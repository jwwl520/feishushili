"use strict";(self.webpackChunkbear_fe=self.webpackChunkbear_fe||[]).push([["vsh_6388"],{vsh_72834:function(e,t,n){n.d(t,{dFq:function(){return L2},TMv:function(){return gd},w99:function(){return Ja},T_g:function(){return j3},k6y:function(){return T2},SWH:function(){return Ni},bwg:function(){return Of},XhZ:function(){return Bf},W7I:function(){return Ei},JTP:function(){return tl},yJh:function(){return Kv},_5N:function(){return Pn},ZSG:function(){return Bn},isD:function(){return oq},yKb:function(){return ME},R4C:function(){return Jb},DB6:function(){return m5},Vb3:function(){return sT},zcn:function(){return pu},GfN:function(){return lv},luK:function(){return Zi},zof:function(){return NX},$gu:function(){return sv},qxV:function(){return YS},BHd:function(){return tE},rvb:function(){return Vi},Jr5:function(){return o6},DXb:function(){return g5},ZJ7:function(){return bE},DsI:function(){return SA},Gni:function(){return vr},DmQ:function(){return Gw},f5z:function(){return NE},at8:function(){return ay},GzH:function(){return n4},YLM:function(){return pI},CSb:function(){return _X},EPL:function(){return wX},Aog:function(){return IT},J5L:function(){return XI},bA2:function(){return C6},kiZ:function(){return ZA},vrE:function(){return pm},OvR:function(){return _a},Nsj:function(){return cd},MLY:function(){return rE},vpZ:function(){return dd},BDP:function(){return yv},deh:function(){return DX},nKc:function(){return VT},Viq:function(){return RT},uTF:function(){return oA},waE:function(){return tA},$3z:function(){return JK},Wph:function(){return rA},pj:function(){return p5},iHi:function(){return eb},juF:function(){return ib},bNH:function(){return gb},_JP:function(){return AE},yz_:function(){return ui},bAI:function(){return Yc},XzD:function(){return E2},D4r:function(){return eK},t$C:function(){return Df},_8N:function(){return yT},RKk:function(){return P_},hRV:function(){return yC},bP6:function(){return pC},hkV:function(){return PM},OM_:function(){return xx},fOM:function(){return mC},Rox:function(){return Mi},xQG:function(){return gg},mMO:function(){return nS},AF2:function(){return vk},y3G:function(){return mv},ZDm:function(){return DC},dR4:function(){return v5},$Rx:function(){return tk},Vb_:function(){return fm},b5y:function(){return dm},PtY:function(){return RR},Nnc:function(){return FE},ITp:function(){return ar},Gdm:function(){return uu},w2y:function(){return Fi},THQ:function(){return DM},bfo:function(){return Zf},PpF:function(){return hI},Zqx:function(){return WA},Zpn:function(){return KA},RSl:function(){return iI},Gzt:function(){return bc},KdS:function(){return Fy},$3B:function(){return My},Yv1:function(){return uJ},e6w:function(){return Oi},XBb:function(){return _5},QWZ:function(){return sE},s3e:function(){return vu},uPt:function(){return $a},nw1:function(){return sl},X1$:function(){return el},vRA:function(){return by},Cbj:function(){return mw},xdz:function(){return Xy},lq$:function(){return xi},Dx_:function(){return S1},NHZ:function(){return E1},SuU:function(){return UQ},dP7:function(){return fT},JG4:function(){return xv},Y19:function(){return Gd},nl1:function(){return kA},RPo:function(){return h4},c68:function(){return D5},aQD:function(){return K5},jTu:function(){return zd},bRw:function(){return uE},AKq:function(){return Ii},THe:function(){return uI},kyt:function(){return aq},z4O:function(){return Su},I8v:function(){return mu},vms:function(){return gv},jyU:function(){return MX},Ji0:function(){return PX},_16:function(){return RX},EGQ:function(){return HA},bju:function(){return eS},hms:function(){return dT},I5U:function(){return Qk},e7B:function(){return Gk},GI0:function(){return y5},uIW:function(){return Wd},E6s:function(){return jn},bgS:function(){return Ad},ZE6:function(){return wa},OBY:function(){return fA},vus:function(){return Ra},fVw:function(){return a6},AOr:function(){return VX},QBB:function(){return hj},Q4J:function(){return fj},n$r:function(){return O_},jo8:function(){return Zu},cLE:function(){return tK},SdI:function(){return gT},FfW:function(){return tv},ngh:function(){return ed},IEE:function(){return RK},Wje:function(){return EA},ipL:function(){return gM},mkl:function(){return UF},SJM:function(){return Pd},gNO:function(){return dk},uYg:function(){return Mx},DHM:function(){return eq},fBW:function(){return yS},Glb:function(){return Q1},mdl:function(){return X1},$2A:function(){return e2},ry4:function(){return Di},ty_:function(){return oJ},X_A:function(){return X2},rMO:function(){return V1},iw5:function(){return av},SCt:function(){return D1},TuQ:function(){return K1},r8Q:function(){return fr},M52:function(){return S2},PHR:function(){return Lv},l7q:function(){return m2},kER:function(){return g2},oyI:function(){return c2},LSy:function(){return Zv},vJj:function(){return fb},xN1:function(){return JI},p5f:function(){return DI},C7s:function(){return pp},hs4:function(){return GA},$pH:function(){return dX},OlV:function(){return _m},ciS:function(){return GQ},Xy9:function(){return Sy},Ukk:function(){return DE},oLG:function(){return y6},Q8:function(){return l2},Vd7:function(){return zE},wZO:function(){return dE},XYU:function(){return hk},nMX:function(){return mm},UDU:function(){return dp},S6s:function(){return jw},mLp:function(){return Dw},$jF:function(){return gm},Eiz:function(){return vm},Xe6:function(){return fp},Tnr:function(){return vX},z6i:function(){return iX},RiU:function(){return Ag},CcX:function(){return $3},I_9:function(){return um},oYo:function(){return eu},wv7:function(){return ek},l5Z:function(){return q3},mhf:function(){return Kk},Z7n:function(){return Yk},eUX:function(){return Ey},Vqk:function(){return Rf},hLk:function(){return ck},_CE:function(){return Oc},VzS:function(){return SI},f$J:function(){return w2},U1Q:function(){return nv},mQS:function(){return xA},KST:function(){return q1},KxW:function(){return $1},Odo:function(){return si},P0c:function(){return T4},mEw:function(){return FX},V8g:function(){return ya},GQK:function(){return ak},RCB:function(){return z2},SyF:function(){return fk},Ry4:function(){return Z2},IcH:function(){return Bm},AGH:function(){return D2},SMW:function(){return B2},cI7:function(){return M1},gAR:function(){return Rh},Kq2:function(){return Jf},zgZ:function(){return d5},hSW:function(){return a4},Srs:function(){return AS},x5g:function(){return zQ},aH0:function(){return c5},ah$:function(){return f5},C7Q:function(){return AF},Jh_:function(){return sm},Nwv:function(){return Ax},zRi:function(){return Vh},zqY:function(){return cm},LxP:function(){return Lh},feJ:function(){return Nv},VRd:function(){return lp},zhK:function(){return cp},cqU:function(){return f2},Lu3:function(){return sr},ZUi:function(){return LE},T_q:function(){return PE},zi$:function(){return s2},ENK:function(){return ik},rKz:function(){return bA},_Fy:function(){return Sk},I0p:function(){return gk},Goo:function(){return mk},pOj:function(){return zk},o80:function(){return Jh},ECF:function(){return Md},$go:function(){return id},buC:function(){return Kh},qNh:function(){return Xh},fnp:function(){return ph},Z5C:function(){return cb},xH3:function(){return im},rjm:function(){return Gf},CoF:function(){return am},$aH:function(){return om},_AL:function(){return FF},qs4:function(){return ih},wYj:function(){return Cp},WhP:function(){return oh},iQ0:function(){return _f},_d$:function(){return qf},qRG:function(){return u$},Pq3:function(){return hp},AdU:function(){return Tv},n1H:function(){return JQ},SrO:function(){return _k},uT_:function(){return no},gfB:function(){return V2},axp:function(){return $i},vw_:function(){return wm},EMG:function(){return BE},vYR:function(){return TI},Dwm:function(){return _y},x32:function(){return f3},oZ:function(){return s4},JnB:function(){return NI},vmo:function(){return xI},jJ3:function(){return wA},ayx:function(){return OA},aIC:function(){return wh},hJs:function(){return fh},QaK:function(){return YA},C68:function(){return Gl},mWC:function(){return IF},C12:function(){return ev},qpA:function(){return Qd},BEd:function(){return _p},dbt:function(){return Ov},MPy:function(){return FA},mC6:function(){return B3},JMv:function(){return dh},uVG:function(){return h5},k9D:function(){return r4},nc6:function(){return Yg},QKf:function(){return jI},nL$:function(){return zI},eTC:function(){return HI},Thf:function(){return WI},oCv:function(){return dw},HzL:function(){return kI},yzJ:function(){return JA},TvB:function(){return SS},uW2:function(){return aT},HCW:function(){return rT},tbe:function(){return nT},fJz:function(){return lh},XMn:function(){return lm},A8G:function(){return BI},UE3:function(){return k2},hjL:function(){return q2},PuS:function(){return _i},NVf:function(){return Av},sMb:function(){return Wf},xhN:function(){return rq},pb4:function(){return ym},b4I:function(){return J1},NgA:function(){return Em},Bkg:function(){return _2},eSn:function(){return Ci},UJ4:function(){return l5},q_S:function(){return Ck},GCO:function(){return Tm},Ab2:function(){return bv},uUo:function(){return Vv},$4z:function(){return M2},lYP:function(){return bp},rwT:function(){return Fv},onc:function(){return Mv},GG9:function(){return Cv},cuz:function(){return Iv},mkm:function(){return nh},Unk:function(){return th},oFn:function(){return EC},s2A:function(){return Z_},JgN:function(){return x_},p9h:function(){return kk},MUL:function(){return pk},dCY:function(){return yk},mzN:function(){return vE},b_9:function(){return Nm},Xfg:function(){return Mm},fuV:function(){return Vm},CpM:function(){return Sm},Ju9:function(){return bm},SWG:function(){return Au},$GL:function(){return U2},YtE:function(){return Dm},lep:function(){return Mn},qY6:function(){return Am},v4_:function(){return rh},Cyn:function(){return OY},E42:function(){return zf},VtV:function(){return lE},cUY:function(){return Mh},Lii:function(){return to},mJ9:function(){return xm},gLI:function(){return Jd},LJj:function(){return yi},dOv:function(){return s5},yFL:function(){return sk},iq:function(){return _w},bGC:function(){return Fu},KpR:function(){return Lm},h7R:function(){return Pm},Od_:function(){return Zm},gsJ:function(){return Im},WBL:function(){return Ip},Avh:function(){return hr},MOM:function(){return Qs},mGT:function(){return Rl},DBs:function(){return eT},m9o:function(){return QE},Aj9:function(){return L1},JX8:function(){return R2},qBP:function(){return bh},ANU:function(){return C2},jBE:function(){return rX},t3y:function(){return uk},WVI:function(){return vp},sz6:function(){return VE},Yom:function(){return Ay},W$j:function(){return h2},Uo4:function(){return u2},gxr:function(){return ql},r90:function(){return ha},NPK:function(){return lb},tN4:function(){return a2},deC:function(){return t2},p95:function(){return r2},Zaw:function(){return AA},HTE:function(){return aI},YFY:function(){return nk},kff:function(){return ov},LoC:function(){return H2},rDL:function(){return U$},mcV:function(){return WQ},Hr1:function(){return $Q},qRm:function(){return gp},cE9:function(){return Ma},gYd:function(){return Ia},JBg:function(){return Fa},xAK:function(){return Y1},MWw:function(){return kh},Mbj:function(){return Sh},h0Q:function(){return VK},V4q:function(){return Eh},smz:function(){return W2},lbI:function(){return jQ},Ywm:function(){return _h},xxt:function(){return ki},zFf:function(){return ef},RUM:function(){return Q2},iBL:function(){return lT},wG9:function(){return F2},D_J:function(){return Th},MyS:function(){return Ah},Bym:function(){return Ch},mEk:function(){return Ih},g99:function(){return aX},dN9:function(){return wf},yjE:function(){return LX},B0I:function(){return lk},JPx:function(){return AI},lXs:function(){return YQ},yTN:function(){return wy},nBL:function(){return qQ},ClL:function(){return DY},xEL:function(){return vv},__h:function(){return UI},uMU:function(){return ch},h7L:function(){return Yl},O6n:function(){return hh},B57:function(){return uh},x7e:function(){return vw},qMG:function(){return Ty},e88:function(){return ky},lDu:function(){return oQ},y02:function(){return yh},HiW:function(){return N1},z3T:function(){return li},nzm:function(){return $s},F$l:function(){return Cm},xD6:function(){return vh},EIf:function(){return Qw},qEj:function(){return G2},Xem:function(){return rx},ohz:function(){return y2},UcG:function(){return x1},RcK:function(){return Ry},EgI:function(){return ud},MYK:function(){return Pg},RTy:function(){return gw}});var r=n("vsh_26364"),a=n("vsh_13431"),o=n("vsh_67017"),i=n.n(o),u=n("vsh_35067"),s=n("vsh_26278"),l=n("vsh_74561"),c=n("vsh_93035"),h=n("vsh_5159"),f=n("vsh_56589"),d=n("vsh_12064"),v=n("vsh_22462"),g=n("vsh_73455"),m=n("vsh_98652"),p=n("vsh_1139"),y=n("vsh_19264"),C=n("vsh_4175"),_=n("vsh_65498"),R=n("vsh_68250"),w=n("vsh_30187"),k=n("vsh_10717"),S=n("vsh_83519"),E=n("vsh_32459"),T=n("vsh_46016"),A=n("vsh_43369"),I=n("vsh_11144"),b=n("vsh_7207"),F=n("vsh_2184"),M=n("vsh_97504"),V=n("vsh_88157"),N=n("vsh_21469"),O=n("vsh_47253"),x=n("vsh_53164"),Z=n("vsh_11657"),D=n("vsh_89586"),P=n("vsh_4561"),L=n("vsh_48912"),B=n("vsh_86982"),U=n("vsh_3285"),H=n("vsh_65726"),W=n("vsh_77704"),j=n("vsh_98460"),z=n("vsh_58818"),G=n("vsh_26171"),J=n("vsh_59980"),q=n("vsh_30426"),$=n("vsh_75712"),Y=n("vsh_4468"),K=n("vsh_3186"),X=n("vsh_47551"),Q=n("vsh_25264"),ee=n("vsh_40969"),te=n("vsh_11967"),ne=n("vsh_97348"),re=n("vsh_65725"),ae=n("vsh_70098"),oe=n("vsh_53690"),ie=n("vsh_82898"),ue=n("vsh_96636"),se=n("vsh_72429"),le=n("vsh_82108"),ce=n("vsh_79170"),he=n("vsh_13867"),fe=n("vsh_88206"),de=n("vsh_89646"),ve=n("vsh_89443"),ge=n("vsh_93301"),me=n("vsh_97811"),pe=n("vsh_22023"),ye=n("vsh_54313"),Ce=n("vsh_29033"),_e=n("vsh_14064"),Re=n("vsh_47246"),we=n("vsh_24627"),ke=n("vsh_84784"),Se=n("vsh_63738");n.o(Se,"Formatter")&&n.d(t,{Formatter:function(){return Se.Formatter}}),n.o(Se,"createFormatter")&&n.d(t,{createFormatter:function(){return Se.createFormatter}}),n.o(Se,"getPreferredFormatter")&&n.d(t,{getPreferredFormatter:function(){return Se.getPreferredFormatter}}),n.o(Se,"hasDate")&&n.d(t,{hasDate:function(){return Se.hasDate}}),n.o(Se,"isDateTimeFormatter")&&n.d(t,{isDateTimeFormatter:function(){return Se.isDateTimeFormatter}});var Ee,Te,Ae,Ie,be,Fe,Me,Ve,Ne,Oe,xe,Ze,De,Pe,Le,Be,Ue,He,We,je,ze,Ge,Je,qe,$e,Ye,Ke,Xe,Qe,et,tt,nt,rt,at,ot=n("vsh_91777"),it=n.n(ot),ut=n("vsh_22485"),st=n("vsh_63603"),lt=(n("vsh_1278"),n("vsh_22392")),ct=n("vsh_99520"),ht=n("vsh_47531"),ft=n("vsh_53290"),dt=n("vsh_8282"),vt=n("vsh_64299"),gt=n("vsh_93631"),mt=n("vsh_99073"),pt=n("vsh_22052"),yt=n("vsh_40742"),Ct=n("vsh_67295"),_t=n("vsh_79828"),Rt=n("vsh_8073"),wt=n("vsh_23414"),kt=n("vsh_55478"),St=n("vsh_91497"),Et=n("vsh_34539"),Tt=n.n(Et),At=n("vsh_45617"),It=n("vsh_61332"),bt=n.n(It),Ft=n("vsh_82905"),Mt=n("vsh_86670"),Vt=n("vsh_33916"),Nt=n("vsh_92292"),Ot=n("vsh_7459"),xt=n("vsh_83836"),Zt=n("vsh_75071"),Dt=n("vsh_17494"),Pt=n("vsh_56489"),Lt=n("vsh_57181"),Bt=n("vsh_23188"),Ut=n("vsh_38383"),Ht=n("vsh_83784"),Wt=n("vsh_98085"),jt=n("vsh_71561"),zt=n("vsh_89808"),Gt=n("vsh_61496"),Jt=n("vsh_33476"),qt=n.n(Jt),$t=n("vsh_28185"),Yt=n("vsh_74683"),Kt=n("vsh_26246"),Xt=n("vsh_40658"),Qt=n("vsh_74876"),en=(n("vsh_33417"),n("vsh_7121")),tn=n("vsh_69691"),nn=n("vsh_67013"),rn=n.n(nn),an=n("vsh_76925"),on=n("vsh_15722"),un=n("vsh_73565"),sn=n.n(un),ln=n("vsh_77034"),cn=n.n(ln),hn=n("vsh_99343"),fn=n("vsh_73043"),dn=n("vsh_66988").Buffer,vn=(n("vsh_14224"),["fontInfo","textDecoration"]),gn=["style"],mn=["_pivotExtra"],pn=["creatorId"],yn=["type"],Cn=["refCount"];function _n(e,t){var n="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!n){if(Array.isArray(e)||(n=function(e,t){if(!e)return;if("string"==typeof e)return Rn(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);"Object"===n&&e.constructor&&(n=e.constructor.name);if("Map"===n||"Set"===n)return Array.from(e);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return Rn(e,t)}(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var r=0,a=function(){};return{s:a,n:function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}},e:function(e){throw e},f:a}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,i=!0,u=!1;return{s:function(){n=n.call(e)},n:function(){var e=n.next();return i=e.done,e},e:function(e){u=!0,o=e},f:function(){try{i||null==n.return||n.return()}finally{if(u)throw o}}}}function Rn(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}function wn(e,t){return e.hasOwnProperty(t)}function kn(e,t,n){return wn(e,t)&&e[t]!==n}var Sn=isNaN,En="rowCount",Tn="colCount";function An(e){return e}function In(e,t,n,r,a,o,i,u,s,l,c){var h,f,d,v,g,m,p,y,C,_,R,w,k,S,E,T,A=n[En],I=n[Tn],b=t[En],F=t[Tn],M=r[En],V=r[Tn],N=1===I,O=1===F;if(b===A&&F===I){var x=0,Z=0,D=0,P=0;for(p=A*I,h=0;h<A;h++)for(f=0;f<I;f++){if(v=o(n[h][f]),g=o(t[h][f]),e&&(Sn(v)||Sn(g)))return s;x+=v,Z+=v*v,D+=g=l(g),P+=v*g}var L=p*P-x*D;for(m=a?L/(p*Z-x*x):P/Z,y=a?(D*Z-x*P)/(p*Z-x*x):0,C=[],h=0;h<M;h++)for(C[h]=[],f=0;f<V;f++){if(v=o(r[h][f]),e&&Sn(v))return s;C[h][f]=0===L?t[0][0]:c(m*v+y)}return i?new i(C):C}if(N&&b===A||1===b&&F===I){for(v=[],g=[],E=I+1,T=I+2,h=0;h<A;h++){if(y=o(R=N?t[h][0]:t[0][h]),e&&Sn(y))return s;g[h]=N?l(y):y}for(h=0;h<A;h++)for(v[h]=[],f=0;f<I;f++){if(y=o(n[h][f]),e&&Sn(y))return s;v[h][f]=y}var B=[];for(m=0;m<E;m++)for(B[m]=[],p=0;p<T;p++)B[m][p]=0;for(d=0;d<A;d++)for(B[0][E]+=g[d],h=0;h<I;h++)for(R=h+1,B[0][R]+=v[d][h],B[R][0]=B[0][R],B[R][E]+=v[d][h]*g[d],f=h;f<I;f++)B[k=f+1][R]+=v[d][h]*v[d][f],B[R][k]=B[k][R];B[0][0]=A;var U=a?0:1;for(_=U;_<E;_++){if(e){if(0===B[h][h]){for(S=!1,f=h+1;!S&&f<E;f++)if(0!==B[f][h]){for(d=0;d<T;d++)k=B[h][d],B[h][d]=B[f][d],B[f][d]=k;S=!0}if(!S)return u}}else{for(h=_;h<E&&0===B[h][_];)h++;if(h>=E)return u;for(w=U;w<T;w++)R=B[_][w],B[_][w]=B[h][w],B[h][w]=R}for(R=1/B[_][_],w=U;w<T;w++)B[_][w]*=R;for(h=U;h<E;h++)if(h!==_)for(R=-B[h][_],w=0;w<T;w++)B[h][w]+=R*B[_][w];!a&&(B[0][E]=0)}for(C=[],!O&&(C[0]=[]),h=0;h<M;h++){for(O&&(C[h]=[]),R=B[0][E],f=0;f<I;f++){if(y=o(R=O?r[h][f]:r[f][h]),e&&Sn(y))return s;R+=B[f+1][E]*y}O?C[h][0]=c(R):C[0][h]=c(R)}return i?new i(C):C}return u}var bn={},Fn=new Date(1899,11,30);function Mn(e){return null==e}bn._each=function(e,t){if(bn._isArraylike(e))for(var n=0,r=e.length;n<r&&!1!==t.call(e[n],n,e[n]);n++);else for(var a in e)if(e.hasOwnProperty(a)&&!1===t.call(e[a],a,e[a]))break;return e},bn._isEmptyObject=function(e){return!e||"object"==(0,_.Z)(e)&&0===Object.keys(e).length},bn._isFunction=function(e){return"function"===bn._getType(e)},bn._isArray=function(e){return Array.isArray?Array.isArray(e):"array"===bn._getType(e)},bn._isNumeric=function(e){return!isNaN(parseFloat(e))&&isFinite(e)},bn._getType=function(e){if(null===e)return"null";var t=bn._class2type;if(!t){t=bn._class2type={};for(var n=["Boolean","Number","String","Function","Array","Date","RegExp","Object","Error"],r=0,a=n.length;r<a;r++)t["[object "+n[r]+"]"]=n[r].toLowerCase()}var o=t.toString,i=(0,_.Z)(e);return"object"===i||"function"===i?t[o.call(e)]||"object":i},bn._inArray=function(e,t,n){var r;if(t){var a=[].indexOf;if(a)return a.call(t,e,n);for(r=t.length,bn._isNullOrUndefined(n)&&(n=0),n=n<0?Math.max(0,r+n):n;n<r;n++)if(n in t&&t[n]===e)return n}return-1},bn._merge=function(e,t){var n=t.length,r=e.length,a=0;if("number"==typeof n)for(;a<n;a++)e[r++]=t[a];else for(;void 0!==t[a];)e[r++]=t[a++];return e.length=r,e},bn._map=function(e,t,n){var r,a=0,o=e.length,i=[];if(bn._isArraylike(e))for(;a<o;a++)null!==(r=t(e[a],a,n))&&(i[i.length]=r);else for(a in e)e.hasOwnProperty(a)&&(null!==(r=t(e[a],a,n))&&(i[i.length]=r));return[].concat.apply([],i)},bn._extend=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];var n,r,a,o,i,u,s=arguments[0]||{},l=1,c=arguments.length,h=!1;for("boolean"==typeof s&&(h=s,s=arguments[1]||{},l=2),"object"==(0,_.Z)(s)||bn._isFunction(s)||(s={}),c===l&&(s=this,--l);l<c;l++)if(!bn._isNullOrUndefined(i=arguments[l]))for(o in i)n=s[o],s!==(a=i[o])&&(h&&a&&(bn._isPlainObject(a)||(r=bn._isArray(a)))?(r?(r=!1,u=n&&bn._isArray(n)?n:[]):u=n&&bn._isPlainObject(n)?n:{},s[o]=bn._extend(h,u,a)):void 0!==a&&(s[o]=a));return s},bn._inherit=function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n]);function r(){this.constructor=e}r.prototype=t.prototype,e.prototype=new r},bn._isWindow=function(e){return null!==e&&e===e.window},bn._isPlainObject=function(e){if(!e||"object"!==bn._getType(e)||e.nodeType||bn._isWindow(e))return!1;var t,n={}.hasOwnProperty;try{if(e.constructor&&!n.call(e,"constructor")&&!n.call(e.constructor.prototype,"isPrototypeOf"))return!1}catch(e){return we.Ps3.moirae.ravenCatch(e),!1}for(t in e);return void 0===t||n.call(e,t)},bn._isArraylike=function(e){if(bn._isNullOrUndefined(e))return!1;var t=e.length,n=bn._getType(e);return!bn._isWindow(e)&&(!(1!==e.nodeType||!t)||"array"===n||"function"!==n&&(0===t||"number"==typeof t&&t>0&&t-1 in e))},bn._makeArray=function(e,t){var n=t||[];return null!==e&&(bn._isArraylike(Object(e))?bn._merge(n,"string"==typeof e?[e]:e):[].push.call(n,e)),n},bn._isType=function(e,t){return bn._isNullOrUndefined(e)?"null"===t:!!t&&(t instanceof Function&&e instanceof t||(0,_.Z)(e)===t||!("function"!==t||!/^\s*\bfunction\b/.test(""+e))||Object.prototype.toString.call(e).slice(8,-1).toLowerCase()===t.toLowerCase()||("PureTimeSpan"===t?e instanceof Date&&e.getDate()===Fn.getDate():"DateTime"===t||"TimeSpan"===t?e instanceof Date:("string"==typeof t&&"undefined number boolean string".indexOf(t),!1)))},bn._isNullOrUndefined=Mn,bn._cloneObject=function(e){if(!e)return e;if("number"==typeof e||"string"==typeof e||"boolean"==typeof e||bn._isNullOrUndefined(e))return e;if(e.clone)return e.clone();if(e instanceof Date)return new Date(e);var t,n,r;for(n in t=e instanceof Object?new e.constructor:new e.constructor(e.valueOf()),e)e.hasOwnProperty(n)&&(r=e[n],e.hasOwnProperty(n)&&t[n]!==r&&(t[n]="object"==(0,_.Z)(r)?bn._cloneObject(r):r));return t.toString=e.toString,t.valueOf=e.valueOf,t};var Vn="Check_Action_Valid_Fail",Nn=["Formula_Parse_Error",Vn];var On,xn,Zn=function(){function e(t,n){(0,y.Z)(this,e),this._owner=t,this._cmdDef=n}return(0,C.Z)(e,[{key:"canUndo",value:function(){return!!this._cmdDef.canUndo}},{key:"updateCommandDef",value:function(e){this._cmdDef.canUndo=e.canUndo}},{key:"execute",value:function(e,t,n,r){var a,o=!0,i=!1;try{o=!1!==(i=("execute"in this._cmdDef?this._cmdDef.execute:this._cmdDef)(e,t,1===n,r))}catch(n){console.error("sheet log Command Error: ",n),(a=n)&&-1!==Nn.indexOf(a.message)||(we.Ps3.moirae.ravenCatch(n,{tags:{scm:JSON.stringify(window.scm),key:"SHEET_CMD_ERROR"}}),o=!1,we.Ps3.moirae.teaLog({key:"client_sheet_command_execute_fail",command:t.cmd,transId:r,err_msg:n&&n.stack?String(n.stack):String(n)}),e.throwError("CommandError",{code:"5007",command:t.cmd}))}return!0!==o||t&&o&&this._owner._commandExecuted({command:t,result:i,_actionType:n,name:this.name}),i}}]),e}(),Dn=function(){function e(t){(0,y.Z)(this,e),this._shortcutKeys={},this.executingType="idle",this._listeners={},this._executed=!1,this._spread=t}return(0,C.Z)(e,[{key:"hasExecuted",value:function(){return this._executed}},{key:"register",value:function(e,t){var n=new Zn(this,t);n.name=e,this[e]=n}},{key:"updateCommandDef",value:function(e,t){this[e]&&this[e].updateCommandDef(t)}},{key:"getCommand",value:function(e){return this[e]}},{key:"setExecutingType",value:function(e){this.executingType=e}},{key:"clearExecutingType",value:function(){this.executingType="idle"}},{key:"getExecutingType",value:function(){return this.executingType}},{key:"execute",value:function(e,t){this._executed=!0;var n=this[e.cmd];if(t=t||we.Hg0.genStepTid(),!n)return we.Ps3.browser.isMobile&&(console.error("[SHEET LOG] ".concat(e.cmd," is not registered")),we.Ps3.collectSuiteEvent("sheet_opration",{error_command_name:e.cmd})),!1;var r=this._spread.hookManager(),a="".concat(we.Jfb,"_").concat(e.cmd);if(r&&!r.executeBeforeHooks(a,e))return!0;var o=n.execute(this._spread,e,0,t);return o?r&&r.onExecuteSuccess(a,e):r&&r.onExecuteFail(a,e),null!=r&&r.executeAfterHooks(a,e),o}},{key:"addListener",value:function(e,t){this._listeners[e]=t}},{key:"removeListener",value:function(e){delete this._listeners[e]}},{key:"_commandExecuted",value:function(e){var t=this._listeners;for(var n in t)t.hasOwnProperty(n)&&t[n](e)}}]),e}(),Pn=function(){function e(t){(0,y.Z)(this,e),this._id=t}return(0,C.Z)(e,[{key:"id",value:function(){return this._id}}]),e}(),Ln=function(){function e(){(0,y.Z)(this,e),this.undoStack=[],this.redoStack=[]}return(0,C.Z)(e,[{key:"do",value:function(e){this.undoStack.push(e),this.redoStack=[]}},{key:"undo",value:function(){var e=this.undoStack.pop();if(e)return this.redoStack.push(e),e}},{key:"redo",value:function(){var e=this.redoStack.pop();if(e)return this.undoStack.push(e),e}},{key:"canUndo",value:function(){return!!this.undoStack.length}},{key:"canRedo",value:function(){return!!this.redoStack.length}},{key:"reset",value:function(){this.redoStack=[],this.undoStack=[]}},{key:"clearById",value:function(e){this.redoStack=this._clearById(e,this.redoStack),this.undoStack=this._clearById(e,this.undoStack)}},{key:"_clearById",value:function(e,t){return t.filter((function(t){return 1!==t.length||t[0].id()!==e}))}}]),e}(),Bn=function(){function e(){(0,y.Z)(this,e),this.blocks=new Map,this._request=new Array,this._doSetTimeoutGap=0,this._canUndoPre=!1,this.stack=new Ln}return(0,C.Z)(e,[{key:"register",value:function(e){this.blocks.set(e.blockId,e)}},{key:"remove",value:function(e){var t=e.blockId;this.blocks.delete(t),this.stack.clearById(t)}},{key:"clear",value:function(){this.blocks.clear(),this.stack.reset()}},{key:"undo",value:function(){for(var e=this,t=arguments.length,n=new Array(t),r=0;r<t;r++)n[r]=arguments[r];var a=this.stack.undo();a&&[].concat(a).reverse().forEach((function(t){var r=t.id();if(e.blocks.has(r)){var a=e.blocks.get(r);a&&a.onUndo.apply(a,n)}}))}},{key:"redo",value:function(){for(var e=this,t=arguments.length,n=new Array(t),r=0;r<t;r++)n[r]=arguments[r];var a=this.stack.redo();a&&a.forEach((function(t){var r=t.id();if(e.blocks.has(r)){var a=e.blocks.get(r);a&&a.onRedo.apply(a,n)}}))}},{key:"do",value:function(e){var t=this;"string"==typeof e&&(e=new Pn(e)),this.blocks.forEach((function(t){t.onDo(e)})),this._request.push(e),this._canUndoPre=!0,window.clearTimeout(this._doSetTimeoutId),this._doSetTimeoutId=window.setTimeout((function(){t.stack.do(t._request),t._request=[],t._canUndoPre=!1}),this._doSetTimeoutGap)}},{key:"_getStackUndoState",value:function(){return this._canUndoPre||this.stack.canUndo()}},{key:"canUndo",value:function(e){if(!e)return this._getStackUndoState();var t=this.blocks.get(e);return t&&t.canUndo?t.canUndo():this._getStackUndoState()}},{key:"canRedo",value:function(e){if(!e)return this.stack.canRedo();var t=this.blocks.get(e);return t&&t.canRedo?t.canRedo():this.stack.canRedo()}},{key:"clearHistory",value:function(){this.stack.reset()}}],[{key:"init",value:function(){return new e}}]),e}(),Un="SHEET",Hn=function(){function e(t,n,r,a){(0,y.Z)(this,e),this._spread=t,this._allowUndo=r,this._undoDispatcher=a,this._undoStack=[],this._redoStack=[],this.blockId=Un,n<0&&(n=2147483647),this._maxLength=n,this._undoDispatcher&&this._undoDispatcher.register(this)}return(0,C.Z)(e,[{key:"register",value:function(e){e.register(this),this._undoDispatcher=e}},{key:"_addCommand",value:function(e,t){e&&0===t&&this.do(e)}},{key:"_execCommand",value:function(e,t){var n=!0;try{var r=this._spread.commandManager()[e.cmd];if(r){var a=we.Hg0.genStepTid();n=r.execute(this._spread,e,t,a)}}catch(e){we.Ps3.moirae.ravenCatch(e),n=!1}return n}},{key:"do",value:function(e){if(!0!==e.dontAddToCommandStack){var t=this._maxLength,n=this._undoStack.length;if(t>0&&n>=t)for(var r=0;r<n-t+1;r++)this._undoStack.shift();this._undoStack.push(e),this._undoDispatcher&&this._undoDispatcher.do(new Pn(Un))}}},{key:"canUndo",value:function(){return this._undoStack.length>0}},{key:"undo",value:function(){return this._undoDispatcher&&this._undoDispatcher.undo(),!0}},{key:"canRedo",value:function(){return this._redoStack.length>0}},{key:"redo",value:function(){return this._undoDispatcher&&this._undoDispatcher.redo(),!0}},{key:"clear",value:function(){this._undoStack=[],this._redoStack=[]}},{key:"dispose",value:function(){this.clear()}},{key:"getUndoStack",value:function(){return console.warn("sheet log getUndoStack is exec slowly, try to use function getUndoStackTop instead"),(0,Re.default)(this._undoStack)}},{key:"getUndoStackTop",value:function(){return this.getStackTop(this._undoStack)}},{key:"getRedoStack",value:function(){return console.warn("sheet log getRedoStack is exec slowly, try to use function getRedoStackTop instead"),(0,Re.default)(this._redoStack)}},{key:"getRedoStackTop",value:function(){return this.getStackTop(this._redoStack)}},{key:"getStackTop",value:function(e){if(!e.length)return null;var t=e[e.length-1];return t?{cmd:t.cmd,sheetId:t.sheetId}:null}},{key:"onDo",value:function(){return this._redoStack=[],!0}},{key:"onUndo",value:function(){if(!this._allowUndo||!this.canUndo())return!0;var e=this._undoStack,t=e[e.length-1],n=this._execCommand(t,1);return!1!==n&&(e.pop(),this._redoStack.push(t)),n}},{key:"onRedo",value:function(){var e=this._redoStack;if(!this._allowUndo||!this.canRedo())return!0;var t=e[e.length-1],n=this._execCommand(t,2);return!1!==n&&(this._undoStack.push(t),e.pop()),n}}]),e}(),Wn=(xn={_getReg:function(e){var t=xn._regDict[e];return t||(t=xn._regDict[e]=new RegExp(e,"g")),t.lastIndex=0,t},_getRegIgnoreCase:function(e){var t=xn._regDictIgnoreCase[e];return t||(t=xn._regDictIgnoreCase[e]=new RegExp(e,"gi")),t.lastIndex=0,t},_regDict:{},_regDictIgnoreCase:{}},xn);!function(e){e["&"]="&amp;",e["<"]="&lt;",e[">"]="&gt;",e['"']="&quot;",e["'"]="&#x27;",e["`"]="&#x60;"}(On||(On={}));var jn={_trimStart:function(e,t){if(!t)return e;for(var n=e;n.substr(0,t.length)===t;)n=n.substr(t.length);return n},_trimEnd:function(e,t){if(!t)return e;for(var n=e;n.substr(n.length-t.length,t.length)===t;)n=n.substr(0,n.length-t.length);return n},_startsWith:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]&&arguments[2];return zn(e,t,n,(function(e,t){return e.slice(0,t.length)===t}))},_endsWith:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]&&arguments[2];return zn(e,t,n,(function(e,t){return e.slice(-t.length)===t}))},_padZero:function(e,t,n){for(var r=e.toString(),a=r.length;a<t;a++)r=n?"0"+r:r+"0";return r},_padZeroLeft:function(e,t){return jn._padZero(e,t,!0)},_padZeroRight:function(e,t){return jn._padZero(e,t,!1)},_escapeHtml:function(e){var t=Wn._getReg("(?:&|<|>|\"|'|`)");return t.test(e)?e.replace(t,(function(e){return On[e]})):e},_unescapeHtml:function(e){var t=Wn._getReg("(?:&amp;|&lt;|&gt;|&quot;|&#x27;|&#x60;)");return t.test(e)?e.replace(t,(function(e){return On[e]})):e}};function zn(e,t,n,r){if(void 0===t)throw new Error;return""===t||!(t.length>e.length)&&r(n?e.toLowerCase():e,n?t.toLowerCase():t)}var Gn,Jn=/^-?(\d+(\.\d*)?|\.\d+)(e[+-]?\d+)?$/i;function qn(e,t){return 5===e[t]?void 0!==e[t+1]||1&e[t-1]:e[t]>5}!function(e){e[e.ROUND_DOWN=0]="ROUND_DOWN",e[e.ROUND_HALF_UP=1]="ROUND_HALF_UP",e[e.ROUND_HALF_EVEN=2]="ROUND_HALF_EVEN",e[e.ROUND_UP=3]="ROUND_UP"}(Gn||(Gn={}));var $n=function(){function e(t){(0,y.Z)(this,e),this.parse(this,String(t))}return(0,C.Z)(e,[{key:"parse",value:function(e,t){if(!Jn.test(t))throw Error("invalid number");e.signNum="-"===t.charAt(0)?(t=t.slice(1),-1):1;var n=t.indexOf(".");n>-1&&(t=t.replace(".",""));var r=t.search(/e/i);r>0?(n<0&&(n=r),n+=Number(t.slice(r+1)),t=t.substring(0,r)):n<0&&(n=t.length);for(var a=t.length,o=0;o<a&&"0"===t.charAt(o);)o++;if(o===a)e.numberArr=[e.exponent=0];else{for(;a>0&&"0"===t.charAt(--a););e.exponent=n-o-1,e.numberArr=[];for(var i=0,u=o;u<=a;i++,u++)e.numberArr[i]=Number(t.charAt(u))}return e}},{key:"round",value:function(t,n){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:e.RM,a=arguments.length>3&&void 0!==arguments[3]&&arguments[3],o=t.numberArr;if(0!==r&&1!==r&&2!==r&&3!==r)throw Error("Invalid rounding mode");if(n<1)return a=3===r&&(a||!!o[0])||0===n&&(1===r&&o[0]>=5||2===r&&(o[0]>5||5===o[0]&&(a||void 0!==o[1]))),o.length=1,a?(t.exponent=t.exponent-n+1,o[0]=1):o[0]=t.exponent=0,t;if(n<o.length){if((1===r&&o[n]>=5||2===r&&(a||qn(o,n))||3===r&&(a||o[0]))&&(a=!0),o.length=n,a)for(;++o[--n]>9;)if(o[n]=0,0===n){++t.exponent,o.unshift(1);break}for(var i=o.length;!o[--i];)o.pop()}return t}},{key:"toPrecision",value:function(t,n){if(void 0!==t){if(t!==~~t||t<1||t>1e6)throw Error("invalid digit");for(this.round(this,t,n);this.numberArr.length<t;)this.numberArr.push(0)}return this.stringify(this,t<=this.exponent||this.exponent<=e.NE||this.exponent>=e.PE,!!this.numberArr[0])}},{key:"stringify",value:function(e,t,n){var r=e.numberArr.join(""),a=e.exponent,o=r.length;if(t)r=r.charAt(0)+(o>1?"."+r.slice(1):"")+(a<0?"e":"e+")+a;else if(a<0){for(;++a;)r="0"+r;r="0."+r}else if(a>0)if(++a>o)for(a-=o;a--;)r+="0";else a<o&&(r=r.slice(0,a)+"."+r.slice(a));else o>1&&(r=r.charAt(0)+"."+r.slice(1));return e.signNum<0&&n?"-"+r:r}}]),e}();$n.NE=-7,$n.PE=21,$n.DP=20,$n.RM=1;var Yn=jn._padZeroLeft,Kn=null,Xn=parseInt,Qn=parseFloat,er=Math.floor,tr=Math.abs;function nr(e,t,n){return e.substr(t,n)}var rr={numberNegativePattern:1,negativeSign:"-",positiveSign:"+",percentSymbol:"%"},ar=function(){function e(e,t,n){var r=t.negativeSign,a=t.positiveSign,o=jn;if(4!==n&&2!==n||(r=" "+r,a=" "+a),4===n||3===n){if(o._endsWith(e,r))return["-",nr(e,0,e.length-r.length)];if(o._endsWith(e,a))return["+",nr(e,0,e.length-a.length)]}else if(2===n||1===n){if(o._startsWith(e,r))return["-",nr(e,r.length)];if(o._startsWith(e,a))return["+",nr(e,a.length)]}else{if(0!==n)throw new Error("");if(o._startsWith(e,"(")&&o._endsWith(e,")"))return["-",nr(e,1,e.length-2)]}return["",e]}return{_parseLocale:function(t){return function(t){if((t=Mn(t)?"":jn._trimEnd(t,"")).match(/^[+-]?infinity$/i))return Qn(t);if(t.match(/^0x[a-f0-9]+$/i))return Xn(t,10);var n,r,a=rr,o=a.numberNegativePattern,i=e(t,a,o),u=i[0],s=i[1];""===u&&1!==o&&(u=(i=e(t,a,1))[0],s=i[1]),""===u&&(u="+");var l,c,h=s.indexOf("e");h<0&&(h=s.indexOf("E")),h<0?(r=s,n=Kn):(r=nr(s,0,h),n=nr(s,h+1));var f=r.indexOf(".");f<0?(l=r,c=Kn):(l=nr(r,0,f),c=nr(r,f+".".length)),l=l.split(",").join("");var d=",".replace(/\u00A0/g," ");","!==d&&(l=l.split(d).join(""));var v=u+l;if(c!==Kn&&(v+="."+c),v[v.length-1]===a.percentSymbol){v=nr(v,0,v.length-1);var g=(v=jn._trimEnd(v,"")).indexOf(".");-1===g&&(g=v.length);var m="";m+=nr(v,0,g-2),m+=".",m+=nr(v,g-2,2),v=m+=nr(v,g+1)}if(n!==Kn){var p=e(n,a,1);""===p[0]&&(p[0]="+"),v+="e"+p[0]+p[1]}return v.match(/^[+-]?\d*\.?\d*(e[+-]?\d+)?$/)?Qn(v):NaN}(t)},_parseFloat:function(e){return ar._toPrecision(Qn(e),15)},_toHexString:function(e,t,n){if(0!==tr(er(e)-e))throw new Error("Bad Format Specifier");var r=e>=0?e.toString(16):(4294967295+e+1).toString(16);return r=t?r.toLowerCase():r.toUpperCase(),!Mn(n)&&r.length<n?Yn(r,n):r},_toPrecision:function(e,t){return"number"!=typeof e&&(e=Number(e)),isNaN(e)||e===1/0||e===-1/0?e:Qn(new $n(e).toPrecision(t))}}}();bn._isNumber=function(e){return bn._isType(e,"number")||bn._isType(e,"DateTime")||bn._isType(e,"TimeSpan")||e&&!bn._isType(e,"boolean")&&!isNaN(e)&&!isNaN(parseFloat(e))&&!(e.length>=2&&"0"===e[0]&&"x"===e[1])},bn._toDouble=function(e){return bn._isNullOrUndefined(e)||""===e?0:bn._isType(e,"number")?e:bn._isType(e,"string")&&!isNaN(e)?ar._parseLocale(e):bn._isType(e,"boolean")?e?1:0:parseFloat(e)};var or=ar._toHexString,ir=parseInt,ur=function(){var e=function(){};return e._toString=function(e){var t=e.a,n=e.r,r=e.g,a=e.b;return 3===arguments.length&&(t=255,n=arguments[0],r=arguments[1],a=arguments[2]),4===arguments.length&&(t=arguments[0],n=arguments[1],r=arguments[2],a=arguments[3]),255===t?"#"+or(n,!0,2)+or(r,!0,2)+or(a,!0,2):"rgba("+n+","+r+","+a+","+t+")"},e._fromString=function(t){var n=cr().cssColorNames[t];if(n){var r=(0,p.Z)(n,3);return{a:255,r:r[0],g:r[1],b:r[2]}}var a=document.createElement("div");function o(t){var n=e._ctx;return n?(n.fillStyle=t,t=n.fillStyle):(a.style.backgroundColor=t,a.style.backgroundColor)}if(t instanceof e)return t;var i=0,u=0,s=0,l=0;if(t&&""!==t){var c=function(e){var t=function(e){return e.indexOf("%")>0?2.55*parseFloat(e):0|e},n=o(e),r=RegExp;if(/^#([0-9a-f]{2})([0-9a-f]{2})([0-9a-f]{2})$/i.test(n))return[r.$1,r.$2,r.$3].map((function(e){return ir(e,16)}));if(/^rgba\(([\s\d]*),([\s\d]*),([\s\d]*),([\s\d]*)\)$/i.test(n)){var a=[r.$1,r.$2,r.$3].map(t);return a.splice(0,0,255*parseFloat(r.$4)),a}return/^rgb\(([\s\d]*),([\s\d]*),([\s\d]*)\)$/i.test(n)?[r.$1,r.$2,r.$3].map(t):/^#([0-9a-f])([0-9a-f])([0-9a-f])$/i.test(n)?[r.$1,r.$2,r.$3].map((function(e){return ir(e+e,16)})):null}(t);c&&(3===c.length?(i=255,u=c[0],s=c[1],l=c[2]):4===c.length&&(i=c[0],u=c[1],s=c[2],l=c[3]))}return{a:i,r:u,g:s,b:l}},e}();function sr(e){return cr().cssColorNamesToHex[e]||e}var lr=null;function cr(){if(lr)return lr;var e={aliceblue:[240,248,255],antiquewhite:[250,235,215],aqua:[0,255,255],aquamarine:[127,255,212],azure:[240,255,255],beige:[245,245,220],bisque:[255,228,196],black:[0,0,0],blanchedalmond:[255,235,205],blue:[0,0,255],blueviolet:[138,43,226],brown:[165,42,42],burlywood:[222,184,135],cadetblue:[95,158,160],chartreuse:[127,255,0],chocolate:[210,105,30],coral:[255,127,80],cornflowerblue:[100,149,237],cornsilk:[255,248,220],crimson:[220,20,60],cyan:[0,255,255],darkblue:[0,0,139],darkcyan:[0,139,139],darkgoldenrod:[184,134,11],darkgray:[169,169,169],darkgreen:[0,100,0],darkgrey:[169,169,169],darkkhaki:[189,183,107],darkmagenta:[139,0,139],darkolivegreen:[85,107,47],darkorange:[255,140,0],darkorchid:[153,50,204],darkred:[139,0,0],darksalmon:[233,150,122],darkseagreen:[143,188,143],darkslateblue:[72,61,139],darkslategray:[47,79,79],darkslategrey:[47,79,79],darkturquoise:[0,206,209],darkviolet:[148,0,211],deeppink:[255,20,147],deepskyblue:[0,191,255],dimgray:[105,105,105],dimgrey:[105,105,105],dodgerblue:[30,144,255],firebrick:[178,34,34],floralwhite:[255,250,240],forestgreen:[34,139,34],fuchsia:[255,0,255],gainsboro:[220,220,220],ghostwhite:[248,248,255],gold:[255,215,0],goldenrod:[218,165,32],gray:[128,128,128],green:[0,128,0],greenyellow:[173,255,47],grey:[128,128,128],honeydew:[240,255,240],hotpink:[255,105,180],indianred:[205,92,92],indigo:[75,0,130],ivory:[255,255,240],khaki:[240,230,140],lavender:[230,230,250],lavenderblush:[255,240,245],lawngreen:[124,252,0],lemonchiffon:[255,250,205],lightblue:[173,216,230],lightcoral:[240,128,128],lightcyan:[224,255,255],lightgoldenrodyellow:[250,250,210],lightgray:[211,211,211],lightgreen:[144,238,144],lightgrey:[211,211,211],lightpink:[255,182,193],lightsalmon:[255,160,122],lightseagreen:[32,178,170],lightskyblue:[135,206,250],lightslategray:[119,136,153],lightslategrey:[119,136,153],lightsteelblue:[176,196,222],lightyellow:[255,255,224],lime:[0,255,0],limegreen:[50,205,50],linen:[250,240,230],magenta:[255,0,255],maroon:[128,0,0],mediumaquamarine:[102,205,170],mediumblue:[0,0,205],mediumorchid:[186,85,211],mediumpurple:[147,112,219],mediumseagreen:[60,179,113],mediumslateblue:[123,104,238],mediumspringgreen:[0,250,154],mediumturquoise:[72,209,204],mediumvioletred:[199,21,133],midnightblue:[25,25,112],mintcream:[245,255,250],mistyrose:[255,228,225],moccasin:[255,228,181],navajowhite:[255,222,173],navy:[0,0,128],oldlace:[253,245,230],olive:[128,128,0],olivedrab:[107,142,35],orange:[255,165,0],orangered:[255,69,0],orchid:[218,112,214],palegoldenrod:[238,232,170],palegreen:[152,251,152],paleturquoise:[175,238,238],palevioletred:[219,112,147],papayawhip:[255,239,213],peachpuff:[255,218,185],peru:[205,133,63],pink:[255,192,203],plum:[221,160,221],powderblue:[176,224,230],purple:[128,0,128],rebeccapurple:[102,51,153],red:[255,0,0],rosybrown:[188,143,143],royalblue:[65,105,225],saddlebrown:[139,69,19],salmon:[250,128,114],sandybrown:[244,164,96],seagreen:[46,139,87],seashell:[255,245,238],sienna:[160,82,45],silver:[192,192,192],skyblue:[135,206,235],slateblue:[106,90,205],slategray:[112,128,144],slategrey:[112,128,144],snow:[255,250,250],springgreen:[0,255,127],steelblue:[70,130,180],tan:[210,180,140],teal:[0,128,128],thistle:[216,191,216],tomato:[255,99,71],turquoise:[64,224,208],violet:[238,130,238],wheat:[245,222,179],white:[255,255,255],whitesmoke:[245,245,245],yellow:[255,255,0],yellowgreen:[154,205,50]},t=Object.entries(e).reduce((function(e,t){var n=(0,p.Z)(t,2),r=n[0],a=n[1];return e[r]=ur._toString.apply(ur,(0,m.Z)(a)),e}),{});return lr={cssColorNamesToHex:t,cssColorNames:e}}function hr(e){return"number"==typeof e&&e>=ke.SheetDate.MIN_DATE_VALUE&&e<=ke.SheetDate.MAX_DATE_VALUE}function fr(e,t){var n=new Date(e);return n.getHours()>0||n.getMinutes()>0||n.getSeconds()>0||!!t&&(0,Se.hasTime)(t)}var dr=function(){function e(t){(0,y.Z)(this,e),this.hooks=new Map,this._spread=t}return(0,C.Z)(e,[{key:"executeBeforeHooks",value:function(e,t){var n=this.getHooks(e);if(n){var r,a=_n(n);try{for(a.s();!(r=a.n()).done;){var o=r.value;if(o.beforeExecute&&!o.beforeExecute(this._spread,t))return o.beforeExecuteFailCallback&&o.beforeExecuteFailCallback(this._spread,t),!1}}catch(e){a.e(e)}finally{a.f()}}return!0}},{key:"executeAfterHooks",value:function(e,t){this.executeHooks(e,t,"afterExecute")}},{key:"onExecuteSuccess",value:function(e,t){this.executeHooks(e,t,"onExecuteSuccess")}},{key:"onExecuteFail",value:function(e,t){this.executeHooks(e,t,"onExecuteFail")}},{key:"setHook",value:function(e,t){var n=this.getHooks(e);n?(n.push(t),this.hooks.set(e,n)):this.hooks.set(e,[t])}},{key:"setHooks",value:function(e,t){var n=this.getHooks(e);if(n){var r=n.concat(t);this.hooks.set(e,r)}else this.hooks.set(e,t)}},{key:"removeHook",value:function(e,t){var n=this.getHooks(e);if(n){var r=n.indexOf(t);r>=0&&(n.splice(r,1),this.hooks.set(e,n))}}},{key:"getHooks",value:function(e){return this.hooks.get(e)}},{key:"executeHooks",value:function(e,t,n){var r=this.getHooks(e);if(r){var a,o=_n(r);try{for(o.s();!(a=o.n()).done;){var i=a.value[n];i&&i(this._spread,t)}}catch(e){o.e(e)}finally{o.f()}}}}]),e}(),vr={_Types:bn,_RegexHelper:Wn,_ColorHelper:ur,_StringHelper:jn,_NumberHelper:ar,_hasOwnProperty:wn,_isInstanceOf:function(e,t){return e instanceof t},_trend:function(e,t,n,r,a,o,i,u){return In(!0,e,t,n,r,a,o,u,i,An,An)},_growth:function(e,t,n,r,a,o,i){var u,s;for(u=0;u<e[En];u++)for(s=0;s<e[Tn];s++)if(e[u][s]<=0)return o;return In(!1,e,t,n,r,An,a,i,null,Math.log,Math.exp)}},gr=void 0,mr=null,pr=parseFloat,yr=document,Cr="_nonamespace",_r="events",Rr="get",wr="set",kr="width",Sr="height",Er="left",Tr="right",Ar="top",Ir="bottom",br="hidden",Fr="block",Mr="none",Vr="position",Nr="visibility",Or="display",xr={tabindex:"tabIndex",readonly:"readOnly",for:"htmlFor",class:"className",maxlength:"maxLength",cellspacing:"cellSpacing",cellpadding:"cellPadding",rowspan:"rowSpan",colspan:"colSpan",usemap:"useMap",frameborder:"frameBorder",contenteditable:"contentEditable"},Zr={tabIndex:{get:function(e){var t=e.getAttributeNode("tabindex"),n=e.nodeName;return t&&t.specified?parseInt(t.value,10):/^(?:input|select|textarea|button|object)$/i.test(n)||/^(?:a|area)$/i.test(n)&&e.href?0:gr}}},Dr={option:{get:function(e){var t=e.attributes.value;return!t||t.specified?e.value:e.text}},select:{get:function(e){var t,n,r=e.options,a=e.selectedIndex,o="select-one"===e.type||a<0,i=o?mr:[],u=o?a+1:r.length,s=o?a:0;for(a<0&&(s=u);s<u;s++)if(((n=r[s]).selected||s===a)&&!n.disabled&&(!n.parentNode.disabled||!Jr(n.parentNode,"optgroup"))){if(t=Wr(n).val(),o)return t;i.push(t)}return i},set:function(e,t){var n=Wr.makeArray(t);return Wr(e).find("option").getAll().forEach((function(e){e.selected=Wr.inArray(Wr(e).val(),n)>=0})),n.length||(e.selectedIndex=-1),n}}},Pr={},Lr="GC$"+(""+Math.random()).replace(/\D/g,""),Br=1,Ur={};function Hr(e,t){var n;Array.call(this),"string"==typeof e?n=(t||yr).querySelectorAll(e):e&&(n=e instanceof Array||"undefined"!=typeof HTMLCollection&&e instanceof HTMLCollection?e:[e]);for(var r=0;n&&r<n.length;r++)this.push(n[r])}[Sr,kr].forEach((function(e){Ur[e]={get:function(t){var n=getComputedStyle(t),r=t.style,a=r[Vr],o=r[Nr],i=r[Or],u=0===t.offsetWidth&&/^(none|table(?!-c[ea]).+)/.test(n[Or]);u&&(r[Vr]="absolute",r[Nr]=br,r[Or]=Fr);var s=n&&n[e];if(u&&(r[Vr]=a,r[Nr]=o,r[Or]=i),""===s){for(var l=t.parentElement,c=yr.body;l&&l!==c;)l=l.parentElement;l!==c&&(s=r[e])}return s}}}));var Wr=function(e,t){return new Hr(e,t)},jr={get:function(e){return this[e]},getAll:function(){return this},bind:function(e,t,n){return na(n)&&(n=t,t=gr),this.forEach((function(r){var a=Xr(r,_r,gr,!0);a||Xr(r,_r,a={},!0);var o=e.split("."),i=o[0],u=o[1]||Cr,s=a[u];s||(s=a[u]={});var l=function(e){na(t)||(e.data=t);var a=n.apply(r,arguments);e.result=a,!1===a&&(e.preventDefault?e.preventDefault():(e.cancelBubble=!1,e.returnValue=!1))};l.original=n;var c=s[i];c||(c=s[i]=[]),c.push(l),r.addEventListener(i,l)})),this},unbind:function(e,t){return this.forEach((function(n){var r,a,o,i=e.split("."),u=i[0],s=i[1]||Cr,l=Xr(n,_r,gr,!0),c=l&&l[s];if(t){if(c&&u&&(r=c[u]))for(a=0,o=r.length;a<o;a++)if(r[a].original===t){sa(n,u,r[a]),r.splice(a,1);break}}else if(c)if(u){if(r=c[u])for(a=0,o=r.length;a<o;a++)sa(n,u,r[a]);c[u]=gr}else{for(var h in c)if(wn(c,h)&&(r=c[h]))for(a=0,o=r.length;a<o;a++)sa(n,h,r[a]);l[s]=gr}})),this},trigger:function(e,t){for(var n=this,r=0,a=n.length;r<a;r++){var o=n[r],i=Xr(o,_r,gr,!0);if(i){var u=e.split(".")[0];for(var s in i)if(wn(i,s)){var l=i[s],c=l&&l[u];if(c)for(var h=0,f=(c=c.concat()).length;h<f;h++)c[h].apply(o,[{type:u},t])}}}return n},css:function(e,t){var n=this,r=n,a=arguments.length;function o(e,t){r.forEach((function(n){n.style[e]=qr(e,t)}))}if(1===a){if(!ta(e)){var i=n[0],u=Ur[e];if(u&&Rr in u)return u.get(i);var s=getComputedStyle(i);return s&&s[e]}r.forEach((function(t){for(var n in e)wn(e,n)&&(t.style[n]=qr(n,e[n]))}))}else 2===a&&(Array.isArray(e)&&Array.isArray(t)&&e.length===t.length?e.forEach((function(e,n){o(e,t[n])})):o(e,t));return n},width:ra(!0),height:ra(),innerWidth:aa(!0),innerHeight:aa(),outerWidth:oa(!0),outerHeight:oa(),append:function(e){var t=[e];e instanceof Wr&&(t=e.getAll());var n=this[0];return t.forEach((function(e){e&&n.appendChild(e)})),this},appendTo:function(e){var t=e;e instanceof Wr&&(t=e[0]);return this.forEach((function(e){t.appendChild(e)})),this},prepend:function(e){var t=this[0];return t.insertBefore(e,t.firstChild),this},insertBefore:function(e){var t=e.parentElement;return this.forEach((function(n){t.insertBefore(n,e)})),this},addClass:function(e){var t,n,r,a,o,i=0,u=this.length,s=/[\t\r\n]/g;for(t=(e||"").match(/\S+/g)||[];i<u;i++)if(r=1===(n=this[i]).nodeType&&(n.className?(" "+n.className+" ").replace(s," "):" ")){for(o=0;a=t[o++];)r.indexOf(" "+a+" ")<0&&(r+=a+" ");n.className=Wr.trim(r)}return this},removeClass:function(e){var t,n,r,a,o,i=0,u=this.length,s=/[\t\r\n]/g;for(t=(e||"").match(/\S+/g)||[];i<u;i++)if(r=1===(n=this[i]).nodeType&&(n.className?(" "+n.className+" ").replace(s," "):"")){for(o=0;a=t[o++];)for(;r.indexOf(" "+a+" ")>=0;)r=r.replace(" "+a+" "," ");n.className=e?Wr.trim(r):""}return this},hasClass:function(e){var t=0,n=this.length,r=/[\t\r\n]/g;for(e=" "+e+" ";t<n;t++){var a=this[t];if(1===a.nodeType&&(" "+a.className+" ").replace(r," ").indexOf(e)>=0)return!0}return!1},toggle:function(){var e=this;return e[0].style[Or]===Mr?e.show():e.hide(),e},show:ia(!0),hide:ia(),attr:function(e,t){var n=this,r=n,a=arguments.length;if(1===a){if(!ta(e))return n[0].getAttribute(e);r.forEach((function(t){for(var n in e)wn(e,n)&&t.setAttribute(n,e[n])}))}else 2===a&&r.forEach((function(n){n.setAttribute(e,t)}));return n},removeAttr:function(e){return this.forEach((function(t){t.removeAttribute(e)})),this},prop:function(e,t){var n=this,r=n,a=arguments.length;if(1===a){if(!ta(e))return $r(n[0],e);r.forEach((function(t){for(var n in e)wn(e,n)&&$r(t,n,e[n])}))}else 2===a&&r.forEach((function(n){$r(n,e,t)}));return n},removeProp:function(e){e=xr[e]||e;return this.forEach((function(t){try{t[e]=gr,delete t[e]}catch(e){we.Ps3.moirae.ravenCatch(e)}})),this},text:function(e){var t=this,n=t;return 0===arguments.length?t[0].textContent:(n.forEach((function(t){t.textContent=e})),t)},val:function(e){var t,n=this;if(!arguments.length){var r,a=n[0];return a?(t=Dr[a.type]||Dr[a.nodeName.toLowerCase()])&&Rr in t&&!na(r=t.get(a,"value"))?r:ea(r=a.value)?r.replace(/\r/g,""):r===mr||r===gr?"":r:void 0}var o=Wr.isFunction(e);return n.forEach((function(n,r){var a;1===n.nodeType&&((a=o?e.call(n,r,Wr(n).val()):e)===mr||a===gr?a="":"number"==typeof a?a+="":Wr.isArray(a)&&(a=Wr.map(a,(function(e){return e===mr||e===gr?"":e+""}))),(t=Dr[n.type]||Dr[n.nodeName.toLowerCase()])&&wr in t&&!na(t.set(n,a,"value"))||(n.value=a))})),n},position:function(){var e=this[0];if(e){var t,n={top:0,left:0};if("fixed"===Wr(e).css(Vr))t=e.getBoundingClientRect();else{var r=this.offsetParent();t=this.offset();var a=r[0];Jr(a,"html")||((n=r.offset()).left-=a.scrollLeft,n.top-=a.scrollTop),n.top+=pr(Wr(a).css("borderTopWidth")),n.left+=pr(Wr(a).css("borderLeftWidth"))}return{top:t.top-n.top-pr(Wr(e).css("marginTop")),left:t.left-n.left-pr(Wr(e).css("marginLeft"))}}},offsetParent:function(){var e=Wr.map(this,(function(e){for(var t=yr.documentElement,n=e.offsetParent||t;n&&!Jr(n,"html")&&"static"===Wr(n).css(Vr);)n=n.offsetParent;return n||t}));return Wr(e)},offset:function(){var e,t,n={top:0,left:0},r=this[0],a=r&&r.ownerDocument;if(a)return e=a.documentElement,na(r.getBoundingClientRect)||(n=r.getBoundingClientRect()),t=Gr(a),{top:n.top+(t.pageYOffset||e.scrollTop)-(e.clientTop||0),left:n.left+(t.pageXOffset||e.scrollLeft)-(e.clientLeft||0)}},scrollLeft:ua(!0),scrollTop:ua(),html:function(e){var t=this,n=t;return 0===arguments.length?t[0].innerHTML:(n.forEach((function(t){t.innerHTML=it().sanitize(e)})),t)},remove:function(){this.forEach((function(e){var t=e.parentElement;t&&(t.removeChild(e),Qr([e]))}))},empty:function(){return this.forEach((function(e){Wr(e.children).remove()})),this},find:function(e){var t=[];return ea(e)&&this.forEach((function(n){var r=n.querySelectorAll(e);Wr.merge(t,r)})),Wr(t)},parent:function(){var e=[];return this.forEach((function(t){var n=t.parentElement;n&&e.push(n)})),Wr(e)},index:function(e){var t=this[0];return e?ea(e)?Wr.inArray(t,Wr(e).getAll()):Wr.inArray(e,this):t&&t.parentElement?Wr.inArray(t,t.parentElement.children):-1},focus:function(){var e=this[0];return e!==yr.activeElement&&e.focus&&e.focus(),this},isVisible:function(){var e=0;return this.forEach((function(t){var n=getComputedStyle(t);n[Nr]!==br&&n[Or]!==Mr&&e++})),e>0},data:function(e,t){var n=this,r=na(t);return r&&(n=void 0),Wr.each(this,(function(a,o){var i=Xr(o,e,t);if(r)return n=i,!1})),n},removeData:function(e){return Wr.each(this,(function(t,n){!function(e,t,n){if(Yr(e)){var r,a,o,i=function(e){var t;for(t in e)if(("data"!==t||!Wr.isEmptyObject(e[t]))&&"toJSON"!==t)return!1;return!0},u=e.nodeType,s=u?Pr:e,l=u?e[Lr]:Lr;if(s[l]){if(t&&(o=n?s[l]:s[l].data)){for((r=0,a=(t=Wr.isArray(t)?t.concat(Wr.map(t,Kr)):t in o||(t=Kr(t))in o?[t]:t.split(" ")).length);r<a;r++)delete o[t[r]];if(!(n?i:Wr.isEmptyObject)(o))return}(n||(delete s[l].data,i(s[l])))&&(u?Qr([e],!0):s!==s.window?delete s[l]:s[l]=mr)}}}(n,e)})),this}},zr=Hr.prototype=[];function Gr(e){return Wr.isWindow(e)?e:9===e.nodeType&&(e.defaultView||e.parentWindow)}function Jr(e,t){var n=e.nodeName;return n&&n.toLowerCase()===t.toLowerCase()}function qr(e,t){return"top left right bottom width height border-radius border-width border-left-width border-right-width border-top-width border-bottom-width line-height padding padding-left padding-right padding-top padding-bottom margin margin-left margin-right margin-top margin-bottom".split(" ").indexOf(e)>=0&&isFinite(t)?("width height".split(" ").indexOf(e)>=0&&t<0&&(t=0),t+"px"):t}function $r(e,t,n){var r,a,o=e.nodeType;if(e&&3!==o&&8!==o&&2!==o)return 1!==o&&(a=Zr[t=xr[t]||t]),na(n)?a&&Rr in a&&(r=a.get(e,t))!==mr?r:e[t]:a&&wr in a&&!na(r=a.set(e,n,t))?r:e[t]=n}function Yr(e){var t=e.nodeType;if(t&&1!==t&&9!==t)return!1;var n=e.nodeName,r=n&&{embed:!0,object:"clsid:D27CDB6E-AE6D-11cf-96B8-444553540000",applet:!0}[n.toLowerCase()];return!r||!0!==r&&e.getAttribute("classid")===r}function Kr(e){return e.replace(/^-ms-/,"ms-").replace(/-([\da-z])/gi,(function(e,t){return t.toUpperCase()}))}function Xr(e,t,n,r){if(Yr(e)){var a,o,i=Lr,u=ea(t),s=e.nodeType,l=s?Pr:e,c=s?e[i]:e[i]&&i;if(c&&l[c]&&(r||l[c].data)||!u||!na(n))return c||(s?e[i]=c=Br++:c=i),l[c]||(l[c]={},s||(l[c].toJSON=function(){})),(ta(t)||"function"==typeof t)&&(r?l[c]=Wr.extend(l[c],t):l[c].data=Wr.extend(l[c].data,t)),a=l[c],r||(a=a.data||(a.data={})),na(n)||(a[Kr(t)]=n),u?(o=a[t])!==mr&&o!==gr||(o=a[Kr(t)]):o=a,o}}function Qr(e,t){for(var n,r,a,o=0,i=Lr,u=Pr;(n=e[o])!==mr&&void 0!==n;o++)if((t||Yr(n))&&(a=(r=n[i])&&u[r])){var s=a.events;if(s)for(var l in s)if(wn(s,l)){var c=s[l];if(c)for(var h in c)if(wn(c,h)){var f=c[h];if(f)for(var d=0,v=f.length;d<v;d++)sa(n,l,f[d])}}u[r]&&(delete u[r],delete n[i])}}function ea(e){return"string"==typeof e}function ta(e){return"object"==(0,_.Z)(e)}function na(e){return(0,_.Z)(e)==(0,_.Z)(gr)}function ra(e){var t=e;return function(e){var n,r=this,a="border-box"===r.css("box-sizing"),o=t?kr:Sr,i=t?Er:Ar,u=t?Tr:Ir;return 0===arguments.length?(n=Math.round(pr(r.css(o)))||0,a&&(n-=pr(r.css("padding-"+i))+pr(r.css("padding-"+u))+pr(r.css("border-"+i+"-"+kr))+pr(r.css("border-"+u+"-"+kr))),n):(r.css(o,e),r)}}function aa(e){var t=e;return function(){var e=this,n=t?Er:Ar,r=t?Tr:Ir;return t?e.width():e.height()+pr(e.css("padding-"+n))+pr(e.css("padding-"+r))}}function oa(e){var t=e;return function(e){var n=t?Er:Ar,r=t?Tr:Ir,a=this,o=t?a.innerWidth():a.innerHeight();return o+=pr(a.css("border-"+n+"-"+kr))+pr(a.css("border-"+r+"-"+kr)),e&&(o+=pr(a.css("margin-"+n))+pr(a.css("margin-"+r))),o}}function ia(e){var t=e;return function(e){return this.forEach((function(n){n.style[Or]=t?Fr:Mr,e&&e.apply(n)})),this}}function ua(e){var t=e;return function(e){var n="scrollLeft",r="scrollTop",a=t?n:r,o=t?"pageXOffset":"pageYOffset",i=this[0],u=Gr(i);return na(e)?u?o in u?u[o]:yr.documentElement[a]:i[a]:(u?u.scrollTo(t?e:Wr(u)[n](),t?Wr(u)[r]():e):i[a]=e,this)}}function sa(e,t,n){e.removeEventListener(t,n)}bn._extend(zr,jr),Wr.prototype=zr,Wr.each=bn._each,Wr.isEmptyObject=bn._isEmptyObject,Wr.isFunction=bn._isFunction,Wr.isArray=bn._isArray,Wr.isNumeric=bn._isNumeric,Wr.getType=bn._getType,Wr.inArray=bn._inArray,Wr.merge=bn._merge,Wr.map=bn._map,Wr.extend=bn._extend,Wr.inherit=bn._inherit,Wr.isPlainObject=bn._isPlainObject,Wr.isArraylike=bn._isArraylike,Wr.isWindow=bn._isWindow,Wr.makeArray=bn._makeArray,Wr.trim=function(e){return e.trim?e.trim():e===mr||e===gr?"":(e+"").replace(/^[\s\uFEFF\xA0]+|[\s\uFEFF\xA0]+$/g,"")},Wr._createElement=function(e,t,n,r,a){var o=Wr(yr.createElement(e));return t&&n&&o.css(t,n),r&&o.addClass(r),a&&(a instanceof Wr?a.append(o):Wr(a).append(o)),o};var la=Wr;function ca(e){if(null==e)return!1;var t=e.toString();return!isNaN(Number(""===t.trim()?NaN:t))||/^[1-9]\d{0,2}(?:(,\d{3})*|\d*)(?:\.\d*)?$/.test(t)}function ha(e,t,n){var r=!(arguments.length>3&&void 0!==arguments[3])||arguments[3];if(null==n)return null;if("string"!=typeof n&&"number"!=typeof n)return{value:n,autoFormatter:null};var a,o=t&&t.formatter,i=t&&t.autoFormatter,u=null;if(o){var s="string"==typeof n?n:String(n),l=o.parse(s);a=l?l.value:n}else if(r){var c=(0,Se.getPreferredFormatter)(e,n,i);a=c.value,u=c.formatter}else{var h=(0,Se.getPreferredFormatter)(e,n);a=h.value,u=h.formatter}return a instanceof ke.SheetDate&&(a=a.toNumber()),{value:a,autoFormatter:u}}var fa=1,da=2,va=3,ga=4;function ma(e){for(var t=e.replace(/^\s+|\s+$/,"").replace(/\s+/g," ").split(" "),n=0;n<t.length;n+=1)if(/^(-?\d|--)/.test(t[n])||!/^([_a-zA-Z0-9-]|[^\0-\237]|(\\[0-9a-f]{1,6}(\r\n|[ \n\r\t\f])?|\\[^\n\r\f0-9a-f]))+$/.test(t[n]))return null;return t.join(" ")}function pa(e){e=e.replace(/\s*\/\s*/gi,"/");for(var t,n=fa,r="",a={"font-family":[]},o=0;t=e.charAt(o);o+=1)if(n!==ga||'"'!==t&&"'"!==t)if(n===va&&","===t)n=ga,r="";else if(n===ga&&","===t){var i;(i=ma(r))&&a["font-family"].push(i),r=""}else n!==fa||" "!==t&&"/"!==t?n===da&&" "===t?(/^(\+|-)?([0-9]*\.)?[0-9]+(em|ex|ch|rem|vh|vw|vmin|vmax|px|mm|cm|in|pt|pc|%)?$/.test(r)&&(a["line-height"]=r),n=ga,r=""):r+=t:(/^((xx|x)-large|(xx|s)-small|small|large|medium)$/.test(r)||/^(larg|small)er$/.test(r)||/^(\+|-)?([0-9]*\.)?[0-9]+(em|ex|ch|rem|vh|vw|vmin|vmax|px|mm|cm|in|pt|pc|%)$/.test(r)?(n="/"===t?da:ga,a["font-size"]=r):/^(italic|oblique)$/.test(r)?a["font-style"]=r:/^small-caps$/.test(r)?a["font-variant"]=r:/^(bold(er)?|lighter|[1-9]00)$/.test(r)?a["font-weight"]=r:/^((ultra|extra|semi)-)?(condensed|expanded)$/.test(r)&&(a["font-stretch"]=r),r="");else{var u=o+1;do{if(!(u=e.indexOf(t,u)+1))return null}while("\\"===e.charAt(u-2));a["font-family"].push(e.slice(o,u)),o=u-1,n=va,r=""}return n!==va||/^\s*$/.test(r)?(n===ga&&(i=ma(r))&&a["font-family"].push(i),a["font-size"]&&a["font-family"].length?a:null):null}function ya(e){if(null==e)return e;if("object"!=(0,_.Z)(e))return e;if(Array.isArray(e)){for(var t=[],n=0;n<e.length;n++)t[n]=ya(e[n]);return t}var r={};for(var a in e)Object.prototype.hasOwnProperty.call(e,a)&&(r[a]=ya(e[a]));return r}var Ca,_a=13;!function(e){e[e.normal=400]="normal",e[e.bold=700]="bold"}(Ca||(Ca={}));var Ra="normal",wa={_composeTextDecoration:function(e){if(e<=0)return"none";var t=[];return(e&we.aBM.underline)===e&&t.push("underline"),(e|we.aBM.lineThrough)===e&&t.push("line-through"),(e|we.aBM.overline)===e&&t.push("overline"),t.join(" ")},_scaleFont:function(e,t,n,r){var a;if(!r&&(a=Ea[e]))return a;var o=-1!==e.indexOf("no-common-ligatures");return o&&Sa?(r||(Ea[e]=Sa),Sa):(a=Aa(o?null:pa(e)),r||(Ea[e]=a),Sa=a,a)},_dispose:function(){Va&&(Va.parentElement&&Va.parentElement.removeChild(Va),Va=void 0,Na=void 0)},_buildFontString:function(e,t){var n=[],r="normal",a=e.fontWeight,o=e.fontSize||"",i=e.lineHeight,u=e.fontStyle,s=e.fontVariant;if(u&&u!==r&&n.push(u),s&&s!==r&&n.push(s),a&&a!==r&&"400"!==a&&n.push(a),o){var l=o;i&&i!==r&&(l+="/"+i),n.push(l)}var c=e.fontFamily||(t?"":(0,we.M10)());return c&&n.push(c),n.join(" ")},_updateFont:function(e,t){var n,r=null;"string"==typeof e?(r=Oa[e])||(r=pa(e))&&(Oa[e]=r):r={"font-family":[],"font-style":e.fontStyle,"font-weight":null===(n=e.fontWeight)||void 0===n?void 0:n.toString(),"font-size":"".concat(e.fontSize,"px")};var a=Aa(r,t);return Ea[a.font]=a,a},_updateTextDecoration:function(e,t){var n=t.active,r=t.flag,a=e||we.aBM.none;return n?a&=~r:a|=r,a},px2Pt:Ia};function ka(e){if(!e)return{fontFamily:null,fontSize:null,fontStyle:null,fontWeight:null,lineHeight:null};var t=function(){if(Va)Va.style.cssText=Na;else{var e=document.createElement("span"),t=e.style;t.visibility="hidden",t.top="-10000px",t.left="-10000px",t.lineHeight="normal",t.position="absolute",t.fontWeight="normal",t.fontStretch="normal",t.fontStyle="normal",t.fontVariant="normal",t.fontSize=we.OSP,document.body.appendChild(e),Va=e,Na=t.cssText}return Va}();t.style.font=e;var n=t.style;return{fontFamily:n.fontFamily,fontSize:n.fontSize,fontStyle:n.fontStyle,fontWeight:n.fontWeight,lineHeight:n.lineHeight}}var Sa,Ea={},Ta={"x-small":10,small:13,medium:16,large:18,"x-large":24,"xx-large":32};function Aa(e,t){var n={font:"13px/1.5 Arial",fontStyle:"normal",fontWeight:400,fontSize:13,fontFamily:(0,we.M10)()};if(!e){if(!t)return n;e={"font-family":(0,we.M10)().split(", ")}}var r=ya(e);t&&function(e,t){for(var n in t)e[(0,_e.Z)(n)]=t[n]}(r,t);var a=r["font-style"],o=r["font-weight"],i=r["font-size"],u=r["line-height"],s=Array.isArray(r["font-family"])?r["font-family"].join(", "):r["font-family"];i&&function(e,t){var n=parseFloat(t);Number.isNaN(n)&&(n=Ta[t]||_a),/pt/i.test(t)?e.fontSize=ba(n):e.fontSize=Math.floor(n)}(n,i),o&&function(e,t){"bold"===t?e.fontWeight=700:"normal"===t?e.fontWeight=400:t&&(e.fontWeight=parseInt(t,10)||400)}(n,o),a&&(n.fontStyle=a),s&&(n.fontFamily=s);var l=a&&"normal"!==a?a+" ":"",c=o&&"normal"!==o&&400!==Number(o)?o+" ":"",h=i?"number"==typeof i?i+"px":i:"",f=u?"/"+u:"";return n.font=l+c+h+f+" "+n.fontFamily,n}function Ia(e){return null==e?10:Math.ceil(72*e/96)}function ba(e){return Math.floor(96*e/72)}function Fa(e){return e.endsWith("px")?Ia(parseInt(e,10)||_a):10}function Ma(e){return ba(e)+"px"}var Va,Na,Oa={};function xa(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,n=arguments.length>2?arguments[2]:void 0;switch((0,_.Z)(e)){case"object":return null===e?Za(349,t):Array.isArray(e)?Pa(e,t):La(e,t,n);case"string":return Da(e,t);case"boolean":return Za(e?433:863,t);case"number":return Za(e,t);case"undefined":return Za(937,t);default:return Za(617,t)}}function Za(e,t){return(t<<5)-t+e|0}function Da(e,t){t=Za(149417,t);for(var n=0,r=e.length;n<r;n++)t=Za(e.charCodeAt(n),t);return t}function Pa(e,t){return t=Za(104579,t),e.reduce((function(e,t){return xa(t,e)}),t)}function La(e,t,n){return t=Za(181387,t),Object.keys(e).sort().reduce((function(t,r){return null==e[r]||n&&n.has(r)?t:(t=Da(r,t),xa(e[r],t))}),t)}var Ba=function(){function e(t,n,r,a){(0,y.Z)(this,e),this.x=t,this.y=n,this.width=r,this.height=a}return(0,C.Z)(e,[{key:"intersect",value:function(e,t,n,r){return e<this.x+this.width&&this.x<e+n&&t<this.y+this.height&&this.y<t+r}},{key:"intersectRect",value:function(e){return this.intersect(e.x,e.y,e.width,e.height)}},{key:"contains",value:function(e,t){return this.x<e&&e<this.x+this.width&&this.y<t&&t<this.y+this.height}},{key:"containsRect",value:function(e){return this.contains(e.x,e.y)&&this.contains(e.x+e.width,e.y+e.height)}},{key:"getIntersectRect",value:function(e){return this.getIntersect(e.x,e.y,e.width,e.height)}},{key:"getIntersect",value:function(t,n,r,a){var o=Math.max(this.x,t),i=Math.max(this.y,n),u=Math.min(this.x+this.width,t+r)-o,s=Math.min(this.y+this.height,n+a)-i;return u>0&&s>0?new e(o,i,u,s):null}},{key:"round",value:function(){this.x=Math.floor(this.x),this.y=Math.floor(this.y),this.width=Math.ceil(this.width),this.height=Math.ceil(this.height)}},{key:"clone",value:function(){return new e(this.x,this.y,this.width,this.height)}},{key:"unionRect",value:function(e){return this.union(e.x,e.y,e.width,e.height)}},{key:"union",value:function(t,n,r,a){var o=Math.min(this.x,t),i=Math.min(this.y,n);return new e(o,i,Math.max(this.x+this.width,t+r)-o,Math.max(this.y+this.height,n+a)-i)}}]),e}(),Ua=function(){function e(t,n){(0,y.Z)(this,e),this.x=t,this.y=n}return(0,C.Z)(e,[{key:"clone",value:function(){return new e(this.x,this.y)}}]),e}(),Ha=function(e){function t(e,n,r,a,o){var i;return(0,y.Z)(this,t),(i=(0,d.Z)(this,(0,v.Z)(t).call(this))).row=e,i.col=n,i.blockToken=a,i.formula=o,i.baseVar=r,i.type=r.type,i}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"isNull",value:function(){return this.baseVar.isNull()}},{key:"getVar",value:function(e){if(!this.formula)return this.baseVar;var t=this.formula.getRawVar(e);if(t instanceof ut.ErrorVar){var n=this.formula.getRef().toJSON(),r=n.row,a=n.col;return this.row===r&&this.col===a&&t.errorCode===ut.ErrorCode.SUSPENDED?ut.WAIT_ASYNC_ERR_VAR:t}return this.baseVar}},{key:"getValue",value:function(e){return this.getVar(e).getValue()}},{key:"getRawVar",value:function(e){var t;return(null===(t=this.formula)||void 0===t?void 0:t.getRawVar(e))||ut.NULL_VAR}},{key:"toNumberVar",value:function(e){return this.baseVar.toNumberVar(e)}},{key:"toStringVar",value:function(){return this.baseVar.toStringVar()}},{key:"toBooleanVar",value:function(){return this.baseVar.toBooleanVar()}},{key:"equals",value:function(e){return this.baseVar.equals(e)}},{key:"greaterThan",value:function(e){return!this.baseVar.isError()&&this.baseVar.greaterThan(e)}},{key:"lessThan",value:function(e){return!this.baseVar.isError()&&this.baseVar.lessThan(e)}},{key:"greaterThanEquals",value:function(e){return!this.baseVar.isError()&&this.baseVar.greaterThanEquals(e)}},{key:"lessThanEquals",value:function(e){return!this.baseVar.isError()&&this.baseVar.lessThanEquals(e)}},{key:"serialize",value:function(){return null}},{key:"isRuntimeError",value:function(){return this.baseVar.isError()&&this.baseVar.isRuntimeError()}}]),t}(ut.BaseVar);function Wa(e){return e instanceof Ha}var ja=ut.StringVar.prototype.toNumberVar;ut.StringVar.prototype.toNumberVar=function(e){var t=this.getValue();if(!e.spread)return ja.apply(this,arguments);var n=(0,Se.getPreferredFormatter)(e.spread.formatterService,t).value;return n instanceof ke.SheetDate?new ut.NumberVar(n.toNumber()):"number"==typeof n?new ut.NumberVar(n):"boolean"==typeof n?new ut.NumberVar(n?1:0):ja.apply(this,arguments)},ut.StringVar.prototype.equals=function(e){return!!e.isString()&&this.getValue().toLowerCase()===e.getValue().toLowerCase()},ut.StringVar.prototype.greaterThan=function(e){return!(!e.isString()||this.equals(e))&&this.getValue().toLowerCase()>e.getValue().toLowerCase()},ut.StringVar.prototype.lessThan=function(e){return!(!e.isString()||this.equals(e))&&this.getValue().toLowerCase()<e.getValue().toLowerCase()};var za,Ga,Ja,qa,$a,Ya=1048576,Ka=16384,Xa=32;!function(e){e.Add="add",e.Delete="delete"}(za||(za={})),function(e){e[e.AllRangeBase=0]="AllRangeBase",e[e.NormalRange=1]="NormalRange"}(Ga||(Ga={})),function(e){e[e.None=0]="None",e[e.Left=1]="Left",e[e.Right=2]="Right",e[e.Top=4]="Top",e[e.Bottom=8]="Bottom",e[e.All=15]="All"}(Ja||(Ja={})),function(e){e[e.None=0]="None",e[e.Left=1]="Left",e[e.Right=2]="Right",e[e.Top=4]="Top",e[e.Bottom=8]="Bottom",e[e.Horizontal=3]="Horizontal",e[e.Vertical=12]="Vertical",e[e.All=15]="All"}(qa||(qa={})),function(e){e.A1="A1",e.R1C1="R1C1"}($a||($a={}));var Qa=Math.pow(2,25),eo=new Set([we.xj7.ROW,we.xj7.COL,we.xj7.ALL]),to=function(e){return eo.has(e.rgType)},no=function(e){return e[0]+e[1]},ro=function(e,t){var n=e[0],r=e[1],a=t.from(),o=t.to(),i=t.segOpType(),u=t.size();if("add"===i)a<=e[0]?n+=u:a<no(e)&&(r+=u);else if("delete"===i){var s=function(e,t){var n=Math.max(e[0],t[0]),r=Math.min(e[1],t[1])-n;return r<=0?null:[n,r]}([n,n+r],[a,o+1]);a<e[0]&&(o<e[0]?n-=u:n=a),null!==s&&(r-=s[1])}return[n,r]},ao=function(e,t){return e[0]===t[0]&&e[1]===t[1]},oo=function(e,t,n,r){return e<=n&&r<=t},io=Math.max,uo=Math.min;function so(e,t){return e.startCol<=t.startCol&&e.startRow<=t.startRow&&t.endCol<=e.endCol&&t.endRow<=e.endRow}function lo(e,t){return function(e,t){return oo(e.startRow,e.endRow-1,t.startRow,t.endRow-1)}(e,t)||function(e,t){return oo(e.startCol,e.endCol-1,t.startCol,t.endCol-1)}(e,t)}function co(e,t){return t.startCol<e.endCol&&t.startRow<e.endRow&&t.endCol>e.startCol&&t.endRow>e.startRow}function ho(e,t){return e.hostId===t.hostId}function fo(e,t){return{startRow:io(e.startRow,t.startRow),endRow:uo(e.endRow,t.endRow),startCol:io(e.startCol,t.startCol),endCol:uo(e.endCol,t.endCol),hostId:e.hostId,hostName:e.hostName,status:e.status}}function vo(e){return{startRow:e.startRow,endRow:e.endRow,startCol:e.startCol,endCol:e.endCol,hostId:e.hostId,hostName:e.hostName,status:e.status}}var go=new Array(8);function mo(e,t,n,r,a,o,i,u){return go[0]=a||"",go[1]=o||"",go[2]=e||0,go[3]=t||0,go[4]=n||0,go[5]=r||0,go[6]=i||0,go[7]=u||0,go.join()}function po(e,t){return t.startRow<e.startRow&&(e.startRow=t.startRow),t.startCol<e.startCol&&(e.startCol=t.startCol),t.endRow>e.endRow&&(e.endRow=t.endRow),t.endCol>e.endCol&&(e.endCol=t.endCol),e}function yo(e,t){e.startRow=t.startRow,e.endRow=t.endRow,e.startCol=t.startCol,e.endCol=t.endCol,e.hostId=t.hostId,e.hostName=t.hostName,e.status=t.status}function Co(e){return e.endRow-e.startRow}function _o(e){return e.endCol-e.startCol}function Ro(e){return _o(e)*Co(e)}var wo,ko=[0,1],So=[2,3],Eo=["endRow","startRow","endCol","startCol"],To={startKey:Eo[1],endKey:Eo[0]},Ao={startKey:Eo[3],endKey:Eo[2]},Io=[0,2];function bo(e,t){return(t<<4)+e}function Fo(e){return 15&e}function Mo(e){return e>>4}function Vo(e){var t=Mo(e);return!!(1&t&&2&t)}function No(e){var t=Mo(e);return!!(4&t&&8&t)}function Oo(e){return Vo(e.status)}function xo(e){return No(e.status)}function Zo(e,t){var n=e[t.startKey],r=e[t.endKey];return n>=0&&r>n}function Do(e){return Zo(e,To)&&Zo(e,Ao)}function Po(e,t){var n,r=Lo(function(e){var t=Vo(e.status),n=No(e.status);return{startRow:n?0:e.startRow,endRow:n?Qa:e.startRow+1,startCol:t?0:e.startCol,endCol:t?Qa:e.startCol+1,hostId:e.hostId,hostName:e.hostName,status:e.status}}(e),t);n=1===Ro(e)?r:po(r,Lo(function(e){var t=Vo(e.status),n=No(e.status);return{startRow:n?0:e.endRow-1,endRow:n?Qa:e.endRow,startCol:t?0:e.endCol-1,endCol:t?Qa:e.endCol,hostId:e.hostId,hostName:e.hostName,status:e.status}}(e),t));var a=Mo(n.status),o=Fo(e.status);return n.status=bo(o,a),n}function Lo(e,t){for(var n={hostId:t.hostId,hostName:t.hostName},r=[],a=Mo(t.status),o=Fo(t.status),i=0;i<Io.length;i++){var u=Io[i],s=Eo[u],l=1<<3-u,c=u+1,h=Eo[c],f=l>>1,d=a&l,v=a&f,g=o&l,m=o&f;if(r[u]=g,r[c]=m,d&&v)n[s]=t[s],n[h]=t[h];else if(d||!v)if(!d||v)if(m&&g)n[s]=t[s],n[h]=t[h];else if(g||m){var p=g?t[s]:e[h]+t[s],y=m?t[h]:e[h]+t[h];y>=p?(n[h]=p-1,n[s]=y+1,r[c]=g>>1,r[u]=m<<1):(n[h]=y,n[s]=p)}else n[s]=e[h]+t[s],n[h]=e[h]+t[h];else n[s]=t[s],n[h]=m?t[h]:e[h]+t[h];else n[h]=t[h],n[s]=g?t[s]:e[h]+t[s]}return n.status=bo(r[0]|r[1]|r[2]|r[3],a),n}function Bo(e,t,n){for(var r={hostId:t.hostId,hostName:t.hostName,status:t.status},a=Mo(t.status),o=Fo(t.status),i=[],u=0;u<Io.length;u++){var s=Io[u],l=Eo[s],c=1<<3-s,h=s+1,f=Eo[h],d=c>>1,v=a&c,g=a&d,m=o&c,p=o&d;i[s]=m,i[h]=p,g&&(r[f]=t[f]),v&&(r[l]=t[l]),g&&v||(p&&m?(!g&&(r[f]=t[f]),!v&&(r[l]=t[l])):m||p?void 0===n||(n&d)===p&&(n&c)===m?(!g&&(r[f]=p?t[f]:t[f]-e[f]),!v&&(r[l]=m?t[l]:t[l]-e[f])):(p?(!g&&(r[f]=t[l]-e[f]-1),!v&&(r[l]=t[f]+1)):(!g&&(r[f]=t[l]-1),!v&&(r[l]=t[f]-e[f]+1)),i[h]=m>>1,i[s]=p<<1):(!g&&(r[f]=t[f]-e[f]),!v&&(r[l]=t[l]-e[f])))}return void 0!==n&&(r.status=bo(i[0]|i[1]|i[2]|i[3],a)),r}function Uo(e,t){return e.startRow=io(e.startRow,t.startRow),e.endRow=uo(e.endRow,t.endRow),e.startCol=io(e.startCol,t.startCol),e.endCol=uo(e.endCol,t.endCol),e}function Ho(e,t,n){for(var r=!(arguments.length>3&&void 0!==arguments[3])||arguments[3],a={hostId:n.hostId,hostName:n.hostName,status:n.status},o=Mo(t.status),i=Fo(t.status),u=0;u<Io.length;u++){var s=Io[u],l=Eo[s],c=1<<3-s,h=s+1,f=Eo[h],d=c>>1,v=o&c,g=o&d,m=i&c,p=i&d;if(v&&g)a[l]=n[l],a[f]=n[f];else if(!v||g)if(v||!g)if(m&&p)a[l]=n[l],a[f]=n[f];else if(m||p){var y=Eo[m?s:h],C=Eo[m?h:s],_=t[y],R=p?t[C]-1:t[C];e[f]<=_?a[f]=n[f]:a[f]=e[f]-R,e[l]-1>=_?a[l]=n[l]:a[l]=e[l]-R}else{a[l]=e[l]-t[f];var w=Math.abs(t[l]-t[f]);a[f]=e[f]-w+1-t[f]}else a[l]=n[l],a[f]=m?n[f]:e[f]+1-t[l];else a[f]=n[f],a[l]=p?n[l]:e[f]-t[f]+1}return r&&Uo(a,n),a}function Wo(e,t,n,r){var a=vo(n),o=jo(t,r),i=o.startKey,u=o.endKey,s=o.startLock,l=o.endLock;if(s&&l)return a[i]=e[i]===t[i]?n[i]:-1,a[u]=e[u]===t[u]?n[u]:-1,a;if(!s&&!l)return a[i]=e[i]-t[i],a[u]=e[u]-t[u]+1,a;var c=s?t[i]:t[u]-1,h=s?t[u]-1:t[i];return c<e[i]||c>e[u]-1?(a[i]=-1,a[u]=-1,a):(a[i]=io(e[i]-h,n[i]),a[u]=uo(e[u]-h,n[u]),a)}function jo(e,t){var n=t?ko:So,r=t?To:Ao,a=Fo(e.status);return{startKey:r.startKey,endKey:r.endKey,startLock:$o(a,n[1]),endLock:$o(a,n[0])}}function zo(e,t,n,r){var a=vo(n),o=jo(t,r),i=o.startKey,u=o.endKey,s=o.startLock,l=o.endLock;if(s&&l)return a[i]=n[i],a[u]=n[u],Uo(a,n);if(!s&&!l)return a[u]=e[i]-t[i]+1,a[i]=e[u]-t[u],Uo(a,n);var c=s?t[i]:t[u]-1,h=s?t[u]-1:t[i];return e[i]<c?a[u]=e[i]-h+1:a[u]=n[u],e[u]-1>c?a[i]=e[u]-1-h:a[i]=n[i],Uo(a,n)}function Go(e){var t,n,r,a,o=e.startRow,i=e.endRow,u=e.endCol,s=e.startCol,l=e.status,c=e.sheetId,h=e.sheetName;return{startRow:null!==(t=o)&&void 0!==t?t:0,endRow:null!==(n=i)&&void 0!==n?n:Qa,startCol:null!==(r=s)&&void 0!==r?r:0,endCol:null!==(a=u)&&void 0!==a?a:Qa,hostId:c,hostName:h,status:l||0}}function Jo(e){var t=Fo(e.status),n=!!(4&t),r=!!(8&t),a=!!(1&t),o=!!(2&t);return!(n===r&&e.startRow>=e.endRow)&&!(a===o&&e.startCol>=e.endCol||n&&e.startRow<0||r&&e.endRow<0||a&&e.startCol<0||o&&e.endCol<0)}function qo(e,t){var n=[];if(!ho(e,t)||!co(e,t))return n.push(e),n;var r=fo(e,t);return r.startCol>e.startCol&&n.push({startRow:e.startRow,endRow:e.endRow,startCol:e.startCol,endCol:r.startCol,hostId:e.hostId,hostName:e.hostName,status:e.status}),r.startRow>e.startRow&&n.push({startRow:e.startRow,endRow:r.startRow,startCol:r.startCol,endCol:r.endCol,hostId:e.hostId,hostName:e.hostName,status:e.status}),r.endRow<e.endRow&&n.push({startRow:r.endRow,endRow:e.endRow,startCol:r.startCol,endCol:r.endCol,hostId:e.hostId,hostName:e.hostName,status:e.status}),r.endCol<e.endCol&&n.push({startRow:e.startRow,endRow:e.endRow,startCol:r.endCol,endCol:e.endCol,hostId:e.hostId,hostName:e.hostName,status:e.status}),n}function $o(e,t){return e&1<<3-t}function Yo(e,t){var n=Fo(e.status),r=t?ko:So;return $o(n,r[0])&&$o(n,r[1])}function Ko(e,t,n,r,a){var o=e.clone();return o.startRow+=t,o.endRow+=t,o.startCol+=n,o.endCol+=n,r&&(o.hostId=r),a&&(o.hostName=a),o}function Xo(e,t,n,r,a){var o=e.clone(),i=Mo(e.status),u=Fo(e.status),s=Qo(o.startRow,o.endRow,t,u,i,!0),l=(0,p.Z)(s,2),c=l[0],h=l[1],f=Qo(o.startCol,o.endCol,n,u,i,!1),d=(0,p.Z)(f,2),v=d[0],g=d[1];return o.startRow=c,o.endRow=h,o.startCol=v,o.endCol=g,r&&(o.hostId=r),a&&(o.hostName=a),o}function Qo(e,t,n,r,a,o){var i=o?2:0;return a>>=i,[1&(r>>=i)||1&a?e:e+n,2&r||2&a?t:t+n]}function ei(e,t){var n=t.getRowCount(),r=t.getColumnCount();return e.endRow<=n&&e.endCol<=r||((e=e.clone()).status=0,e.endRow=uo(e.endRow,n),e.endCol=uo(e.endCol,r)),e}!function(e){e[e.ALL=0]="ALL",e[e.RANGE=1]="RANGE"}(wo||(wo={}));var ti=[];!function(){for(var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:Ya,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:Ka,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:Xa,r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:8,a={rowSize:e,colSize:t,count:1,hashBase:0};a.rowSize>n||a.colSize>r;){var o=a.count,i=Math.max(a.rowSize/2,n),u=Math.max(a.colSize/2,r);i<a.rowSize&&(o*=2),u<a.colSize&&(o*=2);var s={rowSize:i,colSize:u,count:o,hashBase:a.hashBase+a.count};a=s,ti.push(s)}}();var ni=function(){function e(t){(0,y.Z)(this,e),this._rg=t,this._phase=0}return(0,C.Z)(e,[{key:"next",value:function(){if(0===this._phase)return this._phase=1,this._iter=new oi(this._rg,!0,this._rg.sheetHash()+1,Ya/2,8192),0;var e=this._iter,t=e.next();if(null==t&&(e.blockRowSize()>Xa||e.blockColSize()>8)){var n=Math.max(e.blockRowSize()/2,Xa),r=Math.max(e.blockColSize()/2,8);this._iter=new oi(this._rg,!0,e.hashOffset()+e.blockCount(),n,r),t=this.next()}return t}}]),e}(),ri=function(){function e(t){(0,y.Z)(this,e),this.range=t,this.isDone=!0}return(0,C.Z)(e,[{key:"next",value:function(){return this.isDone?(this.isDone=!1,this.range.sheetHash()):null}}]),e}(),ai=function(){function e(t){(0,y.Z)(this,e),this._partitionIters=[];for(var n=ti.length-1,r=ti[n];n>0&&(r.rowSize<t.rowCount()||r.colSize<t.colCount());)n--,r=ti[n];var a=t.sheetHash()+1,o=Ya/2,i=8192;r&&(a=t.sheetHash()+r.hashBase,o=r.rowSize,i=r.colSize),this._blockIter=new oi(t,o===Xa&&8===i,a,o,i)}return(0,C.Z)(e,[{key:"next",value:function(){var e=this._blockIter,t=e.next();if(null==t){if(e.blockRowSize()>Xa||e.blockColSize()>8){var n,r=Math.max(e.blockRowSize()/2,Xa),a=Math.max(e.blockColSize()/2,8),o=_n(e.partitionRanges());try{for(o.s();!(n=o.n()).done;){var i=n.value;this._partitionIters.push(new oi(i,r===Xa&&8===a,e.hashOffset()+e.blockCount(),r,a))}}catch(e){o.e(e)}finally{o.f()}}var u=this._partitionIters.shift();if(u)return this._blockIter=u,this.next()}return t}}]),e}(),oi=function(){function e(t,n,r,a,o){(0,y.Z)(this,e),this._includePartition=n,this._hashOffset=r,this._blockRowSize=a,this._blockColSize=o,t instanceof Ei&&(t={row:t.rowFrom(),col:t.colFrom(),rowCount:t.rowCount(),colCount:t.colCount(),sheet:t.sheet()}),this._rg=t,this._row=this._rg.row,this._col=this._rg.col,this._blockRowCount=Ya/this._blockRowSize,this._blockColCount=Ka/this._blockColSize}return(0,C.Z)(e,[{key:"next",value:function(){var e=this._rg;if(!this._includePartition&&!this._coverBlock(this._row,this._col))return this._stepToNextBlock(),ii(e,this._row,this._col)?this.next():null;if(ii(e,this._row,this._col)){var t=this._id();return this._stepToNextBlock(),t+this._hashOffset}return null}},{key:"blockRowSize",value:function(){return this._blockRowSize}},{key:"blockColSize",value:function(){return this._blockColSize}},{key:"blockCount",value:function(){return this._blockRowCount*this._blockColCount}},{key:"hashOffset",value:function(){return this._hashOffset}},{key:"partitionRanges",value:function(){var e=[],t=this._rg.row,n=this._rg.col,r=this._rg.row+this._rg.rowCount-1,a=this._rg.col+this._rg.colCount-1,o=this._blockRowStart(t),i=this._blockColStart(n),u=this._blockRowStart(r),s=this._blockColStart(a);return this._coverBlock(t,n)||e.push({row:t,col:n,rowCount:Math.min(o+this.blockRowSize(),r+1)-t,colCount:Math.min(i+this.blockColSize(),a+1)-n,sheet:this._rg.sheet}),s>i&&!this._coverBlock(t,s)&&e.push({row:t,col:s,rowCount:Math.min(o+this.blockRowSize(),r+1)-t,colCount:a-s+1,sheet:this._rg.sheet}),u>o&&!this._coverBlock(u,n)&&e.push({row:u,col:n,rowCount:r-u+1,colCount:Math.min(i+this.blockColSize(),a+1)-n,sheet:this._rg.sheet}),u>o&&s>i&&!this._coverBlock(u,s)&&e.push({row:u,col:s,rowCount:r-u+1,colCount:a-s+1,sheet:this._rg.sheet}),e}},{key:"_stepToNextBlock",value:function(){this._col=this._blockColStart(this._col)+this._blockColSize,this._col>this._rg.col+this._rg.colCount-1&&(this._row=this._blockRowStart(this._row)+this._blockRowSize,this._col=this._rg.col)}},{key:"_blockRowStart",value:function(e){return Math.floor(e/this._blockRowSize)*this._blockRowSize}},{key:"_blockColStart",value:function(e){return Math.floor(e/this._blockColSize)*this._blockColSize}},{key:"_id",value:function(){var e=Math.floor(this._row/this._blockRowSize);return Math.floor(this._col/this._blockColSize)+e*(Ka/this._blockColSize)}},{key:"_coverBlock",value:function(e,t){var n=this._blockRowStart(e),r=this._blockColStart(t);return e===n&&this._rg.row+this._rg.rowCount-1>=n+this._blockRowSize-1||t===r&&this._rg.col+this._rg.colCount-1>=r+this._blockColSize-1}}]),e}();function ii(e,t,n){return e.row<=t&&t<=e.row+e.rowCount-1&&e.col<=n&&n<=e.col+e.colCount-1}var ui=function(){function e(t,n,r,a,o,i){var u=arguments.length>6&&void 0!==arguments[6]?arguments[6]:0;(0,y.Z)(this,e),this.startRow=t,this.endRow=n,this.startCol=r,this.endCol=a,this.hostId=o,this.hostName=i,this.status=u}return(0,C.Z)(e,[{key:"getHostIdentifier",value:function(){return-1}},{key:"hash",value:function(){var e=arguments.length>0&&void 0!==arguments[0]&&arguments[0],t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];if(e&&this.key)return this.key;var n=mo(this.startRow,this.endRow,this.startCol,this.endCol,this.hostId,this.hostName,this.status,this.getHostIdentifier());return t&&(this.key=n),n}},{key:"onDataChanged",value:function(){this.key=void 0}},{key:"isRow",value:function(){return Vo(this.status)}},{key:"isCol",value:function(){return No(this.status)}},{key:"toGridJSON",value:function(){return Object.assign({},this.toSimpleGridJSON(),{sheetId:this.hostId,sheetName:this.hostName,status:this.status})}},{key:"toSimpleGridJSON",value:function(){var e=this.isRow(),t=this.isCol();return{startRow:t?void 0:this.startRow,endRow:t?void 0:this.endRow,startCol:e?void 0:this.startCol,endCol:e?void 0:this.endCol}}},{key:"toGridRange",value:function(){return{startRow:this.startRow,endRow:this.endRow,startCol:this.startCol,endCol:this.endCol,hostId:this.hostId,hostName:this.hostName,status:this.status}}},{key:"clone",value:function(){return e.fromGridRange(this)}}],[{key:"fromGridJSON",value:function(e){return this.fromGridRange(Go(e))}},{key:"fromGridRange",value:function(t){return new e(t.startRow,t.endRow,t.startCol,t.endCol,t.hostId,t.hostName,t.status)}}]),e}();function si(e){return/[^a-z]/gi.test(e)?"'".concat(e=e.replace(/'/g,"''"),"'"):e}function li(e,t){var n={type:e.rgType};if(e.rgType===we.xj7.ALL)return n;var r=e.rgType===we.xj7.CELL;return e.rgType!==we.xj7.ROW&&(n.col=e.colFrom(),n.colCount=r?1:e.colCount(t)),e.rgType!==we.xj7.COL&&(n.row=e.rowFrom(),n.rowCount=r?1:e.rowCount(t)),n}function ci(e,t){var n={type:t};return t===we.xj7.ALL||(t!==we.xj7.ROW&&(n.col=e.startCol,n.colCount=_o(e)),t!==we.xj7.COL&&(n.row=e.startRow,n.rowCount=Co(e))),n}function hi(e,t,n){var r=arguments.length>3&&void 0!==arguments[3]&&arguments[3];if(t=t.clone(),n=n.clone(),!t.equal(n)){if(t.contain(e))return di(e,t,n);if(n.sheet()===e.sheet()){var a=fi(e,t,n,r),o=a.movingHorizontal,i=a.onEdge,u=a.intersectedRange;if(i)return mi(e,t,n,u,o,r);if(!u){var s=n.intersect(e);if(s)return pi(e,s,r)}}}}function fi(e,t,n,r){var a=n.rowFrom()!==t.rowFrom(),o=n.colFrom()!==t.colFrom(),i=t.containCol(e),u=t.containRow(e),s=null;if(!to(t)&&to(e)||(r&&(o&&u&&t.setColCount(e.colTo(!0)+1-t.colFrom()),a&&i&&t.setRowCount(e.rowTo(!0)+1-t.rowFrom())),s=e.intersect(t)),!s)return{intersectedRange:null,onEdge:!1,movingHorizontal:!1};var l=s.colTo(!0)===e.colTo(!0)||s.colFrom()===e.colFrom(),c=s.rowTo(!0)===e.rowTo(!0)||s.rowFrom()===e.rowFrom();return{intersectedRange:s,onEdge:u&&!i&&o&&!a&&l||i&&!u&&a&&!o&&c,movingHorizontal:o}}function di(e,t,n){var r=e.sheet(),a=n.sheet();if(r&&a)return e=e.clone(),r!==a&&e.setSheet(a),e.setRowFrom(Math.max(0,e.rowFrom()+n.rowFrom()-t.rowFrom())),e.setColFrom(Math.max(0,e.colFrom()+n.colFrom()-t.colFrom())),e.setRowCount(e.rowCount()),e.setColCount(e.colCount()),e}function vi(e,t){return e.colFrom()+e.colCount(!0)<t.colFrom()||e.colFrom()>t.colFrom()+t.colCount(!0)}function gi(e,t){return e.rowFrom()+e.rowCount(!0)<t.rowFrom()||e.rowFrom()>t.rowFrom()+t.rowCount(!0)}function mi(e,t,n,r,a,o){e=e.clone();var i={from:a?function(e){return e.colFrom()}:function(e){return e.rowFrom()},count:a?function(e){return e.colCount(!0)}:function(e){return e.rowCount(!0)},setFrom:a?function(e,t){return e.setColFrom(t)}:function(e,t){return e.setRowFrom(t)},setCount:a?function(e,t){return e.setColCount(t)}:function(e,t){return e.setRowCount(t)},movingOverBoundary:a?vi:gi},u=i.from(n)-i.from(t),s=e.sub(r)[0];if(!s){var l,c=function(e){return JSON.stringify(Object.assign({type:e.rgType},e.toJSON()))};return null!==(l=we.Ps3.collectSheetEvent)&&void 0!==l&&l.call(we.Ps3,"ccm_sheet_add_del_cell_exception",{reason:"formulaRange",detail:"".concat(c(e),",").concat(c(r))}),void console.error("[ADD_DEL_CELL] formulaRange edge move failed")}var h=r.clone();if(i.setFrom(h,i.from(r)+u),(i.from(r)-i.from(s))*u>0){var f=s.union(h);i.setCount(e,i.count(f)),i.setFrom(e,i.from(f))}else if(i.movingOverBoundary(h,s))o?(i.setCount(e,i.count(h)),i.setFrom(e,i.from(h))):(i.setCount(e,i.count(s)),i.setFrom(e,i.from(s)));else{var d,v=s.sub(n);d=v.length?v.reduce((function(e,t){return e.union(t)})).union(h):h,i.setCount(e,i.count(d)),i.setFrom(e,i.from(d))}return e}function pi(e,t,n){e=e.clone();var r=t.rowCount(!0)===e.rowCount(!0),a=t.colCount(!0)===e.colCount(!0);if(a&&r)return function(e){e.setRowCount(0),e.setColCount(0)}(e),e;if(n&&(a||r)){var o={from:r?function(e){return e.colFrom()}:function(e){return e.rowFrom()},count:r?function(e){return e.colCount(!0)}:function(e){return e.rowCount(!0)},setFrom:r?function(e,t){return e.setColFrom(t)}:function(e,t){return e.setRowFrom(t)},setCount:r?function(e,t){return e.setColCount(t)}:function(e,t){return e.setRowCount(t)}},i=e.sub(t);if(1===i.length){var u=i[0];return o.setCount(e,o.count(u)),o.setFrom(e,o.from(u)),e}}}var yi=function(e){return e.rgType===we.xj7.ROW},Ci=function(e){return e.rgType===we.xj7.COL},_i=function(e){return e.rgType===we.xj7.ALL};function Ri(e){return e instanceof Ei}function wi(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;return(e.isRow()?xi:e.isCol()?Vi:Oi).fromGridRange(e,t)}function ki(e,t){return wi(ui.fromGridRange(Lo(t,e)),e.sheet())}function Si(e,t,n){return wi(ui.fromGridRange(Bo(t,e,n)),e.sheet())}var Ei=function(e){function t(e,n,r,a,o){var i,u;return(0,y.Z)(this,t),(u=(0,d.Z)(this,(0,v.Z)(t).call(this,e,n,r,a,null==o||null===(i=o.id)||void 0===i?void 0:i.call(o))))._sheet=o,u.customType="SheetRange",u}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"setSheet",value:function(e){this._sheet=e,this.hostId=null==e?void 0:e.id(),this.afterSheetChanged&&this.afterSheetChanged(this._sheet)}},{key:"sheetHash",value:function(){var e=String(this._sheet?this._sheet._id:0),n=t.sheetHashMap;if(!n.has(e)){var r=n.size<<26;n.set(e,r)}return n.get(e)}},{key:"getHostIdentifier",value:function(){return this._sheet?this._sheet._id:(0,f.Z)((0,v.Z)(t.prototype),"getHostIdentifier",this).call(this)}},{key:"sheet",value:function(){return this._sheet}},{key:"refStatus",value:function(){return void 0!==this.status?Fo(this.status):15}},{key:"rowInterval",value:function(e){return[this.rowFrom(),this.rowCount(e)]}},{key:"colInterval",value:function(e){return[this.colFrom(),this.colCount(e)]}},{key:"rowFrom",value:function(){return this.startRow||0}},{key:"colFrom",value:function(){return this.startCol||0}},{key:"rowTo",value:function(e){return this.rowEnd(e)-1}},{key:"colTo",value:function(e){return this.colEnd(e)-1}},{key:"rowEnd",value:function(e){var t,n;return e?this.endRow:Math.min(this.endRow,null!==(t=null===(n=this._sheet)||void 0===n?void 0:n.getRowCount())&&void 0!==t?t:0)}},{key:"colEnd",value:function(e){var t,n;return e?this.endCol:Math.min(this.endCol,null!==(t=null===(n=this._sheet)||void 0===n?void 0:n.getColumnCount())&&void 0!==t?t:0)}},{key:"rowCount",value:function(e){return Math.max(0,this.rowEnd(e)-this.startRow)}},{key:"colCount",value:function(e){return Math.max(0,this.colEnd(e)-this.startCol)}},{key:"equal",value:function(e,t){return!(!this.isValid()||!e.isValid())&&!(!this._sheet||!e._sheet)&&this._sheet===e._sheet&&ao(this.rowInterval(t),e.rowInterval(t))&&ao(this.colInterval(t),e.colInterval(t))&&this._sheet.name()===e._sheet.name()}},{key:"isRangeValid",value:function(e){return!(!this.isValid()||!e.isValid())&&this._sheet===e._sheet}},{key:"contain",value:function(e,t){return!!this.isRangeValid(e)&&oo(this.rowFrom(),this.rowTo(t),e.rowFrom(),e.rowTo(t))&&oo(this.colFrom(),this.colTo(t),e.colFrom(),e.colTo(t))}},{key:"containRow",value:function(e,t){return!!this.isRangeValid(e)&&oo(this.rowFrom(),this.rowTo(t),e.rowFrom(),e.rowTo(t))}},{key:"containCol",value:function(e,t){return!!this.isRangeValid(e)&&oo(this.colFrom(),this.colTo(t),e.colFrom(),e.colTo(t))}},{key:"containCell",value:function(e,t,n){return!!this.isValid()&&this.rowFrom()<=e&&e<=this.rowTo(n)&&this.colFrom()<=t&&t<=this.colTo(n)}},{key:"intersectRow",value:function(e,t){var n=Math.max(this.rowFrom(),e.rowFrom()),r=Math.min(this.rowTo(t),e.rowTo(t))-n+1;return r<=0?null:[n,r]}},{key:"intersectCol",value:function(e,t){var n=Math.max(this.colFrom(),e.colFrom()),r=Math.min(this.colTo(t),e.colTo(t))-n+1;return r<=0?null:[n,r]}},{key:"isIntersectRow",value:function(e,t){return this.rowFrom()<=e.rowTo(t)&&e.rowFrom()<=this.rowTo(t)}},{key:"isIntersectCol",value:function(e,t){return this.colFrom()<=e.colTo(t)&&e.colFrom()<=this.colTo(t)}},{key:"isIntersect",value:function(e,t){return this._sheet===e._sheet&&!(!this.isValid()||!e.isValid())&&(e.rgType===we.xj7.ALL||this.rgType===we.xj7.ALL||this.isIntersectCol(e,t)&&this.isIntersectRow(e,t))}},{key:"size",value:function(e){return this.isValid()?this.rowCount(e)*this.colCount(e):0}},{key:"setRowFrom",value:function(e){var t=this.rowCount(!0);this.startRow=e,this.setRowCount(t)}},{key:"setRowCount",value:function(e){this.endRow=this.startRow+e}},{key:"setColFrom",value:function(e){var t=this.colCount(!0);this.startCol=e,this.setColCount(t)}},{key:"setColCount",value:function(e){this.endCol=this.startCol+e}},{key:"sheetNameToString",value:function(e){var t,n,r=e.isShowSheetName;return void 0===r&&(r=(null===(t=e.ref.sheet())||void 0===t?void 0:t.id())!==(null===(n=this._sheet)||void 0===n?void 0:n.id())),r&&null!=this.sheetName?si(this.sheetName)+"!":""}},{key:"rowFromToString",value:function(e){var t=e.ref,n=e.refStyle,r=void 0===n?"A1":n,a=this.rowFrom(),o=4&this.refStatus();if("R1C1"===r){var i=t?a-t.rowFrom():0;return"R".concat(o?a+1:"[".concat(i,"]"))}return"".concat(o?"$":"").concat(a+1)}},{key:"rowToToString",value:function(e){var t=e.ref,n=e.refStyle,r=void 0===n?"A1":n,a=this.rowTo(!0),o=8&this.refStatus();if("R1C1"===r){var i=t?a-t.rowTo(!0):0;return"R".concat(o?a+1:"[".concat(i,"]"))}return"".concat(o?"$":"").concat(a+1)}},{key:"colFromToString",value:function(e){var t=e.ref,n=e.refStyle,r=void 0===n?"A1":n,a=this.colFrom(),o=1&this.refStatus();if("R1C1"===r){var i=t?a-t.colFrom():0;return"C".concat(o?a+1:"[".concat(i,"]"))}return"".concat(o?"$":"").concat((0,we.hdC)(a))}},{key:"colToToString",value:function(e){var t=e.ref,n=e.refStyle,r=void 0===n?"A1":n,a=this.colTo(!0),o=2&this.refStatus();if("R1C1"===r){var i=t?a-t.colTo(!0):0;return"C".concat(o?a+1:"[".concat(i,"]"))}return"".concat(o?"$":"").concat((0,we.hdC)(a))}},{key:"canDecompile",value:function(){return this.rowFrom()>=0&&this.colFrom()>=0&&this.rowCount(!0)>0&&this.colCount(!0)>0}},{key:"isValidRefInSheet",value:function(e){return null!=this._sheet&&this.rowFrom()>=0&&this.colFrom()>=0&&this.rowCount(e)>0&&this.colCount(e)>0}},{key:"isValidBoundaryInsideSheet",value:function(){if(null==this._sheet)return!1;var e=this.rowFrom(),t=this.rowCount(!0),n=this.colFrom(),r=this.colCount(!0),a=this._sheet.getRowCount(),o=this._sheet.getColumnCount();return e>=0&&e<a&&n>=0&&n<o&&t>0&&e+t<=a&&r>0&&n+r<=o}},{key:"isValid",value:function(){return this.isValidRefInSheet(!0)}},{key:"onOp",value:function(e){if(!this.isFrozen){if("DelRowOp"===e.instanceType)return e.onOp(this),void this.updateRefInterval();if("MoveRangeOP"!==e.instanceType)if("DelSheetOp"!==e.instanceType){if(e.isRowType()){var t=ro([this.rowFrom(),this.rowCount(!0)],e),n=(0,p.Z)(t,2),r=n[0],a=n[1];this.setRowFrom(r),this.setRowCount(a)}else{var o=ro([this.colFrom(),this.colCount(!0)],e),i=(0,p.Z)(o,2),u=i[0],s=i[1];this.setColFrom(u),this.setColCount(s)}this.updateRefInterval()}else this.sheet()===e.getSheet()&&(this.hostName=this._sheet.name(),this._sheet=null,this.afterSheetChanged&&this.afterSheetChanged(this._sheet));else{var l=hi(this,e.srcRange(),e.targetRange(),e.toEdgeAdjust);l&&(this.startRow=l.startRow,this.startCol=l.startCol,this.endRow=l.endRow,this.endCol=l.endCol,this.hostId=l.hostId,this.hostName=l.hostName,this.setSheet(l.sheet()))}}}},{key:"effectedHashIter",value:function(){return new ni(this)}},{key:"transpose",value:function(){var e=this.colCount(!0),t=this.rowCount(!0);return this.setRowCount(e),this.setColCount(t),this}},{key:"getTransposed",value:function(){var e=this.clone();return e.transpose(),e}},{key:"toJSON",value:function(){return{row:this.rowFrom(),col:this.colFrom(),rowCount:this.rowCount(),colCount:this.colCount()}}},{key:"unionRow",value:function(e){var t=Math.min(this.rowFrom(),e.rowFrom());return[t,Math.max(this.rowEnd(),e.rowEnd())-t]}},{key:"unionCol",value:function(e){var t=Math.min(this.colFrom(),e.colFrom());return[t,Math.max(this.colEnd(),e.colEnd())-t]}},{key:"isUnionable",value:function(e){if(this._sheet!==e._sheet)return!1;if(!e.isValid()||!this.isValid())return!1;var t=this.size()+e.size(),n=Math.min(this.rowFrom(),e.rowFrom()),r=Math.min(this.colFrom(),e.colFrom()),a=Math.max(this.rowEnd(!0),e.rowEnd(!0));return t>=(Math.max(this.colEnd(!0),e.colEnd(!0))-r)*(a-n)>>1}},{key:"type",value:function(){return we.xj7[this.rgType]}},{key:"namespace",value:function(){return this.customNamespace||""}},{key:"setNamespace",value:function(e){this.customNamespace=e}},{key:"parentRef",value:function(){return null}},{key:"getCustomData",value:function(e){var t=this.sheet();if(!t||!this.isValid())return null;var n=this.rowFrom(),r=this.colFrom(),a=t.getActualFormatter(n,r,e)||null,o=a?a.getFormatCode():"";return{autoFormat:"General"===o?"":o}}},{key:"nth",value:function(e){if(e>=this.size()||e<0||null==this._sheet)return ut.REF_ERR_VAR;var t=this.colCount();if(t<=0)return ut.REF_ERR_VAR;var n=e/t,r=e%t,a=this.rowFrom(),o=this.colFrom();return this._sheet.getVar(a+n,o+r)}},{key:"updateRefInterval",value:function(){this.startRow=this.rowFrom(),this.endRow=this.rowEnd(!0),this.startCol=this.colFrom(),this.endCol=this.colEnd(!0)}},{key:"isAsync",value:function(){return!1}},{key:"isRef",value:function(){return!0}},{key:"isError",value:function(){return!1}},{key:"toGridJSON",value:function(){return Object.assign({},(0,f.Z)((0,v.Z)(t.prototype),"toGridJSON",this).call(this),{sheetName:this.sheetName})}},{key:"toSheetBoundRange",value:function(){var e=this.toGridRange();return e.endRow=this.rowEnd(),e.endCol=this.colEnd(),e}},{key:"sheetName",get:function(){return null==this._sheet?this.hostName:this._sheet.name()},set:function(e){null==this._sheet&&(this.hostName=null==e?void 0:e)}}],[{key:"fromGridRange",value:function(e){throw new Error("Not implemented")}},{key:"fromGridJSON",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;return this.fromGridRange(Go(e),t)}}]),t}(ui);function Ti(e,t){return qo(e.toSheetBoundRange(),t).map((function(t){return Oi.fromGridRange(t,e.sheet())}))}function Ai(e,t){return function(e,t){var n=[];if(!ho(e,t)||!co(e,t))return n.push(e),n;var r=fo(e,t);return r.startRow>e.startRow&&n.push({startRow:e.startRow,endRow:r.startRow,startCol:e.startCol,endCol:e.endCol,hostId:e.hostId,hostName:e.hostName,status:e.status}),r.startCol>e.startCol&&n.push({startRow:r.startRow,endRow:r.endRow,startCol:e.startCol,endCol:r.startCol,hostId:e.hostId,hostName:e.hostName,status:e.status}),r.endCol<e.endCol&&n.push({startRow:r.startRow,endRow:r.endRow,startCol:r.endCol,endCol:e.endCol,hostId:e.hostId,hostName:e.hostName,status:e.status}),r.endRow<e.endRow&&n.push({startRow:r.endRow,endRow:e.endRow,startCol:e.startCol,endCol:e.endCol,hostId:e.hostId,hostName:e.hostName,status:e.status}),n}(e.toSheetBoundRange(),t).map((function(t){return Oi.fromGridRange(t,e.sheet())}))}Ei.sheetHashMap=new Map;var Ii,bi,Fi,Mi,Vi=function(e){function t(e,n,r){var a,o=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0;return(0,y.Z)(this,t),(a=(0,d.Z)(this,(0,v.Z)(t).call(this,0,Qa,e,e+n,r))).rgType=we.xj7.COL,a.setRefStatus(o),a}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"setRefStatus",value:function(e){this.status=bo(e,12)}},{key:"offset",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,a=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0;return 0!==e||r>0?Oi.prototype.offset.call(this,e,n,r,a):new t(this.colFrom()+n,a<=0?this.colCount(!0):a,this._sheet)}},{key:"rowFrom",value:function(){return 0}},{key:"rowEnd",value:function(){return(0,f.Z)((0,v.Z)(t.prototype),"rowEnd",this).call(this,!1)}},{key:"intersect",value:function(e){if(this._sheet!==e.sheet())return null;if(e.rgType===we.xj7.ALL)return e;var n=this.intersectRow(e);if(null!==n){var r=this.intersectCol(e);if(null!==r)return ao(n,this.rowInterval())?new t(r[0],r[1],this._sheet):new Oi(n[0],r[0],n[1],r[1],this._sheet)}return null}},{key:"union",value:function(e){this._sheet!==e.sheet()&&console.error("cant union two range in different worksheet");var n=this.unionCol(e);return new t(n[0],n[1],this._sheet)}},{key:"clone",value:function(){var e=t.fromGridRange(this.toGridRange(),this._sheet);return this._sheet||(e.sheetName=this.sheetName),e}},{key:"canDecompile",value:function(){return this.colFrom()>=0&&this.colCount(!0)>0}},{key:"hashIter",value:function(){return new ai(this)}},{key:"toString",value:function(e){return this.canDecompile()?"".concat(this.sheetNameToString(e)).concat(this.colFromToString(e),":").concat(this.colToToString(e)):ut.REF_ERR_VAR.getValue()}},{key:"setRowFrom",value:function(e){console.warn("ColumnRange.setRowFrom not effect, row:",e)}},{key:"setRowCount",value:function(e){console.warn("ColumnRange.setRowCount not effect, rowCount:",e)}},{key:"sub",value:function(e){for(var n=Ti(this,e),r=0;r<n.length;r++){var a=n[r];a.rowFrom()===this.rowFrom()&&a.rowCount()===this.rowCount()&&(n[r]=new t(a.colFrom(),a.colCount(),this.sheet()))}return n}},{key:"id",value:function(){var e=!(arguments.length>0&&void 0!==arguments[0])||arguments[0],t="";if(e){var n=this.sheet();if(null==n)throw new Error("sheet is null");t+=n.id()+","}return"".concat(t).concat(we.xj7.COL,",").concat(this.colFrom(),",").concat(this.colCount())}}],[{key:"fromGridRange",value:function(e){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,r=new t(e.startCol,e.endCol-e.startCol,n,Fo(e.status));return r.sheetName=e.hostName,r}}]),t}(Ei),Ni=function(e){function t(e){var n,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;return(0,y.Z)(this,t),(n=(0,d.Z)(this,(0,v.Z)(t).call(this,0,Qa,0,Qa,e))).rgType=we.xj7.ALL,n.setRefStatus(r),n}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"onOp",value:function(e){}},{key:"offset",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,a=e||n>0,o=t||r>0;return a&&o?Oi.prototype.offset.call(this,e,t,n,r):o?Vi.prototype.offset.call(this,e,t,n,r):a?xi.prototype.offset.call(this,e,t,n,r):this.clone()}},{key:"rowEnd",value:function(){return(0,f.Z)((0,v.Z)(t.prototype),"rowEnd",this).call(this,!1)}},{key:"colEnd",value:function(){return(0,f.Z)((0,v.Z)(t.prototype),"colEnd",this).call(this,!1)}},{key:"intersect",value:function(e){return e.sheet()!==this._sheet?null:e.clone()}},{key:"union",value:function(e){return this._sheet!==e.sheet()&&console.error("cant union two range in different worksheet"),this.clone()}},{key:"hashIter",value:function(){return new ri(this)}},{key:"toString",value:function(e){return this.canDecompile()?"".concat(this.sheetNameToString(e)).concat(this.rowFromToString(e),":").concat(this.rowToToString(e)):ut.REF_ERR_VAR.getValue()}},{key:"clone",value:function(){return new t(this._sheet,this.refStatus())}},{key:"setRowFrom",value:function(e){console.warn("AllRange.setRowFrom not effect")}},{key:"setRowCount",value:function(e){console.warn("AllRange.setRowCount not effect")}},{key:"setColFrom",value:function(e){console.warn("AllRange.setColFrom not effect")}},{key:"setColCount",value:function(e){console.warn("AllRange.setColCount not effect")}},{key:"sub",value:function(e){for(var t=Ti(this,e),n=0;n<t.length;n++){var r=t[n];r.colFrom()===this.colFrom()&&r.colCount()===this.colCount()&&(t[n]=new xi(r.rowFrom(),r.rowCount(),this._sheet)),r.rowFrom()===this.rowFrom()&&r.rowCount()===this.rowCount()&&(t[n]=new Vi(r.colFrom(),r.colCount(),this.sheet()))}return t}},{key:"setRefStatus",value:function(e){this.status=bo(e,15)}},{key:"id",value:function(){var e=!(arguments.length>0&&void 0!==arguments[0])||arguments[0],t="";if(e){var n=this.sheet();if(null==n)throw new Error("sheet is null");t+=n.id()+","}return"".concat(t).concat(we.xj7.ALL)}}]),t}(Ei),Oi=function(e){function t(e,n,r,a,o){var i,u=arguments.length>5&&void 0!==arguments[5]?arguments[5]:0;return(0,y.Z)(this,t),(i=(0,d.Z)(this,(0,v.Z)(t).call(this,e,e+r,n,n+a,o))).rgType=we.xj7.NORMAL,i.setRefStatus(u),i}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"intersect",value:function(e){if(this._sheet!==e.sheet())return null;if(e.rgType===we.xj7.ALL)return e;var n=this.intersectRow(e);if(null!==n){var r=this.intersectCol(e);if(null!==r)return new t(n[0],r[0],n[1],r[1],this._sheet)}return null}},{key:"union",value:function(e){this._sheet!==e.sheet()&&console.error("cant union two range in different worksheet");var n=this.unionRow(e),r=this.unionCol(e);return new t(n[0],r[0],n[1],r[1],this._sheet)}},{key:"hashIter",value:function(){return new ai(this)}},{key:"offset",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,a=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,o=this.rowInterval(),i=this.colInterval();return new t(o[0]+e,i[0]+n,r<=0?o[1]:r,a<=0?i[1]:a,this._sheet)}},{key:"clone",value:function(){var e=t.fromGridRange(this.toGridRange(),this._sheet);return this._sheet||(e.sheetName=this.sheetName),e}},{key:"toString",value:function(e){if(!this.canDecompile())return ut.REF_ERR_VAR.getValue();var t=this.sheetNameToString(e),n=this.rowFromToString(e),r=this.colFromToString(e),a=this.rowToToString(e),o=this.colToToString(e),i=r===o&&n===a;return e&&"R1C1"===e.refStyle?"".concat(t).concat(n).concat(r).concat(i?"":":".concat(a).concat(o)):"".concat(t).concat(r).concat(n).concat(i?"":":".concat(o).concat(a))}},{key:"toSimpleObj",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=e.withoutCheck,n=void 0!==t&&t;return Object.assign({type:we.xj7.NORMAL},this.toJSON(n))}},{key:"toJSON",value:function(e){return e?{row:this.rowFrom(),col:this.colFrom(),rowCount:this.rowCount(!0),colCount:this.colCount(!0)}:(0,f.Z)((0,v.Z)(t.prototype),"toJSON",this).call(this)}},{key:"toNormalRange",value:function(){return{row:this.rowFrom(),col:this.colFrom(),row_count:this.rowCount(),col_count:this.colCount()}}},{key:"sub",value:function(e){return Ti(this,e)}},{key:"setRefStatus",value:function(e){this.status=bo(e,0)}},{key:"splitByRow",value:function(){for(var e=this.rowFrom(),n=this.rowTo(),r=this.colFrom(),a=this.colCount(),o=[],i=e;i<=n;i++){var u=new t(i,r,1,a,this._sheet);o.push(u)}return o}},{key:"id",value:function(){var e=!(arguments.length>0&&void 0!==arguments[0])||arguments[0],t="";if(e){var n=this.sheet();if(null==n)throw new Error("sheet is null");t+=n.id()+","}return"".concat(t).concat(we.xj7.NORMAL,",").concat(this.rowFrom(),",").concat(this.colFrom(),",").concat(this.rowCount(),",").concat(this.colCount())}}],[{key:"toNormalRange",value:function(e){return new t(e.rowFrom(),e.colFrom(),e.rowCount(),e.colCount(),e.sheet())}},{key:"fromJSON",value:function(e,n,r){switch(n){case we.xj7.ROW:return new xi(e.row,e.rowCount,r);case we.xj7.COL:return new Vi(e.col,e.colCount,r);case we.xj7.ALL:return new Ni(r);default:return new t(e.row,e.col,e.rowCount,e.colCount,r)}}},{key:"fromGridRange",value:function(e){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,r=new t(e.startRow,e.startCol,e.endRow-e.startRow,e.endCol-e.startCol,n,Fo(e.status));return r.sheetName=e.hostName,r}}]),t}(Ei),xi=function(e){function t(e,n,r){var a,o=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0;return(0,y.Z)(this,t),(a=(0,d.Z)(this,(0,v.Z)(t).call(this,e,e+n,0,Qa,r))).rgType=we.xj7.ROW,a.setRefStatus(o),a}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"setRefStatus",value:function(e){this.status=bo(e,3)}},{key:"offset",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,a=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0;return 0!==n||a>0?Oi.prototype.offset.call(this,e,n,r,a):new t(this.rowFrom()+e,r<=0?this.rowCount(!0):r,this._sheet)}},{key:"colFrom",value:function(){return 0}},{key:"colEnd",value:function(){return(0,f.Z)((0,v.Z)(t.prototype),"colEnd",this).call(this,!1)}},{key:"intersect",value:function(e){if(this._sheet!==e.sheet())return null;if(e.rgType===we.xj7.ALL)return e;var n=this.intersectCol(e);if(null!==n){var r=this.intersectRow(e);if(null!==r)return ao(n,this.colInterval())?new t(r[0],r[1],this._sheet):new Oi(r[0],n[0],r[1],n[1],this._sheet)}return null}},{key:"union",value:function(e){this._sheet!==e.sheet()&&console.error("cant union two range in different worksheet");var n=this.unionRow(e);return new t(n[0],n[1],this._sheet)}},{key:"hashIter",value:function(){return new ai(this)}},{key:"toString",value:function(e){return this.canDecompile()?"".concat(this.sheetNameToString(e)).concat(this.rowFromToString(e),":").concat(this.rowToToString(e)):ut.REF_ERR_VAR.getValue()}},{key:"clone",value:function(){var e=t.fromGridRange(this.toGridRange(),this._sheet);return this._sheet||(e.sheetName=this.sheetName),e}},{key:"canDecompile",value:function(){return this.rowFrom()>=0&&this.rowCount(!0)>0}},{key:"setColFrom",value:function(e){console.warn("RowRange.setColFrom not effect")}},{key:"setColCount",value:function(e){console.warn("RowRange.setColCount not effect, colCount")}},{key:"sub",value:function(e){for(var n=Ai(this,e),r=0;r<n.length;r++){var a=n[r];a.colFrom()===this.colFrom()&&a.colCount()===this.colCount()&&(n[r]=new t(a.rowFrom(),a.rowCount(),this._sheet))}return n}},{key:"id",value:function(){var e=!(arguments.length>0&&void 0!==arguments[0])||arguments[0],t="";if(e){var n=this.sheet();if(null==n)throw new Error("sheet is null");t+=n.id()+","}return"".concat(t).concat(we.xj7.ROW,",").concat(this.rowFrom(),",").concat(this.rowCount())}}],[{key:"fromGridRange",value:function(e){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,r=new t(e.startRow,e.endRow-e.startRow,n,Fo(e.status));return r.sheetName=e.hostName,r}}]),t}(Ei),Zi=function(e){function t(e,n,r){var a,o=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0;return(0,y.Z)(this,t),(a=(0,d.Z)(this,(0,v.Z)(t).call(this,e,n,1,1,r,o))).rgType=we.xj7.CELL,a}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"rowCount",value:function(){return(0,f.Z)((0,v.Z)(t.prototype),"rowCount",this).call(this,!0)}},{key:"colCount",value:function(){return(0,f.Z)((0,v.Z)(t.prototype),"colCount",this).call(this,!0)}},{key:"isValidRefInSheet",value:function(){return null!=this._sheet&&this.rowFrom()>=0&&this.colFrom()>=0&&1===this.rowCount()&&1===this.colCount()}},{key:"clone",value:function(){var e=t.fromGridRange(this.toGridRange(),this._sheet);return this._sheet||(e.sheetName=this.sheetName),e}},{key:"toString",value:function(e){return this.canDecompile()?e&&"R1C1"===e.refStyle?"".concat(this.sheetNameToString(e)).concat(this.rowFromToString(e)).concat(this.colFromToString(e)):"".concat(this.sheetNameToString(e)).concat(this.colFromToString(e)).concat(this.rowFromToString(e)):ut.REF_ERR_VAR.getValue()}},{key:"id",value:function(){var e=this.sheet();if(null==e)throw new Error("sheet is null");return"".concat(e.id(),",").concat(we.xj7.CELL,",").concat(this.rowFrom(),",").concat(this.colFrom())}}],[{key:"fromGridRange",value:function(e){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,r=new t(e.startRow,e.startCol,n,Fo(e.status));return r.sheetName=e.hostName,r}}]),t}(Oi);function Di(e,t,n,r){for(var a=0,o=e.length-1;a<=o;){var i=a+o>>1,u=n(t,e[i]);if(u>0)a=i+1;else{if(!(u<0))return i;o=i-1}}return r&&e.length>0?a<o?a:o:-1}!function(e){e.MoveRangeOp="MoveRangeOp",e.DelSheetOp="DelSheetOp"}(Ii||(Ii={}));var Pi=function(e){function t(){var e;return(0,y.Z)(this,t),(e=(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))).isValidRef=e.isValid(),e}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"rowInterval",value:function(e){return(0,f.Z)((0,v.Z)(t.prototype),"rowInterval",this).call(this,!0)}},{key:"isIntersect",value:function(e){return this._sheet===e.sheet()&&!!this.isValidRef&&(e.rgType===we.xj7.ALL||e.rgType===we.xj7.COL||this.rowFrom()<=e.rowTo(!0))}}]),t}(xi),Li=function(e){function t(){var e;return(0,y.Z)(this,t),(e=(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))).isValidRef=e.isValid(),e}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"colInterval",value:function(e){return(0,f.Z)((0,v.Z)(t.prototype),"colInterval",this).call(this,!0)}},{key:"isIntersect",value:function(e){return this._sheet===e.sheet()&&!!this.isValidRef&&(e.rgType===we.xj7.ALL||e.rgType===we.xj7.ROW||this.colFrom()<=e.colTo(!0))}}]),t}(Vi);function Bi(e,t){return e<t.target?-1:e>t.target+t.count-1?1:0}var Ui=function(){function e(t,n){(0,y.Z)(this,e),this.sheet=n,this.instanceType="DelRowOp";var r=0;this.ranges=t.map((function(e){var t=e.target,n=e.count;return{target:t,count:n,total:r+=n}}))}return(0,C.Z)(e,[{key:"effectedRef",value:function(){return[new Pi(this.ranges[0].target,1/0,this.sheet)]}},{key:"type",value:function(){return"delete"}},{key:"isRowType",value:function(){return!0}},{key:"onOp",value:function(e){var t,n,r=e.rowFrom(),a=e.rowTo(!0)+1,o=Di(this.ranges,r,Bi,!0),i=Di(this.ranges,a,Bi,!0),u=this.ranges[o],s=this.ranges[i];u&&(r>u.target+u.count-1?r-=u.total:r=u.target-((null===(t=this.ranges[o-1])||void 0===t?void 0:t.total)||0)),s&&(a>s.target+s.count-1?a-=s.total:a=s.target-((null===(n=this.ranges[i-1])||void 0===n?void 0:n.total)||0)),e.setRowFrom(r),e.setRowCount(a-r)}}]),e}(),Hi=function(){function e(t,n,r){(0,y.Z)(this,e),this._type=t,this._start=n,this._size=r}return(0,C.Z)(e,[{key:"type",value:function(){return this._type}},{key:"segOpType",value:function(){return this._type}},{key:"effectedRef",value:function(){throw new Error("should never be call")}},{key:"from",value:function(){return this._start}},{key:"size",value:function(){return this._size}},{key:"to",value:function(){return this._start+this._size-1}}]),e}(),Wi=function(e){function t(e,n,r,a,o){var i;return(0,y.Z)(this,t),(i=(0,d.Z)(this,(0,v.Z)(t).call(this,n,r,a)))._isRow=e,i._sheet=o,i.instanceType="RowColOp",i.ranges=[{target:r,count:a,total:a}],i}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"isRowType",value:function(){return this._isRow}},{key:"effectedRef",value:function(){return this._isRow?[new Pi(this.from(),1/0,this._sheet)]:[new Li(this.from(),1/0,this._sheet)]}}]),t}(Hi),ji=function(){function e(t,n,r,a){(0,y.Z)(this,e),this._src=t,this._toSheet=n,this._toRow=r,this._toCol=a,this.instanceType="MoveRangeOP",this.toEdgeAdjust=!1}return(0,C.Z)(e,[{key:"type",value:function(){return"MoveRangeOp"}},{key:"setShouldAdjustToEdge",value:function(e){this.toEdgeAdjust=e}},{key:"effectedRef",value:function(){var e=this._src.clone(),t=this.targetRange();return 0===e.colCount(!0)&&0===t.colCount(!0)&&e.rowFrom()===t.rowFrom()||0===e.rowCount(!0)&&0===t.rowCount(!0)&&e.colFrom()===t.colFrom()?[e.union(t)]:[this._src.clone(),this.targetRange()]}},{key:"srcRange",value:function(){return this._src}},{key:"targetRange",value:function(){var e=this._toSheet,t=Math.min(this._toRow+this._src.rowCount(),e.getRowCount()),n=Math.max(this._toRow,0),r=Math.min(this._toCol+this._src.colCount(),e.getColumnCount()),a=Math.max(this._toCol,0);return new Oi(n,a,t-n,r-a,e)}}]),e}(),zi=function(){function e(t){(0,y.Z)(this,e),this.sheet=t,this.instanceType="DelSheetOp"}return(0,C.Z)(e,[{key:"type",value:function(){return"DelSheetOp"}},{key:"effectedRef",value:function(){return[new Ni(this.sheet)]}},{key:"getSheet",value:function(){return this.sheet}}]),e}();function Gi(e,t,n,r){var a,o=arguments.length,i=o<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,n):r;if("object"==("undefined"==typeof Reflect?"undefined":(0,_.Z)(Reflect))&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,n,r);else for(var u=e.length-1;u>=0;u--)(a=e[u])&&(i=(o<3?a(i):o>3?a(t,n,i):a(t,n))||i);return o>3&&i&&Object.defineProperty(t,n,i),i}function Ji(e,t){return function(n,r){t(n,r,e)}}function qi(e){var t=(0,p.Z)(e,2),n=t[0],r=t[1];return!(n<0||r<=0||n>n+r)}function $i(e,t){var n=(0,p.Z)(e,2),r=n[0],a=n[1],o=(0,p.Z)(t,2),i=o[0],u=o[1],s=r+a,l=i+u;return r===i&&a===u?Mi.Equal:r===l||s===i?Mi.EmptyButPoint:r<=i&&s>=l?Mi.Include:r>=i&&s<=l?Mi.BeIncluded:r>=i&&r<=l||i>=r&&i<=s?Mi.IntersectedNotInlcude:Mi.Empty}function Yi(e,t){var n=(0,p.Z)(e,2),r=n[0],a=n[1],o=(0,p.Z)(t,2),i=o[0],u=r+a-1,s=i+o[1]-1,l=Math.max(r,i),c=Math.min(u,s);return r===l?[[c+1,u-c]]:u===c?[[r,l-r]]:[[r,l-r],[c+1,Math.max(u,s)-c]]}function Ki(e,t){var n=(0,p.Z)(e,2),r=n[0],a=n[1],o=(0,p.Z)(t,2),i=o[0],u=o[1],s=Math.max(r,i);return[s,Math.min(r+a,i+u)-s]}function Xi(e,t){return e===we.xj7.ROW?{type:we.xj7.ROW,row:t[0],rowCount:t[1]}:{type:we.xj7.COL,col:t[0],colCount:t[1]}}function Qi(e){return e.type===we.xj7.ROW?[e.row,e.rowCount]:[e.col,e.colCount]}"function"==typeof SuppressedError&&SuppressedError,function(e){e[e.One=1]="One",e[e.Two=2]="Two",e[e.Three=3]="Three",e[e.Four=4]="Four",e[e.Five=5]="Five",e[e.Six=6]="Six",e[e.Seven=7]="Seven"}(bi||(bi={})),function(e){e[e.Expand=0]="Expand",e[e.Fold=1]="Fold"}(Fi||(Fi={})),function(e){e[e.Empty=0]="Empty",e[e.Equal=1]="Equal",e[e.Include=2]="Include",e[e.BeIncluded=3]="BeIncluded",e[e.EmptyButPoint=4]="EmptyButPoint",e[e.IntersectedNotInlcude=5]="IntersectedNotInlcude"}(Mi||(Mi={}));var eu=function(e,t,n){return n?{type:we.xj7.ROW,row:e,rowCount:t}:{type:we.xj7.COL,col:e,colCount:t}};function tu(e,t){var n=[],r=Qi(t),a=r[0],o=r[1];if(0===e.length)return[[a,o]];var i=a+o,u=[];e.forEach((function(e){u.push(e.start,e.start+e.count)})),u.push(a,a+o),u=(0,ye.Z)(u).sort((function(e,t){return e-t}));for(var s=0;s<u.length;s++){var l=u[s];if(i===l)return n.push([a,i-a]),n;if(a<l&&i>l)n.push([a,l-a]),a=l;else if(i<l)return n.push([a,i-a]),n}return n}function nu(e){for(var t=e.sort((function(e,t){return e.start!==t.start?e.start-t.start:t.count-e.count})),n=0;n<t.length;n++){var r=t[n];qi([r.start,r.count])||(r.tag=1);for(var a=n+1;a<t.length;a++){var o=t[a];1!==o.tag&&1!==r.tag&&r.start+r.count===o.start&&(r.count+=o.count,r.state=we.w2y.Expand,o.tag=1)}}for(var i=t.length-1;i>=0;i--)1===t[i].tag&&t.splice(i,1);return t}function ru(e){e.sort((function(e,t){return e.start!==t.start?e.start-t.start:t.count-e.count})),e.forEach((function(e){return e.level=bi.One}));for(var t=0,n=1;t<e.length;){var r=e[t],a=e[n];a&&ou(r,a)?(a.level!==r.level+1&&(a.level=r.level+1),r.state===we.w2y.Fold&&(a.visible=!1),n++):n=++t+1}return e}function au(e,t,n){t.forEach((function(t){var r=t.start,a=t.count,o=t.state;e.forEach((function(e){e.start===r&&e.count===a&&(e.state=o),n&&e.start===n[0]&&e.count===n[1]&&(e.state=n[2])}))}))}function ou(e,t){var n=e.start,r=e.count,a=t.start,o=t.count;return n<=a&&n+r>=a+o}function iu(e,t){var n=e.start,r=e.count,a=t.start,o=t.count;return n===a&&r===o}var uu=function(){function e(){(0,y.Z)(this,e),this._rowOutlines$=new vt.X([]),this._colOutlines$=new vt.X([]),this._hiddenSetChangedVersion$=new vt.X(0),this.colCollapsedStartSet=new Set,this.rowCollapsedStartSet=new Set,this._rowHiddenSet$=new vt.X(new Set),this._colHiddenSet$=new vt.X(new Set),this.rowOutlines$=this._rowOutlines$.asObservable(),this.colOutlines$=this._colOutlines$.asObservable(),this.hiddenSetChangedVersion$=this._hiddenSetChangedVersion$.asObservable()}return(0,C.Z)(e,[{key:"toJSON",value:function(){var e=[];return this.rowOutlineTree.forEach((function(t){var n=t.state,r=t.start,a=t.count;e.push({state:n,target:{type:we.xj7.ROW,row:r,rowCount:a}})})),this.colOutlineTree.forEach((function(t){var n=t.state,r=t.start,a=t.count;e.push({state:n,target:{type:we.xj7.COL,col:r,colCount:a}})})),e}},{key:"fromJSON",value:function(e){var t,n=_n(e);try{for(n.s();!(t=n.n()).done;){var r=t.value,a=r.state,o=r.target,i=this.buildOutlineNode(a,o);if(!i)return;o.type===we.xj7.ROW?this.rowOutlineTree.push(i):this.colOutlineTree.push(i)}}catch(e){n.e(e)}finally{n.f()}ru(this.rowOutlineTree),ru(this.colOutlineTree),this.refresh(we.xj7.ROW),this.refresh(we.xj7.COL)}},{key:"serialize",value:function(e,t){function n(t){var n=t.state,r=t.start,a=t.count;e.push({info:{collapsed:n===Fi.Fold},range:{start:r,end:r+a}})}t?this.rowOutlineTree.forEach(n):this.colOutlineTree.forEach(n)}},{key:"deserialize",value:function(e,t){if(0!==e.length){for(var n=!1,r=0,a=e.length;r<a;r++){var o=e[r],i=o.info,u=o.range;i&&void 0!==i.collapsed&&u&&(n=!0,t?this.rowOutlineTree.push({type:we.xj7.ROW,start:u.start,count:u.end-u.start,level:bi.One,state:i.collapsed?Fi.Fold:Fi.Expand,visible:!0}):this.colOutlineTree.push({type:we.xj7.COL,start:u.start,count:u.end-u.start,level:bi.One,state:i.collapsed?Fi.Fold:Fi.Expand,visible:!0}))}n&&(ru(this.rowOutlineTree),ru(this.colOutlineTree),this.refresh(we.xj7.ROW),this.refresh(we.xj7.COL))}}},{key:"getAllStartPointsOfFoldLines",value:function(e){return e===we.xj7.ROW?this.rowCollapsedStartSet:this.colCollapsedStartSet}},{key:"isRowColHidden",value:function(e,t){return e===we.xj7.ROW?this.rowHiddenSet.has(t):this.colHiddenSet.has(t)}},{key:"getEntireMatchOutlines",value:function(e){var t=e.type===we.xj7.ROW?this.rowOutlineTree:this.colOutlineTree,n=Qi(e),r=(0,p.Z)(n,2),a=r[0],o=r[1];return t.filter((function(e){return e.start===a&&e.count===o}))}},{key:"getInfluencedOutlines",value:function(e){var t=e.type===we.xj7.ROW?this.rowOutlineTree:this.colOutlineTree,n=Qi(e);return t.filter((function(e){var t=[e.start,e.count],r=$i(n,t);return!(r===Mi.Empty||r===Mi.EmptyButPoint)}))}},{key:"getBeInludedOutlines",value:function(e){var t=e.type===we.xj7.ROW?this.rowOutlineTree:this.colOutlineTree,n=Qi(e),r=(0,p.Z)(n,2),a=r[0],o=r[1],i=a+o;return t.filter((function(e){return e.start>=a&&e.start+e.count<=i}))}},{key:"getBehindOutlines",value:function(e,t){return(e===we.xj7.ROW?this.rowOutlineTree:this.colOutlineTree).filter((function(e){return e.start>=t}))}},{key:"addRange",value:function(e,t){var n=this,r=e.type,a=Qi(e),o=(0,p.Z)(a,2),i=o[0],u=o[1],s=r===we.xj7.ROW?this.rowOutlineTree:this.colOutlineTree,l=this.getInfluencedOutlines(e),c=ya(l);tu(l,e).map((function(e){n.addOutline(Xi(r,e),t)})),nu(s),ru(s),au(s,c,[i,u,t]),this.refresh(r)}},{key:"cancelRange",value:function(e){for(var t=e.type,n=t===we.xj7.ROW?this.rowOutlineTree:this.colOutlineTree,r=this.getInfluencedOutlines(e),a=ya(n),o=tu(r,e),i=0;i<o.length;i++){var u=o[i],s=this.getInfluencedOutlines(Xi(t,u)).sort((function(e,t){return e.count-t.count}));if(0!==s.length){var l=s[0],c=l.start,h=l.count,f=l.state;if(c===u[0]&&h===u[1])this.deleteOutline(l);else{var d=Yi([c,h],u);this.deleteOutline(l),this.addOutline(Xi(t,d[0]),f),d[1]&&this.addOutline(Xi(t,d[1]),f)}}}nu(n),ru(n),au(n,a),this.refresh(t)}},{key:"adjustOutlineAfterAddRowCol",value:function(e,t,n){var r=this,a=e===we.xj7.ROW?this.rowOutlineTree:this.colOutlineTree,o=this.getBehindOutlines(e,t);o.forEach((function(e){return e.start+=n}));var i=ya(o),u=this.getInfluencedOutlines(Xi(e,[t-1,1])),s=ya(u);u.forEach((function(e){return r.deleteOutline(e)})),s.forEach((function(a){var o=a.state;(function(e,t){var n=Qi(e),r=(0,p.Z)(n,2),a=r[0],o=r[1],i=a+o,u=t.start;return[[u,a-u],[i,u+t.count+o-i]].filter((function(e){return qi(e)}))})(Xi(e,[t,n]),a).forEach((function(t){r.addOutline(Xi(e,t),o)}))})),nu(a),ru(a),au(a,i),this.refresh(e)}},{key:"adjustOutlineAfterDelRowCol",value:function(e,t,n){var r=e===we.xj7.ROW?this.rowOutlineTree:this.colOutlineTree,a=t+n;this.getBehindOutlines(e,a).forEach((function(e){return e.start-=n})),nu(r),ru(r),this.refresh(e)}},{key:"updateOutline",value:function(e,t){var n=this.getEntireMatchOutlines(e);if(0===n.length)return!1;var r=n[0].type;return n.forEach((function(e){e.state=t})),this.refresh(r),!0}},{key:"addOutline",value:function(e,t){var n=this.buildOutlineNode(t,e),r=e.type;n&&(r===we.xj7.ROW?this.rowOutlineTree.push(n):this.colOutlineTree.push(n))}},{key:"deleteOutline",value:function(e){var t=e.type===we.xj7.ROW?this.rowOutlineTree:this.colOutlineTree;return-1!==t.indexOf(e)&&(t.splice(t.indexOf(e),1),!0)}},{key:"pushOutlinePipe",value:function(e){e===we.xj7.ROW?this._rowOutlines$.next(this.rowOutlineTree):this._colOutlines$.next(this.colOutlineTree)}},{key:"setVisibleAndHiddenSet",value:function(e){var t=e===we.xj7.ROW?this.rowOutlineTree:this.colOutlineTree;!function(e){for(var t=0,n=1;t<e.length;){var r=e[t];r.level===bi.One&&(r.visible=!0);var a=e[n];a&&ou(r,a)?(r.state===we.w2y.Fold||!1===r.visible?a.visible=!1:a.visible=!0,iu(r,a)&&(a.visible=r.visible),n++):n=1+ ++t}}(t);var n=function(e){var t=new Set,n=new Set;return e.forEach((function(e){if(e.state===we.w2y.Fold){var r=e.start,a=r+e.count;n.add(r);for(var o=r;o<a;o++)t.add(o)}})),{hiddentSet:t,startSet:n}}(t);e===we.xj7.ROW?(this._rowHiddenSet$.next(n.hiddentSet),this.rowCollapsedStartSet=n.startSet):(this._colHiddenSet$.next(n.hiddentSet),this.colCollapsedStartSet=n.startSet),this._hiddenSetChangedVersion$.next(1^this.hiddenSetChangedVersion)}},{key:"buildOutlineNode",value:function(e,t){var n=t.type;if(n===we.xj7.ROW||n===we.xj7.COL)return n===we.xj7.ROW?{type:n,start:t.row,count:t.rowCount,level:bi.One,state:e,visible:!0}:{type:n,start:t.col,count:t.colCount,level:bi.One,state:e,visible:!0};console.error("[OUTLINE-GROUP]: 分组类型错误，无法创建分组")}},{key:"refresh",value:function(e){this.setVisibleAndHiddenSet(e),this.pushOutlinePipe(e)}},{key:"clear",value:function(){this.rowCollapsedStartSet.clear(),this.colCollapsedStartSet.clear(),this.rowHiddenSet.clear(),this.colHiddenSet.clear(),this._rowOutlines$.next([]),this._colOutlines$.next([]),this._rowOutlines$.complete(),this._colOutlines$.complete(),this._hiddenSetChangedVersion$.complete()}},{key:"destroy",value:function(){this.clear()}},{key:"rowOutlineTree",get:function(){return this._rowOutlines$.getValue()}},{key:"colOutlineTree",get:function(){return this._colOutlines$.getValue()}},{key:"rowHiddenSet",get:function(){return this._rowHiddenSet$.getValue()}},{key:"colHiddenSet",get:function(){return this._colHiddenSet$.getValue()}},{key:"hiddenSetChangedVersion",get:function(){return this._hiddenSetChangedVersion$.getValue()}}]),e}();function su(e,t,n,r,a){var o=a.row,i=r.sheet();return!!i&&i.filterModel.isVisible(o)}function lu(e,t,n,r,a){var o=a.row,i=r.sheet();return!!i&&i.getRowVisible(o)}function cu(e){return!e.isError()}function hu(e,t,n,r,a){var o=a.row,i=a.col,u=r.sheet();if(!u)return!1;var s=u.getVar(o,i);return!s.isFormula()||!s.formula.hasSubtotal}function fu(e,t,n,r,a){var o=a.row,i=a.col,u=r.sheet();if(!u)return!1;var s=u.getVar(o,i);return!s.isFormula()||!s.formula.hasAggregate}function du(e,t,n,r,a){var o=a.row,i=r.sheet();return!!i&&!(null==i?void 0:i.inject(uu)).isRowColHidden(we.xj7.ROW,o)}Gi([(0,lt.P)()],uu.prototype,"destroy",null),uu=Gi([(0,ct.b)()],uu);var vu=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[],n=arguments.length>1?arguments[1]:void 0,r=arguments.length>2&&void 0!==arguments[2]&&arguments[2];(0,y.Z)(this,e),this._sheet=n,this._ranges=r?t:t.map((function(e){switch(e.type){case we.xj7.ROW:return new xi(e.row,e.rowCount,n);case we.xj7.COL:return new Vi(e.col,e.colCount,n);case we.xj7.ALL:return new Ni(n);case we.xj7.CELL:return new Zi(e.row,e.col,n);case we.xj7.NORMAL:default:return new Oi(e.row,e.col,e.rowCount,e.colCount,n)}}))}return(0,C.Z)(e,[{key:"intersect",value:function(e){var t=[];return this.iter((function(n){var r=n.intersect(e);r&&t.push(r)})),t.length?t:null}},{key:"isIntersect",value:function(e){var t=this;return Array.isArray(e)?e.some((function(e){return t.isIntersect(e)})):this._ranges.some((function(t){return t.isIntersect(e)}))}},{key:"sub",value:function(e){var t=[];return this._ranges.forEach((function(n){var r=n.sub(e);t.push.apply(t,(0,m.Z)(r))})),t}},{key:"subRanges",value:function(t){var n=this,r=this;return t.forEach((function(t){var a=r.sub(t);r=new e(a,n._sheet,!0)})),r.getRanges()}},{key:"containCell",value:function(e,t){return this._ranges.some((function(n){return n.containCell(e,t)}))}},{key:"toString",value:function(e){return this.mapIfValid((function(t){return t.toString(e)})).join(",")}},{key:"mapIfValid",value:function(e){return this._ranges.filter((function(e){return e.isValidRefInSheet()})).map(e)}},{key:"isValid",value:function(){return this._ranges.every((function(e){return e.isValidRefInSheet()}))}},{key:"toJSON",value:function(){return this.mapIfValid((function(e){return e.toJSON()}))}},{key:"toTypedRanges",value:function(){return this.mapIfValid((function(e){return li(e)}))}},{key:"getRanges",value:function(){return this._ranges}},{key:"getRange",value:function(e){return this._ranges[e]}},{key:"iter",value:function(e){return this._ranges.forEach(e)}},{key:"insert",value:function(e){this._ranges.push(e)}},{key:"size",value:function(){return this._ranges.length}},{key:"sheet",value:function(){return this._sheet}}]),e}();function gu(e,t){return(e=(0,ut.varCheck)(e)).isPrimitive()||(e=(0,ut.varCheck)(e.getVar(t))),e}var mu=function(e){function t(e,n){var r;return(0,y.Z)(this,t),(r=(0,d.Z)(this,(0,v.Z)(t).call(this)))._refs=e,r._ctx=n,r._value=null,r._rgIdx=-1,r._iter=null,r}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"nextRange",value:function(){return this._refs[++this._rgIdx]}},{key:"asyncNext",value:function(){var e=this.innerNext();if(null===e)return null;if(!e.isAsync())return e;if(e.isResolved())return e.getVar();throw e}},{key:"next",value:function(){return this.innerNext()}},{key:"innerNext",value:function(){if(null===this._iter){var e,t=this.nextRange();if(!t)return null;if(!t.isValidRefInSheet(!0))return this._iter=null,we.d$b[we.O6N.REF_INVALID_CELL_REFERENCE]({funcName:"",index:-1,value:""});this._sheet=t.sheet(),null!==(e=this._ctx)&&void 0!==e&&e.skipEmptyRef?this._iter=this._sheet._dataModel.orderedIterCell(t.rowFrom(),t.colFrom(),t.rowCount(),t.colCount()):this._iter=new pu(t.rowFrom(),t.colFrom(),t.rowCount(),t.colCount())}for(var n=this._iter.next();null!==n;n=this._iter.next()){var r,a=void 0;if(null!==(r=this._ctx)&&void 0!==r&&r.skipEmptyRef){var o=this._iter.position();if((a=this._sheet._dataModel.getVarByContent(n,o.row,o.col)).isNull())continue}else a=this._sheet.getVar(this._iter.cellPosition.row,this._iter.cellPosition.col);return this._value=gu(a,this._ctx),this._value}return this._iter=null,this.next()}},{key:"value",value:function(){return this._value}},{key:"getCurrRow",value:function(){return this._iter?this._iter.cellPosition.row:-1}},{key:"getCurrCol",value:function(){return this._iter?this._iter.cellPosition.col:-1}}]),t}(Rt.FIterator),pu=function(){function e(t,n,r,a){(0,y.Z)(this,e),this._colFrom=n,this.cellPosition={row:t,col:n-1},this._rowTo=t+r-1,this._colTo=n+a-1}return(0,C.Z)(e,[{key:"next",value:function(){if(this.cellPosition.col+=1,this.cellPosition.col>this._colTo){if(this.cellPosition.row+=1,this.cellPosition.row>this._rowTo)return null;this.cellPosition.col=this._colFrom}return!0}},{key:"position",value:function(){return this.cellPosition}}]),e}(),yu=function(e){function t(e){var n;return(0,y.Z)(this,t),(n=(0,d.Z)(this,(0,v.Z)(t).call(this))).data=e,n.index=0,n}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"next",value:function(){var e=this.data[this.index++];return void 0!==e?(0,ut.boxValue)(e):null}},{key:"getCurrRow",value:function(){return 0}},{key:"getCurrCol",value:function(){return void 0!==this.index?this.index:-1}},{key:"getVar",value:function(e,t){return this.data[t]}}]),t}(Rt.FIterator);var Cu=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"getRow",value:function(){return Math.floor(this.idx/this.v.colCount())}},{key:"getCol",value:function(){return this.idx%this.v.colCount()}}]),t}(ut.CollectionVarIter),_u=function(e){function t(e,n){var r;return(0,y.Z)(this,t),(r=(0,d.Z)(this,(0,v.Z)(t).call(this)))._rowCount=e,r._colCount=n,r}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"id",value:function(){var e;return null!==(e=this._id)&&void 0!==e?e:""}},{key:"setId",value:function(e){this._id=e}},{key:"rowCount",value:function(){return this._rowCount}},{key:"colCount",value:function(){return this._colCount}},{key:"iter",value:function(e){return new Cu(this,e).do((function(e){return(0,ut.varCheck)(e)}))}},{key:"iterWithPos",value:function(e){var t=new Cu(this,e),n=new Array(3);return t.do((function(e){return(0,ut.varCheck)(e)})).map((function(e){return n[0]=e,n[1]=t.getRow(),n[2]=t.getCol(),n}))}},{key:"nth",value:function(e,t){if(e<0||e>=this.size())return ut.NULL_VAR;var n=Math.floor(e/this.colCount()),r=e%this.colCount();return this.getVarByPos(n,r,t)}},{key:"getExpandVarByPos",value:function(e,t,n){var r=this.rowCount(),a=this.colCount();return e>=r&&1===r&&(e=0),t>=a&&1===a&&(t=0),this.isPosOutOfBounds(e,t)?we.d$b[we.O6N.NA_ARRAY_SIZES_NOT_EQUAL]({funcName:""}):this.getVarByPos(e,t,n)}},{key:"idxVar",value:function(e,t){return this.nth(e,t)}},{key:"getVar",value:function(e){return this.getVarByPos(0,0,e)}},{key:"getValue",value:function(e){return this.getVar(e).getValue()}},{key:"valueCount",value:function(){return this.rowCount()*this.colCount()}},{key:"size",value:function(){return this.rowCount()*this.colCount()}},{key:"isPosOutOfBounds",value:function(e,t){return e<0||t<0||e>=this.rowCount()||t>=this.colCount()}},{key:"getFormatterByPos",value:function(e,t,n){var r,a,o,i,u=null===(r=this.getVarByPos(e,t).getSpecialInfo())||void 0===r||null===(a=r.customData)||void 0===a?void 0:a.autoFormat,s=null===(o=n.ref)||void 0===o||null===(i=o.sheet())||void 0===i?void 0:i.parent;return u&&s?s.formatterService.getFormatter(u):null}},{key:"getValueByPos",value:function(e,t){return this.getVarByPos(e,t).getValue()}}]),t}(ut.BaseCustomCollectionVar),Ru=function(e){function t(e){var n;return(0,y.Z)(this,t),(n=(0,d.Z)(this,(0,v.Z)(t).call(this,e.length,e.length>0?e[0].length:0))).primitiveVarArr=e,n}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"getVarByPos",value:function(e,t){var n;return null!==(n=this.primitiveVarArr[e]&&this.primitiveVarArr[e][t])&&void 0!==n?n:ut.NULL_VAR}},{key:"getCollectionValue",value:function(){return this.primitiveVarArr}},{key:"customType",get:function(){return"PrimitiveMatrixVar"}}]),t}(_u),wu=function(e){function t(e,n){var r;return(0,y.Z)(this,t),(r=(0,d.Z)(this,(0,v.Z)(t).call(this,e))).importRangeId=n,r}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"id",value:function(){return this.importRangeId}}]),t}(Ru),ku=function(e){function t(e){var n;return(0,y.Z)(this,t),(n=(0,d.Z)(this,(0,v.Z)(t).call(this,e.rowCount(),e.colCount()))).ref=e,n}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"getVarByPos",value:function(e,t,n){return this.ref.getVarByPos(e,t,n)}},{key:"customType",get:function(){return"RefMatrixVar"}}]),t}(_u),Su=function(e){function t(e){var n;return(0,y.Z)(this,t),(n=(0,d.Z)(this,(0,v.Z)(t).call(this))).ref=e,n}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"getSheetByRange",value:function(e){return e.sheet()||we.d$b[we.O6N.REF_INVALID_CELL_REFERENCE]({funcName:"",index:-1,value:""})}},{key:"toNumberVar",value:function(e){return this.nth(0).toNumberVar(e)}},{key:"toStringVar",value:function(e){return this.nth(0).toStringVar(e)}},{key:"toBooleanVar",value:function(e){return this.nth(0).toBooleanVar(e)}},{key:"isValid",value:function(){return this.getRef().isValid()}},{key:"toValidVar",value:function(){return this.isValid()?this:we.d$b[we.O6N.REF_INVALID_CELL_REFERENCE]({funcName:"",index:-1,value:""})}},{key:"iter",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{skipEmptyRef:!0};return void 0===e.skipEmptyRef&&(e.skipEmptyRef=!0),new mu([this.getRef()],e)}},{key:"iterWithPos",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{skipEmptyRef:!0};void 0===e.skipEmptyRef&&(e.skipEmptyRef=!0);var t=new mu([this.getRef()],e),n=new Array(3);return t.map((function(e){return n[0]=e,n[1]=t.getCurrRow(),n[2]=t.getCurrCol(),n}))}},{key:"size",value:function(){return this.getRef().size(!0)}},{key:"getRawVarByIndex",value:function(e){var t=this.getRef(),n=this.getSheetByRange(t);if(n instanceof ut.ErrorVar)return n;var r=t.colCount();return n.getVar(t.rowFrom()+Math.floor(e/r),t.colFrom()+e%r)}},{key:"getVarByPos",value:function(e,t,n){var r=this.getRef(),a=r.sheet().getVar(e+r.rowFrom(),t+r.colFrom());return a.isPrimitive()?a:gu(a.getVar(n),n)}},{key:"nth",value:function(e,t){var n=this.getRawVarByIndex(e);return n.isPrimitive()?n:gu(n.getVar(t),t)}},{key:"getRef",value:function(){return this.ref}},{key:"getVar",value:function(e){var t=this.getRef();if(!t.isValidRefInSheet(!0))return we.d$b[we.O6N.REF_INVALID_CELL_REFERENCE]({funcName:"",index:-1,value:""});if(1===this.size())return this.nth(0,e);if(!e)return we.d$b[we.O6N.INVALID_CELL_REFERENCE]({funcName:"",index:-1,value:""});var n=e.ref,r=n.rowFrom(),a=n.colFrom(),o=t.rowFrom(),i=t.colFrom(),u=t.rowTo(),s=t.colTo();return a>=i&&a<=s&&r>=o&&r<=u?t.sheet().getVar(r,a).getVar(e):a<i&&(r<o||r>u)||a>s&&(r<o||r>u)?ut.VALUE_ERR_VAR:a>=i&&a<=s?o!==u?ut.VALUE_ERR_VAR:t.sheet().getVar(o,a).getVar(e):r>=o&&r<=u?i!==s?ut.VALUE_ERR_VAR:t.sheet().getVar(r,i).getVar(e):ut.VALUE_ERR_VAR}},{key:"getValue",value:function(e){return this.getVar(e).getValue()}},{key:"rowCount",value:function(){return this.getRef().rowCount()}},{key:"colCount",value:function(){return this.getRef().colCount()}},{key:"toRefMatrix",value:function(){return new ku(this)}},{key:"toPrimitiveMatrix",value:function(e){for(var t=this.rowCount(),n=this.colCount(),r=[],a=0;a<t;a++){r[a]||(r[a]=[]);for(var o=0;o<n;o++)r[a][o]=this.getVarByPos(a,o,e)}return new Ru(r)}},{key:"isRef",value:function(){return!0}},{key:"equals",value:function(e){return e instanceof t&&this.getRef().equal(e.getRef())}},{key:"iterIf",value:function(e){var t=this,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{skipEmptyRef:!0},r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:mu;void 0===n.skipEmptyRef&&(n.skipEmptyRef=!0);var a=this.getRef(),o=new r([a],n),i={row:void 0,col:void 0};return o.filter((function(r){return i.row=o.getCurrRow(),i.col=o.getCurrCol(),e.every((function(e){return e(r,n,t,a,i)}))}))}},{key:"getFormatterByPos",value:function(e,t,n){var r=this.getRef();e+=r.rowFrom(),t+=r.colFrom();var a=this.getSheetByRange(r);return a instanceof ut.ErrorVar?a:a.getActualFormatter(e,t,n)}},{key:"getValueByPos",value:function(e,t,n){return this.getVarByPos(e,t,n).getValue()}},{key:"clone",value:function(){return new t(this.getRef().clone())}},{key:"customType",get:function(){return"SheetRefVar"}}]),t}(ut.BaseCustomCollectionVar),Eu=function(e){function t(e,n,r,a,o){var i;return(0,y.Z)(this,t),(i=(0,d.Z)(this,(0,v.Z)(t).call(this,a,o))).value=e,i.realRowCount=n,i.realColCount=r,i}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"getExpandVarByPos",value:function(e,t,n){for(var r=this.getRawVarByPos(e,t);Fu(r)||Au(r);)Fu(r)&&(r=r.toRefMatrix()),Au(r)&&(r=r.getExpandVarByPos(e,t,n));return gu(r,n)}},{key:"getVar",value:function(e){return this.getExpandVarByPos(0,0,e)}},{key:"getVarByPos",value:function(e,t,n){return this.getExpandVarByPos(e,t,n)}},{key:"getRawVarByPos",value:function(e,t){var n=this.realRowCount;e>=n&&(e=1===n?0:-1);var r=this.value[e];if(void 0===r)return ut.NA_ERR_VAR;var a=this.realColCount;t>=a&&(t=1===a?0:-1);var o=r[t];return void 0===o?ut.NA_ERR_VAR:o}},{key:"customType",get:function(){return"MixinMatrixVar"}}]),t}(_u),Tu=function(e){function t(e,n,r,a,o){var i;return(0,y.Z)(this,t),(i=(0,d.Z)(this,(0,v.Z)(t).call(this,a,o))).value=e,i.offsetRow=n,i.offsetCol=r,i}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"getVarByPos",value:function(e,t,n){return this.value.getVarByPos(e+this.offsetRow,t+this.offsetCol,n)}},{key:"customType",get:function(){return"SlicedMatrixVar"}}]),t}(_u);function Au(e){return e instanceof _u}function Iu(e){return e.isCustomCollection()&&"PrimitiveMatrixVar"===e.customType}function bu(e){return e.isCustomCollection()&&"MultipleRefsVar"===e.customType}function Fu(e){return e instanceof Su}function Mu(e){return e.isCustomCollection()&&"ProxyRefVar"===e.customType}function Vu(e){return e.isCustomCollection()&&"FixedSizeMatrixVar"===e.customType}function Nu(e){return e instanceof wu}function Ou(e,t,n){var r=e.colCount(),a=Math.min(Math.max(0,t),r-1),o=Math.min(Math.max(1,n),r-a);return 0===a&&r===o?e:new Tu(e,0,a,e.rowCount(),o)}function xu(e,t,n){var r=e.rowCount(),a=Math.min(Math.max(0,t),r-1),o=Math.min(Math.max(1,n),r-a);return 0===a&&r===o?e:new Tu(e,a,0,o,e.colCount())}var Zu,Du=String.raw(Ee||(Ee=(0,h.Z)(["R[-?(?:0|[1-9][0-9]*)]"],["R\\[-?(?:0|[1-9][0-9]*)\\]"]))),Pu="R".concat("[1-9][0-9]{0,6}"),Lu=String.raw(Te||(Te=(0,h.Z)(["C[-?(?:0|[1-9][0-9]*)]"],["C\\[-?(?:0|[1-9][0-9]*)\\]"]))),Bu="C".concat("[1-9][0-9]{0,4}"),Uu=String.raw(Ae||(Ae=(0,h.Z)(["(?:",")|(?:",")"])),Du,Pu),Hu=String.raw(Ie||(Ie=(0,h.Z)(["(?:",")|(?:",")"])),Lu,Bu),Wu=/[ \t\r\n]*(?::|\uFF1A)[ \t\r\n]*/,ju=new RegExp("(?:".concat(Uu,")(?:").concat(Hu,")")),zu=new RegExp("(?:".concat(ju.source,")")+Wu.source+"(?:".concat(ju.source,")")),Gu=new RegExp("(?:".concat(Uu,")")+Wu.source+"(?:".concat(Uu,")")),Ju=new RegExp("(?:".concat(Hu,")")+Wu.source+"(?:".concat(Hu,")")),qu=new RegExp("(?:".concat(Gu.source,")|(?:").concat(Ju.source,")|(?:").concat(zu.source,")|(?:").concat(ju.source,")")),$u=String.raw(be||(be=(0,h.Z)(["$?",""],["\\$?",""])),"[1-9][0-9]{0,6}"),Yu=String.raw(Fe||(Fe=(0,h.Z)(["$?",""],["\\$?",""])),"[a-zA-Z]{1,3}"),Ku=/[ \t\r\n]*(?::|\uFF1A)[ \t\r\n]*/,Xu=new RegExp("(?:".concat(Yu,")(?:").concat($u,")")),Qu=new RegExp("(?:".concat(Xu.source,")")+Ku.source+"(?:".concat(Xu.source,")")),es=new RegExp("(?:".concat($u,")")+Ku.source+"(?:".concat($u,")")),ts=new RegExp("(?:".concat(Yu,")")+Ku.source+"(?:".concat(Yu,")")),ns=new RegExp("(?:".concat(es.source,")|(?:").concat(ts.source,")|(?:").concat(Qu.source,")|(?:").concat(Xu.source,")"));!function(e){e.NAME="Name",e.ERROR_CONSTANT="ErrorConstant",e.REF_CONSTANT="RefConstant",e.FUNCTION_NAME="FunctionName",e.LOGICAL_CONSTANT="LogicalConstant",e.LOGICAL_TRUE="LogicalTrue",e.LOGICAL_FALSE="LogicalFalse",e.NUMERICAL_CONSTANT="NumericalConstant",e.STRING_CONSTANT="StringConstant",e.OPEN_PAREN="OpenParen",e.CLOSE_PAREN="CloseParen",e.OPEN_BRACE="OpenBrace",e.CLOSE_BRACE="CloseBrace",e.COLON="Colon",e.EXCLAMATION_MARK="ExclamationMark",e.COMMA="Comma",e.SEMICOLON="SemiColon",e.ADDITION_OPERATOR="AdditionOperator",e.PLUS="Plus",e.MINUS="Minus",e.MULTIPLICATION_OPERATOR="MultiplicationOperator",e.MULTIPLY="Multiply",e.DIVIDE="Divide",e.PERCENT="Percent",e.POWER="Power",e.CONCATENATE="Concatenate",e.COMPARISON_OPERATOR="ComparisonOperator",e.LESS_THAN_EQUALS="LessThanEquals",e.GREATER_THAN_EQUALS="GreaterThanEquals",e.NOT_EQUALS="NotEquals",e.LESS_THAN="LessThan",e.GREATER_THAN="GreaterThan",e.EQUALS="Equals",e.WHITE_SPACE="WhiteSpace",e.SINGLE_SHEET_PREFIX="SingleSheetPrefix",e.QUOTED_SINGLE_SHEET_PREFIX="QuotedSingleSheetPrefix",e.LOCAL_REFERENCE_A1="LocalReferenceA1",e.LOCAL_REFERENCE_R1C1="LocalReferenceR1C1",e.EXTERNAL_REFERENCE_A1="ExternalReferenceA1",e.EXTERNAL_REFERENCE_R1C1="ExternalReferenceR1C1",e.FIELD_NAME_REFERENCE_A1="FieldNameLocalReferenceA1"}(Zu||(Zu={}));var rs=String.raw(Me||(Me=(0,h.Z)(["[^\\/!*:[]'();{}#\"=<>&+-^%,（）：！，； \r\n\t]*"],["[^\\\\\\/!\\*:\\[\\]\\'\\(\\);{}#\"=<>&\\+\\-\\^%,\\uFF08\\uFF09\\uFF1A\\uFF01\\uFF0C\\uFF1B \\r\\n\\t]*"]))),as=String.raw(Ve||(Ve=(0,h.Z)(["[^\\/?!*:[]'();{}#\"=<>&+-^%,（）：！，； \r\n\t]+"],["[^\\\\\\/\\?!\\*:\\[\\]\\'\\(\\);{}#\"=<>&\\+\\-\\^%,\\uFF08\\uFF09\\uFF1A\\uFF01\\uFF0C\\uFF1B \\r\\n\\t]+"]))),os=String.raw(Ne||(Ne=(0,h.Z)(["[^\\/?.!*:[]'();{}#\"=<>&+-^%,（）：！，； \r\n\t]+"],["[^\\\\\\/\\?.!\\*:\\[\\]\\'\\(\\);{}#\"=<>&\\+\\-\\^%,\\uFF08\\uFF09\\uFF1A\\uFF01\\uFF0C\\uFF1B \\r\\n\\t]+"]))),is=(0,wt.createToken)({name:"Name",pattern:new RegExp("".concat(os).concat(rs))}),us=(0,wt.createToken)({name:"ErrorConstant",pattern:/#NULL!|#DIV\/0!|#VALUE!|#NAME\?|#NUM!|#N\/A/}),ss=(0,wt.createToken)({name:"RefConstant",pattern:/#REF!/}),ls=(0,wt.createToken)({name:"LogicalConstant",pattern:wt.Lexer.NA}),cs=(0,wt.createToken)({name:"LogicalTrue",pattern:/TRUE/i,longer_alt:is,categories:ls}),hs=(0,wt.createToken)({name:"LogicalFalse",pattern:/FALSE/i,longer_alt:is,categories:ls}),fs=(0,wt.createToken)({name:"NumericalConstant",pattern:/(?:[0-9]+(\.[0-9]*)?|\.[0-9]+)(?:E[+-]?[0-9]+)?/i}),ds=(0,wt.createToken)({name:"StringConstant",pattern:/"(?:[^"]|"")*"/}),vs=(0,wt.createToken)({name:"OpenParen",pattern:/(?:\(|\uFF08)[ \t\r\n]*/}),gs=(0,wt.createToken)({name:"CloseParen",pattern:/[ \t\r\n]*(?:\)|\uFF09)/}),ms=(0,wt.createToken)({name:"FunctionName",pattern:new RegExp(String.raw(Oe||(Oe=(0,h.Z)(["(?:[A-Za-z_])(?:[A-Za-z_.0-9])*",""])),vs.PATTERN.source))}),ps=(0,wt.createToken)({name:"OpenBrace",pattern:/{[ \t\r\n]*/}),ys=(0,wt.createToken)({name:"CloseBrace",pattern:/[ \t\r\n]*}/}),Cs=(0,wt.createToken)({name:"Colon",pattern:/[ \t\r\n]*(?::|\uFF1A)[ \t\r\n]*/}),_s=(0,wt.createToken)({name:"ExclamationMark",pattern:/[ \t\r\n]*(?:!|\uFF01)[ \t\r\n]*/}),Rs=(0,wt.createToken)({name:"Comma",pattern:/[ \t\r\n]*(?:,|\uFF0C)[ \t\r\n]*/}),ws=(0,wt.createToken)({name:"SemiColon",pattern:/[ \t\r\n]*(?:;|\uFF1B)[ \t\r\n]*/}),ks=(0,wt.createToken)({name:"AdditionOperator",pattern:wt.Lexer.NA}),Ss=(0,wt.createToken)({name:"Plus",pattern:/[ \t\r\n]*\+[ \t\r\n]*/,categories:ks}),Es=(0,wt.createToken)({name:"Minus",pattern:/[ \t\r\n]*-[ \t\r\n]*/,categories:ks}),Ts=(0,wt.createToken)({name:"MultiplicationOperator",pattern:wt.Lexer.NA}),As=(0,wt.createToken)({name:"Multiply",pattern:/[ \t\r\n]*\*[ \t\r\n]*/,categories:Ts}),Is=(0,wt.createToken)({name:"Divide",pattern:/[ \t\r\n]*\/[ \t\r\n]*/,categories:Ts}),bs=(0,wt.createToken)({name:"Percent",pattern:/[ \t\r\n]*%[ \t\r\n]*/}),Fs=(0,wt.createToken)({name:"Power",pattern:/[ \t\r\n]*\^[ \t\r\n]*/}),Ms=(0,wt.createToken)({name:"Concatenate",pattern:/[ \t\r\n]*&[ \t\r\n]*/}),Vs=(0,wt.createToken)({name:"ComparisonOperator",pattern:wt.Lexer.NA}),Ns=(0,wt.createToken)({name:"LessThanEquals",pattern:/[ \t\r\n]*<=[ \t\r\n]*/,categories:Vs}),Os=(0,wt.createToken)({name:"GreaterThanEquals",pattern:/[ \t\r\n]*>=[ \t\r\n]*/,categories:Vs}),xs=(0,wt.createToken)({name:"NotEquals",pattern:/[ \t\r\n]*<>[ \t\r\n]*/,categories:Vs}),Zs=(0,wt.createToken)({name:"LessThan",pattern:/[ \t\r\n]*<[ \t\r\n]*/,categories:Vs}),Ds=(0,wt.createToken)({name:"GreaterThan",pattern:/[ \t\r\n]*>[ \t\r\n]*/,categories:Vs}),Ps=(0,wt.createToken)({name:"Equals",pattern:/[ \t\r\n]*=[ \t\r\n]*/,categories:Vs}),Ls=(0,wt.createToken)({name:"WhiteSpace",pattern:new RegExp("[ \t\r\n]+")}),Bs=(0,wt.createToken)({name:"SingleSheetPrefix",pattern:new RegExp("(?:".concat(as,")").concat(_s.PATTERN.source))}),Us=(0,wt.createToken)({name:"QuotedSingleSheetPrefix",pattern:new RegExp("(?:".concat(/'(?:[^']|'')*'/.source,")").concat(_s.PATTERN.source))}),Hs=(0,wt.createToken)({name:"LocalReferenceA1",pattern:ns,longer_alt:is}),Ws=(0,wt.createToken)({name:"LocalReferenceR1C1",pattern:qu,longer_alt:is}),js=(0,wt.createToken)({name:"ExternalReferenceA1",pattern:new RegExp("(?:(".concat(Bs.PATTERN.source,")|(").concat(Us.PATTERN.source,"))(?:(").concat(Hs.PATTERN.source,")|(").concat(ss.PATTERN.source,"))"))}),zs=(0,wt.createToken)({name:"ExternalReferenceR1C1",pattern:new RegExp("(?:(".concat(Bs.PATTERN.source,")|(").concat(Us.PATTERN.source,"))(?:(").concat(Ws.PATTERN.source,")|(").concat(ss.PATTERN.source,"))"))}),Gs=(0,wt.createToken)({name:"FieldNameLocalReferenceA1",pattern:new RegExp("(?:".concat(/'(?:[^']|'')*'/.source,")")),longer_alt:js}),Js=(0,wt.createToken)({name:"FieldNameLocalReferenceA1",pattern:new RegExp("(?:".concat(/'(?:[^']|'')*'/.source,")")),longer_alt:zs}),qs=[ms,Gs,js,Hs,fs,cs,hs,ls,ds,vs,gs,ps,ys,Cs,_s,Rs,ws,Ss,Es,As,Is,bs,Fs,Ms,Ns,Os,xs,Zs,Ds,Ps,us,ss,Us,Bs,is,ks,Ts,Vs,Ls];var $s=function(){var e={};return qs.forEach((function(t){e[t.name]=t})),e.LocalReferenceR1C1=Ws,e.ExternalReferenceR1C1=zs,e}(),Ys=qs.map((function(e,t){return e===js?zs:e===Hs?Ws:e===Gs?Js:e})),Ks=[ms,fs,cs,hs,ls,ds,vs,gs,ps,ys,Cs,_s,Rs,ws,Ss,Es,As,Is,bs,Fs,Ms,Ns,Os,xs,Zs,Ds,Ps,us,ss,Us,Bs,is,js,Hs,ks,Ts,Vs,Ls],Xs=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,null,[{key:"getTractorLexerA1",value:function(){return null==this.tractorLexerA1&&(this.tractorLexerA1=new t(qs,{skipValidations:!0})),this.tractorLexerA1}},{key:"getTractorLexerR1C1",value:function(){return null==this.tractorLexerR1C1&&(this.tractorLexerR1C1=new t(Ys,{skipValidations:!0})),this.tractorLexerR1C1}},{key:"dispose",value:function(){this.tractorLexerA1=null,this.tractorLexerR1C1=null}}]),t}(wt.Lexer);function Qs(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"A1";switch(t){case"A1":var n=Xs.getTractorLexerA1();return{lexingResult:n.tokenize(e),lexer:n};case"R1C1":var r=Xs.getTractorLexerR1C1();return{lexingResult:r.tokenize(e),lexer:r};default:throw Error("RefStyle is not found!")}}var el=["LocalReferenceA1","LocalReferenceR1C1","ExternalReferenceA1","ExternalReferenceR1C1","FieldNameLocalReferenceA1"],tl=["AdditionOperator","Plus","Minus","MultiplicationOperator","Multiply","Divide","Percent","Power","Concatenate","ComparisonOperator","LessThanEquals","GreaterThanEquals","NotEquals","LessThan","GreaterThan","Equals"];function nl(){return ut.REF_ERR_VAR}function rl(e,t){var n,r=t.visit(e.lhs),a=t.visit(e.rhs),o=r,i=a;r.rowFrom()>a.rowFrom()&&(o=(n=[a,r])[0],i=n[1]);var u=4&o.refStatus(),s=8&i.refStatus(),l=t.context,c=l.ref,h=l.relativeRef?o.rowFrom()-c.startRow:o.rowFrom();return new xi(h,i.rowFrom()-o.rowFrom()+1,t.context.ref.sheet(),u|s)}function al(e,t){var n,r=t.visit(e.lhs),a=t.visit(e.rhs),o=r,i=a;r.colFrom()>a.colFrom()&&(o=(n=[a,r])[0],i=n[1]);var u=1&o.refStatus(),s=2&i.refStatus(),l=t.context,c=l.ref,h=l.relativeRef?o.colFrom()-c.startCol:o.colFrom();return new Vi(h,i.colFrom()-o.colFrom()+1,t.context.ref.sheet(),u|s)}function ol(e,t){var n,r;t.context.refStyle&&"R1C1"===t.context.refStyle?(n=t.visit(e.r1C1Row),r=t.visit(e.r1C1Column)):(n=t.visit(e.a1Row),r=t.visit(e.a1Column));var a=t.context,o=a.ref,i=a.relativeRef,u=i?n.rowFrom()-o.startRow:n.rowFrom(),s=i?r.colFrom()-o.startCol:r.colFrom();return new Zi(u,s,t.context.ref.sheet(),n.refStatus()|r.refStatus())}function il(e,t){var n,r=t.visit(e.lhs),a=t.visit(e.rhs),o=r,i=a,u=r.rowFrom(),s=a.rowFrom();(u>s||u===s&&r.colFrom()>a.colFrom())&&(o=(n=[a,r])[0],i=n[1]);var l=o,c=i,h=5&l.refStatus(),f=10&c.refStatus(),d=t.context,v=d.ref,g=d.relativeRef,m=g?l.rowFrom()-v.startRow:l.rowFrom(),p=g?l.colFrom()-v.startCol:l.colFrom();return new Oi(m,p,c.rowFrom()-l.rowFrom()+1,c.colFrom()-l.colFrom()+1,t.context.ref.sheet(),h|f)}function ul(e,t){var n;if(e.QuotedSingleSheetPrefix){var r=e.QuotedSingleSheetPrefix[0].image;n=r.substring(1,r.length-2).replace(/\'\'/g,"'")}else if(e.SingleSheetPrefix){var a=e.SingleSheetPrefix[0].image;n=a.substring(0,a.length-1)}var o=t.context.spread.getSheetFromName(n),i=t.visit(e.localReference);return i instanceof Ei?(i.setSheet(o),null==o&&(i.sheetName=n),i):ut.REF_ERR_VAR}var sl,ll="[1-9][0-9]{0,6}";!function(e){e.A1_RELATIVE_COLUMN="A1RelativeColumn",e.A1_RELATIVE_ROW="A1RelativeRow",e.R1C1_RELATIVE_COLUMN="R1C1RelativeColumn",e.R1C1_RELATIVE_ROW="R1C1RelativeRow",e.R1C1_ABSOLUTE_COLUMN="R1C1AbsoluteColumn",e.R1C1_ABSOLUTE_ROW="R1C1AbsoluteRow",e.WHITE_SPACE_IN_REF="WhiteSpaceInRef",e.DOLLAR="Dollar",e.COLON="Colon",e.REF_CONSTANT="RefConstant",e.SINGLE_SHEET_PREFIX="SingleSheetPrefix",e.QUOTED_SINGLE_SHEET_PREFIX="QuotedSingleSheetPrefix"}(sl||(sl={}));var cl=(0,wt.createToken)({name:"A1RelativeColumn",pattern:/[a-zA-Z]{1,3}/,longer_alt:$s.SingleSheetPrefix}),hl=(0,wt.createToken)({name:"A1RelativeRow",pattern:new RegExp(ll),longer_alt:$s.SingleSheetPrefix}),fl=(0,wt.createToken)({name:"R1C1RelativeColumn",pattern:/C\[-?(?:0|[1-9][0-9]*)\]/}),dl=(0,wt.createToken)({name:"R1C1RelativeRow",pattern:/R\[-?(?:0|[1-9][0-9]*)\]/}),vl=(0,wt.createToken)({name:"R1C1AbsoluteColumn",pattern:new RegExp("C".concat("[1-9][0-9]{0,4}")),longer_alt:$s.SingleSheetPrefix}),gl=(0,wt.createToken)({name:"R1C1AbsoluteRow",pattern:new RegExp("R".concat(ll)),longer_alt:$s.SingleSheetPrefix}),ml=(0,wt.createToken)({name:"WhiteSpaceInRef",pattern:/[ \t\r\n]+/,group:wt.Lexer.SKIPPED}),pl=(0,wt.createToken)({name:"Dollar",pattern:/\$/}),yl=[ml,cl,hl,pl,$s.Colon,$s.RefConstant,$s.QuotedSingleSheetPrefix,$s.SingleSheetPrefix],Cl=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,null,[{key:"getRefLexerA1",value:function(){return null==this.refLexerA1&&(this.refLexerA1=new t(yl,{skipValidations:!0})),this.refLexerA1}},{key:"getRefLexerR1C1",value:function(){return null==this.refLexerR1C1&&(this.refLexerR1C1=new t(_l,{skipValidations:!0})),this.refLexerR1C1}},{key:"dispose",value:function(){this.refLexerA1=null,this.refLexerR1C1=null}}]),t}(wt.Lexer),_l=[ml,fl,dl,vl,gl,$s.Colon,$s.RefConstant,$s.QuotedSingleSheetPrefix,$s.SingleSheetPrefix];function Rl(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"A1",n=Cl.getRefLexerA1(),r=Cl.getRefLexerR1C1();switch(t){case"A1":return{lexingResult:n.tokenize(e),lexer:n};case"R1C1":return{lexingResult:r.tokenize(e),lexer:r};default:throw Error("RefStyle is not found!")}}var wl=[ml,cl,hl,fl,dl,vl,gl,pl,$s.Colon,$s.RefConstant,$s.QuotedSingleSheetPrefix,$s.SingleSheetPrefix];var kl,Sl=function(){var e={};return wl.forEach((function(t){e[t.name]=t})),e}(),El=function(e){function t(e){var n,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"A1";(0,y.Z)(this,t),(n=(0,d.Z)(this,(0,v.Z)(t).call(this,e,{skipValidations:!0,maxLookahead:5}))).refStyle=r;var a=(0,c.Z)(n);return a.RULE("reference",(function(){a.OR([{ALT:function(){return a.SUBRULE(a.localReference)}},{ALT:function(){return a.SUBRULE(a.externalReference)}}])})),a.RULE("localReference",(function(){switch(n.refStyle){case"A1":a.OR([{ALT:function(){return a.SUBRULE(a.a1ColumnReference)}},{ALT:function(){return a.SUBRULE(a.a1RowReference)}},{ALT:function(){return a.SUBRULE(a.a1AreaReference)}},{ALT:function(){return a.SUBRULE(a.a1CellReference)}},{ALT:function(){return a.CONSUME(Sl.RefConstant)}}]);break;case"R1C1":a.OR([{ALT:function(){return a.SUBRULE(a.r1C1ColumnReference)}},{ALT:function(){return a.SUBRULE(a.r1C1RowReference)}},{ALT:function(){return a.SUBRULE(a.r1C1AreaReference)}},{ALT:function(){return a.SUBRULE(a.r1C1CellReference)}},{ALT:function(){return a.CONSUME(Sl.RefConstant)}}]);break;default:throw Error("RefStyle is not found!")}})),a.RULE("externalReference",(function(){switch(n.refStyle){case"A1":case"R1C1":a.OR([{ALT:function(){return a.CONSUME(Sl.SingleSheetPrefix)}},{ALT:function(){return a.CONSUME(Sl.QuotedSingleSheetPrefix)}}]);break;default:throw Error("RefStyle is not found!")}a.SUBRULE(a.localReference)})),a.RULE("a1ColumnReference",(function(){a.SUBRULE(a.a1Column,{LABEL:"lhs"}),a.CONSUME(Sl.Colon),a.SUBRULE2(a.a1Column,{LABEL:"rhs"})})),a.RULE("a1RowReference",(function(){a.SUBRULE(a.a1Row,{LABEL:"lhs"}),a.CONSUME(Sl.Colon),a.SUBRULE2(a.a1Row,{LABEL:"rhs"})})),a.RULE("a1AreaReference",(function(){a.SUBRULE(a.a1CellReference,{LABEL:"lhs"}),a.CONSUME(Sl.Colon),a.SUBRULE2(a.a1CellReference,{LABEL:"rhs"})})),a.RULE("a1CellReference",(function(){a.SUBRULE(a.a1Column),a.SUBRULE(a.a1Row)})),a.RULE("a1Column",(function(){a.OR([{ALT:function(){return a.CONSUME(Sl.A1RelativeColumn)}},{ALT:function(){return a.SUBRULE(a.a1AbsoluteColumn)}}])})),a.RULE("a1AbsoluteColumn",(function(){a.CONSUME(Sl.Dollar),a.CONSUME(Sl.A1RelativeColumn)})),a.RULE("a1Row",(function(){a.OR([{ALT:function(){return a.CONSUME(Sl.A1RelativeRow)}},{ALT:function(){return a.SUBRULE(a.a1AbsoluteRow)}}])})),a.RULE("a1AbsoluteRow",(function(){a.CONSUME(Sl.Dollar),a.CONSUME(Sl.A1RelativeRow)})),a.RULE("r1C1ColumnReference",(function(){a.SUBRULE(a.r1C1Column,{LABEL:"lhs"}),a.CONSUME(Sl.Colon),a.SUBRULE2(a.r1C1Column,{LABEL:"rhs"})})),a.RULE("r1C1RowReference",(function(){a.SUBRULE(a.r1C1Row,{LABEL:"lhs"}),a.CONSUME(Sl.Colon),a.SUBRULE2(a.r1C1Row,{LABEL:"rhs"})})),a.RULE("r1C1AreaReference",(function(){a.SUBRULE(a.r1C1CellReference,{LABEL:"lhs"}),a.CONSUME(Sl.Colon),a.SUBRULE2(a.r1C1CellReference,{LABEL:"rhs"})})),a.RULE("r1C1CellReference",(function(){a.SUBRULE(a.r1C1Row),a.SUBRULE(a.r1C1Column)})),a.RULE("r1C1Column",(function(){a.OR([{ALT:function(){return a.CONSUME(Sl.R1C1RelativeColumn)}},{ALT:function(){return a.CONSUME(Sl.R1C1AbsoluteColumn)}}])})),a.RULE("r1C1Row",(function(){a.OR([{ALT:function(){return a.CONSUME(Sl.R1C1RelativeRow)}},{ALT:function(){return a.CONSUME(Sl.R1C1AbsoluteRow)}}])})),n.performSelfAnalysis(),n}return(0,g.Z)(t,e),(0,C.Z)(t,null,[{key:"getRefParserA1",value:function(){return null==this.refParserA1&&(this.refParserA1=new t(yl,"A1")),this.refParserA1}},{key:"getRefParserR1C1",value:function(){return null==this.refParserR1C1&&(this.refParserR1C1=new t(_l,"R1C1")),this.refParserR1C1}},{key:"dispose",value:function(){this.refParserA1=null,this.refParserR1C1=null}}]),t}(wt.CstParser);!function(e){e.reference="reference",e.localReference="localReference",e.externalReference="externalReference",e.a1ColumnReference="a1ColumnReference",e.a1RowReference="a1RowReference",e.a1AreaReference="a1AreaReference",e.a1CellReference="a1CellReference",e.a1Column="a1Column",e.a1AbsoluteColumn="a1AbsoluteColumn",e.a1Row="a1Row",e.a1AbsoluteRow="a1AbsoluteRow",e.r1C1ColumnReference="r1C1ColumnReference",e.r1C1RowReference="r1C1RowReference",e.r1C1AreaReference="r1C1AreaReference",e.r1C1CellReference="r1C1CellReference",e.r1C1Column="r1C1Column",e.r1C1Row="r1C1Row"}(kl||(kl={}));var Tl=null,Al=null;function Il(){if(null!=Tl)return Tl;if(null==Al){var e=El.getRefParserA1().getBaseCstVisitorConstructor();Al=function(e){return function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"visitTree",value:function(e,t){this.context=t;var n=this.visit(e);return this.context=null,n}},{key:"reference",value:function(e){if(void 0!==e.localReference)return this.visit(e.localReference);if(void 0!==e.externalReference)return this.visit(e.externalReference);throw new Error("Invalid token in the reference expression!")}},{key:"localReference",value:function(e){if(void 0!==e.a1ColumnReference)return this.visit(e.a1ColumnReference);if(void 0!==e.a1RowReference)return this.visit(e.a1RowReference);if(void 0!==e.a1AreaReference)return this.visit(e.a1AreaReference);if(void 0!==e.a1CellReference)return this.visit(e.a1CellReference);if(void 0!==e.RefConstant)return nl();throw new Error("Invalid token in the localReference expression!")}},{key:"externalReference",value:function(e){return ul(e,this)}},{key:"a1ColumnReference",value:function(e){return al(e,this)}},{key:"a1RowReference",value:function(e){return rl(e,this)}},{key:"a1CellReference",value:function(e){return ol(e,this)}},{key:"a1AreaReference",value:function(e){return il(e,this)}},{key:"a1Column",value:function(e){if(void 0!==e.A1RelativeColumn)return this.visitA1RelativeColumn(e);if(void 0!==e.a1AbsoluteColumn)return this.visit(e.a1AbsoluteColumn);throw new Error("Invalid token in the a1Column expression!")}},{key:"a1Row",value:function(e){if(void 0!==e.A1RelativeRow)return this.visitA1RelativeRow(e);if(void 0!==e.a1AbsoluteRow)return this.visit(e.a1AbsoluteRow);throw new Error("Invalid token in the a1Row expression!")}},{key:"a1AbsoluteColumn",value:function(e){var t=e.A1RelativeColumn[0].image,n=(0,we.pen)(t);if(n>=Ka)throw new Error('Column number cannot be greater than "XFD"!');return new Vi(n,1,this.context.ref.sheet(),3)}},{key:"a1AbsoluteRow",value:function(e){var t=parseInt(e.A1RelativeRow[0].image,10)-1;if(t>=Ya)throw new Error("Row number cannot be greater than 1048576!");return new xi(t,1,this.context.ref.sheet(),12)}},{key:"visitA1RelativeColumn",value:function(e){var t=e.A1RelativeColumn[0].image,n=(0,we.pen)(t);if(n>=Ka)throw new Error('Column number cannot be greater than "XFD"!');return new Vi(n,1,this.context.ref.sheet())}},{key:"visitA1RelativeRow",value:function(e){var t=parseInt(e.A1RelativeRow[0].image,10)-1;if(t>=Ya)throw new Error("Row number cannot be greater than 1048576!");return new xi(t,1,this.context.ref.sheet())}}]),t}(e)}(e)}return Tl=new Al}var bl=1048575;var Fl=null,Ml=null;function Vl(){if(null!=Fl)return Fl;if(null==Ml){var e=El.getRefParserA1().getBaseCstVisitorConstructor();Ml=function(e){return function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"visitTree",value:function(e,t){this.context=t;var n=this.visit(e);return this.context=null,n}},{key:"reference",value:function(e){if(void 0!==e.localReference)return this.visit(e.localReference);if(void 0!==e.externalReference)return this.visit(e.externalReference);throw new Error("Invalid token in the reference expression!")}},{key:"localReference",value:function(e){if(void 0!==e.r1C1RowReference)return this.visit(e.r1C1RowReference);if(void 0!==e.r1C1ColumnReference)return this.visit(e.r1C1ColumnReference);if(void 0!==e.r1C1AreaReference)return this.visit(e.r1C1AreaReference);if(void 0!==e.r1C1CellReference)return this.visit(e.r1C1CellReference);if(void 0!==e.RefConstant)return nl();throw new Error("Invalid token in the localReference expression!")}},{key:"externalReference",value:function(e){return ul(e,this)}},{key:"r1C1ColumnReference",value:function(e){return al(e,this)}},{key:"r1C1RowReference",value:function(e){return rl(e,this)}},{key:"r1C1CellReference",value:function(e){return ol(e,this)}},{key:"r1C1AreaReference",value:function(e){return il(e,this)}},{key:"r1C1Column",value:function(e){if(void 0!==e.R1C1RelativeColumn)return this.visitR1C1RelativeColumn(e);if(void 0!==e.R1C1AbsoluteColumn)return this.visitR1C1AbsoluteColumn(e);throw new Error("Invalid token in the r1C1Column expression!")}},{key:"r1C1Row",value:function(e){if(void 0!==e.R1C1RelativeRow)return this.visitR1C1RelativeRow(e);if(void 0!==e.R1C1AbsoluteRow)return this.visitR1C1AbsoluteRow(e);throw new Error("Invalid token in the r1C1Row expression!")}},{key:"visitR1C1RelativeColumn",value:function(e){var t=e.R1C1RelativeColumn[0].image,n=parseInt(t.substring(2,t.length-1),10),r=this.context.ref.colFrom()+n;if(0>r||r>16383)throw new Error("Relative R1C1 column number is out of range!");return new Vi(r,1,this.context.ref.sheet())}},{key:"visitR1C1AbsoluteColumn",value:function(e){var t=e.R1C1AbsoluteColumn[0].image,n=parseInt(t.substring(1),10)-1;if(n>16383)throw new Error("Column number cannot be greater than 16384!");return new Vi(n,1,this.context.ref.sheet(),3)}},{key:"visitR1C1RelativeRow",value:function(e){var t=e.R1C1RelativeRow[0].image,n=parseInt(t.substring(2,t.length-1),10),r=this.context.ref.rowFrom()+n;if(0>r||r>bl)throw new Error("Relative R1C1 row number is out of range!");return new xi(r,1,this.context.ref.sheet())}},{key:"visitR1C1AbsoluteRow",value:function(e){var t=e.R1C1AbsoluteRow[0].image,n=parseInt(t.substring(1),10)-1;if(n>bl)throw new Error("Row number cannot be greater than 1048576!");return new xi(n,1,this.context.ref.sheet(),12)}}]),t}(e)}(e)}return Fl=new Ml}var Nl=null,Ol=null;function xl(){if(null!=Nl)return Nl;if(null==Ol){var e=El.getRefParserA1().getBaseCstVisitorConstructor();Ol=function(e){return function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"visitRefConstant",value:function(e){return null}},{key:"reference",value:function(e){if(e.localReference)return this.visit(e.localReference);if(e.externalReference)return this.visit(e.externalReference);throw new Error("Invalid token in the reference expression!")}},{key:"localReference",value:function(e){if(e.a1ColumnReference)return this.visit(e.a1ColumnReference);if(e.a1RowReference)return this.visit(e.a1RowReference);if(e.a1AreaReference)return this.visit(e.a1AreaReference);if(e.a1CellReference)return this.visit(e.a1CellReference);if(e.RefConstant)return this.visitRefConstant(e.RefConstant);throw new Error("Invalid token in the localReference expression!")}},{key:"externalReference",value:function(e){var t,n=this.visit(e.localReference[0]);if(null==n)return null;if(e.QuotedSingleSheetPrefix){var r=e.QuotedSingleSheetPrefix[0].image;t=r.substring(1,r.length-2).replace(/\'\'/g,"'")}else if(e.SingleSheetPrefix){var a=e.SingleSheetPrefix[0].image;t=a.substring(0,a.length-1)}return n.sheetName=t,n}},{key:"a1ColumnReference",value:function(e){var t,n=this.visit(e.lhs),r=this.visit(e.rhs),a=n,o=r;return n.col>r.col&&(a=(t=[r,n])[0],o=t[1]),{type:we.xj7.COL,col:a.col,colCount:o.col-a.col+1}}},{key:"a1RowReference",value:function(e){var t,n=this.visit(e.lhs),r=this.visit(e.rhs),a=n,o=r;return n.row>r.row&&(a=(t=[r,n])[0],o=t[1]),{type:we.xj7.ROW,row:a.row,rowCount:o.row-a.row+1}}},{key:"a1AreaReference",value:function(e){var t=this.visit(e.lhs),n=this.visit(e.rhs),r=Math.min(t.row,n.row),a=Math.max(t.row,n.row),o=Math.min(t.col,n.col),i=Math.max(t.col,n.col);return{type:we.xj7.NORMAL,row:r,col:o,rowCount:a-r+1,colCount:i-o+1}}},{key:"a1CellReference",value:function(e){var t=this.visit(e.a1Row).row,n=this.visit(e.a1Column).col;return{type:we.xj7.CELL,row:t,col:n,rowCount:1,colCount:1}}},{key:"a1Column",value:function(e){if(e.A1RelativeColumn)return this.visitA1RelativeColumn(e);if(e.a1AbsoluteColumn)return this.visit(e.a1AbsoluteColumn);throw new Error("Invalid token in the a1Column expression!")}},{key:"a1Row",value:function(e){if(e.A1RelativeRow)return this.visitA1RelativeRow(e);if(e.a1AbsoluteRow)return this.visit(e.a1AbsoluteRow);throw new Error("Invalid token in the a1Row expression!")}},{key:"visitA1RelativeColumn",value:function(e){var t=e.A1RelativeColumn[0].image,n=(0,we.pen)(t);return{type:we.xj7.COL,col:n,colCount:1}}},{key:"a1AbsoluteColumn",value:function(e){return this.visitA1RelativeColumn(e)}},{key:"visitA1RelativeRow",value:function(e){var t=parseInt(e.A1RelativeRow[0].image,10)-1;return{type:we.xj7.ROW,row:t,rowCount:1}}},{key:"a1AbsoluteRow",value:function(e){return this.visitA1RelativeRow(e)}}]),t}(e)}(e)}return Nl=new Ol}var Zl=255;function Dl(){for(var e=[95,48,46,63,36,92,65,97,162,170,181,186,192,216,248,546,592,688,699,720,736,750,890,902,904,908,910,931,976,986,1024,1164,1223,1227,1232,1272,1329,1369,1377,1488,1520,1569,1600,1649,1749,1765,1786,1808,1810,1920,2309,2365,2384,2392,2437,2447,2451,2474,2482,2486,2524,2527,2544,2565,2575,2579,2602,2610,2613,2616,2649,2654,2674,2693,2701,2703,2707,2730,2738,2741,2749,2768,2784,2821,2831,2835,2858,2866,2870,2877,2908,2911,2949,2958,2962,2969,2972,2974,2979,2984,2990,2999,3077,3086,3090,3114,3125,3168,3205,3214,3218,3242,3253,3294,3296,3333,3342,3346,3370,3424,3461,3482,3507,3517,3520,3585,3634,3647,3713,3716,3719,3722,3725,3732,3737,3745,3749,3751,3754,3757,3762,3773,3776,3782,3804,3840,3904,3913,3976,4096,4131,4137,4176,4256,4304,4352,4447,4520,4608,4616,4680,4682,4688,4696,4698,4704,4744,4746,4752,4784,4786,4792,4800,4802,4808,4816,4824,4848,4880,4882,4888,4896,4936,5024,5121,5743,5761,5792,6016,6107,6176,6272,7680,7840,7936,7960,7968,8008,8016,8025,8027,8029,8031,8064,8118,8126,8130,8134,8144,8150,8160,8178,8182,8255,8319,8352,8450,8455,8458,8469,8473,8484,8486,8488,8490,8495,8499,8544,12293,12321,12337,12344,12353,12445,12449,12549,12593,12704,13312,19968,40960,44032,63744,64256,64275,64285,64287,64298,64312,64318,64320,64323,64326,64467,64848,64914,65008,65075,65101,65129,65136,65140,65142,65284,65313,65343,65345,65381,65474,65482,65490,65498,65504,65509],t=[95,57,46,63,36,92,90,122,165,170,181,186,214,246,543,563,685,696,705,721,740,750,890,902,906,908,929,974,983,1011,1153,1220,1224,1228,1269,1273,1366,1369,1415,1514,1522,1594,1610,1747,1749,1766,1788,1808,1836,1957,2361,2365,2384,2401,2444,2448,2472,2480,2482,2489,2525,2529,2547,2570,2576,2600,2608,2611,2614,2617,2652,2654,2676,2699,2701,2705,2728,2736,2739,2745,2749,2768,2784,2828,2832,2856,2864,2867,2873,2877,2909,2913,2954,2960,2965,2970,2972,2975,2980,2986,2997,3001,3084,3088,3112,3123,3129,3169,3212,3216,3240,3251,3257,3294,3297,3340,3344,3368,3385,3425,3478,3505,3515,3517,3526,3632,3635,3654,3714,3716,3720,3722,3725,3735,3743,3747,3749,3751,3755,3760,3763,3773,3780,3782,3805,3840,3911,3946,3979,4129,4135,4138,4181,4293,4342,4441,4514,4601,4614,4678,4680,4685,4694,4696,4701,4742,4744,4749,4782,4784,4789,4798,4800,4805,4814,4822,4846,4878,4880,4885,4894,4934,4954,5108,5740,5750,5786,5866,6067,6107,6263,6312,7835,7929,7957,7965,8005,8013,8023,8025,8027,8029,8061,8116,8124,8126,8132,8140,8147,8155,8172,8180,8188,8256,8319,8367,8450,8455,8467,8469,8477,8484,8486,8488,8493,8497,8505,8579,12295,12329,12341,12346,12436,12446,12542,12588,12686,12727,19893,40869,42124,55203,64045,64262,64279,64285,64296,64310,64316,64318,64321,64324,64433,64829,64911,64967,65019,65076,65103,65129,65138,65140,65276,65284,65338,65343,65370,65470,65479,65487,65495,65500,65505,65510],n=new Array(65534).fill(!1),r=0;r<e.length;r++)for(var a=t[r],o=e[r];o<=a;o++)n[o]=!0;return n}var Pl=null;function Ll(e,t){var n=e.trim();if(function(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];if(e.length>Zl||0===e.length)return!1;if(t)return!0;var n=e.toUpperCase();if("TRUE"===n||"FALSE"===n)return!1;var r=/^[^~/@` !-,:->\^\-\[\]\\]*$/;if(/^[0-9.?]/.test(e)||!r.test(e))return!1;null==Pl&&(Pl=Dl());for(var a=0,o=0;o<e.length;o++)Pl[e.charCodeAt(o)]&&(a+=1);return a===e.length}(n)){var r=ut.NAME_ERR_VAR.clone();return r.setSpecialInfo({errorInfo:n}),r}return null}function Bl(e,t,n){var r=e.trim();if(function(e){return!(e.length>Zl||0===e.length)}(r)){if(null!=n&&n.has(r)){var a=new Oi(0,0,1,1,t.spread.getActiveSheet());return a.setNamespace(r),a}var o=ut.NAME_ERR_VAR.clone();return o.setSpecialInfo({errorInfo:r}),o}return null}var Ul=new RegExp("^(".concat($s.LocalReferenceA1.PATTERN.source,")$")),Hl=new RegExp("^(".concat($s.ExternalReferenceA1.PATTERN.source,")$")),Wl=new RegExp("^(".concat($s.LocalReferenceR1C1.PATTERN.source,")$")),jl=new RegExp("^(".concat($s.ExternalReferenceR1C1.PATTERN.source,")$"));function zl(e){var t=e.trim();return Ul.test(t)||Hl.test(t)||Wl.test(t)||jl.test(t)}function Gl(e){var t=$s.LocalReferenceA1,n=$s.ExternalReferenceA1,r=$s.LocalReferenceR1C1,a=$s.ExternalReferenceR1C1,o=[];return(o=Array.from(e.matchAll(new RegExp(a.PATTERN.source,"g")))).length||((o=Array.from(e.matchAll(new RegExp(n.PATTERN.source,"g")))).length||((o=Array.from(e.matchAll(new RegExp(r.PATTERN.source,"g")))).length||(o=Array.from(e.matchAll(new RegExp(t.PATTERN.source,"g")))).length)),o}function Jl(e,t){t.refStyle||(t.refStyle="A1");var n,r=Rl(e,t.refStyle).lexingResult;switch(t.refStyle){case"A1":n=El.getRefParserA1();break;case"R1C1":n=El.getRefParserR1C1();break;default:throw Error("RefStyle is not found!")}if(r.errors.length>0)return console.log("lexing error: ",r.errors[0].message),null;n.input=r.tokens;var a=n.reference();return n.errors.length>0?(console.log("parsing error: ",n.errors[0].message),null):(t&&"R1C1"===t.refStyle?Vl():Il()).visitTree(a,t)}function ql(e,t){return zl(e)?Jl(e,t):Ll(e)}function $l(e){if(!zl(e))return null;var t=Rl(e,"A1").lexingResult,n=El.getRefParserA1();n.input=t.tokens;var r=n.reference();return t.errors.length>0||n.errors.length>0?null:xl().visit(r)}function Yl(e,t){var n=null;switch(e.type){case we.xj7.ROW:var r=e.row+1;n="".concat(r,":").concat(r+e.rowCount-1);break;case we.xj7.COL:n="".concat((0,we.hdC)(e.col),":").concat((0,we.hdC)(e.col+e.colCount-1));break;case we.xj7.CELL:var a=e.row+1;n="".concat((0,we.hdC)(e.col)).concat(a);break;case we.xj7.NORMAL:var o=e.row+1,i=o+e.rowCount-1;n="".concat((0,we.hdC)(e.col)).concat(o,":").concat((0,we.hdC)(e.col+e.colCount-1)).concat(i);break;default:return null}var u=(null==t?void 0:t.escapeSheetNameFunc)||si;return(!t||t.isShowSheetName)&&e.hasOwnProperty("sheetName")&&e.sheetName.length>0&&(n="".concat(u(e.sheetName),"!").concat(n)),n}var Kl=new Set,Xl=new Set(["LAMBDA","LET","InvokeFunctionOp"]),Ql=new Set(["IF","IFS"]);function ec(e){for(var t=e.length-1;t>=0;t--){var n=e[t];if(!n.isOp())return!1;var r=n.op();if(Kl.has(r.name))return!0;if(!(r instanceof ut.ParenOp))return!1}return!1}function tc(e){for(var t=e.length-1;t>=0;t--){var n=e[t];if("OG1"!==n){if(!n.startsWith("F"))return!1;var r=n.split(":")[1];if(""===r||void 0===r)return!1;if(Kl.has(r))return!0;break}}return!1}function nc(e){var t=e.getSpecialInfo();return null!=(null==t?void 0:t.link)?t.link:e.getValue()}function rc(e){var t=e.getValue();if("string"==typeof t){var n=$l(t);if(n){var r=Yl(n,{isShowSheetName:!0});if(r)return r}return t}}function ac(e,t){for(var n=e.getRef(),r=e.getFormulaService(),a=[],o=[],i=t.length-1;i>1;i--){var u=t[i];if(u.isOp()&&"IMPORTRANGE"===u.op().name){if(2!==u.getArgCount())return;a.push(i)}}if(a.length){for(var s=0;s<a.length;s++){var l=a[s];try{var c={calcId:0,ref:n,info:{},formula:e,service:r,isArray:!0},h=Tc(c,t,l);if(2!==h.length)return;var f=l-h[1],d=rc(Ic(c,_c(c,e,e.getState(),[],f,f+h[1]-1))[1]);if("string"!=typeof d)return;var v=f-h[0],g=nc(Ic(c,_c(c,e,e.getState(),[],v,v+h[0]-1))[1]);if("string"!=typeof g)return;o.push({url:g,range:d,isSyncStyle:!1})}catch(e){return}}return o}}function oc(e){for(var t=Array.isArray(e)?e:[e],n=t[0],r=1;r<t.length;r++){var a,o,i,u;if(n.sheet()!==t[r].sheet())return we.d$b[we.O6N.RANGE_CAN_ONLY_REFERENCE_ONE_SHEET]({firstSheetName:null!==(a=null===(o=n.sheet())||void 0===o?void 0:o.name())&&void 0!==a?a:"",secondSheetName:null!==(i=null===(u=t[r].sheet())||void 0===u?void 0:u.name())&&void 0!==i?i:""});if(null==(n=n.union(t[r])))return ut.NULL_ERR_VAR}return new Su(n)}function ic(e,t,n,r){return t&&t.sheet()?sc(e,t,n,r):e}function uc(e,t,n,r){return sc(e,t,n+t.rowFrom(),r+t.colFrom())}function sc(e,t,n,r){var a,o,i=t.sheet().getCellFormatter(n,r);if(i&&!(0,Se.isDefaultFormatter)(i)){var u=e.clone();return u.setSpecialInfo({customData:{autoFormat:i.getFormatCode()}}),u}var s=null===(a=e.getSpecialInfo())||void 0===a||null===(o=a.customData)||void 0===o?void 0:o.autoFormat;if(s){var l=e.clone();return l.setSpecialInfo({customData:{autoFormat:s}}),l}return e}function lc(e,t){return function(){var n,r=[],a=_n(t);try{var o=function(){var t=n.value;if(t.isNumber())return r.push(t.iter(e)),"continue";var a=[];t.iterWithPos(e).forEach((function(t){var n=(0,p.Z)(t,3),r=n[0],o=n[1],i=n[2];r.isNumber()&&(e&&e.ref&&e.ref.sheet().hasCheckbox(o,i)||a.push(r))})),r.push(Rt.FIterator.fromArray(a))};for(a.s();!(n=a.n()).done;)o()}catch(e){a.e(e)}finally{a.f()}return r}}function cc(e){return Kl.add(e),function(e){return e}}function hc(e,t,n,r){if(bu(t))return ut.VALUE_ERR_VAR;var a=t.rowCount(),o=t.colCount();if("number"==typeof n&&n>=1&&(a=Math.min(a,n)),"number"==typeof r&&r>=1&&(o=Math.min(o,r)),Fu(t)){for(var i,u=t.getRef(),s=[],l=0;l<a;l++){s[l]||(s[l]=[]);for(var c=0;c<o;c++){var h=t.getVarByPos(l,c,e);s[l][c]=uc(h,u,l,c)}}if(!a||!o)return 1===t.size()?new Ru([[]]):ut.REF_ERR_VAR;e.info&&(e.info.customData=null===(i=s[0][0].getSpecialInfo())||void 0===i?void 0:i.customData),t=new Ru(s)}return!Au(t)||a===t.rowCount()&&o===t.colCount()?t:new Tu(t,0,0,a,o)}var fc=function(e){function t(e,n){var r;return(0,y.Z)(this,t),(r=(0,d.Z)(this,(0,v.Z)(t).call(this))).expression=e,r.params=n,r}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"clone",value:function(){return new t(this.expression,this.params)}},{key:"toNumberVar",value:function(){throw new Error("LambdaVar can not convert toNumberVar")}},{key:"toStringVar",value:function(){throw new Error("LambdaVar can not convert toStringVar")}},{key:"toBooleanVar",value:function(){throw new Error("LambdaVar can not convert toBooleanVar")}},{key:"getVar",value:function(e){var t;return void 0===e?we.d$b[we.O6N.FORMULA_SHOULD_BE_FOLLOWED_BY_A_CALL]({funcName:"LAMBDA"}):(this.expression.isOp()&&null!==(null===(t=e.info)||void 0===t?void 0:t.customData)&&(e.info.customData=null),this.expression.isCollection()?this.expression:this.expression.getVar(e))}},{key:"getValue",value:function(e){return this.getVar(e).getValue()}},{key:"serializeValue",value:function(){return null}},{key:"getParams",value:function(){return this.params}},{key:"customType",get:function(){return"LambdaVar"}}]),t}(ut.BaseCustomPrimitiveVar);function dc(e){return e.isCustomPrimitive()&&"LambdaVar"===e.customType}var vc=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"setArray",value:function(e){return this.arr=e}},{key:"getVarByPos",value:function(e,t){var n;return null!==(n=this.arr&&this.arr[e]&&this.arr[e][t])&&void 0!==n?n:ut.NULL_VAR}},{key:"customType",get:function(){return"FixedSizeMatrixVar"}}]),t}(_u),gc=new ut.FormulaCache(ut.CIRCULAR_DEPENDENCY_ERR_VAR),mc=[];function pc(e,t,n){if(!t.circleChecker.enterFormula(e,n))return gc;if(n.cache)return n.cache;if(t.level===t.maxStackSize){var r=wc(Promise.resolve(ut.NULL_VAR),e,t,n),a=new ut.AsyncVar(r);return new ut.FormulaCache(a)}var o=e.service.formulaChainPerformanceService;1===t.level&&o.isCollect&&Math.random()<o.sampleRate&&(e.formulaChainPerformance=new ut.FormulaChainPerformance(o),e.formulaChainPerformance.startCalc()),null!=e.formulaChainPerformance&&e.formulaChainPerformance.enterFormula(t);try{return yc(e,function(e,t,n){return _c(e,t,n,[],0,t.formula.expression.length-1)}(e,t,n))}catch(o){var i=Sc(o,e,t,n);return new ut.FormulaCache(i)}}function yc(e,t){if(t.isAsync())return new ut.FormulaCache(t);var n=Ic(e,t),r=(0,p.Z)(n,2),a=r[0],o=r[1];return new ut.FormulaCache(a,o)}function Cc(e,t,n,r){return r.getRawVar().isAsync()?(t.getFormulaService().emit(ut.FormulaEvents.onAsyncFormulaCalculating,t),(0,ut.cacheFormulaResult)(e,n,r)):t.afterCalc(e,t,n,r)}function _c(e,t,n,r,a,o){for(var i=t.formula.expression,u=a;u<=o;u++){var s=i[u];if(s.isOp()){var l=s.getArgCount(),c=r.splice(r.length-l,l);if(s.setArgs(c),s.canLazyCalc()){r.push(s);continue}var h=s.getVar(e);if(s.setArgs(mc),h.isAsync()){var f=function(){var a=u;e.service.addCalculatingAsyncFormula(t);var i=h.resolve().then((function(i){e.service.removeCalculatingAsyncFormula(t),r.push(i);var u=_c(e,t,n,r,a+1,o);return Cc(e,t,n,yc(e,u)),u})).catch((function(r){return kc(r,e,t,n)})).finally((function(){return t.getFormulaService().emit(ut.FormulaEvents.onAsyncFormulaValueChanged,t)}));return{v:new ut.AsyncVar(i)}}();if("object"===(0,_.Z)(f))return f.v}r.push(h)}else Vu(s)?Rc(s,r):r.push(s)}return r[0]}function Rc(e,t){for(var n=e.rowCount(),r=e.colCount(),a=n*r,o=t.length-a,i=[],u=0;u<n;u++){var s=t.splice(o,r);i.push(s)}(e=new vc(n,r)).setArray(i),t.push(e)}function wc(e,t,n,r){return e.then((function(){return n.circleChecker.exitFormula(t,r),r.reset(),null!=t.formulaChainPerformance&&(t.formulaChainPerformance=void 0),function(e,t,n){var r=pc(e,t,n);return Cc(e,t,n,r),r.getVar()}(t,n,r)})).catch((function(e){return kc(e,t,n,r)})).finally((function(){return n.getFormulaService().emit(ut.FormulaEvents.onAsyncFormulaValueChanged,n)}))}function kc(e,t,n,r){var a=Sc(e,t,n,r);return Cc(t,n,r,new ut.FormulaCache(a)),a}function Sc(e,t,n,r){var a;if(e instanceof ut.AsyncVar){var o=wc(e.resolve(),t,n,r);a=new ut.AsyncVar(o)}else a=e instanceof ut.ErrorVar?e:Ec(e);return a}function Ec(e){var t,n;return e instanceof Error?(n=ut.tractorErrorVarCreators[ut.ErrorCode.DEFAULT_RUNTIME_ERROR]("Message: ".concat(e.message,"\nstack: ").concat(e.stack,".")),null===(t=we.Ps3.moirae)||void 0===t||t.ravenCatch(e,{tags:{key:"SHEET_FORMULA_CALC_ERROR"}})):n=ut.tractorErrorVarCreators[ut.ErrorCode.DEFAULT_RUNTIME_ERROR]("Unknown error occurred during calculation."),n}function Tc(e,t,n){var r=t[n];if(!r.isOp())return[];var a=r.getArgCount();if(0===a)return[];var o=new Array(a);n--;for(var i=0;i<a;i++){var u=Ac(e,t,n);o[a-i-1]=u,n-=u}return o}function Ac(e,t,n){return t[n].isOp()?Tc(e,t,n).reduce((function(e,t){return e+t}),0)+1:1}function Ic(e,t){if(dc(t)&&(t=t.getVar()),Mu(t)){var n,r=t.getSheetRef(null===(n=e.formula)||void 0===n?void 0:n.getRefMap());t=r instanceof Ei?new Su(ki(r,e.ref)):r}e.isArray&&Fu(t)&&(t=hc(e,t)),e.isArray&&function(e){return e instanceof Eu||e instanceof ku||e instanceof Tu}(t)&&(t=function(e,t){if(Iu(e))return e;for(var n=[],r=0;r<e.rowCount();r++){n[r]||(n[r]=[]);for(var a=0;a<e.colCount();a++){var o=e.getVarByPos(r,a,t);n[r][a]=o}}return new Ru(n)}(t,e));var a=t.getVar(e);return t.isNull()&&(t=t.toNumberVar()),a.isNull()&&(a=a.toNumberVar()),[t,a]}var bc,Fc=240;function Mc(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;if(!e.canDecompile())return{type:we.xj7.INVALID};var r,a=e.sheet();return(r=1===n?ci(Bo(t.ref,e),e.rgType):li(e,!0)).type=n<<8|e.refStatus()<<4|(r.type||0),null!=a?(a===t.ref.sheet()||(r.sheetId=a.id()),r):null==e.sheetName?(console.error("Cannot convert range without sheet id or name to JSON"),{type:we.xj7.INVALID}):(r.sheetName=e.sheetName,r)}function Vc(e,t,n,r){var a,o,i=null;if(t===n.id()||!e&&!t)return n;if(t?i=r?r(t):n.getParent().getSheetFromId(t):e&&(i=null===(a=n.parent)||void 0===a||null===(o=a.getSheetFromName)||void 0===o?void 0:o.call(a,e)),i)return i;if(e)return null;throw new Error("Cannot deserialize range without id")}!function(e){e[e.Absolute=0]="Absolute",e[e.Relative=1]="Relative"}(bc||(bc={}));var Nc=new Oi(-1,-1,-1,-1,null);function Oc(e,t,n,r){return null!=r&&r.isGridJSON?Zc(e,t,n,r):function(e,t,n,r){var a=e.sheetId||null,o=e.sheetName||null,i=null;try{i=Vc(o,a,t,n)}catch(e){return new Oi(0,0,0,0,null)}var u,s=xc(e,r),l=null==r?void 0:r.relativeRef,c=null==r?void 0:r.ref;switch(s.type){case we.xj7.INVALID:u=new Oi(0,0,0,0,null);break;case we.xj7.ALL:u=new Ni(i);break;case we.xj7.ROW:u=new xi(s.row,s.rowCount,i,s.refStatus);break;case we.xj7.COL:u=new Vi(s.col,s.colCount,i,s.refStatus);break;case we.xj7.CELL:u=new Zi(s.row,s.col,i,s.refStatus);break;case we.xj7.NORMAL:u=new Oi(s.row,s.col,s.rowCount,s.colCount,i,s.refStatus);break;default:throw new Error("unKnown ref bits ".concat(e.type))}if(l){if(!c)throw new Error("To deserialize to a relative Range, you should pass the reference position, namely ctx.ref, as a parameter.");u=s.type===we.xj7.INVALID?Nc:Si(u,c,(e.type&Fc)>>4)}return!u.hostId&&o?u.hostName=o:u.hostName=void 0,null!=r&&r.ref.isFrozen&&(u.isFrozen=!0),u}(e,t,n,r)}function xc(e,t){var n=e.type,r=15&n,a=(n&Fc)>>4,o=(3840&n)>>8,i=4&a,u=8&a,s=1&a,l=2&a;switch(r){case we.xj7.INVALID:return{type:we.xj7.INVALID};case we.xj7.ALL:return{type:we.xj7.ALL};case we.xj7.ROW:var c=e,h=c.row,f=c.rowCount;if(1===o&&null!=t&&null!=t.ref){var d,v=c.row,g=c.row+c.rowCount-1;i||(v+=t.ref.rowFrom()),u||(g+=t.ref.rowFrom()),v>g&&(i=(d=[u>>1,i<<1])[0],u=d[1]),h=Math.min(v,g),f=Math.abs(g-v)+1}return{type:we.xj7.ROW,row:h,rowCount:f,refStatus:i|u};case we.xj7.COL:var m=e,p=m.col,y=m.colCount;if(1===o&&null!=t&&null!=t.ref){var C,_=m.col,R=m.col+m.colCount-1;s||(_+=t.ref.colFrom()),l||(R+=t.ref.colFrom()),_>R&&(s=(C=[l>>1,s<<1])[0],l=C[1]),p=Math.min(R,_),y=Math.abs(R-_)+1}return{type:we.xj7.COL,col:p,colCount:y,refStatus:s|l};case we.xj7.CELL:case we.xj7.NORMAL:var w=e,k=w.row,S=w.col,E=w.rowCount,T=w.colCount;if(1===o&&null!=t&&null!=t.ref){var A,I,b=w.row,F=w.col,M=w.row+w.rowCount-1,V=w.col+w.colCount-1;i||(b+=t.ref.rowFrom()),u||(M+=t.ref.rowFrom()),s||(F+=t.ref.colFrom()),l||(V+=t.ref.colFrom()),b>M&&(i=(A=[u>>1,i<<1])[0],u=A[1]),F>V&&(s=(I=[l>>1,s<<1])[0],l=I[1]),k=Math.min(b,M),E=Math.abs(M-b)+1,S=Math.min(F,V),T=Math.abs(V-F)+1}return{type:r,row:k,col:S,rowCount:E,colCount:T,refStatus:i|u|s|l};default:throw new Error("unKnown ref bits ".concat(e.type))}}function Zc(e,t,n,r){var a,o,i=e.sheetId||null,u=e.sheetName||null;try{var s;a=null!==(s=Vc(u,i,t,n))&&void 0!==s?s:void 0}catch(e){return new Oi(0,0,0,0,null)}var l=Vo(e.status||0),c=No(e.status||0);return o=l&&c?new Ni(a):l?xi.fromGridJSON(e,a):c?Vi.fromGridJSON(e,a):Oi.fromGridJSON(e,a),u&&(o.sheetName=u),null!=r&&r.ref.isFrozen&&(o.isFrozen=!0),o}var Dc=function(e){function t(e){var n;return(0,y.Z)(this,t),(n=(0,d.Z)(this,(0,v.Z)(t).call(this))).value=e,n.customType="SheetImageVar",n}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"toBooleanValue",value:function(){return!0}},{key:"toStringValue",value:function(){return""}},{key:"toNumberValue",value:function(){return 0}},{key:"getValue",value:function(){return this.value}}]),t}(ut.Primitive),Pc=function(e){function t(e){var n;return(0,y.Z)(this,t),(n=(0,d.Z)(this,(0,v.Z)(t).call(this,e))).value=e,n.type=ut.VAR_TYPE.CUSTOM_PRIMITIVE,n}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"toNumberVar",value:function(){return t.numberVar}},{key:"toStringVar",value:function(){return t.stringVar}},{key:"toBooleanVar",value:function(){return t.booleanVar}},{key:"clone",value:function(){return new t(this.value)}},{key:"serialize",value:function(){var e=(0,f.Z)((0,v.Z)(t.prototype),"serialize",this).call(this);return e[ut.TractorFormulaCacheProps.value]=this.value.getValue(),e[ut.TractorFormulaCacheProps.customType]=this.customType,e}},{key:"customType",get:function(){return"SheetImageVar"}}],[{key:"deserialize",value:function(e){var n=e[ut.TractorFormulaCacheProps.value];return new t(new Dc(n))}}]),t}(ut.CustomPrimitiveVar);function Lc(e){return e.isCustomPrimitive()&&"SheetImageVar"===e.customType}Pc.numberVar=new ut.NumberVar(0),Pc.stringVar=new ut.StringVar(""),Pc.booleanVar=ut.BOOLEAN_VAR_MAP[ut.BooleanConstant.TRUE];var Bc,Uc,Hc=function(){function e(t,n){(0,y.Z)(this,e),this.dataView=t,this.options=n}return(0,C.Z)(e,[{key:"toJSON",value:function(){var e=this.dataView,t=this.options,n=t.isDirtyCache,r=t.isPassive,a=t.isError,o=t.errorType;return{dataViewJSON:null==e?void 0:e.toJSON(),isDirtyCache:n,isPassive:r,isError:a,errorType:o}}}],[{key:"fromJSON",value:function(t){var n,r=t.dataViewJSON,a=t.isDirtyCache,o=t.isPassive,i=t.isError,u=t.errorType;return r&&(n=new kt.b$).fromJSON(r),new e(n,{isDirtyCache:a,isPassive:o,isError:i,errorType:u})}}]),e}(),Wc=function(e){function t(e){var n;return(0,y.Z)(this,t),(n=(0,d.Z)(this,(0,v.Z)(t).call(this))).value=e,n.customType="PivotTableDataVar",n}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"toBooleanValue",value:function(){return!0}},{key:"toNumberValue",value:function(){return 0}},{key:"toStringValue",value:function(){return""}},{key:"getValue",value:function(){return this.value}}]),t}(ut.Primitive),jc=function(e){function t(e){var n;return(0,y.Z)(this,t),(n=(0,d.Z)(this,(0,v.Z)(t).call(this,e))).value=e,n}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"toNumberVar",value:function(){return new ut.NumberVar(0)}},{key:"toStringVar",value:function(){return new ut.StringVar("")}},{key:"toBooleanVar",value:function(){return new ut.BooleanVar(!0)}},{key:"serializeValue",value:function(){var e;return null===(e=this.value.getValue())||void 0===e?void 0:e.toJSON()}},{key:"customType",get:function(){return"PivotTableDataVar"}}],[{key:"deserialize",value:function(e){var t=e[ut.TractorFormulaCacheProps.value],n=e[ut.TractorFormulaCacheProps.customType],r=e[ut.TractorFormulaCacheProps.type];if(!n||!r)return null;var a=Hc.fromJSON(t);return zc(a)}}]),t}(ut.CustomPrimitiveVar),zc=function(e){return new jc(new Wc(e))};function Gc(e,t,n){var r=e[t];null!=r?"object"==(0,_.Z)(r)&&Object.assign(r,n):e[t]=n}function Jc(e){switch(e[st.TractorFormulaCacheProps.customType]){case"SheetImageVar":return Pc.deserialize(e);case"PivotTableDataVar":return jc.deserialize(e);default:return null}}function qc(e){var t,n,r=null!==(t=null===(n=e.getState().cache)||void 0===n?void 0:n.getInfo())&&void 0!==t?t:null;if(null==r)return null;var a={};if(null!=r.customDepends&&r.customDepends.length>0){for(var o=e.getRef(),i=r.customDepends,u=[],s=0;s<i.length;++s){var l=i[s];u.push(JSON.stringify(Mc(l,{ref:o})))}a[st.TractorCacheFormulaInfoProps.customDepends]=u}return(0,ut.isEmptyObject)(a)?null:a}function $c(e,t,n,r){var a,o=t.getInfo();if(o&&n){var i=n[st.TractorCacheFormulaInfoProps.customDepends];if(i){a=[];for(var u=0;u<i.length;u++)a.push(Oc(JSON.parse(i[u]),r,r.parent.getSheetFromId.bind(r.parent)))}}var s=a||null;e.getCustomDepends()!==s&&(e.registerCustomDepends(s),e.getFormulaService().calcEngine.dynamicRefManager.updateDynamicRefs(e,e.getRef(),s)),o&&(o.customDepends=a,t.setInfo(o))}!function(e){e.afterFormulaCalc="afterFormulaCalc",e.afterWaitAsyncCalc="afterWaitAsyncCalc",e.formulaCalcFinished="formulaCalcFinished"}(Bc||(Bc={})),function(e){e[e.import=0]="import",e[e.image=1]="image",e[e.ai=2]="ai",e[e.importRange=3]="importRange",e[e.pinyin=4]="pinyin"}(Uc||(Uc={}));var Yc,Kc=function(e){function t(e,n,r){var a,o,i=r.formula;return(0,y.Z)(this,t),(o=(0,d.Z)(this,(0,v.Z)(t).call(this,n,ut.NULL_VAR,e))).ignoreApplyCache=!1,o.formula=i,o.alwaysCalcInfo=null!==(a=o.formula.alwaysCalcInfo)&&void 0!==a?a:null,o}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"isArrayFormula",value:function(){return!1}},{key:"isImportRange",value:function(){return null!=this.formula.externalDataReferenceInfo}},{key:"hasImportRangeId",value:function(){return this.formula.importRangeId}},{key:"getExternalDataReferenceInfo",value:function(){return this.formula.externalDataReferenceInfo}},{key:"getImportRangeMeta",value:function(){return this.formula.importRangeMeta}},{key:"getTokens",value:function(){return this.formula.tokens}},{key:"markDirty",value:function(e){return this.ignoreApplyCache||(this.ignoreApplyCache=!0),(0,f.Z)((0,v.Z)(t.prototype),"markDirty",this).call(this,e)}},{key:"calc",value:function(e){var t,n=this.getState();if(this.service.isSuspended()&&(null==e?void 0:e.executeMode)!==ut.ExecuteMode.FORCE)return null!==(t=n.cache)&&void 0!==t?t:ut.BaseFormulaVar.SUSPENDED_FORMULA_CACHE;var r=this.formulaStack.enterFormula(this,e);r.isArray=Boolean(this.formula.hasArrayFunction);try{return Cc(r,this,n,pc(r,this,n))}catch(e){return new ut.FormulaCache(Ec(e))}finally{this.formulaStack.exitFormula(r)}}},{key:"afterCalc",value:function(e,n,r,a){var o=r.cache,i=n.getCustomDepends(),u=(0,f.Z)((0,v.Z)(t.prototype),"afterCalc",this).call(this,e,n,r,a);if(o===u)return u;var s=n.getCustomDepends();(s&&s.forEach((function(e){var t=e.sheet();t&&t.parent.detectWorksheet(t)})),s||i)&&(e.service.spread&&e.ref.hostId&&e.service.calcEngine.dynamicRefManager.updateDynamicRefs(n,e.ref,s));return u}},{key:"getRef",value:function(){return this.ref}},{key:"deserializeCache",value:function(e,n){var r,a=this.getRef().sheet();if(null==a)return null;if(e[st.TractorFormulaCacheProps.customType]){var o=Jc(e);r=o?new ut.FormulaCache(o):null}else r=(0,f.Z)((0,v.Z)(t.prototype),"deserializeCache",this).call(this,e,n);return null==r?null:($c(this,r,e[st.TractorFormulaCacheProps.info]||null,a),r)}},{key:"isEmptyState",value:function(){return!this.state.cache}},{key:"serializeCache",value:function(e){if(this.isDirty())return null;var n=(0,f.Z)((0,v.Z)(t.prototype),"serializeCache",this).call(this);if(null==n)return null;null!=(null==e?void 0:e.customSerializeCacheMethod)&&(n=e.customSerializeCacheMethod({formulaVar:this,serializedCache:n}));var r=qc(this);return null!=r&&Gc(n,st.TractorFormulaCacheProps.info,r),n}},{key:"getDependencies",value:function(){var e=[],t=this.getRefMap();if(t)for(var n in t)e.push(t[n]);var r=this.getCustomDepends();if(null!=r)for(var a=0;a<r.length;a++)e.push(r[a]);return e}},{key:"registerCustomDepends",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;this.customDepends=e}}]),t}(ut.FormulaVar),Xc=new ut.FormulaCache(ut.NULL_VAR);function Qc(e){return function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"calc",value:function(){return null!==this.state.cache?this.state.cache:th(this)||function(e){return eh(e,"AI")}(this)?ut.BaseFormulaVar.WAIT_ASYNC_FORMULA_CACHE:Xc}}]),t}(e)}function eh(e,t){return t=t.toLocaleUpperCase(),!("function"!=typeof e.isFormula||!e.isFormula()||!(e.formula.tokens||[]).find((function(e){return e.includes(t)})))}function th(e){if(!e.isFormula())return!1;if(e.isImportRange())return!0;var t=e.formula,n=t.expression,r=t.serialization,a="IMPORTRANGE";return n?function(e,t){for(var n=0;n<e.length;n++){var r=e[n];if(r.isOp()&&r.op().name===t)return!0}return!1}(n,a):!!r&&function(e,t){for(var n="F:".concat(t,":"),r=0;r<e.length;r++)if(0===e[r].indexOf(n))return!0;return!1}(r,a)}function nh(e){return!(!e.isFormula()||!(e.formula.tokens||[]).find((function(e){return e.includes("CIMAGE")||e.includes("CIMPORTXML")||e.includes("CIMPORTHTML")||e.includes("CIMPORTDATA")||e.includes("CIMPORTFEED")})))}function rh(e){return eh(e,"PRIVATE_PIVOT_TABLE")}function ah(e){return e instanceof Kc}function oh(e){var t;return(0,we.gw3)("".concat(null===(t=e.getRef().sheet())||void 0===t?void 0:t.id(),";").concat(e.getId()))}function ih(e,t){var n=t.split(";"),r=(0,p.Z)(n,2),a=r[0],o=r[1],i=parseInt(o,10);if(!isNaN(i))return e.getFormulaFromId(a,i)}!function(e){e[e.NONE=0]="NONE",e[e.HAS_HIDDEN_ROWS=1]="HAS_HIDDEN_ROWS",e[e.HAS_HIDDEN_COLS=2]="HAS_HIDDEN_COLS",e[e.HAS_HIDDEN_ROWS_AND_COLS=3]="HAS_HIDDEN_ROWS_AND_COLS"}(Yc||(Yc={}));function uh(e,t){var n=e.sheet(),r=[Oi.toNormalRange(e)];if(!n)return r;var a,o=e.rowFrom(),i=e.rowTo(),u=_n(t);try{for(u.s();!(a=u.n()).done;){var s=a.value;if(s>=o){if(s>i)break;var l=r.pop();if(l){var c=l.sub(new xi(s,1,n));Array.prototype.push.apply(r,c)}}}}catch(e){u.e(e)}finally{u.f()}return r}function sh(e){var t=e.sheet(),n=[e];return t&&t.filterModel.hasFilter()?uh(e,t.filterModel.getAllFilteredOutRowsArray()):n}function lh(e,t,n){if(0===e.length)return 0;var r,a=0,o=_n(e);try{for(o.s();!(r=o.n()).done;){var i=r.value,u=i.rowFrom(),s=i.rowTo(),l=i.colFrom(),c=i.colTo();if(!(1&a))for(var h in t)if(t[h]){var f=Number(h);if(f>=u){if(f>s)break;if(3===(a|=1))return a;break}}if(!(2&a))for(var d in n)if(n[d]){var v=Number(d);if(v>=l){if(v>c)break;if(3===(a|=2))return a;break}}}}catch(e){o.e(e)}finally{o.f()}return a}function ch(e){var t=e.sheet();if(!t)return{tl:null,tr:null,bl:null,br:null};var n=t.frozenRowCount(),r=t.frozenColumnCount(),a=e.rowFrom(),o=e.rowTo(),i=e.colFrom(),u=e.colTo(),s=null,l=null,c=null,h=null;a>=n?l=e.rowInterval():o<n?s=e.rowInterval():(s=[a,n-a],l=[n,o-n+1]),i>=r?h=e.colInterval():u<r?c=e.colInterval():(c=[i,r-i],h=[r,u-r+1]);var f=null,d=null,v=null,g=null;return s&&(c&&(f=new Oi(s[0],c[0],s[1],c[1],t)),h&&(d=new Oi(s[0],h[0],s[1],h[1],t))),l&&(c&&(v=new Oi(l[0],c[0],l[1],c[1],t)),h&&(g=new Oi(l[0],h[0],l[1],h[1],t))),{tl:f,tr:d,bl:v,br:g}}function hh(e,t){var n,r=[e],a=_n(t);try{for(a.s();!(n=a.n()).done;){var o,i=n.value,u=[],s=_n(r);try{for(s.s();!(o=s.n()).done;){var l=o.value;l.isIntersect(i)?Array.prototype.push.apply(u,l.sub(i)):u.push(l)}}catch(e){s.e(e)}finally{s.f()}r=u}}catch(e){a.e(e)}finally{a.f()}return r}function fh(e,t){if(0===e.length)return[];var n=[];if(1===e.length)n=t?sh(e[0]):e;else{if(t){var r,a=_n(e);try{for(a.s();!(r=a.n()).done;){var o=r.value;Array.prototype.push.apply(n,sh(o))}}catch(e){a.e(e)}finally{a.f()}}else n=e;var i=function(e){var t,n={},r={},a=[],o=_n(e);try{for(o.s();!(t=o.n()).done;){var i,u=hh(t.value,a),s=_n(u);try{for(s.s();!(i=s.n()).done;)for(var l=i.value,c=l.rowFrom();c<=l.rowTo();++c)n[c]=n[c]?n[c]+l.colCount():l.colCount()}catch(e){s.e(e)}finally{s.f()}var h,f=_n(u);try{for(f.s();!(h=f.n()).done;)for(var d=h.value,v=d.colFrom();v<=d.colTo();++v)r[v]=r[v]?r[v]+d.rowCount():d.rowCount()}catch(e){f.e(e)}finally{f.f()}Array.prototype.push.apply(a,u)}}catch(e){o.e(e)}finally{o.f()}return{rowCountMap:n,colCountMap:r}}(n),u=i.rowCountMap,s=i.colCountMap,l=e[0].sheet(),c=Object.keys(u).map((function(e){return Number(e)})),h=Object.keys(s).map((function(e){return Number(e)})),f=c.length,d=h.length;n=c.every((function(e){return u[e]===d}))&&h.every((function(e){return s[e]===f}))?function(e,t,n){if(0===e.length||0===t.length)return[];for(var r=[],a=[],o=e[0],i=t[0],u=0;u<e.length-1;++u)e[u]+1!==e[u+1]&&(r.push([o,e[u]-o+1]),o=e[u+1]);r.push([o,e[e.length-1]-o+1]);for(var s=0;s<t.length-1;++s)t[s]+1!==t[s+1]&&(a.push([i,t[s]-i+1]),i=t[s+1]);a.push([i,t[t.length-1]-i+1]);for(var l=[],c=0,h=r;c<h.length;c++){var f,d=h[c],v=_n(a);try{for(v.s();!(f=v.n()).done;){var g=f.value;l.push(new Oi(d[0],g[0],d[1],g[1],n))}}catch(e){v.e(e)}finally{v.f()}}return l}(c,h,l):t?sh(e[e.length-1]):[e[e.length-1]]}return yh(n)}function dh(e){var t=new Set,n=new Set;if(!e||0===e.length||1===e.length)return{rows:t,cols:n};for(var r=1,a=e.length,o=0;o<a-1;++o){var i=e[o],u=e[o+1];if(i.rowFrom()!==u.rowFrom())break;for(var s=i.colTo()+1;s<u.colFrom();++s)n.add(s);++r}for(var l=0;l<a-r;l+=r)for(var c=e[l],h=e[l+r],f=c.rowTo()+1;f<h.rowFrom();++f)t.add(f);return{rows:t,cols:n}}function vh(e,t){return{row:e.rowFrom(),col:e.colFrom(),row_count:e.rowCount(t),col_count:e.colCount(t)}}function gh(e){return{row:e.row,col:e.col,row_count:e.rowCount,col_count:e.colCount}}function mh(e,t){var n,r,a=1,o=[],i=_n(e);try{for(i.s();!(r=i.n()).done;){var u=r.value;void 0===n?n=u:n+a===u?++a:n+a<u&&(o.push(new xi(n,a,t)),n=u,a=1)}}catch(e){i.e(e)}finally{i.f()}return void 0!==n&&o.push(new xi(n,a,t)),o}function ph(e,t){var n=e.sheet(),r=new Oi(e.rowFrom(),e.colFrom(),e.rowCount(!0),e.colCount(!0),n);if(!n)return{filteredRows:new Set,range:r};var a,o=n.filterModel.getAllFilteredOutRowsArray(),i=new Set,u=_n(o);try{for(u.s();!(a=u.n()).done;){var s=a.value;r.rowFrom()<=s&&s<=r.rowTo(!0)&&(i.add(s),t&&r.setRowCount(r.rowCount(!0)+1))}}catch(e){u.e(e)}finally{u.f()}return{filteredRows:i,range:r}}function yh(e){return e.map((function(e){return Oi.toNormalRange(e)}))}var Ch=function(e,t,n){if(!e)return"";var r=e.filter((function(e){return e.isValidRefInSheet()})).map((function(e){var r=_h(e,t);return n&&(r="'".concat(e.sheetName,"'!").concat(r)),r}));return r.join()},_h=function(e,t){return e instanceof Ei?(t?(e instanceof Vi||e instanceof xi||e instanceof Ni)&&(e=Oi.toNormalRange(e)):e instanceof Oi&&1===e.rowCount()&&1===e.colCount()&&(e=new Zi(e.rowFrom(),e.colFrom(),e.sheet())),e.toString({refStyle:"A1",ref:e})):""},Rh=function(e){return/^([a-zA-Z]+\d+):([a-zA-Z]\d+)$/.test(e)&&(e=e.replace(/^(.+):(.+)$/,(function(e,t,n){return t===n?t:e}))),e};function wh(e,t){if(!e)return"";var n=e.getSelections(),r="name"===t.type,a=Ch(n,!1,r);return r&&(a=a.replace("'".concat(t.value,"'!"),"")),"id"===t.type?t.value===e.id()?a:"'".concat(e.id(),"'!").concat(a):a}function kh(e,t,n,r,a){if(!t||!e)return"";if(t===ut.ErrorConstant.REF)return t;var o=a||e.getActiveSheet();if(!o)return"";var i=o.rangeStringToRange(t);return i&&i instanceof Ei?(function(e){return!(!e||e>15||e<1)}(n)&&i.setRefStatus(n),null==r&&(r=o.name()!==i.sheetName),i.toString({ref:i,isShowSheetName:r})):""}function Sh(e,t,n){return kh(e,t,15,n)}function Eh(e,t,n,r){return Sh(e,_h(t,n),r)}function Th(e,t,n,r){if(!t||!t.length)return"";var a=t.filter((function(e){return e.isValidRefInSheet()})).map((function(t){return Eh(e,t,n,r)}));return a.join()}function Ah(e,t,n,r){if(!t||!t.length)return[];var a=t.filter((function(e){return e.isValidRefInSheet()})).map((function(t){return Eh(e,t,n,r)}));return a}var Ih=function(e,t,n){if(!e)return[];var r=e.filter((function(e){return e.isValidRefInSheet()})).map((function(e){var r=_h(e,t);return n&&(r="'".concat(e.sheetName,"'!").concat(r)),r}));return r};function bh(e,t,n){var r=t||e[0]&&e[0].sheet();if(!r)return e;var a,o=[],i=[[]],u=function(e,t,n){i[e]||(i[e]=[]),n?i[e][t]=1:delete i[e][t]},s=_n(e);try{for(s.s();!(a=s.n()).done;){var l=a.value;if(l.sheet()===r)if([we.xj7.NORMAL,we.xj7.CELL].includes(l.rgType))for(var c=l.rowFrom(),h=l.colFrom(),f=l.rowCount(n),d=l.colCount(n),v=1;v<=f;v++)for(var g=1;g<=d;g++)u(c+v-1,h+g-1,!0);else o.push(l);else o.push(l)}}catch(e){s.e(e)}finally{s.f()}for(var p=function(){var e=null;return i.some((function(t,n){return t.some((function(t,r){return!!t&&(e=[n,r],!0)}))})),e},y=function(e,t){for(var n=0,a=0,o=1,s=1,l=function(){var r=e+n,l=t+a,c=l+1,h=r+1;return i[r]&&i[r][l]&&(0===n&&(s=a+1),0===a&&(o=n+1),a<s&&n<o&&u(r,l,!1)),i[r]&&i[r][c]?(a++,!0):(a=0,!(!i[h]||!i[h][l]||(n++,0)))},c=l();c;)c=l();return new Oi(e,t,o,s,r)},C=p();C;){var _=y.apply(void 0,(0,m.Z)(C));_&&o.push(_),C=p()}return o}function Fh(e){var t=[],n=[];try{var r,a=e[0].target,o=_n(e);try{for(o.s();!(r=o.n()).done;){for(var i=r.value,u=i.target,s=i.count,l=0;l<s;l++)t[u+l]=!0;a=Math.min(a,u)}}catch(e){o.e(e)}finally{o.f()}for(var c,h=t.length,f=0,d=a;d<h;)t[d]?1===++f&&(c=d):f>0&&(n.push({target:c,count:f}),f=0),d++;f>0&&n.push({target:c,count:f})}catch(e){return console.error("this is a unexpected removing duplicated row col error. Pleace check!"),[]}return n}function Mh(e,t){return null!==e.cellModel.iterVisibleContent(t.rowFrom(),t.colFrom(),t.rowTo(),t.colTo()).first_if((function(t){var n=(0,p.Z)(t,2),r=n[0],a=n[1],o=a.row,i=a.col,u=e._getModel().getVarByContent(r,o,i);return!!((Wf(u)||zf(u))&&u.getArrayRef().size()>1)}))}function Vh(e,t){var n=e.filterModel;if(t){var r=e.viewsModel.getViewById(t);r&&(n=r.getFilterModel())}var a=n.getValidFilterRules(),o=[];return(0,m.Z)(a).forEach((function(e){var t=(0,p.Z)(e,1)[0],r=n.getFilterInfo(t);r&&o.push(r)})),o}function Nh(e,t,n,r,a,o){var i=e.getPivotTableManager();if(!i.hasPivotTable())return!1;var u,s=new Oi(t,n,r,a,e),l=_n(i.getPivotInfoMap());try{for(l.s();!(u=l.n()).done;){var c=(0,p.Z)(u.value,2),h=c[0],f=c[1];if(null==o||!o.includes(h)){var d=f.contentRange,v=f.pageRange,g=f.row,m=f.col;if(s.containCell(g,m))return!0;if(null!=d&&d.isIntersect(s))return!0;if(null!=v&&v.isIntersect(s))return!0}}}catch(e){l.e(e)}finally{l.f()}return!1}var Oh=function(e,t){return{rowFrom:e.rowFrom(),rowTo:e.rowTo(t),rowCount:e.rowCount(t),colFrom:e.colFrom(),colTo:e.colTo(t),colCount:e.colCount(t)}};function xh(e,t){var n=e.getRowCount();if(t<0||t>=n)return t+1;var r=e._rowInfos.firstVisible(t+1,n-1);return r?r.index:t+1}function Zh(e,t,n,r){var a=arguments.length>4&&void 0!==arguments[4]?arguments[4]:[],o=e.getRowCount(),i=e.getColumnCount();if(t>=o)return!1;for(var u=Math.min(i-1,r),s=n;s<=u;s++){var l,c=!1,h=_n(a);try{for(h.s();!(l=h.n()).done;){var f=l.value;if(f.containCell(t,s)){c=!0;break}}}catch(e){h.e(e)}finally{h.f()}if(!c){var d=e.getSpan(t,s),v=t,g=s;if(d&&(v=d.rowFrom(),g=d.colFrom()),e.hasContent(v,g))return!0}}return!1}function Dh(e,t,n){if(e>t)return 0;var r,a=0,o=_n(n);try{for(o.s();!(r=o.n()).done;){var i=r.value,u=Oh(i),s=u.rowFrom,l=s+u.rowCount-1,c=Math.min(l,t)-Math.max(s,e)+1;a+=c>0?c:0}}catch(e){o.e(e)}finally{o.f()}return a}function Ph(e,t,n,r){var a=e.getRowCount(),o=t.colFrom(),i=t.colTo();if(n>=a)return n;for(var u=n,s=xh(e,u);s<a&&(!Nh(e,s,o,1,i)&&Zh(e,s,o,i,r));)s=xh(e,u=s);return u}var Lh=function(e){return e.viewsModel.getViewList().map((function(e){return{id:e.getId(),name:e.getName(),range:e.getFilterModel().filterRange}}))},Bh=function(e,t,n){var r=n.targetRange,a=Oh(t,!0),o=a.rowTo,i=a.colFrom,u=a.colTo,s=a.colCount,l=Oh(r,!0),c=l.rowFrom,h=l.rowTo,f=l.colFrom,d=l.colTo;if(Nh(e,c,i,l.rowCount,s))return!1;if(d<i||f>u)return!1;var v=xh(e,o);return o<h&&c<=v};function Uh(e,t,n){var r=n.targetRangeArr,a=n.ignoreRanges,o=(0,m.Z)(r);o.sort((function(e,t){return e.rowFrom()-t.rowFrom()}));for(var i=t.clone(),u=t.rowFrom(),s=0,l=o;s<l.length;s++){var c=l[s];if(Bh(e,i,{targetRange:c})){var h=Ph(e,i,c.rowTo(!0),a);i.setRowCount(h-u+1)}}return i.rowTo(!0)}var Hh=function(e,t,n){var r=n.sourceRange,a=n.targetRange,o=t.rowFrom(),i=xh(e,t.rowTo()),u=a.rowFrom(),s=r.rowTo(),l=t.clone(),c=r.rowCount(),h=t.rowTo(),f=!1;i===u&&(f=!0,h=Ph(e,t,i-1),l.setRowCount(h-o+1)),Bh(e,l,{targetRange:r})&&(f=!0,h=Ph(e,l,s));var d=xh(e,h);return o<u&&u<=d&&(h+=c),{shouldExtend:f,targetRow:h-=Dh(o,d,[r])}},Wh=function(e,t,n,r,a,o,i){var u=t.rowFrom(),s=t.clone(),l=t.clone();s.setRowCount(n-u+1);var c,h,f=vh(s,!0),d=vh(l,!0),v=e.id();if(Nh(e,s.rowFrom(),s.colFrom(),s.rowCount(),s.colCount()))return{actions:[],oldActions:[]};if(o&&i?(c=[(0,we.eRv)(v,{range:f,view_id:i})],h=[(0,we.eRv)(v,{range:d,view_id:i})]):(c=[{action:"setFilter",sheet_id:v,target:f,value:null}],h=[{action:"setFilter",sheet_id:v,target:d,value:null}]),r)if(i){var g=e.viewsModel.getViewById(i).getFilterModel(),m=g.getInfo().range.clone();m.setRowCount(n-u+1),g.setRange(Oi.toNormalRange(m).toSimpleObj(),!1)}else{var p=e.sheetFilterModel.getInfo();p&&p.range.setRowCount(n-u+1)}return a&&(c=[]),{actions:c,oldActions:h}},jh=function(e,t,n,r,a){var o=arguments.length>5&&void 0!==arguments[5]&&arguments[5],i=e.id(),u=vh(n);o&&t.push((0,we.VCn)(i,{view_id:r,name:a})),t.push((0,we.eRv)(i,{range:u,view_id:r}));var s=Vh(e,r);s&&s.forEach((function(e){var n=e.col,a=e.type,o=e.compare,s=e.expected,l=e.contents;t.push((0,we.eRv)(i,{filter_value:{col:n,type:0===a?null:a,compare:o,expected:s,contents:l},range:u,view_id:r}))})),e.viewsModel.getActiveViewId()===r&&t.push((0,we.fdi)(i,r))},zh=function(e,t){var n=e.sheetFilterModel,r=n.getInfo();if(r){var a=r.range;t.push({action:"setFilter",sheet_id:e.id(),target:vh(a),value:null}),(0,m.Z)(n.getValidFilterRules()).forEach((function(n){var r=(0,p.Z)(n,1)[0],o=e.sheetFilterModel.getFilterInfo(r);o&&t.push({action:"setFilter",sheet_id:e.id(),target:vh(a),value:o})}))}},Gh=function(e,t,n,r){var a=arguments.length>4&&void 0!==arguments[4]&&arguments[4],o=[];return r&&n?jh(e,o,t,r,n,a):zh(e,o),o},Jh=function(e,t,n,r){return n&&r?{actions:[(0,we.h_E)(e.id(),{view_id:r,name:n})],oldActions:Gh(e,t,n,r,!0)}:e.sheetFilterModel.getInfo()?{actions:[{action:"delFilter",sheet_id:e.id()}],oldActions:Gh(e,t)}:{actions:[],oldActions:[]}},qh=function(e,t){var n=t.sourceRange,r=t.targetRange,a=e.rowFrom(),o=e.rowCount(),i=r.rowFrom(),u=Dh(0,a-1,[n]),s=0;i>=0&&i<=a&&(s=r.rowCount());var l=s-u,c=e.clone();return c.setRowFrom(a+l),c.setRowCount(o),{adjustRange:c,offset:l}},$h=function(e,t,n,r,a){var o=(0,m.Z)(n);o.sort((function(e,t){return e.rowFrom()-t.rowFrom()}));var i,u=Oh(t).rowFrom,s=t.clone(),l=!1,c=_n(o);try{for(c.s();!(i=c.n()).done;){var h=i.value,f=Oh(h),d=f.rowFrom,v=f.rowCount,g=d+v-1;if(d<=u&&u<=g)return Jh(e,t,r,a);var p=new xi(d,v,e);if(!l&&t.intersect(p)&&(l=!0),Bh(e,s,{targetRange:p})){l=!0;var y=Ph(e,s,g);s.setRowCount(y-u+1)}}}catch(e){c.e(e)}finally{c.f()}if(!l)return{actions:[],oldActions:[]};var C=Dh(s.rowFrom(),s.rowTo(!0),n),_=s.rowTo(!0)-C,R=function(e,t){var n=t.filterRange,r=t.deleteRowsArr,a=t.targetRow,o=t.viewId,i=t.viewName,u=n.rowFrom(),s=n.rowCount(),l=Dh(0,u-1,r),c=n.clone();return c.setRowFrom(u-l),c.setRowCount(s),Wh(e,c,a-l,!1,!1,i,o).actions}(e,{filterRange:t,deleteRowsArr:n,targetRow:_,viewId:a,viewName:r});return{actions:R,oldActions:Wh(e,t,_,!1,!1,r,a).oldActions}},Yh=function(e,t,n,r,a){var o,i=Oh(t),u=i.colFrom,s=i.colTo,l={actions:[],oldActions:[]},c=_n(n);try{for(c.s();!(o=c.n()).done;){var h=o.value,f=Oh(h),d=f.colFrom,v=f.colTo;if(d<=u&&s<=v)return Jh(e,t,r,a);if(d>=u&&d<=s||v>=u&&v<=s){(0,we.hTd)(l.oldActions,Gh(e,t,r,a));break}}}catch(e){c.e(e)}finally{c.f()}return l},Kh=function(e,t,n){var r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{executeLocal:!1},a={actions:[],oldActions:[]};try{var o=r.executeLocal,i=e.sheetFilterModel.filterRange;if(null!=i&&i.isValid()){var u=Uh(e,i,{targetRangeArr:t,ignoreRanges:n});if(u>i.rowTo(!0)){var s=Wh(e,i,u,!!o,!1),l=s.actions,c=s.oldActions;(0,we.hTd)(a.actions,l),(0,we.hTd)(a.oldActions,c)}}var h,f=Lh(e),d=_n(f);try{for(d.s();!(h=d.n()).done;){var v=h.value,g=v.name,m=v.id,p=v.range;if(null!=p&&p.isValid()){var y=Uh(e,p,{targetRangeArr:t,ignoreRanges:n});if(y>p.rowTo(!0)){var C=Wh(e,p,y,!!o,!1,g,m),_=C.actions,R=C.oldActions;(0,we.hTd)(a.actions,_),(0,we.hTd)(a.oldActions,R)}}}}catch(e){d.e(e)}finally{d.f()}}catch(e){console.error("extendFilterHelper.ts: getFilterExtendChangeSetsByMultiRange error")}return a},Xh=function(e,t){var n={actions:[],oldActions:[]};try{var r=t.rowTo(),a=e.sheetFilterModel.filterRange;if(null!=a&&a.isValid()&&Bh(e,a,{targetRange:t})){var o=Wh(e,a,r,!0),i=o.actions,u=o.oldActions;(0,we.hTd)(n.actions,i),(0,we.hTd)(n.oldActions,u)}var s,l=_n(Lh(e));try{for(l.s();!(s=l.n()).done;){var c=s.value,h=c.name,f=c.id,d=c.range;if(Bh(e,d,{targetRange:t})){var v=Wh(e,d,r,!0,!1,h,f),g=v.actions,m=v.oldActions;(0,we.hTd)(n.actions,g),(0,we.hTd)(n.oldActions,m)}}}catch(e){l.e(e)}finally{l.f()}}catch(e){console.error("extendFilterHelper.ts: getFilterExtendChangeSetsByRemoveDuplication error")}return n};var Qh,ef=function(e,t){var n=e.filterModel&&e.filterModel.getFilterRules();n&&n.size>0&&n.forEach((function(n,r){var a=n.getCompareTypeAndConditionTypeForEnum(),o=(0,p.Z)(a,2),i=o[0],u=o[1];if(1===i||0===u){for(var s=[],l=t.rowInterval(),c=(0,p.Z)(l,2),h=c[0],f=c[1],d=h+1;d<h+f;d++)s.push(e.getText(d,r));var v,g=!0,y=_n((0,m.Z)(n.params));try{e:for(y.s();!(v=y.n()).done;){var C,_=v.value,R=_n(s);try{for(R.s();!(C=R.n()).done;){if(C.value===_){g=!1;break e}}}catch(e){R.e(e)}finally{R.f()}}}catch(e){y.e(e)}finally{y.f()}if(g){var w=e.filterModel.filterRange,k=e.viewsModel&&e.viewsModel.activeView;e.setFilterView(null==k?void 0:k.getId(),!0,{range:w.toJSON(),col:r,value:null})}}}))};!function(e){e.PrimitiveMatrixVar="PrimitiveMatrixVar",e.RefMatrixVar="RefMatrixVar",e.MixinMatrixVar="MixinMatrixVar",e.SlicedMatrixVar="SlicedMatrixVar",e.FixedSizeMatrixVar="FixedSizeMatrixVar",e.SheetRefVar="SheetRefVar",e.MultipleRefsVar="MultipleRefsVar",e.ProxyRefVar="ProxyRefVar"}(Qh||(Qh={}));var tf=function(e){function t(e,n,r){var a;return(0,y.Z)(this,t),(a=(0,d.Z)(this,(0,v.Z)(t).call(this,n))).name=e,a.data=r,a.ignoreCache=!0,a}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"getRef",value:function(){var e,t=new Oi(0,0,this.rowCount(),this.colCount(),null===(e=this.ref)||void 0===e?void 0:e.sheet());return t.colCount=t.colCount.bind(t,!0),t}},{key:"iter",value:function(){var e=Array.isArray(this.data)?this.data:[this.data];return new yu(e)}},{key:"setData",value:function(e){this.data=Array.isArray(e)?e:[e]}},{key:"rowCount",value:function(){return 1}},{key:"colCount",value:function(){return(Array.isArray(this.data)?this.data:[this.data]).length}},{key:"getVar",value:function(){return this.nth(0)}},{key:"getVarByPos",value:function(e,t){return this.nth(t)}},{key:"toString",value:function(){return this.name}},{key:"iterWithPos",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{skipEmptyRef:!0};void 0===e.skipEmptyRef&&(e.skipEmptyRef=!0);var t=new yu(this.data),n=new Array(3);return t.map((function(e){return n[1]=t.getCurrRow(),n[2]=t.getCurrCol()-1,n[0]=e,n}))}},{key:"nth",value:function(e){var t=Array.isArray(this.data)?this.data:[this.data];return(0,ut.boxValue)(t[e])}},{key:"getDataVar",value:function(e,t){return this.nth(t)}},{key:"size",value:function(){return Array.isArray(this.data)?this.data.length:1}},{key:"customType",get:function(){return"SheetRefVar"}}]),t}(Su);var nf,rf=we.d$b[we.O6N.REF_INVALID_CELL_REFERENCE]({funcName:"",index:-1,value:""}),af=function(e){function t(e){var n;return(0,y.Z)(this,t),(n=(0,d.Z)(this,(0,v.Z)(t).call(this))).id=e,n}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"nth",value:function(){return rf}},{key:"size",value:function(){return 0}},{key:"getValue",value:function(){return null}},{key:"getSheetRef",value:function(e){var t;return null!==(t=null==e?void 0:e[this.id])&&void 0!==t?t:rf}},{key:"customType",get:function(){return"ProxyRefVar"}}]),t}(ut.BaseCustomCollectionVar);function of(e,t,n){return"".concat(e?e.join():"",":").concat(t?t.join():"",":").concat(n||"")}!function(e){e[e.hasSubtotal=1]="hasSubtotal",e[e.hasAggregate=2]="hasAggregate",e[e.hasArrayFunction=4]="hasArrayFunction",e[e.hasAsyncFunction=8]="hasAsyncFunction"}(nf||(nf={}));var uf={enumerable:!1,writable:!0,configurable:!0};function sf(e,t){Object.defineProperty(e,0,uf),e[0]=t}var lf=function(){function e(t){var n,r,a,o,i,u,s,l=this,c=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},h=arguments.length>2?arguments[2]:void 0,f=arguments.length>3&&void 0!==arguments[3]&&arguments[3];(0,y.Z)(this,e),this.alwaysCalcInfo=h,this.enableCalculation=f,this.tokens=null,this.serialization=null,this.expression=null,this.importRangeMeta=null,this.externalDataReferenceInfo=null,this.status=0,this.tokens=null!==(n=t.tokens)&&void 0!==n?n:null,this.serialization=null!==(r=t.serialization)&&void 0!==r?r:null,this.expression=null!==(a=t.expression)&&void 0!==a?a:null,this.params=null!==(o=t.params)&&void 0!==o?o:null,this.importRangeId=null!==(i=t.importRangeId)&&void 0!==i?i:null,this.importRangeMeta=null!==(u=t.importRangeMeta)&&void 0!==u?u:null,this.externalDataReferenceInfo=null!==(s=t.externalDataReferenceInfo)&&void 0!==s?s:null,Object.entries(c).forEach((function(e){var t=(0,p.Z)(e,2),n=t[0],r=t[1],a=nf[n];r&&(l.status=l.status|a)}))}return(0,C.Z)(e,[{key:"hash",value:function(){return this.key||(this.key=of(this.tokens,this.params,this.importRangeId))}},{key:"getStatus",value:function(e){return Boolean(this.status&e)}},{key:"getHashObject",value:function(){var e,t;return{tokens:this.tokens,params:this.params,importRangeId:null!==(e=null===(t=this.importRangeMeta)||void 0===t?void 0:t.importRangeId)&&void 0!==e?e:this.importRangeId}}},{key:"hasSubtotal",get:function(){return this.getStatus(nf.hasSubtotal)}},{key:"hasAggregate",get:function(){return this.getStatus(nf.hasAggregate)}},{key:"hasArrayFunction",get:function(){return this.getStatus(nf.hasArrayFunction)}},{key:"hasAsyncFunction",get:function(){return this.getStatus(nf.hasAsyncFunction)}}]),e}(),cf=function(){function e(){(0,y.Z)(this,e),this.pool={}}return(0,C.Z)(e,[{key:"save",value:function(e,t){this.pool[e]=t}},{key:"get",value:function(e){return this.pool[e]||null}},{key:"add",value:function(e){var t=this.getHash(e);return this.pool[t]||(this.save(t,e),e)}},{key:"clear",value:function(){this.pool={}}}]),e}(),hf=function(e){function t(e,n){var r;return(0,y.Z)(this,t),(r=(0,d.Z)(this,(0,v.Z)(t).call(this))).formulaRefManager=e,r.refMapRefManager=n,r}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"add",value:function(e){return this.formulaRefManager.add(e.formula),e.refMap&&this.refMapRefManager.add(e.refMap),(0,f.Z)((0,v.Z)(t.prototype),"add",this).call(this,e)}},{key:"save",value:function(e,n){sf(n,e),(0,f.Z)((0,v.Z)(t.prototype),"save",this).call(this,e,n)}},{key:"updateRefMap",value:function(e,t){var n=this.getHash(e,!1),r=e.refMap;if(r){var a=this.refMapRefManager.getHash(r),o=t(r);o&&this.refMapRefManager.updateRefMapHash(a,o);var i=this.getHash(e,!1);return n!==i&&(this.pool[n]=void 0,this.save(i,e)),o}}},{key:"equals",value:function(e,t){return e.formula===t.formula&&e.refMap===t.refMap||this.getHash(e)===this.getHash(t)}},{key:"getHash",value:function(e){var t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],n=e[0];if(t&&n)return n;var r=e.formula,a=e.refMap;return this.formulaRefManager.getHash(r)+(a?this.refMapRefManager.getHash(a):"")}}]),t}(cf),ff=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"equals",value:function(e,t){return e===t||this.getHash(e)===this.getHash(t)}},{key:"getHash",value:function(e){return e.hash()}},{key:"getByVal",value:function(e){var t=of(e.tokens,e.params,e.importRangeId);return this.get(t)}}]),t}(cf),df=function(e){function t(){var e;return(0,y.Z)(this,t),(e=(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))).relativeCache={},e}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"onRangeChange",value:function(e){var t=e.hash(!0);this.relativeCache[t]&&(this.relativeCache[t]=void 0)}},{key:"updateRefMapHash",value:function(e,t){var n=this.get(e);if(n&&n===t){var r=this.getHash(t,!1);r!==e&&(this.pool[e]=void 0,this.save(r,t))}}},{key:"getHash",value:function(e){var t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],n=e[0];return t&&n?n:this.calcRefMapHash(e)}},{key:"save",value:function(e,n){sf(n,e),(0,f.Z)((0,v.Z)(t.prototype),"save",this).call(this,e,n)}},{key:"equals",value:function(e,t){return this.getHash(e)===this.getHash(t)}},{key:"calcRefMapHash",value:function(e){var t=Object.keys(e);t.length>1&&t.sort();for(var n=0,r=t.length;n<r;n++){var a=t[n],o=e[a],i=o.hash(!0,!0);this.relativeCache[i]||(this.relativeCache[i]=o),t[n]=a+i+";"}return t.join()}}]),t}(cf),vf=function(e){function t(e){var n;return(0,y.Z)(this,t),(n=(0,d.Z)(this,(0,v.Z)(t).call(this))).index=e,n}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"clone",value:function(){return new t(this.index)}},{key:"toNumberVar",value:function(){throw new Error("ParameterVar can not convert toNumberVar")}},{key:"toStringVar",value:function(){throw new Error("ParameterVar can not convert toStringVar")}},{key:"toBooleanVar",value:function(){throw new Error("ParameterVar can not convert toBooleanVar")}},{key:"getValue",value:function(){return ut.NAME_ERR_VAR.getValue()}},{key:"getVar",value:function(e){var t;if(null==e)return ut.NAME_ERR_VAR;var n=e.parameterScope;return null==n?ut.NAME_ERR_VAR:null!==(t=n[this.index])&&void 0!==t?t:ut.NAME_ERR_VAR}},{key:"serializeValue",value:function(){return null}},{key:"customType",get:function(){return"ParamVar"}}]),t}(ut.BaseCustomPrimitiveVar);function gf(e){return e.isCustomPrimitive()&&"ParamVar"===e.customType}var mf=function(e){function t(e,n){var r;return(0,y.Z)(this,t),(r=(0,d.Z)(this,(0,v.Z)(t).call(this,e))).operator=e,r.argCount=n,r.lazyCalc=!1,r.type=ut.VAR_TYPE.OPERATOR,r}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"isOp",value:function(){return!0}},{key:"getVar",value:function(e){var t=(0,ut.combineCtxArgs)(e,this.args);return this.operator.calc.apply(this.operator,t).toValidVar()}},{key:"getValue",value:function(e){return this.getVar(e).getValue(e)}},{key:"getArgs",value:function(){return this.args}},{key:"getDependencies",value:function(){return this.args}},{key:"op",value:function(){return this.operator}},{key:"serialize",value:function(){return null}},{key:"setOperator",value:function(e){this.operator=e}},{key:"setArgs",value:function(e){this.args=e}},{key:"getArgCount",value:function(){return this.argCount}},{key:"setLazyCalc",value:function(e){this.lazyCalc=e}},{key:"canLazyCalc",value:function(){return this.lazyCalc}}]),t}(ut.OperatorVar);function pf(e,t){if(th(t)){var n=e.parent.importRangeManager.getMetaFromFormula(t);if(n)return{spreadToken:n.spreadToken,ref:n.ref,isSyncStyle:n.isSyncStyle,importRangeId:n.importRangeId,spreadSource:n.spreadSource}}}var yf=function(e){function t(){var e;return(0,y.Z)(this,t),(e=(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))).name="InvokeFunctionOp",e.operands=1,e.optionOperands=254,e.resultType=ut.VAR_TYPE.ALL,e.repeatedLastParam=1,e.paramsDesc=[{type:ut.VAR_TYPE.OPERATOR|ut.VAR_TYPE.CUSTOM_PRIMITIVE,customType:{primitive:["LambdaVar"]}},{type:ut.VAR_TYPE.ALL}],e}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e,t){var n,r,a=t.isOp()?t.getVar(e):t;if(a.isError())return a;if(!dc(a))return new ut.ErrorVar(ut.ErrorType.NA,ut.ErrorConstant.NA,we.O6N.INVALID_CALL_TO_NON_FUNCTION);if(null!==(n=e.invokedFunctionCircleChecker)&&void 0!==n&&n.has(a))return new ut.ErrorVar(ut.ErrorType.RUNTIME_ERROR,ut.ErrorConstant.RUNTIME_ERROR,we.O6N.REACHED_CALC_LIMIT);var o=null!==(r=e.invokedFunctionCircleChecker)&&void 0!==r?r:new Set;o.add(a),e.invokedFunctionCircleChecker=o;var i=a.getParams();if((arguments.length<=2?0:arguments.length-2)!==i.length)return we.d$b[we.O6N.WRONG_NUMBER_OF_ARGUMENTS_TO_CALL_FOLLOWING_LAMBDA_FUNCTION]({funcName:"LAMBDA",argCount:arguments.length<=2?0:arguments.length-2,requiredOperandCount:i.length});if(0!=(arguments.length<=2?0:arguments.length-2)){for(var u,s=null!==(u=e.parameterScope)&&void 0!==u?u:[],l=0;l<(arguments.length<=2?0:arguments.length-2);l++){var c=l+2<2||arguments.length<=l+2?void 0:arguments[l+2];c.isOp()&&(c=c.getVar(e)),s[i[l].index]=c}e.parameterScope=s}var h=a.getVar(e);return o.delete(a),h}}]),t}(ut.OpBase);function Cf(e){for(var t=e.tokens,n=e.refStringGen,r=e.params,a="",o=0;o<t.length;o++){var i=t[o];switch(i[0]){case"R":a+=n(i);break;case"C":a+=i.slice(1);break;case"P":null!=r&&(a+=r[i.slice(1)]);break;default:throw new Error("unknown token ".concat(i[0]))}}return a}function _f(e,t,n){return Cf({tokens:e.tokens,refStringGen:function(e){return t[e].toString(n)},params:e.params})}function Rf(e,t){var n=e.getRefMap(),r=e.formula.tokens;if(null==r)throw new Error("failed to decompile formula without tokens");return Cf({tokens:r,refStringGen:function(r){return n&&n[r]?ki(n[r],e.getRef()).toString(t):ut.REF_ERR_VAR.getValue()},params:e.formula.params})}function wf(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},r=n.refType,a=void 0===r?0:r,o=n.shouldContainExternalDataReference,i=void 0===o||o,u=n.isMutation,s=void 0!==u&&u,l=e.formula.tokens;if(null==l)throw new Error("Tokens not found in formula");var c=e.getRef().sheet(),h=c&&c.parent.importRangeManager;if(!c||!h)throw new Error("ImportRangeManager not found");var f={v:1,refs:null},d=e.getRefMap(),v=null;if(null!=d){var g={};for(var m in v=new Map,d){var p=d[m];v.set(p,m),g[m]=s?p.toGridJSON():Mc(ki(p,t.ref),t,a)}f.refs=g}var y=e.formula.params;null!==y&&(f.params=y);var C=e.formula.serialization;if(f.tree=null!=C?C:kf(e.formula.expression,v),Wf(e)&&(f.flag=1),i){var _=pf(c,e);_&&(f.externalDataReference=_)}return f.tokens=l,f}function kf(e,t){for(var n=[],r=0;r<e.length;r++){var a=e[r];if(Au(a))bf(a,n);else{if(a.isOp()){var o=a.op(),i=o.name;if(o instanceof ut.FuncOpBase){n.push("F:".concat(i,":").concat(a.getArgCount()));continue}if(o instanceof ut.BinaryOpBase){n.push("OB".concat(i));continue}if(o instanceof ut.PrefixUnaryOpBase){n.push("OP".concat(i));continue}if(o instanceof ut.SuffixUnaryOpBase){n.push("OS".concat(i));continue}if(o instanceof ut.ParenOp){n.push("OG".concat(a.getArgCount()));continue}if(o instanceof yf){n.push("OI".concat(a.getArgCount()));continue}}switch(a.type){case ut.VAR_TYPE.NUMBER:Ef(a,n);break;case ut.VAR_TYPE.STRING:Sf(a,n);break;case ut.VAR_TYPE.BOOL:Tf(a,n);break;case ut.VAR_TYPE.NULL:Af(n);break;case ut.VAR_TYPE.ERROR:If(a,n);break;case ut.VAR_TYPE.CUSTOM_COLLECTION:Fu(a)?Ff(a,n,t):Mu(a)&&Mf(a,n);break;case ut.VAR_TYPE.CUSTOM_PRIMITIVE:gf(a)&&Vf(a,n)}}}return n}function Sf(e,t){t.push("S".concat(e.getValue()))}function Ef(e,t){t.push("D".concat(e.getValue()))}function Tf(e,t){t.push("B"+(e.getValue()?1:0))}function Af(e){e.push("N")}function If(e,t){var n=e.getSpecialInfo();n&&"string"==typeof n.errorInfo?t.push("E:".concat(e.errorType,":").concat(n.errorInfo,":").concat(e.errorCode)):t.push("E:".concat(e.errorType,"::").concat(e.errorCode))}function bf(e,t){t.push("M:".concat(e.rowCount(),":").concat(e.colCount()))}function Ff(e,t,n){var r=n.get(e.getRef());if(null==r)throw new Error("ref not found in map");t.push(r)}function Mf(e,t){t.push(e.id)}function Vf(e,t){t.push("P".concat(e.index))}function Nf(e,t){var n;if(!t.isError()||t.errorCode!==ut.ErrorCode.UNKNOWN_FUNCTION)return null;var r=wf(e,{ref:e.getRef(),isNotShowErrRef:!1},{refType:0,shouldContainExternalDataReference:!1}),a=JSON.stringify(r.tree.filter((function(e){return e.startsWith("F:")})).map((function(e){return e.split(":")[1]})));return(0,l.Z)({},st.TractorFormulaCacheProps.error,(n={},(0,l.Z)(n,st.TractorFormulaCacheErrorProps.type,ut.ErrorType.RUNTIME_ERROR),(0,l.Z)(n,st.TractorFormulaCacheErrorProps.code,ut.ErrorCode.DEFAULT_RUNTIME_ERROR),(0,l.Z)(n,st.TractorFormulaCacheErrorProps.arguments,a),n))}var Of,xf,Zf,Df,Pf;new Set(["AI_WRITE","AI_DEEPSEEK_WRITE","AI_ASK","AI_CLASSIFY","AI_EXTRACT","AI_IMPORTDATA","AI_INFER","AI_POLISH","AI_SENTIMENT","AI_SUMMARY","AI_TRANSLATE"]);function Lf(e,t,n){if(!e.parent.permissionManager.hasPermission(e.id()))return{showExpandRowCol:!1,showCannotExpandRowCol:!1};var r=new Zi(t,n,e);if(!e.protectionModel.getRangePermissions([r]).hasPermission)return{showExpandRowCol:!1,showCannotExpandRowCol:!1};var a=e.getVar(t,n);if(!Wf(a)||!th(a))return{showExpandRowCol:!1,showCannotExpandRowCol:!1};var o=a.getRawVar();if(!Fu(o)&&!Au(o))return{showExpandRowCol:!1,showCannotExpandRowCol:!1};var i=a.getArrayRef(),u=o.rowCount(),s=o.colCount(),l=i.rowFrom(),c=i.colFrom(),h=i.rowCount(),f=i.colCount();if(u!==h||s!==f)return function(e,t,n){return(e.getRowCount()+t)*(e.getColumnCount()+n)>(0,we.$$w)()}(e,u-h,s-f)?{showExpandRowCol:!1,showCannotExpandRowCol:!0}:{showExpandRowCol:!0,showCannotExpandRowCol:!1};var d=e.getRowCount(),v=e.getColumnCount();return l+u>d||c+s>v?{showExpandRowCol:!1,showCannotExpandRowCol:!0}:{showExpandRowCol:!1,showCannotExpandRowCol:!1}}!function(e){e[e.CanExpand=1]="CanExpand",e[e.CanNotExpand=2]="CanNotExpand",e[e.LackRowCol=3]="LackRowCol"}(Of||(Of={})),function(e){e.onMarkDirty="onMarkDirty",e.SetMatrixVar="SetMatrixVar"}(xf||(xf={}));var Bf=function(e){function t(e,n,r){var a;return(0,y.Z)(this,t),(a=(0,d.Z)(this,(0,v.Z)(t).call(this,e,n,r))).expandState={arrayFormulaCanExpand:1},a.arrayRef=null,a.disposeRefWatcher=null,a}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"isArrayFormula",value:function(){return!0}},{key:"watchArrayRef",value:function(e){var t=this;this.disposeRefWatcher&&(this.disposeRefWatcher(),this.disposeRefWatcher=null),e.size(!0)>1&&(this.disposeRefWatcher=this.service.calcEngine.depRefManager.watchRef(e,(function(){t.recheck()})))}},{key:"recheck",value:function(){var e=this.arrayRef;if(e&&e.isValid()){var t=e.sheet();if(t){var n=this.getState().cache;if(n){var r=n.getRawVar();if(Fu(r)||Au(r)){var a=e.rowFrom(),o=e.colFrom(),i=r.rowCount(),u=r.colCount(),s=new Oi(a,o,i,u,t),l=Uf(t._dataModel,s,this,r),c=this.canArrayExpand();e.equal(s)&&c.arrayFormulaCanExpand===l.arrayFormulaCanExpand&&!function(e,t){var n=t.getExpandRef();if(!n)return!1;if(1!==t.canArrayExpand().arrayFormulaCanExpand)return!1;for(var r=n.rowFrom(),a=n.colFrom(),o=n.rowCount(),i=n.colCount(),u=0;u<o;u++)for(var s=r+u,l=0;l<i;l++){var c=a+l,h=e.getImmutableContent(s,c);if(!h||!h.variant)return!0;if(!zf(h.variant))return!0;if(h.variant.formula!==t)return!0}return!1}(t._dataModel,this)||this.service.addValueChangedFormula(this)}}}}}},{key:"getArrayRef",value:function(){if(!this.state.cache)return this.ref;var e=this.state.cache.getInfo();return e&&e.arrayRef?e.arrayRef:this.ref}},{key:"getExpandRef",value:function(){return this.arrayRef}},{key:"getVar",value:function(e){var n=(0,f.Z)((0,v.Z)(t.prototype),"getRawVar",this).call(this,e);if(!n.isCollection())return n;var r=this.getRef(),a=r.sheet(),o=r.rowFrom(),i=r.colFrom();switch(this.expandState.arrayFormulaCanExpand){case 1:return n.nth(0,e);case 3:var u=Lf(a,o,i),s=u.showExpandRowCol,l=u.showCannotExpandRowCol,c=JSON.stringify(this.expandState);return s?we.d$b[we.O6N.ARRAYFORMULA_EXPAND_LACK_ROW_COL_NOT_EXCEED_LIMIT](c):l?we.d$b[we.O6N.ARRAYFORMULA_EXPAND_LACK_ROW_COL_EXCEED_LIMIT](c):we.d$b[we.O6N.ARRAYFORMULA_EXPAND_LACK_ROW_COL](c);default:var h=this.expandState,d=h.row,g=h.col,m=new Zi(d,g,a).toString({ref:new Oi(0,0,1,1,a)});return we.d$b[we.O6N.ARRAYFORMULA_CAN_NOT_EXPAND]({rangeText:m},JSON.stringify(this.expandState))}}},{key:"canArrayExpand",value:function(){return this.expandState}},{key:"dispose",value:function(){this.disposeRefWatcher&&(this.disposeRefWatcher(),this.disposeRefWatcher=null),Hf(this,this.arrayRef||this.getArrayRef()),this.arrayRef=null}},{key:"setArrayCanExpand",value:function(e){this.expandState=e}},{key:"setCurrentArrayRef",value:function(e){this.arrayRef=e}},{key:"fromCache",value:function(e,n){if(!(this.isDirty()||null!=n&&n.forceOverride))return!1;var r=e.a;return null!=r&&(!0!==(null==n?void 0:n.ignoreArrayFormulaCanExpand)&&this.setArrayCanExpand(JSON.parse(r.e)),(0,f.Z)((0,v.Z)(t.prototype),"fromCache",this).call(this,e,n))}},{key:"deserializeCache",value:function(e,n){var r=e.a;if(null==r)return null;var a=e[st.TractorFormulaCacheProps.info];return null!=r.r&&null!=r.c?function(e,t,n,r){var a=t.r,o=t.c,i=t.m,u=t.s;if(null==i||null==a||null==o)return null;for(var s=[],l=0;l<a;l++){s.push([]);for(var c=0;c<o;c++){var h,f=i[l*o+c];if(null==(h=f[st.TractorFormulaCacheProps.customType]?Jc(f):(0,ut.deserializeBaseVar)(f,r)))return null;s[l].push(h)}}var d=new Ru(s),v=new ut.FormulaCache(d,d.getVarByPos(0,0)),g=e.getRef().sheet();return null==g?null:(null!=n&&((0,ut.setTractorFormulaInfo)(v,n),$c(e,v,n,g)),null!=u&&d.setSpecialInfo(JSON.parse(u)),v)}(this,r,a,n):(0,f.Z)((0,v.Z)(t.prototype),"deserializeCache",this).call(this,e,n)}},{key:"serializeCache",value:function(e){var t=this.getState().cache;if(null==t)return null;var n=t.getRawVar(),r={};if(!n.isCollection()){if(null==(r=n.serialize()))return null;var a=Nf(this,n);null!=a&&Object.assign(r,a)}var o=(0,ut.getTractorFormulaInfo)(this);return null!=o&&Gc(r,st.TractorFormulaCacheProps.info,o),null!=(o=qc(this))&&Gc(r,st.TractorFormulaCacheProps.info,o),o=function(e){var t,n,r=null!==(t=null===(n=e.getState().cache)||void 0===n?void 0:n.getInfo())&&void 0!==t?t:null;return null==r||null==r.arrayRef?null:{r:JSON.stringify(Mc(r.arrayRef,{ref:e.getRef()}))}}(this),null!=o&&Gc(r,st.TractorFormulaCacheProps.info,o),r=function(e,t,n){var r=t.getState().cache;if(null==r)return null;var a={e:JSON.stringify(t.canArrayExpand())},o=r.getRawVar();if(!o.isCollection())return Gc(e,"a",a),e;try{for(var i=[],u=0;u<o.size();++u){var s=o.nth(u).getVar().serialize();if(null==s)return null;i[u]=s}var l=t.getArrayRef();a.m=i,null!=n&&n.ignoreRowColLimit?(a.r=l.rowCount(!0),a.c=l.colCount(!0)):(a.r=l.rowCount(),a.c=l.colCount());var c=o.getSpecialInfo();c&&!(0,ut.isEmptyObject)(c)&&(a.s=JSON.stringify(c))}catch(t){if(!(t instanceof ut.PrimitiveVar&&t.isError()))return null;var h=t.serialize();e[st.TractorFormulaCacheProps.value]=h,a.m=[h],a.r=1,a.c=1}return Gc(e,"a",a),e}(r,this,e),this.specialInfo&&!(0,ut.isEmptyObject)(this.specialInfo)&&(r[st.TractorFormulaCacheProps.specialInfo]=JSON.stringify(this.specialInfo)),r}},{key:"calc",value:function(e){var n;return this.service.isSuspended()&&(null==e?void 0:e.executeMode)!==ut.ExecuteMode.FORCE&&th(this)?null!==(n=this.state.cache)&&void 0!==n?n:ut.BaseFormulaVar.WAIT_ASYNC_FORMULA_CACHE:(0,f.Z)((0,v.Z)(t.prototype),"calc",this).call(this,e)}}],[{key:"setUnsetMatrixVarMode",value:function(e){t.unsetMatrixVarMode=e}},{key:"getUnsetMatrixVarMode",value:function(){return t.unsetMatrixVarMode}}]),t}(Kc);function Uf(e,t,n,r){var a=t.rowFrom(),o=t.colFrom();if(e.getVar(a,o)!==n)return{arrayFormulaCanExpand:2,row:a,col:o};var i=r.rowCount(),u=r.colCount(),s=t.rowCount(),l=t.colCount();if(i!==s||u!==l)return{arrayFormulaCanExpand:3,rowCount:i-s,colCount:u-l};var c=e.getRowCount(),h=e.getColumnCount();if(a+i>c||o+u>h)return{arrayFormulaCanExpand:3,rowCount:c-(a+i),colCount:h-(o+u)};var f=t.sheet(),d=f.parent.calcEngine.pivotCalculateEngine,v=e.orderedIterCellWithPos(a,o,i,u).first_if((function(e){var t=(0,p.Z)(e,2),r=t[0],i=t[1],u=i.row,s=i.col,l=r.variant;if(u===a&&s===o){if(l&&Wf(l)&&l===n)return!1}else{if(l&&zf(l)&&l.formula===n)return!1;if(l&&Wa(l))return Boolean(d.getFormulaByPos(u,s,f.id()))}return r.hasContent()}));if(null==v)return{arrayFormulaCanExpand:1};var g=v[1];return{arrayFormulaCanExpand:2,row:g.row,col:g.col}}function Hf(e,t){var n=t.sheet();if(n){var r=t.rowFrom(),a=t.colFrom(),o=n._dataModel,i=n.getCalcEngine();1!==t.size()&&(o.iterContentWithPos(r,a,t.rowCount(),t.colCount()).forEach((function(t){var n=(0,p.Z)(t,2),r=n[0],a=n[1],i=a.row,u=a.col;r.variant&&zf(r.variant)&&r.variant.formula===e&&o.setVariant(i,u,null)})),i.arrayFormulaExpand(t),n.dispatch("RangeChanged",{range:t,type:0}))}}function Wf(e){return e instanceof Bf}Bf.unsetMatrixVarMode=xf.SetMatrixVar,Bf.checkArrayFormulaExpandStateInModel=function(e,t){if(!Wf(t))return!1;var n=t.state.cache;if(!n)return!1;var r=t.getRef(),a=r.sheet();if(null==a||!r.isValidRefInSheet(!0))return!1;var o=n.getRawVar();if(!Fu(o)&&!Au(o))return o!==ut.CIRCULAR_DEPENDENCY_ERR_VAR||1===t.canArrayExpand().arrayFormulaCanExpand;var i=r.rowFrom(),u=r.colFrom(),s=o.rowCount(),l=o.colCount(),c=new Oi(i,u,s,l,a);return 1===Uf(a._dataModel,c,t,o).arrayFormulaCanExpand},Bf.handleValueChanged=function(e){if(Wf(e)){var t=e.state.cache;if(null!=t){var n=e.getRef(),r=n.sheet();if(null!=r&&n.isValidRefInSheet(!0)){var a=t.getRawVar(),o=e.arrayRef;if(e.disposeRefWatcher&&(e.disposeRefWatcher(),e.disposeRefWatcher=null),Fu(a)||Au(a)){var i=n.rowFrom(),u=n.colFrom(),s=a.rowCount(),l=a.colCount(),c=new Oi(i,u,s,l,r);t.setInfo(Object.assign({},t.getInfo(),{arrayRef:c}));var h=Uf(r._dataModel,c,e,a),f=h.arrayFormulaCanExpand;if(th(e)){var d=Promise.resolve();3===f?d=d.then((function(){return function(e,t,n,r){if(!th(t))return!1;var a=t.getRef(),o=a.rowFrom(),i=a.colFrom(),u=e.parent,s=u.importRangeManager,l=u.importRangeManagerV3;if(!th(t)||t.hasImportRangeId()||we.Ps3.getImportRangeV2Enable()){var c=s.getIdFromFormula(t);if(!c)return!1;var h="".concat(c,"_").concat(o,"_").concat(i);if(!s.getImportRangeAutoExpand(h))return!1;s.collectImportRangeFrontError("importrange_add_row_col"),s.finishImportRangeAutoExpand(h)}else{var f=l.formula2ImportRange.get(oh(t));if(!f||1!==f.size)return!1;var d=f.values().next().value;if(!d)return!1;var v="".concat(d,"_").concat(o,"_").concat(i),g=l.importRangeAutoExpandSet;if(!g||!g.has(v))return!1;l.collectImportRangeFrontError("importrange_add_row_col"),g.delete(v)}return e.parent.commandManager().execute({cmd:we.rvF.ADD_ROW_AND_COL,sheetId:e.id(),addRowCount:n,addColCount:r})}(r,e,h.rowCount,h.colCount)})):function(e,t){if(t.isImportRange()){var n=e.parent.importRangeManager,r=n.getIdFromFormula(t);null!=r&&n.finishImportRangeAutoExpand(r)}}(r,e),d.then((function(e){if(1!==f&&!e){var t=r.parent.importRangeManager,n="";switch(f){case 3:n="lack_row_or_col";break;case 2:n="can_not_expand";break;default:n="unknown_array_expand_error"}t.collectImportRangeFrontError(n)}})),1===f&&Promise.resolve().then((function(){e.getArrayRef()===c&&function(e){try{var t=e.sheet();if(null==t)return;var n=t.parent.getActiveSheet();if(!n||t.id()!==n.id())return;var r=t.parent.commandManager();if(!r)return;var a=[],o=Kh(t,[e],void 0,{executeLocal:!0}).oldActions;(0,we.hTd)(a,o),a.length>0&&r.execute({cmd:"setFilter",sheetId:t.id(),range:null,col:null,value:null,_changesets:[],_oldChangesets:a})}catch(e){console.error("extendFilterHelper.ts: extendFilterRangeCommand error")}}(c)}))}var v=e.canArrayExpand().arrayFormulaCanExpand;if(e.setArrayCanExpand(h),null!=o&&(1!==f&&1===v||!c.contain(o))&&Hf(e,o),1===f){var g=function(e,t){var n=!0,r=t.rowFrom(),a=t.colFrom(),o=t.rowCount(),i=t.colCount(),u=t.sheet();if(!u)return n;for(var s=u._dataModel,l=0;l<o;l++)for(var c=0;c<i;c++)if(0!==l||0!==c){var h=s.getImmutableContent(r+l,a+c);h&&null!=h.variant&&zf(h.variant)&&h.variant.formula===e?(h.variant.getOffsetRow()===l&&h.variant.getOffsetCol()===c||(h.variant.setOffset({row:l,col:c}),n=!1),h.variant.updateCacheValue()&&(n=!1)):(s.setVariant(r+l,a+c,new jf(e,l,c)),n=!1)}return n}(e,c);1===c.size()||g||(r.getCalcEngine().arrayFormulaExpand(c),r.dispatch("RangeChanged",{range:c,type:0}))}else 2===f&&1===v&&r.dispatch("RangeChanged",{range:c,type:0});e.setCurrentArrayRef(c),e.watchArrayRef(c)}else{if(function(e,t,n){if(t!==ut.CIRCULAR_DEPENDENCY_ERR_VAR)return!0;if(!n)return!1;var r=e.getRef();return!n.containCell(r.rowFrom(),r.colFrom())}(e,a,o)){if(null!=o){var m=o.colCount(),p=o.rowCount();(m>1||p>1)&&Hf(e,o)}e.setArrayCanExpand({arrayFormulaCanExpand:1})}e.setCurrentArrayRef(null)}}}}};var jf=function(e){function t(e){var n,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,a=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;return(0,y.Z)(this,t),(n=(0,d.Z)(this,(0,v.Z)(t).call(this))).formula=e,n.offsetRow=r,n.offsetCol=a,n.type=ut.VAR_TYPE.FORMULA,n.value=ut.NULL_VAR,n.value=n.getCalcVar(),n}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"getCalcVar",value:function(e){var t=this.formula.getState().cache,n=t?t.getRawVar():this.formula.getRawVar(e);return Au(n)?1===this.canArrayExpand().arrayFormulaCanExpand?n.getVarByPos(this.offsetRow,this.offsetCol):ut.NULL_VAR:n}},{key:"getArrayRef",value:function(){return this.formula.getArrayRef()}},{key:"canArrayExpand",value:function(){return this.formula.canArrayExpand()}},{key:"isFormula",value:function(){return!1}},{key:"hasCache",value:function(){return!!this.formula.getState().cache}},{key:"updateCacheValue",value:function(e){var t=this.getCalcVar(e),n=!t.equals(this.value);return this.value=t,n}},{key:"getValue",value:function(e){return this.value.getValue(e)}},{key:"getRawVar",value:function(e){return this.formula.getRawVar(e)}},{key:"getVar",value:function(e){return this.formula.isEmptyState()&&this.updateCacheValue(e),this.value}},{key:"isProxyArrayFormula",value:function(){return!0}},{key:"isSameFormula",value:function(e){return e instanceof Bf?this.formula===e:e instanceof t&&this.formula===e.formula}},{key:"isInRange",value:function(e,t){var n=this.getArrayRef();return e<=n.rowTo()&&e>=n.rowFrom()&&t<=n.colTo()&&t>=n.colFrom()}},{key:"isInCorrectPosition",value:function(e,t){var n=this.getArrayRef();return!!this.isInRange(e,t)&&e-n.rowFrom()===this.offsetRow&&t-n.colFrom()===this.offsetCol}},{key:"fixOffset",value:function(e,t){var n=this.getArrayRef();this.isInRange(e,t)&&this.setOffset({row:e-n.rowFrom(),col:t-n.colFrom()})}},{key:"setOffset",value:function(e){var t=!1;"number"==typeof e.col&&e.col>=0&&(this.offsetCol=e.col,t=!0),"number"==typeof e.row&&e.row>=0&&(this.offsetRow=e.row,t=!0),t&&this.updateCacheValue()}},{key:"getOffset",value:function(){return{row:this.offsetRow,col:this.offsetCol}}},{key:"getOffsetRow",value:function(){return this.offsetRow}},{key:"getOffsetCol",value:function(){return this.offsetCol}},{key:"serialize",value:function(){return null}}]),t}(ut.BaseVar);function zf(e){return e instanceof jf}!function(e){e[e.None=0]="None",e[e.Shrink=1]="Shrink",e[e.Cover=2]="Cover",e[e.Circle=3]="Circle",e[e.ImportRange=4]="ImportRange",e[e.LessThanTwo=5]="LessThanTwo",e[e.CoverSource=6]="CoverSource",e[e.SourceHasPivot=7]="SourceHasPivot",e[e.ServiceCalcLoading=8]="ServiceCalcLoading",e[e.UnSupportVersion=9]="UnSupportVersion",e[e.FormulaError=10]="FormulaError",e[e.Loading=11]="Loading"}(Zf||(Zf={})),function(e){e[e.rowGrandTotal=0]="rowGrandTotal",e[e.colGrandTotal=1]="colGrandTotal",e[e.rowSubtotal=2]="rowSubtotal",e[e.colSubtotal=3]="colSubtotal",e[e.rowLabel=4]="rowLabel",e[e.colLabel=5]="colLabel"}(Df||(Df={})),function(e){e.Loading="Loading",e.Loaded="Loaded"}(Pf||(Pf={}));function Gf(e){if(e){if(e.formatter)return{isAuto:!1,formatter:e.formatter};if(e.autoFormatter)return{isAuto:!0,formatter:e.autoFormatter}}return{formatter:null,isAuto:!1}}function Jf(e,t,n){if(n){var r=Gf(e).formatter;if(null!=t&&r instanceof Se.Formatter)return{value:t=r.getEditingText(t),formatter:r}}return{value:Se.GeneralFormatter.getEditingText(t)}}function qf(e,t,n){if(e===we.KqL.General){var r=bn._getType(t);e=n&&(0,Se.isTextFormatter)(n)?we.KqL.Left:"boolean"===r?we.KqL.Center:"number"===r||"date"===r?we.KqL.Right:we.KqL.Left}return e}function $f(e,t){var n;if(!t)return null;var r=!!Wa(t)&&(null===(n=e.getPivotTableManager().getPivotInfoByName(t.blockToken))||void 0===n?void 0:n.errorState)===Zf.FormulaError;if((t.isFormula()||zf(t)||r)&&t.getVar().isError()){var a=t.getVar();return!a.isError()||a.errorCode!==ut.SUSPENDED_ERR_VAR.errorCode&&a.errorCode!==ut.WAIT_ASYNC_ERR_VAR.errorCode?{suggestion:a,state:1}:null}return null}var Yf=new Map;function Kf(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},n=arguments.length>2&&void 0!==arguments[2]&&arguments[2];return e.fontSize===t.fontSize&&e.fontStyle===t.fontStyle&&e.fontWeight===t.fontWeight&&(!(!n||t.fontFamily&&(t.fontFamily,0))||e.fontFamily===t.fontFamily)}function Xf(e){var t=Yf.get(e);if(void 0!==t)return t;var n=wa._scaleFont(e,1);return n.fontFamily,delete n.fontFamily,Yf.set(e,n),n}var Qf,ed,td,nd=/pt/i;function rd(e){if(void 0!==e){if("number"==typeof e)return e;var t=parseFloat(e);return Number.isNaN(t)?void 0:nd.test(e)?Math.floor(96*t/72):Math.floor(t)}}function ad(e){return void 0===e?void 0:"number"==typeof e?e:"bold"===e?700:"normal"===e?400:parseInt(e,10)||400}function od(e){if(e)return e["font-weight"]||e["font-style"]||e["font-size"]?{fontStyle:e["font-style"]||e.fontStyle,fontSize:rd(e["font-size"]||e.fontSize),fontWeight:ad(e["font-weight"]||e.fontWeight)}:"string"==typeof e.fontSize||"string"==typeof e.fontWeight?{fontFamily:e.fontFamily,fontStyle:e.fontStyle,fontSize:rd(e.fontSize),fontWeight:ad(e.fontWeight)}:e}function id(e){var t={};if(void 0!==e._textDecoration){var n=e._textDecoration;0!=(n&we.aBM.lineThrough)?t.strikethrough="true":t.strikethrough="",0!=(n&we.aBM.underline)?t.underline="true":t.underline=""}var r=e.fontInfo;return r.fontWeight&&(700===r.fontWeight?t.bold="true":t.bold=""),r.fontStyle&&("italic"===r.fontStyle?t.italic="true":t.italic=""),r.fontSize&&(t.fontsize=r.fontSize+"px"),void 0!==e._foreColor&&(t.textcolor=e._foreColor),void 0!==r.fontFamily&&(t.fontfamily=r.fontFamily),t}function ud(e,t){if(!t)return e;var n=e,r=[Td[dd],Td[gd]],a=!1;return r.forEach((function(r){void 0===n[r]&&void 0!==t[r]&&(a||(n=e.clone(!0),a=!0),n[r]=t[r])})),n}function sd(e,t,n){var r=["fontStyle","fontWeight","fontSize"],a=["foreColor","textDecoration"],o=new Array(n.length);return n.forEach((function(n,i){var u=n.style;if(u){if(!(u instanceof Ad))throw new Error("The segmemnt style is not type of Style, did you pass SegementForChangeset to this?");var s=!1,l={};a.forEach((function(n){var r=e[n],a=t[n],o=u[n];o===r&&o!==a&&(l[n]=a,s=!0)}));var c={};r.forEach((function(n){var r,a,o,i=null===(r=e._font)||void 0===r?void 0:r[n],s=null===(a=t._font)||void 0===a?void 0:a[n],l=null===(o=u._font)||void 0===o?void 0:o[n];l===i&&l!==s&&(c[n]=s)})),(0,pe.default)(c,{})||(l.fontInfo=c,s=!0),s&&(o[i]=Ad.withUpdateStyle(u,l))}})),o}function ld(){return!!we.Ps3.getSheetFontDataCleanEnable&&!we.Ps3.getSheetFontDataCleanEnable()}!function(e){e[e.unset=0]="unset",e[e.none=1]="none",e[e.thin=2]="thin",e[e.medium=3]="medium",e[e.thick=4]="thick",e[e.dotted=5]="dotted",e[e.dashed=6]="dashed",e[e.double=7]="double",e[e.hair=8]="hair",e[e.dashDot=9]="dashDot",e[e.dashDotDot=10]="dashDotDot",e[e.slantDashDot=11]="slantDashDot",e[e.mediumDashed=12]="mediumDashed",e[e.mediumDashDot=13]="mediumDashDot",e[e.mediumDashDotDot=14]="mediumDashDotDot"}(Qf||(Qf={})),function(e){e[e.OVERFLOW=0]="OVERFLOW",e[e.AUTOWRAP=1]="AUTOWRAP",e[e.WORDCLIP=2]="WORDCLIP"}(ed||(ed={})),function(e){e.TOP="Top",e.RIGHT="Right",e.BOTTOM="Bottom",e.LEFT="Left"}(td||(td={}));var cd=["Top","Right","Bottom","Left"],hd=function(){function e(t,n,r){(0,y.Z)(this,e),this.color=t,this.width=n,(0,Ce.default)(r)||(this.lineStyle=r)}return(0,C.Z)(e,[{key:"_clone",value:function(){return new e(this.color,this.width,this.lineStyle)}},{key:"toJSON",value:function(){var e={},t=this.color,n=this.width,r=this.lineStyle;return e.color=t,e.width=n,(0,Ce.default)(r)||(e.lineStyle=r),e}},{key:"equals",value:function(e){return this===e||!!e&&this.color===e.color&&this.width===e.width&&this.lineStyle===e.lineStyle}}],[{key:"fromJSON",value:function(t){if(t)return new e(t.color,t.width,t.lineStyle)}}]),e}(),fd=function(){function e(t,n,r,a){(0,y.Z)(this,e),this.fontFamily=a,this.fontSize=t,this.fontStyle=n,this.fontWeight=r}return(0,C.Z)(e,[{key:"getHash",value:function(e){return xa([this.fontSize,this.fontStyle,this.fontWeight,this.fontFamily],e)}},{key:"equals",value:function(e){return this===e||!!e&&this.fontSize===e.fontSize&&this.fontStyle===e.fontStyle&&this.fontWeight===e.fontWeight&&this.fontFamily===e.fontFamily}},{key:"toFontString",value:function(){return this._cachedFontString||(this._cachedFontString=function(e,t){var n,r,a;a=400===e.fontWeight?"normal":700===e.fontWeight?"bold":(null===(n=e.fontWeight)||void 0===n?void 0:n.toString())||null;var o=null!==(r=e.fontFamily)&&void 0!==r?r:null;return t||(o=(0,we.M10)()),wa._buildFontString({fontFamily:o,fontWeight:a,fontSize:e.fontSize?"".concat(Ia(e.fontSize),"pt"):null,fontStyle:e.fontStyle||null,fontVariant:null,lineHeight:"1.5"},t)}(this)),this._cachedFontString}},{key:"getActual",value:function(){return{fontFamily:this.fontFamily||(0,we.M10)(),fontSize:this.fontSize||we.OvR,fontStyle:this.fontStyle||"normal",fontWeight:this.fontWeight||400}}},{key:"toJSON",value:function(){var e={};return this.fontFamily&&(e.fontFamily=this.fontFamily),this.fontSize&&(e.fontSize=this.fontSize),this.fontStyle&&(e.fontStyle=this.fontStyle),this.fontWeight&&(e.fontWeight=this.fontWeight),e}}],[{key:"getOrCreateStyleFont",value:function(t,n,r,a){var o,i=xa("".concat(t,"_").concat(n,"_").concat(r,"_").concat(a)),u=this.styleFontCache.get(i);return void 0===u&&(u=[],this.styleFontCache.set(i,u)),u.length>0&&(o=u.find((function(e){return e.fontSize===t&&e.fontStyle===n&&e.fontWeight===r&&e.fontFamily===a}))),void 0===o&&(o=new e(t,n,r,a),u.push(o)),o}},{key:"valueOf",value:function(e,t,n,r){var a,o;return"string"==typeof e?(o=(a=Xf(e)).fontSize,t=a.fontStyle,r=a.fontFamily,n=a.fontWeight):o=e,this.getOrCreateStyleFont(o,t,n,r)}},{key:"withUpdate",value:function(e,t){var n,r,a,o;return t=od(t),this.valueOf((null===(n=t)||void 0===n?void 0:n.fontSize)||(null==e?void 0:e.fontSize),(null===(r=t)||void 0===r?void 0:r.fontStyle)||(null==e?void 0:e.fontStyle),(null===(a=t)||void 0===a?void 0:a.fontWeight)||(null==e?void 0:e.fontWeight),(null===(o=t)||void 0===o?void 0:o.fontFamily)||(null==e?void 0:e.fontFamily))}},{key:"fromJSON",value:function(e){var t=(e=od(e)).fontFamily;return t&&(t=void 0),this.valueOf(e.fontSize,e.fontStyle,e.fontWeight,t)}}]),e}();fd.styleFontCache=new Map,fd.EMPTY=fd.valueOf();var dd="formatter",vd="fontInfo",gd="autoFormatter",md="borderLeft",pd="borderTop",yd="borderRight",Cd="borderBottom",_d="wordWrap",Rd="textDecoration",wd="dropdown",kd="diagonal",Sd="font",Ed={_vAlign:"vAlign",_hAlign:"hAlign",_textDecoration:Rd,_foreColor:"foreColor",_font:vd,_borderLeft:md,_borderTop:pd,_borderRight:yd,_borderBottom:Cd,_wordWrap:_d,_backColor:"backColor",_hideLink:"hideLink",_dropdown:wd,_formatter:dd,_autoFormatter:gd,_diagonal:kd,_diagonalUp:"diagonalUp",_diagonalDown:"diagonalDown",_textRotation:"textRotation"},Td=(0,me.Z)(Ed),Ad=function(){function e(){(0,y.Z)(this,e)}return(0,C.Z)(e,[{key:"clone",value:function(t){var n=new e;for(var r in Ed){var a=this[r];void 0!==a&&(n[r]=!t&&(null==a?void 0:a._clone)instanceof Function&&a._clone()||a)}return n._default=this._default,n}},{key:"getHash",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,t=e;for(var n in Ed){var r=this[n];switch(Ed[n]){case dd:case gd:t=r?xa(r.getFormatCode(),t):t;break;case wd:case vd:t=r?xa(r.getHash(),t):t;break;default:t=xa(r,t)}}return t}},{key:"equals",value:function(e){var t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];if(!e)return!1;if(this===e)return!0;for(var n in Ed){var r=this[n],a=e[n];if(t||Ed[n]!==Rd){if(r&&r.equals){if(null==a||!r.equals(a))return!1}else if(!(0,pe.default)(r,a))return!1}else if(!this._textDecorationLooseEquals(r,a))return!1}return!0}},{key:"_textDecorationLooseEquals",value:function(e,t){return e===t||void 0===e&&0===t||0===e&&void 0===t}},{key:"toJSON",value:function(){var e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];if(!0===e||!this.equals(this._default)){var t={};if(this._formatter instanceof Se.Formatter){var n,r=null!==(n=this._formatter.toJSON())&&void 0!==n?n:{formatCached:"General"};t[dd]=r}for(var a in this._font&&(ld()?t[Sd]=this._font.toFontString():t[vd]=this._font.toJSON()),Ed){var o=Ed[a];if(o!==dd&&o!==vd){var i=this[a];void 0!==i&&(t[o]=i&&i.toJSON instanceof Function?i.toJSON():i)}}return 0!==Object.keys(t).length?t:void 0}}},{key:"setDefault",value:function(e){this._default=e}},{key:"isDefault",value:function(){return this.equals(this._default||Md())}},{key:"toFasterHAlign",value:function(e){return this._hAlign===we.KqL.General?e.getValue()instanceof Array?we.KqL.Left:qf(this.hAlign,e.getValue(),this.formatter):this._hAlign}},{key:"_updateFromJSON",value:function(e,t){if(e){var n=function(e,t){return t?fd.fromJSON(t):e?fd.valueOf(e):null}(e[Sd],e[vd]);for(var r in n&&(this._font=n),Ed){var a=Ed[r],o=e[a];if(void 0!==o)switch(a){case dd:if(!t)throw new Error("Unexpected behaviour, trying to update formatter without formatter service");this[r]=bd(t,o);break;case gd:if(!t)throw new Error("Unexpected behaviour, trying to update formatter without formatter service");var i=bd(t,o);this._setAutoFormatter(i);break;case kd:case md:case pd:case yd:case Cd:this[r]=hd.fromJSON(o);break;case wd:break;case _d:this[r]=Id(o);break;case vd:break;default:this[r]=null!==o?o:void 0}}}}},{key:"_setAutoFormatter",value:function(e){var t;null!==(t=e)&&void 0!==t&&t.toJSON()||(e=void 0),this._autoFormatter=e}},{key:"vAlign",get:function(){return this._vAlign}},{key:"hAlign",get:function(){return this._hAlign}},{key:"textDecoration",get:function(){return this._textDecoration}},{key:"foreColor",get:function(){return this._foreColor}},{key:"backColor",get:function(){return this._backColor}},{key:"borderLeft",get:function(){return this._borderLeft}},{key:"borderTop",get:function(){return this._borderTop}},{key:"borderRight",get:function(){return this._borderRight}},{key:"borderBottom",get:function(){return this._borderBottom}},{key:"diagonal",get:function(){return this._diagonal}},{key:"diagonalUp",get:function(){return this._diagonalUp}},{key:"diagonalDown",get:function(){return this._diagonalDown}},{key:"textRotation",get:function(){return this._textRotation}},{key:"wordWrap",get:function(){return this._wordWrap}},{key:"fontInfo",get:function(){var e;return(null===(e=this._font)||void 0===e?void 0:e.getActual())||{}}},{key:"rawFont",get:function(){return this._font}},{key:"fontSizePx",get:function(){var e;return null===(e=this._font)||void 0===e?void 0:e.fontSize}},{key:"hideLink",get:function(){return!0===this._hideLink}},{key:"dropdown",get:function(){return this._dropdown}},{key:"formatter",get:function(){return this._formatter}},{key:"autoFormatter",get:function(){return this._autoFormatter}},{key:"locked",get:function(){}}],[{key:"withUpdateStyle",value:function(e,t,n){if(!t||(0,pe.default)(t,{}))return e;var r=t.fontInfo,a=t.textDecoration,o=(0,s.Z)(t,vn),i=e.clone();if(r&&(i._font=fd.withUpdate(i._font,r),delete o.font),a&&!(0,ge.default)(a)){var u=e._textDecoration;o.textDecoration=wa._updateTextDecoration(u,a)}else"textDecoration"in t&&(o.textDecoration=a);return i._updateFromJSON(o,n),i}},{key:"withDropdown",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]&&arguments[2];if((0,pe.default)(e._dropdown,t))return e;var r=e.clone();return(n||t)&&(r._dropdown=null==t?void 0:t.clone()),r}},{key:"delBorder",value:function(e,t){var n=e.clone();if("borderLeft"===t)n._borderLeft=void 0;else if("borderRight"===t)n._borderRight=void 0;else if("borderTop"===t)n._borderTop=void 0;else{if("borderBottom"!==t)throw new Error("Unreachable Code");n._borderBottom=void 0}return n}},{key:"withBorders",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]&&arguments[2],r=arguments.length>3?arguments[3]:void 0,a=t.borderLeft,o=t.borderRight,i=t.borderBottom,u=t.borderTop,s=t.diagonal,l=t.diagonalUp,c=t.diagonalDown,h=e.clone(),f=function(e,t){(t||n)&&(h[e]=t)};return f("_borderLeft",a),f("_borderBottom",i),f("_borderRight",o),f("_borderTop",u),r&&["noborder","diagonalup","diagonaldown"].includes(r)&&(f("_diagonal",s),f("_diagonalUp",l),f("_diagonalDown",c)),h}},{key:"withAutoFormatter",value:function(e,t){var n;if(null!==(n=t)&&void 0!==n&&n.toJSON()||(t=void 0),(0,pe.default)(e.autoFormatter,t))return e;var r=e.clone();return r._autoFormatter=t,r}},{key:"withFormatter",value:function(e,t){if((0,pe.default)(e.formatter,t))return e;var n=e.clone();return n._formatter=t||void 0,n}},{key:"newStyle",value:function(e,t,n){return!e||(0,pe.default)(e,{})?(null==t?void 0:t.clone())||Md().clone():this.withUpdateStyle(t||Md(),e,n)}},{key:"newStyleWithoutDefault",value:function(t,n,r){return this.withUpdateStyle(n||new e,t,r)}},{key:"fromJSON",value:function(t,n,r){if(!n)return(null==r?void 0:r.clone())||new e;var a=(null==r?void 0:r.clone())||new e;return a._updateFromJSON(n,t),a}},{key:"extractCommonStyle",value:function(e){if(!e||e.length<=0)return{commonStyle:void 0,hasDifference:!1};var t,n=!1,r=e[0],a=Object.assign.apply(Object,[{}].concat((0,m.Z)(this.possibleCommonProperties.map((function(e){return(0,l.Z)({},e,r[e])})))));r._font&&(t=Object.assign.apply(Object,[{}].concat((0,m.Z)(this.possibleFontProperties.map((function(e){var t;return(0,l.Z)({},e,null===(t=r._font)||void 0===t?void 0:t[e])}))))));for(var o=1;o<e.length;o++){var i,u=e[o],s=_n(this.possibleCommonProperties);try{for(s.s();!(i=s.n()).done;){var c=i.value;if(a.hasOwnProperty(c)){var h=a[c],f=u[c];h===f||"object"==(0,_.Z)(h)&&h.equals instanceof Function&&h.equals(f)||(delete a[c],n=!0)}}}catch(e){s.e(e)}finally{s.f()}if(t){var d,v=_n(this.possibleFontProperties);try{for(v.s();!(d=v.n()).done;){var g,p=d.value;if(t.hasOwnProperty(p))t[p]!==(null===(g=u._font)||void 0===g?void 0:g[p])&&(delete t[p],n=!0)}}catch(e){v.e(e)}finally{v.f()}}}return"{}"===JSON.stringify(t)&&(t=void 0),t||"{}"!==JSON.stringify(a)?{commonStyle:{fontInfo:t,foreColor:a._foreColor,backColor:a._backColor,textDecoration:a._textDecoration},hasDifference:n}:{commonStyle:void 0,hasDifference:n}}},{key:"composeStyles",value:function(e){for(var t,n=arguments.length,r=new Array(n>1?n-1:0),a=1;a<n;a++)r[a-1]=arguments[a];if(void 0===r||r.length<=0)return e;var o=function(e,t){for(var n in Ed){var r=t[n];Ed[n]!==vd?void 0===e[n]&&(r&&r._clone instanceof Function?e[n]=r._clone()||r:e[n]=r):e[n]=fd.withUpdate(r,e[n])}e._default||(e._default=t._default)},i=null===(t=r[0])||void 0===t?void 0:t.clone();if(i){for(var u=1;u<r.length;u++)r[u]&&o(i,r[u]);return e&&o(i,e),i}return e}}]),e}();function Id(e){return!1===e?0:!0===e?1:"object"==(0,_.Z)(e)?null!=e&&e.wrap?Id(e.wrap):0:e}function bd(e,t){return"string"==typeof t?""===t?(0,Se.createFormatter)(e):(0,Se.createFormatter)(e,t):t instanceof Se.Formatter?t:null!==t&&"object"==(0,_.Z)(t)?Se.Formatter.fromJSON(e,t):void 0}Ad.EMPTY=new Ad,Ad.possibleCommonProperties=["_foreColor","_backColor","_textDecoration"],Ad.possibleFontProperties=["fontSize","fontStyle","fontWeight"];var Fd=null;function Md(){if(Fd)return Fd;var e=new Ad;return e._font=fd.valueOf(we.OvR,"normal",400),e._vAlign=we.g$I.Bottom,e._hAlign=we.KqL.General,e._wordWrap=0,e.setDefault(e),Object.freeze(e),Fd=e}function Vd(e){return void 0!==e}function Nd(e){return document.createElement(e)}function Od(e,t,n,r){var a=function(a,o){this.hasOwnProperty("_ps")||(this._ps={});var i=this._ps;if(0===arguments.length)return void 0!==i[e]?i[e]:t;if(!1===o||!r||r.call(this,a)){var u=void 0!==i[e]?i[e]:t;u!==a&&(i[e]=a,!1!==o&&n&&n.call(this,a,u))}return this};return a.isDefault=function(e){return e===t},a}function xd(e,t){var n={_ps:{}};return bn._each(e,(function(e){!function(e,t,n){Object.defineProperty(e,t,{get:function(){return this._ps[t]},set:function(e){var r=this._ps[t];r!==e&&(this._ps[t]=e,n&&n(t,e,r))},enumerable:!0})}(n,e,t)})),n}var Zd=function(){};Zd._getColor=function(e,t){if(e&&t){var n=e._currentTheme;if(n)return n.getColor(t)}return t},Zd._getFont=function(e,t){if(e&&t){var n=e._currentTheme;return n?n.getFont(t):t}return null};var Dd="worksheet/sheetDataModel",Pd="worksheet",Ld="worksheet/watchedRefHub",Bd="worksheet/getService",Ud="worksheet/I18N",Hd="workbook/calcEngine",Wd="worksheet/stageTracker",jd=Symbol("SheetDep/Moirae"),zd=function(){function e(t){(0,y.Z)(this,e),this.sheet=t}return(0,C.Z)(e,[{key:"getFormatCode",value:function(e,t){return this.sheet.getFormatCode(e,t)}},{key:"getActualFormatter",value:function(e,t){return this.sheet.getActualFormatter(e,t)}},{key:"getInternationalText",value:function(e,t){return this.sheet.getInternationalText(e,t)}},{key:"getValue",value:function(e,t){return this.sheet.getValue(e,t)}},{key:"getValueWithStringFormatter",value:function(e,t){var n=this.sheet.getActualFormatter(e,t),r=this.getValue(e,t);return null!=n&&n.getFormatters().find((function(e){return"@"===e.getFormatCode()}))?"".concat(r):r}},{key:"getText",value:function(e,t){return this.sheet.getText(e,t)}},{key:"getStyle",value:function(e,t){return this.sheet.getStyleWithConditionalFormat(e,t)}},{key:"getSpan",value:function(e,t){return this.sheet.getSpan(e,t)}},{key:"getSegmentArray",value:function(e,t){return this.sheet.getSegmentArray(e,t)}},{key:"getCellFormatter",value:function(e,t){return this.sheet.getCellFormatter(e,t)}}]),e}();zd=Gi([(0,ct.b)(),Ji(0,(0,ht.f)(Pd))],zd);var Gd=function(){function e(){(0,y.Z)(this,e)}return(0,C.Z)(e,[{key:"getSelections",value:function(){var e;return(e=this.sheet).getSelections.apply(e,arguments)}},{key:"setSelection",value:function(){var e;return(e=this.sheet).setSelection.apply(e,arguments)}},{key:"getResponsableFilterRange",value:function(){var e=this.getSelections()[0];if(e){var t,n=this.sheet.getColumnCount(),r=this.sheet.getRowCount(),a=e.rowFrom(),o=e.colFrom(),i=e.rowCount(),u=e.colCount(),s=!1,l=!1,c=!1,h=!1;return 1===i&&u===n?new Oi(a,0,r-a,n,this.sheet):(1===i&&1===u||null!==(t=this.sheet.getSpan(a,o))&&void 0!==t&&t.equal(e)?(s=!0,l=!0,c=!0,h=!0):1===i&&u>1&&(l=!0),this.getResponsableRange(e,{up:s,down:l,left:c,right:h},{isExcludePivotTable:!0}))}return e}},{key:"getResponsableRange",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{up:!0,down:!0,left:!0,right:!0},n=arguments.length>2?arguments[2]:void 0;this.stageTracker(we.FHD.GET_RESPONSABLE_RANGE,0);for(var r=this.sheet.getRowCount(),a=this.sheet.getColumnCount(),o=e.clone(),i=new Map,u=this.getCellsInSpan(this.sheet.getSpans()),s=!0;s;)s=!1,t.left&&(s=s||this.expandLeft(o,u,i,n)),t.up&&(s=s||this.expandUp(o,u,i,n)),t.right&&(s=s||this.expandRight(o,u,i,a,n)),t.down&&(s=s||this.expandDown(o,u,i,r,n));return this.stageTracker(we.FHD.GET_RESPONSABLE_RANGE,1,{row:o.rowFrom(),col:o.colFrom(),row_count:o.rowCount(),col_count:o.colCount(),cell_count:o.rowCount()*o.colCount()}),o}},{key:"getCellsInSpan",value:function(e){var t=this,n={};return e.forEach((function(e){for(var r=e.rowFrom(),a=e.colFrom(),o=e.rowCount(),i=e.colCount(),u=t.sheetFacade.getValue(r,a),s=r+o,l=a+i,c=r;c<s;c++)for(var h=a;h<l;h++)n[c]||(n[c]={}),n[c][h]={span:e,value:u}})),n}},{key:"expandRight",value:function(e,t,n,r,a){var o=e.colFrom()+e.colCount();return!(o>=r||!this.hasValueInRowOrCol(t,{rowOrCol:"row",position:o},e.rowFrom(),e.rowFrom()+e.rowCount(),n,a)||(e.setColCount(e.colCount()+1),0))}},{key:"expandDown",value:function(e,t,n,r,a,o){var i=e.rowFrom()+e.rowCount();return!(i>=r)&&(o&&this.sheet._isRowFilterOut(i)||!!this.hasValueInRowOrCol(t,{rowOrCol:"col",position:i},e.colFrom(),e.colFrom()+e.colCount(),n,a))&&(e.setRowCount(e.rowCount()+1),!0)}},{key:"expandUp",value:function(e,t,n,r){var a=e.rowFrom()-1;return!(a<0||!this.hasValueInRowOrCol(t,{rowOrCol:"col",position:a},e.colFrom(),e.colFrom()+e.colCount(),n,r)||(e.setRowFrom(a),e.setRowCount(e.rowCount()+1),0))}},{key:"expandLeft",value:function(e,t,n,r){var a=e.colFrom()-1;return!(a<0||!this.hasValueInRowOrCol(t,{rowOrCol:"row",position:a},e.rowFrom(),e.rowFrom()+e.rowCount(),n,r)||(e.setColFrom(a),e.setColCount(e.colCount()+1),0))}},{key:"hasValueInRowOrCol",value:function(e,t,n,r,a,o){for(var i="col"===t.rowOrCol?"row-".concat(t.position):"col-".concat(t.position),u=a.get(i),s=n;s<r;)if(u&&s>=u.start&&s<u.end)s=u.end;else{if("col"===t.rowOrCol&&this.hasValue(e,t.position,s,o))return!0;if("row"===t.rowOrCol&&this.hasValue(e,s,t.position,o))return!0;s++}return a.set(i,{start:n,end:r}),!1}},{key:"cellhasVisibleStyle",value:function(e,t){var n=this.sheet.getImmutableStyle(e,t),r=n.backColor,a=n.borderBottom,o=n.borderLeft,i=n.borderRight,u=n.borderTop,s=n.diagonal,l=n.diagonalUp,c=n.diagonalDown;return!!(r||a||o||i||u||s&&(l||c))}},{key:"cellHasValue",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]&&arguments[2],r=this.sheetFacade.getSegmentArray(e,t)||this.sheetFacade.getValue(e,t);return n?null!==r&&("string"!=typeof r||""!==r.trim()):""!==r&&null!==r}},{key:"hasValue",value:function(e,t,n,r){var a=this,o=r||{isIncludeStyle:!1,trimValue:!1,isExcludePivotTable:!1,isIncludeDropdown:!1,isIncludeEmptySpan:!1,isIncludeSparkline:!1,isIncludeFormula:!1},i=o.isIncludeStyle,u=o.isIncludeEmptySpan,s=o.trimValue,l=o.isExcludePivotTable,c=o.isIncludeDropdown,h=o.isIncludeSparkline,f=o.isIncludeFormula,d=this.sheet.getPivotTableManager();if(l&&d.hasPivotTableAtCell(t,n))return!1;return(function(e,t,n){return Boolean(e[t]&&e[t][n])}(e,t,n)?u||function(e,t,n){var r=arguments.length>3&&void 0!==arguments[3]&&arguments[3],a=e[t]&&e[t][n]?e[t][n].value:null;return r?null!==a&&("string"!=typeof a||""!==a.trim()):""!==a&&null!==a}(e,t,n,s):a.cellHasValue(t,n,s))||i&&a.cellhasVisibleStyle(t,n)||c&&a.sheet.dataValidationService.hasDropdown(t,n)||h&&a.sheet.getSparklineByCell(t,n)||f&&a.sheet.hasFormula(t,n)}}]),e}();Gi([(0,ht.f)(Pd)],Gd.prototype,"sheet",void 0),Gi([(0,ht.f)(zd)],Gd.prototype,"sheetFacade",void 0),Gi([(0,ht.f)(Wd)],Gd.prototype,"stageTracker",void 0),Gd=Gi([(0,ct.b)()],Gd);var Jd=function(e,t){try{if(!e)return!1;var n=e.colFrom(),r=e.colCount();if(!t)return{rowFrom:e.rowFrom()+1,colFrom:n,rowCount:e.rowCount()-1,colCount:r};var a=t.colFrom(),o=t.colCount();return!(n<=a&&r>=o)&&{rowFrom:t.rowFrom()+1,colFrom:a,rowCount:t.rowCount()-1,colCount:o}}catch(e){return!1}};function qd(e,t){return-1===e||-1===t?-1:e>t?e:t}function $d(e,t){return e<t?e:t}var Yd=-1;function Kd(e,t){if(e&&t){var n=$d(e.row,t.row),r=qd(e.row_end,t.row_end),a=$d(e.col,t.col),o=qd(e.col_end,t.col_end);return{row:n,col:a,row_end:r,col_end:o,row_count:-1===r?-1:r-n+1,col_count:-1===o?-1:o-a+1}}return e||t}function Xd(e){if(!e)throw Error("formatToRange:Target Cannot Be NULL");var t=Object.assign({row:0,row_count:Yd,row_end:Yd,col:0,col_count:Yd,col_end:Yd},e);return function(e){var t=e.row,n=e.col,r=e.row_count,a=e.col_count;return null!=t&&null!=r&&(null==n||0===n)&&null==a}(e)?(t.row_end=e.row+e.row_count-1,t.col=0,t.col_count=Yd,t.col_end=Yd):function(e){var t=e.row,n=e.col,r=e.row_count,a=e.col_count;return(null==t||0===t)&&null==r&&null!=n&&null!=a}(e)?(t.col_end=e.col+e.col_count-1,t.row=0,t.row_count=Yd,t.row_end=Yd):(function(e){var t=e.row,n=e.col,r=e.row_count,a=e.col_count;return null!=t&&null!=n&&null!=r&&0!==r&&null!=a&&0!==a}(e)?(t.row_count=e.row_count,t.col_count=e.col_count):(t.row_count=1,t.col_count=1),t.row_end=e.row+t.row_count-1,t.col_end=e.col+t.col_count-1),t}function Qd(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{up:!0,down:!0,left:!0,right:!0},r=arguments.length>3?arguments[3]:void 0;return e.inject(Gd).getResponsableRange(t,n,r)}function ev(e){return e.inject(Gd).getResponsableFilterRange()}var tv=function(e){function t(e){var n,r=arguments.length>1&&void 0!==arguments[1]&&arguments[1];return(0,y.Z)(this,t),(n=(0,d.Z)(this,(0,v.Z)(t).call(this)))._info=e,n._isReverse=r,n._isReverse?n._count=n._info.count+1:n._count=-1,n}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"next",value:function(){return this._isReverse?this.reverseNext():this.normalNext()}},{key:"normalNext",value:function(){return this._count++,this._count<0||this._count>=this._info.count?null:this._info.index+this._count}},{key:"reverseNext",value:function(){return this._count--,this._count<=0||this._count>this._info.count?null:this._info.index+this._count-this._info.count}}]),t}(Rt.FIterator);function nv(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},n={RETURN_DOM_FRAGMENT:!1,RETURN_DOM:!1};return it().sanitize(e,Object.assign({},t,{},n))}var rv=Math.floor;function av(e,t){return t+e*Ka}function ov(e){return{row:rv(e/Ka),col:e%Ka}}function iv(e,t){return"".concat(e,",").concat(t)}var uv,sv=function(){function e(){(0,y.Z)(this,e),this._set=new Set}return(0,C.Z)(e,[{key:"clear",value:function(){return this._set.clear()}},{key:"delete",value:function(e,t){return this._set.delete(av(e,t))}},{key:"forEach",value:function(e){var t=this;this._set.forEach((function(n){var r=ov(n);e(r.row,r.col,t)}))}},{key:"has",value:function(e,t){return this._set.has(av(e,t))}},{key:"add",value:function(e,t){return this._set.add(av(e,t)),this}},{key:"size",get:function(){return this._set.size}}]),e}(),lv=function(){function e(){(0,y.Z)(this,e),this._map=new Map}return(0,C.Z)(e,[{key:"clear",value:function(){return this._map.clear()}},{key:"delete",value:function(e,t){if(0!==this._map.size)return this._map.delete(av(e,t))}},{key:"forEach",value:function(e){var t=this;this._map.forEach((function(n,r){var a=ov(r);e(n,a.row,a.col,t)}))}},{key:"has",value:function(e,t){return 0!==this._map.size&&this._map.has(av(e,t))}},{key:"set",value:function(e,t,n){return this._map.set(av(e,t),n),this}},{key:"get",value:function(e,t){return this._map.get(av(e,t))}},{key:"size",get:function(){return this._map.size}}]),e}();!function(e){e[e.Equal=0]="Equal",e[e.GreaterThan=1]="GreaterThan",e[e.LessThan=-1]="LessThan"}(uv||(uv={}));var cv=vr._Types._isNullOrUndefined;function hv(e,t,n,r,a){return e===t?0:"string"===r&&"string"===a?function(e,t,n){var r=(0,we.$1K)().compare(e.toLowerCase(),t.toLowerCase());return 0===r?0:r>0?n?1:-1:n?-1:1}(e,t,n):function(e,t,n,r){var a="number"===r,o="string"===n,i="string"===r;return n===r||"number"!==n&&!a?!("boolean"!==n||!i)||(!o||"boolean"!==r)&&(o&&i?1===(0,we.$1K)().compare(e.toLowerCase(),t.toLowerCase()):e>t):a}(e,t,r,a)?n?1:-1:n?-1:1}function fv(e,t,n){var r=0,a=(0,_.Z)(e),o=(0,_.Z)(t),i=cv(e)||"number"===a&&isNaN(e),u=cv(t)||"number"===o&&isNaN(t);return i||u?i&&u?r=0:i&&!u?r=1:!i&&u&&(r=-1):r=hv(e,t,n,a,o),r}function dv(e){return e instanceof Date&&(e=e.getTime()),e}function vv(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:function(e){return[e]},r=arguments.length>3?arguments[3]:void 0,a=arguments.length>4?arguments[4]:void 0,o=function(e){return a&&"function"==typeof a?a(e):e.sort((function(e,t){return fv(n(e)[0],n(t)[0],!0)}))},i=[];if(t.length){var u=function(){var a,u=t.join(" "),s=[function(e){return e.toLowerCase()===u.toLowerCase()},function(e){return e.toLowerCase().includes(u.toLowerCase())},function(e){var n=e.toLowerCase().split(/\s+/);return t.some((function(e){return n.includes(e.toLowerCase())}))},function(e){return t.some((function(t){return e.toLowerCase().includes(t.toLowerCase())}))}],l=[],c=u.split(/\s+/).map((function(e){return Number(e)})).filter((function(e){return!isNaN(e)})),h=_n(e);try{var f=function(){var e=a.value,t=n(e),o=Array.isArray(t)?t:[t];!function(){var t,n=_n(new Set(o));try{for(n.s();!(t=n.n()).done;){var a=t.value;if("number"==typeof a&&c.includes(a))return l[0]=l[0]||[],void l[0].push(e);for(var u=0,h=s.length;u<h;u++)if(s[u](String(a)))return l[u]=l[u]||[],void l[u].push(e);if(null!=r&&r(e))return void i.push(e)}}catch(e){n.e(e)}finally{n.f()}}()};for(h.s();!(a=h.n()).done;)f()}catch(e){h.e(e)}finally{h.f()}return{v:l.flatMap((function(e){return o(e)})).concat(i)}}();if("object"===(0,_.Z)(u))return u.v}return o(e)}var gv,mv=function(){function e(t){(0,y.Z)(this,e),this.value=t}return(0,C.Z)(e,[{key:"rowCount",value:function(){return this.value.length}},{key:"colCount",value:function(){return this.value.length>0?this.value[0].length:0}},{key:"size",value:function(){return this.rowCount()*this.colCount()}}]),e}();!function(e){e[e.setSelection=0]="setSelection",e[e.addSelection=1]="addSelection",e[e.setActiveCell=2]="setActiveCell",e[e.clearSelection=3]="clearSelection",e[e.expandSelectedRange=4]="expandSelectedRange"}(gv||(gv={}));var pv=function(){function e(){(0,y.Z)(this,e),this.hooks=new Map}return(0,C.Z)(e,[{key:"setHook",value:function(e,t){for(var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,r=this.hooks.get(e)||[],a=r.length,o=r.length-1;o>=0&&n>r[o][1];o--)a=o;r.splice(a,0,[t,n]),this.hooks.set(e,r)}},{key:"getHooks",value:function(e){var t=this.hooks.get(e);return t?t.map((function(e){return e[0]})):[]}},{key:"removeHook",value:function(e,t){var n=this.hooks.get(e);if(n){for(var r=-1,a=n.length-1;a>=0;a--)if(t===n[a][0]){r=a;break}-1!==r&&n.splice(r,1)}}}]),e}(),yv=["=","+"];function Cv(e){return(e=e.trim()).length>1&&yv.some((function(t){return e.startsWith(t)}))}var _v=la,Rv=document,wv=parseInt,kv=isNaN;var Sv={_cancelDefault:function(e){return e.preventDefault?(e.preventDefault(),e.stopPropagation()):(e.cancelBubble=!1,e.returnValue=!1),!1},_getRelativeOffset:function(e,t){var n=0,r=0;if(e!==t){var a=_v(e).offset(),o=_v(t).offset();n=a.left-o.left,r=a.top-o.top}return{_top:r,_left:n}},_defProperty:Od,_isDefined:Vd,_parseText2Value:ha};Sv._isStringNumber=ca,Sv._parseText2Value=ha,Sv._getValueAndStyleFromEditing=function(e,t,n,r,a,o){var i=e.getActualStyle(t,n);"string"==typeof r&&!o&&e.getReminder(t,n)&&(i=i.formatter?Ad.withFormatter(i,e.getReminderFormatter(t,n)):Ad.withAutoFormatter(i,(0,Se.getPreferredFormatter)(e.formatterService,r).formatter));var u=Sv._parseText2Value(e.formatterService,i,r,a),s=u&&u.autoFormatter,l=u&&u.value,c=e.getStyleWithDropdown(t,n)||e.getDefaultStyle();return{value:l,styleWithDropdown:c=Ad.withAutoFormatter(c,s)}},Sv._getPreferredZIndex=function(e){for(var t=Rv.body,n=e;n&&n.parentElement&&n.parentElement!==t;)n=n.parentElement;var r,a=1e3;return n&&n.parentElement===t&&(r=wv(_v(n).css("z-index")),kv(r)||(a+=r)),a},Sv._createElement=Nd,Sv._createOptions=xd;var Ev=function(){function e(t,n,r,a){(0,y.Z)(this,e),this.list=t,this.isValid=n,this.isEnableOptionColor=r,this.color=a}return(0,C.Z)(e,[{key:"toJSON",value:function(){var e={};return null!=this.list&&(e.list=this.list.slice(0)),void 0!==this.isValid&&(e.isValid=this.isValid),void 0!==this.isEnableOptionColor&&(e.isEnableOptionColor=this.isEnableOptionColor),null!=this.color&&(e.color=this.color.slice(0)),e}},{key:"clone",value:function(){return new e(this.list&&this.list.slice(),this.isValid,this.isEnableOptionColor,this.color&&this.color.slice())}},{key:"setValid",value:function(t){return this.isValid===t?this:new e(this.list,t,this.isEnableOptionColor,this.color)}},{key:"equals",value:function(e){return!!e&&(this===e||this.isValid===e.isValid&&this.isEnableOptionColor===e.isEnableOptionColor&&this.arrayEqual(this.list,e.list)&&this.arrayEqual(this.color,e.color))}},{key:"isSameDropdown",value:function(e){return!!e&&(this===e||this.isEnableOptionColor===e.isEnableOptionColor&&this.arrayEqual(this.list,e.list)&&this.arrayEqual(this.color,e.color))}},{key:"getHash",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;return void 0===this._hash&&(this._hash=[this.isValid,this.isEnableOptionColor,this.list,this.color].reduce((function(e,t){return xa(t,e)}),e)),this._hash}},{key:"arrayEqual",value:function(e,t){var n=void 0===e?-1:e.length;if(n!==(void 0===t?-1:t.length))return!1;for(var r=0;r<n;r++)if(e[r]!==t[r])return!1;return!0}}],[{key:"fromJSON",value:function(t){return new e(t.list,t.isValid,t.isEnableOptionColor,t.color)}}]),e}();function Tv(e){return new Promise((function(t){var n=new Image;n.crossOrigin="use-credentials",n.onload=function(){var r=n.width,a=n.height;t([e,{width:r,height:a}])},n.onerror=function(){t([e,{width:0,height:0}])},n.src=e}))}function Av(e){return e.sheets.some((function(e){var t=e.toJSON();if(t.image){for(var n in t.image)if(t.image[n].fileToken)return!0;return!1}return!1}))}function Iv(e,t,n){return bv(e,t,n)||Fv(e,t,n)}function bv(e,t,n){return Vv(e.getSegmentArray(t,n))}function Fv(e,t,n){return Mv(e.getVar(t,n))}function Mv(e){var t,n,r;if(!(null!=e&&null!==(t=e.isFormula)&&void 0!==t&&t.call(e)||null!=e&&null!==(n=e.isProxyArrayFormula)&&void 0!==n&&n.call(e)))return!1;var a=null==e||null===(r=e.getVar)||void 0===r?void 0:r.call(e);return a&&Lc(a)||!1}function Vv(e){var t;return Array.isArray(e)&&1===e.length&&(null===(t=e[0])||void 0===t?void 0:t.type)===we.K6s.EMBED_IMAGE}function Nv(e,t){var n;return(n="en"===t&&e.en_name||e.name)?"@"+n:e.text}function Ov(e,t){return e.type===we.K6s.TEXT?e.text=(0,we.ATv)(e.text):function(e){return Vv([e])}(e)&&(e.link=we.Ps3.replaceImageDataSrc(e.link)),Zv(e)?Nv(e,t):e.text||""}var xv=function(){function e(t,n){(0,y.Z)(this,e),this.spread=t,this.segmentArray=[],this.segmentArray=e.convertSegmentArrayFromChangeset(this.spread,n)}return(0,C.Z)(e,[{key:"getSegmentArray",value:function(){return this.segmentArray}},{key:"getText",value:function(e){return this.segmentArray.reduce((function(t,n){return Zv(n)?t+Ov(n,e):t+n.text}),"")}},{key:"getVar",value:function(e){var t="",n=0,r=!1,a=null;if(1===this.segmentArray.length&&this.segmentArray[0].type===we.K6s.EMBED_IMAGE)return new Pc(new Dc(this.segmentArray[0]));for(var o=0;o<this.segmentArray.length;++o){var i,u=this.segmentArray[o],s=Zv(u)?Ov(u,e):u.text;void 0!==s&&(t+=s,u.type===we.K6s.MENTION||u.type===we.K6s.URL?(n++,a=u.type===we.K6s.URL?null!==(i=u.link)&&void 0!==i?i:u.text:u.link):s.trim().length>0&&(r=!0))}var l=new ut.StringVar(t);if(r||null==a||1!==n)return l;try{a=decodeURIComponent(a)}catch(e){}return l.setSpecialInfo({link:a}),l}},{key:"clone",value:function(){return new e(this.spread,(0,m.Z)(this.segmentArray))}}],[{key:"convertSegmentArrayFromChangeset",value:function(e,t){var n=this;return t.map((function(t){var r=Object.assign({},t);if(t.style&&!(t.style instanceof Ad)){var a=Ad.fromJSON(e.formatterService,t.style);a?r.style=a:delete r.style}if(t.texts){var o=n.convertSegmentArrayFromChangeset(e,t.texts);o.length?r.texts=o:delete r.texts}return r}))}},{key:"getSegmentArray4Changeset",value:function(e){var t=this;return Array.isArray(e)?e.map((function(e){var n=Object.assign({},e);if(e.style&&e.style.toJSON){var r=e.style.toJSON();r?n.style=r:delete n.style}if(e.texts){var a=t.getSegmentArray4Changeset(e.texts);a.length?n.texts=a:delete n.texts}return n})):e}}]),e}();function Zv(e){return e.type===we.K6s.MENTION&&0===e.mentionType}function Dv(e){return!!(Zv(e)&&e.name&&e.en_name)}function Pv(e){return Array.isArray(e)&&e.some((function(e){return Dv(e)}))}function Lv(e){return e.type===we.K6s.MENTION&&void 0!==we.HA_[e.mentionType]}var Bv=function(){function e(t,n,r,a,o){(0,y.Z)(this,e),this.table=t,this.rowFrom=n,this.colFrom=r,this.rowTo=a,this.colTo=o,this.row=-1,this.col=-1,this.rowTo=Math.min(a,t.length-1),this.row=n,this.col=r-1}return(0,C.Z)(e,[{key:"next",value:function(){for(;this.isValid();){if(this.col++,(!this.table[this.row]||this.col>=this.table[this.row].length||this.col>this.colTo)&&!this.nextRow())return null;var e=this.table[this.row];if(null==e)return null;var t=e[this.col];if(null!=t)return t}return null}},{key:"isValid",value:function(){return this.row<=this.rowTo}},{key:"value",value:function(){var e=this.table[this.row]&&this.table[this.row][this.col];return null!=e?e:null}},{key:"nextRow",value:function(){do{this.row++}while(!this.table[this.row]&&this.rowTo>=this.row);return this.col=this.colFrom,this.rowTo>=this.row}}]),e}(),Uv=function(){function e(){(0,y.Z)(this,e),this.table=[]}return(0,C.Z)(e,[{key:"set",value:function(e,t,n){this.table[e]||(this.table[e]=[]),this.table[e][t]=n}},{key:"getRow",value:function(e){return this.table[e]||null}},{key:"get",value:function(e,t){var n=this.table[e];if(null==n)return null;var r=n[t];return void 0===r?null:r}},{key:"clear",value:function(e,t,n,r){for(var a=Math.min(n+e,Kv.rowSize),o=Math.min(r+t,Kv.colSize),i=e;i<a;i++)if(this.table[i]&&!(this.table[i].length<t))if(this.table[i].length<t+r)0===t?delete this.table[i]:this.table[i].length=t;else{for(var u=t;u<o;u++)this.table[i][u]=null;this.table[i].every((function(e){return null==e}))&&delete this.table[i]}this.table.every((function(e){return null==e||0===e.length}))&&(this.table.length=0)}},{key:"clearRow",value:function(e,t){for(var n=Math.min(t+e,Kv.rowSize);e<n;e++)this.table[e]=null}},{key:"swapRow",value:function(e,t,n){var r=this.table[e];this.table[e]=t.table[n],t.table[n]=r}},{key:"swapCol",value:function(e,t,n){this.table.map((function(r,a){r=r||[],t.table[a]=t.table[a]||[];var o=r[e];r[e]=t.table[a][n],t.table[a][n]=o}))}},{key:"swapCell",value:function(e,t,n,r,a){var o=this.get(e,t),i=n.get(r,a);this.set(e,t,i),n.set(r,a,o)}},{key:"reset",value:function(){this.table=[]}},{key:"setSize",value:function(e){this.table.length=e}},{key:"getSize",value:function(){return this.table.length}},{key:"iter",value:function(e,t,n,r){return new Bv(this.table,e,t,n,r)}},{key:"isEmpty",value:function(){return 0===this.table.length}}]),e}(),Hv=Math.pow(2,32),Wv=64,jv=63,zv=Math.pow(2,31)-1,Gv=Math.pow(2,32)-1;function Jv(e){return 0|(e>zv?e/Wv:e>>6)}function qv(e){return e>Gv?e%Wv:e&jv}function $v(e){return 0|(e>zv?e/8:e>>3)}function Yv(e){return e>Gv?e%8:7&e}var Kv=function(){function e(){(0,y.Z)(this,e),this.model=new Uv}return(0,C.Z)(e,[{key:"iterModel",value:function(e,t,n,r){return this.model.iter(e,t,n,r)}},{key:"set",value:function(e,t,n){if(!(e<0||t<0||void 0===e||void 0===t)){var r=0|(e>zv?e/Wv:e>>6),a=0|(t>zv?t/8:t>>3),o=this.model.get(r,a);o||(o=new Uv,this.model.set(r,a,o)),o.set(e>Gv?e%Wv:e&jv,t>Gv?t%8:7&t,n)}}},{key:"get",value:function(e,t){if(e<0||t<0||void 0===e||void 0===t)return null;var n=0|(e>zv?e/Wv:e>>6),r=0|(t>zv?t/8:t>>3),a=this.model.get(n,r);return a?a.get(e>Gv?e%Wv:e&jv,t>Gv?t%8:7&t):null}},{key:"getRow",value:function(e){return this.model.getRow(e)}},{key:"clear",value:function(e,t,n,r){var a=this.model.table;if(0!==a.length){for(var o=this.blockOffset(e,t),i=this.blockOffset(e+n-1,t+r-1),u=Math.min(a.length,i[0]+1),s=o[0];s<u;s++){var l=a[s];if(l){for(var c=Math.min(l.length,i[2]+1),h=o[2];h<c;h++){var f=l[h];if(f){var d=s===o[0]?o[1]:0,v=h===o[2]?o[3]:0,g=s===i[0]?i[1]-d+1:Wv-d,m=h===i[2]?i[3]-v+1:8-v;g===Wv&&8===m?f.reset():f.clear(d,v,g,m),f.isEmpty()&&delete l[h]}}l.every((function(e){return null==e||e.isEmpty()}))&&delete a[s]}}a.every((function(e){return null==e||0===e.length}))&&this.model.setSize(0)}}},{key:"isEmpty",value:function(){return this.model.isEmpty()}},{key:"setSize",value:function(e){this.model.setSize(e)}},{key:"getSize",value:function(){return this.model.getSize()}},{key:"reset",value:function(){this.model.reset()}},{key:"addRow",value:function(e,t,n){if(0!==t){for(var r=this.rowBlockOffset(e),a=(0,p.Z)(r,2),o=a[0],i=a[1],u=this.model.table,s=u.length-1;s>=o;s--)if(u[s]){var l=u[s];for(var c in l){var h=parseInt(c,10);if(l[c]){var f=s>o?0:i,d=Wv-f;this.MoveBlockDataByRow(l[c],s*Wv,8*h,f,d,t)}}}u.length=Math.min(u.length,this.rowBlockOffset(n)[0]+1)}}},{key:"addCol",value:function(e,t){if(0!==t){var n=this.colBlockOffset(e),r=(0,p.Z)(n,2),a=r[0],o=r[1],i=this.model.table;for(var u in i)if(i[u]&&!(i[u].length<a))for(var s=parseInt(u,10),l=i[u],c=i[u].length-1;c>=a;c--)if(l[c]){var h=l[c],f=c>a?0:o,d=8-f;this.MoveBlockDataByCol(h,s*Wv,8*c,f,d,t)}}}},{key:"delRow",value:function(e,t,n,r){if(0!==t){!r&&this.clear(e,0,t,Hv);for(var a=this.rowBlockOffset(e+t),o=(0,p.Z)(a,2),i=o[0],u=o[1],s=this.model.table,l=s.length,c=i;c<l;c++){var h=s[c];if(h)for(var f in h){var d=parseInt(f,10);if(h[d]){var v=c>i?0:u,g=Wv-v;this.MoveBlockDataByRow(h[d],c*Wv,8*d,v,g,-t)}}}var m=this.rowBlockOffset(n)[0]+1;m>=0&&(s.length=Math.min(s.length,m))}}},{key:"delCol",value:function(e,t,n){if(0!==t){!n&&this.clear(0,e,Hv,t);var r=this.model.table;for(var a in r){var o=r[a];if(o)for(var i=parseInt(a,10),u=o.length,s=this.colBlockOffset(e+t),l=(0,p.Z)(s,2),c=l[0],h=l[1],f=c;f<u;f++)if(o[f]){var d=f>c?0:h,v=8-d;this.MoveBlockDataByCol(o[f],i*Wv,8*f,d,v,-t)}}}}},{key:"swapRow",value:function(e,t){var n=this.rowBlockOffset(e),r=(0,p.Z)(n,2),a=r[0],o=r[1],i=this.rowBlockOffset(t),u=(0,p.Z)(i,2),s=u[0],l=u[1],c=this.model.table[a]||[],h=this.model.table[s]||[];if(0!==c.length||0!==h.length)for(var f=Math.max(c.length,h.length),d=0;d<f;d++){var v=this.gainBlock({rowBlock:a,colBlock:d}),g=this.gainBlock({rowBlock:s,colBlock:d});v.swapRow(o,g,l)}}},{key:"swapCol",value:function(e,t){var n=this,r=this.colBlockOffset(e),a=(0,p.Z)(r,2),o=a[0],i=a[1],u=this.colBlockOffset(t),s=(0,p.Z)(u,2),l=s[0],c=s[1];this.model.table.map((function(e,t){var r=n.gainBlock({rowBlock:t,colBlock:o}),a=n.gainBlock({rowBlock:t,colBlock:l});r.swapCol(i,a,c)}))}},{key:"swapCell",value:function(e,t,n,r){var a=Jv(e),o=$v(t),i=Jv(n),u=$v(r),s=this.gainBlockPos(a,o),l=this.gainBlockPos(i,u),c=qv(e),h=Yv(t),f=qv(n),d=Yv(r);s.swapCell(c,h,l,f,d)}},{key:"iter",value:function(e,t,n,r){return new Qv(this,e,t,e+n-1,t+r-1)}},{key:"orderedIter",value:function(e,t,n,r){return new eg(this,e,t,e+n-1,t+r-1)}},{key:"orderedIterWithPos",value:function(e,t,n,r){var a=new eg(this,e,t,e+n-1,t+r-1);return a.map((function(e){return[e,a.position()]}))}},{key:"iterWithPos",value:function(e,t,n,r){var a=new Qv(this,e,t,e+n-1,t+r-1);return a.map((function(e){return[e,a.position()]}))}},{key:"getImporter",value:function(){return null}},{key:"getExporter",value:function(e,t,n,r){return null}},{key:"rowBlockOffset",value:function(e){return[0|(e>zv?e/Wv:e>>6),e>Gv?e%Wv:e&jv]}},{key:"colBlockOffset",value:function(e){return[0|(e>zv?e/8:e>>3),e>Gv?e%8:7&e]}},{key:"blockOffset",value:function(e,t){var n=this.rowBlockOffset(e),r=this.colBlockOffset(t);return n.concat(r)}},{key:"MoveBlockDataByRow",value:function(e,t,n,r,a,o){var i=o<0?r:r+a-1,u=o<0?1:-1,s=this.blockOffset(t+i+o,n),l=this.gainBlock(this.convertBlockPositionToMap(s));if(a===Wv&&0===r&&0==(o>Gv?o%Wv:o&jv))l.table=e.table,e.table=[];else for(var c=0;c<a;c++)(s[1]===Wv||s[1]<0)&&(s=this.blockOffset(t+i+o,n),l=this.gainBlock(this.convertBlockPositionToMap(s))),l.table[s[1]]=e.table[i],e.table[i]=[],i+=u,s[1]+=u}},{key:"convertBlockPositionToMap",value:function(e){return{rowBlock:e[0],rowOffset:e[1],colBlock:e[2],colOffset:e[3]}}},{key:"MoveBlockDataByCol",value:function(e,t,n,r,a,o){var i=o<0?r:r+a-1,u=o<0?1:-1,s=this.blockOffset(t,n+i+o),l=this.gainBlock(this.convertBlockPositionToMap(s));if(8===a&&0===r&&0==(o>Gv?o%8:7&o))l.table=e.table,e.table=[];else for(var c=0;c<a;c++){(8===s[3]||s[3]<0)&&(s=this.blockOffset(t,n+i+o),l=this.gainBlock(this.convertBlockPositionToMap(s)));for(var h=0;h<Wv;h++)(l.table[h]||e.table[h])&&(l.table[h]||(l.table[h]=[]),e.table[h]?(l.table[h][s[3]]=e.table[h][i],e.table[h][i]=null):l.table[h][s[3]]&&(l.table[h][s[3]]=null));i+=u,s[3]+=u}}},{key:"gainBlock",value:function(e){var t=this.model.table,n=t[e.rowBlock];t[e.rowBlock]||(n=t[e.rowBlock]=[]);var r=n[e.colBlock];return r||(r=n[e.colBlock]=new Uv),r}},{key:"gainBlockPos",value:function(e,t){var n=this.model.table,r=n[e];n[e]||(r=n[e]=[]);var a=r[t];return a||(a=r[t]=new Uv),a}}]),e}();Kv.rowSize=Wv,Kv.colSize=8;var Xv,Qv=function(e){function t(e,n,r,a,o){var i;return(0,y.Z)(this,t),(i=(0,d.Z)(this,(0,v.Z)(t).call(this))).table=e,i.rowFrom=n,i.colFrom=r,i.rowTo=a,i.colTo=o,i.cellPosition={row:0,col:0},i.reset(),i}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"reset",value:function(){return this.blockIter=this.table.iterModel(0|(this.rowFrom>zv?this.rowFrom/Wv:this.rowFrom>>6),0|(this.colFrom>zv?this.colFrom/8:this.colFrom>>3),0|(this.rowTo>zv?this.rowTo/Wv:this.rowTo>>6),0|(this.colTo>zv?this.colTo/8:this.colTo>>3)),this.dataIter=null,this.cellPosition.row=0,this.cellPosition.col=0,this}},{key:"next",value:function(){if(!this.isValid())return null;for(;!this.dataIter||null===this.dataIter.next();){var e=this.blockIter.next();if(!e)return null;var t=this.blockIter,n=t.row,r=t.col,a=n===(this.rowFrom>zv?this.rowFrom/Wv:this.rowFrom>>6|0),o=r===(this.colFrom>zv?this.colFrom/8:this.colFrom>>3|0),i=n===(this.rowTo>zv?this.rowTo/Wv:this.rowTo>>6|0),u=r===(this.colTo>zv?this.colTo/8:this.colTo>>3|0);this.dataIter=new Bv(e.table,a?this.rowFrom>Gv?this.rowFrom%Wv:this.rowFrom&jv:0,o?this.colFrom>Gv?this.colFrom%8:7&this.colFrom:0,i?this.rowTo>Gv?this.rowTo%Wv:this.rowTo&jv:63,u?this.colTo>Gv?this.colTo%8:7&this.colTo:7)}return this.dataIter.value()}},{key:"position",value:function(){var e=this.blockIter,t=this.dataIter?this.dataIter.row:0,n=this.dataIter?this.dataIter.col:0;return this.cellPosition.row=e.row*Wv+t,this.cellPosition.col=8*e.col+n,this.cellPosition}},{key:"isValid",value:function(){return this.blockIter.isValid()}}]),t}(Rt.FIterator),eg=function(e){function t(e,n,r,a,o){var i;return(0,y.Z)(this,t),(i=(0,d.Z)(this,(0,v.Z)(t).call(this))).model=e,i.rowFrom=n,i.colFrom=r,i.rowTo=a,i.colTo=o,i.cellPosition={row:n,col:r-1},i.blockRowTo=0|(a>zv?a/Wv:a>>6),i.blockColTo=0|(o>zv?o/8:o>>3),i}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"next",value:function(){if(!this.isValid())return null;for(var e=null;null===e;){if(!this.iter())return null;for(var t=0|(this.cellPosition.row>zv?this.cellPosition.row/Wv:this.cellPosition.row>>6),n=0|(this.cellPosition.col>zv?this.cellPosition.col/8:this.cellPosition.col>>3);!this.model.getRow(t)||!this.model.getRow(t)[n];)if(n<this.blockColTo)n++,this.cellPosition.col=8*n;else{if(!(this.cellPosition.row<this.rowTo))return null;this.cellPosition.row++,this.cellPosition.col=this.colFrom,t=0|(this.cellPosition.row>zv?this.cellPosition.row/Wv:this.cellPosition.row>>6),n=0|(this.cellPosition.col>zv?this.cellPosition.col/8:this.cellPosition.col>>3)}var r=this.model.getRow(t)[n],a=this.cellPosition.row>Gv?this.cellPosition.row%Wv:this.cellPosition.row&jv,o=this.cellPosition.col>Gv?this.cellPosition.col%8:7&this.cellPosition.col;r.getRow(a)?e=r.get(a,o):this.cellPosition.col+=8-o-1}return e}},{key:"iter",value:function(){return this.cellPosition.col<this.colTo?(this.cellPosition.col++,!0):this.cellPosition.row<this.rowTo?(this.cellPosition.row++,this.cellPosition.col=this.colFrom,!0):(this.cellPosition.col++,this.cellPosition.row++,!1)}},{key:"isValid",value:function(){return this.cellPosition.row<=this.rowTo&&this.cellPosition.col<=this.colTo}},{key:"position",value:function(){return this.cellPosition}}]),t}(Rt.FIterator),tg=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[];(0,y.Z)(this,e),this.models=t}return(0,C.Z)(e,[{key:"addModel",value:function(e){return this.models.push(e),this}},{key:"removeModels",value:function(e){for(var t=new Set,n=0,r=e.length;n<r;n++)t.add(e[n]);for(var a=this.models.length-1;a>=0;a--)t.has(this.models[a])&&this.models.splice(a,1);return this}},{key:"orderedIter",value:function(e,t,n,r){throw new Error("Method not implemented.")}},{key:"orderedIterWithPos",value:function(e,t,n,r){throw new Error("Method not implemented.")}},{key:"iter",value:function(){throw new Error("not implement")}},{key:"set",value:function(){throw new Error("not support!")}},{key:"get",value:function(){throw new Error("not support!")}},{key:"clear",value:function(e,t,n,r){throw new Error("Method not implemented.")}},{key:"isEmpty",value:function(){throw new Error("Method not implemented.")}},{key:"iterWithPos",value:function(e,t,n,r){throw new Error("Method not implemented.")}},{key:"addRow",value:function(e,t,n){for(var r=0;r<this.models.length;r++)this.models[r].addRow(e,t,n)}},{key:"delRow",value:function(e,t,n){for(var r=0;r<this.models.length;r++)this.models[r].delRow(e,t,n)}},{key:"addCol",value:function(e,t){for(var n=0;n<this.models.length;n++)this.models[n].addCol(e,t)}},{key:"delCol",value:function(e,t){for(var n=0;n<this.models.length;n++)this.models[n].delCol(e,t)}},{key:"swapRow",value:function(e,t){for(var n=0;n<this.models.length;n++)this.models[n].swapRow(e,t)}},{key:"swapCol",value:function(e,t){for(var n=0;n<this.models.length;n++)this.models[n].swapCol(e,t)}},{key:"swapCell",value:function(e,t,n,r){for(var a=0;a<this.models.length;a++)this.models[a].swapCell(e,t,n,r)}},{key:"getImporter",value:function(){var e,t=[],n=_n(this.models);try{for(n.s();!(e=n.n()).done;){var r=e.value.getImporter();r&&t.push(r)}}catch(e){n.e(e)}finally{n.f()}return new rg(t)}},{key:"getExporter",value:function(e,t,n,r){var a,o=[],i=_n(this.models);try{for(i.s();!(a=i.n()).done;){var u=a.value.getExporter(e,t,n,r);u&&o.push(u)}}catch(e){i.e(e)}finally{i.f()}return new ng(o)}}]),e}(),ng=function(){function e(t){(0,y.Z)(this,e),this.exporters=t}return(0,C.Z)(e,[{key:"exportExtraInfo",value:function(e){var t,n=_n(this.exporters);try{for(n.s();!(t=n.n()).done;){t.value.exportExtraInfo(e)}}catch(e){n.e(e)}finally{n.f()}}},{key:"exportCells",value:function(e,t){for(var n=0;n<this.exporters.length;n++)this.exporters[n].exportCells(e,t)}},{key:"serializeCells",value:function(e,t){var n,r=_n(this.exporters);try{for(r.s();!(n=r.n()).done;){n.value.serializeCells(e,t)}}catch(e){r.e(e)}finally{r.f()}}},{key:"serializeToMutations",value:function(e){this.exporters.forEach((function(t){t.serializeToMutations(e)}))}},{key:"setExportType",value:function(e){var t,n=_n(this.exporters);try{for(n.s();!(t=n.n()).done;){t.value.setExportType(e)}}catch(e){n.e(e)}finally{n.f()}}}]),e}(),rg=function(){function e(t){(0,y.Z)(this,e),this.importers=t}return(0,C.Z)(e,[{key:"importExtraInfo",value:function(e,t){for(var n=0,r=this.importers.length;n<r;n++)this.importers[n].importExtraInfo(e,t)}},{key:"importCell",value:function(e,t,n,r){for(var a=0,o=this.importers.length;a<o;a++)this.importers[a].importCell(e,t,n,r)}}]),e}();!function(e){e.CheckCell="CheckCell",e.CheckInput="CheckInput"}(Xv||(Xv={}));var ag="dataValidation";var og=new ut.FormulaCache(ut.NULL_VAR,ut.NULL_VAR),ig=function(){function e(t,n,r,a,o){(0,y.Z)(this,e),this.sheet=o,this.dvFormula=null,this._hasFormulaForCheckCellValidInit=!1,this.fromJSON(t,n,r,a)}return(0,C.Z)(e,[{key:"destroy",value:function(){this._setFormula(null),this._hasFormulaForCheckCellValidInit=!1}},{key:"toJSON",value:function(e){var t=this,n=this.toJSONImplement(e);if(e.returnDependentSheets){var r=new Set,a=this.dvFormula?this.dvFormula.getRefMap():null;a&&Object.values(a).forEach((function(e){var n=e.sheet();n&&n.id()!==t.sheet.id()&&r.add(n.id())})),0!==r.size&&(n.dependentSheets=Array.from(r))}return n}},{key:"checkOptionsValid",value:function(){return this.isOptionError=!1,!0}},{key:"checkCellValid",value:function(e,t){this.checkOptionsValid();var n=null;if(this.dvFormula){var r=new Zi(e,t,this.sheet),a={ref:r,customRef:r,executeMode:ut.ExecuteMode.FORCE};this.dvFormula.resetState();var o=this.dvFormula.getRawVar(a),i=this.sheet.getImmutableContent(e,t);n=!i||function(e){var t=e.multipleValues,n=e.segmentArray,r=e.variant;return!(t||n||r&&r!==ut.NULL_VAR)}(i)?this._getResultWhileCellIsEmpty():this._getResultWhileCalcCorrectly(o,"CheckCell",i)}else n=this._getResultWhileFmlErr();return n}},{key:"checkInputValid",value:function(e){var t=e.row,n=e.col,r=e.editingText;if(!r)return!0;var a=this._getFormulaArgsForCheckInput(r),o=a.validateObj,i=a.formatCode;if("string"!=typeof o&&"number"!=typeof o)return!1;var u=this._initFormulaForCheckInput(o,i,t,n);if(!u)return!0;var s=u.getRawVar({executeMode:ut.ExecuteMode.FORCE});return this._getResultWhileCalcCorrectly(s,"CheckInput").getValue()}},{key:"_setFormula",value:function(e,t){this.dvFormula=e,this._afterFormulaForCheckCellChanged&&this._afterFormulaForCheckCellChanged(t)}},{key:"initFormulaForCheckCell",value:function(e){if(!this._hasFormulaForCheckCellValidInit){var t={ref:new Zi(-1,-1,this.sheet),spread:this.sheet.parent,enableCalculation:!0},n=this._getFormulaStr("PRIVATE_GET_REF()"),r=this.sheet.getCalcEngine().compile(n,t),a=null==e?void 0:e.preventRegisterFml;if(r.formulaVar&&r.formulaVar.isFormula()){var o=r.formulaVar;a||(o.getState().cache=og),this._setFormula(o,a)}else console.error("COMPILE_FORMULA_VAR_ERROR",(0,we.XP5)(n)),we.Ps3.moirae.ravenCatch("COMPILE_FORMULA_VAR_ERROR",{tags:{key:"COMPILE_FORMULA_VAR_ERROR"}});this._hasFormulaForCheckCellValidInit=!0}}},{key:"_initFormulaForCheckInput",value:function(e,t,n,r){var a=null,o={ref:new Zi(n,r,this.sheet),enableCalculation:!0,spread:this.sheet.parent},i=this._getFormulaStr(e,t),u=this.sheet.getCalcEngine().compile(i,o);return u.formulaVar&&u.formulaVar.isFormula()?a=u.formulaVar:(console.error("COMPILE_FORMULA_VAR_ERROR",(0,we.XP5)(i)),we.Ps3.moirae.ravenCatch("COMPILE_FORMULA_VAR_ERROR",{tags:{key:"COMPILE_FORMULA_VAR_ERROR"}})),a}},{key:"onOp",value:function(e){}}],[{key:"isValidJSON",value:function(e){var t=e.options;if((0,ve.Z)(t)){var n=t.handledWayOnInvalidData,r=t.helpText;if(kn(t,"handledWayOnInvalidData")&&("number"!=typeof n||3===n))return!1;if(kn(t,"helpText")&&("string"!=typeof r||""===r))return!1}return!0}}]),e}();function ug(e,t){var n=new ut.BooleanVar(e);return t&&n.setSpecialInfo({listValidateInfo:new mv([t])}),n}ig=Gi([function(e){return e}],ig);var sg,lg=function(e){function t(e,n,r,a){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).call(this,e,void 0,n,r,a))}return(0,g.Z)(t,e),(0,C.Z)(t,null,[{key:"isValidJSON",value:function(e){if(!ig.isValidJSON(e))return!1;if(kn(e,"operator"))return!1;var t=e.formulas,n=e.options;if(!Array.isArray(t))return!1;var r,a=_n(t);try{for(a.s();!(r=a.n()).done;){if("string"!=typeof r.value)return!1}}catch(e){a.e(e)}finally{a.f()}if(!(0,ve.Z)(n))return!1;var o=n.supportMultipleValues,i=n.ignoreCase,u=n.shouldHighlightValidData,s=n.isDropdownIconHiddenInCell;return"boolean"==typeof o&&"boolean"==typeof i&&"boolean"==typeof u&&(!kn(n,"isDropdownIconHiddenInCell")||!0===s)}}]),(0,C.Z)(t,[{key:"_getFormulaStr",value:function(e){return"PRIVATE_LIST_VALIDATION(".concat(e,", ").concat(this._getListArgs(),", ").concat(this._getSupportMultipleValuesArgs(),", ").concat(this._getIgnoreCaseArgs(),")")}},{key:"_getResultWhileFmlErr",value:function(){return ug(!1)}},{key:"_getResultWhileCellIsEmpty",value:function(){return ug(!0)}},{key:"_getResultWhileFmlServiceSuspended",value:function(){return ug(!0)}},{key:"_getSupportMultipleValuesArgs",value:function(){return!0===this.options.supportMultipleValues?"TRUE":"FALSE"}},{key:"_getIgnoreCaseArgs",value:function(){return!0===this.options.ignoreCase?"TRUE":"FALSE"}},{key:"_getFormulaArgsForCheckInput",value:function(e){var t="";return t=(this.options||{}).supportMultipleValues&&"string"==typeof e?e.split(",").map((function(e){return(0,we.dNX)(e)})).join('","'):(0,we.dNX)(e),{validateObj:'{"'.concat(t,'"}')}}}]),t}(ig);function cg(e,t){if(null!==e&&"object"==(0,_.Z)(e)&&!Object.isFrozen(e)){Object.freeze(e);var n,r=_n(Object.getOwnPropertyNames(e));try{for(r.s();!(n=r.n()).done;){var a=n.value;t&&t.has(a)||cg(e[a],t)}}catch(e){r.e(e)}finally{r.f()}}}lg=Gi([function(e){return e}],lg);var hg=sg=function(e){function t(e,n,r){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).call(this,"list",e,n,r))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"formulas",get:function(){return this._initialFormulas}}],[{key:"isValidJSON",value:function(e){if(!lg.isValidJSON(e))return!1;var t=e.options;if(t.shouldHighlightValidData){var n=t.listItemColorMap;if(!(0,ve.Z)(n))return!1}return!0}}]),(0,C.Z)(t,[{key:"fromJSON",value:function(e,t,n,r){this.type=e,this.operator=t,this._initialFormulas=n,this.options=r}},{key:"toJSONImplement",value:function(e){var t=e.needDeepClone,n=t?ya(this.formulas):this.formulas,r=t?ya(this.options):this.options;return{type:this.type,formulas:n,options:r}}},{key:"clone",value:function(){return new sg(ya(this.formulas),ya(this.options),this.sheet)}},{key:"freezeRef",value:function(){var e={writable:!1,configurable:!1};cg(this.type),cg(this.operator),cg(this._initialFormulas),cg(this.options),Object.defineProperties(this,{type:e,operator:e,_initialFormulas:e,options:e})}},{key:"getHash",value:function(){return xa(this.toJSON({needDeepClone:!1}))}},{key:"_getListArgs",value:function(){return'{"'.concat(this.formulas.map((function(e){return(0,we.dNX)(e)})).join('","'),'"}')}},{key:"_getResultWhileCalcCorrectly",value:function(e){var t,n=this;if(!e.isBool())return ug(!1);var r=null===(t=e.getSpecialInfo())||void 0===t?void 0:t.listValidationFuncInfo;if(r){var a=r.map((function(e){var t=e.segmentArray,r=e.variant,a=e.text,o={segmentArray:t,variant:r,text:a};if(n.options.shouldHighlightValidData){var i=n.options.listItemColorMap,u=a.toUpperCase();if("FALSE"===u||"TRUE"===u){for(var s in i)if(s.toUpperCase()===u){o.color=i[s];break}}else{var l=i[a];l&&(o.color=l)}}return o}));return ug(e.getValue(),a)}return ug(e.getValue())}},{key:"getDropdownListData",value:function(){var e=this.options&&this.options.shouldHighlightValidData,t={list:(0,ye.Z)(this.formulas).filter(Boolean),colorMap:{},isEnableOptionColor:e,isSupportMultipleValue:this.options&&this.options.supportMultipleValues};return this.options.shouldHighlightValidData&&(t.colorMap=this.options.listItemColorMap),t}},{key:"getListItem",value:function(){return this.formulas}}]),t}(lg);hg=sg=Gi([function(e){return e}],hg);var fg,dg,vg=function(){function e(t,n){(0,y.Z)(this,e),this._colors=t,this._refRange=n}return(0,C.Z)(e,[{key:"onOp",value:function(e){e instanceof Wi?this._onRowColOp(e):"DelRowOp"===e.instanceType&&this._handleDelRows(e)}},{key:"_onRowColOp",value:function(e){switch(e.segOpType()){case"add":e.isRowType()?this._handleColorsWhileAddRows(e):this._handleColorsWhileAddCols(e);break;case"delete":e.isRowType()?this._handleColorsWhileDelRows(e):this._handleColorsWhileDelCols(e)}}},{key:"_handleColorsWhileAddRows",value:function(e){var t=e.from()-this._refRange.rowFrom();if(this._refRange instanceof Vi?0<=t&&t<=this._refRange.rowCount(!0):0<t&&t<this._refRange.rowCount(!0)){for(var n,r=[],a=e.size(),o=this._refRange.colCount(!0),i=t;i<t+a;++i){for(var u=[],s=0;s<o;++s)u.push((0,we.N$c)(i*o+s));r.push(u)}(n=this._colors).splice.apply(n,[t,0].concat(r))}}},{key:"_handleColorsWhileAddCols",value:function(e){var t=e.from()-this._refRange.colFrom();if(this._refRange instanceof xi?0<=t&&t<=this._refRange.colCount(!0):0<t&&t<this._refRange.colCount(!0))for(var n=e.size(),r=this._refRange.colCount(!0)+n,a=0;a<this._colors.length;++a){for(var o,i=[],u=t;u<t+n;++u)i.push((0,we.N$c)(a*r+u));(o=this._colors[a]).splice.apply(o,[t,0].concat(i))}}},{key:"_handleDelRows",value:function(e){for(var t=e.ranges,n=this._refRange.rowFrom(),r=t.length-1;r>=0;r--){var a=t[r].target-n,o=t[r].count;if(a<0&&(o+=a,a=0),!(a>=this._colors.length)){if(!(o>0))break;this._colors.splice(a,o)}}}},{key:"_handleColorsWhileDelRows",value:function(e){var t=e.from()-this._refRange.rowFrom(),n=e.size();t<0&&(n+=t,t=0),this._colors.splice(t,n)}},{key:"_handleColorsWhileDelCols",value:function(e){var t=e.from()-this._refRange.colFrom(),n=e.size();t<0&&(n+=t,t=0);for(var r=0;r<this._colors.length;++r)this._colors[r].splice(t,n)}}]),e}(),gg=2e3,mg=fg=function(e){function t(e,n,r){var a;return(0,y.Z)(this,t),(a=(0,d.Z)(this,(0,v.Z)(t).call(this,"listFromRange",e,n,r)))._refRangeInFormula=null,a.dispose=null,a}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"fromJSON",value:function(e,t,n,r){var a=new Zi(-1,-1,this.sheet),o=this.sheet.parent,i=ql(n[0],{spread:o,refStyle:"A1",ref:a});if(i)if(i.isRef()){i.setRefStatus(15);var u=i;n[0]=u.toString({refStyle:"A1",ref:a})}else n[0]=i.getValue();else n[0]=ut.ErrorConstant.REF;if(r.shouldHighlightValidData)if(i&&!i.isError()){var s=i;this._fixColorsByRefRange(r.colors,s)}else r.colors.splice(0,r.colors.length);this.type=e,this.operator=t,this._initialFormulas=n,this.options=r}},{key:"freezeRef",value:function(){var e={writable:!1,configurable:!1};cg(this.type),cg(this.operator),cg(this.options,new Set(["colors"])),Object.defineProperties(this,{type:e,operator:e,_initialFormulas:e,options:e})}},{key:"getHash",value:function(){var e;return this.options.shouldHighlightValidData?delete(e=Object.assign({},this.options)).colors:e=this.options,xa({type:this.type,options:e})}},{key:"toJSONImplement",value:function(e){var t,n=e.needDeepClone,r=e.refSheet;t=r&&this._refRangeInFormula?[this._refRangeInFormula.toString({refStyle:"A1",ref:new Zi(-1,-1,r)})]:n?ya(this.formulas):this.formulas;var a=n?ya(this.options):this.options;return{type:this.type,formulas:t,options:a}}},{key:"clone",value:function(){return new fg(ya(this.formulas),ya(this.options),this.sheet)}},{key:"_getListArgs",value:function(){return this.formulas[0]}},{key:"checkOptionsValid",value:function(){var e;return this.options.shouldHighlightValidData?(this.isOptionError=!this._refRangeInFormula||(null===(e=this._refRangeInFormula)||void 0===e?void 0:e.size())>gg,!this.isOptionError):(this.isOptionError=!1,!0)}},{key:"_getResultWhileCalcCorrectly",value:function(e){var t,n=this;if(!e.isBool())return ug(!1);var r=null===(t=e.getSpecialInfo())||void 0===t?void 0:t.listValidationFuncInfo;if(r){var a=r.map((function(e){var t=e.segmentArray,r=e.variant,a=e.text,o=e.index,i={segmentArray:t,variant:r,text:a};if(n.options.shouldHighlightValidData&&o>=0){var u=n.options.colors;if(u.length>0){var s=u[0].length,l=u[Math.floor(o/s)];if(l){var c=l[o%s];c&&(i.color=c)}}}return i}));return ug(e.getValue(),a)}return ug(e.getValue())}},{key:"getListItem",value:function(e){var t=null;if(this._refRangeInFormula)t=this._refRangeInFormula;else{var n=new Zi(-1,-1,this.sheet),r=this.sheet.parent,a=ql(this.formulas[0],{spread:r,refStyle:"A1",ref:n});a&&a.isRef()&&(t=a)}if(!t)return[];var o=t.sheet();if(!o)return[];for(var i=[],u=t.rowFrom(),s=t.colFrom(),l=t.rowTo(),c=t.colTo(),h=Boolean(e&&e.preventUseTextCache),f=u;f<=l;++f)for(var d=s;d<=c;++d)i.push(o.getText(f,d,void 0,h,void 0));return i}},{key:"_fixColorsByRefRange",value:function(e,t){for(var n=t.colCount(!0),r=0;r<e.length;++r){var a=e[r].length,o=n-a;if(o>0)for(var i=a;i<n;++i)e[r].push((0,we.N$c)(r*n+i));else if(o<0)for(var u=0;u<-o;++u)e[r].pop()}var s=t.rowCount(!0),l=s-e.length;if(l>0)for(var c=e.length;c<s;++c){for(var h=[],f=0;f<n;++f)h.push((0,we.N$c)(c*n+f));e.push(h)}else if(l<0)for(var d=0;d<-l;++d)e.pop()}},{key:"_getRefRangeInFormula",value:function(e){if(!e)return null;var t=e.formula.expression;if(5!==(null==t?void 0:t.length))return null;var n=t[1];if(Mu(n)){var r=n.getSheetRef(e.getRefMap());return r.isError()?null:r}return Fu(n)?n.getRef():null}},{key:"_afterFormulaForCheckCellChanged",value:function(e){var t=this;if(this.dispose&&(this.dispose(),this.dispose=null),this._refRangeInFormula&&delete this._refRangeInFormula.afterSheetChanged,this.dvFormula){var n=this.dvFormula.getRefMap();if(!n)return;var r={};Object.keys(n).forEach((function(e){r[e]=n[e].clone()})),this.dvFormula.setRefMap(r);var a=this._getRefRangeInFormula(this.dvFormula);this.options.shouldHighlightValidData&&a&&(a instanceof xi||a instanceof Vi)&&(a.afterSheetChanged=function(){t.options.shouldHighlightValidData&&t._fixColorsByRefRange(t.options.colors,a)}),this._refRangeInFormula=a}else this._initialFormulas[0]=this.formulas[0],this._refRangeInFormula=null;this._refRangeInFormula&&!e&&(this.dispose=this.sheet.getCalcEngine().depRefManager.watchRef(this._refRangeInFormula,(function(){t.sheet.dispatch("DataValidationFormulaMarkDirty",t)}),(function(e,n){return t.beforeFormulaRefArgChanged(e,n),!0}),(function(e,n){t.afterFormulaRefArgChanged(e,n)})))}},{key:"beforeFormulaRefArgChanged",value:function(e,t){if(this.options.shouldHighlightValidData){var n=this._refRangeInFormula;if(n===e){var r=n;n instanceof xi&&t instanceof Wi&&"add"===t.segOpType()&&!t.isRowType()&&(r=Object.create(n,{colCount:{value:function(){return n.colCount()-t.size()}}})),n instanceof Vi&&t instanceof Wi&&"add"===t.segOpType()&&t.isRowType()&&(r=Object.create(n,{rowCount:{value:function(){return n.rowCount()-t.size()}}})),new vg(this.options.colors,r).onOp(t)}}}},{key:"afterFormulaRefArgChanged",value:function(e,t){if(this.options.shouldHighlightValidData){var n=this._refRangeInFormula;n===e&&"DelSheetOp"!==t.type()&&this._fixColorsByRefRange(this.options.colors,n)}}},{key:"onOp",value:function(e){if(this._refRangeInFormula){var t=this._refRangeInFormula;e.effectedRef().every((function(e){return!e.isIntersect(t)}))||(this.beforeFormulaRefArgChanged(t,e),t.onOp(e),this.afterFormulaRefArgChanged(t,e))}}},{key:"assignListOptionsWithColor",value:function(){var e=this.formulas[0]||"",t=this.sheet;if(!e||!this.options.shouldHighlightValidData||!t)return[];var n=this.options.colors,r=(0,de.Z)(n),a=null,o=(a=this._refRangeInFormula?this._refRangeInFormula:t.rangeStringToRange(e))&&a.sheet();if(!a||!o)return[];for(var i=[],u=0,s=a.rowFrom(),l=a.colFrom(),c=a.rowTo(),h=a.colTo(),f=s;f<=c;++f)for(var d=l;d<=h;++d){var v=o.getText(f,d);i.push({id:u,value:v,color:r[u++]||""})}return i}},{key:"getDropdownListData",value:function(){var e={},t=(0,ye.Z)(this.getListItem()).filter(Boolean);return this.options.shouldHighlightValidData&&(e=this.assignListOptionsWithColor().reduce((function(e,t){return e[t.value]||(e[t.value]=t.color),e}),{})),{list:t,colorMap:e,isEnableOptionColor:this.options.shouldHighlightValidData,isSupportMultipleValue:this.options.supportMultipleValues}}},{key:"formulas",get:function(){return this._refRangeInFormula?[this._refRangeInFormula.toString({refStyle:"A1",ref:new Zi(-1,-1,this.sheet)})]:this._initialFormulas}}],[{key:"isValidJSON",value:function(e){if(!lg.isValidJSON(e))return!1;var t=e.formulas,n=e.options;if(1!==t.length)return!1;if(n.shouldHighlightValidData){var r=n.colors;if(!Array.isArray(r))return!1}else if(kn(n,"colors"))return!1;return!0}}]),t}(lg);function pg(e,t){var n=new ut.BooleanVar(e);return n.setSpecialInfo({checkboxInfo:t}),n}mg=fg=Gi([function(e){return e}],mg);var yg,Cg=dg=function(e){function t(e,n,r){var a;return(0,y.Z)(this,t),(a=(0,d.Z)(this,(0,v.Z)(t).call(this,"checkbox",void 0,e,n,r))).shouldDelWhileClearValue=!0,a}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"fromJSON",value:function(e,t,n,r){this.type=e,this.operator=t,this._initialFormulas=n,this.options=r}},{key:"toJSONImplement",value:function(e){var t=e.needDeepClone,n={type:this.type,formulas:t?ya(this.formulas):this.formulas};return this.options&&(n.options=t?ya(this.options):this.options),n}},{key:"clone",value:function(){return new dg(ya(this.formulas),ya(this.options),this.sheet)}},{key:"freezeRef",value:function(){var e={writable:!1,configurable:!1};cg(this.type),cg(this.operator),cg(this._initialFormulas),cg(this.options),Object.defineProperties(this,{type:e,operator:e,_initialFormulas:e,options:e})}},{key:"getHash",value:function(){return xa(this.toJSON({needDeepClone:!1}))}},{key:"_getFormulaStr",value:function(e){var t=(0,p.Z)(this.formulas,2),n=t[0],r=t[1];return"PRIVATE_CHECKBOX(".concat(e,",").concat(n,",").concat(r,")")}},{key:"_getResultWhileFmlErr",value:function(){return pg(!1,{visible:!1})}},{key:"_getResultWhileCellIsEmpty",value:function(){return pg(!0,{visible:!0,checked:!1})}},{key:"_getResultWhileFmlServiceSuspended",value:function(){return pg(!0,{visible:!1})}},{key:"_getResultWhileCalcCorrectly",value:function(e,t,n){return"CheckCell"===t&&n&&function(e){var t=e.multipleValues,n=e.segmentArray;return!(t||!n||1!==n.length||n[0].type!==we.K6s.EMBED_IMAGE)}(n)?pg(!1,{visible:!1}):e}},{key:"_getFormulaArgsForCheckInput",value:function(e){var t=(0,fe.Z)(e);return{validateObj:isNaN(t)?'"'.concat((0,we.dNX)(e),'"'):t}}},{key:"formulas",get:function(){return this._initialFormulas}}],[{key:"isValidJSON",value:function(e){if(!ig.isValidJSON(e))return!1;if(kn(e,"operator"))return!1;var t=e.formulas,n=e.options;if(!Array.isArray(t)||2!==t.length)return!1;var r,a=_n(t);try{for(a.s();!(r=a.n()).done;){if("number"!=typeof r.value)return!1}}catch(e){a.e(e)}finally{a.f()}return!(0,ve.Z)(n)||0!==Object.keys(n).length}}]),t}(ig);function _g(e,t,n){var r,a=arguments.length>3&&void 0!==arguments[3]&&arguments[3],o="TRUE()";if(!n)return o;e=a?"LEN(".concat(e,")"):e;var i=n.map((function(e){return e.value})),u="NOT(AND(NOT(ISNUMBER(".concat(e,")), ISNUMBER(").concat(i[0],")))");return null!==(r={equalTo:"AND(".concat(e," = ").concat(i[0],", NOT(ISBLANK(").concat(e,")))"),notEqualTo:"AND(OR(NOT(".concat(e," = ").concat(i[0],"), ISBLANK(").concat(e,")), ").concat(u,")"),lessThan:"AND(".concat(e," < ").concat(i[0],", ").concat(u,")"),lessThanOrEqualTo:"AND(".concat(e," <= ").concat(i[0],", ").concat(u,")"),greaterThan:"AND(".concat(e," > ").concat(i[0],", ").concat(u,")"),greaterThanOrEqualTo:"AND(".concat(e," >= ").concat(i[0],", ").concat(u,")"),between:"AND(OR(\n      AND(".concat(e," >= ").concat(i[0],", ").concat(e," <= ").concat(i[1],"),\n      AND(").concat(e," >= ").concat(i[1],", ").concat(e," <= ").concat(i[0],")\n    ),\n      NOT(ISBLANK(").concat(e,"))\n    )"),notBetween:"NOT(OR(\n      AND(".concat(e," >= ").concat(i[0],", ").concat(e," <= ").concat(i[1],"),\n      AND(").concat(e," >= ").concat(i[1],", ").concat(e," <= ").concat(i[0],")\n    ))")}[t])&&void 0!==r?r:o}function Rg(e,t){var n=["between","notBetween"].includes(e);return[!n&&1===t.length,n&&2===t.length].some(Boolean)}Cg=dg=Gi([function(e){return e}],Cg);var wg,kg=yg=function(e){function t(e,n,r,a){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).call(this,"number",e,n,r,a))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"formulas",get:function(){return this._initialFormulas}}]),(0,C.Z)(t,[{key:"fromJSON",value:function(e,t,n,r){this.type=e,this.operator=t,this._initialFormulas=n,this.options=r}},{key:"toJSONImplement",value:function(e){var t=e.needDeepClone,n={type:this.type,options:t?ya(this.options):this.options,operator:t?ya(this.operator):this.operator};return"isAValidNumber"!==this.operator&&(n.formulas=t?ya(this.formulas):this.formulas),n}},{key:"clone",value:function(){return new yg(ya(this.operator),ya(this.formulas),ya(this.options),this.sheet)}},{key:"freezeRef",value:function(){var e={writable:!1,configurable:!1};cg(this.type),cg(this.operator),cg(this._initialFormulas),cg(this.options),Object.defineProperties(this,{type:e,operator:e,_initialFormulas:e,options:e})}},{key:"getHash",value:function(){return xa(this.toJSON({needDeepClone:!1}))}},{key:"_getResultWhileFmlErr",value:function(){return new ut.BooleanVar(!1)}},{key:"_getResultWhileCellIsEmpty",value:function(){return new ut.BooleanVar(!0)}},{key:"_getResultWhileFmlServiceSuspended",value:function(){return new ut.BooleanVar(!0)}},{key:"_getResultWhileCalcCorrectly",value:function(e){return e.isBool()?e:new ut.BooleanVar(!1)}},{key:"_getFormulaStr",value:function(e,t){var n;t=null!==(n=t)&&void 0!==n?n:"";var r="PRIVATE_IS_INT(".concat(e,")");if("isAValidNumber"===this.operator){var a="AND(\n        ISNUMBER(".concat(e,'),\n        OR(\n          PRIVATE_FORMATTER_VALIDATION("null", "').concat(t,'"),\n          PRIVATE_FORMATTER_VALIDATION("general", "').concat(t,'"),\n          PRIVATE_FORMATTER_VALIDATION("digital", "').concat(t,'")\n        )\n      )');return a=this.isOnlyReceiveInteger?"AND(".concat(r,", ").concat(a,")"):a,"OR(ISBLANK(".concat(e,"), ").concat(a,")")}var o=_g(e,this.operator,this.formulas);return o=this.isOnlyReceiveInteger?"AND(".concat(r,", ").concat(o,")"):o,"OR(ISBLANK(".concat(e,"), ").concat(o,")")}},{key:"_getFormulaArgsForCheckInput",value:function(e){var t=ha(this.sheet.formatterService,null,e);if(!t)return{validateObj:e};var n=t.value,r=t.autoFormatter;return{validateObj:(0,ge.default)(n)?n:'"'.concat((0,we.dNX)(n),'"'),formatCode:r&&r.getFormatCode()}}},{key:"isOnlyReceiveInteger",get:function(){return 1===this.options.validNumType}}],[{key:"isValidJSON",value:function(e){var t=e.type,n=e.formulas,r=e.operator,a=e.options,o=kn(e,"formulas");return!([[t,r,a].every(Boolean),[(0,he.Z)(r),(0,ve.Z)(a)].every(Boolean),!o||Array.isArray(n)&&n.every((function(e){return(0,ge.default)(e.value)}))].some((0,ce.Z)(Boolean))||"isAValidNumber"===r&&o||"isAValidNumber"!==r&&!Array.isArray(n)||"isAValidNumber"!==r&&!Rg(r,n))}}]),t}(ig);kg=yg=Gi([function(e){return e}],kg);var Sg,Eg=wg=function(e){function t(e,n,r,a){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).call(this,"date",e,n,r,a))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"formulas",get:function(){return this._initialFormulas}}]),(0,C.Z)(t,[{key:"fromJSON",value:function(e,t,n,r){this.type=e,this.operator=t,this._initialFormulas=n,this.options=r}},{key:"getFormattedValue",value:function(e){if(e){var t=e.value,n=e.autoFormatter;return(0,Se.createFormatter)(this.sheet.formatterService,null==n?void 0:n.formatCached).format(t)}}},{key:"toJSONImplement",value:function(e){var t=e.needDeepClone,n={type:this.type,options:t?ya(this.options):this.options,operator:t?ya(this.operator):this.operator};return"isAValidDate"!==this.operator&&(n.formulas=t?ya(this.formulas):this.formulas),n}},{key:"clone",value:function(){return new wg(ya(this.operator),ya(this.formulas),ya(this.options),this.sheet)}},{key:"freezeRef",value:function(){var e={writable:!1,configurable:!1};cg(this.type),cg(this.operator),cg(this._initialFormulas),cg(this.options),Object.defineProperties(this,{type:e,operator:e,_initialFormulas:e,options:e})}},{key:"getHash",value:function(){return xa(this.toJSON({needDeepClone:!1}))}},{key:"_getResultWhileFmlErr",value:function(){return new ut.BooleanVar(!1)}},{key:"_getResultWhileCellIsEmpty",value:function(){return new ut.BooleanVar(!0)}},{key:"_getResultWhileFmlServiceSuspended",value:function(){return new ut.BooleanVar(!0)}},{key:"_getResultWhileCalcCorrectly",value:function(e){return e.isBool()?e:new ut.BooleanVar(!1)}},{key:"_getFormulaStr",value:function(e,t){var n;return t=null!==(n=t)&&void 0!==n?n:"","OR(ISBLANK(".concat(e,"), ").concat("isAValidDate"===this.operator?"AND(\n          ISNUMBER(".concat(e,'),\n          PRIVATE_FORMATTER_VALIDATION("dateTime", "').concat(t,'")\n        )'):_g(e,this.operator,this.formulas),")")}},{key:"_getFormulaArgsForCheckInput",value:function(e){var t=ha(this.sheet.formatterService,null,e);if(!t)return{validateObj:e};var n=t.value,r=t.autoFormatter;return{validateObj:(0,ge.default)(n)?n:'"'.concat((0,we.dNX)(n),'"'),formatCode:r&&r.getFormatCode()}}}],[{key:"isValidJSON",value:function(e){var t=e.type,n=e.formulas,r=e.operator,a=e.options,o=kn(e,"formulas");return!([[t,r,a].every(Boolean),[(0,he.Z)(r),(0,ve.Z)(a)].every(Boolean),!o||Array.isArray(n)&&n.every((function(e){return(0,ge.default)(e.value)}))].some((0,ce.Z)(Boolean))||"isAValidDate"===r&&o||"isAValidDate"!==r&&!Array.isArray(n)||"isAValidDate"!==r&&!Rg(r,n))}}]),t}(ig);Eg=wg=Gi([function(e){return e}],Eg);var Tg=Sg=function(e){function t(e,n,r,a){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).call(this,"textLength",e,n,r,a))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"formulas",get:function(){return this._initialFormulas}}]),(0,C.Z)(t,[{key:"fromJSON",value:function(e,t,n,r){this.type=e,this.operator=t,this._initialFormulas=n,this.options=r}},{key:"toJSONImplement",value:function(e){var t=e.needDeepClone,n={type:this.type,formulas:t?ya(this.formulas):this.formulas,operator:t?ya(this.operator):this.operator};return this.options&&(n.options=t?ya(this.options):this.options),n}},{key:"clone",value:function(){return new Sg(ya(this.operator),ya(this.formulas),ya(this.options),this.sheet)}},{key:"freezeRef",value:function(){var e={writable:!1,configurable:!1};cg(this.type),cg(this.operator),cg(this._initialFormulas),cg(this.options),Object.defineProperties(this,{type:e,operator:e,_initialFormulas:e,options:e})}},{key:"getHash",value:function(){return xa(this.toJSON({needDeepClone:!1}))}},{key:"_getFormulaArgsForCheckInput",value:function(e){var t=ha(this.sheet.formatterService,null,e);if(!t)return{validateObj:e};var n=t.value,r=t.autoFormatter;return{validateObj:(0,ge.default)(n)?n:'"'.concat((0,we.dNX)(n),'"'),formatCode:r&&r.getFormatCode()}}},{key:"_getResultWhileFmlErr",value:function(){return new ut.BooleanVar(!1)}},{key:"_getResultWhileCellIsEmpty",value:function(){return new ut.BooleanVar(!0)}},{key:"_getResultWhileFmlServiceSuspended",value:function(){return new ut.BooleanVar(!0)}},{key:"_getResultWhileCalcCorrectly",value:function(e){return e.isBool()?e:new ut.BooleanVar(!1)}},{key:"_getFormulaStr",value:function(e){return"OR(ISBLANK(".concat(e,"), ").concat(_g(e,this.operator,this.formulas,!0),")")}}],[{key:"isValidJSON",value:function(e){var t=e.type,n=e.formulas,r=e.operator,a=e.options;return![[t,n,r].every(Boolean),[(0,Ce.default)(a),(0,ve.Z)(a)].some(Boolean),[(0,he.Z)(r)].every(Boolean),Array.isArray(n)&&n.every((function(e){return(0,ge.default)(e.value)}))].some((0,ce.Z)(Boolean))&&!!Rg(r,n)}}]),t}(ig);function Ag(e,t){if(!Ig(e))return null;switch(e.type){case"list":var n=e.options,r=e.formulas;return new hg(r,n,t);case"listFromRange":var a=e.options,o=e.formulas;return new mg(o,a,t);case"checkbox":var i=e.options,u=e.formulas;return new Cg(u,i,t);case"number":var s=e.formulas,l=e.operator,c=e.options;return new kg(l,s,c,t);case"date":var h=e.formulas,f=e.operator,d=e.options;return new Eg(f,h,d,t);case"textLength":var v=e.formulas,g=e.operator,m=e.options;return new Tg(g,v,m,t);default:return null}}function Ig(e){switch(e.type){case"list":return hg.isValidJSON(e);case"listFromRange":return mg.isValidJSON(e);case"checkbox":return Cg.isValidJSON(e);case"number":return kg.isValidJSON(e);case"date":return Eg.isValidJSON(e);case"textLength":return Tg.isValidJSON(e);default:return!1}}function bg(e,t){return"object"==(0,_.Z)(e)&&"object"==(0,_.Z)(t)?null===e||null===t?Fg(e,t):Array.isArray(e)&&Array.isArray(t)?function(e,t){if(e.length!==t.length)return!1;for(var n=e.length,r=0;r<n;){if(!bg(e[r],t[r]))return!1;r++}return!0}(e,t):function(e,t){if(Object.keys(e).length!==Object.keys(t).length)return!1;for(var n=Object.keys(e),r=n.length,a=0;a<r;){if(!bg(e[n[a]],t[n[a]]))return!1;a++}return!0}(e,t):Fg(e,t)}function Fg(e,t){return e===t}Tg=Sg=Gi([function(e){return e}],Tg);var Mg=function(){function e(t){(0,y.Z)(this,e),this._hooks=t,this._map=new Map}return(0,C.Z)(e,[{key:"has",value:function(e){return this._map.has(e)}},{key:"set",value:function(e,t){var n=this._hooks.afterRefChanged,r=this._map.get(e)||null,a=this._map.set(e,t);return n&&n(r,t),a}},{key:"get",value:function(e){return this._map.get(e)}},{key:"forEach",value:function(e){return this._map.forEach(e)}},{key:"size",get:function(){return this._map.size}}]),e}(),Vg=function(){function e(t){(0,y.Z)(this,e),this.hashToRefs=new Map,this.idToRef=new Mg({afterRefChanged:this.afterRefChanged?this.afterRefChanged.bind(this):void 0}),this.refToId=new Map,this.refCounter=new Map,this.maxId=0,this.useRefCounter=!1,"number"==typeof t&&(this.maxId=t)}return(0,C.Z)(e,[{key:"freezeRef",value:function(e){Object.freeze(e)}},{key:"setHash",value:function(e){var t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],n=this.getHash(e),r=this.hashToRefs.get(n),a=!0;if(void 0===r)a=!1,r=new Set,this.hashToRefs.set(n,r);else if(t)for(var o=r.entries(),i=o.next();!i.done;){if(this.equals(e,i.value[0]))return{ref:i.value[0],hasSet:!0};i=o.next()}return this.freezeRef(e),r.add(e),{ref:e,hasSet:a}}},{key:"getIdByRef",value:function(e){return this.refToId.get(e)}},{key:"getById",value:function(e){return this.idToRef.get(e)}},{key:"getByVal",value:function(e){var t=this.getHash(e),n=this.hashToRefs.get(t);if(void 0!==n)for(var r=n.entries(),a=r.next();!a.done;){if(this.equals(e,a.value[0]))return a.value[0];a=r.next()}}},{key:"add",value:function(e){var t=this.setHash(e),n=t.ref;return t.hasSet&&this.refToId.has(n)||(this.maxId++,this.idToRef.set(this.maxId,n),this.refToId.set(n,this.maxId)),this.useRefCounter&&this.incRefCounter(n),{ref:n,id:this.toId(n)}}},{key:"foreach",value:function(e){this.idToRef.forEach(e)}},{key:"addById",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]&&arguments[2];if(null!=t){var r=this.setHash(t,n),a=r.ref;if(this.maxId<e&&(this.maxId=e),this.idToRef.has(e)){var o=this.idToRef.get(e);if(this.refToId.delete(o),this.useRefCounter){var i=this.refCounter.get(o)||0;this.refCounter.set(a,i),this.refCounter.delete(o)}}return this.idToRef.set(e,a),this.refToId.set(a,e),{ref:a,id:e}}}},{key:"toId",value:function(e){return this.refToId.get(e)}},{key:"decRefCounter",value:function(e){if(!this.useRefCounter)return!1;var t=this.refCounter.get(e);return!!t&&(this.refCounter.set(e,t-1),!0)}},{key:"incRefCounter",value:function(e){if(!this.useRefCounter)return!1;var t=this.refCounter.get(e)||0;return this.refCounter.set(e,t+1),!0}},{key:"setUseRefCounter",value:function(e){this.useRefCounter=e}},{key:"getUseRefCounter",value:function(){return this.useRefCounter}},{key:"setCounterById",value:function(e,t){if(!this.useRefCounter)return!1;if(!(0,ge.default)(t))return!1;var n=this.getById(e);return!!n&&(this.refCounter.set(n,t),!0)}},{key:"getCounterById",value:function(e){if(!this.useRefCounter)return 0;var t=this.getById(e);return t&&this.refCounter.get(t)||0}},{key:"toJSON",value:function(){var e=this,t=!(arguments.length>0&&void 0!==arguments[0])||arguments[0],n={};return t?this.foreach((function(t,r){var a=JSON.parse(JSON.stringify(t));if(n[r]=a,e.useRefCounter){var o=e.refCounter.get(t);n[r].refCount=o||0}})):this.foreach((function(t,r){if(n[r]=t,e.useRefCounter){var a=e.refCounter.get(t);n[r].refCount=a||0}})),n}},{key:"toArray",value:function(e){for(var t=new Array(Math.max(0,this.maxId)).fill(null),n=0;n<=this.maxId;n++){var r=this.idToRef.get(n);r&&(t[n]=e?r:this.serializeRef(r))}return t}},{key:"findSameRefs",value:function(e){var t=this,n=[];return this.foreach((function(r){t.equals(e,r)&&n.push(r)})),n}},{key:"isEmpty",value:function(){return 0===this.refToId.size}},{key:"serializeRef",value:function(e){return JSON.parse(JSON.stringify(e))}},{key:"getRefCount",value:function(){return this.idToRef.size}}]),e}(),Ng=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).call(this,-1))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"getHash",value:function(e){return xa(e)}},{key:"equals",value:function(e,t){return bg(e,t)}}]),t}(Vg),Og=function(e){function t(e){var n;return(0,y.Z)(this,t),(n=(0,d.Z)(this,(0,v.Z)(t).call(this))).refs=e,n}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"setDefaultRef",value:function(e){this.defaultRef=e}},{key:"getDefaultRef",value:function(){return this.defaultRef}},{key:"getRefMgr",value:function(){return this.refs}},{key:"setRef",value:function(e,t,n){if(null!=n){var r=this.refs.add(n).id;return this.set(e,t,r),r}this.set(e,t,null)}},{key:"getRef",value:function(e,t){var n=this.get(e,t);return null==n?null:this.refs.getById(n)||null}},{key:"setById",value:function(e,n,r){var a=!(arguments.length>3&&void 0!==arguments[3])||arguments[3];return a?!!this.refs.getById(r)&&(this.set(e,n,r,a),!0):((0,f.Z)((0,v.Z)(t.prototype),"set",this).call(this,e,n,r),!0)}},{key:"iterRef",value:function(e,t,n,r){var a=this;return this.iter(e,t,n,r).map((function(e){return a.refs.getById(e)||null})).filter((function(e){return null!=e}))}},{key:"iterRefWithPos",value:function(e,t,n,r){var a=this;return this.iterWithPos(e,t,n,r).map((function(e){return[a.refs.getById(e[0]),e[1]]}))}},{key:"clearCellRef",value:function(e,t){if(this.refs.getUseRefCounter()){var n=this.getRef(e,t);n&&this.refs.decRefCounter(n)}}},{key:"set",value:function(e,n,r){var a=!(arguments.length>3&&void 0!==arguments[3])||arguments[3];a&&this.clearCellRef(e,n),(0,f.Z)((0,v.Z)(t.prototype),"set",this).call(this,e,n,r)}},{key:"clear",value:function(e,n,r,a){for(var o=this.iter(e,n,r,a);o.next();){var i=o.position();this.clearCellRef(i.row,i.col)}(0,f.Z)((0,v.Z)(t.prototype),"clear",this).call(this,e,n,r,a)}}]),t}(Kv);function xg(e){for(var t in e)return null!=e[t]&&"number"==typeof e[t].refCount;return!1}function Zg(e){for(var t in e)return!1;return!0}var Dg=[jg,$g];function Pg(e,t,n,r,a){var o,i=null==a?void 0:a.skipFormulaCompile,u=null==a?void 0:a.formulaCompileCtx,s=null==a?void 0:a.stringVarRefMap;if((0,ve.Z)(r)&&r.tokens&&r.tree){var l=e.parent.calcEngine;try{return l.deserializeFormula(r,new Oi(t,n,1,1,e))}catch(e){console.log("value2variant deserializeFormula err: ",e)}}return o=i?Dg:[jg,function(r){return function(e){return e.length>1&&("="===e[0]||"+"===e[0])}(r)?zg(e,t,n,r,u):null},$g],Lg(r,o,s)}function Lg(e,t,n){if((0,le.Z)(e))return ut.BOOLEAN_VAR_MAP[e?ut.BooleanConstant.TRUE:ut.BooleanConstant.FALSE];if((0,ge.default)(e))return new ut.NumberVar(e);if((0,he.Z)(e)){var r=(0,we.$ES)(e);t||(t=Dg);for(var a=0;a<t.length;a++){var o=t[a](r);if(null!=o)return o}return n?n.add(r):new ut.StringVar(r)}return e instanceof Date?new ut.NumberVar(ke.SheetDate.fromUTCDate(e).toNumber()):e instanceof ke.SheetDate?new ut.NumberVar(e.toNumber()):e instanceof ut.BaseVar?e:null}var Bg=ut.ERROR_VAR_MAP,Ug=ut.BOOLEAN_VAR_MAP,Hg=ut.BooleanConstant.TRUE,Wg=ut.BooleanConstant.FALSE;function jg(e){var t=e.toUpperCase();if("#"===e[0]){var n=Bg[t];if(n)return n}return t===Hg?Ug[Hg]:t===Wg?Ug[Wg]:null}function zg(e,t,n,r,a){var o="="===r[0]?r.substring(1):r,i=Object.assign({ref:new Oi(t,n,1,1,e),spread:e.parent},a),u=e.getCalcEngine().compile(o,i),s=u.errors,l=u.formulaVar;return s?new ut.StringVar(r):l}var Gg=/^\/OADate\((-?\d+\.?\d*)\)\//,Jg="/OADate",qg=Jg.length;function $g(e){for(var t=0;t<qg;t++)if(e[t]!==Jg[t])return null;var n=Gg.exec(e);return null!=n&&n[1]?new ut.NumberVar(parseFloat(n[1])):null}function Yg(e,t,n,r){var a=t.segmentArray;if(a)return new xv(e,a).getText(e.userLanguage);var o=t.variant,i=o?o.getValue(r):"";return(n.formatter||(0,Se.createFormatter)(e.formatterService)).format(i)}function Kg(e,t,n,r,a){var o=e.getActualFormatter(t,n,a),i=r.segmentArray,u=r.variant;return{text:Yg(e.parent,{segmentArray:i,variant:u},{formatter:o}),variant:u||null,segmentArray:i||null}}var Xg,Qg,em,tm=function(){var e=new Map([{formatName:"01/08/2017",formatCode:"dd/mm/yyyy"},{formatName:"01/08/17",formatCode:"dd/mm/yy"},{formatName:"1/8/17",formatCode:"d/m/yy"},{formatName:"1.8.17",formatCode:"d.m.yy"},{formatName:"01 August 2017",formatCode:"dd mmmm yyyy"},{formatName:"1 August 2017",formatCode:"d mmmm yyyy"},{formatName:"2017/8/1",formatCode:"yyyy/m/d"},{formatName:"2017年8月1日 星期四",formatCode:"yyyy/mm/dd aaaa"},{formatName:"2017年8月1日",formatCode:"yyyy年m月d日"},{formatName:"2017年8月",formatCode:"yyyy年m月"},{formatName:"8月1日",formatCode:"m月d日"},{formatName:"星期四",formatCode:"aaaa"},{formatName:"周四",formatCode:"aaa"},{formatName:"17/8/1",formatCode:"yy/m/d"},{formatName:"8/1",formatCode:"m/d"},{formatName:"8/1/17",formatCode:"m/d/yy"},{formatName:"08/01/17",formatCode:"mm/dd/yy"},{formatName:"2017年",formatCode:"yyyy年"},{formatName:"17年",formatCode:"yy年"}].map((function(e){return[e.formatName,{formatCode:e.formatCode,name:e.formatName,teaName:"date(".concat(e.formatCode,")"),type:5,formatterName:e.formatName}]})));return function(){var e=we.Ps3.getLanguage().toLowerCase();return"zh"===e||"zh-hk"===e||"zh-tw"===e?["2017年8月1日 星期四","2017年8月1日","2017/8/1","17/8/1","2017年8月","8月1日","8/1","星期四","周四","8/1/17","08/01/17","2017年","17年"]:"ja"===e?["2017年8月1日","2017/8/1","2017年8月","8月1日","8/1","8/1/17","08/01/17"]:["01/08/2017","01/08/17","1/8/17","1.8.17","01 August 2017","1 August 2017"]}().map((function(t){var n=e.get(t);if(!n)throw new Error("item: ".concat(t,", must be defined"));return n}))};function nm(){return void 0===Xg&&(Xg=[{formatCode:"General",name:fn("sheet.conventional"),teaName:"general",type:0,formatterName:"general",isMatch:function(e,t){return/^general$/i.test(t)}},{formatCode:"@",name:fn("sheet.plain_text"),teaName:"plain_text",type:1,formatterName:"plain_text"},{formatCode:"0",name:fn("LarkCCM_Sheets_Toolbar_NumberRounded_Menu"),format:"1024",teaName:"number_without_separator",type:2,formatterName:"digital_without_separator"},{formatCode:"#,##0",name:fn("LarkCCM_Sheets_Toolbar_Number_Separator_Menu"),format:"1,024",teaName:"number",type:2,formatterName:"digital"},{formatCode:"#,##0.00",name:fn("LarkCCM_Sheets_Toolbar_Number_Decimal_Menu"),format:"1,024.56",teaName:"number(rounded)",type:2,formatterName:"digital_round",isMatch:function(e,t){return/^#,##0\.0+$/.test(t)}},{formatCode:"0%",name:fn("LarkCCM_Sheets_Toolbar_PercentageRounded_Menu"),format:"10%",teaName:"percentage(rounded)",type:3,formatterName:"percentage_rounded"},{formatCode:"0.00%",name:fn("LarkCCM_Sheets_Toolbar_Percentage_Decimal_Menu"),format:"10.24%",teaName:"percentage",type:3,formatterName:"percentage",isMatch:function(e,t){return/^0\.0+%$/.test(t)}},{formatCode:"0.00E+00",name:fn("sheet.scientific_count"),format:"1.02E+03",teaName:"scientific",type:2,formatterName:"scientific",isMatch:function(e,t){return/^0(\.0+)*E\+00$/.test(t)}},{formatCode:"¥#,##0",name:fn("LarkCCM_Sheets_Toolbar_CNY_Menu"),format:"¥1,024",teaName:"cny(rounded)",type:4,formatterName:"cyn_rounded"},{formatCode:"¥#,##0.00",name:fn("LarkCCM_Sheets_Toolbar_CNY_Decimal_Menu"),format:"¥1,024.56",teaName:"cny",type:4,formatterName:"cyn",isMatch:function(e,t){return/^¥#,##0\.0+$/.test(t)}},{formatCode:"$#,##0",name:fn("sheet.currency_dollar_rounded"),format:"$1,024",teaName:"dollar(rounded)",type:4,formatterName:"dollar_rounded"},{formatCode:"$#,##0.00",name:fn("LarkCCM_Sheets_Toolbar_USD_Decimal_Menu"),format:"$1,024.56",teaName:"dollar",type:4,formatterName:"dollar",isMatch:function(e,t){return/^\$#,##0\.0+$/.test(t)}},{formatCode:fn("sheet.format_code.date_with_slash"),name:fn("sheet.date"),format:fn("sheet.format_text.date_with_slash"),teaName:"date(yyyy/mm/dd)",type:5,formatterName:"date_with_slash",isMatch:function(e,t){var n=(0,Se.createFormatter)(e.formatterService,t);return(0,Se.hasDate)(n)&&!(0,Se.hasTime)(n)}},{formatCode:fn("sheet.format_code.date_with_hyphen"),name:fn("sheet.date"),format:fn("sheet.format_text.date_with_hyphen"),teaName:"date(yyyy-mm-dd)",type:5,formatterName:"date_with_hyphen",isMatch:function(e,t){var n=(0,Se.createFormatter)(e.formatterService,t);return(0,Se.hasDate)(n)&&!(0,Se.hasTime)(n)}},{formatCode:"HH:mm:ss",name:fn("sheet.time"),format:"23:24:25",teaName:"time",type:5,formatterName:"time",isMatch:function(e,t){var n=(0,Se.createFormatter)(e.formatterService,t);return!(0,Se.hasDate)(n)&&(0,Se.hasTime)(n)}},{formatCode:fn("sheet.format_code.date_time"),name:fn("sheet.data_time"),format:fn("sheet.format_text.date_time"),teaName:"datetime",type:5,formatterName:"date_time",isMatch:function(e,t){var n=(0,Se.createFormatter)(e.formatterService,t);return(0,Se.hasDate)(n)&&(0,Se.hasTime)(n)}}].concat((0,m.Z)(tm()))),Xg}function rm(){return void 0===Qg&&(Qg=new Map(nm().map((function(e){return[e.formatterName,e]})))),Qg}function am(e){return(void 0===em&&(em=new Map(nm().map((function(e){return[e.formatCode,e]})))),em).get(e)}function om(e){return rm().get(e)}function im(e){return rm().get(e).formatCode}function um(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"";Number.isNaN(e)&&(e=2);var r=0===e?"":".".concat("0".repeat(e)),a=n||t?"#,##":"",o="".concat(a,"0").concat(r);if(n){var i=(0,we.MAs)().get(n);if(!i)throw Error("currencyInfo is not found");var u=i.position,s=i.symbol,l=i.locale;o=u===we.Gvu.prefix?"[$-".concat(l,"]").concat(s).concat(a,"0").concat(r):"".concat(a,"0").concat(r).concat(s,"[$-").concat(l,"]")}return["".concat(o,"_);(").concat(o,")"),o]}function sm(e,t){null!=t&&"string"!=typeof t&&(t=t.formatCached||im("general"));var n,r=_n(nm());try{for(r.s();!(n=r.n()).done;){var a=n.value;if(a.isMatch&&a.isMatch(e,t))return a.formatCode}}catch(e){r.e(e)}finally{r.f()}return t}var lm=function(e,t){if(!e)return!1;var n=e.getSelections();return function(e,t,n){var r=(n||{}).includeAutoFormatter,a=void 0===r||r;return t.some((function(t){return!!e.iterStyle(t.rowFrom(),t.colFrom(),t.rowCount(),t.colCount()).first_if((function(e){var t=e.formatter,n=e.autoFormatter;return!!Boolean(t)||a&&Boolean(n)}))}))}(e,n,t)},cm=function(e,t){if(!e)return new Set;var n=e.getSelections();return function(e,t,n){var r=(n||{}).includeAutoFormatter,a=void 0===r||r,o=new Set;return t.forEach((function(t){e.iterStyle(t.rowFrom(),t.colFrom(),t.rowCount(),t.colCount()).forEach((function(e){var t=e.formatter,n=e.autoFormatter;t?o.add(t.getFormatCode()):a&&n&&o.add(n.getFormatCode())}))})),o}(e,n,t)},hm=function(e){var t,n="¥";if(null!==(t=e.service.spread)&&void 0!==t&&t.locale){var r,a=(0,we.sBS)(null===(r=e.service.spread)||void 0===r?void 0:r.locale);a&&(n=a[1].symbol)}e.info.customData={autoFormat:n+"#,##0.00"}},fm=",",dm=function(){function e(t){(0,y.Z)(this,e),this._spread=t,this.list=[]}return(0,C.Z)(e,[{key:"fromJSON",value:function(e){var t=this;if(e&&e.length)return this.clear(),e.forEach((function(e){var n={};Array.isArray(e.value)?n.segmentArray=e.value:n.variant=Lg(e.value),e.autoFormatter&&(n.autoFormatter=t.importFormatter(e.autoFormatter)),t.add(n)})),this}},{key:"toJSON",value:function(){var e=[];return this.list.forEach((function(t){var n;if(t.segmentArray)n=t.segmentArray;else{if(!t.variant)return;n=t.variant.getValue()}if(t.autoFormatter){var r=t.autoFormatter.getFormatCode();if(r)return void e.push({value:n,autoFormatter:r})}e.push({value:n})})),e}},{key:"clone",value:function(){var t=new e(this._spread);return t.fromJSON(this.toJSON()),t}},{key:"fromSingleValue",value:function(e,t){if(this.clear(),e.segmentArray)this.addBySegmentArray(e.segmentArray,t);else if(e.variant)if(e.variant.isString()){var n=e.variant.getValue();this.addByText(n,t)}else{var r={variant:e.variant};t&&(r.autoFormatter=t),this.add(r)}return this}},{key:"fromString",value:function(e,t){return this.clear(),this.addByText(e,t),this}},{key:"addByTextNoSplit",value:function(e,t){var n=(0,we.Tcw)(e);Array.isArray(n)&&1===n.length?this.addBySegmentArray(n,t):this.add(this.stringToMultipleValue(e,t))}},{key:"addByText",value:function(e,t){var n=this;e&&e.split(fm).forEach((function(e){if(e){var r=(0,we.Tcw)(e);Array.isArray(r)?n.addBySegmentArray(r,t):n.add(n.stringToMultipleValue(r,t))}}))}},{key:"add",value:function(e){this.list.push(e)}},{key:"forEach",value:function(e){for(var t=this.list.length,n=0;n<t;)e(this.get(n),n),n++}},{key:"get",value:function(e){return this.list[e]}},{key:"set",value:function(e,t){this.list[e]=t}},{key:"clear",value:function(){this.list=[]}},{key:"stringToMultipleValue",value:function(e,t){var n=(0,Se.getPreferredFormatter)(this._spread.formatterService,e,t),r=n.value,a=n.formatter,o={variant:Lg(r)};return t?o.autoFormatter=t:a&&!function(e,t){if(e){var n=e.getFormatCode();return t.includes(n)}return!1}(a,["@","General"])&&(o.autoFormatter=a),o}},{key:"addBySegmentArray",value:function(t,n){var r=this,a=[],o=t.length;t.forEach((function(t,i){if(t.type===we.K6s.TEXT&&e.isTextCanSplit(t.text)){var u=t.text.split(fm),s=u.shift(),l=u.pop();a.length?(s&&a.push(r.createTextSegment(s)),r.add({segmentArray:a}),a=[]):s&&r.addByText(s,n),r.addByText(u.join(fm),n),l&&(i===o-1?r.addByText(l,n):a.push(r.createTextSegment(l)))}else a.push(t)})),a.length&&this.add({segmentArray:a})}},{key:"getFirstItem",value:function(){return this.get(0)||{variant:null}}},{key:"toStringArray",value:function(t){var n=this;return this.list.map((function(r){return e.multipleValueItemToString(n._spread,r,t)})).filter((function(e){return!!e}))}},{key:"mergeToString",value:function(e){return this.toStringArray(e).join(fm)}},{key:"toStringWithFormatterArray",value:function(t){var n=this;return this.list.map((function(r){return{text:e.multipleValueItemToString(n._spread,r,t),formatter:r.autoFormatter}})).filter((function(e){return!!e.text}))}},{key:"mergeToSingleValue",value:function(t){var n=this;if(this.list.length<=1)return this.getFirstItem();if(this.list.some((function(e){return!!e.segmentArray}))){var r=[];return this.list.forEach((function(a,o){if(a.segmentArray)Array.prototype.push.apply(r,a.segmentArray);else{var i=e.multipleValueItemToString(n._spread,a,t);r.push(n.createTextSegment(i))}o!==n.list.length-1&&r.push(n.createTextSegment(fm))})),{segmentArray:r}}return{variant:new ut.StringVar(this.mergeToString(t))}}},{key:"createTextSegment",value:function(e){return{type:we.K6s.TEXT,text:e}}},{key:"importFormatter",value:function(e){return"string"==typeof e?""===e?(0,Se.createFormatter)(this._spread.formatterService):(0,Se.createFormatter)(this._spread.formatterService,e):e instanceof Se.Formatter?e:(0,Se.createFormatter)(this._spread.formatterService)}},{key:"length",get:function(){return this.list.length}},{key:"spread",get:function(){return this._spread}}],[{key:"isCanSingleToMultiple",value:function(t,n,r){var a=n.variant,o=n.segmentArray;if(o)return o.some((function(t){return t.type===we.K6s.TEXT&&e.isTextCanSplit(t.text)}));if(a){if(!a.isString())return!1;var i=e.multipleValueItemToString(t,{segmentArray:n.segmentArray,variant:n.variant,autoFormatter:r||void 0},{formatter:r||null});return e.isTextCanSplit(i)}return!1}},{key:"isTextCanSplit",value:function(e){return e.indexOf(fm)>=0}},{key:"multipleValueItemToString",value:function(e,t,n){return Yg(e,{variant:t.variant,segmentArray:t.segmentArray},{formatter:n.formatter||t.autoFormatter||null})}}]),e}();function vm(e){4===e&&(e=0);var t=0;switch(e){case 0:case 6:t=511;break;case 1:t=1;break;case 2:t=24;break;case 3:t=2;break;case 5:t=128}return t}function gm(e,t){var n,r=e.getListItem(t);if(e.options.shouldHighlightValidData){var a={},o=e.options.colors;if(o.length>0)for(var i=0;i<r.length;++i){var u=o[0].length,s=o[Math.floor(i/u)];if(s){var l=s[i%u];if(l){var c=r[i];a[c]||(a[c]=l)}}}var h=Object.assign({},e.options);delete h.colors,n=Object.assign({},h,{listItemColorMap:a})}else n=e.options;return new hg(r,n,e.sheet)}function mm(e){if(null==e)throw Error("[SHEET ERROR] Dropdown Data Invalid, can not be transformed! ");var t=e.list,n=function(e){var t=e.isEnableOptionColor,n=e.list,r=e.color;if(!t||!n||!r)return{shouldHighlightValidData:!1};var a={};return n.forEach((function(e,t){a[e]=r[t]})),{listItemColorMap:a,shouldHighlightValidData:!0}}(e);return{type:"list",formulas:Array.isArray(t)?(0,m.Z)(t):[],options:Object.assign({supportMultipleValues:!1,ignoreCase:!1},n)}}var pm=function(){function e(){(0,y.Z)(this,e)}return(0,C.Z)(e,null,[{key:"isSameDataValidationJSON",value:function(e,t){return e.type===t.type&&(0,pe.default)(e,t)}},{key:"findRanges",value:function(e,t,n){var r,a=[],o=n.range;0!==e.size&&(r=n.iterVisible?t.cellModel.iterVisibleDataValidation(o.rowFrom(),o.colFrom(),o.rowTo(),o.colTo()):t._getModel().iterDataValidationWithPos(o.rowFrom(),o.colFrom(),o.rowCount(),o.colCount()),a=this.findDataValidationRefRange(e,t,r));return a}},{key:"contentContainValues",value:function(e,t,n,r){return n.getTextWithValues(e,t,!0).map((function(e){return e.text})).some((function(e){return r.includes(e)}))}},{key:"findDataValidationRefRange",value:function(e,t,n){var r=[];return n.forEach((function(n){var a=(0,p.Z)(n,2),o=a[0],i=a[1],u=i.row,s=i.col;e.has(o)&&r.push(new Zi(u,s,t))})),r}}]),e}();function ym(e,t,n,r){var a=e.getDataValidation(t,n);if(!a||!Mm(a))return!1;if(e.getMultipleValues(t,n))return!1;var o=e.getImmutableContent(t,n);if(!o)return!1;var i=e.getActualFormatter(t,n,r,!0)||void 0;return dm.isCanSingleToMultiple(e.parent,o,i)}function Cm(e,t,n,r){var a=e.getImmutableContent(t,n),o=e.getActualFormatter(t,n,r,!0)||void 0,i=new dm(e.parent);return a&&i.fromSingleValue(a,o),i}function _m(e,t,n,r,a,o,i,u){var s=arguments.length>8&&void 0!==arguments[8]?arguments[8]:0,l="",c="";if(e&&(l&&(l+="_"),l+="checkbox"),t&&(l&&(l+="_"),l+="list_single"),n&&(l&&(l+="_"),l+="list_multiple"),r&&(c&&(c+="_"),c+="colored"),a&&(c&&(c+="_"),c+="default"),l){var h={action:"apply_valid_rule",valid_type:l,source:o};c&&(h.op_item=c),we.Ps3.collectSuiteEvent("sheet_opration",h)}128&vm(s)&&u&&i&&we.Ps3.ccmEventTracking&&we.Ps3.ccmEventTracking("ccm_sheet_content_page_click",Object.assign({},(0,we.dK5)(),{click:"add_data_valid_cell",target:"none",action_type:o,valid_num:i,valid_type:u}))}function Rm(e,t,n,r,a){e.iterContentWithPos(t,n,r,a).forEach((function(t){var n=(0,p.Z)(t,2),r=n[0],a=n[1],o=a.row,i=a.col,u=r.multipleValues;if(u){var s=e.getDataValidation(o,i);if(!s||!Mm(s)){var l=e.getUserFormatter(o,i)||null,c=u.mergeToSingleValue({formatter:l}),h=c.segmentArray,f=c.variant,d=null;h?d=h:f&&(d=f.getValue()),e.setValue(o,i,d)}}}))}function wm(e,t,n,r){var a=e.getActualFormatter(t,n,r,!0),o=e.getImmutableContent(t,n);if(o){var i=o.multipleValues,u=o.segmentArray;return i?i.mergeToSingleValue({formatter:a}).segmentArray:u}}function km(e){return"list"===e.type}function Sm(e){return"listFromRange"===e.type}function Em(e){return"checkbox"===e.type}function Tm(e){return"date"===e.type}function Am(e){return"number"===e.type}function Im(e){return"textLength"===e.type}function bm(e){return km(e)||Sm(e)}function Fm(e){return"list"===e.type||"listFromRange"===e.type}function Mm(e){return bm(e)&&e.options.supportMultipleValues}function Vm(e){return Fm(e)&&e.options.supportMultipleValues}function Nm(e){return bm(e)&&!e.options.supportMultipleValues}function Om(e,t,n){var r,a=[],o=e._getModel(),i=function(e,t){var n,r=[e],a=_n(t);try{for(a.s();!(n=a.n()).done;){var o,i=n.value,u=[],s=_n(r);try{for(s.s();!(o=s.n()).done;){var l=o.value;u.push.apply(u,(0,m.Z)(l.sub(i)))}}catch(e){s.e(e)}finally{s.f()}r=u}}catch(e){a.e(e)}finally{a.f()}return r}(new Ni(e),n),u=new Set(o.findSameDataValidation(t)),s=_n(i);try{for(s.s();!(r=s.n()).done;){var l,c=r.value,h=_n(bh(pm.findRanges(u,e,{iterVisible:!1,range:c}),e));try{for(h.s();!(l=h.n()).done;){var f=l.value;a.push(f)}}catch(e){h.e(e)}finally{h.f()}}}catch(e){s.e(e)}finally{s.f()}return a}function xm(e){return e&&e.options&&(!e.options.handledWayOnInvalidData||2&e.options.handledWayOnInvalidData)}function Zm(e){var t,n=null==e||null===(t=e.options)||void 0===t?void 0:t.handledWayOnInvalidData;return!!n&&1&n&&!xm(e)}function Dm(e){return!(e&&!bm(e))&&(null==e?void 0:e.options)&&e.options.supportMultipleValues}function Pm(e){return e&&Tm(e)&&!!e.options.isDatePickerVisibleInCell}function Lm(e){var t,n=null===(t=e.getSpecialInfo())||void 0===t?void 0:t.checkboxInfo;return Boolean(n&&n.visible)}function Bm(e,t,n){var r=[],a=t.sheetView().getVisibleRangeWithFrozen()||new Oi(0,0,0,0,n);return n.cellModel.iterVisibleDataValidation(a.rowFrom(),a.colFrom(),a.rowTo(),a.colTo()).forEach((function(t){var a=(0,p.Z)(t,2),o=a[0],i=a[1];if(e!==o){var u=e.toJSON({needDeepClone:!1}),s=o.toJSON({needDeepClone:!1});(0,pe.default)(u,s)&&r.push(new Oi(i.row,i.col,1,1,n))}else r.push(new Oi(i.row,i.col,1,1,n))})),r}var Um=function(){function e(t){(0,y.Z)(this,e),this.iter=t,this.exportType=0}return(0,C.Z)(e,[{key:"exportCells",value:function(e,t){for(var n=this.iter.next();null!==n;n=this.iter.next()){var r=this.iter.position(),a=e(r.row,r.col);this.exportToCell(a,n,t)}}},{key:"isIgnoreCellNode",value:function(e,t){return!1}},{key:"serializeCells",value:function(e,t){if(this.serializeCell)for(var n=this.iter.next();null!==n;n=this.iter.next())if(!this.isIgnoreCellNode(n,t)){var r=this.iter.position();t.cellPosition=r;var a=e(r.row,r.col);this.serializeCell(a,n,t)}}},{key:"exportExtraInfo",value:function(e){}},{key:"setExportType",value:function(e){this.exportType=e}},{key:"exportToCell",value:function(e,t,n){}},{key:"serializeToMutations",value:function(e){}}]),e}(),Hm="#bacefd";function Wm(e,t){var n,r=function(e){return e?{handledWayOnInvalidData:e.handledWayOnInvalidData,helpText:e.helpText}:void 0}(e.options);switch(e.type){case"list":case"listFromRange":var a={supportMultipleValues:e.options.supportMultipleValues,ignoreCase:e.options.ignoreCase,isDropdownIconHiddenInCell:e.options.isDropdownIconHiddenInCell,shouldHighlightValidData:e.options.shouldHighlightValidData},o=e.options.shouldHighlightValidData;if("list"===e.type){for(var i,u,s=e.formulas,l=0;l<s.length;l++){var c=s[l],h=t.strings.addValue(c);if(u||(u=new Array(s.length)),u[l]=h,o&&e.options.listItemColorMap){var f,d=e.options.listItemColorMap[c];i||(i=new Array(s.length)),i[l]=t.colors.addValue(null!==(f=d)&&void 0!==f?f:Hm)}}n={type:we.B2l.DataValidationConditionType.DataValidationConditionType_List,listDataValidation:{listSourceType:we.B2l.ListSourceType.ListSourceType_Items,listItemFormula:{listItemIds:u,listItemColorIds:i},options:a,tips:r}}}else{var v;if(o&&e.options.colors.length)for(var g=e.options.colors,m=0;m<g.length;m++)for(var p=g[m],y=0;y<p.length;y++){var C,_=p[y];v||(v=new Array(g.length*p.length)),v[m*p.length+y]=t.colors.addValue(null!==(C=_)&&void 0!==C?C:Hm)}n={type:we.B2l.DataValidationConditionType.DataValidationConditionType_List,listDataValidation:{listSourceType:we.B2l.ListSourceType.ListSourceType_Range,listRangeFormula:{refRangeString:e.formulas[0],listItemColorIds:v},options:a,tips:r}}}break;case"number":n={type:we.B2l.DataValidationConditionType.DataValidationConditionType_Number,numberDataValidation:{operator:zm(e.operator),formulas:Jm(e.formulas),options:{validNumType:e.options.validNumType},tips:r}};break;case"date":n={type:we.B2l.DataValidationConditionType.DataValidationConditionType_Date,dateDataValidation:{operator:zm(e.operator),formulas:Jm(e.formulas),options:{isDatePickerVisibleInCell:e.options.isDatePickerVisibleInCell},tips:r}};break;case"textLength":n={type:we.B2l.DataValidationConditionType.DataValidationConditionType_TextLength,textLengthDataValidation:{operator:zm(e.operator),formulas:Jm(e.formulas),tips:r}};break;case"checkbox":n={type:we.B2l.DataValidationConditionType.DataValidationConditionType_Checkbox,checkboxDataValidation:{formulas:e.formulas,tips:r}}}return n}function jm(e,t,n){var r,a,o=t.valueRefDelta,i=t.resourceRefDelta;switch(e.type){case we.B2l.DataValidationConditionType.DataValidationConditionType_List:var u=e.listDataValidation,s=u.listSourceType,l=u.listItemFormula,c=u.listRangeFormula,h=u.options,f=u.tips;if(s===we.B2l.ListSourceType.ListSourceType_Items){var d,v,g;if(null!=l&&null!==(d=l.listItemIds)&&void 0!==d&&d.length){g=new Array(l.listItemIds.length);for(var p=0;p<l.listItemIds.length;p++){var y,C,_=o.strings[l.listItemIds[p]];if(g[p]=_,null!=h&&h.shouldHighlightValidData)if(v||(v={}),null!==(y=l.listItemColorIds)&&void 0!==y&&y.length){var R=l.listItemColorIds[p];v[_]=i.colors[R]}else(null===(C=l.listItemColors)||void 0===C?void 0:C.length)&&(v[_]=l.listItemColors[p])}}a={type:"list",formulas:g,options:Object.assign({},qm(f),{},$m(h),{listItemColorMap:v})}}else if(s===we.B2l.ListSourceType.ListSourceType_Range){var w,k,S,E;if(null!=h&&h.shouldHighlightValidData)if(E=[],null!=c&&null!==(w=c.listItemColorIds)&&void 0!==w&&w.length)for(var T=c.listItemColorIds,A=function(e,t){if(!t)return 0;var n=new Zi(-1,-1,e),r=ql(t,{spread:e.parent,refStyle:"A1",ref:n});return r&&r.isRef()?r.colCount(!0):0}(n,c.refRangeString),I=T.length/A,b=0;b<I;b++)for(var F=0;F<A;F++){var M=T[b*A+F];E[b]||(E[b]=[]),E[b].push(i.colors[M])}else if(null!=c&&null!==(k=c.listRangeColors)&&void 0!==k&&null!==(S=k.rows)&&void 0!==S&&S.length)for(var V=c.listRangeColors.rows,N=0;N<V.length;N++){var O=V[N];O.cols&&E.push((0,m.Z)(O.cols))}a={type:"listFromRange",formulas:[null==c?void 0:c.refRangeString],options:Object.assign({},qm(f),{},$m(h),{colors:E})}}break;case we.B2l.DataValidationConditionType.DataValidationConditionType_Number:var x=e.numberDataValidation,Z=x.options,D=x.formulas,P=x.operator,L=x.tips,B=Jm(D);a={type:"number",operator:Gm(P,!1),options:Object.assign({},qm(L),{validNumType:null==Z?void 0:Z.validNumType})},B&&(a.formulas=B);break;case we.B2l.DataValidationConditionType.DataValidationConditionType_Date:var U=e.dateDataValidation;a={type:"date",operator:Gm(null==U?void 0:U.operator,!0),formulas:Jm(U.formulas),options:Object.assign({},qm(U.tips),{isDatePickerVisibleInCell:null==U||null===(r=U.options)||void 0===r?void 0:r.isDatePickerVisibleInCell})};break;case we.B2l.DataValidationConditionType.DataValidationConditionType_TextLength:var H=e.textLengthDataValidation,W=H.operator,j=H.formulas,z=H.tips;a={type:"textLength",operator:Gm(W),formulas:Jm(j),options:qm(z)};break;case we.B2l.DataValidationConditionType.DataValidationConditionType_Checkbox:var G=e.checkboxDataValidation;a={type:"checkbox",formulas:G.formulas,options:qm(G.tips)}}return a}function zm(e){switch(e){case"isAValidNumber":case"isAValidDate":return we.B2l.DataValidationOperator.NumberDataValidationOperator_IsValid;case"between":return we.B2l.DataValidationOperator.NumberDataValidationOperator_Between;case"notBetween":return we.B2l.DataValidationOperator.NumberDataValidationOperator_NotBetween;case"equalTo":return we.B2l.DataValidationOperator.NumberDataValidationOperator_EqualTo;case"notEqualTo":return we.B2l.DataValidationOperator.NumberDataValidationOperator_NotEqualTo;case"greaterThan":return we.B2l.DataValidationOperator.NumberDataValidationOperator_GreaterThan;case"lessThan":return we.B2l.DataValidationOperator.NumberDataValidationOperator_LessThan;case"greaterThanOrEqualTo":return we.B2l.DataValidationOperator.NumberDataValidationOperator_GreaterThanOrEqualTo;case"lessThanOrEqualTo":return we.B2l.DataValidationOperator.NumberDataValidationOperator_LessThanOrEqualTo;default:return}}function Gm(e,t){switch(e){case we.B2l.DataValidationOperator.NumberDataValidationOperator_IsValid:return t?"isAValidDate":"isAValidNumber";case we.B2l.DataValidationOperator.NumberDataValidationOperator_Between:return"between";case we.B2l.DataValidationOperator.NumberDataValidationOperator_NotBetween:return"notBetween";case we.B2l.DataValidationOperator.NumberDataValidationOperator_EqualTo:return"equalTo";case we.B2l.DataValidationOperator.NumberDataValidationOperator_NotEqualTo:return"notEqualTo";case we.B2l.DataValidationOperator.NumberDataValidationOperator_GreaterThan:return"greaterThan";case we.B2l.DataValidationOperator.NumberDataValidationOperator_LessThan:return"lessThan";case we.B2l.DataValidationOperator.NumberDataValidationOperator_GreaterThanOrEqualTo:return"greaterThanOrEqualTo";case we.B2l.DataValidationOperator.NumberDataValidationOperator_LessThanOrEqualTo:return"lessThanOrEqualTo";default:return}}function Jm(e){var t=[];return null!=e&&e.forEach((function(e){var n,r=null===(n=e.autoFormatter)||void 0===n?void 0:n.formatCached;t.push({value:e.value,autoFormatter:r?{formatCached:r}:void 0})})),t.length?t:void 0}function qm(e){var t,n;return!e||void 0===e.handledWayOnInvalidData&&void 0===e.helpText?void 0:{handledWayOnInvalidData:null!==(t=e.handledWayOnInvalidData)&&void 0!==t?t:void 0,helpText:null!==(n=e.helpText)&&void 0!==n?n:void 0}}function $m(e){return e?{supportMultipleValues:e.supportMultipleValues,ignoreCase:e.ignoreCase,isDropdownIconHiddenInCell:!!e.isDropdownIconHiddenInCell||void 0,shouldHighlightValidData:e.shouldHighlightValidData}:void 0}var Ym=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"freezeRef",value:function(e){e.freezeRef()}},{key:"afterRefChanged",value:function(e,t){e&&e.destroy(),t.initFormulaForCheckCell()}},{key:"getHash",value:function(e){return e.getHash()}},{key:"equals",value:function(e,t){if(e===t)return!0;var n=e.toJSON({needDeepClone:!1}),r=t.toJSON({needDeepClone:!1});return(0,pe.default)(n,r)}},{key:"toJSON",value:function(){var e=this,t={};return this.foreach((function(n,r){if(t[r]=n.toJSON({needDeepClone:!0,returnDependentSheets:!0}),e.getUseRefCounter()){var a=e.getCounterById(r);t[r].refCount=a}})),t}},{key:"toArray",value:function(){for(var e=new Array(this.maxId).fill(null),t=this.toJSON(),n=0;n<=this.maxId;n++)t[n]&&(e[n]=t[n]);return e}}]),t}(Vg),Km=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"getValidationId",value:function(e){return this.getValidationRefAndId(e).id}},{key:"getValidationJson",value:function(e){return this.getValidationRefAndId(e).ref}},{key:"getValidationRefAndId",value:function(e){this.validationJsonCache||(this.validationJsonCache=new Map);var t=this.validationJsonCache.get(e);if(t)return t;var n=e.toJSON({needDeepClone:!0}),r=this.add(n);return this.validationJsonCache.set(e,r),r}},{key:"equals",value:function(e,t){return(0,pe.default)(e,t)}},{key:"getHash",value:function(e){return xa(e)}}]),t}(Vg),Xm=function(e){function t(e){var n;return(0,y.Z)(this,t),(n=(0,d.Z)(this,(0,v.Z)(t).call(this,new Ym)))._sheet=e,n.setRefCounterState(),n}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"getExporter",value:function(e,t,n,r){return new ep(this,e,t,n,r)}},{key:"getImporter",value:function(){return new Qm(this,this._sheet)}},{key:"setRefCounterState",value:function(){var e=this._sheet.isRefCountValid();this.refs.setUseRefCounter(e)}}]),t}(Og),Qm=function(){function e(t,n){(0,y.Z)(this,e),this._dataValidationModel=t,this._sheet=n,this._style2DataValidation={},this._dropdown2DataValidation={}}return(0,C.Z)(e,[{key:"importExtraInfo",value:function(e,t){this._dataValidationModel.setRefCounterState();var n=e.dataValidations;n&&this._importDataValidation(n),this._style2DataValidation={},this._dropdown2DataValidation={};var r=e.entities;r&&this._importFromDropdown(r)}},{key:"importCell",value:function(e,t,n,r){var a;if(n.dataValidationId?a=n.dataValidationId:n.styleId&&(a=this._style2DataValidation[n.styleId]),null!=a&&(this._dataValidationModel.setById(e,t,a),r)){this._dataValidationModel.getRefMgr().setUseRefCounter(!0);var o=this._dataValidationModel.getRefMgr().getById(a);if(!o)throw new Error("dataValidation not exist");if(!this._dataValidationModel.getRefMgr().incRefCounter(o))throw new Error("dataValidation incResult failed")}}},{key:"_importDataValidation",value:function(e){if(e){var t=xg(e);for(var n in e){var r=e[n],a=Ag(r,this._sheet);if(a){var o=parseInt(n,10);if(this._dataValidationModel.getRefMgr().addById(o,a,!1),t){var i=r.refCount;this._dataValidationModel.getRefMgr().setCounterById(o,i)}}}}}},{key:"_importFromDropdown",value:function(e){var t=e.styles,n=e.dropdowns;for(var r in t)if(null!=t[r]){var a=t[r].dropdown;if(n&&void 0!==a){var o=this._getOrCreatedDataValidation(n,a);o&&(this._style2DataValidation[r]=o)}}}},{key:"_getOrCreatedDataValidation",value:function(e,t){if(this._dropdown2DataValidation.hasOwnProperty(t))return this._dropdown2DataValidation[t];var n=e[t];if(n){var r=Ag(mm(n),this._sheet);if(r){var a=this._dataValidationModel.getRefMgr().add(r).id;return this._dropdown2DataValidation[t]=a,a}}}}]),e}(),ep=function(e){function t(e,n,r,a,o){var i;return(0,y.Z)(this,t),(i=(0,d.Z)(this,(0,v.Z)(t).call(this,e.iter(n,r,a,o))))._model=e,i}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"exportExtraInfo",value:function(e){var t=this._model.getRefMgr().toJSON();delete e.dataValidations,Zg(t)||(e.dataValidations=t)}},{key:"exportToCell",value:function(e,t){null!=e&&null!=t&&(e.dataValidationId=t)}},{key:"serializeCell",value:function(e,t,n){var r=n.cellValueRefHelper,a=this._model.getRefMgr().getById(t);a&&(n.isForShortcut&&this.serializeDataValidationForShortcut(e,a,n)||r.dataValidations.checkValuesRefId(t,(function(t){e.dataValidationId=t}),(function(){var t=Wm(a.toJSON({needDeepClone:!1}),r);if(t){var n=r.dataValidations.add(t).id;return e.dataValidationId=n,n}})))}},{key:"serializeDataValidationForShortcut",value:function(e,t,n){if("listFromRange"!==t.type||!n.cellPosition)return!1;var r=t.checkCellValid(n.cellPosition.row,n.cellPosition.col);if(!r.getValue())return!1;var a=function(e,t){var n,r=null===(n=t.getSpecialInfo())||void 0===n?void 0:n.listValidateInfo,a=null==r?void 0:r.value[0];if(!a)return null;var o,i=[];if(e.options.shouldHighlightValidData){var u={};a.forEach((function(e,t){var n,r=e.text,a=e.color;i.push(r),u[r]=null!==(n=a)&&void 0!==n?n:""}));var s=Object.assign({},e.options);delete s.colors,o=Object.assign({},s,{listItemColorMap:u})}else a.forEach((function(e){i.push(e.text)})),o=e.options;return new hg(i,o,e.sheet)}(t,r);if(!a)return!1;var o=n.cellValueRefHelper,i=Wm(a.toJSON({needDeepClone:!1}),o);if(i){var u=o.dataValidations.add(i).id;e.dataValidationId=u}return!0}}]),t}(Um),tp=new Set(["refCount"]),np=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"getHash",value:function(e){var t=Object.assign({},e);delete t.style,delete t.texts;var n=xa(t,0,tp);return e.style&&e.style.getHash&&(n=xa(e.style.getHash(),n)),e.texts&&e.texts.forEach((function(t){var r=Object.assign({},t);delete r.style,n=xa(r,n),e.style&&e.style.getHash&&(n=xa(e.style.getHash(),n))})),n}},{key:"equals",value:function(e,t){var n=Object.keys(e).filter((function(e){return!tp.has(e)})),r=Object.keys(t).filter((function(e){return!tp.has(e)}));if(n.length!==r.length)return!1;var a,o=_n(n);try{for(o.s();!(a=o.n()).done;){var i=a.value;if("style"===i){var u=e[i],s=t[i];if(u&&s&&u.equals(s))continue;return!1}if("texts"===i){var l=e[i],c=t[i];if(l.length!==c.length)return!1;for(var h=l.length,f=0;f<h;f++){var d=l[f],v=c[f];if(d.type!==we.K6s.TEXT||d.type!==v.type||v.text!=v.text)return!1;var g=d.style,m=v.style;if(void 0===g&&void 0!==m||void 0!==g&&void 0===m||!g.equals(m))return!1}}if(e[i]!==t[i])return!1}}catch(e){o.e(e)}finally{o.f()}return!0}},{key:"toJSON",value:function(){var e=this,t={};return this.foreach((function(n,r){var a=Object.assign({},n);t[r]=a,e.useRefCounter&&(t[r].refCount=e.refCounter.get(n)||0)})),t}}]),t}(Vg),rp=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"getHash",value:function(e){return e.getHash()}},{key:"equals",value:function(e,t){return e.equals(t)}}]),t}(Vg),ap=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).call(this))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"getHash",value:function(e){return e.getHash()}},{key:"equals",value:function(e,t){return e.equals(t)}},{key:"toJSON",value:function(){var e=this,t={};return this.foreach((function(n,r){var a=n.toJSON(!0);t[r]=a,a&&e.useRefCounter&&(t[r].refCount=e.refCounter.get(n)||0)})),t}}]),t}(Vg),op=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).call(this))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"getHash",value:function(e){return e?1024*(e.style||0)+(e.dropdown||0):0}},{key:"equals",value:function(e,t){return e.dropdown===t.dropdown&&e.style===t.style}}]),t}(Vg),ip=function(e){function t(e){var n,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:new op;return(0,y.Z)(this,t),(n=(0,d.Z)(this,(0,v.Z)(t).call(this,r))).sheet=e,n.styleDropdownRefMgr=r,n.styleRefMgr=new ap,n.dropdownRefMgr=new rp,n.setRefCounterState(),n}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"setRefCounterState",value:function(){var e=this.sheet.isRefCountValid();this.styleDropdownRefMgr.setUseRefCounter(e)}},{key:"setStyle",value:function(e,t,n){n&&n.isDefault()&&(n=null);var r=this.getRef(e,t);if(n){var a=this.styleRefMgr.add(n).id;r?this.setRef(e,t,{style:a,dropdown:r.dropdown}):this.setRef(e,t,{style:a})}else r&&r.dropdown?this.setRef(e,t,{dropdown:r.dropdown}):this.setRef(e,t,null)}},{key:"setStyleById",value:function(e,t,n){var r=this.getRef(e,t);r?this.setRef(e,t,{style:n,dropdown:r.dropdown}):this.setRef(e,t,{style:n})}},{key:"getStyle",value:function(e,t){var n=this.getRef(e,t);return n&&n.style&&this.styleRefMgr.getById(n.style)||null}},{key:"setDefaultStyle",value:function(e){this.defaultStyle=e}},{key:"getDefaultStyle",value:function(){return this.defaultStyle}},{key:"setDropdown",value:function(e,t,n){var r=this.getRef(e,t);if(n){var a=this.dropdownRefMgr.add(n).id;r?this.setRef(e,t,{style:r.style,dropdown:a}):this.setRef(e,t,{dropdown:a})}else r&&r.style?this.setRef(e,t,{style:r.style}):this.setRef(e,t,null)}},{key:"getDropdown",value:function(e,t){var n=this.getRef(e,t);return n&&n.dropdown&&this.dropdownRefMgr.getById(n.dropdown)||null}},{key:"getStyleRefMgr",value:function(){return this.styleRefMgr}},{key:"getDropdownRefMgr",value:function(){return this.dropdownRefMgr}},{key:"getSheet",value:function(){return this.sheet}},{key:"getImporter",value:function(){return new up(this)}},{key:"getExporter",value:function(e,t,n,r){return new sp(this,e,t,n,r)}},{key:"iterDropdown",value:function(e,n,r,a){var o=this;return(0,f.Z)((0,v.Z)(t.prototype),"iterRef",this).call(this,e,n,r,a).filter((function(e){return null!=e.dropdown})).map((function(e){return o.dropdownRefMgr.getById(e.dropdown)})).filter((function(e){return null!=e}))}},{key:"iterStyle",value:function(e,n,r,a){var o=this;return(0,f.Z)((0,v.Z)(t.prototype),"iterRef",this).call(this,e,n,r,a).filter((function(e){return null!=e.style})).map((function(e){return o.styleRefMgr.getById(e.style)})).filter((function(e){return null!=e}))}},{key:"iterDropdownWithPos",value:function(e,n,r,a){var o=this;return(0,f.Z)((0,v.Z)(t.prototype),"iterRefWithPos",this).call(this,e,n,r,a).filter((function(e){return null!=e[0].dropdown})).map((function(e){return[o.dropdownRefMgr.getById(e[0].dropdown),e[1]]})).filter((function(e){return null!=e[0]}))}},{key:"iterStyleWithPos",value:function(e,n,r,a){var o=this;return(0,f.Z)((0,v.Z)(t.prototype),"iterRefWithPos",this).call(this,e,n,r,a).filter((function(e){return null!=e[0].style})).map((function(e){return[o.styleRefMgr.getById(e[0].style),e[1]]})).filter((function(e){return null!=e[0]}))}},{key:"foreachDropdown",value:function(e){this.dropdownRefMgr.foreach(e)}}]),t}(Og),up=function(){function e(t){(0,y.Z)(this,e),this.styleDropdownModel=t,this.hasWarnNotExist=!1}return(0,C.Z)(e,[{key:"importExtraInfo",value:function(e,t){if(this.styleDropdownModel.setRefCounterState(),"object"==(0,_.Z)(e.entities)){var n;if(this.importDropdowns(e.entities.dropdowns),t&&t.defaults&&t.defaults.style){var r=this.styleDropdownModel.getSheet().parent.formatterService;(n=Ad.fromJSON(r,t.defaults.style,Md())).setDefault(n)}this.importStyles(e.entities.styles,n)}}},{key:"importCell",value:function(e,t,n,r){if(n.styleId){var a=this.styleDropdownModel.getRefMgr().getById(n.styleId);if(!a)return void(this.hasWarnNotExist||(this.styleDropdownModel.getSheet().getLogger().warn("styleId not exist: ".concat(n.styleId)),this.hasWarnNotExist=!0));if(r&&(console.warn("style buildRefCounter set, something wrong"),this.styleDropdownModel.getRefMgr().setUseRefCounter(!0),!this.styleDropdownModel.getRefMgr().incRefCounter(a)))throw new Error("style incResult failed");if(a.dropdown)return void(a.style&&this.styleDropdownModel.setRef(e,t,{style:a.style}));this.styleDropdownModel.setById(e,t,n.styleId)}}},{key:"importDropdowns",value:function(e){if(e)for(var t in e){var n=e[t],r=parseInt(t,10),a=n.list,o=n.isValid,i=n.isEnableOptionColor,u=n.color;this.styleDropdownModel.getDropdownRefMgr().addById(r,new Ev(a,o,i,u))}}},{key:"importStyles",value:function(e,t){if(e){var n=xg(e);for(var r in e){var a=e[r],o=parseInt(r,10),i=void 0,u=a&&a.dropdown;u&&(i=parseInt(a.dropdown,10),delete a.dropdown);var s=this.styleDropdownModel.getSheet().parent.formatterService,l=Ad.fromJSON(s,a,t||Md());if(l.equals(t||Md()))this.styleDropdownModel.getRefMgr().addById(o,{dropdown:i});else{var c=this.styleDropdownModel.getStyleRefMgr().add(l).id;this.styleDropdownModel.getRefMgr().addById(o,{style:c,dropdown:i})}n&&this.styleDropdownModel.getRefMgr().setCounterById(o,e[r].refCount),u&&(a.dropdown=u)}}}}]),e}(),sp=function(e){function t(e,n,r,a,o){var i;return(0,y.Z)(this,t),(i=(0,d.Z)(this,(0,v.Z)(t).call(this,e.iter(n,r,a,o)))).model=e,i}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"exportExtraInfo",value:function(e){var t=this,n={},r={};this.model.getRefMgr().foreach((function(e,a){var o=e.style,i=e.dropdown;n[a]={};var u=o&&t.model.getStyleRefMgr().getById(o);if(u&&(n[a]=u.toJSON(!0)),n[a]&&(t.model.getRefMgr().getUseRefCounter()&&(n[a].refCount=t.model.getRefMgr().getCounterById(a)),i)){var s=t.model.getDropdownRefMgr().getById(i);s&&(t.model.getRefMgr().getUseRefCounter()?(n[a].dropdown=i,r[i]?r[i].refCount+=t.model.getRefMgr().getCounterById(a):(r[i]=s.toJSON(),r[i].refCount=t.model.getRefMgr().getCounterById(a))):(n[a].dropdown=i,r[i]=s.toJSON()))}})),e.entities&&(delete e.entities.styles,delete e.entities.dropdowns,Zg(e.entities)&&delete e.entities);var a=10*(Zg(n)?0:1)+(Zg(r)?0:1);11===a?e.entities=Object.assign({},e.entities,{styles:n,dropdowns:r}):10===a&&(e.entities=Object.assign({},e.entities,{styles:n}))}},{key:"exportToCell",value:function(e,t){var n=this.model.getRefMgr().getById(t);null==e||null==t||null==n||null==n.style&&null==n.dropdown||(e.styleId=t)}},{key:"serializeCell",value:function(e,t,n){var r=this.model.getRefMgr().getById(t);if(e&&void 0!==(null==r?void 0:r.style)){var a=this.model.getStyleRefMgr().getById(r.style);a&&(e.styleId=n.cellFormatRefHelper.pushStyle(a,t))}}}]),t}(Um);function lp(e){if(e)for(var t=0;t<e.length;t++)if(e[t].type===we.K6s.EMBED_IMAGE)return e[t];return null}function cp(e,t,n){return Fv(e,t,n)?hp(e,t,n):null}function hp(e,t,n){var r,a=e.getVar(t,n),o=null==a?void 0:a.getValue();if((null==o?void 0:o.type)===we.K6s.EMBED_IMAGE)return o;var i=null===(r=a.getVar)||void 0===r?void 0:r.call(a);if(i&&Rp(i)){var u=i.getValue();return null!=u&&u.link?Object.assign({},u,{type:we.K6s.EMBED_IMAGE}):null}return null}function fp(e,t){return e.map((function(e){return function(e,t){if(e.style){var n=function(e,t){var n,r,a,o;"true"===t.bold?n=700:""===t.bold&&(n=400),"true"===t.italic?r="italic":""===t.italic&&(r="normal"),t.fontsize&&(a=rd(t.fontsize)),t.fontfamily&&(t.fontfamily,0)&&(o=t.fontfamily);var i=e.clone();i._font=fd.valueOf(a,r,n,o);var u=i._textDecoration||we.aBM.none;return"true"===t.underline?u|=we.aBM.underline:""===t.underline&&(u&=~we.aBM.underline),"true"===t.strikethrough?u|=we.aBM.lineThrough:""===t.strikethrough&&(u&=~we.aBM.lineThrough),i._textDecoration=u,t.textcolor&&(i._foreColor=t.textcolor),i._wordWrap=0,i}(t.getDefaultStyle(),e.style);e.style=n}if(e.texts){var r=fp(e.texts,t);0!==r.length?e.texts=r:delete e.texts}return e}(e,t)}))}function dp(e,t){var n=id(t);return e.map((function(e){var r=Object.assign({},e);if(r.style=Object.assign({},n),e.style)for(var a=id(e.style),o=0;o<we.cvC.length;o++){var i=we.cvC[o],u=a[i];["textcolor","fontsize","fontfamily"].includes(i)?void 0!==u&&(r.style[i]=u):void 0!==u&&("true"===u?r.style[i]="true":delete r.style[i])}if(r.texts){var s=dp(r.texts,t);0!==s.length?r.texts=s:delete r.texts}return r.style&&0===Object.keys(r.style).length&&delete r.style,r}))}function vp(e){if(!Array.isArray(e))return!1;for(var t=0;t<e.length;t++){var n=e[t];if(n.type!==we.K6s.TEXT)return!1;if(null!=n.style||null!=n.styleId)return!1}return!0}function gp(e,t,n,r){return e.length&&yp(e)?mp(e,t,n,r).style:t}function mp(e,t,n,r){e=xv.convertSegmentArrayFromChangeset(n.parent,e);var a,o=new Set,i=[],u=[],l=!1;t=t||n.getDefaultStyle();for(var c=a=r?Ad.withUpdateStyle(t,r,n.formatterService):t,h=0;h<e.length;h++){var f=Object.assign({},e[h]);if(f.type!==we.K6s.TEXT||"\n"!==f.text){var d=f.style&&f.style.clone&&f.style.clone()||a.clone(),v=Ad.withUpdateStyle(d,r,n.formatterService);if(l||d.equals(v)||(l=!0),f.style=v,c=v,f.texts){var g=mp(f.texts,d,n,r),p=g.value,y=g.style,C=g.hasChanged;C&&(l=C),f.style=y,c=v,"string"==typeof p?(delete f.texts,l=!0):(f.texts=p,delete f.style)}var _=Object.assign({},f);delete _.style,u.push(_),i.push(f),f.style?o.add(f.style):o.add(a)}else{f.style=c;f.style;var R=(0,s.Z)(f,gn);u.push(R),i.push(f)}}var w=Ad.extractCommonStyle((0,m.Z)(o)),k=w.commonStyle,S=w.hasDifference;k&&(a=Ad.withUpdateStyle(a,k,n.formatterService));var E=i;S||(vp(u)?(E=u.reduce((function(e,t){return e+t.text}),""),l=!0):E=u),l||a.equals(t)||(l=!0);var T=[],A=null;if(Array.isArray(E))for(var I=0;I<E.length;I++){var b=E[I];b.type===we.K6s.TEXT?null!==A?A.style&&b.style&&A.style.equals(b.style)?A.text=A.text+b.text:(T.push(b),A=b):(A=b,T.push(b)):(A=null,T.push(b))}return{value:T.length?T:E,style:a,hasChanged:l}}function pp(e){for(var t=[],n=0;n<e.length;n++){var r=Object.assign({},e[n]);if(delete r.style,r.texts){var a=pp(r.texts);"string"==typeof a||0===a.length?delete r.texts:r.texts=a}t.push(r)}return vp(t)?t.reduce((function(e,t){return e+t.text}),""):t}function yp(e){for(var t=0;t<e.length;t++){var n=e[t];if(null==n.style){if(Array.isArray(n.texts)&&yp(n.texts))continue;return!1}}return!0}function Cp(e){if(e&&e.variant){var t=e.variant.getVar();if(t&&"function"==typeof t.getSpecialInfo){var n,r=null===(n=t.getSpecialInfo())||void 0===n?void 0:n.linkInfo;if(r&&r.link)return[{type:"url",text:null!=t.getValue()?t.getValue().toString():"",link:r.link}]}}return null}function _p(e){if(!e||!e.variant)return null;var t=e.variant.getVar();return Rp(t)?[Object.assign({},t.getValue(),{text:""})]:null}function Rp(e){return e.isCustomPrimitive()&&"SheetImageVar"===e.customType}var wp,kp,Sp,Ep,Tp,Ap=[];function Ip(e,t,n){if(function(e,t,n){for(var r=0;r<Ap.length;r++)if(Ap[r](e,t,n))return!0;return!1}(e,t,n))return!1;var r=e.getSafeValue(t,n);if(Array.isArray(r)&&r.some((function(e){return e.type===we.K6s.MENTION})))return!1;var a=e.getValue(t,n);return function(e,t){if("string"!=typeof t)return!1;var n=function(e,t){try{if((0,Se.isBigNumber)(t))return 1;var n=(0,Se.getPreferredFormatter)(e.formatterService,t),r=n.formatter,a=n.value;return(0,ge.default)(a)?1:(0,Se.isDateTimeFormatter)(r)&&a instanceof ke.SheetDate?2:0}catch(e){return 0}}(e,t);return 1===n||2===n}(e,a)}function bp(e){return we.O6N.DATA_NOT_READY===e||we.O6N.SHEET_AI_TAG_DATABASE_LOADING===e||we.O6N.IMPORT_ERR_PEDDING===e||we.O6N.IMPORT_ERR_CRAWL_WAITING===e||we.O6N.IMPORT_ERR_CRAW_RUNNING===e}Ap.push((function(e,t,n){return e.hasMultipleValues(t,n)})),Ap.push((function(e,t,n){var r=e.getStyle(t,n);if(!r.formatter)return!1;var a=r.formatter.toJSON();return!!a&&"@"===a.formatCached})),Ap.push((function(e,t,n){return e.getPivotTableManager().hasPivotTableAtCell(t,n)})),function(e){e[e.GENERAL=0]="GENERAL",e[e.NUMBER=1]="NUMBER",e[e.DATE=2]="DATE"}(wp||(wp={}));var Fp=function(){function e(){(0,y.Z)(this,e),this.table=[]}return(0,C.Z)(e,[{key:"orderedIter",value:function(e,t,n,r){return Mp(this.table,e,t,n,r)}},{key:"orderedIterWithPos",value:function(e,t,n,r){var a=Mp(this.table,e,t,n,r);return a.map((function(e){return[e,a.position()]}))}},{key:"iterWithPos",value:function(e,t,n,r){var a=this.iter(e,t,n,r);return a.map((function(e){return[e,a.position()]}))}},{key:"addRow",value:function(e,t,n){if(0!==t){var r=new Array(t);this.table.forEach((function(t){t&&t.length>e&&((0,we.b$t)(t,e,0,r),t.length=Math.min(t.length,n))}))}}},{key:"delRow",value:function(e,t,n){0!==t&&this.table.forEach((function(r){r&&r.length>e&&(r.length<=e+t?r.length=e:r.splice(e,t),n>=0&&(r.length=Math.min(r.length,n)))}))}},{key:"addCol",value:function(e,t){this.isEmpty()||(0,we.b$t)(this.table,e,0,new Array(t))}},{key:"delCol",value:function(e,t){e>=this.table.length||0===t||(t<this.table.length-e?this.table.splice(e,t):this.table.length=e)}},{key:"iter",value:function(e,t,n,r){return new Vp(this.table,e,t,e+n-1,t+r-1)}},{key:"getImporter",value:function(){return null}},{key:"getExporter",value:function(e,t,n,r){return null}},{key:"isEmpty",value:function(){return 0===this.table.length}},{key:"set",value:function(e,t,n){e<0||t<0||(this.table[t]||(this.table[t]=[]),this.table[t][e]=n)}},{key:"get",value:function(e,t){var n=this.table[t];if(null==n)return null;var r=n[e];return void 0===r?null:r}},{key:"clear",value:function(e,t,n,r){for(var a=n+e,o=Math.min(r+t,this.table.length),i=t;i<o;i++)if(this.table[i]&&!(this.table[i].length<e))if(this.table[i].length<e+n)this.table[i].length=e;else for(var u=e;u<a;u++)this.table[i][u]=null}},{key:"clearRow",value:function(e,t){var n=e+t-1;this.table.forEach((function(t){if(t&&t.length>e)if(t.length<n)t.length=e;else for(var r=e;r<=n;r++)t[r]=null}))}},{key:"clearCol",value:function(e,t){for(var n=Math.min(t+e,this.table.length);e<n;)this.table[e]=null,e++}},{key:"swapRow",value:function(e,t){this.table.forEach((function(n){if(n&&!(n.length<=Math.min(e,t))){var r=n[e];n[e]=n[t],n[t]=r}}))}},{key:"swapCol",value:function(e,t){var n=this.table[e];this.table[e]=this.table[t],this.table[t]=n}},{key:"swapCell",value:function(e,t,n,r){var a=this.get(e,t),o=this.get(n,r);this.set(e,t,o),this.set(n,r,a)}},{key:"reset",value:function(){this.table=[]}}]),e}();function Mp(e,t,n,r,a){return a<=1?new Vp(e,t,n,t+r-1,n+a-1):new Np(e,t,n,t+r-1,n+a-1)}var Vp=function(e){function t(e,n,r,a,o){var i;return(0,y.Z)(this,t),(i=(0,d.Z)(this,(0,v.Z)(t).call(this))).table=e,i.rowFrom=n,i.rowTo=a,i.colTo=o,i.isDone=!1,i.colTo=Math.min(o,e.length-1),i.cellPosition={row:n-1,col:r},i}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"next",value:function(){for(;this.isValid();){if(this.cellPosition.row++,(!this.table[this.cellPosition.col]||this.cellPosition.row>=this.table[this.cellPosition.col].length||this.cellPosition.row>this.rowTo)&&!this.nextCol())return this.isDone=!0,null;var e=this.table[this.cellPosition.col];if(null==e)return null;var t=e[this.cellPosition.row];if(null!=t)return t}return this.isDone=!0,null}},{key:"isValid",value:function(){return this.cellPosition.col<=this.colTo}},{key:"value",value:function(){if(this.isDone)return null;var e=this.table[this.cellPosition.col]&&this.table[this.cellPosition.col][this.cellPosition.row];return null==e?null:e}},{key:"nextCol",value:function(){do{this.cellPosition.col++}while(!this.table[this.cellPosition.col]&&this.colTo>=this.cellPosition.col);return this.cellPosition.row=this.rowFrom,this.colTo>=this.cellPosition.col}},{key:"position",value:function(){return this.cellPosition}}]),t}(Rt.FIterator),Np=function(e){function t(e,n,r,a,o){var i;(0,y.Z)(this,t),(i=(0,d.Z)(this,(0,v.Z)(t).call(this))).table=e,i.colFrom=r,i.rowTo=a,i.colTo=o,i.validCols=new Set,i.isDone=!1,i.colTo=Math.min(o,e.length-1),i.cellPosition={row:n,col:r};for(var u=i.colFrom;u<=i.colTo;u++)i.table[u]&&i.validCols.add(u);return i.colIter=i.validCols.values(),i}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"next",value:function(){for(;this.isValid();){for(var e=void 0,t=null;null==t;){var n=this.colIter.next();if(e=n.value,n.done)break;this.cellPosition.col=e,this.cellPosition.row>=this.table[e].length?this.validCols.delete(e):t=this.table[e][this.cellPosition.row]}if(null!=t)return t;this.cellPosition.row++,this.colIter=this.validCols.values()}return this.isDone=!0,null}},{key:"isValid",value:function(){return this.cellPosition.row<=this.rowTo}},{key:"value",value:function(){if(this.isDone)return null;var e=this.table[this.cellPosition.col]&&this.table[this.cellPosition.col][this.cellPosition.row];return null==e?null:e}},{key:"position",value:function(){return this.cellPosition}}]),t}(Rt.FIterator);function Op(e){return{get numFmt(){var t=Zp(e.formatter);return void 0!==t?{formatCode:t}:void 0},get autoNumFmt(){var t=Zp(e.autoFormatter);return void 0!==t?{formatCode:t}:void 0},get font(){var t=e.rawFont,n=e.foreColor,r=e.textDecoration,a={name:null==t?void 0:t.fontFamily,bold:void 0!==(null==t?void 0:t.fontWeight)?t.fontWeight>=700:void 0,italic:void 0!==(null==t?void 0:t.fontStyle)?["italic","oblique"].includes(t.fontStyle):void 0,strike:void 0!==r?!!(r&St.TextDecoration.Mid):void 0,underline:void 0!==r?!!(r&St.TextDecoration.Bottom):void 0,color:void 0!==n?{rgb:n}:void 0,size:null==t?void 0:t.fontSize};if(void 0!==a.name||void 0!==a.bold||void 0!==a.italic||void 0!==a.strike||void 0!==a.underline||void 0!==a.color||void 0!==a.size)return a},get fill(){return void 0!==e.backColor?{color:{rgb:e.backColor}}:void 0},get border(){var t=e.borderBottom,n=e.borderLeft,r=e.borderRight,a=e.borderTop,o=e.diagonal,i=e.diagonalUp,u=e.diagonalDown,s={left:Dp(n),right:Dp(r),top:Dp(a),bottom:Dp(t),diagonal:Dp(o),diagonalUp:i,diagonalDown:u};if(void 0!==s.left||void 0!==s.right||void 0!==s.top||void 0!==s.bottom||void 0!==s.diagonal||void 0!==s.diagonalUp||void 0!==s.diagonalDown)return s},get alignment(){var t=e.wordWrap,n=e.hAlign,r=e.vAlign,a={horizontal:Lp(n),vertical:Up(r),textRotation:e.textRotation,wrapText:Wp(t)};if(void 0!==a.horizontal||void 0!==a.vertical||void 0!==a.wrapText||void 0!==a.textRotation)return a},get otherFmt(){return void 0!==e._hideLink?{hideLink:e._hideLink}:void 0}}}function xp(e){var t,n,r,a=e.numFmt,o=e.autoNumFmt,i=e.font,u=e.fill,s=e.border,l=e.alignment,c=e.otherFmt;void 0===(null==i?void 0:i.strike)&&void 0===(null==i?void 0:i.underline)||(r=we.aBM.none,null!=i&&i.strike&&(r|=we.aBM.lineThrough),(null==i?void 0:i.underline)&&(r|=we.aBM.underline));var h=i?function(e){var t=!1,n={};return e.size&&(n.fontSize=e.size,t=!0),e.name&&(n.fontFamily=e.name,t=!0),e.italic&&(n.fontStyle="italic",t=!0),e.bold&&(n.fontWeight=St.FontWeight.bold,t=!0),t?n:void 0}(i):void 0;return{backColor:null==u||null===(t=u.color)||void 0===t?void 0:t.rgb,foreColor:null==i||null===(n=i.color)||void 0===n?void 0:n.rgb,fontInfo:h,vAlign:Hp(null==l?void 0:l.vertical),hAlign:Bp(null==l?void 0:l.horizontal),textDecoration:r,wordWrap:jp(null==l?void 0:l.wrapText),formatter:void 0!==(null==a?void 0:a.formatCode)?{formatCached:a.formatCode}:void 0,autoFormatter:void 0!==(null==o?void 0:o.formatCode)?{formatCached:o.formatCode}:void 0,borderLeft:Pp(null==s?void 0:s.left),borderTop:Pp(null==s?void 0:s.top),borderRight:Pp(null==s?void 0:s.right),borderBottom:Pp(null==s?void 0:s.bottom),diagonal:Pp(null==s?void 0:s.diagonal),diagonalUp:null==s?void 0:s.diagonalUp,diagonalDown:null==s?void 0:s.diagonalDown,textRotation:null==l?void 0:l.textRotation,hideLink:null==c?void 0:c.hideLink}}function Zp(e){var t;if(e)return e instanceof Se.Formatter?(null!==(t=e.toJSON())&&void 0!==t?t:{formatCached:"General"}).formatCached:null==e?void 0:e.formatCached}function Dp(e){if(e&&(e.color||e.lineStyle))return{color:{rgb:e.color},style:e.lineStyle}}function Pp(e){var t,n;if(e&&(e.color||e.style))return{color:null!==(t=null===(n=e.color)||void 0===n?void 0:n.rgb)&&void 0!==t?t:"",lineStyle:e.style,width:1}}function Lp(e){switch(e){case we.KqL.Left:return we.B2l.HorizontalAlignment.HorizontalAlignment_left;case we.KqL.Right:return we.B2l.HorizontalAlignment.HorizontalAlignment_right;case we.KqL.Center:return we.B2l.HorizontalAlignment.HorizontalAlignment_center;default:return}}function Bp(e){switch(e){case we.B2l.HorizontalAlignment.HorizontalAlignment_left:return we.KqL.Left;case we.B2l.HorizontalAlignment.HorizontalAlignment_right:return we.KqL.Right;case we.B2l.HorizontalAlignment.HorizontalAlignment_center:return we.KqL.Center;default:return}}function Up(e){switch(e){case we.g$I.Top:return we.B2l.VerticalAlignment.VerticalAlignment_top;case we.g$I.Bottom:return we.B2l.VerticalAlignment.VerticalAlignment_bottom;case we.g$I.Center:return we.B2l.VerticalAlignment.VerticalAlignment_center;default:return}}function Hp(e){switch(e){case we.B2l.VerticalAlignment.VerticalAlignment_top:return we.g$I.Top;case we.B2l.VerticalAlignment.VerticalAlignment_bottom:return we.g$I.Bottom;case we.B2l.VerticalAlignment.VerticalAlignment_center:return we.g$I.Center;default:return}}function Wp(e){switch(e){case 0:return we.B2l.WrapTextType.WrapTextType_OVERFLOW;case 1:return we.B2l.WrapTextType.WrapTextType_AUTOWRAP;case 2:return we.B2l.WrapTextType.WrapTextType_WORDCLIP;default:return}}function jp(e){switch(e){case we.B2l.WrapTextType.WrapTextType_OVERFLOW:return 0;case we.B2l.WrapTextType.WrapTextType_AUTOWRAP:return 1;case we.B2l.WrapTextType.WrapTextType_WORDCLIP:return 2;default:return}}function zp(e){if(e){var t=e.themeType===we.fW_.pro?we.B2l.SparklineThemeType.SparklineThemeType_PRO:e.themeType;return Object.assign({},e,{themeType:t})}}!function(e){e.Number="D",e.String="S",e.Bool="B",e.Null="N",e.Error="E",e.Ref="R",e.Matrix="M",e.Operator="O",e.Func="F",e.Param="P"}(kp||(kp={})),function(e){e.BinaryOp="B",e.SuffixUnary="S",e.PrefixUnary="P",e.Paren="G",e.InvokeFunctionOp="I"}(Sp||(Sp={})),function(e){e.Constant="C",e.Reference="R",e.Param="P"}(Ep||(Ep={})),function(e){e[e.Array=1]="Array"}(Tp||(Tp={}));var Gp=[ut.ErrorType.RUNTIME_ERROR],Jp=ut.VAR_TYPE.NUMBER,qp=ut.VAR_TYPE.STRING,$p=ut.VAR_TYPE.BOOL,Yp=ut.VAR_TYPE.ERROR,Kp=we.B2l.CellValueType.CellValueType_Number,Xp=we.B2l.CellValueType.CellValueType_String,Qp=we.B2l.CellValueType.CellValueType_Bool,ey=we.B2l.CellValueType.CellValueType_Error,ty=we.B2l.CellValueType.CellValueType_EmbedImage,ny=we.B2l.CellValueType.CellValueType_RichString,ry=we.B2l.CellValueType.CellValueType_Formula,ay=function(){function e(t,n,r){(0,y.Z)(this,e),this._segmentArray=t,this._variant=n,this._multipleValues=r,Object.freeze(this),Object.freeze(this._segmentArray)}return(0,C.Z)(e,[{key:"hasContent",value:function(){return!!(this._segmentArray||this._variant||this._multipleValues)}},{key:"segmentArray",get:function(){return this._segmentArray}},{key:"variant",get:function(){return this._variant}},{key:"multipleValues",get:function(){return this._multipleValues}},{key:"formulaVar",get:function(){return null!=this._variant&&this._variant.isFormula()?this._variant:null}}]),e}();function oy(e){return null==e}function iy(e){return!!e&&e instanceof Bf}function uy(e){return!!e&&e instanceof jf}function sy(e){var t=n.g;return t&&t.window.isNotBrowser?e:we.Ps3.replaceImageDataSrc(e)}function ly(e){var t=n.g;t&&t.window.isNotBrowser||we.Ps3.collectSuiteEvent("sheet_drive_dirty_data",{driveToken:we.Ps3.encryptTea(e)})}function cy(e){if(!e)return"";var t=e.match(/\/box\/stream\/download(\/v2)?\/(all|cover)\/([A-Za-z0-9]*)/);return t&&t[t.length-1]?t[t.length-1]:""}function hy(e,t){var n=null==e?void 0:e.formulaVar;null!=n&&(t.unRegisterFml(n),iy(n)&&n.dispose())}function fy(e,t,n,r,a,o){var i=e.parent.importRangeManager;if(uy(r)&&(r=r.getVar()),r.type&ut.VAR_TYPE.BASIC){var u=e._dataModel.getVarByContent(a,t,n);if(null!=u&&uy(u)&&u.hasCache()&&u.getValue()===r.getValue()&&u.isInCorrectPosition(t,n))return null}else if(r.isFormula()){if(th(r)&&r.getExternalDataReferenceInfo()){var s=i.getMetaFromFormula(r);if(null==s)return console.error("meta is not found"),null;if(i.isImportRangeNumExceedLimitWithRangeCache([s]))return we.Ps3.Toast.error({key:"crossTableError_num",closable:!0,content:fn("CreationDoc_Sheets_ImportrangeToLimit",we.Ps3.getSheetImportRangeCountLimit())}),null;i.setImportRangeFormula(r,s)}o.registerFml(r),iy(r)&&e.parent.setWorkbookHasArrayFormula(!0)}return r}var dy=function(){function e(t){(0,y.Z)(this,e),this.sheet=t,this.mention=new np,this.image=new np,this.attachment=new np,this.style=new ap,this.dataModel=new Fp,this.setRefCounterState()}return(0,C.Z)(e,[{key:"isEmpty",value:function(){return this.dataModel.isEmpty()}},{key:"iter",value:function(e,t,n,r){return this.dataModel.iter(e,t,n,r)}},{key:"set",value:function(e,t,n){this.dataModel.set(e,t,n)}},{key:"addRow",value:function(e,t,n){this.dataModel.addRow(e,t,n)}},{key:"delRow",value:function(e,t,n){0!==t&&(this.clear(e,0,t,this.sheet.getColumnCount()),this.dataModel.delRow(e,t,n,!0))}},{key:"addCol",value:function(e,t){this.dataModel.addCol(e,t)}},{key:"delCol",value:function(e,t){0!==t&&(this.clear(0,e,this.sheet.getRowCount(),t),this.dataModel.delCol(e,t,!0))}},{key:"swapRow",value:function(e,t){this.dataModel.swapRow(e,t)}},{key:"swapCol",value:function(e,t){this.dataModel.swapCol(e,t)}},{key:"swapCell",value:function(e,t,n,r){this.dataModel.swapCell(e,t,n,r)}},{key:"orderedIter",value:function(e,t,n,r){return this.dataModel.orderedIter(e,t,n,r)}},{key:"orderedIterWithPos",value:function(e,t,n,r){return this.dataModel.orderedIterWithPos(e,t,n,r)}},{key:"iterWithPos",value:function(e,t,n,r){return this.dataModel.iterWithPos(e,t,n,r)}},{key:"getExporter",value:function(e,t,n,r){return new vy(this.sheet,{mention:this.mention,image:this.image,style:this.style,attachment:this.attachment},this,e,t,n,r)}},{key:"getImporter",value:function(){return new gy(this.sheet,{mention:this.mention,image:this.image,style:this.style,attachment:this.attachment},this)}},{key:"setRefCounterState",value:function(){var e=this.sheet.isRefCountValid();this.mention.setUseRefCounter(e),this.image.setUseRefCounter(e),this.attachment.setUseRefCounter(e),this.style.setUseRefCounter(e)}},{key:"getSegmentArray",value:function(e,t,n){var r=this.getImmutableNode(e,t,n);return r&&!oy(r.segmentArray)?r.segmentArray.map((function(e){return Object.assign({},e)})):null}},{key:"getImmutableSegmentArray",value:function(e,t,n){var r=this.getImmutableNode(e,t,n);return r&&!oy(r.segmentArray)?r.segmentArray:null}},{key:"get",value:function(e,t,n){return this.getImmutableNode(e,t,n)}},{key:"getImmutableNode",value:function(e,t,n){var r=this.sheet.getPivotTableManager(),a=r.getPivotTableNameByCell(e,t);if(n||!a)return this.dataModel.get(e,t);var o=Lg(r.getCellValue(e,t))||ut.NULL_VAR,i=this.sheet.getCalcEngine().pivotCalculateEngine.getFormula(a);return new ay(null,new Ha(e,t,o,a,i),null)}},{key:"setSegmentArray",value:function(e,t,n){var r=this.dataModel.get(e,t);if(this.clearCellRef(e,t),null==n){if(!r)return;this.set(e,t,new ay(null,r.variant,r.multipleValues))}else r?this.set(e,t,new ay(this.segmentArrayToRef(n),r.variant,r.multipleValues)):this.set(e,t,new ay(this.segmentArrayToRef(n),null,null))}},{key:"getMultipleValues",value:function(e,t){var n=this.dataModel.get(e,t);return n&&null!=n.multipleValues?n.multipleValues:null}},{key:"setMultipleValues",value:function(e,t,n){var r=this.dataModel.get(e,t);if(null==n){if(!r)return;void 0!==r.variant&&null!==r.variant||void 0!==r.segmentArray&&null!==r.segmentArray?this.set(e,t,new ay(r.segmentArray,r.variant,null)):this.clear(e,t,1,1)}else{for(var a=0;a<n.length;a++){var o=n.get(a);o.segmentArray&&n.set(a,Object.assign({},o,{segmentArray:this.segmentArrayToRef(o.segmentArray)}))}r?this.set(e,t,new ay(r.segmentArray,r.variant,n)):this.set(e,t,new ay(null,null,n))}}},{key:"setVariant",value:function(e,t,n,r){void 0===r&&(r=this.dataModel.get(e,t)),r?null==r.segmentArray&&null==r.multipleValues&&null==n?this.clear(e,t,1,1):this.set(e,t,new ay(r.segmentArray,n,r.multipleValues)):n&&this.set(e,t,new ay(null,n,null))}},{key:"setNodeValue",value:function(e,t,n){if(this.clearCellRef(e,t),n){var r=n.multipleValues,a=n.segmentArray,o=n.variant;if(r||a||o){if(r)for(var i=0;i<r.length;i++){var u=r.get(i);u.segmentArray&&r.set(i,Object.assign({},u,{segmentArray:this.segmentArrayToRef(u.segmentArray)}))}null!==a?this.set(e,t,new ay(this.segmentArrayToRef(a),o,r)):this.set(e,t,new ay(null,o,r))}else this.clear(e,t,1,1)}else this.clear(e,t,1,1)}},{key:"clearCellRef",value:function(e,t){var n=this,r=this.getImmutableNode(e,t);if(r){this.clearSegmentArrayCount(r.segmentArray);var a=r.multipleValues;a&&a.forEach((function(e){e&&e.segmentArray&&n.clearSegmentArrayCount(e.segmentArray)}))}}},{key:"clearSegmentArrayCount",value:function(e){var t=this;e&&e.map((function(e){if(e.type){switch(e.type){case"mention":if(!t.mention.getUseRefCounter())break;t.mention.decRefCounter(e)||console.warn("mention decRefCounter failed");break;case"embed-image":if(!t.image.getUseRefCounter())break;t.image.decRefCounter(e)||console.warn("image decRefCounter failed");break;case"attachment":if(!t.attachment.getUseRefCounter())break;t.attachment.decRefCounter(e)}e.style&&t.style.decRefCounter(e.style),e.texts&&t.clearSegmentArrayCount(e.texts)}}))}},{key:"clear",value:function(e,t,n,r){for(var a=this.iter(e,t,n,r);a.next();){var o=a.position();this.clearCellRef(o.row,o.col)}this.dataModel.clear(e,t,n,r)}},{key:"segmentArrayToRef",value:function(e){var t=this;return e.map((function(e){var n=e=Object.assign({},e);switch(n.styleId&&delete n.styleId,e.style&&(e.style instanceof Ad||(e.style=Ad.fromJSON(t.sheet.parent.formatterService,e.style)),e.style=t.style.add(e.style).ref),e.texts&&(e.texts=t.segmentArrayToRef(e.texts)),e.type){case we.K6s.MENTION:n=t.mention.add(e).ref;break;case we.K6s.EMBED_IMAGE:e.link=sy(e.link),n=t.image.add(e).ref;break;case we.K6s.ATTACHMENT:n=t.attachment.add(e).ref}return n}))}}]),e}(),vy=function(e){function t(e,n,r,a,o,i,u){var s;return(0,y.Z)(this,t),(s=(0,d.Z)(this,(0,v.Z)(t).call(this,r.iter(a,o,i,u)))).sheet=e,s.refMgrOptions=n,s}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"isIgnoreCellNode",value:function(e,t){return!t.isForShortcut&&uy(e.variant)}},{key:"serializeCell",value:function(e,t,n){var r,a=t.segmentArray,o=t.variant,i=e,u=n.cellValueRefHelper,s=n.cellFormatRefHelper;if(a){var l=a[0];if((null==l?void 0:l.type)===we.K6s.EMBED_IMAGE)this.serializeEmbedImage(l,i,n);else{var c=this.serializeSegmentArray(a,n);i.valueType=ny,i.valueId=u.richStrings.add(c).id}}else if(o)if(o.isFormula())n.isForShortcut?this.serializeFormulaForShortcut(o,i,n):this.serializeFormula(o,i,n);else if(n.isForShortcut&&uy(o))this.serializeFormulaForShortcut(o,i,n);else if(n.isForShortcut&&Wa(o)){var h=this.sheet.getPivotTableManager().getPivotInfoByName(o.blockToken);if(h&&h.errorState!==Zf.None){var f=h.errorState===Zf.ServiceCalcLoading?we.B2l.ErrorTipsType.ErrorTipsType_PivotServiceCalcLoading:we.B2l.ErrorTipsType.ErrorTipsType_FormulaError,d=o.getVar();this.serializeNormalCell(d,i,n,f)}}else this.serializeNormalCell(o,i,n);if(null!==(r=t.multipleValues)&&void 0!==r&&r.length){for(var v=t.multipleValues.toStringWithFormatterArray({formatter:null}),g=[],m=[],p=0;p<v.length;p++){var y,C=v[p],_=C.text,R=C.formatter;g.push(u.strings.addValue(_));var w=null!==(y=null==R?void 0:R.getFormatCode())&&void 0!==y?y:"";m.push(s.pushNumberFormat({formatCode:w}))}i.extendValueId=u.selectedMultipleValues.add({selectedValueIds:g,selectedAutoFormats:m}).id,i.extendType=we.B2l.CellExtendType.CellExtendType_Select}}},{key:"serializeNormalCell",value:function(e,t,n,r){var a=n.cellValueRefHelper,o=e.getValue();if(null!==o)switch(e.type){case Jp:t.valueType=Kp,t.valueId=a.numbers.addValue(o);break;case qp:t.valueType=Xp,t.valueId=a.strings.addValue(o);break;case $p:t.valueType=Qp,t.valueId=o?1:0;break;case Yp:t.valueType=ey;var i=e;t.valueId=a.errorValues.add(function(e,t){var n,r,a;return{type:e.errorType,code:e.errorCode,description:e.desc,message:null==e||null===(n=e.info)||void 0===n?void 0:n.message,args:null!=e&&null!==(r=e.info)&&void 0!==r&&r.args?JSON.stringify(null==e||null===(a=e.info)||void 0===a?void 0:a.args):void 0,errorTipsType:t}}(i,r)).id}if(n.isForShortcut){var u=e.getSpecialInfo();if(u){var s=JSON.stringify(u);t.formulaSpecialInfoId=a.formulaSpecialInfoStrings.addValue(s)}}}},{key:"serializeFormula",value:function(e,t,n){if(e.isFormula()){var r=n.cellValueRefHelper;if(0===this.exportType){var a=wf(e,{ref:e.getRef(),isNotShowErrRef:!1},{refType:1,shouldContainExternalDataReference:!1,isMutation:!0}),o=this.sheet.parent,i=o.getFormulaId&&o.getFormulaId(e,this.sheet.id());if(null!=i&&(t.formulaId=i),th(e)){var u=o.importRangeManager;a.importRangeId=u.getIdFromFormula(e)}var s={v:a.v,flag:a.flag,tree:a.tree,tokens:a.tokens,importRangeId:a.importRangeId,importRangeMeta:a.externalDataReference,params:a.params},l=a.refs?{refs:a.refs}:void 0,c=r.formulaDatas.add(s).id,h=l?r.formulaRefMaps.add(l).id:void 0;t.valueType=ry,t.valueId=r.formulas.add({formulaDataId:c,formulaRefMapId:h}).id}}}},{key:"serializeFormulaForShortcut",value:function(e,t,n){if(e.isFormula()||uy(e)||Wa(e)){var r,a=e.getVar();if(a.isError()&&bp(a.errorCode))r=we.B2l.ErrorTipsType.ErrorTipsType_Info;else{var o=$f(this.sheet,e);o&&0!==o.state&&(r=we.B2l.ErrorTipsType.ErrorTipsType_FormulaError)}if(!r&&Lc(a)){var i=a.getValue();this.serializeEmbedImage(i,t,n)}else this.serializeNormalCell(a,t,n,r)}}},{key:"serializeEmbedImage",value:function(e,t,n){var r=n.cellValueRefHelper;t.valueType=ty;var a=this.image.getIdByRef(e);r.embedImages.checkValuesRefId(a,(function(e){t.valueId=e}),(function(){var n=r.embedImages.add({token:e.fileToken,size:{w:Number(e.width),h:Number(e.height)},link:e.link}).id;return t.valueId=n,n}))}},{key:"serializeSegmentArray",value:function(e,t){var n,r=this,a=t.cellValueRefHelper,o=t.cellFormatRefHelper,i=[],u=[],s=0,l=_n(e);try{var c=function(){var e=n.value,l=o.pushStyleFont(e.style,r.style.getIdByRef(e.style));switch(s+=e.text.length,i.push(e.text),e.type){case we.K6s.MENTION:var c,h,f=r.mention.getIdByRef(e);a.mentionInfosSerialize.checkValuesRefId(f,(function(e){c=e}),(function(){var t={};return 0===e.mentionType?(t.mentionType=we.B2l.MENTION_TYPE.MENTION_TYPE_USER,t.mentionUserInfo={userInfo:{id:e.token,name:e.name,enName:e.en_name,avatarUrl:e.link},mentionNotify:e.mentionNotify,notNotify:e.not_notify,blockNotify:e.block_notify,isExternal:e.is_external}):e.mentionType>0&&(t.mentionType=we.B2l.MENTION_TYPE.MENTION_TYPE_FILE,t.mentionFileInfo={token:e.token,link:e.link,fileType:e.mentionType,iconInfo:e.iconInfo}),c=a.mentionInfosSerialize.add(t).id})),a.mentionsSerialize.checkValuesRefId(f,(function(e){h=e}),(function(){return h=a.mentionsSerialize.add({mentionId:e.mentionId,mentionInfoId:c}).id})),u.push({runType:we.B2l.CellRunType.CellRunType_Mention,endPos:s,fontId:l,refId:h});break;case we.K6s.ATTACHMENT:var d,v=r.attachment.getIdByRef(e);a.attachments.checkValuesRefId(v,(function(e){d=e}),(function(){var t=a.attachments.add({fileToken:e.fileToken,mimeType:e.mimeType,size:e.size}).id;return d=t,t})),u.push({runType:we.B2l.CellRunType.CellRunType_Attachment,endPos:s,fontId:l,refId:d});break;case we.K6s.URL:r.serializeUrlSegment(e,u,t,s);break;default:u.push({runType:we.B2l.CellRunType.CellRunType_Text,endPos:s,fontId:l})}};for(l.s();!(n=l.n()).done;)c()}catch(e){l.e(e)}finally{l.f()}var h=i.join("");return{textId:a.strings.addValue(h),runs:u}}},{key:"serializeUrlSegment",value:function(e,t,n,r){var a,o,i,u=n.cellValueRefHelper,s=n.cellFormatRefHelper;i=null!==(a=e.cellPosition)&&void 0!==a&&a.sheetId?e.cellPosition.rangeId?u.hyperlinks.add({url:"".concat(e.cellPosition.sheetId,"-").concat(e.cellPosition.rangeId),type:we.B2l.HyperlinkType.HyperlinkType_Range}).id:u.hyperlinks.add({url:e.cellPosition.sheetId,type:we.B2l.HyperlinkType.HyperlinkType_Worksheet}).id:e.link?u.hyperlinks.add({url:e.link,type:we.B2l.HyperlinkType.HyperlinkType_Normal}).id:u.hyperlinks.add({url:e.text,type:we.B2l.HyperlinkType.HyperlinkType_Normal}).id;var l=s.pushStyleFont(e.style,this.style.getIdByRef(e.style));if(null!==(o=e.texts)&&void 0!==o&&o.length){var c,h=0,f=_n(e.texts);try{for(f.s();!(c=f.n()).done;){var d,v=c.value,g=s.pushStyleFont(v.style,this.style.getIdByRef(v.style));h+=v.text.length,t.push({runType:we.B2l.CellRunType.CellRunType_Hyperlink,endPos:r-e.text.length+h,fontId:null!==(d=g)&&void 0!==d?d:l,refId:i})}}catch(e){f.e(e)}finally{f.f()}}else t.push({runType:we.B2l.CellRunType.CellRunType_Hyperlink,endPos:r,fontId:l,refId:i})}},{key:"exportToCell",value:function(e,t,n){var r=this;if(t.multipleValues&&(e.multipleValues=t.multipleValues.toJSON().map((function(e){return Array.isArray(e.value)&&(e.value=r.segmentArrayToRefId(e.value)),e}))),t.segmentArray)e.value=this.segmentArrayToRefId(t.segmentArray);else if(t.variant){if(uy(t.variant)){if(0!==this.exportType){e.value=t.variant.getValue(3!==this.exportType?void 0:n);var a=t.variant.getVar(3!==this.exportType?void 0:n).getSpecialInfo();a&&a.customData&&a.customData.autoFormat&&(e.autoFormat=a.customData.autoFormat)}return}if(t.variant.isFormula())switch(this.exportType){case 0:var o=t.variant;e.formula=this.sheet.getCalcEngine().decompile(o,{ref:o.getRef(),isNotShowErrRef:!1}),e.formulaData=wf(o,{ref:o.getRef(),isNotShowErrRef:!1},{refType:0,shouldContainExternalDataReference:!1});var i=this.sheet.parent.getFormulaId&&this.sheet.parent.getFormulaId(o,this.sheet.id());if(null!=i&&(e.formulaId=i),th(t.variant)){var u=this.sheet.parent.importRangeManager;e.formulaData.importRangeId=u.getIdFromFormula(t.variant)}break;case 1:case 2:e.isCalcError=t.variant.getVar().isError(),e.value=t.variant.getValue();var s=t.variant.getInfo();s&&s.customData&&s.customData.autoFormat&&(e.autoFormat=s.customData.autoFormat);break;case 3:this.exportFormulaToDataRange(t.variant,e,n)}else{var l=t.variant.getValue(n);null!==l&&(e.value=l)}}}},{key:"exportExtraInfo",value:function(e){this.exportImages(e),this.exportMentions(e),this.exportAttachments(e),this.exportSegmentStyles(e)}},{key:"segmentArrayToRefId",value:function(e){var t=this;return e.map((function(e){if(!e)return e;switch(e.type){case we.K6s.MENTION:return{type:we.K6s.MENTION,id:t.mention.getIdByRef(e)};case we.K6s.EMBED_IMAGE:return{type:we.K6s.EMBED_IMAGE,id:t.image.getIdByRef(e)};case we.K6s.ATTACHMENT:return{type:we.K6s.ATTACHMENT,id:t.attachment.getIdByRef(e)}}var n=Object.assign({},e);return e.style&&(n.styleId=t.style.getIdByRef(e.style)),delete n.style,e.texts&&(n.texts=t.segmentArrayToRefId(e.texts)),n}))}},{key:"exportMentions",value:function(e){for(var t=this.mention.toJSON(),n=0,r=Object.keys(t);n<r.length;n++){var a=t[r[n]];a.style&&(a.styleId=this.style.getIdByRef(a.style),delete a.style)}delete e.mention,Zg(t)||(e.mention=t)}},{key:"exportImages",value:function(e){for(var t=this.image.toJSON(),n=0,r=Object.keys(t);n<r.length;n++){var a=t[r[n]];a.style&&(a.styleId=this.style.getIdByRef(a.style),delete a.style)}delete e.image,Zg(t)||(e.image=t)}},{key:"exportSegmentStyles",value:function(e){var t=this.style.toJSON();e.entities=e.entities||{},delete e.entities.segmentStyles,Zg(t)||(e.entities.segmentStyles=t)}},{key:"exportAttachments",value:function(e){for(var t=this.attachment.toJSON(),n=0,r=Object.keys(t);n<r.length;n++){var a=t[r[n]];a.style&&(a.styleId=this.style.getIdByRef(a.style),delete a.style)}delete e.attachment,Zg(t)||(e.attachment=t)}},{key:"exportFormulaToDataRange",value:function(e,t,n){try{var r=e.getVar(n),a=gu(r,n);t.isCalcError=a.isError(),t.value=r.getValue(n)}catch(e){if(!(e&&e instanceof ut.BaseVar&&e.isError()&&Gp.includes(e.errorType)))throw e;t.isCalcError=!1,t.value=e.getValue()}var o=e.getInfo(n);return o&&o.customData&&o.customData.autoFormat&&(t.autoFormat=o.customData.autoFormat),t}},{key:"mention",get:function(){return this.refMgrOptions.mention}},{key:"image",get:function(){return this.refMgrOptions.image}},{key:"attachment",get:function(){return this.refMgrOptions.attachment}},{key:"style",get:function(){return this.refMgrOptions.style}}]),t}(Um),gy=function(){function e(t,n,r){(0,y.Z)(this,e),this.sheet=t,this.refMgrOptions=n,this.block=r,this.hasWarnNotExist=!1}return(0,C.Z)(e,[{key:"importCell",value:function(e,t,n,r){if(vp(n.value)){var a=n.value;n.value=a.reduce((function(e,t){return e+t.text}),"")}var o=Array.isArray(n.value),i=null,u=null,s=null;if(n.multipleValues&&(i=this.importMultipleValues(n.multipleValues,r)),o)u=this.importSegmentArray(n.value,r);else if(n.formula&&""!==n.formula){var l=this.importFormula(e,t,n);l&&(s=l)}else if(null!=n.value){var c=n.value;c&&"object"==(0,_.Z)(c)&&c._calcError&&(c=ut.ERROR_VAR_MAP[c._calcError]||c._calcError),c instanceof ut.BaseVar||null===c||(s=Pg(this.sheet,e,t,c,{skipFormulaCompile:!0,stringVarRefMap:this.sheet._dataModel.getStringVarRefMap()}));var h=this.sheet.getCalcEngine().formulaSpace;if(hy(this.block.getImmutableNode(e,t),h),s){var f=fy(this.sheet,e,t,s,null,h);f&&(s=f)}}(u||s||i)&&this.block.set(e,t,new ay(u,s,i)),null!=n.formulaId&&s instanceof Kc&&this.sheet.parent.setFormulaCache&&this.sheet.parent.setFormulaCache(s,this.sheet,n.formulaId)}},{key:"importFormula",value:function(e,t,n){var r,a=this.sheet.getCalcEngine();if(n.formulaData)r=a.deserializeFormula(n.formulaData,new Oi(e,t,1,1,this.sheet));else{var o="="===n.formula[0]?"":"=";r=Pg(this.sheet,e,t,o+n.formula,{skipFormulaCompile:!1})}var i=a.formulaSpace;hy(this.block.getImmutableNode(e,t),i);var u=fy(this.sheet,e,t,r,null,i);return u&&u.isFormula()&&a.formulaRefService.cacheRange(u.formula,u.getRef()),u}},{key:"importExtraInfo",value:function(e){this.block.setRefCounterState(),this.importSegmentStyles(e),this.importMentions(e),this.importImages(e),this.importAttachments(e)}},{key:"importSegmentArray",value:function(e,t){var n=this,r=this.sheet.getLogger();return e.map((function(e){switch(e.type){case we.K6s.MENTION:var a=n.mention.getById(e.id);if(!a)return n.hasWarnNotExist||(r.warn("mentionId not exist: ".concat(e.id)),n.hasWarnNotExist=!0),{type:"text",text:""};if(t&&(console.warn("mention buildRefCounter set, something wrong"),n.mention.setUseRefCounter(!0),!n.mention.incRefCounter(a)))throw new Error("mention incRefCounter failed");return a;case we.K6s.EMBED_IMAGE:var o=n.image.getById(e.id);if(!o)return n.hasWarnNotExist||(r.warn("imageId not exist: ".concat(e.id)),n.hasWarnNotExist=!0),{type:"text",text:""};if(t&&(console.warn("image buildRefCounter set, something wrong"),n.image.setUseRefCounter(!0),!n.image.incRefCounter(o)))throw new Error("image incRefCounter failed");return o;case we.K6s.ATTACHMENT:var i=n.attachment.getById(e.id);if(!i)return n.hasWarnNotExist||(r.warn("attachment not exist: ".concat(e.id)),n.hasWarnNotExist=!0),{type:"text",text:""};if(t&&(n.attachment.setUseRefCounter(!0),!n.attachment.incRefCounter(i)))throw new Error("attachment incRefCounter failed");return i;default:if(!Object.values(we.K6s).includes(e.type))return{type:we.K6s.TEXT,text:""};var u=Object.assign({},e);return delete u.style,e.styleId&&(u.style=n.style.getById(e.styleId),delete u.styleId),e.texts&&(u.texts=n.importSegmentArray(e.texts,t)),u}}))}},{key:"importMultipleValues",value:function(e,t){var n=this,r=e.map((function(e){return Array.isArray(e.value)?Object.assign({},e,{value:n.importSegmentArray(e.value,t)}):e})),a=new dm(this.sheet.parent);return a.fromJSON(r),a}},{key:"importImages",value:function(e){if(e.image){var t=xg(e.image);for(var n in e.image){var r=Object.assign({},e.image[n]);if(r.link=sy(r.link),!r.fileToken){var a=cy(decodeURIComponent(r.link));a&&(ly(a),r.fileToken=a)}if(delete r.style,void 0!==r.styleId&&(r.style=this.style.getById(r.styleId),delete r.styleId),t){var o=r.refCount;this.image.addById(Number(n),r),this.image.setCounterById(Number(n),o)}else this.image.addById(Number(n),r)}}}},{key:"importMentions",value:function(e){if(e.mention){var t=xg(e.mention);for(var n in e.mention){var r=Object.assign({},e.mention[n]);if(this.setStyle2Segment(r),t){var a=r.refCount;this.mention.addById(Number(n),r),this.mention.setCounterById(Number(n),a)}else this.mention.addById(Number(n),r)}}}},{key:"importSegmentStyles",value:function(e){if(e.entities){var t=e.entities.segmentStyles,n=xg(t);for(var r in t){var a=Object.assign({},t[r]),o=Ad.fromJSON(this.sheet.parent.formatterService,a);if(n){var i=a.refCount;delete a.refCount,o&&this.style.addById(Number(r),o),o&&this.style.setCounterById(Number(r),i)}else o&&this.style.addById(Number(r),o)}}}},{key:"importAttachments",value:function(e){if(e.attachment){var t=xg(e.attachment);for(var n in e.attachment){var r=Object.assign({},e.attachment[n]);if(this.setStyle2Segment(r),t){var a=r.refCount;this.attachment.addById(Number(n),r),this.attachment.setCounterById(Number(n),a)}else this.attachment.addById(Number(n),r)}}}},{key:"setStyle2Segment",value:function(e){var t=this;return delete e.style,void 0!==e.styleId&&(e.style=this.style.getById(e.styleId),delete e.styleId),e.texts&&(e.texts=e.texts.map((function(e){var n=Object.assign({},e);if(e.styleId){var r=t.style.getById(e.styleId);r&&(n.style=r)}return n})),0===e.texts.length&&delete e.texts),e}},{key:"deserializeSegmentArray",value:function(e,t){var n,r=this,a=t.valueRefDelta,o=t.resourceRefDelta,i=t.formatDelta,u=a.richStrings[e],s=a.strings[u.textId],l=0,c=null,h=-1;return null!==(n=u.runs)&&void 0!==n&&n.forEach((function(e){c||(c=[]);var n,a=s.substring(l,e.endPos);switch(l=e.endPos,void 0!==e.fontId&&t.cellFormatRefHelper.fonts.checkValuesRefId(e.fontId,(function(e){n=r.style.getById(e)}),(function(){var t=i.fonts[e.fontId];n=Ad.fromJSON(r.sheet.parent.formatterService,xp({font:t}));var a=r.style.add(n);return n=a.ref,a.id})),e.runType){case we.B2l.CellRunType.CellRunType_Text:var u={type:we.K6s.TEXT,style:n,text:a};c.push(u);break;case we.B2l.CellRunType.CellRunType_Mention:var f=r.deserializeMention(e.refId,t,a,n,e.fontId);c.push(f);break;case we.B2l.CellRunType.CellRunType_Hyperlink:var d,v=o.hyperlinks[e.refId];if(v.type===we.B2l.HyperlinkType.HyperlinkType_Range){var g=v.url.split("-");d={sheetId:g[0],rangeId:g[1]}}else v.type===we.B2l.HyperlinkType.HyperlinkType_Worksheet&&(d={sheetId:v.url});if(h!==e.refId)c.push({type:we.K6s.URL,text:a,style:n,link:v.type===we.B2l.HyperlinkType.HyperlinkType_Normal?v.url:void 0,cellPosition:d});else{var m=c[c.length-1];m.texts||(m.texts=[{type:we.K6s.TEXT,style:m.style,text:m.text}],delete m.style),m.texts.push({type:we.K6s.TEXT,style:n,text:a}),m.text+=a}h=e.refId;break;case we.B2l.CellRunType.CellRunType_Attachment:var p=r.deserializeAttachment(e.refId,t,a,n);c.push(p)}e.runType!==we.B2l.CellRunType.CellRunType_Hyperlink&&(h=-1)})),c}},{key:"deserializeMention",value:function(e,t,n,r,a){var o,i,u=this,s=t.cellValueRefHelper,l=t.resourceRefDelta,c=l.mentions[e],h=c.mentionId,f=c.mentionInfoId;return s.mentionInfosDeserialize.checkValuesRefId(f,(function(e){o=s.mentionInfosDeserialize.getById(e)}),(function(){var e=l.mentionInfos[f];o=function(e){var t,n,r,a,o=e.mentionType===we.B2l.MENTION_TYPE.MENTION_TYPE_USER,i=e.mentionUserInfo,u=e.mentionFileInfo;return{type:we.K6s.MENTION,text:"",link:(o?null==i||null===(t=i.userInfo)||void 0===t?void 0:t.avatarUrl:null==u?void 0:u.link)||"",token:(o?null==i||null===(n=i.userInfo)||void 0===n?void 0:n.id:null==u?void 0:u.token)||"",mentionType:(o?0:Number(null==u?void 0:u.fileType))||0,not_notify:null==i?void 0:i.notNotify,block_notify:null==i?void 0:i.blockNotify,mentionNotify:null==i?void 0:i.mentionNotify,iconInfo:null==u?void 0:u.iconInfo,is_external:null==i?void 0:i.isExternal,category:o?"at-user-block":void 0,name:null==i||null===(r=i.userInfo)||void 0===r?void 0:r.name,en_name:null==i||null===(a=i.userInfo)||void 0===a?void 0:a.enName}}(e);var t=s.mentionInfosDeserialize.add(o);return o=t.ref,t.id})),s.mentionsDeserialize.checkValuesRefId(e,(function(e){i=s.mentionsDeserialize.getById(e)}),(function(){var e=Object.assign({type:we.K6s.MENTION,link:"",token:"",mentionType:0},o,{text:n,mentionId:h}),t=s.mentionsDeserialize.add(e);return i=t.ref,t.id})),s.getMentionWithStyleRefManager(a).checkValuesRefId(e,(function(e){i=u.mention.getById(e)}),(function(){var e=Object.assign({},i,{style:r}),t=u.mention.add(e);return i=t.ref,t.id})),i||{type:"text",text:""}}},{key:"deserializeAttachment",value:function(e,t,n,r){var a=t.resourceRefDelta.attachments[e],o={type:we.K6s.ATTACHMENT,style:r,text:n,fileToken:a.fileToken||"",mimeType:a.mimeType||"",size:a.size||0};return this.attachment.add(o).ref}},{key:"deserializeEmbedImage",value:function(e,t){var n,r=this,a=t.cellValueRefHelper,o=t.resourceRefDelta;return a.embedImages.checkValuesRefId(e,(function(e){n=r.image.getById(e)}),(function(){var t=o.embedImages[e],a={type:we.K6s.EMBED_IMAGE,height:t.size.h,width:t.size.w,text:"",link:t.link,fileToken:t.token},i=r.image.add(a);return n=i.ref,i.id})),n||{type:"text",text:""}}},{key:"mention",get:function(){return this.refMgrOptions.mention}},{key:"image",get:function(){return this.refMgrOptions.image}},{key:"attachment",get:function(){return this.refMgrOptions.attachment}},{key:"style",get:function(){return this.refMgrOptions.style}}]),e}(),my=function(e){function t(e){var n;return(0,y.Z)(this,t),(n=(0,d.Z)(this,(0,v.Z)(t).call(this))).sheet=e,n}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"getExporter",value:function(e,t,n,r){return new py(this,this.sheet,e,t,n,r)}},{key:"getImporter",value:function(){return new yy(this)}}]),t}(Kv),py=function(e){function t(e,n,r,a,o,i){var u;return(0,y.Z)(this,t),(u=(0,d.Z)(this,(0,v.Z)(t).call(this,e.iter(r,a,o,i)))).block=e,u.sheet=n,u}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"exportToCell",value:function(e,t){}},{key:"exportExtraInfo",value:function(e){var t={},n=this.block.iter(0,0,this.sheet.getRowCount(),this.sheet.getColumnCount());n.forEach((function(e){var r=n.position();if(e){var a=t[r.row];a||(a=t[r.row]={}),a[r.col]=e}})),delete e.comment,Zg(t)||(e.comment=t)}},{key:"serializeToMutations",value:function(e){var t=this.block.iter(0,0,this.sheet.getRowCount(),this.sheet.getColumnCount());t.forEach((function(n){var r=t.position(),a={startRow:r.row,startCol:r.col};n.forEach((function(t){var n=t.id,r=t.isResolved;e.push({type:we.B2l.MutationType.MutationType_AddComment,addComment:{value:{id:n,cell:a,isResolved:r}}})}))}))}}]),t}(Um),yy=function(){function e(t){(0,y.Z)(this,e),this.block=t}return(0,C.Z)(e,[{key:"importCell",value:function(e,t,n,r){}},{key:"importExtraInfo",value:function(e){if(e.comment)for(var t in e.comment)if(e.comment[t])for(var n in e.comment[t]){var r,a=null===(r=e.comment[t][n])||void 0===r?void 0:r.filter((function(e){return-1===e.id.indexOf("-")}));a&&this.block.set(Number(t),Number(n),a)}}}]),e}(),Cy={hour:9,minute:0,second:0,millisecond:0};function _y(e,t){if(!e)return null;var n=new by((0,At.v4)());if(n.fromJSON(e),void 0!==t){if(!("number"==typeof t&&t>=ke.SheetDate.MIN_DATE_VALUE&&t<=ke.SheetDate.MAX_DATE_VALUE))return null;n.setExpireTime(wy(t))}return n}function Ry(e){return e.id=(0,At.v4)(),e}function wy(e){var t=new ke.SheetDate(e).time;return Tt()().year(t.year).month(t.month-1).date(t.date).hour(t.hours).minute(t.minutes).second(t.seconds).millisecond(t.milliseconds).valueOf()}function ky(e){return ke.SheetDate.fromLocalDate(e).toNumber()}function Sy(e){we.Ps3.collectSuiteEvent&&we.Ps3.collectSuiteEvent("sheet_opration",e)}var Ey=[{id:6,text:fn("smartable.reminder.day_of_event"),getNotifyTime:function(e){return Tt()(e).set(Cy).valueOf()}},{id:7,text:fn("smartable.reminder.1_day_before"),getNotifyTime:function(e){return Tt()(e).subtract(1,"days").set(Cy).valueOf()}},{id:8,text:fn("smartable.reminder.2_day_before"),getNotifyTime:function(e){return Tt()(e).subtract(2,"days").set(Cy).valueOf()}},{id:9,text:fn("smartable.reminder.1_week_before"),getNotifyTime:function(e){return Tt()(e).subtract(1,"weeks").set(Cy).valueOf()}}],Ty=[{id:0,text:fn("smartable.reminder.at_time_of_event"),getNotifyTime:function(e){return e}},{id:1,text:fn("smartable.reminder.remind_before_min",5),getNotifyTime:function(e){return Tt()(e).subtract(5,"minutes").valueOf()}},{id:2,text:fn("smartable.reminder.remind_before_min",15),getNotifyTime:function(e){return Tt()(e).subtract(15,"minutes").valueOf()}},{id:3,text:fn("smartable.reminder.remind_before_min",30),getNotifyTime:function(e){return Tt()(e).subtract(30,"minutes").valueOf()}},{id:4,text:fn("smartable.reminder.1_hour_before"),getNotifyTime:function(e){return Tt()(e).subtract(1,"hours").valueOf()}},{id:5,text:fn("smartable.reminder.remind_before_hour",2),getNotifyTime:function(e){return Tt()(e).subtract(2,"hours").valueOf()}},{id:10,text:fn("reminder.popover.beforeDay",1),getNotifyTime:function(e){return Tt()(e).subtract(1,"days").valueOf()}},{id:11,text:fn("reminder.popover.beforeDay",2),getNotifyTime:function(e){return Tt()(e).subtract(2,"days").valueOf()}},{id:12,text:fn("reminder.popover.beforeWeek",1),getNotifyTime:function(e){return Tt()(e).subtract(1,"weeks").valueOf()}}],Ay=Ey.concat(Ty).reduce((function(e,t){return e[t.id]=t,e}),{});var Iy,by=function(){function e(t){(0,y.Z)(this,e),this.expireTime=0,this.notifyTime=0,this.notifyStrategy=0,this.notifyUsers=[],this.id=t}return(0,C.Z)(e,[{key:"setExpireTime",value:function(e){this.expireTime=e,this.setNotifyTimeByStrategy(this.notifyStrategy)}},{key:"setNotifyTime",value:function(e){this.notifyTime=e}},{key:"setNotifyStrategy",value:function(e){this.notifyStrategy=e,this.setNotifyTimeByStrategy(e)}},{key:"setNotifyTimeByStrategy",value:function(e){var t=function(e){var t=Ay[e];if(!t)throw new Error("invalid notify strategy id: ".concat(e));return t}(e);this.notifyTime=t.getNotifyTime(this.expireTime)}},{key:"getNotifyStrategy",value:function(){return this.notifyStrategy}},{key:"setNotifyUsers",value:function(e){this.notifyUsers=e}},{key:"getNotifyUsers",value:function(){return this.notifyUsers}},{key:"getNotifyUserIds",value:function(){return this.notifyUsers.map((function(e){return e.id}))}},{key:"setNotifyText",value:function(e){this.notifyText=e}},{key:"getNotifyText",value:function(){return this.notifyText}},{key:"removeNotifyText",value:function(){delete this.notifyText}},{key:"serialize",value:function(){return{expireTime:this.expireTime,notifyStrategyType:this.notifyStrategy+1,notifyTime:this.notifyTime,notifyText:this.notifyText,notifyUserIds:this.notifyUsers.map((function(e){return e.id})),id:this.id}}},{key:"deserialize",value:function(e){var t;this.expireTime=e.expireTime,this.setNotifyStrategy(e.notifyStrategyType-1),this.notifyTime=e.notifyTime,this.notifyText=e.notifyText,this.notifyUsers=(null===(t=e.notifyUserIds)||void 0===t?void 0:t.map((function(e){return{id:e}})))||[]}},{key:"toJSON",value:function(){var e={notifyUsers:this.notifyUsers.slice()};return this.assignReminderExceptUser(e,!1),e}},{key:"fromJSON",value:function(e){this.assignReminderExceptUser(e,!0),this.notifyUsers=e.notifyUsers.slice()}},{key:"fromJSONExceptUserDetails",value:function(e){this.assignReminderExceptUser(e,!0),this.notifyUsers=e.notifyUserIds.map((function(e){return{id:e}}))}},{key:"toJSONExceptUserDetails",value:function(){var e={notifyUserIds:this.notifyUsers.map((function(e){return e.id}))};return this.assignReminderExceptUser(e,!1),e}},{key:"toChangeset",value:function(){var e={id:this.id,notifyUsers:this.notifyUsers.slice()};return this.assignReminderExceptUser(e,!1),e}},{key:"fromChangeset",value:function(e){this.assignReminderExceptUser(e,!0),this.notifyUsers=e.notifyUsers.slice()}},{key:"assignReminderExceptUser",value:function(e,t){t?(this.notifyTime=e.notifyTime,this.notifyStrategy=e.notifyStrategy,this.expireTime=e.expireTime,void 0!==e.notifyText&&(this.notifyText=e.notifyText)):(e.notifyTime=this.notifyTime,e.notifyStrategy=this.notifyStrategy,e.expireTime=this.expireTime,void 0!==this.notifyText&&(e.notifyText=this.notifyText))}}],[{key:"fromReminder",value:function(t){var n=new e(t.id);return n.fromChangeset(t.toChangeset()),n}}]),e}(),Fy=1e3,My=500,Vy=function(e){function t(e){var n;return(0,y.Z)(this,t),(n=(0,d.Z)(this,(0,v.Z)(t).call(this))).sheet=e,n.reminders=new Map,n}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"set",value:function(e,n,r){var a=this.get(e,n);(a||r)&&(0,f.Z)((0,v.Z)(t.prototype),"set",this).call(this,e,n,r),a&&this.reminders.delete(a.id),r&&this.reminders.set(r.id,r)}},{key:"setReminderById",value:function(e,t){this.reminders.set(e,t)}},{key:"getReminderById",value:function(e){return this.reminders.get(e)}},{key:"delRow",value:function(e,n,r){this.removeReminderInRange(e,0,n,Hv),(0,f.Z)((0,v.Z)(t.prototype),"delRow",this).call(this,e,n,r)}},{key:"delCol",value:function(e,n){this.removeReminderInRange(0,e,Hv,n),(0,f.Z)((0,v.Z)(t.prototype),"delCol",this).call(this,e,n)}},{key:"removeReminderInRange",value:function(e,t,n,r){var a=this;this.iter(e,t,n,r).forEach((function(e){a.reminders.delete(e.id)}))}},{key:"isEmpty",value:function(){return 0===this.count()}},{key:"count",value:function(){return this.reminders.size}},{key:"values",value:function(){return this.reminders.values()}},{key:"entries",value:function(){return this.reminders.entries()}},{key:"getImporter",value:function(){return new Oy(this)}},{key:"getExporter",value:function(e,t,n,r){return new Ny(this,e,t,n,r)}}]),t}(Kv),Ny=function(e){function t(e,n,r,a,o){var i;return(0,y.Z)(this,t),(i=(0,d.Z)(this,(0,v.Z)(t).call(this,e.iter(n,r,a,o)))).block=e,i}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"serializeCell",value:function(e,t,n){e.reminderId=n.cellValueRefHelper.reminderIds.addValue(t.id)}},{key:"serializeToMutations",value:function(e){var t,n=_n(this.block.entries());try{for(n.s();!(t=n.n()).done;){var r=(0,p.Z)(t.value,2)[1];e.push({type:we.B2l.MutationType.MutationType_AddReminder,addReminder:{value:r.serialize()}})}}catch(e){n.e(e)}finally{n.f()}}},{key:"exportToCell",value:function(e,t){e&&t&&(e.reminderId=t.id)}},{key:"exportExtraInfo",value:function(e){var t,n={},r=_n(this.block.entries());try{for(r.s();!(t=r.n()).done;){var a=(0,p.Z)(t.value,2),o=a[0],i=a[1];n[o]=i.toJSONExceptUserDetails()}}catch(e){r.e(e)}finally{r.f()}delete e.reminders,(0,se.default)(n)||(e.reminders=n)}}]),t}(Um),Oy=function(){function e(t){(0,y.Z)(this,e),this.block=t}return(0,C.Z)(e,[{key:"importCell",value:function(e,t,n,r){if(n.reminderId){var a=this.block.getReminderById(n.reminderId);a&&this.block.set(e,t,a)}}},{key:"importExtraInfo",value:function(e){for(var t=e.reminders||{},n=Object.keys(t),r=n.length-1;r>=0;r--){var a=n[r],o=new by(a);o.fromJSONExceptUserDetails(t[a]),this.block.setReminderById(a,o)}}}]),e}(),xy={LABEL:"lhs"},Zy={LABEL:"rhs"},Dy={LABEL:"firstArgument"},Py={LABEL:"restArguments"},Ly={LABEL:"firstCall"},By={LABEL:"restCalls"},Uy=function(e){function t(e){var n,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"A1";(0,y.Z)(this,t),(n=(0,d.Z)(this,(0,v.Z)(t).call(this,e,{nodeLocationTracking:"onlyOffset",skipValidations:!0,maxLookahead:1}))).refStyle=r;var a=(0,c.Z)(n),o=[];return a.RULE("entry",(function(){o.push(!0),a.OPTION((function(){a.CONSUME($s.WhiteSpace)})),a.SUBRULE(a.formula),a.OPTION2((function(){a.CONSUME2($s.WhiteSpace)})),o.pop()})),a.RULE("formula",(function(){a.SUBRULE(a.concatExp,xy),a.MANY((function(){a.CONSUME($s.ComparisonOperator),a.SUBRULE2(a.concatExp,Zy)}))})),a.RULE("concatExp",(function(){a.SUBRULE(a.addExp,xy),a.MANY((function(){a.CONSUME($s.Concatenate),a.SUBRULE2(a.addExp,Zy)}))})),a.RULE("addExp",(function(){a.SUBRULE(a.mulExp,xy),a.MANY((function(){a.CONSUME($s.AdditionOperator),a.SUBRULE2(a.mulExp,Zy)}))})),a.RULE("mulExp",(function(){a.SUBRULE(a.powExp,xy),a.MANY((function(){a.CONSUME($s.MultiplicationOperator),a.SUBRULE2(a.powExp,Zy)}))})),a.RULE("powExp",(function(){a.SUBRULE(a.percentExp,xy),a.MANY((function(){a.CONSUME($s.Power),a.SUBRULE2(a.percentExp,Zy)}))})),a.RULE("percentExp",(function(){a.SUBRULE(a.prefixExp),a.MANY((function(){a.CONSUME($s.Percent)}))})),a.RULE("prefixExp",(function(){a.MANY((function(){a.CONSUME($s.AdditionOperator)})),a.SUBRULE(a.baseFormula)})),a.RULE("baseFormula",(function(){a.OR([{ALT:function(){return a.SUBRULE(a.simpleConstant)}},{ALT:function(){return a.SUBRULE(a.matrixConstant)}},{GATE:function(){return!0===o[o.length-1]},ALT:function(){return a.SUBRULE(a.advancedReference)}},{GATE:function(){return!1===o[o.length-1]},ALT:function(){return a.SUBRULE(a.notCommaAdvancedReference)}}])})),a.RULE("advancedReference",(function(){a.SUBRULE(a.intersectExp,xy),a.MANY((function(){a.CONSUME($s.Comma),a.SUBRULE2(a.intersectExp,Zy)}))})),a.RULE("intersectExp",(function(){a.SUBRULE(a.rangeExp,xy),a.MANY((function(){a.CONSUME($s.WhiteSpace),a.OPTION((function(){a.SUBRULE2(a.rangeExp,Zy)}))}))})),a.RULE("rangeExp",(function(){a.SUBRULE(a.referenceFunction,xy),a.MANY((function(){a.CONSUME($s.Colon),a.SUBRULE2(a.referenceFunction,Zy)}))})),a.RULE("notCommaAdvancedReference",(function(){a.SUBRULE(a.notCommaRangeExp,xy),a.MANY((function(){a.CONSUME($s.WhiteSpace),a.SUBRULE2(a.notCommaRangeExp,Zy)}))})),a.RULE("notCommaRangeExp",(function(){a.SUBRULE(a.referenceFunction,xy),a.MANY((function(){a.CONSUME($s.Colon),a.SUBRULE2(a.referenceFunction,Zy)}))})),a.RULE("referenceFunction",(function(){a.OR(a.c1||(a.c1=[{ALT:function(){switch(n.refStyle){case"A1":a.CONSUME($s.LocalReferenceA1);break;case"R1C1":a.CONSUME($s.LocalReferenceR1C1);break;default:throw Error("RefStyle is not found!")}}},{ALT:function(){switch(n.refStyle){case"A1":a.CONSUME($s.ExternalReferenceA1);break;case"R1C1":a.CONSUME($s.ExternalReferenceR1C1);break;default:throw Error("RefStyle is not found!")}}},{ALT:function(){a.CONSUME($s.FieldNameLocalReferenceA1)}},{ALT:function(){return a.CONSUME($s.RefConstant)}},{ALT:function(){return a.CONSUME($s.Name)}},{ALT:function(){return a.SUBRULE(a.parenExp)}},{ALT:function(){return a.SUBRULE(a.funcExp)}}]))})),a.RULE("parenExp",(function(){a.CONSUME($s.OpenParen),o.push(!0),a.SUBRULE(a.formula),o.pop(),a.CONSUME($s.CloseParen),a.MANY((function(){a.CONSUME($s.OpenParen),a.SUBRULE(a.arguments),a.CONSUME1($s.CloseParen)}))})),a.RULE("funcExp",(function(){a.CONSUME($s.FunctionName),a.SUBRULE(a.arguments,Ly),a.CONSUME1($s.CloseParen),a.MANY((function(){a.CONSUME($s.OpenParen),a.SUBRULE1(a.arguments,By),a.CONSUME1($s.CloseParen)}))})),a.RULE("arguments",(function(){o.push(!1),a.OPTION((function(){a.SUBRULE1(a.formula,Dy)})),o.pop(),a.MANY((function(){a.CONSUME($s.Comma),o.push(!1),a.OPTION1((function(){a.SUBRULE2(a.formula,Py)})),o.pop()}))})),a.RULE("simpleConstant",(function(){a.OR([{ALT:function(){return a.CONSUME($s.LogicalConstant)}},{ALT:function(){return a.CONSUME($s.NumericalConstant)}},{ALT:function(){return a.CONSUME($s.StringConstant)}},{ALT:function(){return a.CONSUME($s.ErrorConstant)}}])})),a.RULE("matrixConstant",(function(){a.CONSUME($s.OpenBrace),a.SUBRULE(a.simpleConstantList,xy),a.MANY((function(){a.CONSUME($s.SemiColon),a.SUBRULE1(a.simpleConstantList,Zy)})),a.CONSUME($s.CloseBrace)})),a.RULE("simpleConstantList",(function(){o.push(!1),a.SUBRULE(a.formula,xy),o.pop(),a.MANY((function(){a.CONSUME($s.Comma),o.push(!1),a.SUBRULE1(a.formula,Zy),o.pop()}))})),n.performSelfAnalysis(),n}return(0,g.Z)(t,e),(0,C.Z)(t,null,[{key:"getTractorParserA1",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:qs;return null==this.tractorParserA1&&(this.tractorParserA1=new t(e,"A1")),this.tractorParserA1}},{key:"getTractorParserR1C1",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:Ys;return null==this.tractorParserR1C1&&(this.tractorParserR1C1=new t(e,"R1C1")),this.tractorParserR1C1}},{key:"dispose",value:function(){this.tractorParserA1=null,this.tractorParserR1C1=null}}]),t}(wt.CstParser);!function(e){e.entry="entry",e.formula="formula",e.concatExp="concatExp",e.addExp="addExp",e.mulExp="mulExp",e.powExp="powExp",e.percentExp="percentExp",e.prefixExp="prefixExp",e.baseFormula="baseFormula",e.simpleConstant="simpleConstant",e.matrixConstant="matrixConstant",e.advancedReference="advancedReference",e.notCommaAdvancedReference="notCommaAdvancedReference",e.intersectExp="intersectExp",e.rangeExp="rangeExp",e.referenceFunction="referenceFunction",e.notCommaRangeExp="notCommaRangeExp",e.simpleConstantList="simpleConstantList",e.parenExp="parenExp",e.funcExp="funcExp",e.arguments="arguments"}(Iy||(Iy={}));var Hy=function(e){function t(){var e;return(0,y.Z)(this,t),(e=(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))).name="+",e}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"opImpl",value:function(e,t){return new ut.NumberVar(e.getValue()+t.getValue())}}]),t}(ut.NumberBinaryOp),Wy=function(e){function t(){var e;return(0,y.Z)(this,t),(e=(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))).name="-",e}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"opImpl",value:function(e,t){return new ut.NumberVar(e.getValue()-t.getValue())}}]),t}(ut.NumberBinaryOp),jy=function(e){function t(){var e;return(0,y.Z)(this,t),(e=(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))).name="+",e}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"opImpl",value:function(e,t){var n=e.getValue(),r=t.getValue(),a=ut.NumberVar.doubleEqual(n,-r)?0:n+r;return new ut.NumberVar(a)}}]),t}(ut.NumberBinaryOp),zy=function(e){function t(){var e;return(0,y.Z)(this,t),(e=(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))).name="-",e}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"opImpl",value:function(e,t){var n=e.getValue(),r=t.getValue(),a=ut.NumberVar.doubleEqual(n,r)?0:n-r;return new ut.NumberVar(a)}}]),t}(ut.NumberBinaryOp),Gy={isAlwaysCalc:!1},Jy=function(e){return e.replace(/\uFF08/g,"(")},qy=function(e){return e.replace(/\uFF09/g,")")},$y=function(e){return e.replace(/\uFF0C/g,",")},Yy=function(e){return e.replace(/\uFF1B/g,";")};function Ky(e){for(var t in e)if(Object.prototype.hasOwnProperty.call(e,t))return!1;return!0}var Xy,Qy=function(e){function t(e){var n;return(0,y.Z)(this,t),(n=(0,d.Z)(this,(0,v.Z)(t).call(this,e))).operands=0,n.optionOperands=256,n.resultType=ut.VAR_TYPE.ERROR,n.repeatedLastParam=0,n.paramsDesc=[],n}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"calc",value:function(){return ut.tractorErrorVarCreators[ut.ErrorCode.UNKNOWN_FUNCTION]({funcName:this.name})}}]),t}(ut.FuncOpBase),eC=ut.VAR_TYPE.NULL,tC=ut.VAR_TYPE.NUMBER,nC=ut.VAR_TYPE.STRING,rC=ut.VAR_TYPE.BOOL,aC=ut.VAR_TYPE.ERROR,oC=ut.VAR_TYPE.PRIMITIVE,iC=ut.VAR_TYPE.COLLECTION,uC=ut.VAR_TYPE.FORMULA,sC=ut.VAR_TYPE.OPERATOR,lC=(ut.VAR_TYPE.THROW,ut.VAR_TYPE.ASYNC),cC=(ut.VAR_TYPE.UNPREDICTABLE,ut.VAR_TYPE.CUSTOM_PRIMITIVE),hC=ut.VAR_TYPE.CUSTOM_COLLECTION,fC=ut.VAR_TYPE.BASIC,dC=ut.VAR_TYPE.ATOM,vC=ut.VAR_TYPE.ALL;function gC(e,t,n,r,a,o){return function(i){function u(){var i;return(0,y.Z)(this,u),(i=(0,d.Z)(this,(0,v.Z)(u).apply(this,arguments))).name=e,i.operands=t,i.optionOperands=n,i.repeatedLastParam=r,i.resultType=a,i.paramsDesc=o,i}return(0,g.Z)(u,i),u}(ut.FuncOpBase)}!function(e){e[e.ImportRangeDatas=0]="ImportRangeDatas",e[e.ImportRangeDatasV3=1]="ImportRangeDatasV3",e[e.ImportFormulas=2]="ImportFormulas",e[e.DocsTitles=3]="DocsTitles"}(Xy||(Xy={}));var mC,pC=20,yC=18e4;!function(e){e.onDeleteFormula="onDeleteImportRangeFormula",e.onAddFormula="onAddImportRangeFormula",e.onAfterRequest="onAfterRequest",e.onReceiveDataset="onReceiveImportRangeDataset",e.onReceiveData="onReceiveImportRangeData",e.onReceiveDataHash="onReceiveDataHash",e.onRefreshData="onRefreshData",e.onDeactivateImportRange="onDeactivateImportRange",e.onImportRangeValueChanged="onImportRangeValueChanged",e.onDeleteFormulaV3="onDeleteFormulaV3"}(mC||(mC={}));var CC={retriedTimes:0,forceFetch:!1,delayTimeBeforeFetch:0,shouldRetry:!0,retryImportRangeErrorCodes:[we.O6N.DATA_NOT_READY]};function _C(e){var t,n;return{promise:new Promise((function(r,a){t=r,n=a,null!=e&&e(r,a)})),resolve:t,reject:n}}function RC(e,t){if(Array.isArray(e)){for(var n="",r=0;r<e.length;++r){var a=e[r];"mention"===a.type&&"id"in a&&t.mention?n+=t.mention[a.id].text:"text"in a&&(n+=a.text||"")}return RC(n,t)}switch((0,_.Z)(e)){case"string":return new ut.StringVar(e);case"number":return new ut.NumberVar(e);case"boolean":return new ut.BooleanVar(e);default:return ut.NULL_VAR}}function wC(e){var t,n={};if(!e)return n;var r=dn.concat(e.map((function(e){return dn.from(e.gzip_datatable,"base64")}))),a=(0,we.ecX)(r.toString("base64"));return null!=a&&null!==(t=a.entities)&&void 0!==t&&t.styles&&(n.style=a.entities.styles),null!=a&&a.mention&&(n.mention=a.mention),n}function kC(e,t){return SC.apply(this,arguments)}function SC(){return SC=(0,u.Z)(i().mark((function e(t,n){var r,a,o,u=arguments;return i().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:r=u.length>2&&void 0!==u[2]?u[2]:pC,a=[],o=0;case 3:if(!(o<t.length)){e.next=13;break}if(a.push(t[o]),e.t0=a.length>=r,!e.t0){e.next=10;break}return e.next=9,n(a);case 9:a=[];case 10:o++,e.next=3;break;case 13:if(e.t1=a.length,!e.t1){e.next=17;break}return e.next=17,n(a);case 17:case"end":return e.stop()}}),e)}))),SC.apply(this,arguments)}function EC(e){return!(e instanceof we.rBk)&&e.hasOwnProperty("isNoChange")}function TC(e){return e.hasOwnProperty("importRangeId")}function AC(e,t){return e.getCalcEngine().formulaSpace.formulas.has(t)}function IC(e){var t=e.rowCount,n=e.colCount,r=e.metaToken,a=e.hash,o=e.blocks,i={extraInfo:wC(e.snapshotBlocks),dataTable:[]};if(!o||0===o.length){i.dataTable=[];for(var u=0;u<t;++u)i.dataTable.push(new Array(n).fill(ut.NULL_VAR));return{data:i,updateTime:e.updateTime,metaToken:r,hash:a}}for(var s=0,l=0,c=0;c<o.length;++c){for(var h=o[c],f=h.rowsCount,d=h.startRowIndex,v=s;v<d;++v)i.dataTable[v]=new Array(n).fill(ut.NULL_VAR);l+=h.gzip_datatable.length;for(var g=(0,we.ecX)(h.gzip_datatable),m=d+f,p=s;p<m;++p)if(g.rows[p-s]){i.dataTable[p]||(i.dataTable[p]=[]);for(var y=g.rows[p-s].columns,C=0;C<n;++C){var _=ut.NULL_VAR;if(C<y.length&&y[C]){var R=y[C],w=R.value,k=R.styleId;if(_=RC(w,i.extraInfo),k&&i.extraInfo.style){var S=i.extraInfo.style[k],E=S.autoFormatter,T=S.formatter,A=(null==T?void 0:T.formatCached)||(null==E?void 0:E.formatCached);A&&_.setSpecialInfo({customData:{autoFormat:A}})}}i.dataTable[p][C]=_}}else i.dataTable[p]=new Array(n).fill(ut.NULL_VAR);s=m}l&&we.Ps3.collectSuiteEvent("client_sheet_path_tracker_dev",{trace_code:15,length:l});for(var I=s;I<t;++I)i.dataTable[I]=new Array(n).fill(ut.NULL_VAR);return{data:i,updateTime:e.updateTime,metaToken:r,hash:a}}var bC=1e3,FC=32,MC=12e4;var VC=function(){function e(t){(0,y.Z)(this,e),this.requestArray=t}return(0,C.Z)(e,[{key:"resolve",value:function(e){this.requestArray.forEach((function(t){return(0,t.resolve)(e)})),this.requestArray=[]}},{key:"reject",value:function(e){this.requestArray.forEach((function(t){return(0,t.reject)(e)})),this.requestArray=[]}}]),e}(),NC=function(e){function t(e,n,r){var a;return(0,y.Z)(this,t),(a=(0,d.Z)(this,(0,v.Z)(t).call(this,n))).requestFn=e,a.spreadToken=r,a}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"exec",value:function(){return this.requestFn(Array.from(new Set(this.requestArray.map((function(e){return e.importRangeId})))),this.spreadToken)}},{key:"remove",value:function(e){for(var t=this.requestArray.length-1;t>=0;t--){var n=this.requestArray[t];if(n.importRangeId===e)return n.reject(we.DZv[we.O6N.REQUEST_FAIL]),this.requestArray.splice(t,1),!0}return!1}}]),t}(VC),OC=function(e){function t(e,n){var r;return(0,y.Z)(this,t),(r=(0,d.Z)(this,(0,v.Z)(t).call(this,n))).requestFn=e,r}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"exec",value:function(){return this.requestFn(this.requestArray.map((function(e){return e.params})))}}]),t}(VC),xC=function(e){function t(e,n){var r;return(0,y.Z)(this,t),(r=(0,d.Z)(this,(0,v.Z)(t).call(this,n))).requestFn=e,r}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"exec",value:function(){return this.requestFn(this.requestArray[0].spreadToken,this.requestArray.map((function(e){return e.params})))}}]),t}(VC),ZC=function(e){function t(e,n){var r;return(0,y.Z)(this,t),(r=(0,d.Z)(this,(0,v.Z)(t).call(this,n))).requestFn=e,r}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"exec",value:function(){var e=new Map;return this.requestArray.forEach((function(t){return t.data.forEach((function(t){e.has(t.token)||e.set(t.token,t)}))})),this.requestFn(Array.from(e.values()))}}]),t}(VC),DC=function(){function e(t){(0,y.Z)(this,e),this.fetchList=t,this.requestQueue=[],this.requestTime=[],this.pendingCount=0,this.timer=null,this.mergedTimer=null,this.mergedDelayTime=1e3,this.requestPromiseArray=[]}return(0,C.Z)(e,[{key:"setDelayTime",value:function(e){this.mergedDelayTime=e}},{key:"push",value:function(e){var t=this;this.requestPromiseArray.push(e),null===this.mergedTimer&&(this.mergedTimer=window.setTimeout((function(){return t.processMergeTimer()}),this.mergedDelayTime))}},{key:"processMergeTimer",value:function(){for(;this.requestPromiseArray.length;)this.mergedAndPoll();this.mergedTimer&&window.clearTimeout(this.mergedTimer),this.mergedTimer=null}},{key:"mergedImpoarRangeDataRequest",value:function(e){var t=this,n={};e.forEach((function(e){var t=e.spreadToken;n[t]?n[t].push(e):n[t]=[e]}));var r=[];return Object.entries(n).forEach((function(e){var n=(0,p.Z)(e,2),a=n[0],o=n[1];return r.push(new NC(t.fetchList[Xy.ImportRangeDatas],o,a))})),r}},{key:"mergedAndPoll",value:function(){var e=[],t=[],n=[],r=[];if(this.requestPromiseArray.forEach((function(a){switch(a.type){case Xy.ImportRangeDatas:e.push(a);break;case Xy.ImportRangeDatasV3:t.push(a);break;case Xy.DocsTitles:n.push(a);break;case Xy.ImportFormulas:r.push(a)}})),e.length&&this.fetchList[Xy.ImportRangeDatas]){var a=this.mergedImpoarRangeDataRequest(e);(0,we.hTd)(this.requestQueue,a)}t.length&&this.fetchList[Xy.ImportRangeDatasV3]&&this.requestQueue.push(new OC(this.fetchList[Xy.ImportRangeDatasV3],t)),n.length&&this.fetchList[Xy.DocsTitles]&&this.requestQueue.push(new ZC(this.fetchList[Xy.DocsTitles],n)),r.length&&this.fetchList[Xy.ImportFormulas]&&this.requestQueue.push(new xC(this.fetchList[Xy.ImportFormulas],r)),this.requestPromiseArray=[],this.poll()}},{key:"poll",value:function(){for(var e=this;this.requestTime.length>0&&this.requestTime[0]<Date.now()-bC;)this.requestTime.shift();if(!(this.pendingCount>=6)){if(this.requestTime.length>=FC)return null!=this.timer&&window.clearTimeout(this.timer),void(this.timer=window.setTimeout(this.poll.bind(this),bC/2));var t=this.requestQueue.shift();if(null!=t){this.requestTime.push(Date.now()),this.pendingCount++;var n=PC(t.exec.bind(t)).finally((function(){e.pendingCount--,e.poll()}));t.resolve(n),this.poll()}}}},{key:"remove",value:function(e){for(var t=this.requestPromiseArray.length-1;t>=0;t--){var n=this.requestPromiseArray[t];if(TC(n)&&n.importRangeId===e)return void this.requestPromiseArray.splice(t,1)}for(var r=this.requestQueue.length-1;r>=0;r--){var a=this.requestQueue[r];if(a instanceof NC&&a.remove(e))return}}},{key:"dispose",value:function(){for(var e=this.requestQueue.length-1;e>=0;e--)this.requestQueue[e].reject(we.DZv[we.O6N.REQUEST_FAIL]);this.requestQueue=[],null!=this.timer&&window.clearTimeout(this.timer),this.timer=null,this.mergedTimer&&window.clearTimeout(this.mergedTimer),this.mergedTimer=null}}]),e}();function PC(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:MC;return new Promise((function(n,r){var a=window.setTimeout((function(){console.error("request timeout"),r(we.DZv[we.O6N.REQUEST_FAIL])}),t),o=e();o?o.then(n).catch(r).finally((function(){window.clearTimeout(a)})):(n({}),window.clearTimeout(a))}))}var LC=2147483647,BC=/[^\x20-\x7E]/,UC=/[\x2E\u3002\uFF0E\uFF61]/g,HC={overflow:"Overflow: input needs wider integers to process","not-basic":"Illegal input >= 0x80 (not a basic code point)","invalid-input":"Invalid input"},WC=Math.floor,jC=String.fromCharCode;function zC(e){throw new RangeError(HC[e])}function GC(e,t){return e+22+75*(e<26)-((0!=t)<<5)}function JC(e,t,n){var r=0;for(e=n?WC(e/700):e>>1,e+=WC(e/t);e>455;r+=36)e=WC(e/35);return WC(r+36*e/(e+38))}function qC(e){return function(e,t){var n=e.split("@"),r="";return n.length>1&&(r=n[0]+"@",e=n[1]),r+function(e,t){for(var n=e.length,r=[];n--;)r[n]=t(e[n]);return r}((e=e.replace(UC,".")).split("."),t).join(".")}(e,(function(e){return BC.test(e)?"xn--"+function(e){var t,n,r,a,o,i,u,s,l,c,h,f,d,v,g,m=[];for(f=(e=function(e){for(var t,n,r=[],a=0,o=e.length;a<o;)(t=e.charCodeAt(a++))>=55296&&t<=56319&&a<o?56320==(64512&(n=e.charCodeAt(a++)))?r.push(((1023&t)<<10)+(1023&n)+65536):(r.push(t),a--):r.push(t);return r}(e)).length,t=128,n=0,o=72,i=0;i<f;++i)(h=e[i])<128&&m.push(jC(h));for(r=a=m.length,a&&m.push("-");r<f;){for(u=LC,i=0;i<f;++i)(h=e[i])>=t&&h<u&&(u=h);for(u-t>WC((LC-n)/(d=r+1))&&zC("overflow"),n+=(u-t)*d,t=u,i=0;i<f;++i)if((h=e[i])<t&&++n>LC&&zC("overflow"),h==t){for(s=n,l=36;!(s<(c=l<=o?1:l>=o+26?26:l-o));l+=36)g=s-c,v=36-c,m.push(jC(GC(c+g%v,0))),s=WC(g/v);m.push(jC(GC(s,0))),o=JC(n,d,r==a),n=0,++r}++n,++t}return m.join("")}(e):e}))}function $C(e){return null===e}function YC(e){return"string"==typeof e}function KC(e){return"object"==(0,_.Z)(e)&&null!==e}function XC(e,t){return Object.prototype.hasOwnProperty.call(e,t)}var QC=Array.isArray||function(e){return"[object Array]"===Object.prototype.toString.call(e)};function e_(e){switch((0,_.Z)(e)){case"string":return e;case"boolean":return e?"true":"false";case"number":return isFinite(e)?e:"";default:return""}}function t_(e,t){if(e.map)return e.map(t);for(var n=[],r=0;r<e.length;r++)n.push(t(e[r],r));return n}var n_=Object.keys||function(e){var t=[];for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&t.push(n);return t};function r_(e,t,n,r){t=t||"&",n=n||"=";var a={};if("string"!=typeof e||0===e.length)return a;var o=/\+/g;e=e.split(t);var i=1e3;r&&"number"==typeof r.maxKeys&&(i=r.maxKeys);var u=e.length;i>0&&u>i&&(u=i);for(var s=0;s<u;++s){var l,c,h,f,d=e[s].replace(o,"%20"),v=d.indexOf(n);v>=0?(l=d.substr(0,v),c=d.substr(v+1)):(l=d,c=""),h=decodeURIComponent(l),f=decodeURIComponent(c),XC(a,h)?QC(a[h])?a[h].push(f):a[h]=[a[h],f]:a[h]=f}return a}var a_={parse:w_,resolve:function(e,t){return w_(e,!1,!0).resolve(t)},resolveObject:function(e,t){return e?w_(e,!1,!0).resolveObject(t):t},format:function(e){return YC(e)&&(e=k_({},e)),S_(e)},Url:o_};function o_(){this.protocol=null,this.slashes=null,this.auth=null,this.host=null,this.port=null,this.hostname=null,this.hash=null,this.search=null,this.query=null,this.pathname=null,this.path=null,this.href=null}var i_,u_,s_,l_,c_=/^([a-z0-9.+-]+:)/i,h_=/:[0-9]*$/,f_=/^(\/\/?(?!\/)[^\?\s]*)(\?[^\s]*)?$/,d_=["{","}","|","\\","^","`"].concat(["<",">",'"',"`"," ","\r","\n","\t"]),v_=["'"].concat(d_),g_=["%","/","?",";","#"].concat(v_),m_=["/","?","#"],p_=/^[+a-z0-9A-Z_-]{0,63}$/,y_=/^([+a-z0-9A-Z_-]{0,63})(.*)$/,C_={javascript:!0,"javascript:":!0},__={javascript:!0,"javascript:":!0},R_={http:!0,https:!0,ftp:!0,gopher:!0,file:!0,"http:":!0,"https:":!0,"ftp:":!0,"gopher:":!0,"file:":!0};function w_(e,t,n){if(e&&KC(e)&&e instanceof o_)return e;var r=new o_;return r.parse(e,t,n),r}function k_(e,t,n,r){if(!YC(t))throw new TypeError("Parameter 'url' must be a string, not "+(0,_.Z)(t));var a=t.indexOf("?"),o=-1!==a&&a<t.indexOf("#")?"?":"#",i=t.split(o);i[0]=i[0].replace(/\\/g,"/");var u=t=i.join(o);if(u=u.trim(),!r&&1===t.split("#").length){var s=f_.exec(u);if(s)return e.path=u,e.href=u,e.pathname=s[1],s[2]?(e.search=s[2],e.query=n?r_(e.search.substr(1)):e.search.substr(1)):n&&(e.search="",e.query={}),e}var l,c,h,f,d=c_.exec(u);if(d){var v=(d=d[0]).toLowerCase();e.protocol=v,u=u.substr(d.length)}if(r||d||u.match(/^\/\/[^@\/]+@[^@\/]+/)){var g="//"===u.substr(0,2);!g||d&&__[d]||(u=u.substr(2),e.slashes=!0)}if(!__[d]&&(g||d&&!R_[d])){var m,p,y=-1;for(l=0;l<m_.length;l++)-1!==(c=u.indexOf(m_[l]))&&(-1===y||c<y)&&(y=c);for(-1!==(p=-1===y?u.lastIndexOf("@"):u.lastIndexOf("@",y))&&(m=u.slice(0,p),u=u.slice(p+1),e.auth=decodeURIComponent(m)),y=-1,l=0;l<g_.length;l++)-1!==(c=u.indexOf(g_[l]))&&(-1===y||c<y)&&(y=c);-1===y&&(y=u.length),e.host=u.slice(0,y),u=u.slice(y),E_(e),e.hostname=e.hostname||"";var C="["===e.hostname[0]&&"]"===e.hostname[e.hostname.length-1];if(!C){var R=e.hostname.split(/\./);for(l=0,h=R.length;l<h;l++){var w=R[l];if(w&&!w.match(p_)){for(var k="",S=0,E=w.length;S<E;S++)w.charCodeAt(S)>127?k+="x":k+=w[S];if(!k.match(p_)){var T=R.slice(0,l),A=R.slice(l+1),I=w.match(y_);I&&(T.push(I[1]),A.unshift(I[2])),A.length&&(u="/"+A.join(".")+u),e.hostname=T.join(".");break}}}}e.hostname.length>255?e.hostname="":e.hostname=e.hostname.toLowerCase(),C||(e.hostname=qC(e.hostname)),f=e.port?":"+e.port:"";var b=e.hostname||"";e.host=b+f,e.href+=e.host,C&&(e.hostname=e.hostname.substr(1,e.hostname.length-2),"/"!==u[0]&&(u="/"+u))}if(!C_[v])for(l=0,h=v_.length;l<h;l++){var F=v_[l];if(-1!==u.indexOf(F)){var M=encodeURIComponent(F);M===F&&(M=escape(F)),u=u.split(F).join(M)}}var V=u.indexOf("#");-1!==V&&(e.hash=u.substr(V),u=u.slice(0,V));var N=u.indexOf("?");if(-1!==N?(e.search=u.substr(N),e.query=u.substr(N+1),n&&(e.query=r_(e.query)),u=u.slice(0,N)):n&&(e.search="",e.query={}),u&&(e.pathname=u),R_[v]&&e.hostname&&!e.pathname&&(e.pathname="/"),e.pathname||e.search){f=e.pathname||"";var O=e.search||"";e.path=f+O}return e.href=S_(e),e}function S_(e){var t=e.auth||"";t&&(t=(t=encodeURIComponent(t)).replace(/%3A/i,":"),t+="@");var n=e.protocol||"",r=e.pathname||"",a=e.hash||"",o=!1,i="";e.host?o=t+e.host:e.hostname&&(o=t+(-1===e.hostname.indexOf(":")?e.hostname:"["+this.hostname+"]"),e.port&&(o+=":"+e.port)),e.query&&KC(e.query)&&Object.keys(e.query).length&&(i=function(e,t,n,r){return t=t||"&",n=n||"=",null===e&&(e=void 0),"object"==(0,_.Z)(e)?t_(n_(e),(function(r){var a=encodeURIComponent(e_(r))+n;return QC(e[r])?t_(e[r],(function(e){return a+encodeURIComponent(e_(e))})).join(t):a+encodeURIComponent(e_(e[r]))})).join(t):r?encodeURIComponent(e_(r))+n+encodeURIComponent(e_(e)):""}(e.query));var u=e.search||i&&"?"+i||"";return n&&":"!==n.substr(-1)&&(n+=":"),e.slashes||(!n||R_[n])&&!1!==o?(o="//"+(o||""),r&&"/"!==r.charAt(0)&&(r="/"+r)):o||(o=""),a&&"#"!==a.charAt(0)&&(a="#"+a),u&&"?"!==u.charAt(0)&&(u="?"+u),n+o+(r=r.replace(/[?#]/g,(function(e){return encodeURIComponent(e)})))+(u=u.replace("#","%23"))+a}function E_(e){var t=e.host,n=h_.exec(t);n&&(":"!==(n=n[0])&&(e.port=n.substr(1)),t=t.substr(0,t.length-n.length)),t&&(e.hostname=t)}o_.prototype.parse=function(e,t,n){return k_(this,e,t,n)},o_.prototype.format=function(){return S_(this)},o_.prototype.resolve=function(e){return this.resolveObject(w_(e,!1,!0)).format()},o_.prototype.resolveObject=function(e){if(YC(e)){var t=new o_;t.parse(e,!1,!0),e=t}for(var n,r=new o_,a=Object.keys(this),o=0;o<a.length;o++){var i=a[o];r[i]=this[i]}if(r.hash=e.hash,""===e.href)return r.href=r.format(),r;if(e.slashes&&!e.protocol){for(var u=Object.keys(e),s=0;s<u.length;s++){var l=u[s];"protocol"!==l&&(r[l]=e[l])}return R_[r.protocol]&&r.hostname&&!r.pathname&&(r.path=r.pathname="/"),r.href=r.format(),r}if(e.protocol&&e.protocol!==r.protocol){if(!R_[e.protocol]){for(var c=Object.keys(e),h=0;h<c.length;h++){var f=c[h];r[f]=e[f]}return r.href=r.format(),r}if(r.protocol=e.protocol,e.host||__[e.protocol])r.pathname=e.pathname;else{for(n=(e.pathname||"").split("/");n.length&&!(e.host=n.shift()););e.host||(e.host=""),e.hostname||(e.hostname=""),""!==n[0]&&n.unshift(""),n.length<2&&n.unshift(""),r.pathname=n.join("/")}if(r.search=e.search,r.query=e.query,r.host=e.host||"",r.auth=e.auth,r.hostname=e.hostname||e.host,r.port=e.port,r.pathname||r.search){var d=r.pathname||"",v=r.search||"";r.path=d+v}return r.slashes=r.slashes||e.slashes,r.href=r.format(),r}var g,m=r.pathname&&"/"===r.pathname.charAt(0),p=e.host||e.pathname&&"/"===e.pathname.charAt(0),y=p||m||r.host&&e.pathname,C=y,_=r.pathname&&r.pathname.split("/")||[],R=r.protocol&&!R_[r.protocol];if(n=e.pathname&&e.pathname.split("/")||[],R&&(r.hostname="",r.port=null,r.host&&(""===_[0]?_[0]=r.host:_.unshift(r.host)),r.host="",e.protocol&&(e.hostname=null,e.port=null,e.host&&(""===n[0]?n[0]=e.host:n.unshift(e.host)),e.host=null),y=y&&(""===n[0]||""===_[0])),p)r.host=e.host||""===e.host?e.host:r.host,r.hostname=e.hostname||""===e.hostname?e.hostname:r.hostname,r.search=e.search,r.query=e.query,_=n;else if(n.length)_||(_=[]),_.pop(),_=_.concat(n),r.search=e.search,r.query=e.query;else if(!function(e){return null==e}(e.search))return R&&(r.hostname=r.host=_.shift(),(g=!!(r.host&&r.host.indexOf("@")>0)&&r.host.split("@"))&&(r.auth=g.shift(),r.host=r.hostname=g.shift())),r.search=e.search,r.query=e.query,$C(r.pathname)&&$C(r.search)||(r.path=(r.pathname?r.pathname:"")+(r.search?r.search:"")),r.href=r.format(),r;if(!_.length)return r.pathname=null,r.search?r.path="/"+r.search:r.path=null,r.href=r.format(),r;for(var w=_.slice(-1)[0],k=(r.host||e.host||_.length>1)&&("."===w||".."===w)||""===w,S=0,E=_.length;E>=0;E--)"."===(w=_[E])?_.splice(E,1):".."===w?(_.splice(E,1),S++):S&&(_.splice(E,1),S--);if(!y&&!C)for(;S--;S)_.unshift("..");!y||""===_[0]||_[0]&&"/"===_[0].charAt(0)||_.unshift(""),k&&"/"!==_.join("/").substr(-1)&&_.push("");var T=""===_[0]||_[0]&&"/"===_[0].charAt(0);return R&&(r.hostname=r.host=T?"":_.length?_.shift():"",(g=!!(r.host&&r.host.indexOf("@")>0)&&r.host.split("@"))&&(r.auth=g.shift(),r.host=r.hostname=g.shift())),(y=y||r.host&&_.length)&&!T&&_.unshift(""),_.length?r.pathname=_.join("/"):(r.pathname=null,r.path=null),$C(r.pathname)&&$C(r.search)||(r.path=(r.pathname?r.pathname:"")+(r.search?r.search:"")),r.auth=e.auth||r.auth,r.slashes=r.slashes||e.slashes,r.href=r.format(),r},o_.prototype.parseHost=function(){return E_(this)},function(e){e[e.NotFirstCreate=0]="NotFirstCreate",e[e.FirstCreate=1]="FirstCreate"}(i_||(i_={})),function(e){e.RequestData="request_data",e.CacheHit="cache_hit"}(u_||(u_={})),function(e){e.Server="server",e.Front="front",e.HeartBeat="heartBeat",e.Refresh="refresh"}(s_||(s_={})),function(e){e.onCreateImportRangeId="onCreateImportRangeId",e.onRequestDocument="onRequestDocument",e.onRequestError="onRequestError",e.onRequestSuccess="onRequestSuccess",e.onDeleteFormula="onDeleteFormula",e.onDeactivateImportRange="onDeactivateImportRange",e.onServerSidePush="onServerSidePush",e.onCacheHitInfoCollect="onCacheHitInfoCollect",e.onRequestSuccessFromHeartBeat="onRequestSuccessFromHeartBeat",e.onRequestErrorFromHeartBeat="onRequestErrorFromHeartBeat"}(l_||(l_={}));var T_=function(e){function t(e){var n,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:we.waj.V2;return(0,y.Z)(this,t),(n=(0,d.Z)(this,(0,v.Z)(t).call(this))).spread=e,n.version=r,n.importRangePerformanceDataMap=new Map,n.onCreateImportRangeId=function(e){n.importRangePerformanceDataMap.set(e,{isFirstCreate:1,startTime:null})},n.onRequestDocument=function(e){var t=n.importRangePerformanceDataMap.get(e),r=window.performance?window.performance.now():Date.now();null==t?n.importRangePerformanceDataMap.set(e,{isFirstCreate:0,startTime:r}):null==t.startTime&&(t.startTime=r)},n.onRequestError=function(e,t){var r=n.importRangePerformanceDataMap.get(e);if(null!=r){var a=r.isFirstCreate,o=r.startTime;if(n.importRangePerformanceDataMap.delete(e),null!=o){var i={isFirstCreate:a,costTime:(window.performance?window.performance.now():Date.now())-o,errorCode:t,source:"front"};we.Ps3.collectSuiteEvent("sheet_importrange_cost_time_dev",i)}}},n.onRequestSuccess=function(e,t){var r=n.importRangePerformanceDataMap.get(e);if(null!=r){var a=r.isFirstCreate,o=r.startTime;if(n.importRangePerformanceDataMap.delete(e),null!=o){var i={isFirstCreate:a,costTime:(window.performance?window.performance.now():Date.now())-o,errorCode:0,source:"front"},u=n.getDataInfo(t);Object.assign(i,u),we.Ps3.collectSuiteEvent("sheet_importrange_cost_time_dev",i)}}},n.onDeleteFormula=function(e){n.importRangePerformanceDataMap.delete(e)},n.onDeactivateImportRange=function(e){n.importRangePerformanceDataMap.delete(e)},n.onServerSidePush=function(e,t){var r={errorCode:t,source:"server"},a=n.importRangePerformanceDataMap.get(e);if(null!=a){var o=a.isFirstCreate,i=a.startTime;if(null!=i&&1===o){var u=(window.performance?window.performance.now():Date.now())-i;Object.assign(r,{isFirstCreate:o,costTime:u})}}we.Ps3.collectSuiteEvent("sheet_importrange_cost_time_dev",r)},n.onCacheHitInfoCollect=function(e,t){we.Ps3.collectSuiteEvent("sheet_importrange_stage_dev",{stage:e,source:t})},n.onRequestSuccessFromHeartBeat=function(e){var t={errorCode:0,source:"heartBeat"},r=n.getDataInfo(e);Object.assign(t,r),we.Ps3.collectSuiteEvent("sheet_importrange_cost_time_dev",t)},n.onRequestErrorFromHeartBeat=function(e){var t={errorCode:e,source:"heartBeat"};we.Ps3.collectSuiteEvent("sheet_importrange_cost_time_dev",t)},n.onCompileImportRange=function(e){we.Ps3.collectSuiteEvent("sheet_importrange_compile_infos_dev",{count:e.length})},n.bindEvents(),n}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"bindEvents",value:function(){this.addListener("onCreateImportRangeId",this.onCreateImportRangeId),this.addListener("onRequestDocument",this.onRequestDocument),this.addListener("onRequestError",this.onRequestError),this.addListener("onRequestSuccess",this.onRequestSuccess),this.addListener("onDeleteFormula",this.onDeleteFormula),this.addListener("onDeactivateImportRange",this.onDeactivateImportRange),this.addListener("onServerSidePush",this.onServerSidePush),this.addListener("onCacheHitInfoCollect",this.onCacheHitInfoCollect),this.addListener("onRequestSuccessFromHeartBeat",this.onRequestSuccessFromHeartBeat),this.addListener("onRequestErrorFromHeartBeat",this.onRequestErrorFromHeartBeat)}},{key:"unbindEvents",value:function(){this.removeListener("onCreateImportRangeId",this.onCreateImportRangeId),this.removeListener("onRequestDocument",this.onRequestDocument),this.removeListener("onRequestError",this.onRequestError),this.removeListener("onRequestSuccess",this.onRequestSuccess),this.removeListener("onDeleteFormula",this.onDeleteFormula),this.removeListener("onDeactivateImportRange",this.onDeactivateImportRange),this.removeListener("onServerSidePush",this.onServerSidePush),this.removeListener("onCacheHitInfoCollect",this.onCacheHitInfoCollect),this.removeListener("onRequestSuccessFromHeartBeat",this.onRequestSuccessFromHeartBeat),this.removeListener("onRequestErrorFromHeartBeat",this.onRequestErrorFromHeartBeat)}},{key:"dispose",value:function(){this.unbindEvents(),this.importRangePerformanceDataMap.clear()}},{key:"getDataInfo",value:function(e){var t=e.data.dataTable,n=t.length,r=t[0].length;return{rowCount:n,colCount:r,size:n*r}}}]),t}(we.vpe);function A_(e){for(var t=e.rowCounts,n=e.rowStarts,r=e.tokens,a=e.gzipMap,o=[],i=0;i<r.length;i++)o.push({block_token:r[i],gzip_datatable:a[r[i]],startRowIndex:n[i],rowsCount:t[i]});return o}function I_(e,t){return b_.apply(this,arguments)}function b_(){return b_=(0,u.Z)(i().mark((function e(t,n){var r,a,o,s=arguments;return i().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=s.length>2&&void 0!==s[2]?s[2]:{},a={},o=function(){var e=(0,u.Z)(i().mark((function e(t){var o,u,s,l,c,h,f;return i().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,we.Ps3.serverApi.importRange.requestImportRangeMetas({importrange_ids:t,token:n});case 2:if(void 0===(o=e.sent)){e.next=26;break}e.t0=i().keys(o);case 5:if((e.t1=e.t0()).done){e.next=24;break}if(u=e.t1.value,s=o[u],l=s.importrangeMetaToken,!(c=(0,we.rR3)(s.dataType))){e.next=11;break}return a[u]=c,e.abrupt("continue",5);case 11:if(8!==s.dataType){e.next=14;break}return a[u]={isNoChange:!0,updateTime:Date.now()},e.abrupt("continue",5);case 14:if(!(h=r[l])||h.hash!==s.importrangeMeta.hash){e.next=18;break}return a[u]=h,e.abrupt("continue",5);case 18:return e.next=20,F_(n,s);case 20:f=e.sent,r[l]=f,a[u]=f,e.next=5;break;case 24:e.next=27;break;case 26:t.forEach((function(e){return a[e]=null}));case 27:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),e.next=4,kC(t,o);case 4:return e.abrupt("return",a);case 5:case"end":return e.stop()}}),e)}))),b_.apply(this,arguments)}function F_(e,t){return M_.apply(this,arguments)}function M_(){return M_=(0,u.Z)(i().mark((function e(t,n){var r,a,o,s,l,c,h,f,d;return i().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=n.importrangeMeta,a=r.rowCounts,o=r.rowStarts,s=r.range,l=r.hash,c=r.dataBlockTokens,h=r.snapshotBlockTokens,f={},d=function(){var e=(0,u.Z)(i().mark((function e(r){var a;return i().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,we.Ps3.serverApi.importRange.requestSubBlock({token:t,access_key:n.accessKey,block_tokens:r});case 2:a=e.sent,Object.assign(f,a);case 4:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),e.next=3,kC(Array.prototype.concat.call(c,h),d);case 3:return e.abrupt("return",{metaToken:n.importrangeMetaToken,accessKey:n.accessKey,hash:l,rowCount:s.RowCount,colCount:s.ColCount,updateTime:Date.now(),blocks:A_({rowCounts:a,rowStarts:o,gzipMap:f,tokens:c}),snapshotBlocks:A_({rowCounts:a,rowStarts:o,gzipMap:f,tokens:h})});case 4:case"end":return e.stop()}}),e)}))),M_.apply(this,arguments)}function V_(){return V_=(0,u.Z)(i().mark((function e(t,n){var r,a;return i().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r={},0!==t.length){e.next=3;break}return e.abrupt("return",r);case 3:return a=function(){var e=(0,u.Z)(i().mark((function e(t){var a;return i().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,we.Ps3.serverApi.importRange.requestHeartBeat({token:n,importrange_meta_tokens:t});case 2:a=e.sent,Object.assign(r,a);case 4:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),e.next=6,kC(t,a);case 6:return e.abrupt("return",r);case 7:case"end":return e.stop()}}),e)}))),V_.apply(this,arguments)}var N_=function(e){function t(e){var n,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:I_;return(0,y.Z)(this,t),(n=(0,d.Z)(this,(0,v.Z)(t).call(this))).workbook=e,n._requestMethod=r,n.importRangeDataMap=new Map,n.importRangeFormulasMap=new Map,n.importRangeReadyToInstantiateMetaMap=new Map,n.importRangePromiseMap=new Map,n.requestDocumentPromiseMap=new Map,n.importRangeHeartBeatInterval=null,n.importRangeHeartBeatIntervalTime=yC,n._isDestroy=!1,n.rangeCache=!0,n.importRangeAutoExpand=new Set,n.shouldHeartBeat=!0,n.monitorImportRangeHeartBeat=(0,u.Z)(i().mark((function e(){var t,r,a,o,u,s,l,c,h,f,d,v,g,y;return i().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!n.isDestroy){e.next=2;break}return e.abrupt("return");case 2:return a=n.getCurrentSpreadToken(),o=new Set,n.importRangeDataMap.forEach((function(e){e instanceof we.rBk||o.add(e.metaToken)})),e.next=6,n.requestImportRangeDataHash((0,m.Z)(o),a);case 6:u=e.sent,s={},l=_n(n.importRangeDataMap),e.prev=9,l.s();case 11:if((c=l.n()).done){e.next=28;break}if(h=(0,p.Z)(c.value,2),f=h[0],!((d=h[1])instanceof we.rBk)){e.next=15;break}return e.abrupt("continue",26);case 15:if(null!=n.getMetaFromId(f)){e.next=17;break}return e.abrupt("continue",26);case 17:if(v=d.hash,g=d.metaToken,!u[g]||v===u[g]){e.next=25;break}return e.next=21,n.requestMethod([f],a);case 21:y=e.sent,n.handleImportRangeDatas(y),e.next=26;break;case 25:s[f]={isNoChange:!0,updateTime:Date.now()};case 26:e.next=11;break;case 28:e.next=33;break;case 30:e.prev=30,e.t0=e.catch(9),l.e(e.t0);case 33:return e.prev=33,l.f(),e.finish(33);case 36:n.handleImportRangeDatas(s),null===(t=(r=n).hookAfterHeartBeat)||void 0===t||t.call(r);case 37:case"end":return e.stop()}}),e,null,[[9,30,33,36]])}))),n.updateDependImportRanges=(0,u.Z)(i().mark((function e(){var t,r,a,o,u,s,l,c,h;return i().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t=20,!n.isDestroy){e.next=3;break}return e.abrupt("return");case 3:r=n.getCurrentSpreadToken(),a=[],o=_n(n.importRangeDataMap),e.prev=6,o.s();case 8:if((u=o.n()).done){e.next=19;break}if(s=(0,p.Z)(u.value,2),l=s[0],!(s[1]instanceof we.rBk)){e.next=12;break}return e.abrupt("continue",17);case 12:if(!(null!=n.getMetaFromId(l)&&(a.push(l),a.length>=t))){e.next=17;break}return e.next=15,n.requestMethod(a,r);case 15:c=e.sent,n.handleImportRangeDatas(c),a=[];case 17:e.next=8;break;case 19:e.next=24;break;case 21:e.prev=21,e.t0=e.catch(6),o.e(e.t0);case 24:return e.prev=24,o.f(),e.finish(24);case 27:if(!(a.length>=1)){e.next=32;break}return e.next=30,n.requestMethod(a,r);case 30:h=e.sent,n.handleImportRangeDatas(h);case 32:case"end":return e.stop()}}),e,null,[[6,21,24,27]])}))),n.importRangePerformance=new T_(n.workbook),n}var n,r;return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"clearRetryTimer",value:function(e){null!=e.retryTimer&&clearTimeout(e.retryTimer),e.retryTimer=void 0}},{key:"handleRequestError",value:function(e,n,r,a){var o,i=this,u=this.getImportRangePromise(e);if(null!=u){var s=a.retriedTimes||0;if(a.shouldRetry&&null!==(o=a.retryImportRangeErrorCodes)&&void 0!==o&&o.includes(r.code))return function(){i.clearRetryTimer(u);var o=window.setTimeout((function(){u.retryTimer=void 0,i.importRangePromiseMap.delete(e),s>=2?u.reject(r):(a.retriedTimes=++s,i.requestImportRangeData(e,n,a).then(u.resolve).catch(u.reject))}),t.REQUEST_TIMEOUT);u.retryTimer=o}();this.importRangePromiseMap.delete(e),u.reject(r)}}},{key:"setEnableRangeCache",value:function(e){this.rangeCache=e}},{key:"getEnableRangeCache",value:function(){return this.rangeCache}},{key:"initRequestImportRangeMergedQueue",value:function(e){var t;this.requestImportRangeMergedQueue||(this.requestImportRangeMergedQueue=new DC((t={},(0,l.Z)(t,Xy.ImportRangeDatas,this._requestMethod),(0,l.Z)(t,Xy.DocsTitles,we.Ps3.batchFetchDocsTitles),t)),void 0!==e&&this.requestImportRangeMergedQueue.setDelayTime(e))}},{key:"requestImportRangeData",value:function(e,t,n){var r=this,a=this.getImportRangePromise(e);if(null!=a){if(!n.forceFetch)return a.promise;clearTimeout(a.retryTimer)}this.importRangePerformance.emit("onCacheHitInfoCollect","request_data","front");var o=0,s=null;n.delayTimeBeforeFetch&&(s=function(e,t){var n,r,a=new Promise((function(e,t){n=e,r=t})),o=window.setTimeout((0,u.Z)(i().mark((function t(){return i().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.prev=0,t.t0=n,t.next=4,e();case 4:t.t1=t.sent,(0,t.t0)(t.t1),t.next=11;break;case 8:t.prev=8,t.t2=t.catch(0),r(t.t2);case 11:case"end":return t.stop()}}),t,null,[[0,8]])}))),t);return{promise:a,retryTimer:o,cancel:function(){clearTimeout(o),r(new Error("Cancelled"))}}}(this.requestMethod.bind(this,[e],t),n.delayTimeBeforeFetch),o=s.retryTimer);var l=this.getImportRangePromise(e),c=_C(function(){var a=(0,u.Z)(i().mark((function a(o,u){var h,f;return i().wrap((function(a){for(;;)switch(a.prev=a.next){case 0:if(a.prev=0,null==s){a.next=7;break}return a.next=4,s.promise;case 4:a.t0=a.sent,a.next=10;break;case 7:return a.next=9,r.requestMethod([e],t);case 9:a.t0=a.sent;case 10:if(h=a.t0,null!=l&&l!==c&&c.promise.then(l.resolve).catch(l.reject),null!=h&&!r.isDestroy){a.next=14;break}return a.abrupt("return",(r.importRangePromiseMap.delete(e),void u(null)));case 14:if(!((f=h[e])instanceof we.rBk)){a.next=17;break}throw f;case 17:if(r.importRangePromiseMap.delete(e),null!=f){a.next=19;break}return a.abrupt("return",void u(null));case 19:o(f),a.next=27;break;case 22:if(a.prev=22,a.t1=a.catch(0),!(a.t1 instanceof we.rBk)){a.next=26;break}return a.abrupt("return",void r.handleRequestError(e,t,a.t1,n));case 26:r.importRangePromiseMap.delete(e),u(a.t1);case 27:case"end":return a.stop()}}),a,null,[[0,22]])})));return function(e,t){return a.apply(this,arguments)}}());return this.importRangePromiseMap.set(e,c),0!==o&&(c.retryTimer=o),c.promise}},{key:"requestMethod",value:function(e,t){var n=this;this.initRequestImportRangeMergedQueue();var r=_C(),a=r.promise,o=r.resolve,i=r.reject;return e.forEach((function(e){n.requestImportRangeMergedQueue.push({resolve:o,reject:i,spreadToken:t,importRangeId:e,type:Xy.ImportRangeDatas})})),a}},{key:"requestDocument",value:function(e,t,n){var r=this;if(null!=n&&n.forceFetch)return this.execRequestDocument(e,t,n);var a=this.requestDocumentPromiseMap.get(e);if(!a){var o=_C(),i=o.promise,u=o.resolve,s=o.reject;return this.execRequestDocument(e,t,n).then((function(e){return u(e)})).catch((function(e){return s(e)})),this.requestDocumentPromiseMap.set(e,{promise:i,resolve:u,reject:s}),i.finally((function(){return r.requestDocumentPromiseMap.delete(e)})),i}return a.promise}},{key:"execRequestDocument",value:(r=(0,u.Z)(i().mark((function e(n,r){var a,o,u,s,l=arguments;return i().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return a=l.length>2&&void 0!==l[2]?l[2]:Object.assign({},CC),e.prev=1,this.importRangePerformance.emit("onRequestDocument",n),e.next=5,this.requestImportRangeData(n,r,a);case 5:if(o=e.sent,this.emit("onAfterRequest",n),!EC(o)){e.next=14;break}if(this.importRangePerformance.emit("onCacheHitInfoCollect","cache_hit","front"),!(null==(s=this.importRangeDataMap.get(n))||s instanceof we.rBk)){e.next=11;break}throw s||we.DZv[we.O6N.REQUEST_FAIL];case 11:s.updateTime=o.updateTime,u=s,e.next=15;break;case 14:u=t.getMergedData(o);case 15:return e.abrupt("return",!this.getMetaFromId(n)||this.isDestroy?null:(this.importRangePerformance.emit("onRequestSuccess",n,u),this.importRangeDataMap.set(n,u),this.markDirtyFormulasById(n),u));case 18:if(e.prev=18,e.t0=e.catch(1),e.t0 instanceof we.rBk){e.next=22;break}throw this.importRangePerformance.emit("onRequestError",n,-1),we.Ps3.moirae.ravenCatch(e.t0,{tags:{scm:JSON.stringify(window.scm),key:"SHEET_IMPORTRANGE_UNKNOWN_ERROR"},extras:{importRangeId:n}}),this.getMetaFromId(n)&&this.importRangeDataMap.set(n,we.DZv[we.O6N.REQUEST_FAIL]),e.t0;case 22:return e.abrupt("return",(this.importRangePerformance.emit("onRequestError",n,e.t0.code),this.getMetaFromId(n)&&this.importRangeDataMap.set(n,we.DZv[e.t0.code]),e.t0));case 23:case"end":return e.stop()}}),e,this,[[1,18]])}))),function(e,t){return r.apply(this,arguments)})},{key:"setRequestMethod",value:function(e){this._requestMethod=e}},{key:"getRequestMethod",value:function(){return this._requestMethod}},{key:"setImportRangeMeta",value:function(e,t){var n=this.importRangeReadyToInstantiateMetaMap.get(t.importRangeId);if(n){var r=n.findIndex((function(t){return t.sheetId===e.getRef().hostId}));-1!==r&&n.splice(r,1),n.length||this.importRangeReadyToInstantiateMetaMap.delete(t.importRangeId)}}},{key:"setImportRangeFormula",value:function(e,t){this.setImportRangeMeta(e,t);var n=this.importRangeFormulasMap.get(t.importRangeId);n?n.add(e):this.importRangeFormulasMap.set(t.importRangeId,new Set([e])),this.emit("onAddImportRangeFormula",e,t),this.handleRequestInApplyFormula(t),this.importRangeFormulasMap.size>=1&&!this.importRangeHeartBeatInterval&&this.setHeartBeatInterval()}},{key:"handleRequestInApplyFormula",value:function(e){e.hasOwnProperty("spreadName")||this.refreshMetaSpreadName([e]);var t=this.importRangeDataMap.get(e.importRangeId);t&&!(t instanceof we.rBk)||this.importRangePromiseMap.get(e.importRangeId)||this.requestDocument(e.importRangeId,this.getCurrentSpreadToken(),{shouldRetry:!0,delayTimeBeforeFetch:3e3,retryImportRangeErrorCodes:[we.O6N.DATA_NOT_READY,we.O6N.REFERENCE_NOT_EXIST]})}},{key:"setFromJsonImportRangeMeta",value:function(e){var t=this.importRangeReadyToInstantiateMetaMap.get(e.importRangeId);t?t.push(e):this.importRangeReadyToInstantiateMetaMap.set(e.importRangeId,[e])}},{key:"getIdFromFormula",value:function(e){var t;return(null===(t=e.getImportRangeMeta())||void 0===t?void 0:t.importRangeId)||null}},{key:"getDataFromId",value:function(e){return this.importRangeDataMap.get(e)||null}},{key:"getFormulasFromId",value:function(e){return this.importRangeFormulasMap.get(e)||null}},{key:"getMetaFromId",value:function(e){var t=this.importRangeFormulasMap.get(e);if(t&&t.size){var n=t.values().next().value.getImportRangeMeta();if(n)return{spreadToken:n.spreadToken,spreadSource:n.spreadSource,ref:n.ref,isSyncStyle:n.isSyncStyle,importRangeId:n.importRangeId}}var r=this.importRangeReadyToInstantiateMetaMap.get(e);return r&&r[0]?{spreadToken:r[0].spreadToken,spreadSource:r[0].spreadSource,ref:r[0].ref,isSyncStyle:r[0].isSyncStyle,importRangeId:r[0].importRangeId}:null}},{key:"getMetaFromFormula",value:function(e){return e.getImportRangeMeta()||null}},{key:"clearMetaAndData",value:function(e){var t,n=this.getIdFromFormula(e),r=this.getMetaFromFormula(e);if(n&&r){this.requestDocumentPromiseMap.delete(n);var a=this.getImportRangePromise(n);a&&(this.clearRetryTimer(a),null!==(t=this.requestImportRangeMergedQueue)&&void 0!==t&&t.remove(n),this.importRangePromiseMap.delete(n));var o=this.importRangeFormulasMap.get(n);if(null!=o&&o.delete(e),this.emit("onDeleteImportRangeFormula",e,r),this.importRangePerformance.emit("onDeleteFormula",n),0===(null==o?void 0:o.size)){this.importRangeDataMap.delete(n),this.importRangeAutoExpand.delete(n),this.importRangeFormulasMap.delete(n);var i=this.importRangeReadyToInstantiateMetaMap.get(n);i&&i.length||(this.importRangeReadyToInstantiateMetaMap.delete(n),this.emit("onDeactivateImportRange",r),this.importRangePerformance.emit("onDeactivateImportRange",n))}this.importRangeFormulasMap.size<1&&this.clearHeartBeatInterval()}}},{key:"getCurrentSpreadToken",value:function(){return this.workbook.getService(Ft.UU).token}},{key:"generateAndCacheId",value:function(e,t){var n=this.generateImportRangeMeta(t);if(n){this.setImportRangeMeta(e,n),this.refreshMetaSpreadName([n]);var r=n.importRangeId,a=e.getRef(),o=a.rowFrom(),i=a.colFrom();return this.setImportRangeAutoExpand("".concat(r,"_").concat(o,"_").concat(i)),n}}},{key:"generateImportRangeMeta",value:function(e){var t=a_.parse(e.url).pathname;if(!t)return this.collectImportRangeFrontError("illegal_url"),null;var n=null==t?void 0:t.match(/^.*?\/([^\/]*)$/);if(!n)return this.collectImportRangeFrontError("unMatched_pathname"),null;var r=n[1];if(void 0===r)return this.collectImportRangeFrontError("spreadToken_is_undefined"),null;var a=$l(e.range);if(!a||a.type===we.xj7.INVALID)return this.collectImportRangeFrontError("illegal_range"),null;var o=Object.assign({},a);return o.hasOwnProperty("sheetName")||(o.sheetName=""),{spreadToken:r,importRangeId:this.generateImportRangeId(e.range,r),ref:o,spreadSource:e.url,isSyncStyle:!1,sheetId:e.sheetID}}},{key:"generateImportRangeId",value:function(e,t){var n=this.rangeCache?bt()("".concat(this.getCurrentSpreadToken(),"_").concat(t,"_").concat(e)):bt()("".concat(this.getCurrentSpreadToken(),"_").concat(t,"_").concat(e,"_").concat(Date.now(),"_").concat((0,we.zsn)(8)));return this.importRangePerformance.emit("onCreateImportRangeId",n),n}},{key:"getImportRangeMetaWithUpdateTime",value:function(e){var t=e.getActiveSheet().id(),n=[],r=[],a=this.getImportRangeIDs(t);for(var o in a){var i=a[o],u=ya(i),s=this.getDataFromId(i.importRangeId);!s||s instanceof we.rBk||!s.updateTime||(u.updateTime=s.updateTime),n.push(i),r.push(u)}return n.length<=0||this.refreshMetaSpreadName(n),r}},{key:"batchFetchDocsTitles",value:function(e){var t;if(e.length<=0)return Promise.resolve(null);var n=_C(),r=n.promise,a=n.resolve,o=n.reject;return this.initRequestImportRangeMergedQueue(),null!==(t=this.requestImportRangeMergedQueue)&&void 0!==t&&t.push({resolve:a,reject:o,data:e,type:Xy.DocsTitles}),r}},{key:"refreshMetaSpreadName",value:(n=(0,u.Z)(i().mark((function e(t){var n,r,a;return i().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!(t.length<=0)){e.next=2;break}return e.abrupt("return");case 2:return r=t.map((function(e){return{token:e.spreadToken,typeNum:3}})),e.next=5,null===(n=this.batchFetchDocsTitles(r))||void 0===n?void 0:n.catch((function(){return null}));case 5:(a=e.sent)&&!this.isDestroy&&t.forEach((function(e){a[e.spreadToken]&&(e.spreadName=a[e.spreadToken].title)}));case 7:case"end":return e.stop()}}),e,this)}))),function(e){return n.apply(this,arguments)})},{key:"getImportRangeIDs",value:function(e){for(var t={},n=this.getImportRangeFormulas(),r=0;r<n.length;r++){var a=n[r],o=Object.assign({},a.getImportRangeMeta(),{sheetId:a.getRef().hostId});if(o&&o.sheetId===e){var i=o.importRangeId;t[i]?t[i].refCount++:t[i]=Object.assign({},o,{refCount:1})}}var u,s=_n(this.importRangeReadyToInstantiateMetaMap);try{var l=function(){var n=(0,p.Z)(u.value,2),r=n[0],a=n[1];a&&a.length&&a.forEach((function(n){var a;n.sheetId===e&&(t[r]=Object.assign({},n,{refCount:null!==(a=n.refCount)&&void 0!==a?a:1}))}))};for(s.s();!(u=s.n()).done;)l()}catch(e){s.e(e)}finally{s.f()}return t}},{key:"getAllImportRangeIds",value:function(){var e=new Set;return this.importRangeFormulasMap.forEach((function(t,n){return e.add(n)})),this.importRangeReadyToInstantiateMetaMap.forEach((function(t,n){return e.add(n)})),Array.from(e)}},{key:"countImportRange",value:function(){var e=new Set;return this.importRangeFormulasMap.forEach((function(t,n){return e.add(n)})),this.importRangeReadyToInstantiateMetaMap.forEach((function(t,n){return e.add(n)})),e.size}},{key:"delUnInstantiateMeta",value:function(e){var t,n=_n(this.importRangeReadyToInstantiateMetaMap);try{for(n.s();!(t=n.n()).done;){var r=(0,p.Z)(t.value,2),a=r[0],o=r[1].filter((function(t){return t.sheetId!==e}));o.length>0?this.importRangeReadyToInstantiateMetaMap.set(a,o):this.importRangeReadyToInstantiateMetaMap.delete(a)}}catch(e){n.e(e)}finally{n.f()}}},{key:"refreshImportRangeData",value:function(e){var t=this.getFormulasFromId(e);t&&(this.requestDocument(e,this.getCurrentSpreadToken(),{forceFetch:!0,shouldRetry:!0,retryImportRangeErrorCodes:[we.O6N.DATA_NOT_READY,we.O6N.REFERENCE_NOT_EXIST]}),t.forEach((function(e){var t;Wf(e)&&(null===(t=e.getRef().sheet())||void 0===t||t.dispatch("RangeChanged",{range:e.getArrayRef()}))})),this.markDirtyFormulasById(e))}},{key:"onImportRangeChange",value:function(e,t){if(this.isImportRangeDataSurvive(e)){var n=this.getFormulasFromId(e);if(n){switch(t){case 0:this.importRangePerformance.emit("onServerSidePush",e,0),this.requestDocument(e,this.getCurrentSpreadToken(),{forceFetch:!0});break;case 13:this.importRangePerformance.emit("onServerSidePush",e,0);break;default:this.importRangeDataMap.delete(e);var r=(0,we.rR3)(t)||we.DZv[we.O6N.REQUEST_FAIL],a=this.getImportRangePromise(e);a&&(window.clearTimeout(a.retryTimer),a.reject(r),this.importRangePromiseMap.delete(e)),this.importRangeDataMap.set(e,we.DZv[r.code]),this.importRangePerformance.emit("onServerSidePush",e,r.code)}13!==t&&(n.forEach((function(e){var t;Wf(e)&&(null===(t=e.getRef().sheet())||void 0===t||t.dispatch("RangeChanged",{range:e.getArrayRef()}))})),this.markDirtyFormulasById(e))}}}},{key:"isImportRangeNumExceedLimit",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1,t=this.countImportRange()+e>we.Ps3.getSheetImportRangeCountLimit();return t&&this.collectImportRangeFrontError("importrange_exceed_limit"),t}},{key:"isImportRangeNumExceedLimitWithRangeCache",value:function(e){var t=this,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;if(!this.rangeCache)return this.isImportRangeNumExceedLimit(e.length+n);var r=n,a=new Set;return e.forEach((function(e){var n,o=null!==(n=e.importRangeId)&&void 0!==n?n:t.getImportRangeIdByMeta(e),i=t.importRangeFormulasMap.get(o);i&&i.size||a.has(o)||(a.add(o),r++)})),this.isImportRangeNumExceedLimit(r)}},{key:"hasImportRangeDataByMeta",value:function(e){var t=this.getImportRangeIdByMeta(e);if(!this.rangeCache||!t)return!1;var n=this.importRangeDataMap.get(t),r=this.importRangeReadyToInstantiateMetaMap.get(t);return n||r}},{key:"getImportRangeFormulas",value:function(){var e=[];return this.importRangeFormulasMap.forEach((function(t){t.size>1e4?t.forEach((function(t){return e.push(t)})):e.push.apply(e,(0,m.Z)(t))})),e}},{key:"requestImportRangeDataHash",value:function(e,t){return function(e,t){return V_.apply(this,arguments)}(e,t)}},{key:"hasSetHookAfterHeartBeat",value:function(){return void 0!==this.hookAfterHeartBeat}},{key:"setHookAfterHeartBeat",value:function(e){this.hookAfterHeartBeat=e}},{key:"handleImportRangeDatas",value:function(e){if(null!=e&&!this.isDestroy){var n=[];for(var r in e){var a=e[r],o=this.importRangeDataMap.get(r);if(this.importRangePerformance.emit("onCacheHitInfoCollect","request_data","heartBeat"),null!=a)if(EC(a)){if(this.importRangePerformance.emit("onCacheHitInfoCollect","cache_hit","heartBeat"),!o||o instanceof we.rBk)continue;o.updateTime=a.updateTime}else{var i=void 0;a instanceof we.rBk?(i=a,this.importRangePerformance.emit("onRequestErrorFromHeartBeat",i.code)):(i=t.getMergedData(a),this.importRangePerformance.emit("onRequestSuccessFromHeartBeat",i)),this.importRangeDataMap.set(r,i);var u=this.getFormulasFromId(r);u&&u.size&&(u.size>1e4?u.forEach((function(e){return n.push(e)})):n.push.apply(n,(0,m.Z)(u)))}}n.length>0&&this.workbook.calcEngine.markDirty(n.map((function(e){return e.getRef()})))}}},{key:"setShouldHeartBeat",value:function(e){this.shouldHeartBeat=e}},{key:"clearHeartBeatInterval",value:function(){this.importRangeHeartBeatInterval&&(window.clearInterval(this.importRangeHeartBeatInterval),this.importRangeHeartBeatInterval=null)}},{key:"setHeartBeatInterval",value:function(){this.shouldHeartBeat&&!this.importRangeHeartBeatInterval&&(this.importRangeHeartBeatInterval=window.setInterval(this.monitorImportRangeHeartBeat,this.importRangeHeartBeatIntervalTime))}},{key:"getImportRangePromise",value:function(e){return this.importRangePromiseMap.get(e)}},{key:"getImportRangeDataPromise",value:function(e){var t;return null===(t=this.requestDocumentPromiseMap.get(e))||void 0===t?void 0:t.promise}},{key:"setImportRangeHeartBeatInterval",value:function(e){this.importRangeHeartBeatIntervalTime=e,this.importRangeHeartBeatInterval&&(this.clearHeartBeatInterval(),this.setHeartBeatInterval())}},{key:"dispose",value:function(){this.clearHeartBeatInterval(),this.importRangePerformance.dispose(),this._isDestroy=!0}},{key:"collectImportRangeCount",value:function(e,t,n){var r=this.getCurrentSpreadToken();we.Ps3.collectSuiteEvent("sheet_importrange_count_dev",{count:e,reference_count:t,max_reference_count:n,file_id:we.Ps3.encryptTea(r)})}},{key:"collectImportRangeFrontError",value:function(e){we.Ps3.collectSuiteEvent("sheet_importrange_front_error_dev",{message:e})}},{key:"setImportRangeAutoExpand",value:function(e){this.importRangeAutoExpand.add(e)}},{key:"getImportRangeAutoExpand",value:function(e){return this.importRangeAutoExpand.has(e)}},{key:"getImportRangeIdByMeta",value:function(e){if(!this.rangeCache)return"";var t=e.ref,n=e.spreadToken,r=Yl(t,{isShowSheetName:!0});return bt()("".concat(this.getCurrentSpreadToken(),"_").concat(n,"_").concat(r))}},{key:"getFormulaCountById",value:function(e){var t,n,r=null!==(t=null===(n=this.importRangeFormulasMap.get(e))||void 0===n?void 0:n.size)&&void 0!==t?t:0,a=this.importRangeReadyToInstantiateMetaMap.get(e);if(!a||!a.length)return r;for(var o=0;o<a.length;o++){var i;r+=null!==(i=a[o].refCount)&&void 0!==i?i:1}return r}},{key:"finishImportRangeAutoExpand",value:function(e){this.importRangeAutoExpand.delete(e)}},{key:"isImportRangeDataSurvive",value:function(e){var t=this.importRangeFormulasMap.get(e);if(!t||!t.size)return!1;if(this.importRangeReadyToInstantiateMetaMap.get(e))return!0;var n,r=_n(t);try{for(r.s();!(n=r.n()).done;){var a=n.value;if(AC(this.workbook,a))return!0}}catch(e){r.e(e)}finally{r.f()}return!1}},{key:"markDirtyFormulasById",value:function(e){var t=this.importRangeFormulasMap.get(e);t&&this.workbook.calcEngine.markDirty(Array.from(t).map((function(e){return e.getRef()})))}},{key:"reset",value:function(){var e;this.importRangeDataMap.clear(),this.importRangeFormulasMap.clear(),this.importRangeReadyToInstantiateMetaMap.clear(),this.importRangePromiseMap.clear(),this.importRangeAutoExpand.clear(),null!==(e=this.requestImportRangeMergedQueue)&&void 0!==e&&e.dispose(),this.clearHeartBeatInterval()}},{key:"isDestroy",get:function(){return this._isDestroy}}]),t}(we.vpe);N_.REQUEST_TIMEOUT=1e4,N_.getMergedData=IC;var O_,x_=function(e){return e.includes("_")},Z_=function(e){return th(e)&&!e.hasImportRangeId()&&!we.Ps3.getImportRangeV2Enable()};!function(e){e[e.main=0]="main",e[e.worker=1]="worker",e[e.node=2]="node"}(O_||(O_={}));var D_=function(e){function t(e){var n;return(0,y.Z)(this,t),(n=(0,d.Z)(this,(0,v.Z)(t).call(this))).workbook=e,n.V3Enable=!0,n.isDestroy=!1,n.calculateFormula=new Map,n.setCalcFinishedCallback=function(e){return n.handleCalcFinishedCallback=e},n.setThreadEnv=function(e){return n.env=e},n.setRequestMethod=function(e){return n.handleFetchData=e},n.formula2ImportRange=new Map,n.importRangeContentMap=new Map,n.importRangeAutoExpandSet=new Set,n.importRangeAutoCreateSet=new Set,n.handleFormulaCalcFinished=(0,ue.default)((function(){n.calculateFormula.size&&n.workbook.calcEngine&&(2===n.env&&n.calculateFormula.forEach((function(e,t){var r=n.formula2ImportRange.get(t),a=[],o=[];null!=e&&e.forEach((function(e){var t,r=null===(t=n.importRangeContentMap.get(e))||void 0===t?void 0:t.importRangeMeta;r&&a.push(r)})),null!=r&&r.forEach((function(e){var t,r=null===(t=n.importRangeContentMap.get(e))||void 0===t?void 0:t.importRangeMeta;r&&o.push(r)})),n.emit("onImportRangeValueChanged",ih(n.workbook.calcEngine,t),a,o)})),n.calculateFormula.clear(),n.importRangeContentMap.forEach((function(e,t){e.formulas&&e.formulas.size||n.importRangeContentMap.delete(t)})),n.handleCalcFinishedCallback&&n.handleCalcFinishedCallback())}),200),n.importRangePerformance=new T_(n.workbook,we.waj.V3),n.workbook.calcEngine.formulaService.addListener("formulaCalcFinished",n.handleFormulaCalcFinished),n}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"compileImportRange",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1],n=arguments.length>2&&void 0!==arguments[2]&&arguments[2];if(this.isDestroy)return null;var r=Rf(e,{ref:e.getRef()}),a=this.workbook.calcEngine.compiler.compile(r,{refStyle:"A1",ref:e.getRef(),spread:this.workbook}).externalDataReferenceInfos;if(!a||!a.length)return null;this.importRangePerformance.onCompileImportRange(a);for(var o=[],i=0;i<a.length;i++){var u,s=a[i],l=null!==(u=this.parseUrlString(s.url))&&void 0!==u?u:{},c=l.docsType,h=l.spreadToken,f=this.parseRangeString(s.range);if(!(c&&h&&f&&f.rangeStr))return null;var d=this.generateImportRangeId(f.rangeStr,h,c);if(o.push(d),t&&this.importRangeAutoCreateSet.add(d),n&&1===a.length){var v=e.getRef(),g=v.rowFrom(),m=v.colFrom();this.importRangeAutoExpandSet.add("".concat(d,"_").concat(g,"_").concat(m))}var p=this.importRangeContentMap.get(d);(null==p?void 0:p.importRangeData)&&p.importRangeData instanceof we.rBk&&(p.importRangeData=void 0)}return o}},{key:"getDataFromId",value:function(e){var t,n;return null!==(t=null===(n=this.importRangeContentMap.get(e))||void 0===n?void 0:n.importRangeData)&&void 0!==t?t:null}},{key:"getFormulasFromId",value:function(e){var t,n=this,r=new Set,a=null===(t=this.importRangeContentMap.get(e))||void 0===t?void 0:t.formulas;return null!=a&&a.forEach((function(e){var t=ih(n.workbook.calcEngine,e);t&&r.add(t)})),r}},{key:"getCurrentSpreadToken",value:function(){return this.workbook.getService(Ft.UU).token}},{key:"generateAndCacheId",value:function(e,t){var n,r=null!==(n=this.parseUrlString(e))&&void 0!==n?n:{},a=r.docsType,o=r.spreadToken,i=this.parseRangeString(t);return a&&o&&i&&i.rangeStr?this.generateImportRangeId(i.rangeStr,o,a):null}},{key:"parseUrlString",value:function(e){var t=a_.parse(e).pathname;if(!t)return this.collectImportRangeFrontError("illegal_url"),null;var n=null==t?void 0:t.match(/^\/(.*?)\/([^\/]*)$/);if(!n)return this.collectImportRangeFrontError("unMatched_pathname"),null;var r=n[1];if(void 0===r)return this.collectImportRangeFrontError("docsType_is_undefined"),null;var a=n[2];return void 0===a?(this.collectImportRangeFrontError("spreadToken_is_undefined"),null):{docsType:r,spreadToken:a}}},{key:"parseRangeString",value:function(e){var t=e.lastIndexOf("!");if(-1===t)return null;var n=e.slice(0,t),r=e.slice(t+1);if(/[\/\\?*\[\]:]/.test(n))return null;n.startsWith("'")&&n.endsWith("'")||(n="'".concat(n,"'")),r=r.toUpperCase();var a=$l(e="".concat(n,"!").concat(r));return a&&a.type!==we.xj7.INVALID?(a.rangeStr=e,a):(this.collectImportRangeFrontError("illegal_range"),null)}},{key:"generateImportRangeId",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"sheets";return(0,we.gw3)("".concat(t,"_").concat(n,"_").concat(e))}},{key:"getAllImportRangeIds",value:function(){return Array.from(this.importRangeContentMap.keys())}},{key:"countImportRange",value:function(){return this.importRangeContentMap.size}},{key:"refreshImportRangeData",value:function(e){var t=this;e.forEach((function(e){var n=t.importRangeContentMap.get(e);if(n){n.importRangeData=void 0,t.fetchImportRangeDataById(e);var r=n.formulas;r&&r.size&&r.forEach((function(e){var n,r=ih(t.workbook.calcEngine,e);r&&Wf(r)&&(null===(n=r.getRef().sheet())||void 0===n||n.dispatch("RangeChanged",{range:r.getArrayRef()}))})),t.markDirtyFormulasById(e)}}))}},{key:"getImportRangeFormulas",value:function(){var e=this,t=[];return Array.from(this.formula2ImportRange.keys()).forEach((function(n){var r=ih(e.workbook.calcEngine,n);r&&t.push(r)})),t}},{key:"getImportRangePromise",value:function(e){var t;return null===(t=this.importRangeContentMap.get(e))||void 0===t?void 0:t.importRangePromise}},{key:"getImportRangeMetasByFormula",value:function(e){var t=oh(e),n=this.formula2ImportRange.get(t),r=[];if(!n||!n.size)return r;var a,o=_n(n);try{for(o.s();!(a=o.n()).done;){var i=a.value,u=this.importRangeContentMap.get(i);u&&r.push(u.importRangeMeta)}}catch(e){o.e(e)}finally{o.f()}return r}},{key:"dispose",value:function(){this.isDestroy=!0,this.formula2ImportRange.clear(),this.importRangeContentMap.clear(),this.importRangeAutoCreateSet.clear(),this.importRangeAutoExpandSet.clear(),this.importRangePerformance.dispose(),this.handleFormulaCalcFinished.cancel(),this.workbook.calcEngine.formulaService.removeListener("formulaCalcFinished",this.handleFormulaCalcFinished)}},{key:"reset",value:function(){this.formula2ImportRange.clear(),this.importRangeContentMap.clear(),this.importRangeAutoCreateSet.clear(),this.importRangeAutoExpandSet.clear()}},{key:"collectImportRangeCount",value:function(e,t,n){var r=this.getCurrentSpreadToken();we.Ps3.collectSuiteEvent("sheet_importrange_count_dev",{count:e,reference_count:t,max_reference_count:n,file_id:we.Ps3.encryptTea(r)})}},{key:"collectImportRangeFrontError",value:function(e){we.Ps3.collectSuiteEvent("sheet_importrange_front_error_dev",{message:e})}},{key:"isImportRangeDataSurvive",value:function(e){var t,n=null===(t=this.importRangeContentMap.get(e))||void 0===t?void 0:t.formulas;if(!n||!n.size)return!1;var r,a=_n(n);try{for(a.s();!(r=a.n()).done;){var o=r.value,i=ih(this.workbook.calcEngine,o);if(i&&AC(this.workbook,i))return!0}}catch(e){a.e(e)}finally{a.f()}return!1}},{key:"markDirtyFormulasById",value:function(e){var t,n=this,r=this.workbook.getCalcEngine(),a=null===(t=this.importRangeContentMap.get(e))||void 0===t?void 0:t.formulas,o=[];r&&a&&a.forEach((function(e){var t=ih(n.workbook.calcEngine,e);t&&o.push(t.getRef())})),r.markDirty(o)}},{key:"onImportRangeStatusChange",value:function(e,t){var n=this,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"onServerSidePush";if(this.isImportRangeDataSurvive(e)||18===t)switch(t){case 0:return this.importRangePerformance.emit(r,e,0),void this.fetchImportRangeDataById(e).then((function(){return n.markDirtyFormulasById(e)}));case 13:return void this.importRangePerformance.emit(r,e,0);case 8:var a,o=null===(a=this.importRangeContentMap.get(e))||void 0===a?void 0:a.importRangeData;return void(!o||o instanceof we.rBk||(o.updateTime=Date.now()));case 18:return void this.importRangeContentMap.forEach((function(e,t){e.importRangeData&&e.importRangeData instanceof we.rBk&&(e.importRangeData.code===we.O6N.EXIST_FML_LIMIT||e.importRangeData.code===we.O6N.DATA_SOURCE_IN_TRASH)&&(e.importRangeData=void 0,n.markDirtyFormulasById(t))}));default:var i;(i=2===t?we.DZv[we.O6N.REFERENCE_NOT_EXIST_V3]:(0,we.rR3)(t))||(console.error("[SHEET LOG] ImportRangeStatusChanged Unknown DataType ",t),i=we.DZv[we.O6N.REQUEST_FAIL]),this.importRangePerformance.emit(r,e,i.code);var u=this.importRangeContentMap.get(e);if(u){var s=u.importRangeData;u&&s instanceof we.rBk&&s.code===i.code||(u.importRangeData=i,this.markDirtyFormulasById(e))}return}}},{key:"fetchImportRangeDataById",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:Object.assign({},CC);if(this.isDestroy)return Promise.reject((0,we.i4Q)(we.O6N.REQUEST_FAIL,"importrange manager is destroy"));var n=this.importRangeContentMap.get(e);return t.version=we.waj.V3,n?(n.importRangePromise||(n.importRangePromise=this.createFetchDataPromise({importRangeId:e,spreadToken:this.getCurrentSpreadToken(),options:t})),n.importRangePromise):Promise.reject((0,we.i4Q)(we.O6N.REQUEST_FAIL,"content is not found"))}},{key:"createFetchDataPromise",value:function(e){var t=this,n=e.spreadToken,r=e.importRangeId,a=e.options,o=this.importRangeContentMap.get(r);return this.importRangePerformance.emit("onRequestDocument",r),new Promise((function(e,i){t.handleFetchData({spreadToken:n,importRangeId:r,options:a,resolve:e,reject:i,extraInfo:{spreadSource:o.importRangeMeta.spreadSource,rangeStr:o.importRangeMeta.rangeStr}})})).then((function(n){return t.handleFetchDataSuccess(n,e)})).catch((function(n){return t.handleFetchDataError(n,e)}))}},{key:"handleFetchDataSuccess",value:function(e,t){var n=t.importRangeId;if(e instanceof we.rBk)throw e;var r=this.importRangeContentMap.get(n);if(!r)throw Error("content is not found");if(r.importRangePromise=void 0,EC(e)){this.importRangePerformance.emit("onCacheHitInfoCollect","cache_hit","front");var a=r.importRangeData;return a?(a instanceof we.rBk||(a.updateTime=e.updateTime),a):(this.importRangePerformance.emit("onRequestError",n,-1),we.DZv[we.O6N.REQUEST_FAIL])}var o=IC(e);return r.importRangeData=o,this.importRangePerformance.emit("onRequestSuccess",n,o),o}},{key:"handleFetchDataError",value:function(e,t){var n,r,a=this,o=t.spreadToken,i=t.importRangeId,u=t.options,s=this.importRangeContentMap.get(i);return s&&e instanceof we.rBk?(this.importRangePerformance.emit("onRequestError",i,e.code),null===(n=u.retryImportRangeErrorCodes)||void 0===n||!n.includes(e.code)||s.retryTimes&&s.retryTimes>=2?(s.importRangePromise=void 0,s.importRangeData=e,e):(0,we.Dc1)(null!==(r=u.delayTimeBeforeFetch)&&void 0!==r?r:0).then((function(){return void 0===s.retryTimes?s.retryTimes=1:s.retryTimes++,a.createFetchDataPromise({spreadToken:o,importRangeId:i,options:u})}))):(s&&(s.importRangePromise=void 0,s.importRangeData=we.DZv[we.O6N.REQUEST_FAIL]),this.importRangePerformance.emit("onRequestError",i,-1),we.Ps3.moirae.ravenCatch(e,{tags:{key:"SHEET_IMPORTRANGE_UNKNOWN_ERROR: ".concat(null==e?void 0:e.message)},extras:{importRangeId:i}}),we.DZv[we.O6N.REQUEST_FAIL])}},{key:"setImportRangeContent",value:function(e,t,n,r){var a=this.importRangeContentMap.get(t);a?a.formulas.add(e):this.importRangeContentMap.set(t,{importRangeId:t,importRangeMeta:{importRangeId:t,spreadSource:n,spreadToken:this.getCurrentSpreadToken(),rangeStr:r,ref:$l(r),isSyncStyle:!1},formulas:new Set([e])});var o=this.formula2ImportRange.get(e);o?o.add(t):this.formula2ImportRange.set(e,new Set([t]))}},{key:"removeFormula2ImportRangeRelationship",value:function(e,t){var n=this.formula2ImportRange.get(e);if(n?(n.delete(t),n.size||this.formula2ImportRange.delete(e)):this.collectImportRangeFrontError("del_formula_error_without_importrange"),this.importRangeContentMap){var r,a=null===(r=this.importRangeContentMap.get(t))||void 0===r?void 0:r.formulas;a?(a.delete(e),a.size||this.importRangeContentMap.delete(t)):this.collectImportRangeFrontError("del_importrange_error_without_formula")}}},{key:"delFormula",value:function(e){var t=this,n=oh(e),r=this.formula2ImportRange.get(n);if(r&&r.size){var a=[];this.importRangeContentMap.size&&r.forEach((function(e){var r,o=null===(r=t.importRangeContentMap.get(e))||void 0===r?void 0:r.importRangeMeta;o&&a.push(o),t.removeFormula2ImportRangeRelationship(n,e)})),this.emit("onDeleteFormulaV3",e,a)}}}]),t}(we.vpe);D_.ThreadPromiseMap=new Map;var P_=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e,t,n){var r=e.ref.sheet(),a=null==r?void 0:r.parent;if(!r||!a||!a.importRangeManager)return ut.RUNTIME_ERR_VAR;var o=e.formula;return Z_(o)&&a.importRangeManagerV3?function(e,t,n,r){var a,o,i=(null===(a=t.getSpecialInfo())||void 0===a?void 0:a.link)||t.getValue(),u=r.generateAndCacheId(i,n.getValue()),s=oh(e.formula);if(!u)return we.d$b[we.O6N.IMPORT_RANGE_PARSE_ERROR]();if(!r.calculateFormula.has(s)){var l=r.formula2ImportRange.get(s);r.calculateFormula.set(s,l),null!=l&&l.forEach((function(e){var t;null===(t=r.importRangeContentMap.get(e))||void 0===t||t.formulas.delete(s)})),r.formula2ImportRange.delete(s)}r.setImportRangeContent(s,u,i,n.getValue());var c=null===(o=r.importRangeContentMap.get(u))||void 0===o?void 0:o.importRangeData;return c?function(e,t,n){var r;return n instanceof we.rBk?L_(n,t):(e.info&&(e.info.customData=null===(r=n.data.dataTable[0][0].getSpecialInfo())||void 0===r?void 0:r.customData),n.importRangeVar||(n.importRangeVar=new wu(n.data.dataTable,t)),n.importRangeVar)}(e,u,c):(r.fetchImportRangeDataById(u).finally((function(){e.service.emit("afterWaitAsyncCalc",e.formula,3)})),e.service.addCalculatingAsyncFormula(e.formula),ut.WAIT_ASYNC_ERR_VAR)}(e,t,n,a.importRangeManagerV3):function(e,t,n){var r;if(!t.isImportRange())return we.d$b[we.O6N.IMPORT_RANGE_PARSE_ERROR]();var a=n.importRangeManager,o=a.getMetaFromFormula(t);if(!o)return ut.tractorErrorVarCreators[ut.ErrorCode.DEFAULT_RUNTIME_ERROR]("Cannot import range without meta.");var i=o.importRangeId,u=a.getDataFromId(i);if(u)return u instanceof we.rBk?L_(u,i):(e.info&&(e.info.customData=null===(r=u.data.dataTable[0][0].getSpecialInfo())||void 0===r?void 0:r.customData),new wu(u.data.dataTable,i));var s=a.getImportRangeDataPromise(i);if(!s){var l=a.getCurrentSpreadToken();s=a.requestDocument(i,l)}return s.then((function(t){var n;return t?t instanceof we.rBk?L_(t,i):(e.info&&(e.info.customData=null===(n=t.data.dataTable[0][0].getSpecialInfo())||void 0===n?void 0:n.customData),new wu(t.data.dataTable,i)):ut.NULL_VAR})).catch((function(e){return L_(e,i)})).finally((function(){e.service.emit("afterWaitAsyncCalc",e.formula,3)})),e.service.addCalculatingAsyncFormula(e.formula),ut.WAIT_ASYNC_ERR_VAR}(e,o,a)}}]),t}(gC("IMPORTRANGE",2,0,0,iC|lC,[{type:nC,isMappable:!1},{type:nC,isMappable:!1}]));function L_(e,t){return e instanceof we.rBk?e.code===we.O6N.DATA_NOT_READY?(0,we.LCc)(e.code,"",{importRangeId:t}):(0,we.i4Q)(e.code,"",{importRangeId:t}):(0,we.i4Q)(we.O6N.REQUEST_FAIL,null==e?void 0:e.message,{importRangeId:t})}function B_(e,t,n){return!(n.hasOwnProperty("isMappable")&&!n.isMappable||(Fu(t)&&!(0,ut.isTypeCompatible)(t,n)?t.size()<2||!e.isArray&&(e.formula.canUseArrayFormula=!0,1):!Au(t)||(0,ut.isTypeCompatible)(t,n)))}P_=Gi([cc("IMPORTRANGE")],P_);var U_=function(e,t,n,r){return ut.tractorErrorVarCreators[ut.ErrorCode.STRING_TOO_LONG]({funcName:e,index:t,textLength:n,maxTextLength:r})},H_=function(e,t){return ut.tractorErrorVarCreators[ut.ErrorCode.NUM_PARAMETER_SHOULD_BE_POSITIVE_OR_ZERO]({funcName:e,index:t})},W_=function(e,t){return ut.tractorErrorVarCreators[ut.ErrorCode.PARAMETER_SHOULD_BE_POSITIVE_OR_ZERO]({funcName:e,index:t})},j_=function(e,t,n,r,a){return ut.tractorErrorVarCreators[ut.ErrorCode.NUM_SHOULD_BE_BETWEEN_INCLUSIVE_PARAMETER]({funcName:e,value:n,index:t,lowerBound:r,upperBound:a})},z_=function(e,t,n,r,a){return ut.tractorErrorVarCreators[ut.ErrorCode.SHOULD_BE_BETWEEN_EXCLUSIVE]({funcName:e,value:n,index:t,lowerBound:r,upperBound:a})},G_=ut.tractorErrorVarCreators[ut.ErrorCode.POSITIVE_OVERFLOW]({upperBound:ut.MAX_NUMBER_VALUE}),J_=we.d$b[we.O6N.NEGATIVE_OVERFLOW]({lowerBound:-ut.MAX_NUMBER_VALUE}),q_=function(e,t,n,r){return ut.tractorErrorVarCreators[ut.ErrorCode.NUM_PARAMETER_SHOULD_BE_GREATER_THAN]({funcName:e,value:t,index:n,lowerBound:r})},$_=function(e,t,n,r){return ut.tractorErrorVarCreators[ut.ErrorCode.PARAMETER_SHOULD_BE_GREATER_THAN]({funcName:e,value:t,index:n,lowerBound:r})},Y_=function(e,t,n,r){return ut.tractorErrorVarCreators[ut.ErrorCode.PARAMETER_SHOULD_BE_GREATER_THAN_OR_EQUAL_TO]({funcName:e,index:n,value:t,lowerBound:r})},K_=function(e,t,n,r){return ut.tractorErrorVarCreators[ut.ErrorCode.NUM_PARAMETER_SHOULD_BE_GREATER_THAN_OR_EQUAL_TO]({funcName:e,index:n,value:t,lowerBound:r})},X_=function(e,t,n,r){return ut.tractorErrorVarCreators[ut.ErrorCode.PARAMETER_SHOULD_BE_LESS_THAN_OR_EQUAL_TO]({funcName:e,value:t,index:n,upperBound:r})},Q_=function(e,t,n,r){return ut.tractorErrorVarCreators[ut.ErrorCode.PARAMETER_SHOULD_BE_LESS_THAN]({funcName:e,index:n,value:t,upperBound:r})},eR=function(e,t,n,r,a,o){return we.d$b[we.O6N.DATE_PARAMETER_SHOULD_BE_ON_OR_BEFORE_OTHER_DATE_PARAMETER]({funcName:e,index:r,firstDate:(0,we.L0c)(t.formatterService,n),secondArgIndex:o,secondDate:(0,we.L0c)(t.formatterService,a)})},tR=function(e,t,n){return we.d$b[we.O6N.NUM_PARAMETER_SHOULD_BE_INTEGER]({funcName:e,index:t,value:n})},nR=function(e,t,n,r){return ut.tractorErrorVarCreators[ut.ErrorCode.PARAMETER_VALUE_NOT_IN_LIST]({funcName:e,value:t,index:n,validValues:Array.isArray(r)?r.join(", "):r})},rR=function(e,t,n){return ut.tractorErrorVarCreators[ut.ErrorCode.INVALID_NON_DECIMAL_REPRESENTATION]({funcName:e,value:t,validValue:String(n)})},aR=we.d$b[we.O6N.VALUE_RANDARRAY_ERROR_CALC_LARGE](),oR=we.d$b[we.O6N.PARAMETER_SHOULD_BE_LAMBDA](),iR=we.d$b[we.O6N.RESULT_SHOULD_BE_SINGLE_COL](),uR=we.d$b[we.O6N.RESULT_SHOULD_BE_SINGLE_ROW](),sR=we.d$b[we.O6N.RESULT_SHOULD_BE_SINGLE](),lR=function(e,t,n){return we.d$b[we.O6N.TREND_ARGUMENT_NOT_STIRNG]({funcName:e,index:t,content:n})},cR=function(e,t,n){return we.d$b[we.O6N.TREND_ARGUMENT_NOT_BOOLEAN]({funcName:e,index:t,content:n})},hR=function(e,t,n){return we.d$b[we.O6N.TREND_ARGUMENT_NOT_NULL]({funcName:e,index:t,content:n})},fR=function(e,t,n){return we.d$b[we.O6N.INVALID_WEEKEND_NUMBER]({funcName:e,index:t,invalidVal:n})},dR=function(e,t,n){return ut.tractorErrorVarCreators[ut.ErrorCode.NUM_OUT_OF_RANGE_PARAMETER]({funcName:e,index:t,value:n})},vR=function(e,t,n){return we.d$b[we.O6N.NUM_SETTLEMENT_DATE_NOT_BEFORE_MATURITY_DATE]({funcName:e,settlementDate:t,maturityDate:n})},gR=function(e,t,n,r,a){return ut.tractorErrorVarCreators[ut.ErrorCode.SHOULD_BE_BETWEEN_INCLUSIVE_PARAMETER]({funcName:e,value:n,index:t,lowerBound:r,upperBound:a})},mR=function(e,t,n,r,a){return ut.tractorErrorVarCreators[ut.ErrorCode.PARAMETER_SHOULD_BE_LESS_THAN_OR_EQUAL_TO_OTHER_PARAM]({funcName:e,index:n,value:t,secondArgIndex:r,upperBound:a})},pR=function(e,t,n,r){return we.d$b[we.O6N.VALUE_PARAMETER_SHOULD_BE_LESS_THAN_OR_EQUAL_TO]({funcName:e,index:t,value:n,upperBound:r})},yR=function(e,t,n,r,a){return ut.tractorErrorVarCreators[ut.ErrorCode.PARAMETER_WRONG_DATA_TYPE]({funcName:e,index:t,value:n,argType:r,requiredArgType:a})},CR=function(e,t,n,r,a){return we.d$b[we.O6N.RANGE_SIZES_NOT_EQUAL]({funcName:e,expectedRows:t,expectedCols:n,actualRows:r,actualCols:a})};function _R(e,t,n,r,a,o){return we.d$b[we.O6N.PARAMETER_RANGE_SIZES_NOT_EQUAL]({funcName:e,index:t,expectedRows:n,expectedCols:r,actualRows:a,actualCols:o})}var RR,wR=function(e,t){return we.d$b[we.O6N.ARG_MUST_BE_RANGE]({funcName:e,index:t})},kR=function(e){return we.d$b[we.O6N.VALUE_ARRAY_SIZES_NOT_EQUAL]({funcName:e})},SR=function(e){return we.d$b[we.O6N.NA_ARRAY_SIZES_NOT_EQUAL]({funcName:e})},ER=function(e,t,n){return we.d$b[we.O6N.INVALID_CELL_REFERENCE]({funcName:e,index:t,value:n})},TR=function(e,t,n){return we.d$b[we.O6N.REF_INVALID_CELL_REFERENCE]({funcName:e,index:t,value:n})},AR=function(e,t,n){return we.d$b[we.O6N.NA_INVALID_CELL_REFERENCE]({funcName:e,index:t,value:n})},IR=function(e,t){return we.d$b[we.O6N.PARAMETER_SHOULD_BE_NON_BLANK]({funcName:e,index:t})},bR=function(e,t){return we.d$b[we.O6N.NA_PARAMETER_SHOULD_BE_NON_BLANK]({funcName:e,index:t})},FR=function(e,t,n){return ut.tractorErrorVarCreators[ut.ErrorCode.ARGUMENT_SIZES_NOT_EQUAL]({funcName:e,argCount:t,requiredOperandCount:n})},MR=function(e,t,n){return ut.tractorErrorVarCreators[ut.ErrorCode.ARGUMENTS_COUNT_SHOULD_BE_EXACTLY]({funcName:e,argCount:t,requiredOperandCount:n})},VR=function(e,t,n){return we.d$b[we.O6N.FUNCTION_RESULT_SHOULD_BE_GREATER_THAN_OR_EQUAL_TO]({funcName:e,value:t,lowerBound:n})},NR=function(e,t){return we.d$b[we.O6N.NUM_NOT_BE_NEGATIVE_NUMBER_OR_ZERO]({funcName:e,value:t})},OR=function(e,t){return we.d$b[we.O6N.LOOKUP_VALUE_NOT_FOUND]({funcName:e,value:t})},xR=function(e,t,n){return we.d$b[we.O6N.DIV_TREND_POINT_NUM_UNENOUGHT]({funcName:e,expectedNum:t,receivedNum:n})},ZR=we.d$b[we.O6N.DELETED_REFERENCE](),DR=we.d$b[we.O6N.AVERAGE_WEIGHTED_NEGATIVE_ERROR](),PR=function(e){return ut.tractorErrorVarCreators[ut.ErrorCode.DIVIDE_BY_ZERO_FROM_FUNCTION_EVAL]({funcName:e})},LR=ut.tractorErrorVarCreators[ut.ErrorCode.INVALID_COMPLEX_NUMBER](),BR=ut.tractorErrorVarCreators[ut.ErrorCode.NOT_A_NUMBER](),UR=function(e){return ut.tractorErrorVarCreators[ut.ErrorCode.NO_VALID_DATA]({funcName:e})},HR=function(e){return ut.tractorErrorVarCreators[ut.ErrorCode.NUM_NO_VALID_DATA]({funcName:e})},WR=function(e){return ut.tractorErrorVarCreators[ut.ErrorCode.NA_NO_VALID_DATA]({funcName:e})},jR=function(e){return ut.tractorErrorVarCreators[ut.ErrorCode.DIV0_NO_VALID_DATA]({funcName:e})},zR=function(e){return we.d$b[we.O6N.RANGE_MUST_BE_SINGLE_ROW_OR_COLUMN]({funcName:e})},GR=function(e){return we.d$b[we.O6N.NA_RANGE_MUST_BE_SINGLE_ROW_OR_COLUMN]({funcName:e})},JR=ut.tractorErrorVarCreators[ut.ErrorCode.NO_MATCH](),qR=function(e){return we.d$b[we.O6N.NO_MODE]({funcName:e})},$R=function(e){return we.d$b[we.O6N.NA_NO_MODE]({funcName:e})},YR=function(e,t,n){return we.d$b[we.O6N.MATRIX_ROWS_SHOULD_BE_EQUAL_COLS]({funcName:e,yRowCount:t,xRowCount:n})},KR=function(e,t){return we.d$b[we.O6N.VALUE_BY_ZERO_FROM_PARAMETER_BEING_ZERO]({funcName:e,index:t})},XR=function(e,t){return we.d$b[we.O6N.NO_VALUE_FOR_THIS_CELL_FUNCTION]({funcName:e,errorType:t})},QR=function(e,t){var n=arguments.length>2&&void 0!==arguments[2]&&arguments[2];return we.d$b[we.O6N.NO_VALUE_FOR_THIS_CELL_PARAMETER]({parameterName:e,errorType:t,isI18n:n})};!function(e){e.IF_NOT_FOUND="ifNotFound",e.PAD_WITH="padWith"}(RR||(RR={}));var ew=QR(RR.IF_NOT_FOUND,ut.ErrorConstant.NA,!0),tw=QR(RR.PAD_WITH,ut.ErrorConstant.NA,!0),nw=function(e,t){return ut.tractorErrorVarCreators[ut.ErrorCode.CANNOT_PARSE_TEXT_TO_NUMBER]({funcName:e,arg:'"'.concat(t,'"')})};function rw(e,t){var n=t.parameter,r=t.index,a=t.op,o=t.argument,i="object"==(0,_.Z)(n.type)?n.type.type:n.type;if(gf(o)&&(o=o.getVar(e)),Mu(o)){var u=o.getSheetRef(e.formula.getRefMap());o=u instanceof Ei?new Su(ki(u,e.ref)):u}if(Fu(o)&&(o=o.toValidVar()),o.isError()&&o.isRuntimeError())return{isError:!0,convertedArgument:o,srcArg:o};if((0,ut.isTypeCompatible)(o,n))return{isError:!1,convertedArgument:o,srcArg:o};if(o.isError())return{isError:!0,convertedArgument:o,srcArg:o};if(function(e){return e instanceof tf}(o)&&!B_(e,o,n))return rw(e,{argument:o.nth(0),index:r,parameter:n,op:a});if((Au(o)||Fu(o))&&!B_(e,o,n))return rw(e,{argument:o.getVar(e),index:r,parameter:n,op:a});if(o.isPrimitive()&&!o.isNull()&&!(i&fC)){var s=new Ru([[o]]);if((0,ut.isTypeCompatible)(s,n))return{isError:!1,convertedArgument:s,srcArg:o}}if(o.isPrimitive()){var l=(0,ut.convertToBasicType)(e.service,o,n.type);if(null!=l)return{isError:!1,convertedArgument:l,srcArg:o};if(l=function(e){var t=e.parameter,n=e.argument,r=e.index,a=e.op,o=(0,ut.getVarType)(t.type);return 0==(o&tC)&&0==(o&rC)||!n.isString()?null:yR(a.name,r+1,n.getValue().toString(),ut.FormulaErrorPhrases.DATA_TYPE_STRING,0!=(o&tC)?ut.FormulaErrorPhrases.DATA_TYPE_DOUBLE:ut.FormulaErrorPhrases.DATA_TYPE_BOOLEAN)}(t),null!=l)return{isError:!0,convertedArgument:l,srcArg:o}}return{isError:!0,convertedArgument:ut.VALUE_ERR_VAR,srcArg:o}}var aw=["PrimitiveMatrixVar","MixinMatrixVar","RefMatrixVar","SlicedMatrixVar","FixedSizeMatrixVar"],ow=["SheetRefVar","MultipleRefsVar"],iw={MATRIX:uw(aw,hC),SHEET_REF:uw(ow,hC),MATRIX_AND_SHEET_REF:uw([].concat(aw,ow),hC)};function uw(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:hC;return{type:t,customType:{collection:e}}}var sw=function(){function e(){(0,y.Z)(this,e)}return(0,C.Z)(e,[{key:"isMatrix",value:function(){return this.type===ut.ArgumentType.Matrix}}]),e}(),lw=function(e){function t(e,n,r,a){var o;return(0,y.Z)(this,t),(o=(0,d.Z)(this,(0,v.Z)(t).call(this))).ctx=e,o.op=n,o.argument=r,o.index=a,o.type=ut.ArgumentType.Matrix,Fu(r)?o.matrix=r.toRefMatrix():o.matrix=r,o.matrixSize={row:r.rowCount(),col:r.colCount()},o.paramDesc=o.op.operandDesc(o.index),o}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"dimension",value:function(){return this.matrixSize}},{key:"getArg",value:function(e,t){var n=this.matrix.getExpandVarByPos(e,t,this.ctx);n=(0,ut.varCheck)(n);var r=this.op.getConvertVariantFn()(this.ctx,{argument:n,index:this.index,parameter:this.paramDesc,op:this.op}),a=r.convertedArgument;if(r.isError)return r;if(!(0,ut.isTypeCompatible)(a,this.paramDesc))throw new Error("The type of argument after transformation is not compatible with parameter type");return r}}]),t}(sw),cw=function(e){function t(e,n,r,a){var o;(0,y.Z)(this,t),(o=(0,d.Z)(this,(0,v.Z)(t).call(this))).argument=r,o.type=ut.ArgumentType.Single,r=(0,ut.varCheck)(r);var i=n.operandDesc(a),u=n.getConvertVariantFn()(e,{argument:r,index:a,parameter:i,op:n}),s=u.convertedArgument;if(!1===u.isError&&!(0,ut.isTypeCompatible)(s,i))throw new Error("The type of argument after transformation is not compatible with parameter type");return o.cache=u,o}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"getArg",value:function(){return this.cache}}]),t}(sw),hw=function(){function e(){(0,y.Z)(this,e),this.hasMatrixArgument=!1,this.args=[],this.expandSize={row:1,col:1}}return(0,C.Z)(e,[{key:"getExpandSize",value:function(){return this.expandSize}},{key:"appendArgument",value:function(e){if(this.args.push(e),e.isMatrix()){this.hasMatrixArgument=!0;var t=e.dimension(),n=t.row,r=t.col;this.expandSize.row=Math.max(n,this.expandSize.row),this.expandSize.col=Math.max(r,this.expandSize.col)}}},{key:"getArgs",value:function(e,t){return this.args.map((function(n){return n.getArg(e,t)}))}}]),e}();function fw(e,t){return e.op().alwaysCalc?t.isAlwaysCalc?(null==t.alwaysCalcOps||t.alwaysCalcOps.add(e),t):{isAlwaysCalc:!0,alwaysCalcOps:new Set([e])}:t}function dw(e,t,n,r,a){return e.iterContent(t,r,n,a).reduce((function(e,t){var n=e.formulaVar;return(null==n?void 0:n.getVar())===ut.SUSPENDED_ERR_VAR&&t.add(n),t}),new Set)}function vw(e,t,n){var r=function(e){var r,a=_n(e);try{for(a.s();!(r=a.n()).done;){var i=r.value;if(t.delete(i),0===t.size)return n(),void o()}}catch(e){a.e(e)}finally{a.f()}},a=function(e){t.delete(e)};e.formulaService.addListener(ut.FormulaEvents.onFormulaValuesChanged,r),e.formulaSpace.addListener(ut.FormulaSpaceEvents.onFormulaUnregistered,a);var o=function(){e.formulaService.removeListener(ut.FormulaEvents.onFormulaValuesChanged,r),e.formulaSpace.removeListener(ut.FormulaSpaceEvents.onFormulaUnregistered,a)};return{unsubscribe:o}}function gw(e,t,n,r,a){var o=dw(e,t,n,r,a);return o.size>0?new Promise((function(t){vw(e.getCalcEngine(),o,(function(){t()}))})):Promise.resolve()}var mw,pw,yw=function(e){function t(){var e;return(0,y.Z)(this,t),(e=(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))).alwaysCalc=!0,e}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e,t){var n,r,a=t.getValue(),o=!1;a>100&&(a-=100,o=!0),e.info&&(e.info.hasSubtotal=!0);for(var i=arguments.length,u=new Array(i>2?i-2:0),s=2;s<i;s++)u[s-2]=arguments[s];var l=this.callFunctionByNum(e,a,o,u);return l.isError()&&null!==(n=l.info)&&void 0!==n&&null!==(r=n.args)&&void 0!==r&&r.hasOwnProperty("funcName")&&(l.info.args.funcName=this.name),l}},{key:"createGetIterList",value:function(e,t,n){return t?function(){var t,r=[],a=_n(n);try{for(a.s();!(t=a.n()).done;){var o=t.value;o.isRef()?r.push(o.iterIf([su,hu,lu,du],e)):r.push(o.iter(e))}}catch(e){a.e(e)}finally{a.f()}return r}:function(){var t,r=[],a=_n(n);try{for(a.s();!(t=a.n()).done;){var o=t.value;o.isRef()?r.push(o.iterIf([su,hu],e)):r.push(o.iter(e))}}catch(e){a.e(e)}finally{a.f()}return r}}},{key:"callFunctionByNum",value:function(e,t,n,r){var a=this.createGetIterList(e,n,r);switch(t){case 1:return(0,Mt.averageVar)(a);case 2:return(0,Mt.countVar)((function(){return a().map((function(e){return e.filter((function(e){return e.isNumber()}))}))}));case 3:return(0,Mt.countaVar)(a);case 4:return(0,Mt.maxVar)(a);case 5:return(0,Mt.minVar)(a);case 6:return(0,Mt.productVar)(e,a);case 7:var o=(0,Mt.varianceVar)(!1,a);if(!o.isNumber())return o;var i=Math.sqrt(o.getValue());return new ut.NumberVar(i);case 8:var u=(0,Mt.varianceVar)(!0,a);if(!u.isNumber())return u;var s=Math.sqrt(u.getValue());return new ut.NumberVar(s);case 9:return(0,Mt.sumVar)(a);case 10:return(0,Mt.varianceVar)(!1,a);case 11:return(0,Mt.varianceVar)(!0,a);default:return we.d$b[we.O6N.UNKNOWN_SUBTOTAL_FUNCTION]({funcName:this.name,arg:t})}}}]),t}(gC("SUBTOTAL",2,256,1,tC,[{type:tC},iw.MATRIX_AND_SHEET_REF,iw.MATRIX_AND_SHEET_REF]));!function(e){e[e.Head=0]="Head",e[e.Tail=1]="Tail"}(mw||(mw={}));var Cw=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"repeatedParam",get:function(){return 0!==this.repeatedLastParam?[mw.Tail,this.repeatedLastParam]:null}}]),t}(ut.FuncOpBase);function _w(e){return e instanceof Cw}var Rw=function(e){function t(){var e;return(0,y.Z)(this,t),(e=(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))).name="LAMBDA",e.operands=1,e.optionOperands=253,e.resultType=sC,e.repeatedLastParam=1,e.paramsDesc=[{type:vC},{type:vC}],e.convertVariant=function(e,t){var n=t.argument;return n.isError()?{isError:!0,convertedArgument:n,srcArg:n}:{isError:!1,convertedArgument:n,srcArg:n}},e}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e){for(var t=(arguments.length<=1?0:arguments.length-1)-1,n=0,r=[],a=new Set,o=e.formula.formula.params;n<t;n++){var i=n+1<1||arguments.length<=n+1?void 0:arguments[n+1];if(!gf(i))return we.d$b[we.O6N.FORMULA_WITH_INVALID_PARAM]({funcName:this.name,index:n+1});var u=o[i.index].toUpperCase();if(a.has(u))return we.d$b[we.O6N.FORMULA_WITH_SAME_NAME_PARAMETER]({funcName:this.name});a.add(u),r.push(i)}return new fc(n+1<1||arguments.length<=n+1?void 0:arguments[n+1],r)}},{key:"repeatedParam",get:function(){return[mw.Head,1]}}]),t}(Cw),ww=function(e){function t(){var e;return(0,y.Z)(this,t),(e=(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))).name="LET",e.operands=1,e.optionOperands=252,e.resultType=ut.VAR_TYPE.ATOM,e.repeatedLastParam=1,e.paramsDesc=[{type:ut.VAR_TYPE.ALL},{type:ut.VAR_TYPE.ALL},{type:ut.VAR_TYPE.ALL}],e.convertVariant=function(e,t){var n=t.argument;return n.isError()?{isError:!0,convertedArgument:n,srcArg:n}:{isError:!1,convertedArgument:n,srcArg:n}},e}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),r=1;r<t;r++)n[r-1]=arguments[r];var a=n.length;if(a%2==0)return we.d$b[we.O6N.THE_NUMBER_OF_PARAMETERS_OF_A_FUNCTION_MUST_BE_ODD]({funcName:this.name,count:a});for(var o=new Set,i=e.formula.formula.params,u=0;u<a-1;u+=2){var s=n[u];if(!gf(s))return we.d$b[we.O6N.FORMULA_WITH_INVALID_PARAM]({funcName:this.name,index:u+1});var l=i[s.index].toUpperCase();if(o.has(l))return we.d$b[we.O6N.FORMULA_WITH_SAME_NAME_PARAMETER]({funcName:this.name});o.add(l)}var c=n[a-1];!Array.isArray(e.parameterScope)&&a>1&&(e.parameterScope=[]);for(var h=1;h<a-1;h+=2){var f=n[h];f.isOp()&&(f=f.getVar(e)),gf(f)&&(f=ut.NAME_ERR_VAR),e.parameterScope[n[h-1].index]=f}return c.isCollection()?c:c.getVar(e)}},{key:"repeatedParam",get:function(){return[mw.Head,2]}}]),t}(Cw);function kw(e,t,n){var r=e.length;if(t="PERCENTILE.EXC"===n?t:(0|t)/4,0===r)return HR(n);var a=t*(r+1)-1,o=a%1;if(a<0||r-1<a)return dR(n,2,t.toString());e.sort((function(e,t){return e-t}));var i=Math.floor(a),u=e[i];return new ut.NumberVar(0===o?u:u+o*(e[i+1]-u))}function Sw(e){var t,n=[];return e.exitWhen((function(e){var n=e.isError();return n&&(t=e),n})).filter((function(e){return e.isNumber()})).forEach((function(e){return n.push(e.getValue())})),t||n}function Ew(e){for(var t={N:0,M:0,Q:0,sum:0,sum2:0},n=0;n<e.length;n++){var r=e[n],a=r-t.M,o=a/(t.N+1);t.M+=o,t.Q+=t.N*a*o,t.N++,t.sum+=r,t.sum2+=r*r}return t}var Tw=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e,t,n){return Aw(e,t,n,this.name)}}]),t}(gC("PERCENTILE.EXC",2,0,0,tC,[{type:iC},{type:tC}]));function Aw(e,t,n,r){var a=n.getValue(),o=Sw(t.iter(e));return o instanceof ut.ErrorVar?o:kw(o,a,r)}var Iw=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e,t,n){return bw(e,t,n,this.name)}}]),t}(gC("QUARTILE.EXC",2,0,0,tC,[{type:iC},{type:tC}]));function bw(e,t,n,r){var a=n.getValue();if(4<=a||0>=a)return dR(r,2,a.toString());var o=Sw(t.iter(e));return o instanceof ut.ErrorVar?o:kw(o,a,r)}var Fw=function(e){function t(){var e,n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"MODE";return(0,y.Z)(this,t),(e=(0,d.Z)(this,(0,v.Z)(t).call(this,n))).name=n,e}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),r=1;r<t;r++)n[r-1]=arguments[r];for(var a=0,o=n;a<o.length;a++){var i=o[a];if(Fu(i)&&1===i.size()&&i.getVar(e).isNull())return qR(this.name)}return Mw(e,(function(){var t,r=[],a=_n(n);try{for(a.s();!(t=a.n()).done;){var o=t.value;r.push(o.iter(e))}}catch(e){a.e(e)}finally{a.f()}return r}),this.name)}}]),t}(gC("MODE",1,256,1,tC,[{type:tC|iC},{type:tC|iC}]));function Mw(e,t,n){var r,a=1,o=new Map,i=_n(t());try{for(i.s();!(r=i.n()).done;){var u=r.value,s=null;if(u.exitWhen((function(e){return e.isError()&&(s=e),e.isError()})).filter((function(e){return e.isNumber()})).forEach((function(t){var n=t.getValue(e);if(o.has(n)){var r=o.get(n)+1;a<r&&(a=r),o.set(n,r)}else o.set(n,1)})),s)return s}}catch(e){i.e(e)}finally{i.f()}if(1===a)return $R(n);var l,c=_n(o.keys());try{for(c.s();!(l=c.n()).done;){var h=l.value;if(o.get(h)===a)return new ut.NumberVar(h)}}catch(e){c.e(e)}finally{c.f()}return ut.NA_ERR_VAR}var Vw=function(e){function t(){var e;return(0,y.Z)(this,t),(e=(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))).shouldSkipError=!1,e.alwaysCalc=!0,e}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e,t,n){var r,a,o=Math.floor(t.getValue());if(o<0||o>19)return we.d$b[we.O6N.UNKNOWN_AGGREGATE_FUNCTION]({funcName:this.name,arg:o});var i=Math.floor(n.getValue());if(i<0||i>7)return nR(this.name,n.getValue().toString(),2,"0,1,2,3,4,5,6,7");e.info&&(e.info.hasAggregate=!0);for(var u=arguments.length,s=new Array(u>3?u-3:0),l=3;l<u;l++)s[l-3]=arguments[l];var c=this.callFunctionByNum(e,o,i,s);return c.isError()&&null!==(r=c.info)&&void 0!==r&&null!==(a=r.args)&&void 0!==a&&a.hasOwnProperty("funcName")&&(c.info.args.funcName=this.name),c}},{key:"createGetIterList",value:function(e,t,n){var r=this;return function(){var a,o=[],i=_n(n);try{for(i.s();!(a=i.n()).done;){var u=a.value;Fu(u)?o.push(u.iterIf(t,e)):o.push(u.iter(e).filter((function(e){return!r.shouldSkipError||!e.isError()})))}}catch(e){i.e(e)}finally{i.f()}return o}}},{key:"checkArgs",value:function(e,t,n){var r=this;if(2!==t.length)return function(e,t,n){return ut.tractorErrorVarCreators[ut.ErrorCode.ARGUMENTS_COUNT_SHOULD_BE_EXACTLY]({funcName:e,requiredOperandCount:t,argCount:n})}(this.name,4,t.length+2);var a=t[1].getVar();if(!a.isPrimitive())return ut.VALUE_ERR_VAR;var o=a.toNumberVar(e.service);if(o.isNull())return yR(this.name,4,a.getValue(),ut.FormulaErrorPhrases.DATA_TYPE_STRING,ut.FormulaErrorPhrases.DATA_TYPE_DOUBLE);var i=t[0],u=[];if(i.isPrimitive()){if(i.isNull())return IR(this.name,3);u.push(i)}else Fu(i)?i.iterIf(n,e).forEach((function(e){e.isPrimitive()&&u.push(e)})):i.iter(e).filter((function(e){return!r.shouldSkipError||!e.isError()})).forEach((function(e){e.isPrimitive()&&u.push(e)}));return{array:i=new Ru([u]),numVar:o}}},{key:"callFunctionByNum",value:function(e,t,n,r){var a=[];n>=0&&n<=3&&a.push(hu,fu),[1,3,5,7].includes(n)&&a.push(lu,du),[2,3,6,7].includes(n)&&(a.push(cu),this.shouldSkipError=!0),4===n&&(e.skipEmptyRef=!0);var o=this.createGetIterList(e,a,r);switch(t){case 1:return(0,Mt.averageVar)(o);case 2:return(0,Mt.countVar)((function(){return o().map((function(e){return e.filter((function(e){return e.isNumber()}))}))}));case 3:return(0,Mt.countaVar)(o);case 4:return(0,Mt.maxVar)(o);case 5:return(0,Mt.minVar)(o);case 6:return(0,Mt.productVar)(e,o);case 7:var i=(0,Mt.varianceVar)(!1,o);if(!i.isNumber())return i;var u=Math.sqrt(i.getValue());return new ut.NumberVar(u);case 8:var s=(0,Mt.varianceVar)(!0,o);if(!s.isNumber())return s;var l=Math.sqrt(s.getValue());return new ut.NumberVar(l);case 9:return(0,Mt.sumVar)(o);case 10:return(0,Mt.varianceVar)(!1,o);case 11:return(0,Mt.varianceVar)(!0,o);case 12:return(0,Mt.quartVar)(2,o,this.name);case 13:var c,h=_n(r);try{for(h.s();!(c=h.n()).done;){var f=c.value;if(Fu(f)&&1===f.size()&&f.getVar(e).isNull())return qR(this.name)}}catch(e){h.e(e)}finally{h.f()}return Mw(e,o,this.name)}var d=this.checkArgs(e,r,a);if(d instanceof ut.ErrorVar)return d;switch(t){case 14:return(0,Mt.largeVar)(e,d.array,d.numVar,this.name);case 15:return(0,Mt.smallVar)(e,d.array,d.numVar,this.name);case 16:return(0,Mt.percentileVar)(e,d.array,d.numVar,this.name);case 17:return(0,Mt.quartileVar)(e,d.array,d.numVar,this.name);case 18:return Aw(e,d.array,d.numVar,"PERCENTILE.EXC");case 19:return bw(e,d.array,d.numVar,this.name);default:return we.d$b[we.O6N.UNKNOWN_AGGREGATE_FUNCTION]({funcName:this.name,arg:t})}}}]),t}(gC("AGGREGATE",3,252,1,tC,[{type:tC},{type:tC},{type:dC},{type:dC}]));!function(e){e[e.Parameter=0]="Parameter",e[e.Expression=1]="Expression"}(pw||(pw={}));var Nw=new Set(["SORT","SORTBY","SORTN","XLOOKUP","XMATCH"]);function Ow(e){return function(e){function t(){var e;return(0,y.Z)(this,t),(e=(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))).hasSubtotal=!1,e.hasAggregate=!1,e.alwaysCalcInfo=Object.assign({},Gy),e.hasArrayFunction=!1,e.tokens=[],e.functionCount=new Map,e.nameParamCompileContext=null,e.functionStack=[],e.invokeFunctionCounter=0,e.isArrayFormula=!1,e.importRangeCount=0,e.expression=[],e.hasAsyncFunction=!1,e}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"getTokens",value:function(){return this.tokens}},{key:"getRefs",value:function(){return Ky(this.refs)?null:this.refs}},{key:"getParams",value:function(){var e,t;return null!==(e=null===(t=this.nameParamCompileContext)||void 0===t?void 0:t.params)&&void 0!==e?e:null}},{key:"resetState",value:function(){this.tokens=[],this.refId=1,this.refs={},this.hasSubtotal=!1,this.hasAggregate=!1,this.isArrayFormula=!1,this.importRangeCount=0,this.hasAsyncFunction=!1,this.alwaysCalcInfo=Object.assign({},Gy),this.nameParamCompileContext=null,this.invokeFunctionCounter=0,this.expression=[],this.functionStack=[],this.hasArrayFunction=!1}},{key:"visitTree",value:function(e,t){return this.context=t,this.resetState(),this.visit(e),this.expression}},{key:"entry",value:function(e){var t;this.visit(e.formula),this.isArrayFormula=this.checkArrayFormula(this.expression),null===(t=this.afterVisitEntry)||void 0===t||t.call(this,this.calcEngine,this.expression)}},{key:"formula",value:function(e){this.visitBinaryOp(e,"ComparisonOperator")}},{key:"concatExp",value:function(e){this.visitBinaryOp(e,"Concatenate")}},{key:"addExp",value:function(e){this.visitBinaryOp(e,"AdditionOperator")}},{key:"mulExp",value:function(e){this.visitBinaryOp(e,"MultiplicationOperator")}},{key:"powExp",value:function(e){this.visitBinaryOp(e,"Power")}},{key:"percentExp",value:function(e){var t,n;this.visit(e.prefixExp);for(var r=null!==(t=null===(n=e.Percent)||void 0===n?void 0:n.length)&&void 0!==t?t:0,a=0;a<r;a++){var o=e.Percent[a];this.appendToken(o.image);var i=this.calcEngine.getSuffixUnaryOp(o.image);if(null==i)throw new Error("Invalid token in the percent expression!");this.expression.push(this.visitPercentExp(i,this.lazyCalc))}}},{key:"prefixExp",value:function(e){var t,n,r=this,a=null!==(t=null===(n=e.AdditionOperator)||void 0===n?void 0:n.length)&&void 0!==t?t:0;0!==a&&e.AdditionOperator.forEach((function(e){r.appendToken(e.image)})),this.visit(e.baseFormula);for(var o=a-1;o>=0;o--){var i=e.AdditionOperator[o],u=this.calcEngine.getPrefixUnaryOp(i.image);if(null==u)throw new Error("Invalid token in the prefix expression!");this.expression.push(this.visitPrefixExp(u,this.lazyCalc))}}},{key:"baseFormula",value:function(e){if(void 0!==e.simpleConstant)this.visit(e.simpleConstant);else if(void 0!==e.matrixConstant)this.visit(e.matrixConstant);else if(void 0!==e.advancedReference)this.visit(e.advancedReference);else{if(void 0===e.notCommaAdvancedReference)throw new Error("Invalid token in the baseFormula expression!");this.visit(e.notCommaAdvancedReference)}}},{key:"advancedReference",value:function(e){this.visitRefOp(e,"Comma")}},{key:"intersectExp",value:function(e){this.visitRefOp(e,"WhiteSpace")}},{key:"rangeExp",value:function(e){this.visitRefOp(e,"Colon")}},{key:"notCommaAdvancedReference",value:function(e){this.visitRefOp(e,"WhiteSpace")}},{key:"notCommaRangeExp",value:function(e){this.visitRefOp(e,"Colon")}},{key:"simpleConstant",value:function(e){if(void 0!==e.LogicalConstant){var t=e.LogicalConstant[0].image.toUpperCase();switch(this.appendToken(t),t){case ut.BooleanVar.TRUE:this.expression.push(this.visitLogicalConstant(!0));break;case ut.BooleanVar.FALSE:this.expression.push(this.visitLogicalConstant(!1))}}else if(void 0!==e.NumericalConstant){var n=(0,ut.convertTo15Digits)(parseFloat(e.NumericalConstant[0].image));this.appendToken(String(n).toUpperCase()),this.expression.push(this.visitNumericalConstant(n))}else if(void 0!==e.StringConstant){var r=e.StringConstant[0].image;this.appendToken(r),this.expression.push(this.visitStringConstant(r.slice(1,r.length-1).replace(/""/g,'"')))}else{if(void 0===e.ErrorConstant)throw new Error("Invalid token in the simpleConstant expression!");var a=e.ErrorConstant[0].image;this.visitError(a)}}},{key:"visitError",value:function(e){switch(this.appendToken(e),e){case ut.ErrorConstant.NULL:this.expression.push(this.visitErrorConstant(ut.NULL_ERR_VAR));break;case ut.ErrorConstant.DIV0:this.expression.push(this.visitErrorConstant(ut.DIV0_ERR_VAR));break;case ut.ErrorConstant.VALUE:this.expression.push(this.visitErrorConstant(ut.VALUE_ERR_VAR));break;case ut.ErrorConstant.NAME:this.context.error=ut.NAME_ERR_VAR,this.expression.push(this.visitErrorConstant(ut.NAME_ERR_VAR));break;case ut.ErrorConstant.NUM:this.expression.push(this.visitErrorConstant(ut.NUM_ERR_VAR));break;case ut.ErrorConstant.NA:this.expression.push(this.visitErrorConstant(ut.NA_ERR_VAR));break;case ut.ErrorConstant.REF:this.expression.push(this.visitErrorConstant(ut.REF_ERR_VAR));break;default:this.expression.push(this.visitErrorConstant(ut.tractorErrorVarCreators[ut.ErrorCode.DEFAULT_RUNTIME_ERROR](e)))}}},{key:"matrixConstant",value:function(e){this.appendToken(e.OpenBrace[0].image),this.visit(e.lhs);var t=1;if(void 0!==e.rhs){for(var n=0;n<e.rhs.length;n++){var r=e.rhs[n],a=e.SemiColon[n].image;this.appendToken(Yy(a)),this.visit(r)}t+=e.rhs.length}this.appendToken(e.CloseBrace[0].image),this.expression.push(this.visitFunctionOp(this.calcEngine.getFunctionOp("PRIVATE_ARRAY_LITERAL"),t,this.lazyCalc))}},{key:"simpleConstantList",value:function(e){var t,n;this.visit(e.lhs);for(var r=null!==(t=null===(n=e.rhs)||void 0===n?void 0:n.length)&&void 0!==t?t:0,a=0;a<r;a++){var o=e.Comma[a].image;this.appendToken($y(o)),this.visit(e.rhs[a])}var i=this.calcEngine.getFunctionOp("PRIVATE_ARRAY_ROW");this.expression.push(this.visitFunctionOp(i,r+1,this.lazyCalc))}},{key:"parenExp",value:function(e){var t=Array.isArray(e.arguments)&&e.arguments.length>0;t&&this.setInvokeFunctionStatus(!0);var n=e.OpenParen[0].image;this.appendToken(Jy(n)),this.visit(e.formula);var r=e.CloseParen[0].image;this.appendToken(qy(r)),this.expression.push(this.visitParenOp(this.calcEngine.getParenOp(),this.lazyCalc)),t&&(this.setInvokeFunctionStatus(!1),this.visitInvokedFunction(e.arguments,e.OpenParen,e.CloseParen))}},{key:"visitInvokedFunction",value:function(e,t,n){for(var r=0;r<e.length;r++){r!==e.length-1&&this.setInvokeFunctionStatus(!0);var a=t[r].image;this.appendToken(Jy(a));var o=e[r];this.visit(o);var i=n[r].image;this.appendToken(qy(i));var u,s=o.children;u=void 0===s.firstArgument&&void 0===s.Comma?1:void 0===s.Comma?2:s.Comma.length+2,this.expression.push(this.visitFunctionOp(this.calcEngine.getInvokeFunctionOp(),u,this.lazyCalc)),r!==e.length-1&&this.setInvokeFunctionStatus(!1)}}},{key:"arguments",value:function(e){var t,n,r=this.functionStack[this.functionStack.length-1];n=r instanceof ww,!(t=r instanceof Rw)&&!n||Array.isArray(e.Comma)||(this.nameParamCompileContext.argumentCompileTypes[this.nameParamCompileContext.argumentCompileTypes.length-1]=1);var a=void 0!==e.firstArgument;if(a&&this.visit(e.firstArgument),void 0!==e.Comma){a||this.expression.push(this.visitEmptyArgument());for(var o=0,i=0;i<e.Comma.length;i++){var u;if(t&&i===e.Comma.length-1){var s=this.nameParamCompileContext.argumentCompileTypes.length-1;this.nameParamCompileContext.argumentCompileTypes[s]=1}if(n){var l=this.nameParamCompileContext.argumentCompileTypes.length-1;i%2==0||i===e.Comma.length-1?this.nameParamCompileContext.argumentCompileTypes[l]=1:this.nameParamCompileContext.argumentCompileTypes[l]=0}var c=e.Comma[i];this.appendToken($y(c.image));var h=null===(u=e.restArguments)||void 0===u?void 0:u[o];null!=h&&h.location.startOffset===c.endOffset+1?(o+=1,this.visit(h)):this.expression.push(this.visitEmptyArgument())}}}},{key:"funcExp",value:function(e){var t=e.FunctionName[0].image,n=this.getFunctionNameFromNode(t.toUpperCase()),r=this.calcEngine.getFunctionOp(n),a=null,o=Array.isArray(e.restCalls)&&e.restCalls.length>0;if(o&&this.setInvokeFunctionStatus(!0),null!=r)this.functionStack.push(r),!1===this.hasArrayFunction&&Kl.has(n)&&(this.hasArrayFunction=!0),r instanceof yw?this.hasSubtotal=!0:r instanceof P_?(this.importRangeCount++,this.hasAsyncFunction=!0):r instanceof Rw||r instanceof ww?(null===this.nameParamCompileContext&&(this.nameParamCompileContext={params:[],argumentCompileTypes:[],stack:[]}),this.nameParamCompileContext.stack.push({}),this.nameParamCompileContext.argumentCompileTypes.push(0)):r instanceof Vw?this.hasAggregate=!0:Nw.has(r.name)&&(this.hasAsyncFunction=!0),this.appendToken(Jy(t.toUpperCase()));else{if(null!==this.nameParamCompileContext){var i=this.nameParamCompileContext.argumentCompileTypes;if(1===i[i.length-1])for(var u=n.toUpperCase(),s=this.nameParamCompileContext.stack.length-1;s>=0;s--){var l=this.nameParamCompileContext.stack[s][u];if(null!=l){this.appendParamToken(l[0]),this.appendToken("("),a=l[1],this.expression.push(a);break}}}null===a&&this.appendToken(Jy(t))}this.visit(e.firstCall);var c=e.firstCall[0].children,h=void 0!==c.Comma?c.Comma.length+1:void 0===c.firstArgument?0:1,f=e.CloseParen[0].image;if(this.appendToken(qy(f)),this.countFunction(n),null!=r){var d,v,g;this.functionStack.pop(),(r instanceof Rw||r instanceof ww)&&(null!==(d=this.nameParamCompileContext)&&void 0!==d&&d.argumentCompileTypes.pop(),null===(v=this.nameParamCompileContext)||void 0===v||v.stack.pop());var m=this.visitFunctionOp(r,h,this.lazyCalc);this.expression.push(m),this.updateAlwaysCalcInfo&&(this.alwaysCalcInfo=null===(g=this.updateAlwaysCalcInfo)||void 0===g?void 0:g.call(this,m,this.alwaysCalcInfo))}else if(null!==a)this.expression.push(this.visitFunctionOp(this.calcEngine.getInvokeFunctionOp(),h+1,this.lazyCalc));else{var p=this.getFunctionNameFromNode(t);this.context.error=ut.NAME_ERR_VAR,this.expression.push(this.visitFunctionOp(new Qy(p),h,this.lazyCalc))}o&&this.setInvokeFunctionStatus(!1),Array.isArray(e.restCalls)&&e.restCalls.length>0&&this.visitInvokedFunction(e.restCalls,e.OpenParen,e.CloseParen)}},{key:"visitBinaryOp",value:function(e,t){var n,r;this.visit(e.lhs);for(var a=null!==(n=null===(r=e.rhs)||void 0===r?void 0:r.length)&&void 0!==n?n:0,o=0;o<a;o++){var i=e[t][o].image;this.appendToken(i);var u=this.calcEngine.getBinaryOp(i);if(null==u)throw new Error("Invalid token in the binary operator");this.visit(e.rhs[o]),this.expression.push(this.visitBinaryOperator(u,this.lazyCalc))}}},{key:"visitRefOp",value:function(e,t){var n,r;this.visit(e.lhs);for(var a=null!==(n=null===(r=e.rhs)||void 0===r?void 0:r.length)&&void 0!==n?n:0,o=0;o<a;o++){var i=e[t][o].image;this.appendToken(i),this.visit(e.rhs[o]);var u=i.replace(/\r|\n|\t/g," ").trim();0===u.length&&(u=" "),"："===u?u=":":"，"===u&&(u=",");var s=this.calcEngine.getBinaryOp(u);if(null==s)throw new Error("Invalid token in ref operator");this.expression.push(this.visitRefOperator(s,this.lazyCalc))}}},{key:"visitNameRef",value:function(e){var t=e.Name[0].image,n=Ll(t,this.context);if(null===n)throw new Error("unexpected error in parse reference");if(this.nameParamCompileContext&&this.nameParamCompileContext.argumentCompileTypes){var r=this.nameParamCompileContext.argumentCompileTypes.length-1,a=t.toUpperCase();if(0===this.nameParamCompileContext.argumentCompileTypes[r]){var o=this.nameParamCompileContext.stack[r],i=this.visitParameterReference(this.nameParamCompileContext.params.length);this.nameParamCompileContext.params.push(t);var u=this.nameParamCompileContext.params.length-1;return null==o[a]&&(o[a]=[u,i]),this.appendParamToken(u),void this.expression.push(i)}for(var s=r;s>=0;s--){var l=this.nameParamCompileContext.stack[s][a];if(null!=l)return this.appendParamToken(l[0]),void this.expression.push(l[1])}return this.appendToken(t),void this.expression.push(this.visitErrorConstant(ut.NAME_ERR_VAR))}this.appendToken(t),this.expression.push(this.visitErrorConstant(n))}},{key:"visitFieldNameRef",value:function(e,t){var n=e.FieldNameLocalReferenceA1[0].image,r=Bl(n,this.context,t);if(null==r)throw new Error("unexpected error in parse reference");if(r.isError())this.appendToken(n),this.expression.push(this.visitErrorConstant(r));else{var a=this.appendToken(r);this.expression.push(this.visitReference(a))}}},{key:"visitLocalRef",value:function(e){var t=Jl(e,this.context);if(null==t)throw new Error("unexpected error in parse reference");if(t.isError())this.appendToken(e),this.expression.push(this.visitErrorConstant(t));else{var n=this.appendToken(t);this.expression.push(this.visitReference(n))}}},{key:"visitExternalRef",value:function(e){var t=Jl(e,this.context);if(null==t)throw new Error("unexpected error in parse reference");if(t.isError())this.appendToken(e),this.expression.push(this.visitErrorConstant(t));else{var n=this.appendToken(t);this.expression.push(this.visitReference(n))}}},{key:"getFunctionNameFromNode",value:function(e){var t=e.trim();return t.substring(0,t.length-1)}},{key:"appendToken",value:function(e){if(e instanceof Ei){var t="R"+this.refId++;return this.tokens.push(t),this.refs[t]=e,t}var n=this.tokens.length;if(0===n||"C"!==this.tokens[n-1][0]){var r="C".concat(e);return this.tokens.push(r),r}return this.tokens[n-1]+=e,e}},{key:"appendParamToken",value:function(e){this.tokens.push("P".concat(e))}},{key:"countFunction",value:function(e){var t=this.functionCount.get(e)||0;this.functionCount.set(e,t+1)}},{key:"getFuncStatistics",value:function(){return this.functionCount}},{key:"setInvokeFunctionStatus",value:function(e){e?this.invokeFunctionCounter++:this.invokeFunctionCounter--}},{key:"lazyCalc",get:function(){if(this.invokeFunctionCounter>0)return!0;if(null===this.nameParamCompileContext){var e=this.functionStack,t=e[e.length-1];return!!t&&(Xl.has(t.name)||!this.hasArrayFunction&&Ql.has(t.name))}var n=this.nameParamCompileContext.argumentCompileTypes,r=n.length-1;return!(r<0)&&1===n[r]}}]),t}(e)}function xw(e){return function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"updateAlwaysCalcInfo",value:function(e,t){return fw(e,t)}},{key:"afterVisitEntry",value:function(e,t){var n=t[t.length-1];if(n.isOp()){var r=n.op();r instanceof Hy?(r=e.getPrecisionAddOp(),n.setOperator(r)):r instanceof Wy&&(r=e.getPrecisionSubOp(),n.setOperator(r))}}},{key:"checkArrayFormula",value:function(e){return ec(e)}},{key:"visitPercentExp",value:function(e,t){return this.visitSheetOperatorVar(e,1,t)}},{key:"visitPrefixExp",value:function(e,t){return this.visitSheetOperatorVar(e,1,t)}},{key:"visitLogicalConstant",value:function(e){return new ut.BooleanVar(e)}},{key:"visitNumericalConstant",value:function(e){return new ut.NumberVar(e)}},{key:"visitStringConstant",value:function(e){return new ut.StringVar(e)}},{key:"visitErrorConstant",value:function(e){return e}},{key:"visitMatrixSimpleConstantWithRef",value:function(e){return ut.REF_ERR_VAR}},{key:"visitMatrixSimpleConstantWithNumber",value:function(e,t){return new ut.NumberVar("+"===e?t:-t)}},{key:"visitParameterReference",value:function(e){return"number"==typeof e?new vf(e):e}},{key:"visitParenOp",value:function(e,t){return this.visitSheetOperatorVar(e,1,t)}},{key:"visitEmptyArgument",value:function(){return ut.NULL_VAR}},{key:"visitFunctionOp",value:function(e,t,n){return this.visitSheetOperatorVar(e,t,n)}},{key:"visitBinaryOperator",value:function(e,t){return this.visitSheetOperatorVar(e,2,t)}},{key:"visitRefOperator",value:function(e,t){return this.visitSheetOperatorVar(e,2,t)}},{key:"visitReference",value:function(e){return new af(e)}},{key:"visitSheetOperatorVar",value:function(e,t,n){var r=new mf(e,t);return n&&r.setLazyCalc(n),r}}]),t}(e)}function Zw(e){return function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"checkArrayFormula",value:function(e){return tc(e)}},{key:"visitPercentExp",value:function(e){return this.visitOperatorVar(e,1)}},{key:"visitPrefixExp",value:function(e){return this.visitOperatorVar(e,1)}},{key:"visitLogicalConstant",value:function(e){return this.visitBooleanVar(e)}},{key:"visitNumericalConstant",value:function(e){return this.visitNumberVar(e)}},{key:"visitStringConstant",value:function(e){return this.visitStringVar(e)}},{key:"visitErrorConstant",value:function(e){return this.visitErrorVar(e)}},{key:"visitMatrixSimpleConstantWithRef",value:function(e){return this.visitErrorVar(ut.REF_ERR_VAR)}},{key:"visitMatrixSimpleConstantWithNumber",value:function(e,t){switch(e){case"+":return this.visitNumberVar(t);case"-":return this.visitNumberVar(-t)}return null}},{key:"visitParameterReference",value:function(e){return this.visitParameterVar(e)}},{key:"visitParenOp",value:function(e){return this.visitOperatorVar(e,1)}},{key:"visitEmptyArgument",value:function(){return this.visitNullVar()}},{key:"visitFunctionOp",value:function(e,t){return this.visitOperatorVar(e,t)}},{key:"visitBinaryOperator",value:function(e){return this.visitOperatorVar(e,2)}},{key:"visitRefOperator",value:function(e){return this.visitOperatorVar(e,2)}},{key:"visitReference",value:function(e){return this.visitReferenceVar(e)}},{key:"visitOperatorVar",value:function(e,t){var n=e.name,r="";return e instanceof ut.FuncOpBase?r="F:".concat(n,":").concat(t):e instanceof ut.BinaryOpBase?r="OB".concat(n):e instanceof ut.PrefixUnaryOpBase?r="OP".concat(n):e instanceof ut.SuffixUnaryOpBase?r="OS".concat(n):e instanceof ut.ParenOp?r="OG".concat(t):e instanceof yf&&(r="OI".concat(t)),r}},{key:"visitNumberVar",value:function(e){return"D".concat(e)}},{key:"visitStringVar",value:function(e){return"S".concat(e)}},{key:"visitBooleanVar",value:function(e){return"B"+(e?1:0)}},{key:"visitNullVar",value:function(){return"N"}},{key:"visitErrorVar",value:function(e){var t=e.getSpecialInfo();return t&&"string"==typeof t.errorInfo?"E:".concat(e.errorType,":").concat(t.errorInfo,":").concat(e.errorCode):"E:".concat(e.errorType,"::").concat(e.errorCode)}},{key:"visitReferenceVar",value:function(e){return e}},{key:"visitParameterVar",value:function(e){return"number"==typeof e?"P".concat(e):e}}]),t}(e)}function Dw(e,t){var n=arguments.length>2&&void 0!==arguments[2]&&arguments[2],r=arguments.length>3?arguments[3]:void 0,a=arguments.length>4?arguments[4]:void 0,o=t.sheet();if(null==o)throw new Error("failed to deserialize: sheet not found in ref");if(n&&!r)throw new Error('When serializing a transposed range, there must be a "sourceCell".');var i={ref:t};if(null==e.refs)return{formulaData:e,formulaText:_f(e,null,i)};for(var u={},s=Object.keys(e.refs),l=n?a?Lw(e,a,{ref:r}):[!1,void 0]:[!0,void 0],c=(0,p.Z)(l,2),h=c[0],f=c[1],d=0;d<s.length;d++){var v=s[d],g=e.refs[v],m=void 0;m=n?Bw(g,t,r,h,null==f?void 0:f.get(v)):Oc(g,o,(function(e){return o.getParent().getSheetFromId(e)}),i),u[v]=m,e.refs[v]=Mc(m,i)}return{formulaData:e,formulaText:_f(e,u,i)}}function Pw(e,t,n,r){var a={},o=0;for(var i in e){var u=e[i];a[i]=Oc(u,t,n,r),o++}return 0===o?null:a}function Lw(e,t,n){var r=Object.keys(e.refs),a=t.sheet(),o=new Map;return[r.some((function(r){var i=Oc(e.refs[r],a,(function(e){return a.getParent().getSheetFromId(e)}),n);return o.set(r,i),t.isIntersect(i)})),o]}function Bw(e,t,n,r,a){var o,i,u={ref:n},s=n.sheet();a=a||Oc(e,s,(function(e){return s.getParent().getSheetFromId(e)}),u);var l=0==(e.type&Fc);if(!r&&!l)return a.setSheet(a.sheet()),a;var c,h=a.rowFrom()-n.rowFrom(),f=a.colFrom()-n.colFrom(),d=t.offset(f,h),v=Number(a.refStatus()).toString(2).padStart(4,"0").split("");return o=[v[2],v[0]],v[0]=o[0],v[2]=o[1],i=[v[3],v[1]],v[1]=i[0],v[3]=i[1],(c=1===a.rowCount()&&1===a.colCount()?new Zi(d.rowFrom(),d.colFrom(),t.sheet()):new Oi(d.rowFrom(),d.colFrom(),a.colCount(!0),a.rowCount(!0),t.sheet())).setRefStatus(parseInt(v.join(""),2)),c}function Uw(e){return new ut.ErrorVar(ut.ErrorType.RUNTIME_ERROR,ut.ErrorConstant.RUNTIME_ERROR,we.O6N.DESERIALIZE_FORMULA_ERROR,{message:e})}function Hw(e,t,n){if(t||n){var r=e.parent.importRangeManager,a=null;if(t?a=r.getMetaFromId(t):n&&(a=n),a){var o=a,i=o.spreadSource,u=o.ref,s=o.isSyncStyle,l=Yl(u);if(!l)throw new Error("range is null");return{importRangeMeta:a,externalDataReferenceInfo:{url:i,range:l,isSyncStyle:s}}}}}function Ww(e,t){var n;return!1===(null===(n=Object.getOwnPropertyDescriptor(e,"externalDataReference"))||void 0===n?void 0:n.writable)?e=Object.assign({},e,{externalDataReference:t}):e.externalDataReference=t,e}function jw(e,t,n){var r;if(!function(e,t){for(var n=t.tree,r=n.length-1;r>=0;r--)if(n[r].includes(e))return!0;return!1}("F:IMPORTRANGE",t))return t;var a=e.parent,o=a.calcEngine,i=a.importRangeManager;if(a.importRangeManagerV3.V3Enable)return t.externalDataReference&&(t=Ww(t,void 0)),t;var u=o.deserializeFormula(t,n,{enableCalculation:!0,useCache:!1}),s={ref:n,spread:a},l=u.formula,c=l.tokens,h=l.serialization,f=l.expression,d=l.params,v=ac(u,u.formula.expression);if(!v||!v.length)return Ww(t,null);var g=null!==(r=v[0])&&void 0!==r?r:u.getExternalDataReferenceInfo(),m={sheetID:e.id(),url:g.url,range:g.range},p=i.generateAndCacheId(u,m);return wf(u=o.createFormula(n,{refMap:u.refMap,formula:new lf({tokens:c,serialization:h,expression:f,params:d,importRangeId:null==p?void 0:p.importRangeId,importRangeMeta:p,externalDataReferenceInfo:g}),isArrayFormula:Wf(u)}),s)}var zw={B:function(e,t){var n=t.isRoot,r=t.calcEngine,a=r.getBinaryOp(e);return n&&(a instanceof Wy&&(a=r.getPrecisionSubOp()),a instanceof Hy&&(a=r.getPrecisionAddOp())),[a,2]},S:function(e,t){return[t.calcEngine.getSuffixUnaryOp(e),1]},P:function(e,t){return[t.calcEngine.getPrefixUnaryOp(e),1]},G:function(e,t){return[t.calcEngine.getParenOp(),Number(e)]},I:function(e,t){return[t.calcEngine.getInvokeFunctionOp(),Number(e)]}};var Gw,Jw=[{deserializeRefs:function(e,t,n,r){return null==e?null:Pw(e,t,(function(e){return t.getParent().getSheetFromId(e)}),Object.assign({ref:n},r))},deserializeTree:function(e,t,n){for(var r=e.length,a=new Array(r),o=!1,i=!1,u=Object.assign({},Gy),s=!1,l=!1,c=!1,h=Object.assign({},n,{refs:t}),f=r-1;f>=0;f--){var d=e[f],v=n.visitFunctions[d[0]];if(null==v)throw new Error("Failed to deserialize: Unknown var ".concat(d[0]));var g=v(d,h,f===e.length-1);if(g.isOp()){var m=g.op().name;"SUBTOTAL"===m?o=!0:"AGGREGATE"===m?i=!0:Kl.has(m)?s=!0:Xl.has(m)?l=!0:Ql.has(m)&&(c=!0),u=fw(g,u)}a[f]=g}return(l||c&&!s)&&function(e){for(var t=[],n=0,r=e.length-1;r>=0;r--){var a=e[r],o=-1,i=null;if(0!==t.length&&(o=t[t.length-1][1]-1,i=t[t.length-1][0],0===o?t.pop():t[t.length-1][1]=o),Vu(a)&&n>0&&(n+=a.size()),a.isOp()){var u=!1;if(0!==n)u=!0,n--;else if(-1!==o&&null!==i){var s=i.operandType(o);(0,ut.varTypeCheck)(a,s)&&(u=!0)}u&&a.setLazyCalc(!0);var l=a.op(),c=a.getArgCount();c>0&&(t.push([l,c]),u&&(n+=c))}else n=Math.max(0,n-1)}}(a),[a,u,o,i,s]},deserializeParams:function(e){return null==e?null:e.map((function(e,t){return new vf(t)}))},visitFunctions:{B:function(e){return new ut.BooleanVar("1"===e[1])},D:function(e){return new ut.NumberVar(Number(e.substring(1)))},S:function(e){return new ut.StringVar(e.substring(1))},N:function(){return ut.NULL_VAR},E:function(e){var t=e.split(":"),n=Number(t[1]),r=t[2]||null,a=function(e){switch(e){case ut.ErrorType.NULL:return ut.NULL_ERR_VAR;case ut.ErrorType.DIV0:return ut.DIV0_ERR_VAR;case ut.ErrorType.VALUE:return ut.VALUE_ERR_VAR;case ut.ErrorType.REF:return ut.REF_ERR_VAR;case ut.ErrorType.NAME:return ut.NAME_ERR_VAR;case ut.ErrorType.NUM:return ut.NUM_ERR_VAR;case ut.ErrorType.NA:return ut.NA_ERR_VAR;default:return Uw("Unknown error type, ".concat(e))}}(n);return null!=r&&(a=a.clone()).setSpecialInfo({errorInfo:r}),a},R:function(e,t){var n=t.refs;if(null==(n?n[e]:null))throw new Error("Failed to deserialize: refVar not found");return new af(e)},M:function(e){var t=e.split(":");return new vc(Number(t[1]||0),Number(t[2]||0))},O:function(e,t,n){var r,a,o=t.calcEngine,i=e[1],u=e.substring(2),s=zw[i],l=null,c=0;if(null!=s&&(r=s(u,{isRoot:n,calcEngine:o}),l=(a=(0,p.Z)(r,2))[0],c=a[1]),!l)throw new Error("Failed to deserialize: Unknown operator ".concat(e));return new mf(l,c)},F:function(e,t){var n=t.calcEngine,r=e.split(":"),a=n.getFunctionOp(r[1])||new Qy(r[1]),o=Number(r[2]||0);return new mf(a,o)},P:function(e,t){var n=t.params,r=Number(e.slice(1));if(null==n)return Uw("Unknown lambda Param, ".concat(e));var a=n[r];return null!=a?a:Uw("Unknown lambda Param, ".concat(e))}}}];function qw(e,t,n,r,a){var o,i=t.sheet();if(null==i)throw new Error("Failed to deserialize: sheet not found in ref");var u=i.getParent().calcEngine,s=null===(o=null==r?void 0:r.enableCalculation)||void 0===o||o,l=a?n.fromMutation(e,t,i,a,r):n.fromJSON(e,t,i,r),c=(0,p.Z)(l,2),h=c[0],f=c[1],d=u.createFormula(t,{refMap:f,enableCalculation:s,formula:h,isArrayFormula:1===e.flag}),v=i.parent.importRangeManager;return h.importRangeMeta&&v.setImportRangeMeta(d,h.importRangeMeta),d}!function(e){e.LexicalAnalysis="LexicalAnalysis",e.SyntaxAnalysis="SyntaxAnalysis",e.SemanticAnalysis="SemanticAnalysis"}(Gw||(Gw={}));var $w=function(){function e(){(0,y.Z)(this,e)}return(0,C.Z)(e,null,[{key:"now",value:function(){return void 0===window.performance?Date.now():window.performance.now()}}]),e}(),Yw=function(){function e(t){(0,y.Z)(this,e),this.calcEngine=t,this.isCollectPerformance=!0,this.performanceData={formulaCount:0,LexicalAnalysis:0,SyntaxAnalysis:0,SemanticAnalysis:0},this.A1Instance=null,this.SerializationA1Instance=null,this.R1C1Instance=null,this.SerializationR1C1Instance=null,this.builder=this.getVisitBuilderA1Instance()}return(0,C.Z)(e,[{key:"getVisitBuilderA1Instance",value:function(){if(null!=this.A1Instance)return this.A1Instance;var e=function(e){return function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"referenceFunction",value:function(e){if(void 0!==e.LocalReferenceA1){var t=e.LocalReferenceA1[0].image;this.visitLocalRef(t)}else if(void 0!==e.ExternalReferenceA1){var n=e.ExternalReferenceA1[0].image;this.visitExternalRef(n)}else if(void 0!==e.RefConstant)this.visitError(ut.REF_ERR_VAR.getValue());else if(void 0!==e.Name)this.visitNameRef(e);else if(void 0!==e.parenExp)this.visit(e.parenExp);else{if(void 0===e.funcExp)throw new Error("Invalid token in the referenceFunction expression!");this.visit(e.funcExp)}}}]),t}(Ow(xw(e)))}(Uy.getTractorParserA1().getBaseCstVisitorConstructor());return this.A1Instance=new e,this.A1Instance}},{key:"getSerializationVisitBuilderA1Instance",value:function(){if(null!=this.SerializationA1Instance)return this.SerializationA1Instance;var e=function(e){return function(e){function t(){var e;return(0,y.Z)(this,t),(e=(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))).serialization=[],e}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"referenceFunction",value:function(e){if(void 0!==e.LocalReferenceA1){var t=e.LocalReferenceA1[0].image;this.visitLocalRef(t)}else if(void 0!==e.ExternalReferenceA1){var n=e.ExternalReferenceA1[0].image;this.visitExternalRef(n)}else if(void 0!==e.RefConstant)this.visitError(ut.REF_ERR_VAR.getValue());else if(void 0!==e.Name)this.visitNameRef(e);else if(void 0!==e.parenExp)this.visit(e.parenExp);else{if(void 0===e.funcExp)throw new Error("Invalid token in the referenceFunction expression!");this.visit(e.funcExp)}}}]),t}(Ow(Zw(e)))}(Uy.getTractorParserA1().getBaseCstVisitorConstructor());return this.SerializationA1Instance=new e,this.SerializationA1Instance}},{key:"getVisitBuilderR1C1Instance",value:function(){if(null!=this.R1C1Instance)return this.R1C1Instance;var e=function(e){return function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"referenceFunction",value:function(e){if(void 0!==e.LocalReferenceR1C1){var t=e.LocalReferenceR1C1[0].image;this.visitLocalRef(t)}else if(void 0!==e.ExternalReferenceR1C1){var n=e.ExternalReferenceR1C1[0].image;this.visitExternalRef(n)}else if(void 0!==e.RefConstant)this.visitError(ut.REF_ERR_VAR.getValue());else if(void 0!==e.Name)this.visitNameRef(e);else if(void 0!==e.parenExp)this.visit(e.parenExp);else{if(void 0===e.funcExp)throw new Error("Invalid token in the referenceFunction expression!");this.visit(e.funcExp)}}}]),t}(Ow(xw(e)))}(Uy.getTractorParserR1C1().getBaseCstVisitorConstructor());return this.R1C1Instance=new e,this.R1C1Instance}},{key:"getSerializationVisitBuilderR1C1Instance",value:function(){if(null!=this.SerializationR1C1Instance)return this.SerializationR1C1Instance;var e=function(e){return function(e){function t(){var e;return(0,y.Z)(this,t),(e=(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))).serialization=[],e}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"referenceFunction",value:function(e){if(void 0!==e.LocalReferenceR1C1){var t=e.LocalReferenceR1C1[0].image;return this.visitLocalRef(t)}if(void 0!==e.ExternalReferenceR1C1){var n=e.ExternalReferenceR1C1[0].image;return this.visitExternalRef(n)}if(void 0===e.RefConstant){if(void 0!==e.Name)return this.visitNameRef(e);if(void 0!==e.parenExp)return this.visit(e.parenExp);if(void 0!==e.funcExp)return this.visit(e.funcExp);throw new Error("Invalid token in the referenceFunction expression!")}this.visitError(ut.REF_ERR_VAR.getValue())}}]),t}(Ow(Zw(e)))}(Uy.getTractorParserR1C1().getBaseCstVisitorConstructor());return this.SerializationR1C1Instance=new e,this.SerializationR1C1Instance}},{key:"startCollectPerformance",value:function(){this.isCollectPerformance=!0,this.performanceData.formulaCount=0,this.performanceData.LexicalAnalysis=0,this.performanceData.SyntaxAnalysis=0,this.performanceData.SemanticAnalysis=0}},{key:"stopCollectPerformance",value:function(){this.isCollectPerformance=!1}},{key:"collectPerformanceData",value:function(e){this.isCollectPerformance&&(this.performanceData.formulaCount+=1,this.performanceData.LexicalAnalysis+=e.LexicalAnalysis,this.performanceData.SyntaxAnalysis+=e.SyntaxAnalysis,this.performanceData.SemanticAnalysis+=e.SemanticAnalysis)}},{key:"getPerformanceData",value:function(){var e=this.performanceData.formulaCount;return 0===e?null:{formulaCount:e,timeCost:this.performanceData.LexicalAnalysis+this.performanceData.SyntaxAnalysis+this.performanceData.SemanticAnalysis,LexicalAnalysis:this.performanceData.LexicalAnalysis/e,SyntaxAnalysis:this.performanceData.SyntaxAnalysis/e,SemanticAnalysis:this.performanceData.SemanticAnalysis/e}}},{key:"compile",value:function(e,t){var n,r,a,o,i;void 0===t.refStyle&&(t.refStyle="A1");var u,s,l=null===(n=t.enableCalculation)||void 0===n||n,c=[],h=$w.now(),f=this.compileTokens(e,t.refStyle),d=$w.now(),v=f.lexer,g=_n(null!==(i=f.errors)&&void 0!==i?i:[]);try{for(g.s();!(u=g.n()).done;){var m=u.value;c.push(m)}}catch(e){g.e(e)}finally{g.f()}switch(t.refStyle){case"A1":s=Uy.getTractorParserA1(),this.setVisitBuilder(l?this.getVisitBuilderA1Instance():this.getSerializationVisitBuilderA1Instance());break;case"R1C1":s=Uy.getTractorParserR1C1(),this.setVisitBuilder(l?this.getVisitBuilderR1C1Instance():this.getSerializationVisitBuilderR1C1Instance());break;default:throw Error("RefStyle is not found!")}s.input=f.tokens;var y,C=s.entry(),_=$w.now(),R=_n(s.errors);try{for(R.s();!(y=R.n()).done;){var w=y.value;c.push(w)}}catch(e){R.e(e)}finally{R.f()}if(c.length>0)return{formulaVar:null,lexer:v,parser:s,errors:c};var k=null;try{k=this.builder.visitTree(C,t)}catch(e){c.push(e)}if(0!==c.length)return{formulaVar:null,lexer:v,parser:s,errors:c};var S=t.ref.sheet(),E=this.builder.importRangeCount,T=Boolean(S&&(null===(r=S.parent.importRangeManagerV3)||void 0===r?void 0:r.V3Enable));if(E>1&&S){var A=S.parent.importRangeManager;if(!1===T)return A.collectImportRangeFrontError("import_range_num_greaten_than_one"),{formulaVar:null,lexer:v,parser:s,errors:[new Error("importRangeNum is greater than one")]}}var I=null,b=null;l?I=k:b=k;var F=null!==(a=this.compileImportRange(t.ref,b,I))&&void 0!==a?a:null,M=this.calcEngine.formulaRefService.fromBuilder(this.builder,t.ref,b,I,!T&&F?F[0]:null,l,null!==(o=t.useCache)&&void 0!==o?o:1!==E),V=(0,p.Z)(M,2),N=V[0],O=V[1],x=this.calcEngine.createFormula(t.ref,{formula:N,refMap:O,enableCalculation:l,isArrayFormula:this.builder.isArrayFormula}),Z=$w.now();return null!=k&&this.collectPerformanceData({LexicalAnalysis:d-h,SyntaxAnalysis:_-d,SemanticAnalysis:Z-_}),{formulaVar:x,lexer:v,parser:s,errors:0===c.length?null:c,externalDataReferenceInfos:F}}},{key:"compileImportRange",value:function(e,t,n){var r;if(this.builder.importRangeCount){n=null!==(r=n)&&void 0!==r?r:function(e,t){for(var n=t.refs,r=t.calcEngine,a=t.version,o=t.params,i=[],u=Jw[a-1],s=u.visitFunctions,l={refs:n,calcEngine:r,visitFunctions:s,params:(0,u.deserializeParams)(o)},c=0;c<e.length;++c){var h=e[c],f=(0,s[h[0]])(h,l,c===e.length-1);i.push(f)}return i}(t,{params:this.builder.getParams(),version:1,calcEngine:this.calcEngine,refs:this.builder.getRefs()});var a=this.calcEngine.formulaRefService.fromBuilder(this.builder,e,t,n,null,!0,!1),o=(0,p.Z)(a,2),i=o[0],u=o[1];return ac(this.calcEngine.createFormula(e,{formula:i,refMap:u,isArrayFormula:this.builder.isArrayFormula}),n)}}},{key:"compileTokens",value:function(e,t){var n=Qs(e,t),r=n.lexingResult,a=r.tokens,o=r.errors;return{tokens:a,lexer:n.lexer,errors:0===o.length?null:o}}},{key:"setVisitBuilder",value:function(e){null!=e&&(this.builder=e,this.builder.calcEngine=this.calcEngine)}}]),e}(),Kw=function(){function e(t,n,r){(0,y.Z)(this,e),this.data=t,this.refs=t.refs?Pw(t.refs,n,r):null}return(0,C.Z)(e,[{key:"getRefs",value:function(){return this.refs}},{key:"exportRefs",value:function(e){return this.refs?function(e,t){var n={};for(var r in e)n[r]=Mc(e[r],{ref:t});return n}(this.refs,e):null}},{key:"formulaData",get:function(){return this.data}}]),e}();var Xw=function(e){function t(){var e;return(0,y.Z)(this,t),(e=(0,d.Z)(this,(0,v.Z)(t).call(this,new ap))).styleRefMgr=new ap,e}return(0,g.Z)(t,e),t}(Og);function Qw(e){return e.replace(/https?:\/\//,"bdDriveImg://")}function ek(){var e=function(){},t=function(){};return[new Promise((function(n,r){e=n,t=r})),e,t]}var tk,nk=function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1e3,r=setInterval((function(){try{e()&&(clearInterval(r),t())}catch(e){clearInterval(r),t()}}),n)},rk=function(){function e(){(0,y.Z)(this,e),this._isTestMode=!1,this._storeName="faster-shadow-recording","undefined"!=typeof window&&!0!==window.isNotBrowser&&(this._isTestMode="true"===localStorage.getItem(this._storeName))}return(0,C.Z)(e,[{key:"convertFont",value:function(e){return this._isTestMode?e.replace(/-apple-system, /,"").replace(/BlinkMacSystemFont, /,""):e}},{key:"isTest",get:function(){return this._isTestMode}}]),e}(),ak=new rk;!function(e){e[e.NO=0]="NO",e[e.ALL_CELL=1]="ALL_CELL",e[e.ALL_NORMAL=2]="ALL_NORMAL",e[e.ALL_ROW=3]="ALL_ROW",e[e.ALL_COL=4]="ALL_COL",e[e.MIXED=5]="MIXED"}(tk||(tk={}));var ok={currentRgType:we.xj7.CELL,multiSelectType:0};function ik(e){var t,n,r=e.getSelections();if(!r)return ok;var a=null==r?void 0:r[0];if(!a)return ok;var o=a.rgType,i=e.getRowCount(),u=e.getColumnCount(),s=a.rowCount(),l=a.colCount();if(n=o===we.xj7.NORMAL?1===s&&1===l?we.xj7.CELL:0===a.rowFrom()&&i===s&&0===a.colFrom()&&u===l?we.xj7.ALL:0===a.rowFrom()&&i===s?we.xj7.COL:0===a.colFrom()&&u===l?we.xj7.ROW:we.xj7.NORMAL:0===a.rowFrom()&&i===s&&0===a.colFrom()&&u===l?we.xj7.ALL:o,!r||r.length<=1)t=0;else{var c=r.map((function(e){return e.rgType})),h=!1,f=!1;if(c.every((function(e){return e===we.xj7.NORMAL}))){var d=r.map((function(e){return e.rowCount()+e.colCount()}));h=d.every((function(e){return 2===e})),f=d.every((function(e){return e>2}))}var v=c.every((function(e){return e===we.xj7.COL})),g=c.every((function(e){return e===we.xj7.ROW}));t=h?1:f?2:v?4:g?3:5}return{currentRgType:n,multiSelectType:t}}function uk(e,t,n,r){function a(t,n){var r=e.getValue(t,n);return""!==r&&null!=r}function o(t,n){var r=e.getSpans(new Zi(t,n,e));return r&&r.length>0?a(r[0].rowFrom(),r[0].colFrom()):a(t,n)}function i(e,t,n){for(var r=n.withValue,a=e+u,i=t+s,h=!1;a>=0&&a<l&&i>=0&&i<c;){if(r!==o(a,i)){h=!0;break}a+=u,i+=s}return{row:a-u,col:i-s,found:h}}var u=0,s=0,l=e.getRowCount(),c=e.getColumnCount();switch(r){case 0:u=-1;break;case 3:u=1;break;case 1:s=-1;break;default:s=1}var h=i(t,n,{withValue:!0,direction:r});return(function(t,n,r,a){var o=e.getSpans(new Zi(t,n,e));return!!(o&&o.length>0)&&o[0].containCell(r,a)}(t,n,h.row,h.col)||t===h.row&&n===h.col)&&(h=i(h.row,h.col,{withValue:!1,direction:r})).found?{row:h.row+u,col:h.col+s}:{row:h.row,col:h.col}}function sk(){return n.g&&n.g.window.isNotBrowser}function lk(e,t){var n=t.floatImageSetting;return{action:"setFloatImage",sheet_id:e,target:{row:n.row,col:n.col},value:t}}function ck(e,t){return{action:"delFloatImage",sheet_id:t,value:{floatImageId:e}}}function hk(e){var t=new Map;return e.forEach((function(e){var n=e.floatImageSetting,r=av(n.row,n.col),a=t.get(r);a?t.set(r,[].concat((0,m.Z)(a),[e])):t.set(r,[e])})),t}function fk(e,t){var n=t.floatImageModel.getFloatImageMap(),r=e.toJSON(),a=r.row,o=r.col,i=r.rowCount,u=r.colCount,s=a+i-1,l=o+u-1;return Object.values(n).filter((function(e){var n=e.floatImageSetting,r=n.row,i=n.col,u=n.width,c=n.height,h=n.x,f=n.y;if(r<a||i<o||r>s||i>l)return!1;for(var d=0,v=0,g=i;g<=l;g++)d+=t.getColumnWidth(g);for(var m=r;m<=s;m++)v+=t.getRowHeight(m);return d>=h+u&&v>=f+c}))}function dk(e,t,n,r){var a=r.id(),o=e.floatImageSetting,i=o.x,u=o.y,s=r.getColumnWidth(n),l=r.getRowHeight(t),c=Math.min(s,i),h=Math.min(l,u),f=(0,Re.default)(Object.assign({},o,{x:c,y:h,row:t,col:n}));return{sheetId:a,floatImageId:(0,we.zsn)(10),floatImageSetting:f}}var vk=50;function gk(e,t,n,r){return r?new Oi(t,n,r.rowCount,r.colCount,e):new Oi(t,n,1,1,e)}function mk(e,t,n,r,a){if(a&&r)return{pageRange:new Oi(t,n,r.rowCount,r.colCount,e),contentRange:new Oi(t+r.rowCount+1,n,a.rowCount,a.colCount,e)};if(a&&!r)return{contentRange:new Oi(t,n,a.rowCount,a.colCount,e)};if(!a&&r)return{pageRange:new Oi(t,n,r.rowCount,r.colCount,e)};return{pageRange:new Oi(t,n,1,1,e),contentRange:new Oi(t+2,n,10,5,e),spanRange:new Oi(t+7,n+1,1,4,e)}}function pk(e,t,n,r,a,o){var i=e.getPivotTableManager();if(!i.hasPivotTable())return!1;var u,s=new Oi(t,n,r,a,e),l=_n(i.getPivotInfoMap());try{for(l.s();!(u=l.n()).done;){var c=(0,p.Z)(u.value,2),h=c[0],f=c[1];if(!(null!=o&&o.includes(h)||f.isHidden)){var d=f.contentRange,v=f.pageRange,g=f.row,m=f.col;if(s.containCell(g,m))return!0;if(null!=d&&d.isIntersect(s))return!0;if(null!=v&&v.isIntersect(s))return!0}}}catch(e){l.e(e)}finally{l.f()}return!1}function yk(e,t,n,r,a,o){var i=e.getPivotTableManager();if(!i.hasPivotTable())return!1;var u,s=new Oi(t,n,r,a,e),l=_n(i.getPivotInfoMap());try{for(l.s();!(u=l.n()).done;){var c=(0,p.Z)(u.value,2),h=c[0],f=c[1];if(!o.includes(h)){var d=f.contentRange,v=f.pageRange,g=f.row,m=f.col;if(s.containCell(g,m))return!0;if(null!=d&&d.isIntersect(s))return!0;if(null!=v&&v.isIntersect(s))return!0}}}catch(e){l.e(e)}finally{l.f()}return!1}function Ck(e,t,n,r,a,o){var i=e.getPivotTableManager();if(!i.hasPivotTable())return!1;var u,s=new Oi(t,n,r,a,e),l=_n(i.getPivotInfoMap());try{for(l.s();!(u=l.n()).done;){var c=(0,p.Z)(u.value,2),h=c[0],f=c[1];if(h!==o){var d=f.contentRange,v=f.pageRange;if((!d||s.contain(d))&&(!v||s.contain(v)))return!0}}}catch(e){l.e(e)}finally{l.f()}return!1}function _k(e,t,n,r,a,o){var i=e.getPivotTableManager();if(!i.hasPivotTable())return[];var u,s=[],l=new Oi(t,n,r,a,e),c=_n(i.getPivotInfoMap());try{for(c.s();!(u=c.n()).done;){var h=(0,p.Z)(u.value,2),f=h[0],d=h[1],v=d.pageRange,g=d.contentRange,m=d.row,y=d.col;f!==o&&(l.containCell(m,y)||(null==v?void 0:v.isIntersect(l))||(null==g?void 0:g.isIntersect(l)))&&s.push(f)}}catch(e){c.e(e)}finally{c.f()}return s}function Rk(e,t){var n,r=e.getPivotTableManager().getPivotInfoByName(t);if(r){var a=r.pageRange,o=r.contentRange;a&&o?n=a.clone().union(o):a?n=a.clone():o&&(n=o.clone())}return n}function wk(e,t){var n=e.getPivotTableManager();if(!n.hasPivotTable())return[];var r,a=[],o=_n(n.getPivotInfoMap());try{for(o.s();!(r=o.n()).done;){var i=(0,p.Z)(r.value,1)[0],u=Rk(e,i);u&&t.contain(u)&&a.push(i)}}catch(e){o.e(e)}finally{o.f()}return a}function kk(e,t){var n=e.getPivotTableManager();if(n.hasPivotTable()){var r,a=function(e,t){return e.isIntersect(t)&&!e.contain(t)},o=_n(n.getPivotInfoMap());try{for(o.s();!(r=o.n()).done;){var i=(0,p.Z)(r.value,2)[1],u=i.pageRange,s=i.contentRange;if(u&&s){if(a(t,u.union(s)))return!0}else{if(u&&a(t,u))return!0;if(s&&a(t,s))return!0}}}catch(e){o.e(e)}finally{o.f()}return!1}}function Sk(e,t,n,r,a){return a?new Oi(r?t+r.rowCount+1:t,n,a.rowCount,a.colCount,e):new Oi(t+2,n,10,5,e)}var Ek={"3Arrows":we.B2l.IconGroupType.IconGroupType_ARROWS_3,"3ArrowsGray":we.B2l.IconGroupType.IconGroupType_ARROWS_GRAY_3,"3Triangles":we.B2l.IconGroupType.IconGroupType_TRIANGLES_3,"4ArrowsGray":we.B2l.IconGroupType.IconGroupType_ARROWS_GRAY_4,"4Arrows":we.B2l.IconGroupType.IconGroupType_ARROWS_4,"5ArrowsGray":we.B2l.IconGroupType.IconGroupType_ARROWS_GRAY_5,"5Arrows":we.B2l.IconGroupType.IconGroupType_ARROWS_5,"3Circles":we.B2l.IconGroupType.IconGroupType_CIRCLES_3,"3MultiGraphics":we.B2l.IconGroupType.IconGroupType_MULTI_GRAPHICS_3,"4Circles":we.B2l.IconGroupType.IconGroupType_CIRCLES_4,"5Circles":we.B2l.IconGroupType.IconGroupType_CIRCLES_5,"2Status":we.B2l.IconGroupType.IconGroupType_STATUS_2,"3Status":we.B2l.IconGroupType.IconGroupType_STATUS_3,"2CommentStatus":we.B2l.IconGroupType.IconGroupType_COMMENT_STATUS_2,"3Flags":we.B2l.IconGroupType.IconGroupType_FLAGS_3,"3Stars":we.B2l.IconGroupType.IconGroupType_STARS_3,"3HeartShaped":we.B2l.IconGroupType.IconGroupType_HEART_SHAPED_3,"3Mood":we.B2l.IconGroupType.IconGroupType_MOOD_3,"5CirclesRatio":we.B2l.IconGroupType.IconGroupType_CIRCLES_RATIO_5},Tk=(xe={},(0,l.Z)(xe,we.B2l.IconGroupType.IconGroupType_ARROWS_3,"3Arrows"),(0,l.Z)(xe,we.B2l.IconGroupType.IconGroupType_ARROWS_GRAY_3,"3ArrowsGray"),(0,l.Z)(xe,we.B2l.IconGroupType.IconGroupType_TRIANGLES_3,"3Triangles"),(0,l.Z)(xe,we.B2l.IconGroupType.IconGroupType_ARROWS_GRAY_4,"4ArrowsGray"),(0,l.Z)(xe,we.B2l.IconGroupType.IconGroupType_ARROWS_4,"4Arrows"),(0,l.Z)(xe,we.B2l.IconGroupType.IconGroupType_ARROWS_GRAY_5,"5ArrowsGray"),(0,l.Z)(xe,we.B2l.IconGroupType.IconGroupType_ARROWS_5,"5Arrows"),(0,l.Z)(xe,we.B2l.IconGroupType.IconGroupType_CIRCLES_3,"3Circles"),(0,l.Z)(xe,we.B2l.IconGroupType.IconGroupType_MULTI_GRAPHICS_3,"3MultiGraphics"),(0,l.Z)(xe,we.B2l.IconGroupType.IconGroupType_CIRCLES_4,"4Circles"),(0,l.Z)(xe,we.B2l.IconGroupType.IconGroupType_CIRCLES_5,"5Circles"),(0,l.Z)(xe,we.B2l.IconGroupType.IconGroupType_STATUS_2,"2Status"),(0,l.Z)(xe,we.B2l.IconGroupType.IconGroupType_STATUS_3,"3Status"),(0,l.Z)(xe,we.B2l.IconGroupType.IconGroupType_COMMENT_STATUS_2,"2CommentStatus"),(0,l.Z)(xe,we.B2l.IconGroupType.IconGroupType_FLAGS_3,"3Flags"),(0,l.Z)(xe,we.B2l.IconGroupType.IconGroupType_STARS_3,"3Stars"),(0,l.Z)(xe,we.B2l.IconGroupType.IconGroupType_HEART_SHAPED_3,"3HeartShaped"),(0,l.Z)(xe,we.B2l.IconGroupType.IconGroupType_MOOD_3,"3Mood"),(0,l.Z)(xe,we.B2l.IconGroupType.IconGroupType_CIRCLES_RATIO_5,"5CirclesRatio"),xe),Ak={greaterThan:we.B2l.IconsRuleOperatorType.IconsRuleOperatorType_GREATER,greaterThanOrEqual:we.B2l.IconsRuleOperatorType.IconsRuleOperatorType_GREATER_OR_EQUAL,lessThan:we.B2l.IconsRuleOperatorType.IconsRuleOperatorType_LESS,lessThanOrEqual:we.B2l.IconsRuleOperatorType.IconsRuleOperatorType_LESS_OR_EQUAL},Ik=(Ze={},(0,l.Z)(Ze,we.B2l.IconsRuleOperatorType.IconsRuleOperatorType_GREATER,"greaterThan"),(0,l.Z)(Ze,we.B2l.IconsRuleOperatorType.IconsRuleOperatorType_GREATER_OR_EQUAL,"greaterThanOrEqual"),(0,l.Z)(Ze,we.B2l.IconsRuleOperatorType.IconsRuleOperatorType_LESS,"lessThan"),(0,l.Z)(Ze,we.B2l.IconsRuleOperatorType.IconsRuleOperatorType_LESS_OR_EQUAL,"lessThanOrEqual"),Ze);function bk(e){if(e){var t,n,r,a;if(e.font){var o=e.font.split(" ");o.includes("bold")&&(t=!0),o.includes("italic")&&(n=!0)}2!==e.textDecoration&&3!==e.textDecoration||(r=!0),1!==e.textDecoration&&3!==e.textDecoration||(a=!0),e.bold&&(t=!0),e.italic&&(n=!0),(e.strike||e.lineThrough)&&(r=!0),(e.underline||e.underLine)&&(a=!0);var i=e.backColor?{color:{rgb:e.backColor}}:void 0,u={color:e.foreColor?{rgb:e.foreColor}:void 0,strike:r,underline:a,italic:n,bold:t},s={fill:i,font:void 0!==u.bold||void 0!==u.italic||void 0!==u.strike||void 0!==u.underline||void 0!==u.color?u:void 0};return void 0!==s.fill||void 0!==s.font?s:void 0}}function Fk(e){var t;if(e){var n=e.fill,r=e.font,a={};if(null!=n&&null!==(t=n.color)&&void 0!==t&&t.rgb&&(a.backColor=n.color.rgb),r){var o;null!==(o=r.color)&&void 0!==o&&o.rgb&&(a.foreColor=r.color.rgb),r.strike&&(a.textDecoration=2),r.underline&&(a.textDecoration=a.textDecoration?3:1);var i=[];r.bold&&i.push("bold"),r.italic&&i.push("italic"),a.font=i.length?i.join(" "):void 0}return void 0!==a.backColor||void 0!==a.foreColor||void 0!==a.textDecoration||void 0!==a.font?a:void 0}}function Mk(e){if(e&&void 0!==e.iconType&&void 0!==e.iconLevel)return{iconType:Ek[e.iconType],iconLevel:e.iconLevel}}function Vk(e){if(e&&void 0!==e.color&&void 0!==e.percent&&void 0!==e.originPoint)return{gradient:e.isGradient,color:{rgb:e.color},percent:e.percent,originPoint:e.originPoint}}var Nk=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"getExporter",value:function(e,t,n,r){return new xk(this,e,t,n,r)}},{key:"getImporter",value:function(){return new Ok(this)}}]),t}(Kv),Ok=function(){function e(t){(0,y.Z)(this,e),this.conditionalFormatStyleModel=t}return(0,C.Z)(e,[{key:"importExtraInfo",value:function(e,t){}},{key:"importCell",value:function(e,t,n,r){}},{key:"deserializeConditionalFormatting",value:function(e,t,n){if(n){var r=n.conditionalFormatStyle,a=n.iconsStyle,o=n.dataBarStyleInfo,i=Object.assign({},Fk(r),{},function(e){if(e)return{iconType:Tk[e.iconType],iconLevel:e.iconLevel}}(a),{},function(e){var t,n;if(e)return{isGradient:e.gradient,color:null!==(t=null===(n=e.color)||void 0===n?void 0:n.rgb)&&void 0!==t?t:"",percent:e.percent,originPoint:e.originPoint}}(o));this.conditionalFormatStyleModel.set(e,t,i)}}}]),e}(),xk=function(e){function t(e,n,r,a,o){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).call(this,e.iter(n,r,a,o)))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"serializeCell",value:function(e,t,n){n.isForShortcut&&this.serializeDataValidationForShortcut(e,t,n)}},{key:"serializeDataValidationForShortcut",value:function(e,t,n){if(t){var r={conditionalFormatStyle:bk(t),iconsStyle:Mk(t),dataBarStyleInfo:Vk(t)},a=n.cellValueRefHelper;e.conditionalFormattingResultId=a.conditionalFormattingResults.add(r).id}}}]),t}(Um),Zk=function(){function e(){(0,y.Z)(this,e),this.map=new Map}return(0,C.Z)(e,[{key:"add",value:function(e){var t=this.map.get(e);return t?t[1]++:(t=[new ut.StringVar(e),1],this.map.set(e,t)),t[0]}},{key:"has",value:function(e){return this.map.has(e)}},{key:"del",value:function(e){var t=this.map.get(e);t&&(t[1]>1?t[1]--:this.map.delete(e))}},{key:"clear",value:function(){this.map.clear()}}]),e}();function Dk(e){if(0!==e.length)return e}var Pk=function(e){function t(){var e;return(0,y.Z)(this,t),(e=(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))).valuesRefMap=new Map,e}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"checkValuesRefId",value:function(e,t,n){var r=void 0!==e?this.preCheckValueRefId(e):void 0;if(void 0!==r)t(r);else{var a=n();void 0!==e&&void 0!==a&&this.bindValueRefId(e,a)}}},{key:"bindValueRefId",value:function(e,t){this.valuesRefMap.set(e,t)}},{key:"preCheckValueRefId",value:function(e){return this.valuesRefMap.get(e)}}]),t}(Ng),Lk=function(){function e(){(0,y.Z)(this,e),this.numbers=new Bk,this.strings=new Bk,this.richStrings=new Pk,this.embedImages=new Pk,this.dataValidations=new Pk,this.mentionsDeserialize=new Pk,this.mentionInfosDeserialize=new Pk,this.mentionsWithStyleDeserialize=new Map,this.mentionsSerialize=new Pk,this.mentionInfosSerialize=new Pk,this.hyperlinks=new Ng,this.attachments=new Pk,this.formulas=new Ng,this.formulaDatas=new Pk,this.formulaRefMaps=new Pk,this.errorValues=new Pk,this.extendValues=new Bk,this.notes=new Pk,this.reminderIds=new Bk,this.selectedMultipleValues=new Pk,this.colors=new Bk,this.conditionalFormattingResults=new Pk,this.formulaSpecialInfoStrings=new Bk}return(0,C.Z)(e,[{key:"getMentionWithStyleRefManager",value:function(e){var t=this.mentionsWithStyleDeserialize.get(e);return t||(t=new Pk,this.mentionsWithStyleDeserialize.set(e,t)),t}},{key:"getAllValueRefs",value:function(){return{numbers:Dk(this.numbers.toArray()),strings:Dk(this.strings.toArray()),richStrings:Dk(this.richStrings.toArray(!0)),formulas:Dk(this.formulas.toArray(!0)),formulaDatas:Dk(this.formulaDatas.toArray(!0)),formulaRefMaps:Dk(this.formulaRefMaps.toArray(!0)),errorValues:Dk(this.errorValues.toArray(!0))}}},{key:"getAllResourceRefs",value:function(){return{embedImages:Dk(this.embedImages.toArray(!0)),dataValidations:Dk(this.dataValidations.toArray(!0)),mentions:Dk(this.mentionsSerialize.toArray(!0)),mentionInfos:Dk(this.mentionInfosSerialize.toArray(!0)),hyperlinks:Dk(this.hyperlinks.toArray(!0)),attachments:Dk(this.attachments.toArray(!0)),extendValues:Dk(this.extendValues.toArray()),notes:Dk(this.notes.toArray()),reminderIds:Dk(this.reminderIds.toArray()),selectedMultipleValues:Dk(this.selectedMultipleValues.toArray(!0)),colors:Dk(this.colors.toArray()),conditionalFormattingResults:Dk(this.conditionalFormattingResults.toArray(!0)),formulaSpecialInfoStrings:Dk(this.formulaSpecialInfoStrings.toArray())}}}]),e}(),Bk=function(){function e(){(0,y.Z)(this,e),this.values=[],this.valuesMap=new Map}return(0,C.Z)(e,[{key:"addValue",value:function(e){var t=this.valuesMap.get(e);return void 0!==t||(t=this.values.push(e)-1,this.valuesMap.set(e,t)),t}},{key:"getIdByRef",value:function(e){var t=this.valuesMap.get(e);return void 0!==t?t:-1}},{key:"toArray",value:function(){return this.values}}]),e}(),Uk=function(){function e(){(0,y.Z)(this,e),this.cellFormats=new Pk,this.numberFormats=new Ng,this.fonts=new Pk,this.fills=new Ng,this.borders=new Ng,this.alignments=new Ng,this.hideLinks=new Ng}return(0,C.Z)(e,[{key:"pushStyle",value:function(e,t){var n,r=this;if(e)return this.cellFormats.checkValuesRefId(t,(function(e){n=e}),(function(){var t=r.getCellFormatting(e);return n=r.pushCellFormatting(t)})),n}},{key:"pushStyleFont",value:function(e,t){var n,r=this;if(e)return this.fonts.checkValuesRefId(t,(function(e){n=e}),(function(){var t=Op(e).font;if(t)return n=r.pushFont(t)})),n}},{key:"getAllRefs",value:function(){return{cellFormats:Dk(this.cellFormats.toArray(!0)),numberFormats:Dk(this.numberFormats.toArray(!0)),fonts:Dk(this.fonts.toArray(!0)),fills:Dk(this.fills.toArray(!0)),borders:Dk(this.borders.toArray(!0)),alignments:Dk(this.alignments.toArray(!0)),hideLinks:Dk(this.hideLinks.toArray(!0))}}},{key:"getCellFormatting",value:function(e){var t=Op(e),n={numFmtId:this.pushNumberFormat(t.numFmt),fontId:this.pushFont(t.font),fillId:this.pushFill(t.fill),borderId:this.pushBorder(t.border),alignmentId:this.pushCellAlignment(t.alignment),autoNumFmtId:this.pushNumberFormat(t.autoNumFmt),hideLinkId:this.pushHideLink(t.otherFmt)};if(void 0!==n.numFmtId||void 0!==n.fontId||void 0!==n.fillId||void 0!==n.borderId||void 0!==n.alignmentId||void 0!==n.autoNumFmtId||void 0!==n.hideLinkId)return n}},{key:"pushCellFormatting",value:function(e){return e?this.cellFormats.add(e).id:void 0}},{key:"pushNumberFormat",value:function(e){return e?this.numberFormats.add(e).id:void 0}},{key:"pushFont",value:function(e){return e?this.fonts.add(e).id:void 0}},{key:"pushFill",value:function(e){return e?this.fills.add(e).id:void 0}},{key:"pushBorder",value:function(e){return e?this.borders.add(e).id:void 0}},{key:"pushCellAlignment",value:function(e){return e?this.alignments.add(e).id:void 0}},{key:"pushHideLink",value:function(e){return e?this.hideLinks.add(e).id:void 0}}]),e}(),Hk=function(){function e(t,n,r,a){(0,y.Z)(this,e),this.cellValueRefHelper=new Lk,this.cellFormatRefHelper=new Uk,this.pValueRefDelta=t,this.pResourceRefDelta=n,this.pFormatDelta=r,this.isApplySnapshot=a}return(0,C.Z)(e,[{key:"valueRefDelta",get:function(){var e;return null!==(e=this.pValueRefDelta)&&void 0!==e?e:this.cellValueRefHelper.getAllValueRefs()}},{key:"resourceRefDelta",get:function(){var e;return null!==(e=this.pResourceRefDelta)&&void 0!==e?e:this.cellValueRefHelper.getAllResourceRefs()}},{key:"formatDelta",get:function(){var e;return null!==(e=this.pFormatDelta)&&void 0!==e?e:this.cellFormatRefHelper.getAllRefs()}}]),e}(),Wk=function(){function e(){(0,y.Z)(this,e),this.root=[]}return(0,C.Z)(e,[{key:"insertNode",value:function(e,t){var n=e[t];return n||(e[t]=n=[]),n}},{key:"calcObjectHashValue",value:function(e,t,n){for(var r=this.root,a=this.root,o=0,i=0;i<t.length;i++){var u=t[i];o=void 0===e[u]?0:e[u]+1,r=a,a=this.insertNode(r,o)}return Number.isInteger(a)||(r[o]=n()),r[o]}}]),e}();function jk(e,t,n,r,a,o){var i=function(e,t,n,r){var a,o=Object.assign({},t),i=n.endRow-n.startRow,u=n.endCol-n.startCol,s=t.endRow-t.startRow,l=t.endCol-t.startCol,c=t.startRow-n.startRow,h=t.startCol-n.startCol,f=s*l;if(s<i&&l>=u-3){var d=c*u;a=e.slice(d,d+s*u),o.startCol=n.startCol,o.endCol=n.endCol}else if(l<u-3){for(var v=new Array(f),g=0;g<f;g++){var m=(c+Math.floor(g/l))*u+(h+Math.floor(g%l));v[g]=e[m]}a=v}else Object.assign(o,n),a=e;return o.startRow-=r.row,o.startCol-=r.col,o.endRow-=r.row,o.endCol-=r.col,{finalCells:a,finalRange:o}}(e,t,n,r),u=i.finalCells,s=i.finalRange,l=[];l.push(o);for(var c=new Array(u.length).fill(0),h=Object.keys(o),f=new Wk,d=function(e){var t=u[e];t!==o&&(c[e]=f.calcObjectHashValue(t,h,(function(){return l.push(t),l.length-1})))},v=0;v<u.length;v++)d(v);var g=a.valueRefDelta,m=a.resourceRefDelta,p=a.formatDelta;return{type:we.B2l.MutationType.MutationType_SetRangeValues,setRangeValues:{range:s,valueRefDelta:g,resourceRefDelta:m,formatDelta:p,cells:{cellIds:c,cells:l}}}}function zk(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:we.fW_.brand;return{type:we.bPy.Line,themeType:e,nonNumShowAs:we.v5m.Zero,emptyShowAs:we.v5m.Space,lineWidth:2,showGradient:!0,extremumMax:{type:we.yre.auto},extremumMin:{type:we.yre.auto},containHiddenCells:!1,seriesColor:Gk[e][0],points:{lastPoint:{color:Gk[e][1],visible:!1},negativePoint:{color:Gk[e][1],visible:!1},markersPoint:{color:Gk[e][1],visible:!1},firstPoint:{color:Gk[e][1],visible:!1},highPoint:{color:Gk[e][1],visible:!1},lowPoint:{color:Gk[e][1],visible:!1}},axis:{color:"N900",reverse:!1,visible:!1},showRadius:!0}}var Gk=(De={},(0,l.Z)(De,we.fW_.brand,["B500","R400"]),(0,l.Z)(De,we.fW_.fresh,["ccmtoken-sheet-minichart-fresh-cyan","ccmtoken-sheet-minichart-fresh-yellow"]),(0,l.Z)(De,we.fW_.light,["ccmtoken-sheet-minichart-bright-purple","ccmtoken-sheet-minichart-bright-yellow"]),(0,l.Z)(De,we.fW_.pro,["ccmtoken-sheet-minichart-professional-blue","ccmtoken-sheet-minichart-professional-red"]),(0,l.Z)(De,we.fW_.soft,["ccmtoken-sheet-minichart-pastel-blue","ccmtoken-sheet-minichart-pastel-yellow"]),De),Jk=function(){function e(t){if((0,y.Z)(this,e),t)for(var n=0,r=Object.entries(t);n<r.length;n++){var a=(0,p.Z)(r[n],2),o=a[0],i=a[1];null!=i&&(this[o]=i)}this.defaultSparklineConfig=zk(this.themeType)}return(0,C.Z)(e,[{key:"setType",value:function(e){this.type=e}},{key:"getType",value:function(){var e;return null!==(e=this.type)&&void 0!==e?e:this.defaultSparklineConfig.type}},{key:"setThemeType",value:function(e){this.themeType=e,this.defaultSparklineConfig=zk()}},{key:"getThemeType",value:function(){var e;return null!==(e=this.themeType)&&void 0!==e?e:this.defaultSparklineConfig.themeType}},{key:"setLineWidth",value:function(e){this.lineWidth=e}},{key:"getLineWidth",value:function(){var e;return null!==(e=this.lineWidth)&&void 0!==e?e:this.defaultSparklineConfig.lineWidth}},{key:"setShowGradient",value:function(e){this.showGradient=e}},{key:"getShowGradient",value:function(){var e;return null!==(e=this.showGradient)&&void 0!==e?e:this.defaultSparklineConfig.showGradient}},{key:"setShowRadius",value:function(e){this.showRadius=e}},{key:"getShowRadius",value:function(){var e;return null!==(e=this.showRadius)&&void 0!==e?e:this.defaultSparklineConfig.showRadius}},{key:"setPoint",value:function(e,t,n){this.points||(this.points={}),this.points[e]||(this.points[e]={}),this.points[e].visible=t,this.points[e].color=n}},{key:"setPointsColor",value:function(e,t){this.setPoint("lastPoint",e,t),this.setPoint("negativePoint",e,t),this.setPoint("markersPoint",e,t),this.setPoint("firstPoint",e,t),this.setPoint("highPoint",e,t),this.setPoint("lowPoint",e,t)}},{key:"getPoint",value:function(e){var t,n;return Object.assign({},null===(t=zk(this.getThemeType()).points)||void 0===t?void 0:t[e],{},null===(n=this.points)||void 0===n?void 0:n[e])}},{key:"setSeriesColor",value:function(e){this.seriesColor=e}},{key:"getSeriesColor",value:function(){var e,t;return null!==(e=null!==(t=this.seriesColor)&&void 0!==t?t:Gk[this.getThemeType()][0])&&void 0!==e?e:zk(this.getThemeType()).seriesColor}},{key:"setExtremumMax",value:function(e,t){this.extremumMax||(this.extremumMax={}),this.extremumMax.type=e,void 0!==t&&(this.extremumMax.value=t)}},{key:"setExtremumMin",value:function(e,t){this.extremumMin||(this.extremumMin={}),this.extremumMin.type=e,void 0!==t&&(this.extremumMin.value=t)}},{key:"getExtremumMax",value:function(){return Object.assign({},this.defaultSparklineConfig.extremumMax,{},this.extremumMax)}},{key:"getExtremumMin",value:function(){return Object.assign({},this.defaultSparklineConfig.extremumMin,{},this.extremumMin)}},{key:"setAxisColor",value:function(e){this.axis||(this.axis={}),this.axis.color=e}},{key:"setAxisVisible",value:function(e){this.axis||(this.axis={}),this.axis.visible=e}},{key:"setAxisReverse",value:function(e){this.axis||(this.axis={}),this.axis.reverse=e}},{key:"getAxisConfig",value:function(){return Object.assign({},this.defaultSparklineConfig.axis,{},this.axis)}},{key:"setDefaultSparklineConfig",value:function(e){this.defaultSparklineConfig=e}},{key:"setNonNumShowAs",value:function(e){this.nonNumShowAs=e}},{key:"setEmptyShowAs",value:function(e){this.emptyShowAs=e}},{key:"setContainHiddenCells",value:function(e){this.containHiddenCells=e}},{key:"getNonNumShowAs",value:function(){var e;return null!==(e=this.nonNumShowAs)&&void 0!==e?e:this.defaultSparklineConfig.nonNumShowAs}},{key:"getEmptyShowAs",value:function(){var e;return null!==(e=this.emptyShowAs)&&void 0!==e?e:this.defaultSparklineConfig.emptyShowAs}},{key:"getContainHiddenCells",value:function(){var e;return null!==(e=this.containHiddenCells)&&void 0!==e?e:this.defaultSparklineConfig.containHiddenCells}},{key:"getRawConfig",value:function(){for(var e={themeType:this.themeType,nonNumShowAs:this.nonNumShowAs,emptyShowAs:this.emptyShowAs,containHiddenCells:this.containHiddenCells,seriesColor:this.seriesColor,points:this.points,lineWidth:this.lineWidth,type:this.type,axis:this.axis,showGradient:this.showGradient,extremumMax:this.extremumMax,extremumMin:this.extremumMin,showRadius:this.showRadius},t=0,n=Object.keys(e);t<n.length;t++){var r=n[t];void 0===e[r]&&delete e[r]}return e}},{key:"getConfig",value:function(){return(0,ie.Z)(this.defaultSparklineConfig,{themeType:this.themeType,nonNumShowAs:this.nonNumShowAs,emptyShowAs:this.emptyShowAs,containHiddenCells:this.containHiddenCells,seriesColor:this.seriesColor,points:this.points,lineWidth:this.lineWidth,type:this.type,axis:this.axis,showGradient:this.showGradient,extremumMax:this.extremumMax,extremumMin:this.extremumMin})}}]),e}();function qk(){return"_".concat(Math.random().toString(36).substr(2,9))}function $k(e){var t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],n=!(arguments.length>2&&void 0!==arguments[2])||arguments[2];return function(r,a,o){var i=r.getId(),u=t?o:-o,s=r.getPosition(),l=s.row,c=s.col;t||(n&&l>=a&&l<a+o&&e.deleteSparklineInSparklineModel(i),!n&&c>=a&&c<a+o&&e.deleteSparklineInSparklineModel(i)),n&&l>=a&&r.updatePosition(l+u,c),!n&&c>=a&&r.updatePosition(l,c+u)}}function Yk(){return"sp"+qk()}function Kk(){return"gp"+qk()}function Xk(e,t,n){var r=e.parent;if(null==t||null==r)return null;try{var a=ql(t,{spread:r,refStyle:"A1",ref:new Oi(0,0,1,1,e)});return a&&!a.isError()&&a.isValid()&&a.isValidRefInSheet()?n&&!a.isValidBoundaryInsideSheet()?null:a:null}catch(e){return null}}var Qk,eS=function(){function e(t,n,r,a,o){if((0,y.Z)(this,e),this.sourceRange=null,this.sheet=t,this.id=a||Yk(),this.groupId=o||Kk(),n){this.position=r;var i=Xk(t,n);this.sourceRange=i}}return(0,C.Z)(e,[{key:"getId",value:function(){return this.id}},{key:"updateGroupId",value:function(e){this.groupId=e}},{key:"getGroupId",value:function(){return this.groupId}},{key:"getSourceRange",value:function(){var e;return(null===(e=this.sourceRange)||void 0===e?void 0:e.sheet())!==this.sheet?null:this.sourceRange}},{key:"getSource",value:function(){var e,t;return(null===(e=this.sourceRange)||void 0===e?void 0:e.sheet())!==this.sheet?ut.ErrorConstant.REF:(null===(t=this.sourceRange)||void 0===t?void 0:t.toString({ref:this.sourceRange}))||ut.ErrorConstant.REF}},{key:"updatePosition",value:function(e,t){void 0!==e&&(this.position={row:e,col:this.position.col}),void 0!==t&&(this.position={row:this.position.row,col:t})}},{key:"getPosition",value:function(){return this.position}},{key:"updateSource",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:this.sheet;this.sourceRange=Xk(t,e)}},{key:"toJSON",value:function(){return{id:this.id,groupId:this.groupId,source:this.getSource(),position:Object.assign({},this.position)}}}]),e}(),tS=function(){function e(){(0,y.Z)(this,e),this.sparklineGroupConfigMap=new Map,this.sparklineGroupConfigReferCountMap=new Map,this.groupIdMap=new Map}return(0,C.Z)(e,[{key:"addGroup",value:function(e,t){var n=xa(t);this.groupIdMap.set(e,n);var r=new Jk(t),a=this.sparklineGroupConfigReferCountMap.get(n)||0;return this.sparklineGroupConfigMap.has(n)?this.sparklineGroupConfigReferCountMap.set(n,a+1):(this.sparklineGroupConfigMap.set(n,r),this.sparklineGroupConfigReferCountMap.set(n,1)),r}},{key:"removeGroupById",value:function(e){if(this.groupIdMap.has(e)){var t=this.groupIdMap.get(e);this.groupIdMap.delete(e);var n=this.sparklineGroupConfigReferCountMap.get(t)||0;n>1?this.sparklineGroupConfigReferCountMap.set(t,n-1):(this.sparklineGroupConfigMap.delete(t),this.sparklineGroupConfigReferCountMap.delete(t))}}},{key:"getConfigObjById",value:function(e){var t=this.groupIdMap.get(e);return t&&this.sparklineGroupConfigMap.get(t)||null}},{key:"getRawConfigById",value:function(e){var t;return(null===(t=this.getConfigObjById(e))||void 0===t?void 0:t.getRawConfig())||null}},{key:"getConfigById",value:function(e){var t;return(null===(t=this.getConfigObjById(e))||void 0===t?void 0:t.getConfig())||null}},{key:"updateGroupConfig",value:function(e,t){if(this.groupIdMap.has(e)){var n=this.getRawConfigById(e),r=this.groupIdMap.get(e),a=this.sparklineGroupConfigReferCountMap.get(r)||0;a<=1?(this.sparklineGroupConfigReferCountMap.delete(r),this.sparklineGroupConfigMap.delete(r)):this.sparklineGroupConfigReferCountMap.set(r,a-1);var o=(0,oe.Z)((0,Re.default)(n),t);Object.keys(t).forEach((function(e){var n=t[e];null===n?delete o[e]:["extremumMax","extremumMain","axis","points"].includes(e)&&Object.keys(n).forEach((function(t){var r=n[t];null===r?delete o[e][t]:"object"==(0,_.Z)(r)&&Object.keys(r).forEach((function(n){null===r[n]&&delete o[e][t][n]}))}))}));var i=new Jk(o),u=xa(o);if(this.groupIdMap.set(e,u),this.sparklineGroupConfigMap.has(u)){var s=this.sparklineGroupConfigReferCountMap.get(u)||0;this.sparklineGroupConfigReferCountMap.set(u,s+1)}else this.sparklineGroupConfigMap.set(u,i),this.sparklineGroupConfigReferCountMap.set(u,1),this.groupIdMap.set(e,u)}}}]),e}(),nS="";!function(e){e[e.Null=0]="Null",e[e.Positive=1]="Positive",e[e.PositiveAndZero=2]="PositiveAndZero",e[e.Negative=3]="Negative",e[e.NegativeAndZero=4]="NegativeAndZero",e[e.Mix=5]="Mix"}(Qk||(Qk={}));var rS=function(){function e(t){var n=this;(0,y.Z)(this,e),this.sheet=t,this.disposerMap=new Map,this.cacheMap=new Map,this.idRangeMap=new Map,this.groupExtremumMap=new Map,this.dirtyRect=[],this.subscriber=null,this.markDirtyRect=(0,ue.default)((function(){var e,t,r,a=_n(n.dirtyRect);try{for(a.s();!(r=a.n()).done;){var o=r.value;t=t?t.union(o):o}}catch(e){a.e(e)}finally{a.f()}null!==(e=n.markDirtyCallback)&&void 0!==e&&e.call(n,t),n.dirtyRect=[]}),50,{trailing:!0}),this.depRefManager=t.parent.calcEngine.depRefManager,this.subscriber=t.subscribe({OutlineStateChanged:this.handleOutlineChange,RowVisible:this.handleRowVisibleChange,ColumnVisibleChanged:this.handleColVisibleChange})}return(0,C.Z)(e,[{key:"getSourceRangeById",value:function(e){return this.idRangeMap.get(e)}},{key:"addListener",value:function(e,t){var n,r=this;this.idRangeMap.set(e,t);var a=this.depRefManager.watchRef(t,(function(){return r.markSourceRangeDirtyById(e)}));null!==(n=this.disposerMap.get(e))&&void 0!==n&&n(),this.disposerMap.set(e,a)}},{key:"removeListener",value:function(e){var t;this.idRangeMap.delete(e),null!==(t=this.disposerMap.get(e))&&void 0!==t&&t(),this.disposerMap.delete(e)}},{key:"markSourceRangeDirtyById",value:function(e){var t=this.sheet.getSparklineById(e);if(t)if(t.getSourceRange()){var n=t.getPosition(),r=n.row,a=n.col,o=new Vt.FRect(a,r,1,1);this.dirtyRect.push(o),this.cacheMap.delete(e),this.groupExtremumMap.delete(t.getGroupId()),this.markDirtyRect()}else this.removeListener(e)}},{key:"handleOutlineChange",value:function(e){var t,n=e.range,r=_n(this.idRangeMap);try{for(r.s();!(t=r.n()).done;){var a=(0,p.Z)(t.value,2),o=a[0],i=a[1];n.isIntersect(i)&&this.markSourceRangeDirtyById(o)}}catch(e){r.e(e)}finally{r.f()}}},{key:"handleRowVisibleChange",value:function(e){var t,n=null,r=_n(e.changes);try{for(r.s();!(t=r.n()).done;){var a=t.value,o=a.row,i=a.count;n=n?n.union(new xi(o,i,this.sheet)):new xi(o,i,this.sheet)}}catch(e){r.e(e)}finally{r.f()}n&&this.handleOutlineChange({range:n})}},{key:"handleColVisibleChange",value:function(e){var t,n=null,r=_n(e);try{for(r.s();!(t=r.n()).done;){var a=t.value,o=a.col,i=a.count;n=n?n.union(new Vi(o,i,this.sheet)):new Vi(o,i,this.sheet)}}catch(e){r.e(e)}finally{r.f()}n&&this.handleOutlineChange({range:n})}},{key:"setCache",value:function(e,t){this.cacheMap.set(e,t)}},{key:"getCache",value:function(e){return this.cacheMap.get(e)}},{key:"removeCache",value:function(e,t){this.cacheMap.delete(e),this.groupExtremumMap.delete(t)}},{key:"clearCache",value:function(){this.cacheMap.clear(),this.groupExtremumMap.clear()}},{key:"getDataById",value:function(e){var t=this.sheet.getSparklineModel(),n=this.sheet.getSparklineById(e);if(!n)return null;var r=n.getGroupId(),a=t.getSparklineGroupByGroupId(r);if(!a)return null;var o=this.createSourceDataCache(e,a);if(!o)return null;var i=a.getExtremumMax().type,u=a.getExtremumMin().type,s={data:o.data,selfExtremum:[o.min||0,o.max||0],extremum:[o.min||0,o.max||0],valueType:o.valueType};if(i===we.yre.group){var l,c,h=(null===(l=this.groupExtremumMap.get(r))||void 0===l?void 0:l.max)||(null===(c=this.createGroupExtremumCache(r,a))||void 0===c?void 0:c.max);if(void 0===h)return null;s.extremum[1]=h}if(u===we.yre.group){var f,d,v=(null===(f=this.groupExtremumMap.get(r))||void 0===f?void 0:f.min)||(null===(d=this.createGroupExtremumCache(r,a))||void 0===d?void 0:d.min);if(void 0===v)return null;s.extremum[0]=v}return s}},{key:"createGroupExtremumCache",value:function(e,t){if(this.groupExtremumMap.has(e))return this.groupExtremumMap.get(e);var n,r,a,o=_n(this.sheet.getSparklinesByGroupId(e));try{for(o.s();!(a=o.n()).done;){var i=a.value,u=this.createSourceDataCache(i.getId(),t);void 0!==(null==u?void 0:u.max)&&(n=void 0===n?u.max:Math.max(u.max,n)),void 0!==(null==u?void 0:u.min)&&(r=void 0===r?u.min:Math.min(u.min,r))}}catch(e){o.e(e)}finally{o.f()}if(void 0!==n&&void 0!==r){var s={max:n,min:r};return this.groupExtremumMap.set(e,s),s}return null}},{key:"createSourceDataCache",value:function(e,t){if(this.cacheMap.has(e))return this.cacheMap.get(e);var n=this.idRangeMap.get(e);if(!n)return null;var r=this._getRawData(n),a=this._processRawData(r,t);return this.setCache(e,a),a}},{key:"_getRawData",value:function(e){for(var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1e4,n=this.sheet,r=n.getHiddenRows(),a=n.getHiddenCols(),o=n.filterModel.getAllFilteredOutRowsArray(),i=e.toJSON(),u=i.row,s=i.col,l=i.rowCount,c=i.colCount,h=[],f=0,d=0;d<l;d++)for(var v=0;v<c;v++){f++;var g=u+d,m=s+v,p=n.getValue(g,m);if(h.push({value:p,isFiltered:o.includes(g),isHidden:!(!r[g]&&!a[m])}),f>=t)return h}return h}},{key:"_processRawData",value:function(e,t){for(var n,r,a=t.getEmptyShowAs(),o=t.getNonNumShowAs(),i=t.getContainHiddenCells(),u=!!t.getAxisConfig().reverse,s=[],l=function(e){switch(e){case we.v5m.Link:return nS;case we.v5m.Zero:return 0;case we.v5m.Space:default:return}},c=Qk.Null,h=function(e){n=void 0===n?e:Math.max(e,n),r=void 0===r?e:Math.min(e,r),0===e?c===Qk.Negative?c=Qk.NegativeAndZero:c===Qk.Positive&&(c=Qk.PositiveAndZero):c===Qk.Null?c=e>0?Qk.Positive:Qk.Negative:(e>0&&[Qk.Negative,Qk.NegativeAndZero].includes(c)||e<0&&[Qk.Positive,Qk.PositiveAndZero].includes(c))&&(c=Qk.Mix)},f=function(e){return"string"==typeof e&&""===e.trim()},d=0;d<e.length;d++){var v=e[d],g=v.value,m=v.isFiltered,p=v.isHidden;if(i||!m&&!p)if((0,ae.Z)(g))s.push(l(a)),a===we.v5m.Zero&&h(0);else if(f(g)||Number.isNaN(Number(g)))s.push(l(o)),o===we.v5m.Zero&&h(0);else{var y=Number(g);s.push(y),h(y)}}return u&&s.reverse(),{data:s,min:r,max:n,valueType:c}}},{key:"dispose",value:function(){var e;this.disposerMap.forEach((function(e){return e()})),this.disposerMap.clear(),this.cacheMap.clear(),this.idRangeMap.clear(),this.groupExtremumMap.clear(),null!==(e=this.subscriber)&&void 0!==e&&e.unsubscribe(),this.markDirtyRect.cancel(),delete this.sheet,delete this.sheetFormulaService,delete this.markDirtyCallback,delete this.subscriber,delete this.dirtyRect,delete this.disposerMap,delete this.cacheMap,delete this.idRangeMap,delete this.groupExtremumMap}}]),e}();Gi([(0,Nt.Bind)()],rS.prototype,"handleOutlineChange",null),Gi([(0,Nt.Bind)()],rS.prototype,"handleRowVisibleChange",null),Gi([(0,Nt.Bind)()],rS.prototype,"handleColVisibleChange",null);var aS=function(e){function t(e){var n;return(0,y.Z)(this,t),(n=(0,d.Z)(this,(0,v.Z)(t).call(this))).sparklines=new Map,n.sparklinesGroupMap=new Map,n.groupMgr=new tS,n.sheet=e,n.dataMgr=new rS(e),n}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"addGroupById",value:function(e,t){this.groupMgr.addGroup(e,t),this.sparklinesGroupMap.set(e,new Set)}},{key:"deleteGroupById",value:function(e){var t,n,r=this;this.groupMgr.removeGroupById(e),null!==(t=this.sparklinesGroupMap.get(e))&&void 0!==t&&null!==(n=t.forEach)&&void 0!==n&&n.call(t,(function(e){r.deleteSparklineById(e)})),this.sparklinesGroupMap.delete(e)}},{key:"deleteGroupInSparklineModel",value:function(e){var t,n,r=this;this.groupMgr.removeGroupById(e),null!==(t=this.sparklinesGroupMap.get(e))&&void 0!==t&&null!==(n=t.forEach)&&void 0!==n&&n.call(t,(function(e){r.deleteSparklineInSparklineModel(e)})),this.sparklinesGroupMap.delete(e)}},{key:"getSparklineGroupByGroupId",value:function(e){return this.groupMgr.getConfigObjById(e)}},{key:"getSparklineGroupBySparklineId",value:function(e){var t=this.sparklines.get(e);if(t){var n=t.getGroupId();return this.getSparklineGroupByGroupId(n)||null}return null}},{key:"createSparkline",value:function(e,t,n,r){var a=new eS(this.sheet,e,t,n,r);return this.addSparklineById(a.getId(),a),a}},{key:"addSparklineById",value:function(e,t){var n=t.getPosition(),r=n.row,a=n.col;this.sparklines.set(e,t),this.set(r,a,t);var o=t.getGroupId();if(this.sparklinesGroupMap.has(o))this.sparklinesGroupMap.get(o).add(e);else{var i=new Set;i.add(e),this.sparklinesGroupMap.set(o,i)}}},{key:"set",value:function(e,n,r){(0,f.Z)((0,v.Z)(t.prototype),"set",this).call(this,e,n,r);var a=r.getSourceRange();a&&this.dataMgr.addListener(r.getId(),a),this.sheet.dispatch("SparklineAdd",{id:r.getId(),sheetId:this.sheet.id()})}},{key:"delete",value:function(e,n,r){r.getSourceRange()&&this.dataMgr.removeListener(r.getId()),(0,f.Z)((0,v.Z)(t.prototype),"get",this).call(this,e,n)===r&&(0,f.Z)((0,v.Z)(t.prototype),"set",this).call(this,e,n,null),this.sheet.dispatch("SparklineDelete",{id:r.getId(),sheetId:this.sheet.id(),cell:{row:e,col:n},groupId:r.getGroupId()})}},{key:"setSparklineById",value:function(e,t,n,r){var a=this.sparklines.get(e);if(a){var o=null==a?void 0:a.getGroupId();if(t&&t!==o){var i,u,s=this.sparklinesGroupMap.get(o);null!=s&&s.delete(e),!(null!=s&&s.size)&&this.deleteGroupById(o),a.updateGroupId(t),null!==(i=this.sparklinesGroupMap.get(t))&&void 0!==i&&null!==(u=i.add)&&void 0!==u&&u.call(i,e),this.sheet.dispatch("SparklineGroupConfigChanged",{groupId:t,sheetId:this.sheet.id()})}if(n){var l=a.getPosition();this.delete(l.row,l.col,a),a.updatePosition(n.row,n.col),this.set(n.row,n.col,a)}if(r){var c=a.getGroupId(),h=a.getPosition(),f=h.row,d=h.col;this.delete(f,d,a),this.createSparkline(r,{row:f,col:d},e,c),this.sheet.dispatch("SparklineGroupConfigChanged",{groupId:c,sheetId:this.sheet.id()})}}}},{key:"getSparklineById",value:function(e){return this.sparklines.get(e)||null}},{key:"getSparklineByPosition",value:function(e,t){return(0,m.Z)(this.sparklines.values()).find((function(n){var r=n.getPosition(),a=r.row,o=r.col;return a===e&&o===t}))||null}},{key:"getSparklineGroupIdByCell",value:function(e,t){var n=this.getSparklineByCell(e,t);return n?n.getGroupId():null}},{key:"getSparklineByCell",value:function(e,t){return this.get(e,t)}},{key:"setSparklineByCell",value:function(e,t,n){n.updatePosition(e,t),this.addSparklineById(n.getId(),n)}},{key:"deleteSparklineByCell",value:function(e,t){var n=this.getSparklineByCell(e,t);n&&this.deleteSparklineById(n.getId())}},{key:"deleteSparklineById",value:function(e){var t=this.sparklines.get(e);if(t){var n=t.getPosition(),r=n.row,a=n.col;this.delete(r,a,t),this.deleteSparklineInSparklineModel(e);var o,i=t.getGroupId();if(i)(null===(o=this.sparklinesGroupMap.get(i))||void 0===o||!o.size)&&this.deleteGroupById(i)}}},{key:"deleteSparklineInSparklineModel",value:function(e){var t,n,r,a,o=this.sparklines.get(e);o&&(this.sparklines.delete(e),r=null==o?void 0:o.getGroupId(),null!==(t=this.sparklinesGroupMap.get(r))&&void 0!==t&&null!==(n=t.delete)&&void 0!==n&&n.call(t,e),r&&(null===(a=this.sparklinesGroupMap.get(r))||void 0===a||!a.size)&&this.deleteGroupInSparklineModel(r))}},{key:"getSparklinesByGroupId",value:function(e){var t=this,n=this.sparklinesGroupMap.get(e),r=[];return null!=n&&n.forEach((function(e){t.sparklines.has(e)&&r.push(t.sparklines.get(e))})),r}},{key:"getSparklineRawConfig",value:function(e){return this.groupMgr.getRawConfigById(e)}},{key:"getSparklineConfig",value:function(e){return this.groupMgr.getConfigById(e)}},{key:"addRow",value:function(e,n,r){this.addRowCol(e,n),(0,f.Z)((0,v.Z)(t.prototype),"addRow",this).call(this,e,n,r)}},{key:"addCol",value:function(e,n){this.addRowCol(e,n,!1),(0,f.Z)((0,v.Z)(t.prototype),"addCol",this).call(this,e,n)}},{key:"addRowCol",value:function(e,t){var n,r,a,o,i=!(arguments.length>2&&void 0!==arguments[2])||arguments[2];i?(n=e,a=this.sheet.getRowCount()-e,r=0,o=this.sheet.getColumnCount()):(n=0,a=this.sheet.getRowCount(),r=e,o=this.sheet.getColumnCount()-e);var u=$k(this,!0,i);this.iter(n,r,a,o).forEach((function(n){u(n,e,t)}))}},{key:"delRow",value:function(e,n,r){this.removeRowCol(e,n),(0,f.Z)((0,v.Z)(t.prototype),"delRow",this).call(this,e,n,r),this.sheet.dispatch("SparklineDelRowCol",{sheetId:this.sheet.id()})}},{key:"delCol",value:function(e,n){this.removeRowCol(e,n,!1),(0,f.Z)((0,v.Z)(t.prototype),"delCol",this).call(this,e,n),this.sheet.dispatch("SparklineDelRowCol",{sheetId:this.sheet.id()})}},{key:"swapRow",value:function(e,n){this.iter(e,0,1,this.sheet.getColumnCount()).forEach((function(e){e.updatePosition(n)})),(0,f.Z)((0,v.Z)(t.prototype),"swapRow",this).call(this,e,n)}},{key:"swapCol",value:function(e,n){this.iter(0,e,this.sheet.getRowCount(),1).forEach((function(e){e.updatePosition(void 0,n)})),(0,f.Z)((0,v.Z)(t.prototype),"swapCol",this).call(this,e,n)}},{key:"swapCell",value:function(e,n,r,a){var o=this.get(e,n);o&&o.updatePosition(r,a);var i=this.get(r,a);i&&i.updatePosition(e,n),(0,f.Z)((0,v.Z)(t.prototype),"swapCell",this).call(this,e,n,r,a)}},{key:"removeRowCol",value:function(e,t){var n,r,a,o,i=this,u=!(arguments.length>2&&void 0!==arguments[2])||arguments[2],s=$k(this,!1,u);u?(n=e,a=this.sheet.getRowCount()+t-e,r=0,o=this.sheet.getColumnCount()):(n=0,a=this.sheet.getRowCount(),r=e,o=this.sheet.getColumnCount()+t-e),this.iterWithPos(n,r,a,o).forEach((function(n){var r=(0,p.Z)(n,2),a=r[0],o=r[1],l=u?o.row:o.col;e<=l&&l<e+t?i.deleteSparklineById(a.getId()):s(a,e,t)}))}},{key:"updateGroupConfig",value:function(e,t){this.groupMgr.updateGroupConfig(e,t),this.sheet.dispatch("SparklineGroupConfigChanged",{groupId:e,sheetId:this.sheet.id()})}},{key:"fromJSON",value:function(e){for(var t=0,n=Object.entries(e);t<n.length;t++){var r=(0,p.Z)(n[t],2),a=r[0],o=r[1],i=o.sparklines,u=void 0===i?{}:i,s=o.config,l=void 0===s?{}:s;this.addGroupById(a,l);for(var c=0,h=Object.entries(u);c<h.length;c++){var f=(0,p.Z)(h[c],2),d=f[0],v=f[1],g=this.createSparkline(v.source,v.position,d,a);this.addSparklineById(g.getId(),g)}}}},{key:"toJSON",value:function(){var e,t=this,n={},r=_n(this.sparklinesGroupMap);try{var a=function(){var r=(0,p.Z)(e.value,2),a=r[0],o=r[1],i={};n[a]=i;var u=t.getSparklineRawConfig(a);u&&(i.config=u),o.forEach((function(e){var n=t.sparklines.get(e),r=n.getSource(),a=n.getPosition();i.sparklines?i.sparklines[e]={source:r,position:a}:i.sparklines=(0,l.Z)({},e,{source:r,position:a})}))};for(r.s();!(e=r.n()).done;)a()}catch(e){r.e(e)}finally{r.f()}return n}},{key:"getGroupConfigJSON",value:function(e){var t=this.getSparklineRawConfig(e),n=this.getSparklinesByGroupId(e).reduce((function(e,t){return e[t.getId()]={source:t.getSource(),position:t.getPosition()},e}),{})||{};return t?{config:t,sparklines:n}:{sparklines:n}}},{key:"getDataManager",value:function(){return this.dataMgr}},{key:"getExporter",value:function(e,t,n,r){return new oS(this,this.sheet,e,t,n,r)}},{key:"getImporter",value:function(){return new iS(this)}},{key:"getSparklinesGroupMap",value:function(){return this.sparklinesGroupMap}}]),t}(Kv),oS=function(e){function t(e,n,r,a,o,i){var u;return(0,y.Z)(this,t),(u=(0,d.Z)(this,(0,v.Z)(t).call(this,e.iter(r,a,o,i)))).block=e,u.sheet=n,u}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"exportToCell",value:function(){}},{key:"exportExtraInfo",value:function(e){this.block.isEmpty()||(e.sparklineGroup=this.block.toJSON())}}]),t}(Um),iS=function(){function e(t){(0,y.Z)(this,e),this.block=t}return(0,C.Z)(e,[{key:"importCell",value:function(){}},{key:"importExtraInfo",value:function(e){e.sparklineGroup&&this.block.fromJSON(e.sparklineGroup)}}]),e}(),uS=function(e){function t(e,n){var r;return(0,y.Z)(this,t),(r=(0,d.Z)(this,(0,v.Z)(t).call(this))).sheet=e,r.contentModel=n,r}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"getCellNoteJSON",value:function(e,t){var n=this.get(e,t);if(null!=n&&n.value){var r=this.segmentToJSON(n.value);return Object.assign({},n,{value:r})}return n}},{key:"setNoteFromJSON",value:function(e,t,n){if(n){var r=this.segmentFromJSON(n.value);this.set(e,t,Object.assign({},n,{value:r}))}else this.set(e,t,n)}},{key:"getExporter",value:function(e,t,n,r){return new sS(this,e,t,n,r)}},{key:"getImporter",value:function(){return new lS(this)}},{key:"segmentFromJSON",value:function(e){var t=this;return e.map((function(e){return(e=Object.assign({},e)).style&&(e.style instanceof Ad||(e.style=Ad.fromJSON(t.sheet.parent.formatterService,e.style))),e}))}},{key:"segmentToJSON",value:function(e){return e.map((function(e){return(e=Object.assign({},e)).style&&e.style instanceof Ad&&(e.style=e.style.toJSON()),e}))}}]),t}(Kv),sS=function(e){function t(e,n,r,a,o){var i;return(0,y.Z)(this,t),(i=(0,d.Z)(this,(0,v.Z)(t).call(this,e.iter(n,r,a,o)))).block=e,i.rowFrom=n,i.colFrom=r,i.rowCount=a,i.colCount=o,i}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"exportToCell",value:function(e,t){if(e&&null!=t&&t.value&&!Zg(t)){var n=this.block.segmentToJSON(t.value);e.note=Object.assign({},t,{value:n})}}},{key:"serializeCell",value:function(e,t,n){if(t.value){var r={w:t.width,h:t.height};e.noteId=n.cellValueRefHelper.notes.add(Object.assign({frameSize:r},this.getRefValue(n,t))).id}}},{key:"getRefValue",value:function(e,t){var n=t.value;return this.getRichStringValue(e,n)}},{key:"getRichStringValue",value:function(e,t){var n=this.block.contentModel.getExporter(this.rowFrom,this.colFrom,this.rowCount,this.colCount).serializeSegmentArray(t,e),r=e.cellValueRefHelper.richStrings.add(n);return{valueType:we.B2l.NoteValueType.NoteValueType_RichString,valueId:r.id}}}]),t}(Um),lS=function(){function e(t){(0,y.Z)(this,e),this.block=t}return(0,C.Z)(e,[{key:"importCell",value:function(e,t,n,r){var a=n.note;if(null!=a&&a.value){var o=this.block.segmentFromJSON(a.value);this.block.set(e,t,Object.assign({},a,{value:o}))}}},{key:"importExtraInfo",value:function(){}}]),e}(),cS=la.isEmptyObject,hS=vr._Types._isNullOrUndefined,fS={refType:1};function dS(e){return e.rowCount}function vS(e){return e.colCount}function gS(e){return!!e&&e instanceof jf}var mS=function(){function e(t,n,r,a){(0,y.Z)(this,e),this._dirtySuspended=0,this.rowCount=t,this.colCount=n,this.name=a,this._defaultDataNode=null,this._dirtySuspended=0,this._sheet=r,this.contentModel=new dy(this._sheet),this.styleDropdownModel=new ip(this._sheet),this.composedStyleCache=new Xw,this.dataValidationModel=new Xm(this._sheet),this.commentModel=new my(this._sheet),this.noteModel=new uS(this._sheet,this.contentModel),this.extralModel=new Kv,this.reminderModel=new Vy(this._sheet),this.conditionalFormatStyleModel=new Nk,this.sparklineModel=new aS(this._sheet),this.composer=new tg,this.composer.addModel(this.contentModel).addModel(this.dataValidationModel).addModel(this.styleDropdownModel).addModel(this.composedStyleCache).addModel(this.commentModel).addModel(this.noteModel).addModel(this.extralModel).addModel(this.reminderModel).addModel(this.sparklineModel).addModel(this.conditionalFormatStyleModel),this.importer=this.composer.getImporter(),this.stringVarRefMap=new Zk}return(0,C.Z)(e,[{key:"addModels",value:function(e){var t=this;return e.forEach((function(e){return t.composer.addModel(e)})),this}},{key:"removeModels",value:function(e){return this.composer.removeModels(e),this}},{key:"sheet",value:function(){return this._sheet}},{key:"getRowCount",value:function(){return this.rowCount}},{key:"getColumnCount",value:function(){return this.colCount}},{key:"setDefaultNodeData",value:function(e){this._defaultDataNode=e}},{key:"setRowCount",value:function(e){this.rowCount=e}},{key:"setColumnCount",value:function(e){this.colCount=e}},{key:"getSegmentArray",value:function(e,t,n){return this.contentModel.getSegmentArray(e,t,n)}},{key:"getImmutableSegmentArray",value:function(e,t,n){return this.contentModel.getImmutableSegmentArray(e,t,n)}},{key:"getMultipleValues",value:function(e,t){return this.contentModel.getMultipleValues(e,t)}},{key:"getFormula",value:function(e,t,n,r){var a,o=null===(a=this.getImmutableContent(e,t,r))||void 0===a?void 0:a.formulaVar;return null!=o?Rf(o,n||{ref:o.getRef()}):""}},{key:"getFormulaData",value:function(e,t,n,r,a){var o,i=null===(o=this.getImmutableContent(e,t,r))||void 0===o?void 0:o.formulaVar;if(i)return wf(i,n||{ref:i.getRef()},a?fS:void 0)}},{key:"setVar",value:function(e,t,n,r){var a,o=arguments.length>4&&void 0!==arguments[4]?arguments[4]:this.getImmutableContent(e,t);if(e<0||t<0||e>=this.rowCount||t>=this.colCount)this._sheet.parent.logger.warn("setVar outside, pos ".concat(e,",").concat(t,", sheet ").concat(this._sheet._id_,",").concat(this.rowCount,",").concat(this.colCount));else{var i,u;if(void 0===n&&(n=null),n&&"object"==(0,_.Z)(n)&&n._calcError&&(n=ut.ERROR_VAR_MAP[n._calcError]||n._calcError),!(n instanceof ut.BaseVar)&&null!==n)r&&(i=r.ctx,u=r.skipCompile),n=Pg(this._sheet,e,t,n,{skipFormulaCompile:u,formulaCompileCtx:i,stringVarRefMap:this.stringVarRefMap});var s=this._sheet.getCalcEngine().formulaSpace,l=this.getImmutableContent(e,t,!0),c=null;if(this.stringVarRefMap&&null!=l&&null!==(a=l.variant)&&void 0!==a&&a.isString()&&this.stringVarRefMap.del(l.variant.getValue()),hy(l,s),!n||(c=fy(this._sheet,e,t,n,l,s))){var h={variant:c,segmentArray:(null==o?void 0:o.segmentArray)||null,multipleValues:(null==o?void 0:o.multipleValues)||null};this.contentModel.setNodeValue(e,t,h)}}}},{key:"setSegmentArray",value:function(e,t,n){var r,a=arguments.length>3&&void 0!==arguments[3]?arguments[3]:this.getImmutableContent(e,t);if(!(e<0||e>=this.rowCount||t<0||t>=this.colCount)){var o={segmentArray:n,multipleValues:(null==a?void 0:a.multipleValues)||null,variant:(null==a?void 0:a.variant)||null};if(!n||0===n.length)return this.contentModel.setNodeValue(e,t,o),void this.composedStyleCache.setRef(e,t,null);var i=new xv(this._sheet.parent,n);o.segmentArray=i.getSegmentArray();var u=i.getVar(this._sheet.parent.userLanguage),s=null===(r=u.getSpecialInfo())||void 0===r?void 0:r.link,l=u.isCustomPrimitive()&&"SheetImageVar"===u.customType;s||l?(o.variant=u,this.setVar(e,t,u,{skipCompile:!0},o)):this.setVar(e,t,i.getText(this._sheet.parent.userLanguage),{skipCompile:!0},o),this.composedStyleCache.setRef(e,t,null)}}},{key:"setMultipleValues",value:function(e,t,n){var r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:this.getImmutableContent(e,t);if(!(e<0||e>=this.rowCount||t<0||t>=this.colCount)){var a={multipleValues:n,segmentArray:(null==r?void 0:r.segmentArray)||null,variant:(null==r?void 0:r.variant)||null};if(!n||0===n.length)return hy(this.getImmutableContent(e,t),this._sheet.getCalcEngine().formulaSpace),void this.contentModel.setNodeValue(e,t,a);var o=this._sheet.getUserFormatter(e,t)||null,i=n.mergeToSingleValue({formatter:o}),u=i.segmentArray,s=i.variant;u?this.setSegmentArray(e,t,u,a):s?this.setVar(e,t,s,{skipCompile:!0},a):this.contentModel.setNodeValue(e,t,a)}}},{key:"setVariant",value:function(e,t,n,r){e<0||e>=this.rowCount||t<0||t>=this.colCount||this.contentModel.setVariant(e,t,n,r)}},{key:"setNodeValue",value:function(e,t,n){this.contentModel.setNodeValue(e,t,n)}},{key:"getImmutableContent",value:function(e,t,n){return this.contentModel.getImmutableNode(e,t,n)}},{key:"setConditionalFormatStyle",value:function(e,t,n){return this.conditionalFormatStyleModel.set(e,t,n)}},{key:"getConditionalFormatStyle",value:function(e,t){return this.conditionalFormatStyleModel.get(e,t)}},{key:"clearConditionalFormatStyle",value:function(e,t,n,r){return this.conditionalFormatStyleModel.clear(e,t,n,r)}},{key:"getDefaultStyle",value:function(){return this.styleDropdownModel.getDefaultStyle()}},{key:"setDefaultStyle",value:function(e){return this.styleDropdownModel.setDefaultStyle(e)}},{key:"getStyle",value:function(e,t,n){if(-1===e&&-1===t)return this.getDefaultStyle();if(-1===e&&t>=0)return null;if(e>=0&&-1===t)return null;var r=this.composedStyleCache.getRef(e,t);if(!n&&r)return r;var a=this._sheet.getPivotTableManager(),o=a.hasPivotTableAtCell(e,t),i=this.styleDropdownModel.getStyle(e,t),u=this.getSegmentArray(e,t);if(!n&&o)return a.composePivotStyle(i,e,t);if(Array.isArray(u)&&u.length&&yp(u)){var s=mp(u,i,this._sheet).style;return this.composedStyleCache.setRef(e,t,s),s}return this.composedStyleCache.setRef(e,t,i),i}},{key:"getCellStyle",value:function(e,t,n){if(-1===e&&-1===t)return this.getDefaultStyle();if(-1===e&&t>=0)return null;if(e>=0&&-1===t)return null;var r=this._sheet.getPivotTableManager(),a=r.hasPivotTableAtCell(e,t),o=this.styleDropdownModel.getStyle(e,t);return!n&&a?r.composePivotStyle(o,e,t):o}},{key:"getStyleWithoutPartialStyle",value:function(e,t){return this.styleDropdownModel.getStyle(e,t)}},{key:"setStyle",value:function(e,t,n){if(-1===e&&-1===t)this.styleDropdownModel.setDefaultStyle(n);else{if(-1===e&&t>=0)return;if(e>=0&&-1===t)return;e>=0&&e<this.rowCount&&t>=0&&t<this.colCount&&this.styleDropdownModel.setStyle(e,t,n)}this.composedStyleCache.setRef(e,t,null)}},{key:"setStyleById",value:function(e,t,n){e<0||e>=this.rowCount||t<0||t>=this.colCount||(this.styleDropdownModel.setStyleById(e,t,n),this.composedStyleCache.setRef(e,t,null))}},{key:"setDataValidationById",value:function(e,t,n){e<0||e>=this.rowCount||t<0||t>=this.colCount||this.dataValidationModel.setById(e,t,n,!0)}},{key:"resetStyle",value:function(e,t){e<0||e>=this.rowCount||t<0||t>=this.colCount||(this.styleDropdownModel.setStyle(e,t,null),this.composedStyleCache.setRef(e,t,null))}},{key:"isEmpytComment",value:function(){return this.commentModel.isEmpty()}},{key:"getComment",value:function(e,t){return this.commentModel.get(e,t)}},{key:"setComment",value:function(e,t,n){this.commentModel.set(e,t,n)}},{key:"getCellNoteJSON",value:function(e,t){return this.noteModel.getCellNoteJSON(e,t)}},{key:"getCellNote",value:function(e,t){return this.noteModel.get(e,t)}},{key:"setCellNote",value:function(e,t,n){return this.noteModel.setNoteFromJSON(e,t,n)}},{key:"clearCellNote",value:function(e,t,n,r){return this.noteModel.clear(e,t,n,r)}},{key:"isEmpytDropdown",value:function(){return this.styleDropdownModel.isEmpty()}},{key:"getDataValidationId",value:function(e,t,n){var r=this._sheet.getPivotTableManager();return!n&&r.hasPivotTableAtCell(e,t)?null:this.dataValidationModel.get(e,t)}},{key:"getDataValidation",value:function(e,t,n){var r=this._sheet.getPivotTableManager();return!n&&r.hasPivotTableAtCell(e,t)?null:this.dataValidationModel.getRef(e,t)}},{key:"setDataValidation",value:function(e,t,n){e<0||e>=this.rowCount||t<0||t>=this.colCount||this.dataValidationModel.setRef(e,t,n)}},{key:"getValidationRefCount",value:function(){return this.dataValidationModel.getRefMgr().getRefCount()}},{key:"eachValidationRef",value:function(e){this.dataValidationModel.getRefMgr().foreach(e)}},{key:"getDropdown",value:function(e,t,n){var r=this._sheet.getPivotTableManager();return!n&&r.hasPivotTableAtCell(e,t)?null:this.styleDropdownModel.getDropdown(e,t)}},{key:"getStyleDropdownModel",value:function(){return this.styleDropdownModel}},{key:"getDataValidationModel",value:function(){return this.dataValidationModel}},{key:"setDropdown",value:function(e,t,n){if(!(e<0||e>=this.rowCount||t<0||t>=this.colCount))return null==n?this.styleDropdownModel.setDropdown(e,t,null):this.styleDropdownModel.setDropdown(e,t,n)}},{key:"removeDropdown",value:function(e,t){if(!(e<0||e>=this.rowCount||t<0||t>=this.colCount))return this.styleDropdownModel.setDropdown(e,t,null)}},{key:"findSameDataValidation",value:function(e){return this.dataValidationModel.getRefMgr().findSameRefs(e)}},{key:"updateReference",value:function(e,t,n){var r=_S(e,t,this._sheet);if(null!==r){if("dataValidation"===e)return this.updateReferenceCore(this.dataValidationModel.getRefMgr(),r,n,e);throw Error("[SHEET ERROR] Don't support ref model type: "+e)}}},{key:"updateReferenceCore",value:function(e,t,n,r){var a=e.findSameRefs(t),o=a.map((function(t){return e.getIdByRef(t)})).filter((function(e){return null!=e})),i=[];if("dataValidation"===r){var u=new Oi(0,0,this._sheet.getRowCount(),this._sheet.getColumnCount(),this._sheet),s=new Set(a);i=pm.findRanges(s,this._sheet,{iterVisible:!1,range:u})}for(var l=0;l<o.length;l++){var c=_S(r,n,this._sheet);if(null===c)throw Error("[SHEET ERROR]  Can't instantiate a invalid new ref");e.addById(o[l],c,!1)}return i}},{key:"iterContent",value:function(e,t,n,r,a){return!a&&pk(this._sheet,e,t,n,r)?new RS(this._sheet,this.contentModel,e,t,e+n-1,t+r-1):this.contentModel.iter(e,t,n,r)}},{key:"iterContentWithPos",value:function(e,t,n,r,a){if(!a&&pk(this._sheet,e,t,n,r)){var o=new RS(this._sheet,this.contentModel,e,t,e+n-1,t+r-1);return o.map((function(e){return[e,o.position()]}))}return this.contentModel.iterWithPos(e,t,n,r)}},{key:"iterStyle",value:function(e,t,n,r){return pk(this._sheet,e,t,n,r)?new wS(this._sheet,this.styleDropdownModel,e,t,e+n-1,t+r-1):this.styleDropdownModel.iterStyle(e,t,n,r)}},{key:"iterStyleWithPos",value:function(e,t,n,r){if(pk(this._sheet,e,t,n,r)){var a=new wS(this._sheet,this.styleDropdownModel,e,t,e+n-1,t+r-1);return a.map((function(e){return[e,a.position()]}))}return this.styleDropdownModel.iterStyleWithPos(e,t,n,r)}},{key:"iterDropdown",value:function(e,t,n,r){return this.styleDropdownModel.iterDropdown(e,t,n,r)}},{key:"iterDropdownWithPos",value:function(e,t,n,r){return this.styleDropdownModel.iterDropdownWithPos(e,t,n,r)}},{key:"iterComment",value:function(e,t,n,r){return this.commentModel.iter(e,t,n,r)}},{key:"iterCommentWithPos",value:function(e,t,n,r){return this.commentModel.iterWithPos(e,t,n,r)}},{key:"iterNote",value:function(e,t,n,r){return this.noteModel.iter(e,t,n,r)}},{key:"iterNoteWithPos",value:function(e,t,n,r){return this.noteModel.iterWithPos(e,t,n,r)}},{key:"iterReminder",value:function(e,t,n,r){return this.reminderModel.iter(e,t,n,r)}},{key:"iterReminderWithPos",value:function(e,t,n,r){return this.reminderModel.iterWithPos(e,t,n,r)}},{key:"iterDataValidation",value:function(e,t,n,r){return this.dataValidationModel.iterRef(e,t,n,r)}},{key:"iterDataValidationWithPos",value:function(e,t,n,r){return this.dataValidationModel.iterRefWithPos(e,t,n,r)}},{key:"iterSegmentArrayWithPos",value:function(e,t,n,r){return this.contentModel.iterWithPos(e,t,n,r).filter((function(e){var t=(0,p.Z)(e,2),n=t[0];t[1];return null!==n.segmentArray}))}},{key:"iterSparklineWithPos",value:function(e,t,n,r){return this.sparklineModel.iterWithPos(e,t,n,r)}},{key:"getSparklineGroupByGroupId",value:function(e){return this.sparklineModel.getSparklineGroupByGroupId(e)}},{key:"getSparklineGroupBySparklineId",value:function(e){return this.sparklineModel.getSparklineGroupBySparklineId(e)}},{key:"getSparklineConfigByGroupId",value:function(e,t){return t?this.sparklineModel.getSparklineConfig(e):this.sparklineModel.getSparklineRawConfig(e)}},{key:"getSparklineById",value:function(e){return this.sparklineModel.getSparklineById(e)}},{key:"getSparklinesByGroupId",value:function(e){return this.sparklineModel.getSparklinesByGroupId(e)}},{key:"getSparklineByCell",value:function(e,t){return this.sparklineModel.getSparklineByCell(e,t)}},{key:"getComposer",value:function(){return this.composer}},{key:"getExtralValue",value:function(e,t,n){var r=this.extralModel.get(e,t);return r&&r[n]}},{key:"setExtralValue",value:function(e,t,n,r){var a=this.extralModel.get(e,t)||{};a&&a[n]!==r&&(a[n]=r),this.extralModel.set(e,t,a)}},{key:"clearExtralValue",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1,r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:1;this.extralModel.clear(e,t,n,r)}},{key:"hasContent",value:function(e,t){var n=this.getImmutableContent(e,t);return!(!n||(!n.variant||n.variant.isNull())&&!(n.segmentArray&&n.segmentArray.length>0)&&!(n.multipleValues&&n.multipleValues.length>0))}},{key:"hasMultipleValues",value:function(e,t){var n=this.getImmutableContent(e,t);return!!n&&null!=n.multipleValues}},{key:"getVar",value:function(e,t,n){return this.getVarByContent(this.getImmutableContent(e,t,n),e,t,n)}},{key:"getVarByContent",value:function(e,t,n,r){var a=this._sheet.getPivotTableManager(),o=a.getPivotTableNameByCell(t,n);if(r||!o)return e?e.multipleValues?this.getVarByMultipleValue(e,t,n):this.getVarBySingleValue(e):ut.NULL_VAR;var i=a.getCellValue(t,n),u=this._sheet.getCalcEngine().pivotCalculateEngine.getFormula(o),s=Lg(i)||ut.NULL_VAR;return new Ha(t,n,s,o,u)}},{key:"getVarByMultipleValue",value:function(e,t,n){if(e.multipleValues.length>1){var r=this._sheet.getUserFormatter(t,n)||null,a=e.multipleValues.mergeToString({formatter:r});return a&&""!==a?new ut.StringVar(a):ut.NULL_VAR}var o=e.multipleValues.getFirstItem();return this.getVarBySingleValue(o)}},{key:"getVarBySingleValue",value:function(e){return e.variant?e.variant:e.segmentArray?new xv(this._sheet.parent,e.segmentArray).getVar(this._sheet.parent.userLanguage):ut.NULL_VAR}},{key:"removeComposedStyleCache",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1,r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:1;this.composedStyleCache.clear(e,t,n,r)}},{key:"getValue",value:function(e,t,n,r){var a=this.getVar(e,t,r);return a?(gS(a)&&(a.getValue(n),a.isInCorrectPosition(e,t)||(this.setVar(e,t,null),a=ut.NULL_VAR)),a.getValue(n)):null}},{key:"isArrayFormula",value:function(e,t){var n=this.getImmutableContent(e,t);return null!=n&&function(e){return!!e&&e instanceof Bf}(n.variant)}},{key:"isProxyArrayFormula",value:function(e,t,n){var r=this.getImmutableContent(e,t,n);return null!=r&&gS(r.variant)}},{key:"addRows",value:function(e,t){var n=this,r=dS(n);0<=e&&e<=r&&t>=0&&(n.rowCount+=t,this.composer.addRow(e,t,n.rowCount))}},{key:"deleteRows",value:function(e,t){var n=dS(this);0<=e&&e<n&&t>0&&(e+t>n&&(t=n-e),this.rowCount-=t,this.composer.delRow(e,t,this.rowCount))}},{key:"addColumns",value:function(e,t){var n=vS(this);0<=e&&e<=n&&t>=0&&(this.colCount+=t),this.composer.addCol(e,t)}},{key:"deleteColumns",value:function(e,t){var n=vS(this);0<=e&&e<n&&t>0&&(e+t>n&&(t=n-e),this.colCount-=t),this.composer.delCol(e,t)}},{key:"setReminderById",value:function(e,t){this.reminderModel.setReminderById(e,t)}},{key:"setReminder",value:function(e,t,n){this.reminderModel.set(e,t,n)}},{key:"getReminder",value:function(e,t){return this.reminderModel.get(e,t)}},{key:"getReminderCount",value:function(){return this.reminderModel.count()}},{key:"getAllReminders",value:function(){return Array.from(this.reminderModel.values())}},{key:"isEmptyReminder",value:function(){return this.reminderModel.isEmpty()}},{key:"isRowContentEmpty",value:function(e){return null==this.iterContent(e,0,1,this._sheet.getColumnCount()).next()}},{key:"isColContentEmpty",value:function(e){return null==this.iterContent(0,e,this._sheet.getRowCount(),1).next()}},{key:"iterCell",value:function(e,t,n,r){return this.iterContent(e,t,n,r)}},{key:"orderedIterCell",value:function(e,t,n,r){return this._sheet.getPivotTableManager().isIntersectPivotTable(e,t,n,r)?new RS(this._sheet,this.contentModel,e,t,e+n-1,t+r-1):this.contentModel.orderedIter(e,t,n,r)}},{key:"orderedIterCellWithPos",value:function(e,t,n,r){if(this._sheet.getPivotTableManager().isIntersectPivotTable(e,t,n,r)){var a=new RS(this._sheet,this.contentModel,e,t,e+n-1,t+r-1);return a.map((function(e){return[e,a.position()]}))}return this.contentModel.orderedIterWithPos(e,t,n,r)}},{key:"swapNode",value:function(e,t,n,r){return!(e*n<0||t*r<0||(t<0&&r<0?this.swapRow(e,n):e<0&&n<0?this.swapCol(t,r):this.swapCell(e,t,n,r),0))}},{key:"swapRow",value:function(e,t){this.composer.swapRow(e,t)}},{key:"swapCol",value:function(e,t){this.composer.swapCol(e,t)}},{key:"swapCell",value:function(e,t,n,r){this.composer.swapCell(e,t,n,r)}},{key:"getExporter",value:function(e,t,n,r){return this.composer.getExporter(e,t,n,r)}},{key:"genBlockTable",value:function(e,t){var n=[],r=Number.MAX_VALUE,a=0;return e.exportCells((function(e,t){var o=n[e];return o||(o=n[e]={columns:[]}),o=o.columns,e>a&&(a=e),e<r&&(r=e),o[t]?o[t]:o[t]={}}),t),a>=r?(n.splice(0,r),{startRowIndex:r,rowsCount:a-r+1,data:{rows:n}}):null}},{key:"serialize",value:function(){var e,t,n,r,a,o=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},i=o.gridRange,u=o.isForShortcut,s=o.gridOffset,l={sheetId:this._sheet.id(),startRow:null!==(e=null==i?void 0:i.startRow)&&void 0!==e?e:0,startCol:null!==(t=null==i?void 0:i.startCol)&&void 0!==t?t:0,endRow:null!==(n=null==i?void 0:i.endRow)&&void 0!==n?n:this.rowCount||Hv,endCol:null!==(r=null==i?void 0:i.endCol)&&void 0!==r?r:this.colCount||Hv},c=null!==(a=s)&&void 0!==a?a:{row:l.startRow,col:l.startCol},h=l.endRow-l.startRow,f=l.endCol-l.startCol,d=new Array(h).fill(0),v={valueType:void 0,valueId:void 0,formulaId:void 0,extendType:void 0,extendValueId:void 0,styleId:void 0,dataValidationId:void 0,reminderId:void 0,noteId:void 0,conditionalFormattingResultId:void 0,formulaSpecialInfoId:void 0},g=new Array(h*f).fill(v),m={sheetId:this._sheet.id(),startRow:Hv,startCol:Hv,endRow:-1,endCol:-1},p=0,y=function(e,t){var n=(e-l.startRow)*f+(t-l.startCol);m.startRow=Math.min(m.startRow,e),m.startCol=Math.min(m.startCol,t),m.endRow=Math.max(m.endRow,e+1),m.endCol=Math.max(m.endCol,t+1);var r=g[n];return r===v&&(g[n]=r=Object.assign({},v),p++,d[e-l.startRow]++),r},C=new Hk;if(C.isForShortcut=u,this.composer.getExporter(l.startRow,l.startCol,h,f).serializeCells(y,C),p<=0)return{mutation:{},recommendSplitRowIndex:-1};for(var _=Math.floor(h/2),R=0,w=0;w<d.length;w++){var k=d[w];if(R>=Math.floor(p/2)){_=w;break}R+=k}return{mutation:jk(g,m,l,c,C,v),recommendSplitRowIndex:_+l.startRow}}},{key:"deserializeCell",value:function(e,t,n,r){void 0!==n.valueType&&this.deserializeCellContent(e,t,n,r),void 0!==n.reminderId&&this.deserializeReminder(e,t,n.reminderId,r),void 0!==n.dataValidationId&&this.deserializeDataValidation(e,t,n.dataValidationId,r),void 0!==n.styleId&&this.deserializeStyle(e,t,n.styleId,r),void 0!==n.noteId&&this.deserializeNote(e,t,n.noteId,r),void 0!==n.conditionalFormattingResultId&&this.deserializeConditionalFormattingResult(e,t,n.conditionalFormattingResultId,r)}},{key:"deserializeCellV1",value:function(e,t,n,r){var a,o,i,u,s;void 0!==(null===(a=n.value)||void 0===a?void 0:a.valueType)&&this.deserializeCellContent(e,t,n.value,r),void 0!==(null===(o=n.reminder)||void 0===o?void 0:o.reminderId)&&this.deserializeReminderV1(e,t,n.reminder.reminderId),void 0!==(null===(i=n.dataValidation)||void 0===i?void 0:i.dataValidationId)&&this.deserializeDataValidation(e,t,n.dataValidation.dataValidationId,r),void 0!==(null===(u=n.style)||void 0===u?void 0:u.styleId)&&this.deserializeStyle(e,t,n.style.styleId,r),void 0!==(null===(s=n.note)||void 0===s?void 0:s.noteId)&&this.deserializeNote(e,t,n.note.noteId,r)}},{key:"deserializeCellContent",value:function(e,t,n,r){var a=this,o=r.valueRefDelta,i=r.resourceRefDelta,u=r.formatDelta,s=r.cellValueRefHelper,l=null,c=null,h=!0;switch(n.valueType){case we.B2l.CellValueType.CellValueType_String:l=this.stringVarRefMap.add(o.strings[n.valueId]);break;case we.B2l.CellValueType.CellValueType_Number:l=new ut.NumberVar(o.numbers[n.valueId]);break;case we.B2l.CellValueType.CellValueType_Formula:var f=o.formulas[n.valueId],d=f.formulaDataId,v=f.formulaRefMapId,g=Object.assign({},null!=d&&o.formulaDatas?o.formulaDatas[d]:{},{},null!=v&&o.formulaRefMaps?o.formulaRefMaps[v]:{});l=this.sheet().parent.calcEngine.deserializeFormula(g,new Oi(e,t,1,1,this._sheet),{isGridJSON:!0},{formulaDataId:d,formulaRefMapId:v,cellValueRefHelper:s});break;case we.B2l.CellValueType.CellValueType_FormulaString:var m=o.formulaStrings[n.valueId],p="="===m[0]?"":"=";l=zg(this._sheet,e,t,p+m);break;case we.B2l.CellValueType.CellValueType_Bool:l=ut.BOOLEAN_VAR_MAP[n.valueId?ut.BooleanConstant.TRUE:ut.BooleanConstant.FALSE];break;case we.B2l.CellValueType.CellValueType_EmbedImage:c=[this.contentModel.getImporter().deserializeEmbedImage(n.valueId,r)];break;case we.B2l.CellValueType.CellValueType_RichString:c=this.contentModel.getImporter().deserializeSegmentArray(n.valueId,r);break;case we.B2l.CellValueType.CellValueType_Error:var y;if(null!==(y=o.errorValues)&&void 0!==y&&y.length){var C=o.errorValues[n.valueId];if(C){l=function(e){var t=e.message||e.args||e.errorTipsType?{message:e.message,args:e.args?JSON.parse(e.args):void 0,errorTipsType:e.errorTipsType}:void 0;return new ut.ErrorVar(e.type,e.description,e.code,t)}(C);break}}var _=ut.error2DescriptionMap[n.valueId];_&&(l=ut.ERROR_VAR_MAP[_]);break;default:h=!1}if(h){var R;if(!r.isApplySnapshot){var w,k=this.contentModel.getImmutableNode(e,t,!0);if(k)hy(k,this._sheet.getCalcEngine().formulaSpace),(null==k||null===(w=k.variant)||void 0===w?void 0:w.isString())&&this.stringVarRefMap.del(k.variant.getValue())}try{var S=n.formulaSpecialInfoId;if(void 0!==S&&i.formulaSpecialInfoStrings){var E=i.formulaSpecialInfoStrings[S];if(E){var T,A=JSON.parse(E);null===(T=l)||void 0===T||T.setSpecialInfo(A)}}}catch(e){console.error(e)}var I=null;if(n.extendType===we.B2l.CellExtendType.CellExtendType_Select){I=new dm(this.sheet().parent);var b=i.selectedMultipleValues?i.selectedMultipleValues[n.extendValueId]:void 0;if(b){var F=b.selectedValueIds,M=b.selectedAutoFormats;null==F||F.forEach((function(e,t){var n=o.strings[e],r=M?u.numberFormats[M[t]]:void 0,i=null!=r&&r.formatCode?(0,Se.createFormatter)(a._sheet.formatterService,null==r?void 0:r.formatCode):void 0;I.addByTextNoSplit(n,i)}))}else{var V=i.extendValues[n.extendValueId];I.fromJSON(JSON.parse(V))}}if(null!==(R=l)&&void 0!==R&&R.isFormula()){var N=this._sheet.getCalcEngine(),O=N.formulaSpace,x=fy(this._sheet,e,t,l,null,O);x&&x.isFormula()&&(N.formulaRefService.cacheRange(x.formula,x.getRef()),l=x)}var Z=new ay(c,l,I);this.contentModel.set(e,t,Z),void 0!==n.formulaId&&l instanceof Kc&&this._sheet.parent.setFormulaCache&&this._sheet.parent.setFormulaCache(l,this._sheet,n.formulaId)}}},{key:"deserializeReminder",value:function(e,t,n,r){var a=r.resourceRefDelta.reminderIds[n],o=this.reminderModel.getReminderById(a);o&&this.reminderModel.set(e,t,o)}},{key:"deserializeReminderV1",value:function(e,t,n){var r=this.reminderModel.getReminderById(n);r&&this.reminderModel.set(e,t,r)}},{key:"deserializeDataValidation",value:function(e,t,n,r){var a=this,o=r.resourceRefDelta;r.cellValueRefHelper.dataValidations.checkValuesRefId(n,(function(n){a.dataValidationModel.setById(e,t,n,!1)}),(function(){var i=jm(o.dataValidations[n],r,a.sheet());if(i){var u=Ag(i,a.sheet());if(u)return a.dataValidationModel.setRef(e,t,u)}}))}},{key:"deserializeStyle",value:function(e,t,n,r){var a=this,o=r.cellFormatRefHelper,i=r.formatDelta;o.cellFormats.checkValuesRefId(n,(function(n){a.styleDropdownModel.setById(e,t,n,!1)}),(function(){var r,o,u,s=xp(function(e,t){var n=e.cellFormats[t];return{numFmt:e.numberFormats&&e.numberFormats[n.numFmtId],autoNumFmt:e.numberFormats&&e.numberFormats[n.autoNumFmtId],font:e.fonts&&e.fonts[n.fontId],fill:e.fills&&e.fills[n.fillId],border:e.borders&&e.borders[n.borderId],alignment:e.alignments&&e.alignments[n.alignmentId],otherFmt:e.hideLinks&&e.hideLinks[n.hideLinkId]}}(i,n)),l=a.sheet().parent,c=l.formatterService,h=null===(r=l.defaults)||void 0===r?void 0:r.defaultStyle;!h&&(null===(o=l.defaults)||void 0===o?void 0:o.style)&&((h=Ad.fromJSON(c,null===(u=l.defaults)||void 0===u?void 0:u.style,Md())).setDefault(h),l.defaults.defaultStyle=h);var f=Ad.fromJSON(c,s,h),d=a.styleDropdownModel.getStyleRefMgr().add(f).id;return a.styleDropdownModel.setRef(e,t,{style:d})}))}},{key:"deserializeNote",value:function(e,t,n,r){var a,o,i,u=null===(a=r.resourceRefDelta.notes)||void 0===a?void 0:a[n];if(u){var s=this.getNoteValue(u,r);s&&this.setCellNote(e,t,{value:s,width:(null===(o=u.frameSize)||void 0===o?void 0:o.w)||0,height:(null===(i=u.frameSize)||void 0===i?void 0:i.h)||0})}}},{key:"getNoteValue",value:function(e,t){return e.valueType===we.B2l.NoteValueType.NoteValueType_RichString?this.contentModel.getImporter().deserializeSegmentArray(e.valueId,t):null}},{key:"deserializeConditionalFormattingResult",value:function(e,t,n,r){var a=r.resourceRefDelta.conditionalFormattingResults[n];a&&this.conditionalFormatStyleModel.getImporter().deserializeConditionalFormatting(e,t,a)}},{key:"serializeExtraInfo",value:function(e){this.composer.getExporter(0,0,this.rowCount||Hv,this.colCount||Hv).serializeToMutations(e)}},{key:"toJSON",value:function(e,t,n){var r={},a={},o=this.composer.getExporter(0,0,this.rowCount||Hv,this.colCount||Hv);o.exportCells((function(e,t){var n=a[e];return n||(n=a[e]={}),n[t]?n[t]:n[t]={}})),o.exportExtraInfo(t),cS(a)||(r.dataTable=a);var i=this.getDefaultStyle().toJSON(),u={};return void 0!==i&&(u.style=i),r.defaultDataNode=u,t.data=r,t}},{key:"fromJSON",value:function(e,t){var n,r=this;if("object"==(0,_.Z)(e)){this._dirtySuspended++,hS(e.name)||(this.name=e.name);var a=this._sheet.parent.formulaCacheManager,o=e.data&&e.data.formulaCacheTable||e.formulaCacheTable;o&&(null!=a&&a.setSheetManager(this._sheet.id()),null!=a&&a.loadFormulaCacheBlock(this._sheet.id(),o)),this.importer.importExtraInfo(e,t);var i,u,s=e.data&&e.data.dataTable||e.dataTable,l=dS(this),c=vS(this);if(s)for(var h=0;h<l;h++)if(i=s[h])for(var f=0;f<c;f++)(u=i[f])&&this.importer.importCell(h,f,u);var d,v,g=null==e||null===(n=e.data)||void 0===n?void 0:n.dataTableBlockInfos;g&&g.forEach((function(e){for(var t=e.table,n=e.startRowIndex,a=0,o=t.rows.length;a<o;a++)if((d=t.rows[a])&&d.columns){v=n+a;for(var i=0,s=d.columns.length;i<s;i++)(u=d.columns[i])&&r.importer.importCell(v,i,u)}}));var m=e.data&&e.data.defaultDataNode;if(m&&m.style){var p=Ad.fromJSON(this._sheet.parent.formatterService,m.style);this.setDefaultStyle(p)}this._dirtySuspended--}}},{key:"getName",value:function(){return this.name}},{key:"getStringVarRefMap",value:function(){return this.stringVarRefMap}}]),e}();function pS(e,t,n,r,a){var o=t.sheet().parent;if(o){var i=o.logger;i&&n>=t.getRowCount()&&(i.warn("set rowCount ".concat(t.getRowCount()," to row ").concat(n+1)),t.setRowCount(n+1)),i&&r>=t.getColumnCount()&&(i.warn("set colCount ".concat(t.getColumnCount()," to col ").concat(r+1," ")),t.setColumnCount(r+1)),t.importer.importCell(n,r,e,a)}}function yS(e,t,n,r){var a=t.calcEngine.reactivitySpace;a.ignoreDirty(!0);var o,i,u,s,l,c,h,f,d=n.rows;for(o=0,i=d.length;o<i;o++)if(l=d[o])for(f=o+r,c=l.columns,u=0,s=l.columns.length;u<s;u++)(h=c[u])&&pS(h,e,f,u,!1);a.ignoreDirty(!1)}function CS(e,t,n,r){var a=r.token,o=r.split,i=r.onRowDataApplied,u=n.id?n.id():"",s=n.parent;if(s&&u){var l=s.fiberTaskScheduler,c=s.getCalcEngine().reactivitySpace;if(o){var h=Rt.ArrayIter.fromArray(Object.keys(e)).do(d);l.add(u,h),l.run()}else for(var f in e)d(f)}function d(n){var r=Number(n);c.ignoreDirty(!0),function(e,t,n,r){for(var a in e){var o=Number(a);pS(e[a],n,t,o,!1)}}(e[n],r,t),c.ignoreDirty(!1),i&&i(n,a)}}function _S(e,t,n){return"dataValidation"===e?Ag(t,n):null}var RS=function(e){function t(e,n,r,a,o,i){var u;return(0,y.Z)(this,t),(u=(0,d.Z)(this,(0,v.Z)(t).call(this)))._sheet=e,u.model=n,u.rowTo=o,u.colTo=i,u.innerIter=new pu(r,a,o-r+1,i-a+1),u}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"getPivotTableToken",value:function(){return this._sheet.getPivotTableManager().getPivotTableNameByCell(this.row,this.col)}},{key:"hasPivotTableContent",value:function(){return this._sheet.getPivotTableManager().hasPivotTableAtCell(this.row,this.col)}},{key:"getPivotTableContent",value:function(){return this._sheet.getPivotTableManager().getCellValue(this.row,this.col)}},{key:"next",value:function(){if(!this.isValid())return null;for(var e=null;null===e;){if(!this.iter())return null;for(var t=this.getPivotTableToken(),n=this.model.get(this.row,this.col);;){if(!this.isValid())return null;if(t||n)break;this.iter(),t=this.getPivotTableToken(),n=this.model.get(this.row,this.col)}if(t){var r=this.getPivotTableContent(),a=this._sheet.getCalcEngine().pivotCalculateEngine.getFormula(t),o=Lg(r)||ut.NULL_VAR;e=new ay(null,new Ha(this.row,this.col,o,t,a),null)}else n&&(e=n)}return e}},{key:"iter",value:function(){return this.innerIter.next()}},{key:"position",value:function(){return this.innerIter.position()}},{key:"isValid",value:function(){return this.row<=this.rowTo&&this.col<=this.colTo}},{key:"row",get:function(){return this.innerIter.cellPosition.row}},{key:"col",get:function(){return this.innerIter.cellPosition.col}},{key:"cellPosition",get:function(){return this.innerIter.cellPosition}}]),t}(Rt.FIterator),wS=function(e){function t(e,n,r,a,o,i){var u;return(0,y.Z)(this,t),(u=(0,d.Z)(this,(0,v.Z)(t).call(this)))._sheet=e,u.table=n,u.rowFrom=r,u.colFrom=a,u.rowTo=o,u.colTo=i,u.innerIter=new pu(r,a,o-r+1,i-a+1),u}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"hasPivotTable",value:function(){return this._sheet.getPivotTableManager().hasPivotTableAtCell(this.row,this.col)}},{key:"getPivotTableStyle",value:function(){return this._sheet.getPivotTableManager().getCellStyle(this.row,this.col)}},{key:"next",value:function(){if(!this.isValid())return null;for(var e=null;null===e;){if(!this.iter())return null;for(var t=this.hasPivotTable(),n=this.table.getStyle(this.row,this.col);;){if(!this.isValid())return null;if(t||n)break;this.iter(),t=this.hasPivotTable(),n=this.table.getStyle(this.row,this.col)}t?e=this._sheet.getPivotTableManager().composePivotStyle(n,this.row,this.col):n&&(e=n)}return e}},{key:"iter",value:function(){return this.innerIter.next()}},{key:"isValid",value:function(){return this.row<=this.rowTo&&this.col<=this.colTo}},{key:"position",value:function(){return this.innerIter.position()}},{key:"row",get:function(){return this.innerIter.cellPosition.row}},{key:"col",get:function(){return this.innerIter.cellPosition.col}},{key:"cellPosition",get:function(){return this.innerIter.cellPosition}}]),t}(Rt.FIterator);function kS(e,t,n){var r;return null===(r=e.getPivotTableManager().getPivotInfoByName(t))||void 0===r?void 0:r[n]}function SS(e){for(var t=e.sheets,n=0,r=0;r<t.length;r++)n+=Object.keys(t[r].embeddedBlocksModel.getBlocksMap()).length;return n}var ES,TS,AS=function(e,t){return"".concat(e,"-").concat(t,"-").concat((0,Ot.Ki)())},IS=function(e){function t(e){var n;return(0,y.Z)(this,t),(n=(0,d.Z)(this,(0,v.Z)(t).call(this)))._sheet=e,n._lastNonNullColumn=-1,n._lastNonNullRow=-1,n.rowCache=new Map,n.rowSet=new Map,n.colSet=new Map,n.pivotSpans=new Map,Object.setPrototypeOf((0,c.Z)(n),t.prototype),n}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"_onSpanAdded",value:function(e,t){this._lastNonNullRow=Math.max(this._lastNonNullRow,e.rowTo()),this._lastNonNullColumn=Math.max(this._lastNonNullColumn,e.colTo());var n=e.rowFrom(),r=e.colFrom(),a=e.rowTo(!0),o=e.colTo(!0);this.setCache(n,r,e);for(var i=n;i<=a;i++){var u=this.rowSet.get(i);u||(u=new Set,this.rowSet.set(i,u)),u.add(e)}for(var s=r;s<=o;s++){var l=this.colSet.get(s);l||(l=new Set,this.colSet.set(s,l)),l.add(e)}t&&this.pivotSpans.set(e,!0)}},{key:"getCache",value:function(e,t){var n=this.rowCache.get(e);return n?n.get(t):null}},{key:"setCache",value:function(e,t,n){this.rowCache.has(e)||this.rowCache.set(e,new Map),this.rowCache.get(e).set(t,n)}},{key:"deleteCache",value:function(e,t){var n=this.rowCache.get(e);n&&(n.delete(t),0===n.size&&this.rowCache.delete(e))}},{key:"_onSpanRemoved",value:function(e){var t=e.rowFrom(),n=e.colFrom(),r=e.rowTo(!0),a=e.colTo(!0);this.deleteCache(t,n),this._sheet.dispatch("SpanRemoved",e);for(var o=t;o<=r;o++){var i=this.rowSet.get(o);i&&(i.delete(e),0===i.size&&this.rowSet.delete(o))}for(var u=n;u<=a;u++){var s=this.colSet.get(u);s&&(s.delete(e),0===s.size&&this.colSet.delete(u))}}},{key:"toArray",value:function(e){var t=this,n=[];return this.forEach((function(e){return n.push(e)})),e?n.filter((function(e){return!t.pivotSpans.has(e)})):n}},{key:"find",value:function(e,t){var n=this.getCache(e,t);if(n)return n;var r=this.rowSet.get(e),a=this.colSet.get(t);if(!r||!a)return null;for(var o=(r.size<a.size?r:a).entries(),i=o.next();i.value;i=o.next()){var u=i.value[0];if(u.containCell(e,t))return u}return null}},{key:"get",value:function(e,t){return this.find(e,t)||new Oi(e,t,1,1,this._sheet)}},{key:"remove",value:function(e){var t=this.indexOf(e);t>=0&&this.removeSpan(t,1)}},{key:"update",value:function(e,t){this._onSpanRemoved(this[e]),this[e]=t,this._onSpanAdded(t)}},{key:"addSpan",value:function(e,t){1===e.rowCount(!0)&&1===e.colCount(!0)||this.pivotSpans.has(e)||(this._onSpanAdded(e,t),this.push(e))}},{key:"removeSpan",value:function(e,t){for(var n=!(arguments.length>2&&void 0!==arguments[2])||arguments[2],r=0,a=0;a<Math.min(this.length-e,t)&&r<t;a++){var o=this[e+a];o&&(n&&this.pivotSpans.has(o)||(this._onSpanRemoved(o),this.splice(e+a,1),this.pivotSpans.delete(o),a--,r++))}return r}},{key:"removePivotRange",value:function(e){for(var t=this.length-1;t>=0;t--)this[t].equal(e)&&this.removeSpan(t,1,!1)}},{key:"copy",value:function(e,t,n,r,a,o){for(var i=this,u=arguments.length>6&&void 0!==arguments[6]?arguments[6]:{copyMoveMode:0},s=u.copyMoveMode,l=u.ignoredRows,c=this.length,h=[],f=Boolean(4&s&&l),d=f?l.size:0,v=f?mh(l,this._sheet):[],g=function(u){var s=i[u],g=s.colFrom(),p=s.rowFrom();if((-1===e||e<=p&&p<e+a)&&(-1===t||t<=g&&g<t+o)){var y=n+p-e,C=r+g-t,_=s.rowCount(),R=s.colCount();if(f){var w,k=_n(l);try{for(k.s();!(w=k.n()).done;){var S=w.value;if(S<=y)++y;else if(y<S&&S<=y+_-1);else if(y+_-1<S)break}}catch(e){k.e(e)}finally{k.f()}}h.push(new Oi(y,C,_,R,i._sheet))}else(-1===e||n<=p&&p<n+a+d)&&(-1===t||r<=g&&g<r+o)&&v.every((function(e){return!e.contain(s)}))&&(i.removeSpan(u,1),u--,c--);m=u},m=0;m<c;m++)g(m);for(var p=0;p<h.length;p++){var y=h[p];if(!this.isValid(this.slice(0),0,this.length,y,!0))throw we.PnZ.fromCode(we.XFC.APPLY_FAIL_SPAN_CONFLICT);this.addSpan(y)}}},{key:"isValid",value:function(e,t,n,r){for(var a=arguments.length>4&&void 0!==arguments[4]&&arguments[4],o=t;o<n&&o<e.length;o++)if(e[o].isIntersect(r)){try{a&&console.error("CellRange Error: from=".concat(JSON.stringify(e[o].toJSON()),",\n            to=").concat(JSON.stringify(r.toJSON())))}catch(e){}return we.Ps3.collectSuiteEvent("sheet_add_span_model_invalid"),!1}return!0}},{key:"each",value:function(e,t,n,r,a){for(var o=0,i=this.length;o<i;o++){if(e>=0||t>=0)for(;o<i&&!this[o].isIntersect(new Oi(e,t,n,r,this._sheet));)o++;if(o<i&&a&&!1===a(this[o]))break}}},{key:"getSpans",value:function(e,t){var n=this;if(!e)return this.slice(0);var r=this.getIntersectSpansInfo(e.rowFrom(),e.colFrom(),e.rowCount(),e.colCount()),a=[];return r.containedSpans.forEach((function(e){t&&n.pivotSpans.has(e)||a.push(e)})),r.hasPartSpans.forEach((function(e){t&&n.pivotSpans.has(e)||a.push(e)})),a}},{key:"getSpansByRow",value:function(e){var t=this.rowSet.get(e);return t?Array.from(t):[]}},{key:"getSpansByCol",value:function(e){var t=this.colSet.get(e);return t?Array.from(t):[]}},{key:"hasPartSpans",value:function(e,t,n,r,a){return this.getIntersectSpansInfo(e,t,n,r,a).hasPartSpans.size>0}},{key:"getIntersectSpansInfo",value:function(e,t,n,r,a){if(this.length<=n&&this.length<=r)return this.getIntersectSpansInfoByIterAll(e,t,n,r,a);var o=this.getCacheListArray(this.rowSet,e,n),i=this.getCacheListArray(this.colSet,t,r);return this.getListArrayTotalCount(o)<this.getListArrayTotalCount(i)?this.getIntersectSpansInfoByCache(o,e,t,n,r,a):this.getIntersectSpansInfoByCache(i,e,t,n,r,a)}},{key:"getCacheListArray",value:function(e,t,n){for(var r=[],a=t;a<t+n;a++){var o=e.get(a);o&&r.push(o)}return r}},{key:"getListArrayTotalCount",value:function(e){for(var t=0,n=0;n<e.length;n++)t+=e[n].size;return t}},{key:"getIntersectSpansInfoByIterAll",value:function(e,t,n,r,a){for(var o=new Set,i=new Set,u=new Oi(e,t,n,r,this._sheet),s=0;s<this.length;s++){var l=this[s];a&&this.pivotSpans.has(l)||l.isIntersect(u)&&(-1!==e&&(l.rowFrom()<e||l.rowFrom()+l.rowCount()>e+n)||-1!==t&&(l.colFrom()<t||l.colFrom()+l.colCount()>t+r)?i.add(l):o.add(l))}return{containedSpans:o,hasPartSpans:i}}},{key:"getIntersectSpansInfoByCache",value:function(e,t,n,r,a,o){for(var i=new Set,u=new Set,s=new Oi(t,n,r,a,this._sheet),l=0;l<e.length;l++)for(var c=e[l].entries(),h=c.next();h.value;h=c.next()){var f=h.value[0];o&&this.pivotSpans.has(f.id())||f.isIntersect(s)&&(-1!==t&&(f.rowFrom()<t||f.rowFrom()+f.rowCount()>t+r)||-1!==n&&(f.colFrom()<n||f.colFrom()+f.colCount()>n+a)?u.add(f):i.add(f))}return{containedSpans:i,hasPartSpans:u}}},{key:"hasSpans",value:function(e,t,n,r){var a=!1;return this.each(e,t,n,r,(function(){return a=!0,!1})),a}},{key:"clearAll",value:function(e){for(var t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],n=0,r=0;r<this.length;r++){var a=this[r],o=e.contain(a),i=e.intersect(a);!o&&!i||t&&this.pivotSpans.has(a)?(this[n]=this[r],n++):(this._onSpanRemoved(a),this.pivotSpans.delete(a))}var u=this.length-n;return this.length=n,u}},{key:"clear",value:function(e,t,n,r){for(var a=0;a<this.length;a++){var o=this[a],i=o.rowFrom(),u=o.colFrom();(-1===e||e<=i&&i<e+n)&&(-1===t||t<=u&&u<t+r)&&this.removeSpan(a,1)>0&&a--}}},{key:"move",value:function(e,n,r,a,o,i){for(var u=this,s=arguments.length>6&&void 0!==arguments[6]?arguments[6]:{copyMoveMode:0},l=s.copyMoveMode,c=s.ignoredRows,h=!1,f=!1,d=new t(this._sheet),v=[],g=this.length,m=Boolean(4&l&&c),p=m?c.size:0,y=m?mh(c,this._sheet):[],C=function(t){var s,l=u[t],g=l.rowFrom(),C=l.colFrom(),_=null===(s=u._sheet.getPivotTableManager())||void 0===s?void 0:s.getPivotTableNameByCell(g,C);if(!kS(u._sheet,_,"isCopy")&&!u.pivotSpans.has(l))if((-1===e||e<=g&&g<e+o)&&(-1===n||n<=C&&C<n+i)){var R=r+g-e,w=a+C-n,k=l.rowCount(),S=l.colCount();if(m){var E,T=_n(c);try{for(T.s();!(E=T.n()).done;){var A=E.value;if(A<=R)++R;else if(R<A&&A<=R+k-1);else if(R+k-1<A)break}}catch(e){T.e(e)}finally{T.f()}}var I=new Oi(R,w,k,S,u._sheet);v.push(I),h=!0}else(-1===e||r<=g&&g<r+o+p)&&(-1===n||a<=C&&C<a+i)&&y.every((function(e){return!e.contain(l)}))?f=!0:d.push(l)},_=0;_<g;_++)C(_);if(f&&this.clear(r,a,o,i),h){if(v.length>0)for(var R=0;R<v.length;R++){var w=v[R];if(!this.isValid(d.slice(0),0,d.length,w,!0))throw we.PnZ.fromCode(we.XFC.MOVE_RANGE_CONFLICT_SPAN)}this.clear(e,n,o,i);for(var k=0;k<v.length;k++)this.addSpan(v[k])}}},{key:"isEmpty",value:function(){return this.length<=0}},{key:"isPivotSpan",value:function(e){return this.pivotSpans.has(e)}},{key:"addRows",value:function(e,t){for(var n=this,r=[],a=this.length-1;a>=0;--a){var o=this[a];this.pivotSpans.has(o)||(o.rowFrom()>=e?(this.removeSpan(a,1),r.push(o.offset(t,0))):e<=o.rowTo()&&(this.removeSpan(a,1),r.push(new Oi(o.rowFrom(),o.colFrom(),o.rowCount()+t,o.colCount(),this._sheet))))}r.forEach((function(e){return n.addSpan(e)}))}},{key:"addColumns",value:function(e,t){for(var n=this,r=[],a=this.length-1;a>=0;--a){var o=this[a];this.pivotSpans.has(o)||(o.colFrom()>=e?(this.removeSpan(a,1),r.push(o.offset(0,t))):o.colFrom()<e&&e<=o.colTo()&&(this.removeSpan(a,1),r.push(new Oi(o.rowFrom(),o.colFrom(),o.rowCount(),o.colCount()+t,this._sheet))))}r.forEach((function(e){return n.addSpan(e)}))}},{key:"removeRows",value:function(e,t){for(var n=this,r=[],a=this.length-1;a>=0;--a){var o=this[a];if(!this.pivotSpans.has(o)){var i={row:o.rowFrom(),col:o.colFrom(),rowCount:o.rowCount(!0),colCount:o.colCount(!0)},u=e,s=e+t;this.removeSpan(a,1),s<=i.row?i.row-=t:u<i.row?(i.row-=i.row-u,i.rowCount-=s-i.row-1):u<i.row+i.rowCount&&(i.rowCount-=Math.min(i.row+i.rowCount-u,t));var l=new Oi(i.row,i.col,i.rowCount,i.colCount,this._sheet);this.isLegalSpan(l)&&r.push(l)}}r.forEach((function(e){return n.addSpan(e)}))}},{key:"removeColumns",value:function(e,t){for(var n=this,r=[],a=this.length-1;a>=0;--a){var o=this[a];if(!this.pivotSpans.has(o)){var i={row:o.rowFrom(),col:o.colFrom(),rowCount:o.rowCount(!0),colCount:o.colCount(!0)},u=e,s=e+t;this.removeSpan(a,1),s<=i.col?i.col-=t:u<i.col?(i.col-=i.col-u,i.colCount-=s-i.col-1):u<i.col+i.colCount&&(i.colCount-=Math.min(i.col+i.colCount-u,t));var l=new Oi(i.row,i.col,i.rowCount,i.colCount,this._sheet);this.isLegalSpan(l)&&r.push(l)}}r.forEach((function(e){return n.addSpan(e)}))}},{key:"isLegalSpan",value:function(e){return e.rowCount()*e.colCount()>1}},{key:"toJSON",value:function(){var e=this.toArray(!0).map((function(e){return e.toJSON()}));return 0===e.length?void 0:e}},{key:"fromJSON",value:function(e){if(e){this.length=0;for(var t=0;t<e.length;t++){var n=e[t];this.addSpan(new Oi(n.row,n.col,n.rowCount,n.colCount,this._sheet))}}}},{key:"iter",value:function(e,t,n,r,a){return new bS(e,t,n,r,this,this._sheet,a)}}]),t}((0,a.Z)(Array)),bS=function(e){function t(e,n,r,a,o,i,u){var s;return(0,y.Z)(this,t),(s=(0,d.Z)(this,(0,v.Z)(t).call(this))).spanModel=o,s.sheet=i,s.ignorePivot=u,s.i=-1,s.length=0,s.length=s.spanModel.length,s.target=new Oi(e,n,r-e+1,a-n+1,s.sheet),s}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"next",value:function(){for(this.i++;this.i<this.length;){var e=this.spanModel[this.i];if(this.ignorePivot&&this.spanModel.isPivotSpan(e))this.i++;else{if(e.isIntersect(this.target))return e;this.i++}}return null}}]),t}(Rt.FIterator),FS=function(e){function t(e){var n;return(0,y.Z)(this,t),(n=(0,d.Z)(this,(0,v.Z)(t).call(this)))._sheet=e,n.activeSelectedRangeIndex=-1,Object.setPrototypeOf((0,c.Z)(n),t.prototype),n}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"find",value:function(e,n){var r=this;return(0,f.Z)((0,v.Z)(t.prototype),"find",this).call(this,(function(t){return t.contain(new Oi(e,n,1,1,r._sheet))}))||null}},{key:"clear",value:function(){this.splice(0,this.length),this.activeSelectedRangeIndex=-1}},{key:"add",value:function(e){this.push(e),this.activeSelectedRangeIndex=this.length-1}},{key:"toArray",value:function(){var e=[];return this.forEach((function(t){return e.push(t)})),e}},{key:"fromArray",value:function(e){var t=this;this.clear(),e.forEach((function(e){return t.add(e)}))}},{key:"toJSON",value:function(){if(this.length){var e={length:this.length};return 0!==this.activeSelectedRangeIndex&&(e.activeSelectedRangeIndex=this.activeSelectedRangeIndex),this.forEach((function(t,n){e[n]=t.toJSON()})),e}}},{key:"fromJSON",value:function(e,t){this.clear();for(var n=e.length||1,r=0;r<n;r++){var a=e[r];a?this.add(new Oi(a.row,a.col,a.rowCount,a.colCount,t)):this.add(new Oi(0,0,1,1,t))}this.activeSelectedRangeIndex=e.activeSelectedRangeIndex||0}},{key:"_isColumnSelected",value:function(e){return this.some((function(t){var n=t.sheet();return!!(n&&t.rowCount()===n.getRowCount()&&e>=t.colFrom()&&e<=t.colTo())}))}},{key:"_isRowSelected",value:function(e){return this.some((function(t){var n=t.sheet();return!!(n&&t.colCount()===n.getColumnCount()&&e>=t.rowFrom()&&e<=t.rowTo())}))}}]),t}((0,a.Z)(Array)),MS=1e4,VS=function(){function e(t){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:120;(0,y.Z)(this,e),this.axisModel=t,this.blockSize=n,this.posMap=new we.z6B(MS),this.blockDistanceMap=new we.z6B(MS),this._lastPosInfo={pos:0,distance:0},this._stackLevel=0,this._maxPos=0,this._maxDistance=0}return(0,C.Z)(e,[{key:"getDistance",value:function(e){if(e<=0)return 0;e>this.axisModel.length&&(e=this.axisModel.length);var t=this.posMap.get(e,!1);if(null!=t)return t;var n=0,r=0;this._lastPosInfo.pos<e&&(n=this._lastPosInfo.pos,r=this._lastPosInfo.distance);for(var a=this.axisModel.iter(n,e),o=null,i=a.next();null!==i;i=a.next())(o=i).value&&o.count&&(r+=o.value*o.count);return null!==o&&o.index+o.count>e&&(r-=(o.index+o.count-e)*o.value),this._lastPosInfo.pos=e,this._lastPosInfo.distance=r,this._updateMaxPos(e),this.posMap.set(e,r),r}},{key:"getPos",value:function(e){if(e<=0)return{pos:0,offset:0};var t=this.axisModel.length;if(!isFinite(e))return{pos:t-1,offset:0};var n=Math.floor(e/this.blockSize),r=e%this.blockSize,a=this.blockSize*n,o=this.blockDistanceMap.get(a,!1);if(this._stackLevel<200)if(o){if(0===r)return o}else this._stackLevel++,a=0===r?this.blockSize*(n-1):a,o=this.getPos(a);else a=0,o={pos:0,offset:0};for(var i=a-o.offset,u={pos:o.pos,offset:o.offset},s=o.pos,l=this.axisModel.iter(s,this.axisModel.length),c=l.next();null!==c&&i<e;c=l.next()){var h=c.value*c.count;if(i+h>=e){var f=Math.floor((e-i)/c.value);u.pos+=f,i+=f*c.value,u.offset=e-i;break}u.pos+=c.count,u.offset=0,i+=h}return 0===r&&(this.blockDistanceMap.set(e,u),this._updateMaxDistance(e)),u.pos=Math.min(u.pos,t-1),this._stackLevel=0,u}},{key:"clear",value:function(){this.posMap.clear(),this.blockDistanceMap.clear(),this._lastPosInfo={pos:0,distance:0},this._maxDistance=0,this._maxPos=0}},{key:"clearFrom",value:function(e){if(0!==e){if(this._maxPos>=e){for(;this._maxPos>=e;)this.posMap.remove(this._maxPos),this._maxPos--;this._lastPosInfo.pos=this._maxPos,this._lastPosInfo.distance=this.getDistance(this._maxPos)}for(var t=this.getDistance(e-1);this._maxDistance>t;)this.blockDistanceMap.remove(this._maxDistance),this._maxDistance-=this.blockSize}else this.clear()}},{key:"_updateMaxPos",value:function(e){this._maxPos<e&&(this._maxPos=e)}},{key:"_updateMaxDistance",value:function(e){this._maxDistance<e&&(this._maxDistance=e)}}]),e}();!function(e){e[e.RED=0]="RED",e[e.BLACK=1]="BLACK"}(ES||(ES={}));var NS=function e(){(0,y.Z)(this,e)},OS=function(){function e(){(0,y.Z)(this,e)}return(0,C.Z)(e,[{key:"left",value:function(e){return null!==e?e.left:null}},{key:"right",value:function(e){return null!==e?e.right:null}},{key:"parent",value:function(e){return null!==e?e.parent:null}},{key:"setLeft",value:function(e,t){return null!==e?(e.left=t,e.left):null}},{key:"setRight",value:function(e,t){return null!==e?(e.right=t,e.right):null}},{key:"setParent",value:function(e,t){return null!==e?(e.parent=t,e.parent):null}},{key:"color",value:function(e){return null!==e?e.color:null}},{key:"setColor",value:function(e,t){return null!==e?(e.color=t,e.color):null}},{key:"reset",value:function(e,t,n,r,a){this.setLeft(e,t),this.setRight(e,n),this.setParent(e,r),void 0!==a&&this.setColor(e,a)}},{key:"isRoot",value:function(e){return this.color(e)===ES.BLACK&&this.parent(this.parent(e))===e}},{key:"isHeader",value:function(e){return this.color(e)===ES.RED&&this.parent(this.parent(e))===e}},{key:"root",value:function(e){for(;!this.isRoot(e);)e=this.parent(e);return e}},{key:"header",value:function(e){for(;!this.isHeader(e);)e=this.parent(e);return e}},{key:"leftMostChild",value:function(e){for(;this.left(e);)e=this.left(e);return e}},{key:"rightMostChild",value:function(e){for(;this.right(e);)e=this.right(e);return e}},{key:"next",value:function(e){if(this.isHeader(e))return this.left(e);if(this.right(e))return this.leftMostChild(this.right(e));for(var t=this.parent(e);e===this.right(t);)e=t,t=this.parent(e);return this.right(e)===t?e:t}},{key:"prev",value:function(e){if(this.isHeader(e))return this.right(e);if(this.left(e))return this.rightMostChild(this.left(e));for(var t=this.parent(e);e===this.left(t);)e=t,t=this.parent(e);return this.left(e)===t?e:t}},{key:"deep",value:function(e,t){for(var n=0;t?e!==t:!this.isHeader(e);e=this.parent(e))n+=1;return n}},{key:"rotateLeft",value:function(e,t){var n=this.right(t),r=this.left(n);this.setRight(t,r),r&&this.setParent(r,t);var a=this.parent(t);this.setParent(n,a),a===e?this.setParent(e,n):this.left(a)===t?this.setLeft(a,n):this.setRight(a,n),this.setLeft(n,t),this.setParent(t,n)}},{key:"rotateRight",value:function(e,t){var n=this.left(t),r=this.right(n);this.setLeft(t,r),r&&this.setParent(r,t);var a=this.parent(t);this.setParent(n,a),a===e?this.setParent(e,n):this.left(a)===t?this.setLeft(a,n):this.setRight(a,n),this.setRight(n,t),this.setParent(t,n)}},{key:"insertFixUp",value:function(e,t){for(;t!==this.parent(e)&&this.color(this.parent(t))===ES.RED;){var n=this.parent(t),r=this.parent(n);if(this.left(r)===n){var a=this.right(r);if(!a||this.color(a)!==ES.RED){if(t===this.right(n)){this.rotateLeft(e,n);var o=t;t=n,n=o}this.setColor(n,ES.BLACK),this.setColor(r,ES.RED),this.rotateRight(e,r);break}this.setColor(n,ES.BLACK),this.setColor(a,ES.BLACK),this.setColor(r,ES.RED),t=r}else{var i=this.left(r);if(!i||this.color(i)!==ES.RED){if(t===this.left(n)){this.rotateRight(e,n);var u=t;t=n,n=u}this.setColor(n,ES.BLACK),this.setColor(r,ES.RED),this.rotateLeft(e,r);break}this.setColor(n,ES.BLACK),this.setColor(i,ES.BLACK),this.setColor(r,ES.RED),t=r}}this.color(this.parent(e))===ES.RED&&this.setColor(this.parent(e),ES.BLACK)}},{key:"eraseSwap",value:function(e,t){var n=this.leftMostChild(this.right(t)),r=this.parent(t),a=this.left(t),o=this.right(n);if(n===this.right(t))this.setParent(t,n),this.setRight(n,t);else{var i=this.right(t),u=this.parent(n);this.setParent(t,u),this.setRight(n,i),this.setParent(i,n),this.setLeft(u,t)}this.setLeft(t,null),this.setRight(t,o),this.setParent(n,r),this.setLeft(n,a),this.setParent(a,n),o&&this.setParent(o,t),r===e?this.setParent(r,n):this.left(r)===t?this.setLeft(r,n):this.setRight(r,n);var s=this.color(t);this.setColor(t,this.color(n)),this.setColor(n,s)}},{key:"eraseFixUp",value:function(e,t){for(;t!==this.parent(e);){if(this.color(t)===ES.RED){this.setColor(t,ES.BLACK);break}var n=this.parent(t);if(this.left(n)===t){var r=this.right(n);this.color(r)===ES.RED&&(this.rotateLeft(e,n),this.setColor(n,ES.RED),this.setColor(r,ES.BLACK),r=this.right(n));var a=this.right(r);if(!a||this.color(a)===ES.BLACK){var o=this.left(r);if(!o||this.color(o)===ES.BLACK){this.setColor(r,ES.RED),t=n;continue}this.rotateRight(e,r),this.setColor(r,ES.RED),this.setColor(o,ES.BLACK),r=this.right(n),a=this.right(r)}this.rotateLeft(e,n),this.setColor(r,this.color(n)),this.setColor(n,ES.BLACK),this.setColor(a,ES.BLACK);break}var i=this.left(n);this.color(i)===ES.RED&&(this.rotateRight(e,n),this.setColor(n,ES.RED),this.setColor(i,ES.BLACK),i=this.left(n));var u=this.left(i);if(!u||this.color(u)===ES.BLACK){var s=this.right(i);if(!s||this.color(s)===ES.BLACK){this.setColor(i,ES.RED),t=n;continue}this.rotateLeft(e,i),this.setColor(i,ES.RED),this.setColor(s,ES.BLACK),i=this.left(n),u=this.left(i)}this.rotateRight(e,n),this.setColor(i,this.color(n)),this.setColor(n,ES.BLACK),this.setColor(u,ES.BLACK);break}}},{key:"eraseCut",value:function(e,t){var n=this.left(t);n||(n=this.right(t));var r=this.parent(t);n&&this.setParent(n,r),r===e?n?(this.setParent(e,n),this.color(n)===ES.RED&&this.setColor(n,ES.BLACK)):this.setParent(e,e):this.left(r)===t?this.setLeft(r,n):this.setRight(r,n),this.left(e)===t&&(this.right(t)?this.setLeft(e,this.leftMostChild(this.right(t))):this.setLeft(e,this.parent(t))),this.right(e)===t&&(this.left(t)?this.setRight(e,this.rightMostChild(this.left(t))):this.setRight(e,this.parent(t)))}},{key:"insert",value:function(e,t,n){if(t===e)(t=this.right(e))===e?this.reset(e,n,n,n):(this.setRight(t,n),this.setRight(e,n));else if(this.left(t)){for(t=this.left(t);this.right(t);)t=this.right(t);this.setRight(t,n)}else this.setLeft(t,n),t===this.left(e)&&this.setLeft(e,n);return this.reset(n,null,null,t,ES.RED),this.insertFixUp(e,n),n}},{key:"insertToRight",value:function(e,t,n){if(t===e)(t=this.left(e))===e?this.reset(e,n,n,n):(this.setLeft(t,n),this.setLeft(e,n));else if(this.right(t)){for(t=this.right(t);this.left(t);)t=this.left(t);this.setLeft(t,n)}else this.setRight(t,n),t===this.right(e)&&this.setRight(e,n);return this.reset(n,null,null,t,ES.RED),this.insertFixUp(e,n),n}},{key:"insertRoot",value:function(e,t){return this.reset(e,t,t,t),this.reset(t,null,null,e,ES.BLACK),t}},{key:"insertLeft",value:function(e,t,n){return this.setLeft(t,n),t===this.left(e)&&this.setLeft(e,n),this.reset(n,null,null,t,ES.RED),this.insertFixUp(e,n),n}},{key:"insertRight",value:function(e,t,n){return this.setRight(t,n),t===this.right(e)&&this.setRight(e,n),this.reset(n,null,null,t,ES.RED),this.insertFixUp(e,n),n}},{key:"erase",value:function(e,t){return this.left(t)&&this.right(t)&&this.eraseSwap(e,t),this.eraseFixUp(e,t),this.eraseCut(e,t),t}}]),e}(),xS=function(){function e(t,n){(0,y.Z)(this,e),this.node=t,this._policy=n}return(0,C.Z)(e,[{key:"next",value:function(){return this.node=this._policy.next(this.node),this}},{key:"postNext",value:function(){var e=this.copy();return this.next(),e}},{key:"prev",value:function(){return this.node=this._policy.prev(this.node),this}},{key:"postPrev",value:function(){var e=this.copy();return this.prev(),e}},{key:"equal",value:function(e){return this.node===e.getNode()}},{key:"getNode",value:function(){return this.node}}]),e}(),ZS=function(){function e(t){(0,y.Z)(this,e),this._header=t,this.resetHeader()}return(0,C.Z)(e,[{key:"resetHeader",value:function(){var e=this.header();this.policy().reset(e,e,e,e,ES.RED)}},{key:"policy",value:function(){return this._policy||(this._policy=new OS),this._policy}},{key:"header",value:function(){return this._header}},{key:"root",value:function(){return this.policy().parent(this.header())}},{key:"leftMost",value:function(){return this.policy().left(this.header())}},{key:"rightMost",value:function(){return this.policy().right(this.header())}},{key:"insert",value:function(e,t){return this.policy().insert(this.header(),e,t)}},{key:"erase",value:function(e){return this.policy().erase(this.header(),e)}},{key:"deep",value:function(e){return this.policy().deep(this.header(),e)}}]),e}();!function(e){e[e.Outer=0]="Outer",e[e.Inner=1]="Inner"}(TS||(TS={}));var DS=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),t}(NS),PS=function(e){function t(){var e;return(0,y.Z)(this,t),(e=(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))).posPolicy=TS.Outer,e}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"off",value:function(e){return null!==e?e.off:0}},{key:"setOff",value:function(e,t){return null!==e?(e.off=t,e.off):0}},{key:"data",value:function(e){return null!==e?e.data:null}},{key:"setData",value:function(e,t){return null!==e?(e.data=t,e.data):null}},{key:"cmpPos",value:function(e,t){return this.posPolicy===TS.Outer?t>=e:this.posPolicy===TS.Inner&&e<t}},{key:"findInsertPos",value:function(e,t){var n=this.parent(e);if(n===e)return{node:n,pos:t};for(var r=e;n;)if(this.off(n)<t)t-=this.off(n),n=this.right(n);else{if(!(t<this.off(n)))return{node:null,pos:t};r=n,n=this.left(n)}return{node:r,pos:t}}},{key:"position",value:function(e,t){for(var n=e,r=this.off(n),a=this.parent(n);a!==t;a=this.parent(a))this.right(a)===n&&(r+=this.off(a)),n=a;return r}},{key:"findOuter",value:function(e,t){var n=this.parent(e);if(n===e)return e;for(var r=t,a=e;n;)this.cmpPos(this.off(n),r)?(r-=this.off(n),n=this.right(n)):(a=n,n=this.left(n));return a}},{key:"findInner",value:function(e,t){var n=this.parent(e);if(n===e)return e;for(var r=t,a=e;n;)this.cmpPos(this.off(n),r)?(r-=this.off(n),a=n,n=this.right(n)):n=this.left(n);return a}},{key:"insertSpace",value:function(e,t,n){var r=this.parent(e);if(r!==e)for(var a=t;r;)this.cmpPos(this.off(r),a)?(a-=this.off(r),r=this.right(r)):(this.setOff(r,this.off(r)+n),r=this.left(r))}},{key:"eraseSpace",value:function(e,t,n){var r=this.parent(e);if(r!==e)for(var a=t;r;)this.cmpPos(this.off(r),a)?(a-=this.off(r),r=this.right(r)):(this.setOff(r,this.off(r)-n),r=this.left(r))}},{key:"rotateLeft",value:function(e,n){var r=this.right(n);this.setOff(r,this.off(r)+this.off(n)),(0,f.Z)((0,v.Z)(t.prototype),"rotateLeft",this).call(this,e,n)}},{key:"rotateRight",value:function(e,n){var r=this.left(n);this.setOff(n,this.off(n)-this.off(r)),(0,f.Z)((0,v.Z)(t.prototype),"rotateRight",this).call(this,e,n)}},{key:"eraseSwap",value:function(e,n){for(var r=this.right(n);this.left(r);)r=this.left(r);var a=this.off(r);this.setOff(r,this.off(n)+a),this.setOff(n,0);for(var o=this.parent(r);o!==n;o=this.parent(o))this.setOff(o,this.off(o)-a);(0,f.Z)((0,v.Z)(t.prototype),"eraseSwap",this).call(this,e,n)}},{key:"eraseCut",value:function(e,n){if(this.right(n))for(var r=this.off(n),a=this.right(n);a;a=this.left(a))this.setOff(a,this.off(a)+r);(0,f.Z)((0,v.Z)(t.prototype),"eraseCut",this).call(this,e,n)}}]),t}(OS),LS=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"copy",value:function(){return new t(this.node,this._policy)}},{key:"data",value:function(){return this._policy.data(this.node)}},{key:"setData",value:function(e){this._policy.setData(this.node,e)}}]),t}(xS),BS=function(e){function t(e,n){var r;return(0,y.Z)(this,t),(r=(0,d.Z)(this,(0,v.Z)(t).call(this,e)))._header=e,r.posPolicy=n,r.resetHeader(),r}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"resetHeader",value:function(){var e=this.header();return this.policy().setOff(e,0),(0,f.Z)((0,v.Z)(t.prototype),"resetHeader",this).call(this)}},{key:"policy",value:function(){return this._policy||(this._policy=new PS),this._policy.posPolicy=this.posPolicy,this._policy}},{key:"doEraseSpace",value:function(e,t){for(var n=this,r=[],a=this.policy().findOuter(this.header(),e),o=this.policy().findOuter(this.header(),e+t);a!==o;)a&&r.push(a),a=this.policy().next(a);var i=[];return r.forEach((function(e){var t=n.position(e);n.policy().erase(n.header(),e),n.policy().setOff(e,t),n.policy().reset(e,null,null,null),i.push({pos:t,data:e.data})})),this.policy().eraseSpace(this.header(),e,t),i}},{key:"allocNode",value:function(e,t){var n=new DS;return this.policy().setOff(n,e),this.policy().setData(n,t),n}},{key:"insertFloat",value:function(e,t){var n=this.policy().findInsertPos(this.header(),e);if(n.node){var r=this.allocNode(n.pos,t);return this.policy().insert(this.header(),n.node,r),new LS(r,this.policy())}return this.end()}},{key:"insertSpace",value:function(e,t){this.policy().insertSpace(this.header(),e,t)}},{key:"eraseSpace",value:function(e,t,n){var r=this.doEraseSpace(e,t);n&&n(r)}},{key:"eraseFloat",value:function(e){this.policy().erase(this.header(),e.getNode())}},{key:"position",value:function(e){return e instanceof LS?this.policy().position(e.getNode(),this.header()):e instanceof DS?this.policy().position(e,this.header()):-1}},{key:"findOuter",value:function(e){return new LS(this.policy().findOuter(this.header(),e),this.policy())}},{key:"findInner",value:function(e){return new LS(this.policy().findInner(this.header(),e),this.policy())}},{key:"setDefaultData",value:function(e){return this.policy().setData(this.header(),e)}},{key:"begin",value:function(){return new LS(this.leftMost(),this.policy())}},{key:"end",value:function(){return new LS(this.header(),this.policy())}},{key:"rbegin",value:function(){return new LS(this.rightMost(),this.policy())}}]),t}(ZS),US=function(e){function t(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:TS.Outer;return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).call(this,new DS,e))}return(0,g.Z)(t,e),t}(BS),HS=function(e){function t(e){var n,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,a=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,o=arguments.length>3&&void 0!==arguments[3]&&arguments[3],i=arguments.length>4?arguments[4]:void 0;return(0,y.Z)(this,t),(n=(0,d.Z)(this,(0,v.Z)(t).call(this))).axisDataTree=e,n.from=r,n.to=a,n.isReverse=o,n.baseIterKey=i,n.isReverse?(n.outerIter=n.axisDataTree.findOuter(a),n.innerIter=n.axisDataTree.findInner(a)):(n.outerIter=n.axisDataTree.findOuter(r),n.innerIter=n.axisDataTree.findInner(r)),n}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"next",value:function(){return this.isReverse?this.backward():this.forward()}},{key:"backward",value:function(){if(this.currOuterPos()<=this.from)return null;var e=this.data();if(this.outerIter.postPrev(),this.innerIter.postPrev(),this.baseIterKey)for(var t=this.data();e&&t&&e.value[this.baseIterKey]===t.value[this.baseIterKey];)e.count+=t.count,this.outerIter.postPrev(),this.innerIter.postPrev(),t=this.data();return e}},{key:"forward",value:function(){if(this.currInnerPos()>this.to)return null;var e=this.data();if(this.outerIter.postNext(),this.innerIter.postNext(),this.baseIterKey)for(var t=this.data();e&&t&&e.value[this.baseIterKey]===t.value[this.baseIterKey];)e.count+=t.count,this.outerIter.postNext(),this.innerIter.postNext(),t=this.data();return e}},{key:"data",value:function(){var e=this.currOuterPos(),t=this.currInnerPos(),n=this.currOuterData();if(!n)return null;var r={value:this.baseIterKey?(0,l.Z)({},this.baseIterKey,n[this.baseIterKey]):n,index:t,count:e-t};return this.isInRange(this.from,t,e)&&(r.index=this.from,r.count=e-this.from),this.isInRange(this.to,t,e)&&(r.count=this.to-r.index+1),this.isReverse&&(r.index=r.index+r.count-1),r}},{key:"currOuterPos",value:function(){return this.axisDataTree.position(this.outerIter)}},{key:"currInnerPos",value:function(){return this.axisDataTree.position(this.innerIter)}},{key:"currOuterData",value:function(){return this.outerIter.data()}},{key:"isInRange",value:function(e,t,n){return e<n&&e>=t}}]),t}(Rt.FIterator);function WS(e,t,n,r){if(!(n>=r)){var a=n+r>>1,o=t[a],i=o.endIndex,u=o.info,s=e.rbegin();i===e.position(s)?s.setData(u):e.insertFloat(i,u),WS(e,t,n,a),WS(e,t,a+1,r)}}function jS(e,t){var n,r=[],a=0,o=_n(e);try{for(o.s();!(n=o.n()).done;){var i=n.value;i.startIndex>a&&r.push({startIndex:a,endIndex:i.startIndex,info:{}}),r.push(i),a=i.endIndex}}catch(e){o.e(e)}finally{o.f()}return a<t&&r.push({startIndex:a,endIndex:t,info:{}}),r}function zS(e,t){if(e===t)return!0;var n,r=_n(new Set([].concat((0,m.Z)(Object.keys(e)),(0,m.Z)(Object.keys(t)))));try{for(r.s();!(n=r.n()).done;){var a=n.value;if(e[a]!==t[a])return!1}}catch(e){r.e(e)}finally{r.f()}return!0}var GS=function(){function e(t,n){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:function(e){return null},a=arguments.length>3&&void 0!==arguments[3]?arguments[3]:120;(0,y.Z)(this,e),this.getDefaultSize=t,this.length=n,this.forceSetSize=r,this.cacheBlockSize=a,this._autoSizeChangeHandlers=[],this.forceAutoFitSize=!1,this.axisDistance=new VS(this,this.cacheBlockSize),this.axisDataTree=new US,this.setItems([],this.length)}return(0,C.Z)(e,[{key:"addItems",value:function(e,t){this.axisDataTree.insertSpace(e,t),this.axisDataTree.insertFloat(e,this.getInfo(e)),this.axisDataTree.insertFloat(e+t,{}),this.length+=t,this.clearCache()}},{key:"deleteItems",value:function(e,t){var n=this,r=Math.min(t,this.length-e);r<=0||(this.axisDataTree.eraseSpace(e,r,(function(t){t.length>0&&n.axisDataTree.insertFloat(e,t[0].data)})),this.length-=r,this.clearCache())}},{key:"clearCache",value:function(){this.axisDistance.clear()}},{key:"updateCache",value:function(e){this.axisDistance.clearFrom(e)}},{key:"toJSON",value:function(){for(var e=new Array(this.length),t=this.axisDataTree.begin(),n=this.axisDataTree.end(),r=0;t&&!t.equal(n);){var a=this.axisDataTree.position(t),o=(0,re.Z)(t.data());null==o||delete o.excluded,null==o||delete o.autoFitSize;var i=o&&0===Object.keys(o).length?null:o;e.fill(i,r,a),r=a,t.next()}return e.every((function(e){return null===e}))?[]:e}},{key:"serialize",value:function(e,t){for(var n=this.axisDataTree.begin(),r=this.axisDataTree.end(),a=0;n&&!n.equal(r);){var o=this.axisDataTree.position(n),i={customSize:void 0,hidden:void 0};$S(n.data(),i,t),void 0===i.customSize&&void 0===i.hidden&&void 0===i.formId||e.push({range:{start:a,end:o},info:i}),a=o,n.next()}}},{key:"deserialize",value:function(e){this.clearCache(),this.clearAxisTree();var t=e.map((function(e){var t=e.info,n=e.range;return{info:qS(t)||{},startIndex:(null==n?void 0:n.start)||0,endIndex:(null==n?void 0:n.end)||0}}));t=jS(t,this.length),WS(this.axisDataTree,t,0,t.length)}},{key:"setItems",value:function(e,t){this.clearCache(),this.clearAxisTree(),this.length=t;var n=function(e,t){for(var n=[],r=0;r<e.length;r++){var a=e[r];if(a){var o=n[n.length-1];o&&zS(a,o.info)&&o.endIndex===r?o.endIndex+=1:n.push({startIndex:r,endIndex:r+1,info:a})}}return jS(n,t)}(e,t);WS(this.axisDataTree,n,0,n.length)}},{key:"getRawSize",value:function(e){var t;return null===(t=this.getInfo(e))||void 0===t?void 0:t.fixedSize}},{key:"getSize",value:function(e){var t=this.forceSetSize(e);if(null!==t)return t;if(e<0||e>=this.length)return 0;var n=this.getInfo(e);return this.getSizeFromInfo(n)}},{key:"getActualSize",value:function(e){var t=this.getInfo(e);return t&&void 0!==t.fixedSize?Math.floor(t.fixedSize):0}},{key:"updateExcluded",value:function(e){var t=this;this.resetAllExcluded(),this.mergeConsecutiveNumbers(e).forEach((function(e){var n=e.start,r=e.count;t.setExcluded(n,!0,r)}))}},{key:"setExcluded",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1;n>1?this.batchSetAxisData(e,n,(function(e){return Object.assign({},e,{excluded:t})})):this.setAxisData(e,t,"excluded")}},{key:"setSize",value:function(e,t){var n=this,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1;if(this.updateCache(e),r>1)this.batchSetAxisData(e,r,(function(e){return n.getNewSizeInfo(e,t)}));else{var a=this.getInfo(e),o=this.getNewSizeInfo(a,t);this.setAxisData(e,o)}}},{key:"swap",value:function(e,t){var n=this.getInfo(e),r=this.getInfo(t);this.setItem(t,n),this.setItem(e,r)}},{key:"onAutoSizeChange",value:function(e){this._autoSizeChangeHandlers.push(e)}},{key:"setAutoFitSize",value:function(e,t){var n=this.getSize(e),r=this.getInfo(e);this.setAxisData(e,t,"autoFitSize");var a={after:t};return r&&(a.before=r.autoFitSize),n!==t&&a.before!==a.after&&this._autoSizeChangeHandlers.forEach((function(t){return t(e,a)})),n!==t&&0!==n&&(this.updateCache(e),!0)}},{key:"getVisible",value:function(e){return this.getVisibleFromInfo(this.getInfo(e))}},{key:"getFId",value:function(e){var t,n,r=null===(t=this.getInfo(e))||void 0===t?void 0:t.fId;return null!==r&&(n=r),n}},{key:"setVisible",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1;this.updateCache(e),n>1?this.batchSetAxisData(e,n,(function(e){return Object.assign({},e,{visible:t})})):this.setAxisData(e,t,"visible")}},{key:"setFId",value:function(e,t){this.setAxisData(e,t,"fId"),this.updateCache(e)}},{key:"getRowColIndexByFId",value:function(e){for(var t=this.axisDataTree.begin(),n=this.axisDataTree.end();t&&!t.equal(n);){var r;if((null===(r=t.data())||void 0===r?void 0:r.fId)===e)return this.axisDataTree.position(t)-1;t.next()}return-1}},{key:"iter",value:function(e,t){var n=this,r=arguments.length>2&&void 0!==arguments[2]&&arguments[2];return e=Math.max(0,e),t=Math.min(this.length-1,t),new HS(this.axisDataTree,e,t,r).map((function(e){var t;return{value:null!==(t=e.value)&&void 0!==t&&t.excluded?0:n.getSizeFromInfo(e.value),index:e.index,count:e.count}}))}},{key:"iterVisible",value:function(e,t){var n=this,r=arguments.length>2&&void 0!==arguments[2]&&arguments[2];return e=Math.max(0,e),t=Math.min(this.length-1,t),new HS(this.axisDataTree,e,t,r,"visible").map((function(e){return{value:n.getVisibleFromInfo(e.value),index:e.index,count:e.count}}))}},{key:"iterHidden",value:function(){var e=this;return new HS(this.axisDataTree,0,this.length-1).filter((function(t){return!e.getVisibleFromInfo(t.value)}))}},{key:"iterActualVisible",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]&&arguments[2];return this.iter(e,t,n).filter((function(e){return!!e.value}))}},{key:"iterContinuousActualVisible",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]&&arguments[2];return new JS(this.iterActualVisible(e,t,n))}},{key:"firstVisible",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]&&arguments[2];return this.iter(e,t,n).first_if((function(e){return!!e.value}))}},{key:"iterEachActualVisible",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]&&arguments[2];return this.iterActualVisible(e,t,n).map((function(e){return new tv(e,n)})).flatten()}},{key:"getDistance",value:function(e,t){var n=this.axisDistance.getDistance(e);return this.axisDistance.getDistance(t)-n}},{key:"getPos",value:function(e,t){var n=this.axisDistance.getDistance(e);return this.axisDistance.getPos(n+t).pos}},{key:"clearAxisTree",value:function(){var e=this.axisDataTree.rbegin(),t=this.axisDataTree.position(e);this.axisDataTree.eraseSpace(0,t)}},{key:"getNewSizeInfo",value:function(e,t){var n=Object.assign({},e);return 0===t?delete n.fixedSize:n.fixedSize=t,n}},{key:"setAxisData",value:function(e,t,n){var r=this.axisDataTree.findOuter(e),a=r.data(),o=n?Object.assign({},a,(0,l.Z)({},n,t)):t;a&&zS(o,a)||(this.handleStart(e,a),this.handleEnd(e,r,o))}},{key:"handleStart",value:function(e,t){var n=this.axisDataTree.findInner(e);e!==this.axisDataTree.position(n)&&this.axisDataTree.insertFloat(e,t)}},{key:"handleEnd",value:function(e,t,n){var r=e+1;r!==this.axisDataTree.position(t)?t=this.axisDataTree.insertFloat(r,n):t.setData(n),this.mergeAdjacent(t)}},{key:"batchSetAxisData",value:function(e,t,n){var r=e+t-1,a=r+1,o=this.getInfo(e),i=this.axisDataTree.findOuter(e),u=this.axisDataTree.position(i),s=this.axisDataTree.findOuter(r);if(this.handleStart(e,o),a>u)for(;i&&!i.equal(s);){var l=n(i.data());i.setData(l),this.mergePrev(i),i.next()}var c=n(s.data());this.handleEnd(r,i,c)}},{key:"mergeConsecutiveNumbers",value:function(e){var t=[];if(0===e.size)return t;for(var n=Array.from(e).sort((function(e,t){return e-t})),r=n[0],a=1,o=1;o<n.length;o++)n[o]===n[o-1]+1?a++:(t.push({start:r,count:a}),r=n[o],a=1);return t.push({start:r,count:a}),t}},{key:"resetAllExcluded",value:function(){for(var e=this.axisDataTree.begin(),t=this.axisDataTree.end();e&&!e.equal(t);){var n=e.data();null!=n&&n.excluded&&(null==n||delete n.excluded,e.setData(n),this.mergePrev(e)),e.next()}this.clearCache()}},{key:"mergeAdjacent",value:function(e){this.mergePrev(e),this.mergeNext(e)}},{key:"mergePrev",value:function(e){var t=e.data(),n=e.copy().prev(),r=n.data();return!(!r||!zS(t,r)||(this.axisDataTree.eraseFloat(n),0))}},{key:"mergeNext",value:function(e){var t=e.data(),n=e.copy().next().data();return!!(t&&n&&zS(t,n))&&(this.axisDataTree.eraseFloat(e),!0)}},{key:"setItem",value:function(e,t){this.setAxisData(e,t),this.updateCache(e)}},{key:"getInfo",value:function(e){var t=this.axisDataTree.findOuter(e).data();if(this.forceAutoFitSize&&void 0!==(null==t?void 0:t.fixedSize)){var n=(0,re.Z)(t);return delete n.fixedSize,n}return t}},{key:"getSizeFromInfo",value:function(e){return e?!1===e.visible?0:void 0===e.fixedSize||this.forceAutoFitSize?void 0!==e.autoFitSize?Math.floor(e.autoFitSize):this.getDefaultSize():Math.floor(e.fixedSize):this.getDefaultSize()}},{key:"getVisibleFromInfo",value:function(e){var t=null==e?void 0:e.visible,n=!0;return null!=t&&(n=t),n}},{key:"setForceAutoFitSize",value:function(e){this.forceAutoFitSize=e,this.clearCache()}}]),e}(),JS=function(e){function t(e){var n;(0,y.Z)(this,t),(n=(0,d.Z)(this,(0,v.Z)(t).call(this)))._iter=e,n._curr=null,n._info=null,n._isFirst=!0;var r=n._iter.next();return r&&(n._curr={index:r.index,count:r.count}),n}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"value",value:function(){return this._isFirst?(this._isFirst=!1,this.next()):this._info?this._info:null}},{key:"next",value:function(){if(!this._curr)return null;this._isFirst&&(this._isFirst=!1);var e,t=this._curr;for(e=this._iter.next();e&&e.index===t.index+t.count;e=this._iter.next())t.count+=e.count;return this._curr=e?{index:e.index,count:e.count}:null,this._info=t,this.value()}}]),t}(Rt.FIterator);function qS(e){if(!e)return null;var t={fixedSize:void 0,visible:void 0};return null!=e.customSize&&(t.fixedSize=e.customSize),null!=e.hidden&&(t.visible=!e.hidden),null!=e.formId&&(t.fId=e.formId),t}function $S(e,t,n){if(!e)return!1;var r=!1;return void 0!==e.fixedSize&&(t.customSize=e.fixedSize,r=!0),n&&void 0!==e.autoFitSize&&void 0===e.fixedSize&&(t.customSize=e.autoFitSize,r=!0),!1===e.visible&&(t.hidden=!e.visible,r=!0),void 0!==e.fId&&(t.formId=e.fId,r=!0),r}var YS,KS=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"next",value:function(){return null}}]),t}(Rt.FIterator),XS=function(){function e(t){(0,y.Z)(this,e),this.sheet=t,this.rowAxisModel=this.sheet._getRowInfos(),this.colAxisModel=this.sheet._getColInfos(),this.sheetModel=this.sheet._getModel(),this.spanModel=this.sheet._getSpanModel()}return(0,C.Z)(e,[{key:"iterVisibleRange",value:function(e,t,n,r,a){var o,i=this;return a&&a.visibleRange?Rt.FIterator.fromArray(a.visibleRange):this.rowAxisModel.iterContinuousActualVisible(e,n).map((function(e){return o?Rt.FIterator.fromArray(o).map((function(t){return new Oi(e.index,t.index,e.count,t.count,i.sheet)})):(o=[],i.colAxisModel.iterContinuousActualVisible(t,r).map((function(t){return o.push(t),new Oi(e.index,t.index,e.count,t.count,i.sheet)})))})).flatten()}},{key:"iterVisibleCell",value:function(e,t,n,r,a){return a&&a.visibleCell?Rt.FIterator.fromArray(a.visibleCell):this.iterVisibleRange(e,t,n,r,a).map((function(e){return new QS(e)})).flatten()}},{key:"iterVisibleSpan",value:function(e,t,n,r,a){var o=this;if(a&&a.visibleSpan)return Rt.FIterator.fromArray(a.visibleSpan);var i=new sv;return this.iterVisibleRange(e,t,n,r,a).map((function(e){return o.spanModel.iter(e.rowFrom(),e.colFrom(),e.rowTo(),e.colTo())})).flatten().map((function(e){return{row:e.rowFrom(),col:e.colFrom()}})).filter((function(e){var t=e.row,n=e.col;return!i.has(t,n)&&(i.add(t,n),!0)}))}},{key:"iterVisibleSpanIntersectRange",value:function(e,t,n,r,a){var o=this;return this.spanModel.length?this.iterVisibleRange(e,t,n,r,a).map((function(e){return o.spanModel.iter(e.rowFrom(),e.colFrom(),e.rowTo(),e.colTo()).map((function(t){return[t,t.intersect(e)]})).filter((function(e){return!!e[1]}))})).flatten():new KS}},{key:"iterVisibleCellSpan",value:function(e,t,n,r,a){var o=this;if(a&&a.visibleCellSpan)return Rt.FIterator.fromArray(a.visibleCellSpan);var i,u=this.iterVisibleCell(e,t,n,r,a);return a&&a.visibleSpanSet&&0===a.visibleSpanSet.size||0===this.spanModel.length?u:(i=a&&a.visibleSpanSet?function(e){var t=e.row,n=e.col;return!a.visibleSpanSet.has(t,n)}:function(e){var t=e.row,n=e.col;return!o.spanModel.find(t,n)},u.filter(i).chain(this.iterVisibleSpan(e,t,n,r,a)))}},{key:"visibleCellSpanValueFactory",value:function(e,t,n,r,a,o){var i,u,s=this;o&&o.visibleRange&&o.visibleSpan?(i=Rt.FIterator.fromArray(o.visibleRange),u=Rt.FIterator.fromArray(o.visibleSpan)):(i=this.iterVisibleRange(e,t,n,r,o),u=this.iterVisibleSpan(e,t,n,r,o));var l,c=i.map((function(e){return a(e.rowFrom(),e.colFrom(),e.rowCount(),e.colCount())})).flatten();return o&&o.visibleSpan&&0===o.visibleSpan.length||0===this.spanModel.length?c:(l=o&&o.visibleSpanSet?function(e){var t=(0,p.Z)(e,2)[1],n=t.row,r=t.col;return!o.visibleSpanSet.has(n,r)}:function(e){var t=(0,p.Z)(e,2)[1],n=t.row,r=t.col;return!s.spanModel.find(n,r)},c.filter(l).chain(u.map((function(e){return a(e.row,e.col,1,1).first()||void 0})).filter((function(e){return!!e}))))}},{key:"iterVisibleContent",value:function(e,t,n,r,a){var o=this;return this.visibleCellSpanValueFactory(e,t,n,r,(function(e,t,n,r){return o.sheetModel.iterContentWithPos(e,t,n,r)}),a)}},{key:"visibleSegmentFactory",value:function(e,t,n,r,a,o){return this.iterVisibleContent(e,t,n,r,o).map((function(e){var t=e[0];if(t&&t.segmentArray&&t.segmentArray.length){var n=t.segmentArray.find((function(e){return e.type===a}));return n?[n,e[1]]:void 0}})).filter((function(e){return!!e}))}},{key:"visibleFormulaCustomVar",value:function(e,t,n,r,a,o){var i=this;return this.iterVisibleContent(e,t,n,r,o).map((function(e){var t=e[0].variant;if(t&&!t.isNull()&&function(e,t){var n=e.isFormula()||zf(e)?e.getVar():e;return n.isCustomPrimitive()&&n.customType===t}(t,a)&&!i.sheet.options.showFormulaText)return[t.getValue(),e[1]]})).filter((function(e){return!!e}))}},{key:"iterVisibleImage",value:function(e,t,n,r,a){var o=new Set;return this.visibleSegmentFactory(e,t,n,r,"embed-image",a).chain(this.visibleFormulaCustomVar(e,t,n,r,"SheetImageVar",a)).filter((function(e){var t=e[1].row+"_"+e[1].col;return!o.has(t)&&(o.add(t),!0)}))}},{key:"iterVisibleVar",value:function(e,t,n,r,a){var o=this;return this.iterVisibleContent(e,t,n,r,a).map((function(e){var t=e[0];if(t.multipleValues){var n=t.multipleValues.mergeToString({formatter:null});if(n&&""!==n)return e[1]}else if(t.segmentArray){var r=new xv(o.sheet.parent,t.segmentArray).getText(o.sheet.parent.userLanguage);if(r&&""!==r)return e[1]}else if(t.variant)return e[1]})).filter((function(e){return!!e}))}},{key:"iterVisibleSegmentArray",value:function(e,t,n,r,a){return this.iterVisibleContent(e,t,n,r,a).map((function(e){var t=e[0];return t&&t.segmentArray?[t.segmentArray,e[1]]:void 0})).filter((function(e){return!!e}))}},{key:"iterVisibleStyle",value:function(e,t,n,r,a){var o=this;return this.visibleCellSpanValueFactory(e,t,n,r,(function(e,t,n,r){return o.sheetModel.iterStyleWithPos(e,t,n,r)}),a)}},{key:"iterVisibleDropdown",value:function(e,t,n,r,a){var o=this;return this.visibleCellSpanValueFactory(e,t,n,r,(function(e,t,n,r){return o.sheetModel.iterDropdownWithPos(e,t,n,r)}),a)}},{key:"iterVisibleDataValidation",value:function(e,t,n,r,a){var o=this;return this.visibleCellSpanValueFactory(e,t,n,r,(function(e,t,n,r){return o.sheet.iterDataValidationWithPos(e,t,n,r)}),a)}},{key:"iterVisibleSparkline",value:function(e,t,n,r,a){var o=this;return this.visibleCellSpanValueFactory(e,t,n,r,(function(e,t,n,r){return o.sheet.iterSparklineWithPos(e,t,n,r)}),a)}},{key:"iterVisibleComment",value:function(e,t,n,r,a){var o=this;return this.visibleCellSpanValueFactory(e,t,n,r,(function(e,t,n,r){return o.sheetModel.iterCommentWithPos(e,t,n,r)}),a)}},{key:"iterVisibleNote",value:function(e,t,n,r,a){var o=this;return this.visibleCellSpanValueFactory(e,t,n,r,(function(e,t,n,r){return o.sheetModel.iterNoteWithPos(e,t,n,r)}),a)}},{key:"iterVisibleReminder",value:function(e,t,n,r,a){var o=this;return this.visibleCellSpanValueFactory(e,t,n,r,(function(e,t,n,r){return o.sheetModel.iterReminderWithPos(e,t,n,r)}),a)}},{key:"generatorIterCtx",value:function(e){var t=this,n=[],r=[],a=[],o=[],i=new sv,u=new sv;return e.forEach((function(e){var s=[],l=[];t.iterVisibleRange(e.y,e.x,e.maxY-1,e.maxX-1).forEach((function(e){s.push(e),n.push(e)})),t.iterVisibleSpanIntersectRange(e.y,e.x,e.maxY-1,e.maxX-1,{visibleRange:s}).forEach((function(e){var t=(0,p.Z)(e,2),n=t[0],a=t[1],o={row:n.rowFrom(),col:n.colFrom()};u.has(o.row,o.col)||(u.add(o.row,o.col),l.push(o),r.push(o));for(var s=a.rowFrom(),c=a.colFrom(),h=a.rowTo(),f=a.colTo(),d=s;d<=h;d++)for(var v=c;v<=f;v++)i.add(d,v)})),t.iterVisibleCell(e.y,e.x,e.maxY-1,e.maxX-1,{visibleRange:s}).forEach((function(e){a.push(e)})),t.iterVisibleCellSpan(e.y,e.x,e.maxY-1,e.maxX-1,{visibleRange:s,visibleSpan:l,visibleSpanSet:i}).forEach((function(e){o.push(e)}))})),{visibleRange:n,visibleSpan:r,visibleCell:a,visibleCellSpan:o,visibleSpanSet:i}}}]),e}(),QS=function(e){function t(e){var n;return(0,y.Z)(this,t),(n=(0,d.Z)(this,(0,v.Z)(t).call(this))).range=e,n.index=0,n.isDone=!1,n}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"next",value:function(){return this.index?(this.col++,this.col>this.colTo&&(this.col=this.colFrom,this.row++,this.row>this.rowTo&&(this.isDone=!0))):(this.row=this.range.rowFrom(),this.col=this.range.colFrom(),this.rowTo=this.range.rowTo(),this.colTo=this.range.colTo(),this.colFrom=this.col),this.isDone?null:(this.isDone||this.index++,{row:this.row,col:this.col})}}]),t}(Rt.FIterator);!function(e){e[e.Set=0]="Set",e[e.Add=1]="Add",e[e.Del=2]="Del",e[e.Refresh=3]="Refresh"}(YS||(YS={}));var eE=function(){function e(t){var n=this;(0,y.Z)(this,e),this.chartMap=t,this.refreshBlockSet=new Set,this.oldChartBlock=new Map,this.raiseRefresh=nE((function(){var e=n.refreshBlockSet;e.size>0&&(e.forEach((function(e,t){var r=n.chartMap[t];r&&n.raiseChartChange(t,3,r)})),n.clearRefresh())})),this.raiseChange=nE((function(){var e=n.oldChartBlock;return e.size>0&&(e.forEach((function(e,t){var r=n.chartMap[t];r&&n.raiseChartChange(t,0,r)})),n.clearChange()),e}))}return(0,C.Z)(e,[{key:"markChartChange",value:function(e){this.oldChartBlock.has(e)||(this.oldChartBlock.set(e,this.chartMap[e]),this.chartMap[e]=(0,Re.default)(this.chartMap[e]))}},{key:"markChartRefresh",value:function(e){return this.refreshBlockSet.add(e)}},{key:"hasMarkedRefresh",value:function(e){return this.refreshBlockSet.has(e)}},{key:"hasMarkedChange",value:function(e){return this.oldChartBlock.has(e)}},{key:"clearRefresh",value:function(){this.refreshBlockSet=new Set}},{key:"clearChange",value:function(){this.oldChartBlock=new Map}},{key:"registerChartChange",value:function(e){this.chartChangeHandle=e}},{key:"unRegisterChartChange",value:function(){this.chartChangeHandle=void 0}},{key:"raise",value:function(){this.raiseRefresh(),this.raiseChange()}},{key:"raiseChartChange",value:function(e,t,n){this.chartChangeHandle&&this.chartChangeHandle({chartId:e,changeType:t,chart:n})}}]),e}(),tE=function(){function e(t){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};(0,y.Z)(this,e),this.sheet=t,this._chartMap=n,this.addRowOrColForRange=(0,ne.Z)((function(e,t,n,r,a){return a[n]>=e?Object.assign({},a,(0,l.Z)({},n,a[n]+t)):a[n]+a[r]>e?Object.assign({},a,(0,l.Z)({},r,a[r]+t)):a})),this.delRowOrColForRange=(0,ne.Z)((function(e,t,n,r,a){var o=a[n],i=a[n]+a[r]-1,u=e,s=e+t-1;if(s<o)return Object.assign({},a,(0,l.Z)({},n,o-t));if(u<=o&&o<=s){var c,h=i-s;return h>0?Object.assign({},a,(c={},(0,l.Z)(c,n,u),(0,l.Z)(c,r,h),c)):void 0}if(o<u&&u<=i){var f=i-s;return f<0&&(f=0),Object.assign({},a,(0,l.Z)({},r,u-o+f))}return a})),this.hideRowOrColForRange=function(e,t,n,r,a){var o=a[n],i=a[n]+a[r]-1,u=e+t-1;return u<o||e<=o&&o<=u||o<e&&e<=i},this.changeManager=new eE(n)}return(0,C.Z)(e,[{key:"getChangeManager",value:function(){return this.changeManager}},{key:"fromJSON",value:function(e){this._chartMap=(0,Re.default)(e)||{}}},{key:"toJSON",value:function(){return(0,Re.default)(this._chartMap)}},{key:"registerChartChange",value:function(e){this.changeManager.registerChartChange(e)}},{key:"addChart",value:function(e,t){if(!e||e!==t.chartId)throw new Error("Please make sure your id correct");return this._chartMap[e]?(console.error("id 为 ".concat(e," 的 chart 已经存在")),!1):(this._chartMap[e]=(0,Re.default)(t),this.changeManager.raiseChartChange(e,1,t),!0)}},{key:"setChart",value:function(e,t,n){if(!e||e!==t.chartId)throw new Error("Please make sure your id correct");return n||this._chartMap[e]?(this._chartMap[e]=(0,Re.default)(t),this.changeManager.raiseChartChange(e,0,t),!0):(console.error("id 为 ".concat(e," 的 chart 不存在")),!1)}},{key:"deleteChart",value:function(e){var t=this._chartMap[e];return t?(delete this._chartMap[e],this.changeManager.raiseChartChange(e,2,t),!0):(console.error("id 为 ".concat(e," 的 chart 不存在")),!1)}},{key:"getChartById",value:function(e){return this._chartMap[e]}},{key:"getChartMap",value:function(){return this._chartMap}},{key:"addRowOrColForTarget",value:function(e,t,n){return n>=e?n+t:n}},{key:"delRowOrColForTarget",value:function(e,t,n){var r=e+t-1;return n>=e&&n<=r?e>0?e-1:0:n>r?n-t:n}},{key:"getAxisAdjustFn",value:function(e){if("add"===e)return this.addRowOrColForRange;if("del"===e)return this.delRowOrColForRange;throw new Error("error function type")}},{key:"getTargetAdjustFn",value:function(e){if("add"===e)return this.addRowOrColForTarget;if("del"===e)return this.delRowOrColForTarget;throw new Error("error function type")}},{key:"setChartChange",value:function(e,t,n){(0,te.Z)(this._chartMap[e],t,n)}},{key:"rangeAdjust",value:function(e){var t=this,n=e.index,r=e.count,a=e.indexKey,o=e.countKey,i=e.type,u=this.getAxisAdjustFn(i),s=this.getTargetAdjustFn(i);this._chartMap=(0,H.Z)(this._chartMap,(function(e,i){var l=u(n,r,a,o);if(s(n,r,e.blockSetting[a])!==e.blockSetting[a]){t.changeManager.markChartChange(i);var c=s(n,r,e.blockSetting[a]);t.setChartChange(i,"blockSetting.".concat(a),c)}var h=e.graphSetting.dataRanges.reduce((function(e,n){var r=l(n);return r!==n&&t.changeManager.markChartChange(i),r&&e.push(r),e}),[]);t.setChartChange(i,"graphSetting.dataRanges",h)}))}},{key:"setValue",value:function(e,t){if(0!==Object.keys(this._chartMap).length){var n=this.changeManager;(0,H.Z)(this._chartMap,(function(r,a){if(!n.hasMarkedRefresh(a)){var o,i=_n(r.graphSetting.dataRanges);try{for(i.s();!(o=i.n()).done;){var u=o.value;if(u.row<=e&&u.row+u.rowCount>=e+1&&u.col<=t&&u.col+u.colCount>=t+1)return n.markChartRefresh(a)}}catch(e){i.e(e)}finally{i.f()}}})),this.changeManager.raise()}}},{key:"tryRefreshChart",value:function(e){var t=this,n=!1,r=this.changeManager;return Object.entries(this._chartMap).forEach((function(a){var o=(0,p.Z)(a,2),i=o[0],u=o[1];r.hasMarkedRefresh(i)||u.graphSetting.dataRanges.some((function(n){var r=new Oi(n.row,n.col,n.rowCount,n.colCount,t.sheet);return e.isIntersect(r)}))&&(r.markChartRefresh(i),n=!0)})),n&&this.changeManager.raise(),n}},{key:"setRowColInfoChange",value:function(e,t){var n=this.changeManager;(0,H.Z)(this._chartMap,(function(r,a){if(!n.hasMarkedRefresh(a)){var o=r.blockSetting,i=o.row,u=o.col;("row"===t&&i>e||"col"===t&&u>e)&&n.markChartRefresh(a)}})),this.changeManager.raise()}},{key:"addRows",value:function(e,t){return this.rangeAdjust({index:e,count:t,indexKey:"row",countKey:"rowCount",type:"add"}),this.changeManager.raise()}},{key:"addColumns",value:function(e,t){return this.rangeAdjust({index:e,count:t,indexKey:"col",countKey:"colCount",type:"add"}),this.changeManager.raise()}},{key:"removeRows",value:function(e,t){return this.rangeAdjust({index:e,count:t,indexKey:"row",countKey:"rowCount",type:"del"}),this.changeManager.raise()}},{key:"removeColumns",value:function(e,t){return this.rangeAdjust({index:e,count:t,indexKey:"col",countKey:"colCount",type:"del"}),this.changeManager.raise()}},{key:"setRowColVisible",value:function(e,t,n){var r=this,a="row"===n?"rowCount":"colCount";return(0,H.Z)(this._chartMap,(function(o,i){o.graphSetting.dataRanges.find((function(o){return r.hideRowOrColForRange(e,t,n,a,o)}))&&r.changeManager.markChartRefresh(i)})),this.changeManager.raise()}},{key:"frozen",value:function(e,t){var n=this;return(0,H.Z)(this._chartMap,(function(r,a){var o=r.blockSetting,i=o.row,u=o.col;("col"===e&&t>u||"row"===e&&t>i)&&(n.changeManager.markChartChange(a),n.setChartChange(a,"blockSetting.".concat(e),t))})),this.changeManager.raise()}},{key:"filter",value:function(e,t){var n=this;return(0,H.Z)(this._chartMap,(function(e,t){n.changeManager.markChartRefresh(t)})),this.changeManager.raise()}},{key:"checkDelInfluence",value:function(e,t,n){var r="row"===e?"rowCount":"colCount",a=new Map,o=this.getAxisAdjustFn("del");return(0,H.Z)(this._chartMap,(function(i,u){i.blockSetting[e]>=t+n?a.set(u,i):i.graphSetting.dataRanges.find((function(s){return o(t,n,e,r,s)!==s&&(a.set(u,i),!0)}))})),a}},{key:"checkFreezeInfluence",value:function(e,t){var n=new Map;return(0,H.Z)(this._chartMap,(function(r,a){var o=r.blockSetting,i=o.row,u=o.col;(e>i||t>u)&&n.set(a,r)})),n}}],[{key:"fromJSON",value:function(t,n){return new e(t,(0,Re.default)(n))}},{key:"createDefault",value:function(e,t,n,r){var a=e.id(),o=r.blockSetting,i=r.usingDefaultSetting;e.isSingleCellOrSpan(n)&&(n=[e.extendSelectedRangeForMergeCell(Qd(e,n[0].clone()))]);var u={title:"",type:"bar",xAxisPos:"col",dataRanges:n.map((function(e){return{sheetId:a,row:e.rowFrom(),col:e.colFrom(),rowCount:e.rowCount(),colCount:e.colCount()}})),isStack:!1,combineDirection:"horizontal",isDataLabelShown:!1,isTitleHidden:!1,isGridLineHidden:!1,legendPosition:0,isAggregate:!1,hasLabels:!0,hasHeaders:!0,chartColorType:we.DqO.ColorA,mainYaxisMaxValue:"",mainYaxisMinValue:""},s={chartId:(0,we.zsn)(10),sheetId:a,blockSetting:o,graphSetting:u};return e.parent.graphDataGenerator.detectWhileCreating(s,i),s}}]),e}();function nE(e){var t;return window.cancelAnimationFrame?function(){var n=this,r=arguments;t||window.requestAnimationFrame&&(t=requestAnimationFrame((function(){t=null,e.apply(n,r)})))}:function(){}}tE.defaultBlockRect={x:0,y:0,width:500,height:370};var rE,aE=function(e){var t;return window.cancelAnimationFrame?function(){var n=this,r=arguments;t||window.requestAnimationFrame&&(t=requestAnimationFrame((function(){t=null,e.apply(n,r)})))}:function(){}};!function(e){e[e.Add=0]="Add",e[e.Set=1]="Set",e[e.Del=2]="Del",e[e.Refresh=3]="Refresh"}(rE||(rE={}));var oE=function(){function e(t){var n=this;(0,y.Z)(this,e),this._blocksMap=t,this.refreshBlockSet=new Set,this.oldEmbeddedBlocks=new Map,this.raiseRefresh=aE((function(){var e=n.refreshBlockSet;e.size>0&&(e.forEach((function(e,t){var r=n._blocksMap[t];r&&n.raiseEmbeddedBlockChange(t,3,r)})),n.clearRefresh())})),this.raiseChange=aE((function(){var e=n.oldEmbeddedBlocks;return e.size>0&&(e.forEach((function(e,t){var r=n._blocksMap[t];r&&n.raiseEmbeddedBlockChange(t,1,r)})),n.clearChange()),e}))}return(0,C.Z)(e,[{key:"markBlockChange",value:function(e){this.oldEmbeddedBlocks.has(e)||(this.oldEmbeddedBlocks.set(e,this._blocksMap[e]),this._blocksMap[e]=(0,Re.default)(this._blocksMap[e]))}},{key:"markBlockRefresh",value:function(e){return this.refreshBlockSet.add(e)}},{key:"hasMarkedRefresh",value:function(e){return this.refreshBlockSet.has(e)}},{key:"hasMarkedChange",value:function(e){return this.oldEmbeddedBlocks.has(e)}},{key:"clearRefresh",value:function(){this.refreshBlockSet=new Set}},{key:"clearChange",value:function(){this.oldEmbeddedBlocks=new Map}},{key:"hasChangeHandler",value:function(){return Boolean(this.embeddedBlockChangeHandler)}},{key:"registerEmbeddedBlockChangeHandler",value:function(e){this.embeddedBlockChangeHandler=e}},{key:"unregisterFloatBlockChangeHandler",value:function(){this.embeddedBlockChangeHandler=void 0}},{key:"raise",value:function(){this.raiseRefresh(),this.raiseChange()}},{key:"raiseAllBlocksSet",value:function(){var e=this;Object.keys(this._blocksMap).forEach((function(t){var n=e._blocksMap[t];n&&e.raiseEmbeddedBlockChange(t,1,n)}))}},{key:"raiseEmbeddedBlockChange",value:function(e,t,n){var r;null===(r=this.embeddedBlockChangeHandler)||void 0===r||r.call(this,{blockToken:e,changeType:t,embeddedBlock:n})}}]),e}(),iE=function(){function e(t){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};(0,y.Z)(this,e),this.sheet=t,this._blocksMap={},this._blocksMap=n,this.changeManager=new oE(n)}return(0,C.Z)(e,[{key:"getChangeManager",value:function(){return this.changeManager}},{key:"registerEmbeddedBlockChangeHandler",value:function(e){this.changeManager.registerEmbeddedBlockChangeHandler(e)}},{key:"setBlock",value:function(e,t,n){if(!e||e!==t.blockToken)throw new Error("Please make sure your blockToken correct");return n||this._blocksMap[e]?(this._blocksMap[e]=(0,Re.default)(t),this.changeManager.raiseEmbeddedBlockChange(e,1,t),!0):(console.error("blockToken 为 ".concat(e," 的 embeddedBlock 不存在")),!1)}},{key:"delBlock",value:function(e){if(!this._blocksMap[e])return console.error("blockToken 为 ".concat(e," 的 embeddedBlock 不存在")),!1;var t=this._blocksMap[e];return delete this._blocksMap[e],this.changeManager.raiseEmbeddedBlockChange(e,2,t),this.sheet.dispatch("EmbeddedBlockChanged",{sheetId:this.sheet.id(),embeddedBlockChangeParams:{changeType:2,embeddedBlock:t,blockToken:e}}),!0}},{key:"raiseAllBlocksSet",value:function(){var e=this;this.changeManager.raiseAllBlocksSet(),Object.keys(this._blocksMap).forEach((function(t){var n=e._blocksMap[t];n&&e.sheet.dispatch("EmbeddedBlockChanged",{sheetId:e.sheet.id(),embeddedBlockChangeParams:{changeType:1,embeddedBlock:n,blockToken:t}})}))}},{key:"getBlock",value:function(e){return this._blocksMap[e]}},{key:"getBlocksMap",value:function(){return this._blocksMap}},{key:"toJSON",value:function(){return(0,Re.default)(this._blocksMap)}},{key:"serialize",value:function(){var e=(0,l.Z)({},xt.kH.PIVOT_TABLE,we.B2l.EmbeddedBlockType.EmbeddedBlockType_PIVOT_TABLE);return Object.values(this._blocksMap).filter((function(t){return Boolean(e[t.blockType])})).map((function(t){var n=t.position;return{id:t.blockToken,cell:{startRow:n.row,startCol:n.col},blockType:e[t.blockType]}}))}},{key:"addRows",value:function(e,t,n){this.adjustBlockPos4AddRows(e,t),this.changeManager.raise()}},{key:"addColumns",value:function(e,t,n){this.adjustBlockPos4AddCols(e,t),this.changeManager.raise()}},{key:"removeRows",value:function(e,t){this.adjustBlockPos4DelRows(e,t),this.changeManager.raise()}},{key:"removeColumns",value:function(e,t){this.adjustBlockPos4DelCols(e,t),this.changeManager.raise()}},{key:"updateEmbeddedBlockMap",value:function(e,t,n){(0,te.Z)(this._blocksMap[e],t,n)}},{key:"_isBlockAdjustedByRowColChange",value:function(e,t){return t>=e}},{key:"getBlockTokensToAdjust",value:function(e,t,n){var r=this,a=Object.keys(this._blocksMap).filter((function(n){var a=r._blocksMap[n];return r._isBlockAdjustedByRowColChange(e,a.position[t])})),o="add"===n?function(e,t){return t-e}:function(e,t){return e-t};return a.sort((function(e,n){var a=[e,n].map((function(e){return r._blocksMap[e]})),i=(0,p.Z)(a,2),u=i[0],s=i[1];return o(u.position[t],s.position[t])}))}},{key:"adjustBlockPos4AddRows",value:function(e,t){var n=this;this.getBlockTokensToAdjust(e,"row","add").forEach((function(r){var a=n._blocksMap[r],o=a.position,i=n.getNewTarget4Add(e,t,o.row);i!==o.row&&(n.updateEmbeddedBlockMap(r,"position.row",i),n.changeManager.markBlockRefresh(r),n.sheet.dispatch("EmbeddedBlockChanged",{sheetId:n.sheet.id(),embeddedBlockChangeParams:{changeType:3,embeddedBlock:a,blockToken:r}}))}))}},{key:"adjustBlockPos4AddCols",value:function(e,t){var n=this;this.getBlockTokensToAdjust(e,"col","add").forEach((function(r){var a=n._blocksMap[r],o=a.position,i=n.getNewTarget4Add(e,t,o.col);i!==o.col&&(n.updateEmbeddedBlockMap(r,"position.col",i),n.changeManager.markBlockRefresh(r),n.sheet.dispatch("EmbeddedBlockChanged",{sheetId:n.sheet.id(),embeddedBlockChangeParams:{changeType:3,embeddedBlock:a,blockToken:r}}))}))}},{key:"adjustBlockPos4DelRows",value:function(e,t){var n=this,r=this.getBlockTokensToAdjust(e,"row","del"),a=this.sheet.getRowCount()-1;r.forEach((function(r){var o=n._blocksMap[r],i=o.position,u=n.getNewTarget4Del(e,t,i.row),s=Math.min(u,a);s!==i.row&&(u<0?n.delBlock(r):(n.updateEmbeddedBlockMap(r,"position.row",s),n.changeManager.markBlockRefresh(r),n.sheet.dispatch("EmbeddedBlockChanged",{sheetId:n.sheet.id(),embeddedBlockChangeParams:{changeType:3,embeddedBlock:o,blockToken:r}})))}))}},{key:"adjustBlockPos4DelCols",value:function(e,t){var n=this,r=this.getBlockTokensToAdjust(e,"col","del"),a=this.sheet.getColumnCount()-1;r.forEach((function(r){var o=n._blocksMap[r],i=o.position,u=n.getNewTarget4Del(e,t,i.col),s=Math.min(u,a);s!==i.col&&(s<0?n.delBlock(r):(n.updateEmbeddedBlockMap(r,"position.col",s),n.changeManager.markBlockRefresh(r),n.sheet.dispatch("EmbeddedBlockChanged",{sheetId:n.sheet.id(),embeddedBlockChangeParams:{changeType:3,embeddedBlock:o,blockToken:r}})))}))}},{key:"getNewTarget4Add",value:function(e,t,n){return n<e?n:n+t}},{key:"getNewTarget4Del",value:function(e,t,n){return n<e?n:n<=e+t-1?-1:n-t}}],[{key:"createDefault",value:function(e,t,n,r){return{blockToken:e,blockType:t,position:n,blockSetting:r}}},{key:"fromJSON",value:function(t,n){return new e(t,(0,Re.default)(n))}}]),e}(),uE=function(){function e(t){(0,y.Z)(this,e),this.sheet=t,this.getColumnCount=this.sheet.getColumnCount.bind(this.sheet),this.getRowCount=this.sheet.getRowCount.bind(this.sheet)}return(0,C.Z)(e,[{key:"id",get:function(){return this.sheet.id()}}]),e}();uE=Gi([(0,ct.b)(),Ji(0,(0,ht.f)(Pd))],uE);var sE=function(){function e(t,n,r){(0,y.Z)(this,e),this.sheet=t,this.watchHub=n,this.sheetInfo=r,this.selectionsToString=Ch}return(0,C.Z)(e,[{key:"createRange",value:function(e,t,n,r){return new Oi(e,t,n,r,this.sheet)}},{key:"createRanges",value:function(e){return new vu(e,this.sheet)}},{key:"createRowOp",value:function(e,t,n){return new Wi(!0,"add"===e?"add":"delete",t,n,this.sheet)}},{key:"createColOp",value:function(e,t,n){return new Wi(!1,"add"===e?"add":"delete",t,n,this.sheet)}},{key:"createWatchedRange",value:function(e,t,n,r){var a=this,o=this.createRange(e,t,n,r);o.$=new vt.X(o);var i=o.onOp.bind(o);return o.onOp=function(){var e=i.apply(void 0,arguments);return o.$.next(o),e},this.watchHub.watchRef(o,null),o.destroy=function(){a.watchHub.unWatchRef(o,null)},o}},{key:"isOverflowRange",value:function(e){var t=this.sheetInfo.getRowCount(),n=this.sheetInfo.getColumnCount(),r=e.rowFrom(),a=e.colFrom(),o=e.rowFrom()+e.rowCount(!0),i=e.colFrom()+e.colCount(!0);return r>t||a>n||o>t||i>n}},{key:"rangeStringToRange",value:function(e){return Xk(this.sheet,e)}}]),e}();sE=Gi([(0,ct.b)(),Ji(0,(0,ht.f)(Pd)),Ji(1,(0,ht.f)(Ld)),Ji(2,(0,ht.f)(uE))],sE);var lE=function(e,t){return e.row===t.row&&e.col===t.col&&e.rowCount===t.rowCount&&e.colCount===t.colCount},cE=function e(){var t=this;(0,y.Z)(this,e),this.actionEventBus$=new gt.xQ,this.lifeCycle$=new gt.xQ,this.lifeCycle$.subscribe((function(e){"destroy"===e.type&&(t.actionEventBus$.complete(),t.lifeCycle$.complete())}))};cE=Gi([(0,ct.b)()],cE);function hE(e){return e.replace(/\s/g," ").trim()}function fE(e){return[fn("LarkCCM_Sheets_Filter_Jan"),fn("LarkCCM_Sheets_Filter_Feb"),fn("LarkCCM_Sheets_Filter_Mar"),fn("LarkCCM_Sheets_Filter_Apr"),fn("LarkCCM_Sheets_Filter_May"),fn("LarkCCM_Sheets_Filter_Jun"),fn("LarkCCM_Sheets_Filter_Jul"),fn("LarkCCM_Sheets_Filter_Aug"),fn("LarkCCM_Sheets_Filter_Sep"),fn("LarkCCM_Sheets_Filter_Oct"),fn("LarkCCM_Sheets_Filter_Nov"),fn("LarkCCM_Sheets_Filter_Dec")][e-1]}function dE(e,t,n){var r=t.filterRange,a=[],o=[];if(!r)return{valueList:a,allValueList:o};var i=t.getFilterInfo(n),u=new Map,s=new Map,l=r.rowFrom(),c=r.rowCount(),h=t.getAllFilteredOutRows();function f(t,n,r,a){if(a&&we.Ps3.getSheetFilterDateAggregationEnabled()){var o=e.getValue(n,r),i={shouldShow:!1,count:0,isFilteredOut:!0,isDate:!0,value:o,cellValue:o};if("number"==typeof o){var l=ke.SheetDate.fromNumber(o),c=l.year,h=l.month,f=l.date,d=[String(c),String(h),String(f)],v=d[0],g=d[1],m=d[2],p=s.get(v);p||(p=Object.assign({},i,{internationalValue:[v],children:{}}));var y=p.children[g];y||(y=Object.assign({},i,{internationalValue:[String(h)],children:{}}),p.children[g]=y);var C=y.children[m];return C||(C=Object.assign({},i,{internationalValue:[m],children:{},cellLabel:t}),y.children[m]=C),s.set(v,p),p}}var _=u.get(t);if(!_){var R=e.getValue(n,r),w=e.getInternationalText(n,r),k={shouldShow:!1,count:0,isDate:!1,isFilteredOut:!0,children:{},value:R};Array.isArray(w)&&(k.internationalValue=w.map((function(e){return hE(e)}))),_=k,u.set(t,_)}return _}for(var d=function(r){var a=e.getSpan(r,n),o=a?a.rowFrom():r,i=a?a.colFrom():n,u=hE(e.getText(o,i)),s=yE(e,o,i),c=f(u,o,i,s),d=a?a.rowCount(!0):1;o===l&&(d-=1);for(var g=e.getValue(o,i),m=ke.SheetDate.fromNumber(g),p=m.month,y=m.date,C=c,_=String(p),R=String(y),w=C.children[_],k=0;k<d;k++)if(t.isRowNotFilteredOutByOtherColumn(r+k,n)&&(c.shouldShow=!0,c.count+=1,s&&we.Ps3.getSheetFilterDateAggregationEnabled()&&w)){w.shouldShow=!0,w.count+=1;var S=w.children[R];S&&(S.shouldShow=!0,S.count+=1)}if(Array.from({length:d},(function(e,t){return r+t})).some((function(e){return!h.has(e)}))&&(c.isFilteredOut=!1,s&&we.Ps3.getSheetFilterDateAggregationEnabled()&&w)){w.isFilteredOut=!1;var E=w.children[R];E&&(E.isFilteredOut=!1)}v=r+=d-1},v=l+1;v<l+c;v++)d(v);return u.forEach((function(e,t){var n=e.value,r=e.shouldShow,u=e.isFilteredOut,s=e.internationalValue,l=e.count,c=function(e){var i={label:t,value:t,cellValue:n,checked:e,count:l,staged:!1,isDate:!1};r&&a.push(i),o.push(i)};if(null==i)return c(!0);if(null!=i.type&&!u)return c(!0);if(Array.isArray(i.contents)&&i.contents.length){var h=i.contents,f=function(e){return h.includes(e)},d=0===(null==i?void 0:i.type)&&1===(null==i?void 0:i.compare)||!1;if(Array.isArray(s)){if(s.some(f))return c(!d)}else if(f(t))return c(!d)}return c(!1)})),s.forEach((function(e,t){var n=e.shouldShow,r=e.isFilteredOut,u=e.count,s=e.children,l=function(e){var r=arguments.length>1&&void 0!==arguments[1]&&arguments[1],l={label:fn("LarkCCM_Sheets_Filter_Year",{num:t}),value:"@@DATE@@".concat(t),checked:e,count:u,staged:!1,isDate:!0,cellValue:Number(t)};return n&&a.push(l),o.push(l),l.children=Object.entries(s).map((function(e){var n,a=(0,p.Z)(e,2),o=a[0],u=a[1];return{value:"@@DATE@@".concat(t,"/").concat(o),cellValue:Number(o),label:fE(Number(o)),checked:r||(null==i||null===(n=i.dateGroups)||void 0===n?void 0:n.some((function(e){return String(e.year)===String(t)&&String(e.month)===String(o)})))||!u.isFilteredOut,count:u.count,staged:!1,isDate:!0,children:Object.entries(u.children).map((function(e){var n,a=(0,p.Z)(e,2),u=a[0],s=a[1];return{value:"@@DATE@@".concat(t,"/").concat(o,"/").concat(u),cellLabel:s.cellLabel,cellValue:Number(u),label:fn("LarkCCM_Sheets_Filter_Date",{num:Number(u)}),checked:r||(null==i||null===(n=i.dateGroups)||void 0===n?void 0:n.some((function(e){return String(e.year)===String(t)&&String(e.month)===String(o)&&String(e.day)===String(u)})))||!s.isFilteredOut,count:s.count,isDate:!0,staged:!1}})).filter((function(e){return e.count>0}))}})).filter((function(e){return e.count>0})),l};if(null==i)return l(!0,!0);if(null!=i.type&&!r)return l(!0);if(Array.isArray(i.dateGroups)&&i.dateGroups.length){var c=0===(null==i?void 0:i.type)&&1===(null==i?void 0:i.compare)||!1;if(i.dateGroups.some((function(e){return String(e.year)===String(t)})))return l(!c)}return l(!1)})),{valueList:a,allValueList:o}}function vE(e){var t=e.sheet();if(!t)return!1;var n=t.sheetFilterModel,r=t.filterModel,a=t.sheetFilterModel.filterRange;if(!a)return!1;var o=e.startRow,i=e.endRow,u=a.startRow,s=a.endRow;if(o>=s||u>=i)return!1;var l=n.getFilteredOutRows(),c=r.getFilteredOutRows();return(0,$.Z)(l,c).some((function(e){return o<e+1&&e<i}))}var gE=Gt.Cb,mE=Gt.xA;function pE(e,t,n){for(var r=new Set,a=e.row,o=e.col,i=0;i<e.rowCount;i++){var u=n(a+i,o),s=u?u.rowFrom():a+i,l=t(s,u?u.colFrom():o),c=u?u.rowCount(!0):1;if(s<a&&(c-=1),l&&(r.add(a+i),c>1))for(var h=1;h<c;h++)r.add(a+i+h);i+=c-1}return r}function yE(e,t,n){var r=e.getValue(t,n);if(r<0||!Number.isSafeInteger(ke.SheetDate.fromNumber(r).year))return!1;var a=e.getActualFormatter(t,n);return!(!a||!(0,Se.hasDate)(a)||/^a{3,}$/i.test(a.getFormatCode())||/^d{3,}$/i.test(a.getFormatCode()))}var CE=function(){function e(t){(0,y.Z)(this,e),this.sheetFacade=t,this.tryParseFloat=function(e){var t=e.trim(),n=t.indexOf("%")===t.length-1,r=parseFloat(t);return Number.isNaN(r)?e:n?r/100:r}}return(0,C.Z)(e,[{key:"filterByMultiValueConditionRule",value:function(e,t,n,r){var a=this,o=(null==r?void 0:r.reduce((function(e,t){return t.dateTimeGrouping===we.fmI.DateTimeGrouping_YEAR&&t.year?e[t.year]=!0:t.dateTimeGrouping===we.fmI.DateTimeGrouping_MONTH&&t.year&&t.month?(e[t.year]=e[t.year]||{},e[t.year][t.month]=!0):t.dateTimeGrouping===we.fmI.DateTimeGrouping_DAY&&t.year&&t.month&&t.day&&(e[t.year]=e[t.year]||{},e[t.year][t.month]=e[t.year][t.month]||{},e[t.year][t.month][t.day]=!0),e}),{}))||{},i=function(e){var t=e.year,n=e.month,r=e.date;return!0===o[t]||void 0!==o[t]&&(!0===o[t][n]||void 0!==o[t][n]&&!0===o[t][n][r])};return pE(e,(function(e,r){var o=a.getInternationalText(e,r);if(yE(a.sheetFacade,e,r)){var u=a.sheetFacade.getValue(e,r);if("number"==typeof u){var s=i(ke.SheetDate.fromNumber(u)),l=o.some((function(e){return t.has(e)}));return Boolean(n)===(s||l)}}var c=o.some((function(e){return t.has(e)}));return Boolean(n)===c}),(function(e,t){return a.sheetFacade.getSpan(e,t)}))}},{key:"getInternationalText",value:function(e,t){var n=this.sheetFacade.getInternationalText(e,t);return Array.isArray(n)?n.map(hE):[hE(n||"")]}},{key:"filterByNumberConditionRule",value:function(e,t,n){var r=this,a=(0,p.Z)(n,2),o=a[0],i=a[1],u=function(e){return new Map([[0,function(e){var t=e.getNumber1,n=e.getValue,r=t(),a=n();return"string"==typeof r&&(r=r.trim()),"string"==typeof a&&(a=a.trim()),r===a}],[1,function(e){var t=e.getNumber1,n=e.getValue,r=t(),a=n();return"string"==typeof r&&(r=r.trim()),"string"==typeof a&&(a=a.trim()),r!==a}],[2,function(e){var t=e.getNumber1,n=(0,e.getValue)(),r=t();return(0,_.Z)(n)==(0,_.Z)(r)&&n>r}],[3,function(e){var t=e.getNumber1,n=(0,e.getValue)(),r=t();return(0,_.Z)(n)==(0,_.Z)(r)&&n>=r}],[4,function(e){var t=e.getNumber1,n=(0,e.getValue)(),r=t();return(0,_.Z)(n)==(0,_.Z)(r)&&n<r}],[5,function(e){var t=e.getNumber1,n=(0,e.getValue)(),r=t();return(0,_.Z)(n)==(0,_.Z)(r)&&n<=r}],[6,function(e){var t,n=e.getNumber1,r=e.getValue,a=e.getNumber2,o=n(),i=a();o>i&&(o=(t=[i,o])[0],i=t[1]);var u=r();return(0,_.Z)(u)==(0,_.Z)(o)&&(0,_.Z)(u)==(0,_.Z)(i)&&o<=u&&u<=i}],[7,function(e){var t,n=e.getNumber1,r=e.getValue,a=e.getNumber2,o=n(),i=a();o>i&&(o=(t=[i,o])[0],i=t[1]);var u=r();return(0,_.Z)(u)==(0,_.Z)(o)&&(0,_.Z)(u)==(0,_.Z)(i)&&(o>u||u>i)}]]).get(e)}(t);if(!u)return new Set;var s=function(){return r.tryParseFloat(o)},l=function(){return i?r.tryParseFloat(i):0};return pE(e,(function(e,t){return!u({getNumber1:s,getNumber2:l,getValue:function(){return r.sheetFacade.getValueWithStringFormatter(e,t)}})}),(function(e,t){return r.sheetFacade.getSpan(e,t)}))}},{key:"filterByTextConditionRule",value:function(e,t,n){var r=this,a=function(e){return new Map([[2,function(e){var t=e.compareText,n=e.cellText,r=(0,ee.Z)(n);return(0,Q.Z)(r,t)}],[3,function(e){var t=e.compareText,n=e.cellText,r=(0,ee.Z)(n);return!(0,Q.Z)(r,t)}],[4,function(e){var t=e.compareText,n=e.cellText,r=(0,X.Z)(n);return(0,K.Z)(r,t)}],[5,function(e){var t=e.compareText,n=e.cellText,r=(0,X.Z)(n);return!(0,K.Z)(r,t)}],[6,function(e){var t=e.compareText,n=e.cellText;return(0,Y.Z)(n,t)}],[7,function(e){var t=e.compareText,n=e.cellText;return!(0,Y.Z)(n,t)}]]).get(e)}(t);return a?pE(e,(function(e,t){var o=r.sheetFacade.getText(e,t);return!a({compareText:(0,q.Z)(n),cellText:(0,q.Z)(o)})}),(function(e,t){return r.sheetFacade.getSpan(e,t)})):new Set}},{key:"filterByColorConditionRule",value:function(e,t,n){var r=this,a=1===t?mE:gE,o=1===t?"foreColor":"backColor";return pE(e,(function(e,i){var u=r.sheetFacade.getStyle(e,i),s=(0,J.default)(u,o,a);if(1===t){var l=r.sheetFacade.getSegmentArray(e,i);if(l)return!r.foreColorIsEqForSegment(l,n,s)}return(0,we.XvZ)(n)!==(0,we.XvZ)(s)}),(function(e,t){return r.sheetFacade.getSpan(e,t)}))}},{key:"foreColorIsEqForSegment",value:function(e,t,n){for(var r=function(r){var a=function(){var t=e[r];return t.style&&t.style.foreColor||n}();if((0,we.XvZ)(a)===(0,we.XvZ)(t))return{v:!0}},a=0;a<e.length;a++){var o=r(a);if("object"===(0,_.Z)(o))return o.v}return!1}},{key:"convertNotEqualToEqualValues",value:function(e,t,n){var r=dE(this.sheetFacade,e,t).valueList,a=[];return r.forEach((function(e){n.includes(e.value)||a.push(e.value)})),a}}]),e}();CE=Gi([(0,ct.b)(),Ji(0,(0,ht.f)(zd))],CE);var _E=function(){function e(t,n,r,a){var o=this;(0,y.Z)(this,e),this.filterRuleHelper=t,this.rangeFactory=n,this.filterWatchedRefHub=r,this.eventBus=a,this.active=!0,this.hiddenRows$=new vt.X(new Set),this.getCompareTypeAndConditionTypeForEnum=function(){return o.compareType&&o.translateCompareTypeToEnum(o.compareType)||[]},this.translateCompareTypeToEnum=function(e){return new Map([["BeginsWith",[2,2]],["DoesNotBeginWith",[3,2]],["EndsWith",[4,2]],["DoesNotEndWith",[5,2]],["Contains",[6,2]],["DoesNotContain",[7,2]],["BackgroundColor",[0,3]],["ForegroundColor",[1,3]],["Equal",[0,1]],["NotEqual",[1,1]],["Greater",[2,1]],["GreaterOrEqual",[3,1]],["Less",[4,1]],["LessOrEqual",[5,1]],["Between",[6,1]],["NotBetween",[7,1]],["ValueEqual",[0,0]],["ValueNotEqual",[1,0]]]).get(e)},this.getFilteredRows=function(){return(0,m.Z)(o.hiddenRows$.getValue()).sort((function(e,t){return e-t}))},this.getConditionJSON=function(e){if(void 0!==e){var t=o.translateCompareTypeToEnum(e),n=(0,p.Z)(t,2),r=n[0],a=n[1];switch(o.compareType){case"ValueEqual":var i=(0,m.Z)(o.params).map((function(e){return{compareType:0,conType:2,contents:null,expected:e}}));return Array.isArray(o.dateGroups)&&o.dateGroups.length>0?[{compareType:0,conType:2,dateGroups:o.dateGroups}].concat((0,m.Z)(i)):i;case"ValueNotEqual":return(0,m.Z)(o.params).map((function(e){return{compareType:1,conType:0,contents:null,expected:e}}));default:return[{compareType:r,conType:a,contents:null,expected:o.params}]}}},this.lifeCycleSubscribe=this.eventBus.lifeCycle$.subscribe((function(e){"destroy"===e.type&&o.destroy()}))}return(0,C.Z)(e,[{key:"setActive",value:function(e,t){if(this.active!==e){if(this.active=e,!this.active)return this.reset();t||this.reCalc()}}},{key:"reset",value:function(){this.hiddenRows$.next(new Set)}},{key:"reCalc",value:function(){var e=this.range,t=this.compareType,n=this.dateGroups;this.active&&e&&this.setFilterRuleAndCalculate({row:e.rowFrom(),col:e.colFrom(),rowCount:e.rowCount()},t,this.params,n)}},{key:"getRange",value:function(){return this.range?{col:this.range.colFrom(),row:this.range.rowFrom(),rowCount:this.range.rowCount(),colCount:1}:{col:-1,row:-1,rowCount:0,colCount:1}}},{key:"destroy",value:function(){this.lifeCycleSubscribe.unsubscribe(),this.range&&this.filterWatchedRefHub.unWatchRef(this.range,null)}},{key:"onAddRows",value:function(e,t){var n=this.hiddenRows$.getValue();if(n.size>0){var r=Array.from(n).map((function(n){return n>=e?n+t:n}));this.hiddenRows$.next(new Set(r))}}},{key:"onDelRows",value:function(e,t){var n=this.hiddenRows$.getValue();if(n.size>0){var r=Array.from(n).filter((function(n){return!(e<=n&&n<e+t)})).map((function(n){return n>=e+t?n-t:n}));this.hiddenRows$.next(new Set(r))}}},{key:"onMoveRange",value:function(e,t){var n=this.hiddenRows$.getValue(),r=t.rowFrom()-e.rowFrom();if(0!==r&&0!==n.size){var a=Array.from(n).map((function(e){return e+r}));this.hiddenRows$.next(new Set(a))}}},{key:"createWatchRange",value:function(e){var t=this.range;t&&this.filterWatchedRefHub.unWatchRef(t,null);var n=this.rangeFactory.createRange(e.row,e.col,e.rowCount,1);return this.filterWatchedRefHub.watchRef(n,null),n}},{key:"updateRange",value:function(e,t){this.range=this.createWatchRange(e),this.active&&t&&this.reCalc()}},{key:"updateHiddenRowsFromSnapshot",value:function(e){this.hiddenRows$.next(new Set((0,m.Z)(e)))}},{key:"setFilterRuleAndCalculate",value:function(e,t,n,r,a){if(this.range=this.createWatchRange(e),this.params=n,this.dateGroups=r,this.compareType=t,this.isValid&&this.active){if(void 0===this.translateCompareTypeToEnum(t))throw new Error("setFilterRuleAndCalculate params error");var o=a?new Set(a):this.getHiddenRows(e,t,n,r);this.hiddenRows$.next(o)}}},{key:"getHiddenRows",value:function(e,t,n,r){var a,o=this.translateCompareTypeToEnum(t);if(void 0===o)throw new Error("setFilterRuleAndCalculate params error");var i=(0,p.Z)(o,1)[0];switch(t){case"BeginsWith":case"DoesNotBeginWith":case"EndsWith":case"DoesNotEndWith":case"Contains":case"DoesNotContain":a=this.filterRuleHelper.filterByTextConditionRule(e,i,n);break;case"BackgroundColor":case"ForegroundColor":a=this.filterRuleHelper.filterByColorConditionRule(e,i,n);break;case"Equal":case"NotEqual":case"Greater":case"GreaterOrEqual":case"Less":case"LessOrEqual":case"Between":case"NotBetween":a=this.filterRuleHelper.filterByNumberConditionRule(e,i,Array.isArray(n)?n:[n]);break;case"ValueEqual":a=this.filterRuleHelper.filterByMultiValueConditionRule(e,n,!1,r);break;case"ValueNotEqual":a=this.filterRuleHelper.filterByMultiValueConditionRule(e,n,!0,r);break;default:throw new Error("setFilterRuleAndCalculate params error")}return a}},{key:"isRowVisible",value:function(e){var t=this.hiddenRows$.getValue();return!this.isValid||!t.has(e)}},{key:"toJSON",value:function(){var e=this.getFilteredRows();return{conditions:this.getConditionJSON(this.compareType),filteredRows:e,index:this.getRange().col}}},{key:"serialize",value:function(e,t){var n=this.getRange().col,r=this.getFilteredRows(),a={};switch(this.compareType){case"ValueEqual":case"ValueNotEqual":var o,i=Array.from(this.params);if(o="ValueNotEqual"===this.compareType?this.filterRuleHelper.convertNotEqualToEqualValues(e,n,i):i,t){var u=o.map((function(e){return t.filterStrings.addValue(e)}));a.multiFilters={filterIds:u},this.dateGroups&&(a.multiFilters.dateGroupItemIds=this.dateGroups.map((function(e){return t.dateGroupItems.add(e).id})))}else a.multiFilters={filters:o},this.dateGroups&&(a.multiFilters.dateGroupItems=this.dateGroups);break;case"BackgroundColor":case"ForegroundColor":a.colorFilter={value:this.params,cellColor:"BackgroundColor"===this.compareType};break;case"Between":a.customFilters={customFilter:[{operator:we.B2l.CustomFilterOperator.CustomFilterOperator_GreaterThanOrEqual,value:this.params[0]},{operator:we.B2l.CustomFilterOperator.CustomFilterOperator_LessThanOrEqual,value:this.params[1]}],and:!0};break;case"NotBetween":a.customFilters={customFilter:[{operator:we.B2l.CustomFilterOperator.CustomFilterOperator_LessThanOrEqual,value:this.params[0]},{operator:we.B2l.CustomFilterOperator.CustomFilterOperator_GreaterThanOrEqual,value:this.params[1]}],and:!1};break;default:if(this.compareType){var s=function(e){switch(e){case"Equal":return we.B2l.CustomFilterOperator.CustomFilterOperator_Equal;case"NotEqual":return we.B2l.CustomFilterOperator.CustomFilterOperator_NotEqual;case"Greater":return we.B2l.CustomFilterOperator.CustomFilterOperator_GreaterThan;case"GreaterOrEqual":return we.B2l.CustomFilterOperator.CustomFilterOperator_GreaterThanOrEqual;case"Less":return we.B2l.CustomFilterOperator.CustomFilterOperator_LessThan;case"LessOrEqual":return we.B2l.CustomFilterOperator.CustomFilterOperator_LessThanOrEqual;case"BeginsWith":return we.B2l.CustomFilterOperator.CustomFilterOperator_BeginsWith;case"DoesNotBeginWith":return we.B2l.CustomFilterOperator.CustomFilterOperator_DoesNotBeginWith;case"EndsWith":return we.B2l.CustomFilterOperator.CustomFilterOperator_EndsWith;case"DoesNotEndWith":return we.B2l.CustomFilterOperator.CustomFilterOperator_DoesNotEndWith;case"Contains":return we.B2l.CustomFilterOperator.CustomFilterOperator_Contains;case"DoesNotContain":return we.B2l.CustomFilterOperator.CustomFilterOperator_DoesNotContain;default:return}}(this.compareType);a.customFilters={customFilter:[{operator:s,value:this.params}]}}}return{colId:n-e.filterRange.colFrom(),condition:a,filteredRows:r}}},{key:"isValid",get:function(){return!!this.range&&this.range.isValid()}}]),e}();_E=Gi([(0,ct.b)(),Ji(0,(0,ht.f)(CE)),Ji(1,(0,ht.f)(sE)),Ji(2,(0,ht.f)(Ld)),Ji(3,(0,ht.f)(cE))],_E);var RE=function(e,t){if(2===e)switch(t){case 2:return"BeginsWith";case 3:return"DoesNotBeginWith";case 4:return"EndsWith";case 5:return"DoesNotEndWith";case 6:return"Contains";case 7:return"DoesNotContain"}if(1===e)switch(t){case 0:return"Equal";case 1:return"NotEqual";case 2:return"Greater";case 3:return"GreaterOrEqual";case 4:return"Less";case 5:return"LessOrEqual";case 6:return"Between";case 7:return"NotBetween"}if(3===e)switch(t){case 0:return"BackgroundColor";case 1:return"ForegroundColor"}if(0===e)switch(t){case 0:return"ValueEqual";case 1:return"ValueNotEqual"}return null};var wE=function(){function e(t,n,r){var a=this;(0,y.Z)(this,e),this.rangeFactory=t,this.createInstance=n,this.eventBus=r,this.currentRange$=new vt.X(void 0),this.filterRulesSet$=new vt.X(new Set),this.pauseLock$=new vt.X(!1),this.filteredOutRows$=(0,mt.aj)(this.filterRulesSet$.pipe((0,Zt.w)((function(e){return e.size?(0,mt.aj)((0,m.Z)(e).map((function(e){return e.hiddenRows$}))):(0,pt.of)([new Set])}))),this.pauseLock$).pipe((0,Dt.h)((function(e){var t=(0,p.Z)(e,2);t[0];return!t[1]&&a.active})),(0,Pt.map)((function(e){return function(e){return e.reduce((function(e,t){return t.forEach((function(t){return e.add(t)})),e}),new Set)}((0,p.Z)(e,1)[0])})),(0,Lt.d)(1)),this.filteredOutRows=new Set,this.active=!0,this.filteredOutRowsSub=this.filteredOutRows$.subscribe((function(e){return a.filteredOutRows=e})),this.getAllRuleSorted=function(){return(0,m.Z)(a.filterRulesSet).sort((function(e,t){return e.getRange().col-t.getRange().col}))},this.dataEventSub=this.eventBus.actionEventBus$.subscribe((function(e){switch(e.type){case"addRows":a.onAddRows(e.row,e.count);break;case"deleteRows":a.onDelRows(e.row,e.count);break;case"deleteCols":a.onDeleteCols(e.col,e.count);break;case"moveRange":var t=e.sourceRange,n=e.targetRange,r=a.filterRange;r&&t&&n&&t.contain(r)&&a.onMoveRange(t,n)}}))}return(0,C.Z)(e,[{key:"destroy",value:function(){var e,t;this.filterRulesSet.forEach((function(e){return e.destroy()})),null!==(e=this.filterRange)&&void 0!==e&&e.destroy(),this.filteredOutRowsSub.unsubscribe(),null===(t=this.dataEventSub)||void 0===t||t.unsubscribe()}},{key:"recalc",value:function(){this.getValidFilterRules().forEach((function(e){return e.reCalc()}))}},{key:"setActive",value:function(e){var t=this;this.active!==e&&(this.active=e,this.getValidFilterRules().forEach((function(e){e.setActive(t.active)})))}},{key:"getFilterRange",value:function(){var e=this.filterRange;return e?e.toJSON():{col:-1,row:-1,colCount:0,rowCount:0}}},{key:"getAllFilteredOutRows",value:function(){return this.filteredOutRows}},{key:"getFilterRules",value:function(e){var t=this.filterRulesSet$.getValue(),n=new Map,r=this.filterRange;if(!r)return n;var a=r.colFrom(),o=r.colTo();return t.forEach((function(t){var r=t.getRange().col;(!e||r>=a&&r<=o)&&n.set(r,t)})),n}},{key:"getValidFilterRules",value:function(){return this.getFilterRules(!0)}},{key:"hasFilter",value:function(){return Boolean(this.filterRange)}},{key:"hasRule",value:function(){return this.getValidFilterRules().size>0}},{key:"getFilteredOutRows",value:function(){var e=this.getAllFilteredOutRows();return e?(0,m.Z)(e).sort((function(e,t){return e-t})):[]}},{key:"toJSON",value:function(){var e=this.filterRange;if(e){var t=e.toJSON();t.row+=1,t.rowCount-=1;var n=this.getAllRuleSorted(),r=this.getFilteredOutRows();return{range:t,filteredColumns:n.map((function(e){return e.getRange().col})),filteredOutRows:r,filterItemMap:n.map((function(e){return e.toJSON()}))}}}},{key:"serialize",value:function(e){var t=this,n=this.filterRange;if(n){var r=this.getAllRuleSorted().map((function(n){return n.serialize(t,e)}));return{range:n.toGridJSON(),filterColumns:r}}}},{key:"deserialize",value:function(e,t){var n=this,r=e.range,a=r.startRow,o=r.startCol,i=r.endRow,u=r.endCol;this.setRange({row:a,col:o,rowCount:i-a,colCount:u-o});var s=e.filterColumns;null==s||s.forEach((function(e){var r=e.colId,a=e.condition,i=e.filteredRows,u=void 0===i?[]:i,s=o+r;if(null!=a&&a.multiFilters){var l,c,h,f,d=[],v=[];null!==(l=a.multiFilters.filters)&&void 0!==l&&l.length?d=a.multiFilters.filters:(null===(c=a.multiFilters.filterIds)||void 0===c?void 0:c.length)&&(null==t?void 0:t.filterStrings)&&(d=a.multiFilters.filterIds.map((function(e){return t.filterStrings[e]}))),null!==(h=a.multiFilters.dateGroupItems)&&void 0!==h&&h.length?v=a.multiFilters.dateGroupItems:(null===(f=a.multiFilters.dateGroupItemIds)||void 0===f?void 0:f.length)&&(null==t?void 0:t.dateGroupItems)&&(v=a.multiFilters.dateGroupItemIds.map((function(e){return t.dateGroupItems[e]}))),n.setFilterForHuman(s,"ValueEqual",d,u,v)}else if(null!=a&&a.customFilters){var g=a.customFilters,m=g.customFilter,p=g.and;if(1===(null==m?void 0:m.length)){var y=m[0],C=y.operator,_=y.value,R=function(e){switch(e){case we.B2l.CustomFilterOperator.CustomFilterOperator_Equal:return"Equal";case we.B2l.CustomFilterOperator.CustomFilterOperator_NotEqual:return"NotEqual";case we.B2l.CustomFilterOperator.CustomFilterOperator_GreaterThan:return"Greater";case we.B2l.CustomFilterOperator.CustomFilterOperator_GreaterThanOrEqual:return"GreaterOrEqual";case we.B2l.CustomFilterOperator.CustomFilterOperator_LessThan:return"Less";case we.B2l.CustomFilterOperator.CustomFilterOperator_LessThanOrEqual:return"LessOrEqual";case we.B2l.CustomFilterOperator.CustomFilterOperator_BeginsWith:return"BeginsWith";case we.B2l.CustomFilterOperator.CustomFilterOperator_DoesNotBeginWith:return"DoesNotBeginWith";case we.B2l.CustomFilterOperator.CustomFilterOperator_EndsWith:return"EndsWith";case we.B2l.CustomFilterOperator.CustomFilterOperator_DoesNotEndWith:return"DoesNotEndWith";case we.B2l.CustomFilterOperator.CustomFilterOperator_Contains:return"Contains";case we.B2l.CustomFilterOperator.CustomFilterOperator_DoesNotContain:return"DoesNotContain";default:return"Equal"}}(C);n.setFilterForHuman(s,R,_,u)}else if(2===(null==m?void 0:m.length)){var w=[m[0].value,m[1].value],k=p?"Between":"NotBetween";n.setFilterForHuman(s,k,w,u)}}else if(null!=a&&a.colorFilter){var S=a.colorFilter.value,E=a.colorFilter.cellColor?"BackgroundColor":"ForegroundColor";n.setFilterForHuman(s,E,S,u)}}))}},{key:"setRange",value:function(e,t){var n=e.row,r=e.col,a=e.rowCount,o=e.colCount,i=this.rangeFactory.createWatchedRange(n,r,a,o),u=!!this.filterRange&&i.equal(this.filterRange);u?i.destroy():(this.disposePreviousRange(),this.currentRange$.next(i)),this.pauseLock$.next(!0);var s,l=_n(this.filterRulesSet);try{for(l.s();!(s=l.n()).done;){var c=s.value,h=c.getRange().col;h<=i.colTo()&&h>=i.colFrom()?(this.active&&c.setActive(!0,!0),u?t&&c.reCalc():c.updateRange({row:i.rowFrom()+1,col:h,rowCount:i.rowCount()-1},t)):c.setActive(!1)}}catch(e){l.e(e)}finally{l.f()}var f=this.filterRulesSet$.getValue();this.filterRulesSet$.next(f),this.pauseLock$.next(!1)}},{key:"removeRange",value:function(){this.disposePreviousRange(),this.currentRange$.next(void 0)}},{key:"disposePreviousRange",value:function(){var e;null===(e=this.filterRange)||void 0===e||e.destroy()}},{key:"isVisible",value:function(e){return!this.filteredOutRows.has(e)}},{key:"isCompletelyFilteredOut",value:function(){if(!this.filterRange)return!0;var e=this.filteredOutRows.size;return 0!==e&&e===this.filterRange.rowCount(!0)-1}},{key:"removeFilter",value:function(){this.removeRange(),this.filterRulesSet$.getValue().forEach((function(e){return e.destroy()})),this.filterRulesSet$.next(new Set)}},{key:"setFilterForHuman",value:function(e,t,n,r,a){var o=this.filterRange;if(o){var i=o.colTo(),u=o.colFrom();if(!(e>i||e<u)){var s=this.createInstance(_E);s.setActive(this.active);var l=this.getRuleByCol(e);l&&this.removeFilterRule(l),this.setFilterDry(s,e,o,t,n,r,a);var c=this.filterRulesSet$.getValue();return c.add(s),this.filterRulesSet$.next(c),s}console.warn("invalida range col")}else console.warn("please call set range before set filter")}},{key:"setFilterDry",value:function(e,t,n,r,a,o,i){var u={row:n.rowFrom()+1,col:t,rowCount:n.rowCount()-1};switch(r){case"BeginsWith":case"DoesNotBeginWith":case"EndsWith":case"DoesNotEndWith":case"Contains":case"DoesNotContain":case"BackgroundColor":case"ForegroundColor":case"Equal":case"NotEqual":case"Greater":case"GreaterOrEqual":case"Less":case"LessOrEqual":case"Between":case"NotBetween":e.setFilterRuleAndCalculate(u,r,a,i,o);break;case"ValueEqual":case"ValueNotEqual":e.setFilterRuleAndCalculate(u,r,Boolean(a)?Array.isArray(a)?new Set(a):a:new Set,i,o);break;default:throw new Error("setFilterRuleAndCalculate params error")}}},{key:"filterWithNewRule",value:function(e,t,n,r,a,o){var i=this.filterRange;if(!i)return[];var u=t-i.colFrom(),s=[];if(null===e)s[u]=[];else{var l=this.createInstance(_E),c=RE(e,n);this.setFilterDry(l,t,i,c,a||r,void 0,o);var h=l.getFilteredRows();l.destroy(),s[u]=h}return this.recalcRuleExepctForCol(t,s),s}},{key:"recalcRuleExepctForCol",value:function(e,t){for(var n=this.getValidFilterRules(),r=this.getFilterRange(),a=r.col,o=r.colCount,i=0;i<o;i++){var u=a+i;if(u!==e){var s=n.get(u);if(s){if(s.reCalc(),t){var l=s.getFilteredRows();t[i]=l}}else t&&(t[i]=[])}}}},{key:"removeFilterRuleByCol",value:function(e){var t=this.getRuleByCol(e);return!!t&&(this.removeFilterRule(t),!0)}},{key:"setFilter",value:function(e,t,n){var r=RE(t.conType,t.compareType);if(n&&this.updateHiddenRowsFromSync(e,n),null!==t.expected){if(r){var a=e-this.getFilterRange().col;this.setFilterForHuman(e,r,t.expected,n?n[a]:void 0,t.dateGroups)}}else this.removeFilterRuleByCol(e)}},{key:"updateHiddenRowsFromSync",value:function(e,t){for(var n=this.getValidFilterRules(),r=this.getFilterRange(),a=r.col,o=r.colCount,i=0;i<o;i++){var u=a+i;if(u!==e){var s=n.get(u);s&&t[i]&&s.updateHiddenRowsFromSnapshot(t[i])}}}},{key:"getInfo",value:function(){return this.hasFilter()?{range:this.filterRange,filteredOutRows:this.filteredOutRows}:null}},{key:"getAllFilteredOutRowsArray",value:function(){return Array.from(this.getAllFilteredOutRows()).sort((function(e,t){return e-t}))}},{key:"getFilterInfo",value:function(e){if(!this.hasFilter())return null;var t=this.getValidFilterRules().get(e);if(!t)return null;var n=t.getCompareTypeAndConditionTypeForEnum(),r=(0,p.Z)(n,2),a=r[0],o=r[1],i=this.getFilteredRowsMap();return 0===o?Object.assign({col:e,type:0,compare:a,expected:"",contents:(0,m.Z)(t.params),filteredRowsMap:i},t.dateGroups?{dateGroups:t.dateGroups}:{}):Object.assign({col:e,type:o,compare:a,expected:t.params,contents:null,filteredRowsMap:i},t.dateGroups?{dateGroups:t.dateGroups}:{})}},{key:"getFilteredRowsMap",value:function(){for(var e=this.getValidFilterRules(),t=[],n=this.getFilterRange(),r=0;r<n.colCount;r++){var a=n.col+r,o=e.get(a);t[r]=o?o.getFilteredRows():[]}return t}},{key:"removeFilterRule",value:function(e){e.destroy();var t=this.filterRulesSet;t.delete(e),this.filterRulesSet$.next(t)}},{key:"getRuleByCol",value:function(e){var t,n=_n(this.filterRulesSet);try{for(n.s();!(t=n.n()).done;){var r=t.value;if(r.getRange().col===e)return r}}catch(e){n.e(e)}finally{n.f()}}},{key:"isRowNotFilteredOutByOtherColumn",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]&&arguments[2];if(n)return!1;var r=this.filterRange;if(!r)return!0;if(t<r.colFrom()||t>r.colTo())return!0;var a,o=_n(this.getValidFilterRules());try{for(o.s();!(a=o.n()).done;){var i=(0,p.Z)(a.value,2),u=i[0],s=i[1];if(u!==t&&!s.isRowVisible(e))return!1}}catch(e){o.e(e)}finally{o.f()}return!0}},{key:"getFilterButton",value:function(e,t){if(!this.filterRange)return null;var n=this.getFilterRange();if(e!==n.row)return null;if(t>=n.col+n.colCount||t<n.col)return null;var r=this.getValidFilterRules();return{row:e,col:t,active:Boolean(r.get(t)),filteredRowCount:0}}},{key:"onAddRows",value:function(e,t){this.filterRulesSet.forEach((function(n){return n.onAddRows(e,t)}))}},{key:"onDelRows",value:function(e,t){this.filterRulesSet.forEach((function(n){return n.onDelRows(e,t)}))}},{key:"onDeleteCols",value:function(e,t){for(var n=0;n<t;n++)this.removeFilterRuleByCol(n+e)}},{key:"onMoveRange",value:function(e,t){this.filterRulesSet.forEach((function(n){return n.onMoveRange(e,t)}))}},{key:"filterRange",get:function(){return this.currentRange$.getValue()}},{key:"filterRulesSet",get:function(){return this.filterRulesSet$.getValue()}},{key:"info",get:function(){return this.getInfo()}}]),e}();wE=Gi([(0,ct.b)(),Ji(0,(0,ht.f)(sE)),Ji(1,(0,ht.f)(Bd)),Ji(2,(0,ht.f)(cE))],wE);var kE=function(e){if(e){var t={conType:null===e.type?0:e.type,col:e.col,compareType:e.compare,expected:null===e.type?e.contents:e.expected};return e.dateGroups&&e.dateGroups.length>0&&(t.dateGroups=e.dateGroups),0===e.type&&(t.expected=e.contents),e.filteredRowsMap&&(t.filteredRowsMap=e.filteredRowsMap),t}},SE=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),t}(wE),EE=function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},n=t.sheetRowCount,r=null==e.rowCount?1:e.rowCount+1,a=e.row>0?e.row-1:0;return void 0!==n&&a+r-1>=n&&(r=Math.max(1,n-a)),{col:e.col,colCount:e.colCount,row:a,rowCount:r}},TE=function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},r=e.range,a=e.filterItemMap;return t.setRange(EE(r,n)),a&&a.forEach((function(e){var n=e.index,r=e.conditions,a=e.filteredRows?e.filteredRows:[];if(r&&r[0]){var o=r[0],i=o.conType,u=o.compareType,s=o.expected,l=o.dateGroups;if(2===i&&0===u){var c,h=new Set,f=[],d=_n(r);try{for(d.s();!(c=d.n()).done;){var v=c.value;Array.isArray(v.expected)||(0,ae.Z)(v.expected)||h.add(v.expected),Array.isArray(v.dateGroups)&&f.push.apply(f,(0,m.Z)(v.dateGroups))}}catch(e){d.e(e)}finally{d.f()}return t.setFilterForHuman(n,"ValueEqual",h,a,f)}var g=RE(i,u);return null!==g?t.setFilterForHuman(n,g,s,a,l):void 0}})),t},AE=function(){function e(){(0,y.Z)(this,e),this.gridLineHidden$=new vt.X(!1)}return(0,C.Z)(e,[{key:"getGridLine",value:function(){return this.gridLineHidden$.getValue()}},{key:"setGridLine",value:function(){var e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];this.getGridLine()!==e&&this.gridLineHidden$.next(e)}}]),e}();AE=Gi([(0,ct.b)()],AE);var IE=function(){function e(){(0,y.Z)(this,e),this.tabColor$=new vt.X("")}return(0,C.Z)(e,[{key:"getTabColor",value:function(){return this.tabColor$.getValue()}},{key:"setTabColor",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"";this.getTabColor()!==e&&this.tabColor$.next(e)}}]),e}();IE=Gi([(0,ct.b)()],IE);var bE=function(){function e(t){(0,y.Z)(this,e),this.sheet=t}return(0,C.Z)(e,[{key:"setViewRange",value:function(e,t){var n=(0,we.US_)(e);return this.sheet.setFilterView(e,n,{range:t,col:null,value:null})}}]),e}();bE=Gi([(0,ct.b)(),Ji(0,(0,ht.f)(Pd))],bE);var FE,ME=Symbol("CONDITIONAL_FORMAT_FORMULA"),VE={r:247,g:105,b:100,a:1};!function(e){e.None="none"}(FE||(FE={}));var NE,OE=FE.None,xE={duplicateValues:!1,uniqueValues:!1,cellIs:!0,containsText:!0,timePeriod:!0,containsBlanks:!0,notContainsBlanks:!0,expression:!0},ZE={duplicateValues:!0,cellIs:!0,containsBlanks:!0,containsText:!0,notContainsBlanks:!0,timePeriod:!0,uniqueValues:!0,dataBar:!0,colorScale:!0,rank:!0,aboveAverage:!0,expression:!0,iconSet:!0};!function(e){e.Cell="Cell",e.ValueGroup="ValueGroup",e.Formula="Formula",e.ColorScales="ColorScales",e.DataBar="DataBar",e.IconGroup="IconGroup"}(NE||(NE={}));var DE=function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1;return"rgba(".concat(e.r,", ").concat(e.g,", ").concat(e.b,", ").concat(t,")")},PE=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"";return qt()(e).toRgb()};function LE(e,t,n){if(n){if(0===t)return n[0];var r=PE(n[t-1]),a=PE(n[t]),o=function(e){return void 0===e?1:e};if(r&&a){var i=Math.round(r.r+(a.r-r.r)*e),u=Math.round(r.g+(a.g-r.g)*e),s=Math.round(r.b+(a.b-r.b)*e),l=Math.round(o(r.a)+(o(a.a)-o(r.a))*e);return DE({r:i,g:u,b:s},l)}}return!1}function BE(e){var t=(0,we.zsn)(we.w8i);return UE(e,t)?BE(e):t}function UE(e,t){return e.conditionalFormatModel.getRuleById(t)}function HE(e){return e.colCount()*e.rowCount()}function WE(e){switch(e.type){case NE.DataBar:return"dataBar";case NE.ValueGroup:return function(e){if(NE.ValueGroup!==e.type)return null;switch(e.ruleType){case we.yC8.IsTop:case we.yC8.IsBottom:return"rank";case we.yC8.AboveAverage:case we.yC8.BelowAverage:return"aboveAverage";default:return null}}(e);case NE.ColorScales:return"colorScale";case NE.Formula:return"expression";case NE.IconGroup:return"iconSet";case we.CPf.Number:return"cellIs";case we.CPf.Date:return"timePeriod";case we.CPf.Content:return function(e){if(we.CPf.Content!==e.type)return null;switch(e.operator){case we.MO8.IsDuplicate:return"duplicateValues";case we.MO8.EndsWith:case we.MO8.StartsWith:case we.MO8.Contains:case we.MO8.DoesNotContain:case we.MO8.Is:return"containsText";case we.MO8.IsEmpty:return"containsBlanks";case we.MO8.IsNotEmpty:return"notContainsBlanks";case we.MO8.IsUnique:return"uniqueValues";default:return null}}(e);default:return null}}function jE(e,t){return t.map((function(t){var n=(0,Se.inferPreferredFormatter)(e.formatterService,t).value;return n instanceof ke.SheetDate?"".concat(n.toNumber()):(0,ge.default)(n)?"".concat(n):'"'.concat((0,we.dNX)(t),'"')}))}function zE(e,t){try{var n=t.condition,r=t.format;switch(n.type){case we.CPf.Date:case we.CPf.Number:case we.CPf.Content:case NE.DataBar:case NE.ColorScales:case NE.ValueGroup:case NE.Formula:case NE.IconGroup:var a=WE(n),o=function(e){var t=e.bold,n=void 0!==t&&t,r=e.backColor,a=e.foreColor,o=e.italic,i=void 0!==o&&o,u=e.lineThrough,s=void 0!==u&&u,l=e.underLine,c=void 0!==l&&l,h={};r&&"transparent"!==r&&(h.backColor=r),a&&"transparent"!==a&&(h.foreColor=a);var f=function(e,t){var n=[];return e&&n.push("bold"),t&&n.push("italic"),n.length>0&&n.join(" ")}(n,i);f&&(h.font=f);var d=function(e,t){return e||t?(e?2:0)|(t?1:0):0}(s,c);return d&&(h.textDecoration=d),h}(r),i=function(e,t,n,r){switch(n.type){case NE.DataBar:var a=n.minType,o=n.minValue,i=n.maxValue,u=n.maxType,s=n.hideValue,l=r.negativeColor,c=r.positiveColor,h=r.isGradient;return[{hideValue:s,gradient:h,color:l,value:o,valueType:a},{hideValue:s,gradient:h,color:c,value:i,valueType:u}];case NE.ColorScales:var f,d=n.minValue,v=n.midValue,g=n.maxValue,m=r.valueFormats;return OE===v.valueType?[{valueType:d.valueType,value:d.value,color:m[0].backColor},{valueType:g.valueType,value:g.value,color:m[1].backColor}]:[{valueType:d.valueType,value:d.value,color:m[0].backColor},{valueType:v.valueType,value:v.value,color:m[1].backColor},{valueType:g.valueType,value:g.value,color:null===(f=m[2])||void 0===f?void 0:f.backColor}];case NE.ValueGroup:var p=n.ruleType,y=n.value,C=n.valueType;return[we.yC8.IsTop,we.yC8.IsBottom].includes(p)?[{isBottom:we.yC8.IsBottom===p,valueType:C,value:y}]:[{operator:we.qO2[p]}];case NE.Formula:return[{formula:[n.formula]}];case NE.IconGroup:var _=n.iconRules,R=r.iconType,w=r.hideValue,k=r.reverseIcons;return _.map((function(e){var t=e.valueType,n=e.value,r=e.operator;return{iconType:R,hideValue:w,valueType:t,operator:r,value:n,reverseIcons:k}}));case we.CPf.Number:case we.CPf.Content:case we.CPf.Date:var S=n.operator,E=n.values,T=we.hWC[n.type][S];switch(t){case"cellIs":return[{operator:T,formula:jE(e,E),plaintext:E}];case"containsText":return[{operator:T,text:E[0]}];case"timePeriod":return[{operator:T,timePeriod:we.hrX[S]}]}}return[]}(e,a,n,r);return!!a&&{ruleType:a,attrs:i,format:o};default:return!1}}catch(e){return console.error(e),we.Ps3.collectSuiteEvent("client_sheet_conditional_format_exception",{stage:"setting_to_rule",type:"p0",setting_type:(0,J.default)(t,"condition.type",""),error_name:e&&e.name,error_msg:e&&e.message,error_stack:e&&e.stack}),!1}}var GE,JE={cellIs:qE,timePeriod:qE,notContainsBlanks:qE,containsBlanks:qE,duplicateValues:$E,uniqueValues:$E,containsText:function(e){var t=e.matrixVar,n=e.row,r=e.col,a=e.range;if(t&&a&&Au(t)&&t.valueCount()>0&&a instanceof Ei){var o=r-a.colFrom()+(n-a.rowFrom())*a.colCount();return t.getVarByPos(0,o).getValue()}return!1},dataBar:function(e){var t=e.matrixVar,n=e.row,r=e.col,a=e.range;if(a instanceof vu&&Iu(t)&&t.size()>0){var o,i=a.getRanges().findIndex((function(e){return e.containCell(n,r)}));if(-1===i)return!1;var u=null===(o=t.getSpecialInfo())||void 0===o?void 0:o.ratio;if(void 0===u)return!1;var s=a.getRange(i),l=r-s.colFrom()+(n-s.rowFrom())*s.colCount(),c=t.getVarByPos(i,l);return!!c.isNumber()&&{percent:c.getValue(),originPoint:u}}return!1},colorScale:function(e){var t=e.matrixVar,n=e.row,r=e.col,a=e.range;if(!(Iu(t)&&a instanceof vu))return!1;var o=a.getRanges().findIndex((function(e){return e.containCell(n,r)}));if(-1===o)return!1;var i=a.getRange(o),u=r-i.colFrom()+(n-i.rowFrom())*i.colCount(),s=t.getVarByPos(o,u);return!(!s.isNumber()||!s.getSpecialInfo())&&{percent:s.getValue(),level:s.getSpecialInfo().level}},iconSet:function(e){var t=e.matrixVar,n=e.row,r=e.col,a=e.range;if(!(Iu(t)&&a instanceof vu))return!1;var o=a.getRanges().findIndex((function(e){return e.containCell(n,r)}));if(-1===o)return!1;var i=a.getRange(o),u=r-i.colFrom()+(n-i.rowFrom())*i.colCount(),s=t.getVarByPos(o,u);return!!s.isNumber()&&{iconLevel:s.getValue()}},rank:function(e){var t=e.matrixVar,n=e.row,r=e.col,a=e.range;if(!Iu(t))return!1;var o=a.getRanges().findIndex((function(e){return e.containCell(n,r)}));if(-1===o||!(a instanceof vu))return!1;var i=a.getRange(o),u=r-i.colFrom()+(n-i.rowFrom())*i.colCount();return t.getVarByPos(o,u).getValue()},aboveAverage:function(e){var t=e.matrixVar,n=e.row,r=e.col,a=e.range;if(!Iu(t))return!1;var o=a.getRanges().findIndex((function(e){return e.containCell(n,r)}));if(-1===o||!(a instanceof vu))return!1;var i=a.getRange(o),u=r-i.colFrom()+(n-i.rowFrom())*i.colCount();return t.getVarByPos(o,u).getValue()},expression:function(e){var t=e.matrixVar,n=e.row,r=e.col,a=e.range;if(!Iu(t)||!a)return!1;var o,i=0;a instanceof vu?(i=a.getRanges().findIndex((function(e){return e.containCell(n,r)})),o=a.getRange(i)):o=a;var u=r-o.colFrom()+(n-o.rowFrom())*o.colCount(),s=t.getVarByPos(i,u);return!!s.isBool()&&s.getValue()}};function qE(e){var t=e.matrixVar,n=e.row,r=e.col,a=e.range;if(t&&a&&Au(t)&&t.valueCount()>0&&a instanceof Ei){var o=function(e,t,n){return{newRow:e-n.rowFrom(),newClo:t-n.colFrom()}}(n,r,a),i=o.newRow,u=o.newClo;return!0===t.getVarByPos(i,u).getValue()}return!1}function $E(e){var t=e.sheet,n=e.matrixVar,r=e.row,a=e.col,o=t.getValue(r,a);return!!(n&&Au(n)&&n.valueCount()>0)&&null!==n.iter().first_if((function(e){var t=e.getValue();return"number"==typeof t&&(t=(0,Se.toPrecision)(t)),t===o}))}function YE(e){return!e||!(Au(e)||function(e){return e instanceof ut.ArrayVar}(e)||e.isNull()||e.isError()&&e.errorCode===ut.ErrorCode.SUSPENDED)}function KE(e,t,n,r){return"auto"===t?r?"PRIVATE_MAX_REFS(0, PRIVATE_MAX_REFS(".concat(n,"))"):"PRIVATE_MIN_REFS(0, PRIVATE_MIN_REFS(".concat(n,"))"):"maxValue"===t?"PRIVATE_MAX_REFS(".concat(n,")"):"minValue"===t?"PRIVATE_MIN_REFS(".concat(n,")"):"num"===t?"".concat(e):"percent"===t?"ROUND(PRIVATE_MIN_REFS(".concat(n,")+(PRIVATE_MAX_REFS(").concat(n,")-PRIVATE_MIN_REFS(").concat(n,"))*").concat(Number(e)/100,", 3)"):"percentile"===t?"ROUND(PRIVATE_PERCENTILE_REFS(".concat(Number(e)/100,", ").concat(n,"), 3)"):"formula"===t?"".concat(e):""}!function(e){e.HIGHLIGHT_CELL="highlight_cell",e.FIRST_LAST_RULE="first_last_rule",e.CUSTOM_FORMULA="custom_formula",e.COLOR_SCALE="color_scale",e.DATA_BAR="data_bar",e.ICON_SET="icon_set"}(GE||(GE={}));var XE=function(e){var t,n={highlight_cell:["duplicateValues","uniqueValues","cellIs","containsText","timePeriod","containsBlanks","notContainsBlanks"],first_last_rule:["rank","aboveAverage"],custom_formula:["expression"],color_scale:["colorScale"],data_bar:["dataBar"],icon_set:["iconSet"]};return Object.keys(n).some((function(r){return n[r].some((function(n){return e===n&&(t=r),!!t})),!!t})),t};function QE(e,t){e.forEach((function(e){we.Ps3.ccmEventTracking&&we.Ps3.ccmEventTracking("ccm_sheet_content_page_click",{click:"edit_condition_format_range",target:"none",format_type:XE(e.rule.ruleType),edit_method:t})}))}var eT=function(e,t){we.Ps3.ccmEventTracking("ccm_sheet_content_page_click",Object.assign({},(0,we.dK5)(),{click:"clear_condition_format",target:"none",action_type:e,sub_click:t}))},tT=function(e,t){return!!e&&!(0===e.conditionalFormatModel.getRulesByRange(t).length)},nT=function(e){if(!e)return!1;var t=e.getSelections();return tT(e,t)},rT=function(e){if(!e)return!1;var t=e.getSelections().map((function(t){return new Oi(t.rowFrom(),0,t.rowCount(),e.getColumnCount()-1,e)}));return tT(e,t)},aT=function(e){if(!e)return!1;var t=e.getSelections().map((function(t){return new Oi(0,t.colFrom(),e.getRowCount()-1,t.colCount(),e)}));return tT(e,t)},oT=function(){function e(t){var n=this;(0,y.Z)(this,e),this.attrs=[],this.errorReported=!1,this.setStyle=function(e){n.style=e},this.init=function(e){var t=e.sheet,r=e.ranges,a=e.cfId,o=e.style,i=e.attrs,u=e.hasRef,s=e.ruleType;n.sheet=t,n.cfId=a,n.style=o,n.attrs=i,n.hasRef=u,n._rangesObj=new vu(r,t),n.formulaVarManager=t.inject(uT),n.formulaVarManager.setNeedSplitRanges(xE[s]||!1),!n._rangesObj||n.formulaVarManager.getRangesObj()&&r||n.formulaVarManager.setRangesObj(n._rangesObj),n.unWatchFn=n.tryWatchRanges()},this.insertBaseRanges=function(e){n._rangesObj.insert(e),n.formulaVarManager.updateFormulaRef(n._rangesObj.getRanges())},this.setRanges=function(e){n._rangesObj=e,n.formulaVarManager.updateFormulaRef(n._rangesObj.getRanges())},this.getBaseRanges=function(){return n._rangesObj.getRanges()},this.logCalcError=function(e){n.errorReported||(function(e,t){console.log(t),we.Ps3.moirae.ravenCatch("".concat(e,"_ERROR"),{tags:{key:t}})}(n.ruleType,e),n.errorReported=!0)},this.init(t)}return(0,C.Z)(e,[{key:"initFormula",value:function(){this.formulaVarManager.genFormulaVarInstances({getFormulaStr:this.getFormulaStr})}},{key:"destroyApplicationRanges",value:function(){this.unWatchFn&&(this.unWatchFn(),this.unWatchFn=void 0)}},{key:"destroyFormulaVars",value:function(){this.formulaVarManager.destroyFormulaVars()}},{key:"isIntersect",value:function(e){return this._rangesObj.isIntersect(e)}},{key:"subBaseRanges",value:function(e){return this._rangesObj.subRanges(e)}},{key:"getAttr",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;return this.attrs&&this.attrs[e]||{}}},{key:"handleOnOpRange",value:function(e){this.sheet.dispatch("ConditionalFormatChanged",{type:"RangeChange",rangeOp:e,affectedRanges:e.effectedRef()})}},{key:"isMatch",value:function(e,t){var n=this.formulaVarManager.getFormulaVarByCellInfo(e,t,this.getFormulaStr);if(n.formulaVar&&n.curRange){var r=n.curRange,a=n.formulaVar;if(YE(a))return this.logCalcError(),!1;var o=JE[this.ruleType];return o&&o({sheet:this.sheet,matrixVar:a,row:e,col:t,range:r})}return!1}},{key:"getStyleByRangeRef",value:function(e){var t=this,n=new lv,r=this.formulaVarManager.getFormulaVarByRange(e);if(!r)return n;var a=this.formulaVarManager.toPrimitiveMatrixVar(r.getRawVar({formula:r})),o=JE[this.ruleType];return o&&a?((e.getRanges?e.getRanges():[e]).forEach((function(e){for(var r=e.toJSON(),i=r.row,u=r.col,s=r.rowCount,l=r.colCount,c=i;c<i+s;c++)for(var h=i;h<u+l;h++)o({sheet:t.sheet,matrixVar:a,row:c,col:h,range:e})?n.set(c,h,t.style):n.set(c,h,null)})),n):n}},{key:"tryWatchRanges",value:function(){var e=this;return this.sheet.parent.calcEngine.depRefManager.watchRefs(this.getBaseRanges(),void 0,void 0,(function(t,n){return e.handleOnOpRange(n)}))}},{key:"getFormatStyle",value:function(e,t){try{if(this.isMatch(e,t))return this.style}catch(e){console.error(e),we.Ps3.collectSuiteEvent("client_sheet_conditional_format_exception",{stage:"get_format_style",type:"p0",rule_type:this.ruleType,error_name:e&&e.name,error_msg:e&&e.message,error_stack:e&&e.stack})}return null}},{key:"toJSON",value:function(){var e=this.style,t=this.cfId,n=this.attrs,r=this.hasRef,a={cfId:t,ruleType:this.ruleType,ranges:this.getBaseRanges().map((function(e){return li(e,!0)})),style:(0,Re.default)(e),hasRef:r};return Object.keys(a).forEach((function(e){return void 0===a[e]&&delete a[e]})),n&&n.length&&(a.attrs=(0,Re.default)(n)),a}},{key:"destroy",value:function(){try{this.destroyApplicationRanges(),this.formulaVarManager.destroy()}catch(e){console.error(e)}}}]),e}(),iT=function(e){function t(e){var n;(0,y.Z)(this,t),(n=(0,d.Z)(this,(0,v.Z)(t).call(this,e))).ruleType="expression",n.baseCustomFormulaVar=null,n.firstCell=null,n.unRegisterDynamicDependenciesFns=[],n.unRegisterStaticDependenciesFns=[],n.removeFormulaVar=function(e){var t,r=n.sheet.conditionalFormatModel.getRangeByFormula(e);r&&(null===(t=n.formulaVarManager.getFormulaVarMap())||void 0===t||t.delete(r))},n.getFormulaStr=function(e,t){var r=(0,J.default)(n.attrs,"[0].formula[0]",""),a=n.cfId;return r&&t?n.firstCell?(n.registerStaticDependenciesWatch(t),'PRIVATE_CUSTOM_FORMULA("'.concat(a,'",').concat(e,")")):(console.error("[sheet log] customFormula firstCell Cannot be empty"),""):""};var r=e.attrs,a=void 0===r?null:r,o=(0,J.default)(a,["0","formula","0"],"")||"";return n.initCustomFormulaVarData(o),n.bindEvents(),n}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"bindEvents",value:function(){this.sheet.getCalcEngine().formulaSpace.addListener(ut.FormulaSpaceEvents.onFormulaUnregistered,this.removeFormulaVar)}},{key:"initCustomFormulaVarData",value:function(e){this.genUserCustomRootFormulaVar(e)}},{key:"getFirstCell",value:function(){return this.firstCell}},{key:"getFirstAbsoluteRefMap",value:function(){var e,t=null===(e=this.baseCustomFormulaVar)||void 0===e?void 0:e.getRefMap();if(t&&this.firstCell){var n={};for(var r in t)n[r]=ki(t[r],this.firstCell);return n}}},{key:"getAdjustedFormulaStr",value:function(e){var t=(0,J.default)(this.attrs,["0","formula","0"],""),n=this.getFirstCell(),r=this.baseCustomFormulaVar,a=null==r?void 0:r.getRefMap();if(!n||!r||!a)return"";for(var o in e)e[o]=Si(e[o],n);r.setRefMap(e);var i="="+this.sheet.getCalcEngine().decompile(r,{ref:n});return r.setRefMap(a),i===t?"":i}},{key:"markDirtyFormulaVars",value:function(){var e=this.formulaVarManager.getAllFormulaVars();if(e){var t,n=this.sheet.parent.calcEngine.conditionalDirtyFormulas,r=_n(e);try{for(r.s();!(t=r.n()).done;){var a=t.value;a.resetState(),n.add(a)}}catch(e){r.e(e)}finally{r.f()}n.size&&this.sheet.dispatch("ConditionalFormulaDirty")}}},{key:"getBaseCustomFormulaVar",value:function(){return this.baseCustomFormulaVar}},{key:"genUserCustomRootFormulaVar",value:function(e){var t=this.getBaseRanges()[0];if(t){this.firstCell=new Oi(t.rowFrom(),t.colFrom()||0,1,1,this.sheet),e=e.startsWith("=")?(0,ee.Z)(e,"="):e;var n=this.sheet.getCalcEngine().compile(e,{ref:this.firstCell,spread:this.sheet.parent}).formulaVar;this.baseCustomFormulaVar=n}}},{key:"adjustFormulaVarRefMap",value:function(){if(this.baseCustomFormulaVar){var e=this.baseCustomFormulaVar.getRefMap();if(e){var t=this.getBaseRanges()[0];if(t){var n=new Oi(t.rowFrom(),t.colFrom()||0,1,1,this.sheet),r={};for(var a in e){var o=ki(e[a],this.firstCell);r[a]=o}this.firstCell=n;var i=this.baseCustomFormulaVar.getRef();i.setRowFrom(n.rowFrom()),i.setColFrom(n.colFrom());var u={};for(var s in r){var l=r[s];u[s]=Si(l,i)}this.baseCustomFormulaVar.setRefMap(u)}}}}},{key:"registerStaticDependenciesWatch",value:function(e){var t,n=this,r=null===(t=this.baseCustomFormulaVar)||void 0===t?void 0:t.getRefMap();if(r&&this.firstCell){var a=[];if(Object.values(r).forEach((function(t){var r=ki(t,n.firstCell),o=ki(t,new Oi(e.rowTo(),e.colTo(),1,1,n.sheet));a.push(r.union(o))})),a.length){var o=this.sheet.getCalcEngine().depRefManager.watchRefs(a,this.markDirtyFormulaVars.bind(this),(function(){return n.markDirtyFormulaVars(),!1}));this.appendUnRegisterDependenciesFn(o,!0)}}}},{key:"unRegisterStaticStaticDependencies",value:function(){this.unRegisterStaticDependenciesFns.forEach((function(e){return e()})),this.unRegisterStaticDependenciesFns.length=0}},{key:"unRegisterDynamicDependencies",value:function(){this.unRegisterDynamicDependenciesFns.forEach((function(e){return e()})),this.unRegisterDynamicDependenciesFns.length=0}},{key:"appendUnRegisterDependenciesFn",value:function(e){var t,n=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];null===(t=n?this.unRegisterStaticDependenciesFns:this.unRegisterDynamicDependenciesFns)||void 0===t||t.push(e)}},{key:"unBindEvents",value:function(){this.sheet.getCalcEngine().formulaSpace.removeListener(ut.FormulaSpaceEvents.onFormulaUnregistered,this.removeFormulaVar)}},{key:"serialize",value:function(){var e,t;return{ruleType:we.B2l.ConditionalFormatRuleTypes.ConditionalFormatRuleTypes_EXPRESSION,customFormula:{formula:null===(e=this.getAttr())||void 0===e||null===(t=e.formula)||void 0===t?void 0:t.slice()}}}},{key:"destroy",value:function(){this.unBindEvents(),this.unRegisterStaticStaticDependencies(),(0,f.Z)((0,v.Z)(t.prototype),"destroy",this).call(this)}}]),t}(oT),uT=function(){function e(){var t=this;(0,y.Z)(this,e),this.splitRanges=null,this.unWatchRangeFns=[],this.formulaRangeToBaseRange=new Map,this.isNeedSplitRanges=!1,this.getAllFormulaVars=function(){var e;return null===(e=t.formulaVarMap)||void 0===e?void 0:e.values()},this.getFormulaVarByRange=function(e){var n;return null===(n=t.formulaVarMap)||void 0===n?void 0:n.get(e)},this.getSplitRangeInfoCellIn=function(e,n){var r;if(t.splitRanges&&t.splitRanges.length)return(r=t.getSplitRangeInfoOfCell(e,n))||(t.resetSplitRanges(),r=t.getSplitRangeInfoOfCell(e,n)),r},this.getSplitRangeInfoOfCell=function(e,n){var r,a;if(t.splitRanges&&t.splitRanges.length&&(t.ranges.forEach((function(o,i,u){if(o.containCell(e,n)){var s=t.splitRanges[i];a=s.tree.val,r=function(e,t,n){for(var r=n,a=r.val;r&&r.hasChild;){var o=r.node1;if(o&&o.val.containCell(e,t))a=o.val,r=o;else{var i=r.node2;if(i&&i.val.containCell(e,t))a=i.val,r=i;else{var u=r.node3;if(u&&u.val.containCell(e,t))a=u.val,r=u;else{var s=r.node4;if(!s||!s.val.containCell(e,t))break;a=s.val,r=s}}}}return a}(e,n,s.tree)}})),r&&a))return{range:r,rootRange:a}},this.genFormulaVarByRange=function(e,n,r){t.formulaVarMap=t.formulaVarMap||new Map;var a=t.formulaVarMap&&t.formulaVarMap.get(e);if(a)return a;var o=Ch(e instanceof Ei?[e]:e.getRanges());if(""!==o){var i=n(o,e instanceof Ei?e:e[0],r);if(i&&(a=t.genFormulaVarInstance(i))){var u=e instanceof vu?e.getRanges():a.conditionalFormatBaseRanges=[e];return t.setFormulaVarCache(e,a),t.unWatchRangeFns.push(t.calcEngine.watchFormulaRefMap(a,(function(){a&&t.markFormulaVarDirty(a)}),void 0,(function(e){var n=t.sheet.conditionalFormatModel.getRuleIdByFormula(a);if(n){var r=t.sheet.conditionalFormatModel.getRuleById(n);if(r&&r instanceof iT){var o=r.getFirstCell();o&&(e.rowFrom()===o.rowFrom()&&e.colFrom()===o.colFrom()||r.adjustFormulaVarRefMap())}}}))),a.conditionalFormatBaseRanges=u,a[ME]=ME,t.markFormulaVarDirty(a),a}}}}return(0,C.Z)(e,[{key:"genFormulaVarInstances",value:function(e){var t,n=this,r=e.getFormulaStr;this.isNeedSplitRanges?null===(t=this.splitRanges)||void 0===t||t.forEach((function(e){e.tree.hasChild?function(e){for(var t=[e],n=[];t.length;){var r=t.shift();r&&(r.hasChild?t.unshift(r.node1,r.node2,r.node3,r.node4):n.push(r))}return n}(e.tree).forEach((function(t){var a;n.genFormulaVarByRange(t.val,r,(null===(a=e.tree.root)||void 0===a?void 0:a.val)||e.tree.val)})):n.genFormulaVarByRange(e.tree.val,r,e.tree.val)})):this.genFormulaVarByRange(this.rangesObj,r)}},{key:"getIsNeedSplitRanges",value:function(){return this.isNeedSplitRanges}},{key:"getSplitRanges",value:function(){return this.splitRanges}},{key:"getRangesObj",value:function(){return this.rangesObj}},{key:"getFormulaVarMap",value:function(){return this.formulaVarMap}},{key:"updateFormulaRef",value:function(e){this.rangesObj=this.rangeFactory.createRanges(e),this.ranges=this.rangesObj.getRanges(),this.resetSplitRanges()}},{key:"destroyFormulaVars",value:function(){var e;this.unRegisterCacheFml(),null===(e=this.formulaVarMap)||void 0===e||e.clear()}},{key:"destroy",value:function(){this.splitRanges&&(this.unWatchRangeFns.forEach((function(e){return e()})),this.unWatchRangeFns.length=0),this.destroyFormulaVars()}},{key:"getFormulaVarByCellInfo",value:function(e,t,n){if(!this.isNeedSplitRanges)return{curRange:this.rangesObj,formulaVar:this.getFormulaResult(this.rangesObj,n)};var r=this.getSplitRangeInfoCellIn(e,t);return{curRange:null==r?void 0:r.range,formulaVar:this.getFormulaResult(null==r?void 0:r.range,(function(e){return n(e,null==r?void 0:r.range,null==r?void 0:r.rootRange)}))}}},{key:"getFormulaResult",value:function(e,t){if(e){var n=this.genFormulaVarByRange(e,t);if(n)return this.toPrimitiveMatrixVar(n.getRawVar({formula:n}))}}},{key:"toPrimitiveMatrixVar",value:function(e){return Iu(e)||e instanceof ut.ArrayVar?e:e.isBool()||e.isNumber()?new Ru([[e]]):void 0}},{key:"setNeedSplitRanges",value:function(e){this.isNeedSplitRanges=e}},{key:"setRangesObj",value:function(e){this.ranges=e.getRanges(),this.rangesObj=e,this.isNeedSplitRanges&&this.setSplitRanges()}},{key:"setSplitRanges",value:function(){var e=this;this.splitRanges&&this.formulaRangeToBaseRange.clear(),this.unWatchRangeFns.forEach((function(e){return e()})),this.unWatchRangeFns.length=0,this.splitRanges=this.ranges.map((function(t){return function(e,t){for(var n={val:t,hasChild:!1,root:null},r=function(e){return{val:e,hasChild:!1,root:n}},a=[n],o=[t],i=function(){for(var t=!1,n=[],i=0;i<a.length;i++){var u=a[i],s=u.val;if(!(HE(s)<=1e3)){var l=Math.floor(s.rowCount()/2),c=Math.floor(s.colCount()/2);if(0===l||0===c)break;if(u.node1=r(new Oi(s.rowFrom(),s.colFrom(),l,c,e)),u.node2=r(new Oi(s.rowFrom(),s.colFrom()+c,l,s.colCount()-c,e)),u.node3=r(new Oi(s.rowFrom()+l,s.colFrom(),s.rowCount()-l,c,e)),u.node4=r(new Oi(s.rowFrom()+l,s.colFrom()+c,s.rowCount()-l,s.colCount()-c,e)),u.hasChild=!0,n.push(u.node1,u.node2,u.node3,u.node4),o.push(u.node1.val,u.node2.val,u.node3.val,u.node4.val),t=!0,n.length>=1e3){a.slice(i).forEach((function(e){n.push(e),o.push(e.val)}));break}}}if(!t)return"break";a=n};a.length&&a.length<1e3&&"break"!==i(););return{tree:n,nodes:o}}(e.sheet,t)}))}},{key:"resetSplitRanges",value:function(){this.clearFormulaVarCached(),this.setSplitRanges()}},{key:"clearFormulaVarCached",value:function(){this.unRegisterCacheFml(),this.formulaVarMap&&this.formulaVarMap.clear()}},{key:"unRegisterCacheFml",value:function(){var e=this.calcEngine.formulaSpace;this.formulaVarMap&&this.formulaVarMap.forEach((function(t){e.unRegisterFml(t)}))}},{key:"setFormulaVarCache",value:function(e,t){this.formulaVarMap&&this.formulaVarMap.set(e,t)}},{key:"markFormulaVarDirty",value:function(e){e.resetState(),this.calcEngine.conditionalDirtyFormulas.add(e),this.sheet.dispatch("ConditionalFormulaDirty")}},{key:"genFormulaVarInstance",value:function(e){var t,n=this.sheet,r={ref:this.rangeFactory.createRange(-1,-1,1,1),spread:n.parent,enableCalculation:!n.options.canUseWorker},a=this.calcEngine.compile(e,r);return a.formulaVar&&a.formulaVar.isFormula()?t=a.formulaVar:(console.error("COMPILE_FORMULA_VAR_ERROR",(0,we.XP5)(e)),this.moirae.ravenCatch("COMPILE_FORMULA_VAR_ERROR",{tags:{key:"COMPILE_FORMULA_VAR_ERROR"}})),t}}]),e}();Gi([(0,ht.f)(Pd)],uT.prototype,"sheet",void 0),Gi([(0,ht.f)(jd)],uT.prototype,"moirae",void 0),Gi([(0,ht.f)(sE)],uT.prototype,"rangeFactory",void 0),Gi([(0,ht.f)(Hd)],uT.prototype,"calcEngine",void 0),uT=Gi([(0,ct.b)()],uT);var sT=function(){function e(){(0,y.Z)(this,e),this._enabled$=new vt.X(!1),this._cellColors$=new vt.X(new lv),this._dirtyRect$=new vt.X(void 0),this.enabled$=this._enabled$.asObservable(),this.cellColors$=this._cellColors$.asObservable(),this.dirtyRect$=this._dirtyRect$.asObservable()}return(0,C.Z)(e,[{key:"setEnable",value:function(e){e!==this.enabled&&this._enabled$.next(e)}},{key:"setDirtyRect",value:function(e){this._dirtyRect$.next(e)}},{key:"setCellColors",value:function(e){this._cellColors$.next(e)}},{key:"enabled",get:function(){return this._enabled$.getValue()}},{key:"cellColors",get:function(){return this._cellColors$.getValue()}}]),e}();sT=Gi([(0,ct.b)()],sT);function lT(e,t){return e.row===t.row?e.col-t.col:e.row-t.row}var cT=function(){function e(){(0,y.Z)(this,e),this.searchRstAbove=[],this.searchRstBelow=[],this.searchCellResultMap=new lv}return(0,C.Z)(e,[{key:"getSearchFormulaCount",value:function(){for(var e=0,t=0;t<this.searchRstAbove.length;t++)this.searchRstAbove[t].hasFormula&&e++;for(var n=0;n<this.searchRstBelow.length;n++)this.searchRstBelow[n].hasFormula&&e++;return e}},{key:"getSearchPivotTableCount",value:function(){for(var e=0,t=0;t<this.searchRstAbove.length;t++)this.searchRstAbove[t].hasPivotTable&&e++;for(var n=0;n<this.searchRstBelow.length;n++)this.searchRstBelow[n].hasPivotTable&&e++;return e}},{key:"addSearchResult",value:function(e,t){var n=this;e.sort(lT);var r=!1;if(0!==this.getSearchItems().length){var a=this.getSearchItems().reduce((function(e,t){return e.index>t.index?e:t}));r=Boolean(t&&lT(a,e[0])>0)}if(r){var o=[],i=new Set,u=1/0;if(e.forEach((function(e,t){if(!n.searchCellResultMap.has(e.row,e.col)){var r=Di(n.searchRstBelow,e,lT,!0)+1;e.index=r,n.searchRstBelow.splice(r,0,e),n.searchCellResultMap.set(e.row,e.col,e),o.push(r+1),i.add(r),u=u>t?t:u}})),0!==o.length)for(var s=u;s<this.searchRstBelow.length;s++)if(!i.has(s)){for(var l=0,c=this.searchRstBelow[s],h=0;h<o.length;h++)s>=o[h]&&l++;c.index=c.index+l}}else if(this.searchRstBelow[0]&&lT(this.searchRstBelow[0],e[0])>0){var f=this.searchRstAbove.length+1;e.forEach((function(e,t){e.index=-1*(t+f),n.searchCellResultMap.has(e.row,e.col)||(n.searchRstAbove.push(e),n.searchCellResultMap.set(e.row,e.col,e))}))}else{var d=this.searchRstBelow.length;e.forEach((function(e,t){e.index=d+t,n.searchCellResultMap.has(e.row,e.col)||(n.searchRstBelow.push(e),n.searchCellResultMap.set(e.row,e.col,e))}))}}},{key:"getSearchItems",value:function(){return this.searchRstAbove.concat(this.searchRstBelow)}},{key:"getSearchItem",value:function(e){return e<0?this.searchRstAbove[Math.abs(e)-1]:this.searchRstBelow[e]}},{key:"getSearchNext",value:function(e){return e<0?this.searchRstAbove[Math.abs(e-1)-1]||this.searchRstBelow[0]:this.searchRstBelow[e+1]}},{key:"getSearchPrev",value:function(e){return e<0?this.searchRstAbove[Math.abs(e+1)-1]:this.searchRstBelow[e-1]||this.searchRstAbove[this.searchRstAbove.length-1]}},{key:"getSearchFirst",value:function(){return this.searchRstAbove[0]||this.searchRstBelow[0]}},{key:"getSearchLast",value:function(){return this.searchRstBelow[this.searchRstBelow.length-1]}},{key:"getSearchResultLength",value:function(){return this.searchRstAbove.length+this.searchRstBelow.length}},{key:"getSearchResultCell",value:function(e,t){return this.searchCellResultMap.get(e,t)}},{key:"removeItem",value:function(e){var t;if(e<0){var n=Math.abs(e)-1;t=this.searchRstAbove.splice(n,1);for(var r=n;r<this.searchRstAbove.length;r++)this.searchRstAbove[r].index++}else{var a=e;t=this.searchRstBelow.splice(a,1);for(var o=a;o<this.searchRstBelow.length;o++)this.searchRstBelow[o].index--}if(1===t.length)return t[0]}},{key:"removeSearchResult",value:function(e,t){var n=this.searchCellResultMap.get(e,t);if(n){var r=n.index;if(r<0){var a=Math.abs(r)-1;this.searchRstAbove.splice(a,1);for(var o=a;o<this.searchRstAbove.length;o++)this.searchRstAbove[o].index++}else{var i=r;this.searchRstBelow.splice(i,1);for(var u=i;u<this.searchRstBelow.length;u++)this.searchRstBelow[u].index--}return this.searchCellResultMap.delete(n.row,n.col),n||void 0}}},{key:"clear",value:function(){this.searchRstAbove=[],this.searchRstBelow=[],this.searchCellResultMap.clear()}}]),e}(),hT="var(--B500-FG, 0.2)",fT=function(){function e(t){(0,y.Z)(this,e),this.enabled$=new vt.X(!1),this.highlightColor$=new vt.X(hT),this.activeColor$=new vt.X(hT),this.activeCell$=new vt.X([-1,-1]),this.cellHighlightModel=t,this.searchResults=new cT,this.activeCell$.pipe((0,Bt.G)()).subscribe(this.updateActiveCellColor.bind(this)),this.highlightColor$.pipe((0,Bt.G)()).subscribe(this.updateHighlightColor.bind(this))}return(0,C.Z)(e,[{key:"updateActiveCellColor",value:function(e){var t=(0,p.Z)(e,2),n=t[0],r=t[1],a=!1;return this.cellHighlightModel.cellColors.has(n[0],n[1])&&(a=!0,this.cellHighlightModel.cellColors.set(n[0],n[1],this.searchHighlightColor)),this.cellHighlightModel.cellColors.has(r[0],r[1])&&(a=!0,this.cellHighlightModel.cellColors.set(r[0],r[1],this.searchActiveColor)),a&&this.cellHighlightModel.setCellColors(this.cellHighlightModel.cellColors),a}},{key:"updateHighlightColor",value:function(e){var t=this,n=(0,p.Z)(e,2),r=n[0],a=n[1];if(r!==a){var o=this.activeCell$.getValue(),i=o[0],u=o[1];this.cellHighlightModel.cellColors.forEach((function(e,n,r){i===n&&u===r||t.cellHighlightModel.cellColors.set(n,r,a)})),this.cellHighlightModel.setCellColors(this.cellHighlightModel.cellColors)}}},{key:"setEnable",value:function(e){return e!==this.searchHighlightEnabled&&(this.enabled$.next(e),this.cellHighlightModel.setEnable(e),!1===e&&(this.setActiveCell(-1,-1),this.searchResults.clear(),this.cellHighlightModel.cellColors.clear(),this.setDirtyRect(void 0)),!0)}},{key:"setHighlightColor",value:function(e){e!==this.searchHighlightColor&&this.highlightColor$.next(e)}},{key:"setActiveColor",value:function(e){e!==this.searchActiveColor&&this.activeColor$.next(e)}},{key:"setActiveCell",value:function(e,t){return!(e>0&&t>0&&!this.cellHighlightModel.cellColors.has(e,t)||(this.activeCell$.next([e,t]),0))}},{key:"getSearchFormulaCount",value:function(){return this.searchResults.getSearchFormulaCount()}},{key:"getSearchPivotTableCount",value:function(){return this.searchResults.getSearchPivotTableCount()}},{key:"getSearchItems",value:function(){return this.searchResults.getSearchItems()}},{key:"getSearchItem",value:function(e){return this.searchResults.getSearchItem(e)}},{key:"getSearchNext",value:function(e){return this.searchResults.getSearchNext(e)}},{key:"getSearchPrev",value:function(e){return this.searchResults.getSearchPrev(e)}},{key:"getSearchFirst",value:function(){return this.searchResults.getSearchFirst()}},{key:"getSearchLast",value:function(){return this.searchResults.getSearchLast()}},{key:"getSearchResultLength",value:function(){return this.searchResults.getSearchResultLength()}},{key:"getSearchResultCell",value:function(e,t){return this.searchResults.getSearchResultCell(e,t)}},{key:"removeSearchResult",value:function(e,t,n){var r=this.searchResults.removeSearchResult(e,t);return r&&this.cellHighlightModel.cellColors.has(e,t)&&(this.cellHighlightModel.cellColors.delete(e,t),this.cellHighlightModel.setCellColors(this.cellHighlightModel.cellColors),this.setDirtyRect(n)),r}},{key:"addSearchResult",value:function(e,t,n){var r=this;e.length&&(this.searchResults.addSearchResult(e,n),e.forEach((function(e){r.cellHighlightModel.cellColors.set(e.row,e.col,r.searchHighlightColor)})),this.cellHighlightModel.setCellColors(this.cellHighlightModel.cellColors),this.setDirtyRect(t))}},{key:"setDirtyRect",value:function(e){this.cellHighlightModel.setDirtyRect(e)}},{key:"searchHighlightEnabled",get:function(){return this.enabled$.getValue()}},{key:"searchHighlightColor",get:function(){return this.highlightColor$.getValue()}},{key:"searchActiveColor",get:function(){return this.activeColor$.getValue()}}]),e}();fT=Gi([(0,ct.b)(),Ji(0,(0,ht.f)(sT))],fT);var dT=function(){function e(t){var n=this;(0,y.Z)(this,e),this.sheet=t,this._dirtyRect$=new vt.X(void 0),this.dirtyRect$=this._dirtyRect$.asObservable(),this.setDirtyRect=function(e){we.Ps3.browser.isMobile?n.sheet.notifyShell(94,e):n._dirtyRect$.next(e)}}return(0,C.Z)(e,[{key:"setDirtyCell",value:function(e,t){var n=new Vt.FRect(t,e,1,1);this.setDirtyRect(n)}},{key:"setSourceHighlightRange",value:function(e){this.sourceHighlightRange=e,this.sheet.notifyShell(108,{ranges:e,type:0})}},{key:"setGroupHighlightRange",value:function(e){this.groupHighlightRange=e,this.sheet.notifyShell(108,{ranges:e,type:1})}},{key:"removeSourceHighlightRange",value:function(){this.sourceHighlightRange=[],this.sheet.notifyShell(109,{type:0})}},{key:"removeGroupHighlightRange",value:function(){this.groupHighlightRange=[],this.sheet.notifyShell(109,{type:1})}},{key:"getSourceHighlightRange",value:function(){return this.sourceHighlightRange}},{key:"getGroupHighlightRange",value:function(){return this.groupHighlightRange}}]),e}();dT=Gi([(0,ct.b)(),Ji(0,(0,ht.f)(Pd))],dT);var vT=function(){function e(t){(0,y.Z)(this,e),this.filterModel=t,this.name$=new vt.X(""),this.filterModel.setActive(!1),this.filterModel.setRange({row:0,rowCount:1,col:0,colCount:1})}return(0,C.Z)(e,[{key:"setName",value:function(e){this.name$.next(e)}},{key:"getFilterModel",value:function(){return this.filterModel}},{key:"getId",value:function(){return this.id}},{key:"getName",value:function(){return this.name$.getValue()}},{key:"destroy",value:function(){this.filterModel.destroy(),this.name$.complete()}},{key:"toJSON",value:function(){var e=this.filterModel.toJSON(),t={id:this.id,name:this.name$.getValue()};return e&&Object.assign(t,{rowFilter:e}),t}},{key:"serialize",value:function(e){var t=this.filterModel.serialize(e);return{id:this.getId(),name:this.getName(),autoFilter:t}}},{key:"deactiveFilterModel",value:function(){this.filterModel.setActive(!1)}},{key:"activeFilterModel",value:function(){this.filterModel.setActive(!0)}}]),e}();vT=Gi([(0,ct.b)(),Ji(0,(0,ht.f)(wE))],vT);var gT=function(){function e(t,n,r){var a=this;(0,y.Z)(this,e),this.getService=t,this.t=n,this.sheetFilterModel=r,this.viewMaps=new Map,this.viewIdList$=new vt.X([]),this.activeView$=new vt.X(null),this.viewList$=this.viewIdList$.pipe((0,Pt.map)((function(e){return e.reverse().sort((function(e,t){var n=(0,we.US_)(e);return n===(0,we.US_)(t)?0:n?-1:1})).map((function(e){return a.viewMaps.get(e)}))})))}return(0,C.Z)(e,[{key:"getActiveViewId",value:function(){if(this.activeView)return this.activeView.id}},{key:"tryEntryViewById",value:function(e){var t=this.activeView$.getValue(),n=this.viewMaps.get(e);if(n){if(t){if(t.id===e)return;t.deactiveFilterModel()}n.activeFilterModel(),this.activeView$.next(n)}}},{key:"tryExistView",value:function(){var e=this.activeView$.getValue();e&&(e.deactiveFilterModel(),this.activeView$.next(null))}},{key:"deleteViewById",value:function(e){var t=this.viewIdList$.getValue();this.viewIdList$.next(t.filter((function(t){return t!==e})));var n=this.viewMaps.get(e);n&&n.destroy(),this.getActiveViewId()===e&&this.activeView$.next(null),this.viewMaps.delete(e),(0,we.y_b)(e)&&this.unwatchSheetFilterRange()}},{key:"addView",value:function(e,t,n){var r=this.viewIdList$.getValue(),a=this.getService(vT);return n&&a.filterModel.removeFilter(),a.id=e,a.setName(t),this.viewMaps.set(e,a),this.viewIdList$.next([].concat((0,m.Z)(r),[e])),(0,we.y_b)(e)&&this.watchSheetFilterRange(),a}},{key:"destroy",value:function(){var e,t=_n(this.viewMaps.values());try{for(t.s();!(e=t.n()).done;){e.value.destroy()}}catch(e){t.e(e)}finally{t.f()}this.activeView$.complete(),this.viewIdList$.complete(),this.unwatchSheetFilterRange()}},{key:"getViewById",value:function(e){return this.viewMaps.get(e)}},{key:"assignViewName",value:function(){var e,t=arguments.length>0&&void 0!==arguments[0]&&arguments[0],n=new Set,r=_n(this.viewMaps.values());try{for(r.s();!(e=r.n()).done;){var a=e.value;n.add(a.getName())}}catch(e){r.e(e)}finally{r.f()}for(var o=1,i=t?this.t("CreationDoc_Sheets_Filter_DefaultTemporaryViewName"):this.t("sheets.filter_view.hover_create_new");;){var u=o>1?i+" "+o:i;if(!n.has(u))return u;o++}}},{key:"assignViewId",value:function(){for(var e=!(arguments.length>0&&void 0!==arguments[0])||arguments[0],t=10,n=e?"":we.dux;;){var r=(0,we.zsn)(t);if(!r.startsWith(we.dux)&&!r.startsWith(we.Bge)){var a=n+r;if(!this.viewMaps.has(a))return a}}}},{key:"assignPersonalViewId",value:function(){return we.G2r}},{key:"isNameExit",value:function(e){var t,n=_n(this.viewMaps.values());try{for(n.s();!(t=n.n()).done;){if(t.value.getName()===e)return!0}}catch(e){n.e(e)}finally{n.f()}return!1}},{key:"toJSON",value:function(){var e,t=[],n=_n(this.viewMaps.values());try{for(n.s();!(e=n.n()).done;){var r=e.value;if(!(0,we.US_)(r.id)){var a=r.toJSON();a.rowFilter&&(a.rowFilter=pT(a.rowFilter),t.push(a))}}}catch(e){n.e(e)}finally{n.f()}return t}},{key:"serialize",value:function(e){var t,n=[],r=_n(this.viewMaps.values());try{for(r.s();!(t=r.n()).done;){var a=t.value;(0,we.US_)(a.id)||n.push(a.serialize(e))}}catch(e){r.e(e)}finally{r.f()}return n}},{key:"getViewList",value:function(){var e=this;return this.viewIdList$.getValue().map((function(t){return e.viewMaps.get(t)}))}},{key:"isTempView",value:function(e){return(0,we.US_)(e.id)}},{key:"isInPersonalTempView",value:function(){return!!this.activeView&&(0,we.y_b)(this.activeView.id)}},{key:"getCurrentFilterModel",value:function(e){if(e){var t=this.viewMaps.get(e);return t?t.filterModel:void 0}var n=this.activeView;return n?n.filterModel:this.sheetFilterModel}},{key:"getAllColFilterInfo",value:function(e){var t=this.getCurrentFilterModel(e);if(!t)return[];var n=t.getValidFilterRules(),r=[];return(0,m.Z)(n).forEach((function(e){var n=(0,p.Z)(e,1)[0],a=t.getFilterInfo(n);a&&r.push(a)})),r}},{key:"watchSheetFilterRange",value:function(){var e=this;this.unwatchSheetFilterRange(),this.sheetFilterRangeSub=this.sheetFilterModel.currentRange$.pipe((0,Zt.w)((function(e){return e?e.$:(0,pt.of)(void 0)})),(0,Ut.T)(1),(0,Ht.QV)(yt.P)).subscribe((function(t){var n=e.personalView;if(n){var r=n.getId(),a=n.getFilterModel(),o=a.filterRange;t&&o?t.equal(o)||a.setRange(t.toJSON()):e.deleteViewById(r)}}))}},{key:"unwatchSheetFilterRange",value:function(){var e;null===(e=this.sheetFilterRangeSub)||void 0===e||e.unsubscribe()}},{key:"activeView",get:function(){return this.activeView$.getValue()}},{key:"personalView",get:function(){return this.viewMaps.get(we.G2r)}}]),e}();Gi([(0,lt.P)()],gT.prototype,"destroy",null),gT=Gi([(0,ct.b)(),Ji(0,(0,ht.f)(Bd)),Ji(1,(0,ht.f)(Ud)),Ji(2,(0,ht.f)(SE))],gT);var mT=function(e,t,n){var r=t.range.col,a={filterItemMap:(0,z.default)(t.filterRules,(function(e,t){var n=e.compareType,a=e.contents,o=e.dateGroups;return{conditions:[{compareType:n,conType:e.conType,contents:a,dateGroups:o,expected:a}],filteredRows:[],index:r+Number(t)}})),range:t.range};TE(a,e,n)},pT=function(e){var t=e.range.col;return{filterRules:(0,G.Z)(e.filterItemMap,(function(e,n){if(!n.conditions||!n.conditions[0])return e;var r=n.conditions[0].compareType;return function(e){var t=(0,p.Z)(e,1)[0];return 2===t.conType&&0===t.compareType||0===t.conType}(n.conditions)?Object.assign(e,(0,l.Z)({},n.index-t,{compareType:r,conType:0,contents:(0,z.default)(n.conditions,(0,j.Z)("expected")).filter((function(e){return!(0,ae.Z)(e)})),dateGroups:(0,W.Z)((0,z.default)(n.conditions,(0,j.Z)("dateGroups"))).filter((function(e){return!(0,ae.Z)(e)}))})):Object.assign(e,(0,l.Z)({},n.index-t,{compareType:n.conditions[0].compareType,conType:n.conditions[0].conType,contents:n.conditions[0].expected}))}),{}),range:e.range}};var yT,CT,_T,RT,wT=/^[-+]/,kT=/(\-?\d+)(\D*)$/,ST=/(\-?\d+)$/,ET=/(^\d+)/,TT=/(\d+)$/,AT=/^(\D)(\D*)/,IT="model/fill/cycle-calendars",bT=function(){function e(){(0,y.Z)(this,e),this.cycleCalendarsConfig=[],this.cycleMap={},this._caseIngore=!0}return(0,C.Z)(e,[{key:"registerCycleCalendars",value:function(e){(0,we.hTd)(this.cycleCalendarsConfig,e);for(var t=0,n=this.cycleCalendarsConfig.length;t<n;t++){var r=this.cycleCalendarsConfig[t],a=r.type,o=r.cycle;this.cycleMap[a]=o}}},{key:"closeCaseIgnore",value:function(){this._caseIngore=!1}},{key:"getCycleInfoByText",value:function(e,t){var n=e;this._caseIngore&&(n=e.replace(AT,(function(e,t,n){return t.toUpperCase()+n.toLowerCase()})));var r,a={},o=[];for(var i in this.cycleMap){var u=this.cycleMap[i].findIndex((function(e){return e===n}));if(-1!==u){if(!t)return{type:i,itemIndex:u};a[i]=o.push({type:i,itemIndex:u})-1}}return o.length>1&&t?o[null!==(r=a[t])&&void 0!==r?r:0]:o.length?o[0]:null}},{key:"getCycleByType",value:function(e){return this.cycleMap[e]}}]),e}();bT=Gi([(0,ct.b)()],bT),function(e){e[e.Left=0]="Left",e[e.Right=1]="Right",e[e.Up=2]="Up",e[e.Down=3]="Down",e[e.Range=4]="Range"}(yT||(yT={})),function(e){e[e.vertical=0]="vertical",e[e.horizontal=1]="horizontal"}(CT||(CT={})),function(e){e[e.Increment=0]="Increment",e[e.Decrease=1]="Decrease"}(_T||(_T={})),function(e){e.Auto="auto",e.CopyCells="copyCells",e.FillSeries="fillSeries"}(RT||(RT={}));var FT="model/fill/fill-linear-regression",MT=function(){function e(){(0,y.Z)(this,e)}return(0,C.Z)(e,[{key:"init",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1;if(Array.isArray(e))if(1===e.length){var n=(0,p.Z)(e,1),r=n[0],a=r+t;this._regression=this.getLinearEquation([r,a]),this._data=[r,a]}else this._regression=this.getLinearEquation(e),this._data=e}},{key:"getLinearEquation",value:function(e){if(!Array.isArray(e)||0===e.length)return null;if(1===e.length){this._isLinearData=!0;var t=e[0];return null==t?null:this.getLinearRegression([t,t+1])}var n=this.getLinearRegression(e.slice(0,2));if(!n)return n;for(var r=2;r<e.length;r++)if(e[r]!==n.predict(r))return this._isLinearData=!1,this.getLinearRegression(e);return this._isLinearData=!0,n}},{key:"getLinearRegression",value:function(e){for(var t=[],n=0;n<e.length;n++){if(null==e[n])return null;t.push(n)}return new Yt.Z(t,e)}},{key:"getValueByX",value:function(e){return this._regression&&this.isValidRegression()?e>=0&&e<this._data.length?this._data[e]:this._regression.predict(e):this._data[e]}},{key:"getSlope",value:function(){return this._regression&&this.isValidRegression()?this._regression.slope:1}},{key:"getIntercept",value:function(){return this._regression&&this.isValidRegression()?this._regression.intercept:0}},{key:"isLinear",value:function(){return!!this.isValidRegression()&&this._isLinearData}},{key:"isValidRegression",value:function(){return!(!this._regression||isNaN(this._regression.slope))}},{key:"toString",value:function(e){return this._regression&&this.isValidRegression?this._regression.toString(e):""}},{key:"destroy",value:function(){this._regression=null,this._data=[]}}]),e}();MT=Gi([(0,ct.b)()],MT);var VT,NT,OT,xT=function(){function e(){(0,y.Z)(this,e)}return(0,C.Z)(e,[{key:"fromJSON",value:function(e){var t=e.type,n=e.attrs,r=e.values;this.type=t,this.attrs=n,this.values=r}},{key:"toJSON",value:function(){return{type:this.type,attrs:this.attrs,values:this.values}}},{key:"calcValueByFillCalcType",value:function(e,t){switch(e){case RT.Auto:return this.getValueByAuto(t);case RT.CopyCells:return this.getValueByCopy(t);case RT.FillSeries:return this.getValueBySeries(t);default:return this.getValueByAuto(t)}}},{key:"getValueByAuto",value:function(e){return this.getDefaultAutoFillCalcType()===RT.FillSeries?this.getValueBySeries(e):this.getValueByCopy(e)}},{key:"getDefaultAutoFillCalcType",value:function(){return this._autoFillCalcType}},{key:"setDefaultAutoFillCalcType",value:function(e){e!==this._autoFillCalcType&&(this._autoFillCalcType=e)}},{key:"destroy",value:function(){this.linearGression.destroy()}}],[{key:"isValidBaseJSON",value:function(e){var t=e.type,n=e.attrs,r=e.values;return Boolean(t)&&Array.isArray(n)&&Array.isArray(r)&&r.length>0}}]),e}();Gi([(0,ht.f)(FT)],xT.prototype,"linearGression",void 0),xT=Gi([(0,ct.b)()],xT),function(e){e.SerialCycle="SerialCycle",e.SerialText="SerialText",e.SerialNumber="SerialNumber",e.SerialSegmentArray="SerialSegmentArray",e.CopyOnly="CopyOnly"}(VT||(VT={})),function(e){e.General="General",e.Text="Text",e.Digital="Digital",e.Fraction="Fraction",e.TimeOnly="TimeOnly",e.DateTime="DateTime"}(NT||(NT={})),function(e){e.Head="Head",e.Tail="Tail"}(OT||(OT={}));var ZT="model/fill/fill-calc-group/serial-cycle-fill",DT=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"init",value:function(e,n,r,a){if(this.cycleCalendars=r,(0,f.Z)((0,v.Z)(t.prototype),"fromJSON",this).call(this,{type:VT.SerialCycle,attrs:e,values:n}),1===n.length)this.linearGression.init(n,0===a?1:-1);else if(this.isCycleValues()){var o=n[1]-n[0];this.linearGression.init(n.slice(0,1),o)}else this.linearGression.init(n)}},{key:"isCycleValues",value:function(){var e=this.values;if(e.length<=1)return!0;for(var t=e[1]-e[0],n=2;n<e.length;n++){var r=e[n]-e[n-1];if(r!==t&&Math.abs(r-t)!==this.cycleCalendars.length)return!1}return!0}},{key:"setCycleCalendars",value:function(e){this.cycleCalendars=e}},{key:"canSeries",value:function(){return!(!this.values||!Array.isArray(this.values))&&this.linearGression.isLinear()}},{key:"getValueBySeries",value:function(e){if(this.canSeries()){var t=this.linearGression.getValueByX(e)%this.cycleCalendars.length;return t<0&&(t+=this.cycleCalendars.length),this.getTextByValue(t)}return this.getValueByCopy(e)}},{key:"getValueByCopy",value:function(e){var t=this.values[e%this.values.length];return this.getTextByValue(t)}},{key:"getTextByValue",value:function(e){return this.cycleCalendars[e]}}],[{key:"isValidJSON",value:function(e,t){if(xT.isValidBaseJSON(e)){if(1!==e.attrs.length)return!1;var n=(0,p.Z)(e.attrs,1)[0],r=t.getCycleByType(n);return Array.isArray(r)}return console.info("[Sheet Fill] no inject valid cycle calendars"),!1}}]),t}(xT);DT=Gi([(0,ct.b)()],DT);var PT,LT="model/fill-calc-group/serial-number-fill",BT=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"init",value:function(e,n,r){(0,f.Z)((0,v.Z)(t.prototype),"fromJSON",this).call(this,{type:VT.SerialNumber,attrs:e,values:n});var a=this._getSlope(r);1===n.length?this.linearGression.init(n,a):this._containTimeType(n)&&function(e){for(var t,n=1;n<e.length;n++){var r=e[n-1],a=e[n];if(Math.floor(r)!==Math.floor(a))return!1;var o=new ke.SheetDate(r),i=o.hours,u=o.minutes,s=o.seconds,l=new ke.SheetDate(a),c=l.hours,h=l.minutes,f=l.seconds,d=UT(i,u,s),v=UT(c,h,f);if(void 0!==t){if(t!==v-d)return!1}else t=v-d}return!0}(n)?this.linearGression.init(n.slice(0,1),n[1]-n[0]):this.linearGression.init(n)}},{key:"canSeries",value:function(){var e=this._getSerialNumberFillCalcAttr();return e===NT.General||e===NT.Digital||this.linearGression.isLinear()}},{key:"getValueBySeries",value:function(e){if(this.canSeries()){var t=this.linearGression.getValueByX(e);return this._fixValue(t)}return this.getValueByCopy(e)}},{key:"getValueByCopy",value:function(e){var t=e%this.values.length;return this.values[t]}},{key:"_getSlope",value:function(e){var t=0===e?1:-1;return this._getSerialNumberFillCalcAttr()===NT.TimeOnly?1/24*t:1*t}},{key:"_getSerialNumberFillCalcAttr",value:function(){return this.attrs[0]}},{key:"_containTimeType",value:function(e){var t=this;return e.some((function(e){var n=t._getSerialNumberFillCalcAttr(),r=n===NT.TimeOnly||n===NT.DateTime;return!Number.isInteger(e)&&r}))}},{key:"_fixValue",value:function(e){var t=this._getSerialNumberFillCalcAttr();if(t===NT.TimeOnly||t===NT.DateTime){if(e>ke.SheetDate.MAX_DATE_VALUE)return ke.SheetDate.MAX_DATE_VALUE;if(e<ke.SheetDate.MIN_DATE_VALUE)return Math.abs(e)}return ar._parseFloat(e)}}],[{key:"isValidJSON",value:function(e){if(xT.isValidBaseJSON(e)){var t=e.attrs;if(1!==t.length)return!1;var n=t[0];return[NT.General,NT.Text,NT.Digital,NT.DateTime,NT.TimeOnly,NT.Fraction].includes(n)}return!1}}]),t}(xT);function UT(e,t,n){return 60*e*60+60*t+n}BT=Gi([(0,ct.b)()],BT),function(e){e.plus="+",e.minus="-",e.None=""}(PT||(PT={}));var HT=function(e){function t(){var e;return(0,y.Z)(this,t),(e=(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments)))._leadingSign=PT.None,e}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"initBaseSerialText",value:function(e,n,r,a){(0,f.Z)((0,v.Z)(t.prototype),"fromJSON",this).call(this,{type:e,attrs:n,values:r}),this._leadingSign=this._buildSign(),this._digitsNumber=this._buildLeadingZeros(),this.linearGression.init(r.map((function(e){return Math.abs(Number(e))})),0===a?1:-1)}},{key:"_buildSign",value:function(){var e=this.values[0].match(wT);return null!==e?e[0]:PT.None}},{key:"_buildLeadingZeros",value:function(){for(var e=1,t=0;t<this.values.length;t++){var n=this.values[t],r=wT.test(n)?n.length-1:n.length;e<r&&(e=r)}return e}},{key:"getValueBySeries",value:function(e){if(this.canSeries()){if(e>=0&&e<this.values.length){var t=this.values[e];return this.getCalcResultByValue(t)}var n=this.linearGression.getValueByX(e),r=""+Math.abs(n);if(r.length<this._digitsNumber){var a=this._digitsNumber-r.length;r="0".repeat(a)+r}var o="".concat(this._leadingSign).concat(r);return this.getCalcResultByValue(o)}return this.getValueByCopy(e)}},{key:"getValueByCopy",value:function(e){var t=this.values[e%this.values.length];return this.getCalcResultByValue(t)}},{key:"getTextByValue",value:function(e){return this.headTemplate+e+this.tailTemplate}}]),t}(xT),WT="model/fill-calc-group/serial-segment-array",jT=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"init",value:function(e,n,r){(0,f.Z)((0,v.Z)(t.prototype),"initBaseSerialText",this).call(this,VT.SerialSegmentArray,e,n,r)}},{key:"canSeries",value:function(){return!(!this.values||!Array.isArray(this.values))&&(this.serialSegmentPosition!==OT.Tail||""===this.tailTemplate)&&(this.serialSegmentPosition!==OT.Head||""===this.headTemplate)&&this.linearGression.isLinear()}},{key:"getCalcResultByValue",value:function(e){var t=this.getTextByValue(e),n=[];if(this.serialSegmentPosition===OT.Tail){for(var r=3;r<this.attrs.length;r++){var a=this.attrs[r];n.push(a)}return n.push(t),n}n.push(t);for(var o=3;o<this.attrs.length;o++){var i=this.attrs[o];n.push(i)}return n}},{key:"headTemplate",get:function(){return this.attrs[1]}},{key:"tailTemplate",get:function(){return this.attrs[2]}},{key:"serialSegmentPosition",get:function(){return this.attrs[0]}}],[{key:"isValidJSON",value:function(e){if(xT.isValidBaseJSON(e)){var t=e.attrs;return!(t.length<3)&&[OT.Head,OT.Tail].includes(t[0])}return!1}}]),t}(HT);jT=Gi([(0,ct.b)()],jT);var zT="model/fill/fill-calc-group/serial-text-fill",GT=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"init",value:function(e,n,r){(0,f.Z)((0,v.Z)(t.prototype),"initBaseSerialText",this).call(this,VT.SerialText,e,n,r)}},{key:"canSeries",value:function(){return!(!this.values||!Array.isArray(this.values))&&this.linearGression.isLinear()}},{key:"getCalcResultByValue",value:function(e){return this.getTextByValue(e)}},{key:"headTemplate",get:function(){return this.attrs[0]}},{key:"tailTemplate",get:function(){return this.attrs[1]}}],[{key:"isValidJSON",value:function(e){return!!xT.isValidBaseJSON(e)&&2===e.attrs.length}}]),t}(HT);GT=Gi([(0,ct.b)()],GT);var JT="model/fill/fill-calc-group/factory",qT=function(){function e(){(0,y.Z)(this,e)}return(0,C.Z)(e,[{key:"createFillCalcGroup",value:function(e,t){if(!this.isFillCalcGroupJSONValid(e))return null;switch(e.type){case VT.SerialCycle:var n,r=e.attrs,a=e.values,o=r[0],i=null===(n=this.cycleCalendarsModel)||void 0===n?void 0:n.getCycleByType(o),u=this.sheet.inject(ZT);return u.init(r,a,i,t),u.setDefaultAutoFillCalcType(RT.FillSeries),u;case VT.SerialNumber:var s=e.attrs,l=e.values,c=this.sheet.inject(LT);c.init(s,l,t);var h=s[0];return 1!==l.length||h!==NT.General&&h!==NT.Digital?c.setDefaultAutoFillCalcType(RT.FillSeries):c.setDefaultAutoFillCalcType(RT.CopyCells),c;case VT.SerialText:var f=e.attrs,d=e.values,v=this.sheet.inject(zT);return v.init(f,d,t),v.setDefaultAutoFillCalcType(RT.FillSeries),v;case VT.SerialSegmentArray:var g=e.attrs,m=e.values,p=this.sheet.inject(WT);return p.init(g,m,t),p.setDefaultAutoFillCalcType(RT.FillSeries),p;default:return null}}},{key:"isFillCalcGroupJSONValid",value:function(e){switch(e.type){case VT.SerialCycle:if(!this.sheet)return!1;var t=this.sheet.inject(IT);return DT.isValidJSON(e,t);case VT.SerialNumber:return BT.isValidJSON(e);case VT.SerialText:return GT.isValidJSON(e);case VT.SerialSegmentArray:return jT.isValidJSON(e);default:return!1}}}]),e}();Gi([(0,ht.f)(Pd)],qT.prototype,"sheet",void 0),Gi([(0,ht.f)(IT)],qT.prototype,"cycleCalendarsModel",void 0),qT=Gi([(0,ct.b)()],qT),(0,ft.GW)((0,ct.b)(),Rt.FIterator);var $T="model/fill/fill-data-view/fill-dimension-iter",YT=function(e){function t(){var e;return(0,y.Z)(this,t),(e=(0,d.Z)(this,(0,v.Z)(t).call(this)))._itemIndex=0,e._itemCount=0,e}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"init",value:function(e){this._targetFillDimItemList=e,this._itemCount=e.length,this._itemIndex=0}},{key:"next",value:function(){if(!this._targetFillDimItemList||!this._targetFillDimItemList.length)return null;var e=this._targetFillDimItemList;return this._itemIndex<this._itemCount?e[this._itemIndex++]:null}}]),t}(Rt.FIterator);YT=Gi([(0,ct.b)()],YT);var KT="model/fill/fill-dimension",XT=function(){function e(t){var n=this;(0,y.Z)(this,e),this.sheet=t,this.sourceItemGroupIdList=[],this.sourceItemGroupIdIndex=[],this._cellIndex$=new vt.X([-1,-1]),this._sourceRangeSize$=new vt.X([-1,-1]),this._fillRangeSize$=new vt.X([-1,-1]),this._fillCalcType$=new vt.X(RT.Auto),this._fillTrend$=new vt.X(0),this.skipHiddenRow=!1,this.skipFilterRow=!0,this._buildGroupSubscription=(0,mt.aj)(this._cellIndex$,this._sourceRangeSize$,this._fillTrend$).subscribe((function(){n.reset(),n._parseDataSource(),n._buildGroup()})),this._handleCalcTypeChangeSubscription=this._fillCalcType$.subscribe((function(){n.refreshCalcValue()})),this._handleRangeSizeChangeSubscription=this._fillRangeSize$.subscribe((function(){n._calcValue()}))}return(0,C.Z)(e,[{key:"setInvisibleRowConfig",value:function(e){var t=e.skipHiddenRow,n=e.skipFilterRow;this.skipHiddenRow=t,this.skipFilterRow=n}},{key:"reset",value:function(){this.dimGroupList=[],this.sourceItemGroupIdList=[],this.sourceFillDimItemList=[],this.sourceItemCellPosition=[],this.sourceItemGroupIdIndex=[],this.targetFillDimItemList=[]}},{key:"setCellIndex",value:function(e){(0,pe.default)(this.cellIndex,e)||this._cellIndex$.next(e)}},{key:"setSourceRangeSize",value:function(e){(0,pe.default)(this.sourceRangeSize,e)||this._sourceRangeSize$.next(e)}},{key:"setFillRangeSize",value:function(e){(0,pe.default)(this.fillRangeSize,e)||this._fillRangeSize$.next(e)}},{key:"setFillCalcType",value:function(e){this.fillCalcType!==e&&this._fillCalcType$.next(e)}},{key:"setFillTrend",value:function(e){this.fillTrend!==e&&this._fillTrend$.next(e)}},{key:"_createFillCalcGroup",value:function(e){return this.sheet.inject(JT).createFillCalcGroup(e,this.fillTrend)}},{key:"_parseDataSource",value:function(){for(var e=(0,p.Z)(this.cellIndex,2),t=e[0],n=e[1],r=(0,p.Z)(this.sourceRangeSize,2),a=r[0],o=r[1],i=t;i<t+a;i++)if(!(this.skipHiddenRow&&!this.sheet.getRowVisible(i,!0)||this.skipFilterRow&&this.sheet._isRowFilterOut(i)))for(var u=n;u<n+o;u++){var s=this._parseCellData(i,u);0===this.fillTrend?(this.sourceFillDimItemList.push(s),this.sourceItemCellPosition.push([i,u])):(this.sourceFillDimItemList.unshift(s),this.sourceItemCellPosition.unshift([i,u]))}}},{key:"_parseCellData",value:function(e,t){var n,r=this.sheet,a=r.getSegmentArray(e,t),o=null===(n=r.getCellFormatter(e,t))||void 0===n?void 0:n.getFormatters(),i=r.getValue(e,t),u=r.hasFormula(e,t),s=r.getDataValidation(e,t),l=Boolean(s&&Mm(s)),c=Boolean(s&&Em(s)),h=null;switch(!0){case u||c||l:case null==i:h=null;break;case Array.isArray(a):h=this._parseSegmentArray(a);break;case"string"==typeof i:null==(h=this._parseCycleText(i))&&(h=this._parseSerialText(i));break;case"boolean"==typeof i:h=null;break;case null!=o||"number"==typeof i:h=this._parseNumber(o,i)}return null==h&&(h={type:VT.CopyOnly,attrs:null,value:null}),h}},{key:"_parseSerialText",value:function(e){if(isNaN(Number(e))){var t=e.match(kT);if(t){var n=t[1],r=t[2],a=e.slice(0,t.index);return{type:VT.SerialText,attrs:[a,r],value:n}}return null}if(e.length>15)return null;var o=e.match(ST);if(o){var i=o[1],u=e.slice(0,o.index);return{type:VT.SerialText,attrs:[u,""],value:i}}return null}},{key:"_parseCycleText",value:function(e){var t,n=this.sheet.inject(IT);if(this.sourceFillDimItemList.length>0){var r=0===this.fillTrend?this.sourceFillDimItemList.length-1:0,a=this.sourceFillDimItemList[r];t=a.type===VT.SerialCycle?a.attrs[0]:void 0}var o=n.getCycleInfoByText(e,t);return o?{type:VT.SerialCycle,attrs:[o.type],value:o.itemIndex}:null}},{key:"_parseNumber",value:function(e,t){if(!e)return{type:VT.SerialNumber,attrs:[NT.General],value:t};var n=(0,p.Z)(e,1)[0],r=n.type,a=n.formatRules;return r!==NT.DateTime||a.hasDate?r===NT.Text&&void 0!==t?this._parseSerialText(t.toString()):{type:VT.SerialNumber,attrs:[r],value:t}:{type:VT.SerialNumber,attrs:[NT.TimeOnly],value:t}}},{key:"_parseSegmentArray",value:function(e){if(!e||!Array.isArray(e))return null;var t=function(e){return e===we.K6s.ATTACHMENT||e===we.K6s.MENTION},n=e[0],r=n.text,a=n.type,o=e[e.length-1],i=o.text,u=o.type;if(i&&!t(u)){var s=i.match(TT);if(s){for(var l=s[1],c=i.slice(0,s.index),h=[OT.Tail,c,""],f=0;f<e.length-1;f++){var d=e[f];h.push(d.text)}return{type:VT.SerialSegmentArray,attrs:h,value:l}}}if(r&&!t(a)){var v=r.match(ET);if(v){for(var g=v[1],m=r.slice(g.length),p=[OT.Head,"",m],y=1;y<e.length;y++){var C=e[y];p.push(C.text)}return{type:VT.SerialSegmentArray,attrs:p,value:g}}}return null}},{key:"_buildGroup",value:function(){var e=this;if(this.sourceFillDimItemList.length){var t=0,n=this.sourceFillDimItemList.reduce((function(n,r){if(n&&n.type===r.type&&(0,pe.default)(n.attrs,r.attrs))return n.values.push(r.value),e.sourceItemGroupIdList.push(t),e.sourceItemGroupIdIndex.push(n.values.length-1),n;if(Array.isArray(n.values)){var a=e._createFillCalcGroup(n);e.dimGroupList[t]=a,t++}var o={type:r.type,attrs:r.attrs,values:[r.value]};return e.sourceItemGroupIdList.push(t),e.sourceItemGroupIdIndex.push(0),o}),{}),r=this._createFillCalcGroup(n);this.dimGroupList[t]=r}}},{key:"_calcValue",value:function(){if(this.sourceFillDimItemList.length)for(var e=Math.max(this.fillRangeSize[0],this.fillRangeSize[1]),t=this.targetFillDimItemList.length;t<e;t++){var n=this.sourceFillDimItemList.length,r=t%n,a=this.sourceItemCellPosition[r],o=this.sourceItemGroupIdList[r],i=this.dimGroupList[o];if(i){var u=Math.floor(t/n)+1,s=this.sourceItemGroupIdIndex[r],l=i.values.length*u+s,c=i.calcValueByFillCalcType(this.fillCalcType,l),h={type:i.type,result:c,sourceCell:a};this.targetFillDimItemList.push(h)}else this.targetFillDimItemList.push({type:VT.CopyOnly,result:null,sourceCell:a})}}},{key:"refreshCalcValue",value:function(){this.targetFillDimItemList=[],this._calcValue()}},{key:"getFillDimensionIter",value:function(){if(!this.targetFillDimItemList.length)return null;var e=this.sheet.inject($T);return e.init(this.targetFillDimItemList),e}},{key:"destroy",value:function(){this._buildGroupSubscription.unsubscribe(),this._handleRangeSizeChangeSubscription.unsubscribe(),this._handleCalcTypeChangeSubscription.unsubscribe(),this.dimGroupList.forEach((function(e){return null==e?void 0:e.destroy()})),this.dimGroupList=[],this.sourceItemGroupIdList=[],this.sourceItemGroupIdIndex=[],this.sourceFillDimItemList=[],this.sourceItemCellPosition=[],this.targetFillDimItemList=[],this._cellIndex$.complete(),this._fillCalcType$.complete(),this._fillRangeSize$.complete(),this._sourceRangeSize$.complete(),this._fillTrend$.complete()}},{key:"cellIndex",get:function(){return this._cellIndex$.getValue()}},{key:"sourceRangeSize",get:function(){return this._sourceRangeSize$.getValue()}},{key:"fillRangeSize",get:function(){return this._fillRangeSize$.getValue()}},{key:"fillCalcType",get:function(){return this._fillCalcType$.getValue()}},{key:"fillTrend",get:function(){return this._fillTrend$.getValue()}}]),e}();XT=Gi([(0,ct.b)(),Ji(0,(0,ht.f)(Pd))],XT);var QT="model/fill/fill-data-view/fill-data-view-iter",eA=function(e){function t(e){var n;return(0,y.Z)(this,t),(n=(0,d.Z)(this,(0,v.Z)(t).call(this)))._sheet=e,n._row=-1,n._col=-1,n._skipHiddenRow=!1,n._skipFilterRow=!0,n._fillDimensionIndex=-1,n}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"init",value:function(e,t,n){var r=arguments.length>3&&void 0!==arguments[3]&&arguments[3],a=!(arguments.length>4&&void 0!==arguments[4])||arguments[4];this._rg=e,this._dimList=t,this._fillDirection=n,this._skipHiddenRow=r,this._skipFilterRow=a}},{key:"_stepToNextDimension",value:function(){this._fillDimensionIndex++,this._row=-1,this._col=-1}},{key:"_stepTo",value:function(){switch(this._fillDirection){case yT.Down:return void(-1===this._row&&-1===this._col?(this._row=this._rg.rowFrom(),this._col=this._rg.colFrom()+this._fillDimensionIndex):this._row++);case yT.Right:return void(-1===this._col&&-1===this._row?(this._row=this._rg.rowFrom()+this._fillDimensionIndex,this._col=this._rg.colFrom()):this._col++);case yT.Up:return void(-1===this._row&&-1===this._col?(this._row=this._rg.rowTo(),this._col=this._rg.colFrom()+this._fillDimensionIndex):this._row--);case yT.Left:return void(-1===this._col&&-1===this._row?(this._row=this._rg.rowFrom()+this._fillDimensionIndex,this._col=this._rg.colTo()):this._col--)}}},{key:"_stepToVisibleRow",value:function(){this._fillDirection!==yT.Up?this._row++:this._row--}},{key:"next",value:function(){var e,t,n,r=this._dimList;if(!this._sheet||this._fillDimensionIndex>=r.length)return null;var a=null===(e=this._iter)||void 0===e?void 0:e.next();if(null==a)return this._stepToNextDimension(),this._iter=null===(t=r[this._fillDimensionIndex])||void 0===t?void 0:t.getFillDimensionIter(),this.next();for(this._stepTo();this._skipHiddenRow&&!this._sheet.getRowVisible(this._row,!0);)this._stepToVisibleRow();for(;this._skipFilterRow&&this._sheet._isRowFilterOut(this._row);)this._stepToVisibleRow();return this._rg.containCell(this._row,this._col)?{targetCell:[this._row,this._col],calcItemResult:a}:(this._stepToNextDimension(),this._iter=null===(n=r[this._fillDimensionIndex])||void 0===n?void 0:n.getFillDimensionIter(),this.next())}}]),t}(Rt.FIterator);eA=Gi([(0,ct.b)(),Ji(0,(0,ht.f)(Pd))],eA);var tA="model/fill/fill-data-view",nA=function(){function e(t){var n=this;(0,y.Z)(this,e),this.sheet=t,this._fillType$=new vt.X(RT.Auto),this._direction$=new vt.X(null),this._sourceRange$=new vt.X(null),this._fillRange$=new vt.X(null),this._reverseAutoFill$=new vt.X(!1),this.dimList=[],this.skipHiddenRow=!1,this.skipFilterRow=!0,this._isDirty=!1,this._sipltDimInfoSubscription=(0,mt.aj)(this._sourceRange$,this._reverseAutoFill$,this._direction$.pipe((0,Pt.map)((function(e){return n._getFillSeries(e)})))).subscribe((function(e){var t=(0,p.Z)(e,3),r=(t[0],t[1],t[2]);null!=r&&(n.reset(),n._spiltDimInfo(r),n.setDefaultAutoFillCalcType())})),this._handleFillSubscription=(0,mt.aj)(this._fillRange$,this._fillType$).subscribe((function(){n._handleFill()})),this._handleFillTrendChange=this._direction$.pipe((0,Pt.map)((function(e){return n._getFillTrend(e)}))).subscribe((function(e){null!==e&&(n.dimList.forEach((function(t){t.setFillTrend(e)})),n.setDefaultAutoFillCalcType())})),this._handleReverseAutoFillChange=this._reverseAutoFill$.subscribe((function(){n.setDefaultAutoFillCalcType(),n.dimList.forEach((function(e){e.refreshCalcValue()}))}))}return(0,C.Z)(e,[{key:"markDirty",value:function(){this._isDirty||(this._isDirty=!0)}},{key:"refresh",value:function(){this.reset(),this._spiltDimInfo(this._getFillSeries(this.direction)),this.setDefaultAutoFillCalcType(),this._handleFill(),this._isDirty=!1}},{key:"reset",value:function(){this.dimList.forEach((function(e){return e.destroy()})),this.dimList=[]}},{key:"setFillRange",value:function(e){(0,pe.default)(this.fillRange,e)||this._fillRange$.next(e)}},{key:"setFillType",value:function(e){this.fillType!==e&&this._fillType$.next(e)}},{key:"setDirection",value:function(e){this.direction!==e&&this._direction$.next(e)}},{key:"setSourceRange",value:function(e){(0,pe.default)(this.sourceRange,e)||this._sourceRange$.next(e)}},{key:"setReverseAutoFill",value:function(e){(0,pe.default)(this.reverseAutoFill,e)||this._reverseAutoFill$.next(e)}},{key:"setCanSkipHiddenRow",value:function(e){this.skipHiddenRow!==e&&(this.skipHiddenRow=e)}},{key:"setCanSkipFilterRow",value:function(e){this.skipFilterRow!==e&&(this.skipFilterRow=e)}},{key:"createFillDimension",value:function(){return this.sheet.inject(KT)}},{key:"_getFillSeries",value:function(e){if(null==e)return null;var t=[yT.Up,yT.Down],n=[yT.Left,yT.Right];return t.includes(e)?0:n.includes(e)?1:null}},{key:"_getFillTrend",value:function(e){if(null==e)return null;var t=[yT.Right,yT.Down],n=[yT.Up,yT.Left];return t.includes(e)?0:n.includes(e)?1:null}},{key:"_spiltDimInfo",value:function(e){var t=this.sourceRange,n=this.sheet;if(t&&n&&null!=e)for(var r=t.rowFrom(),a=t.colFrom(),o=t.rowCount(),i=t.colCount(),u=0===e,s=u?i:o,l=u?a:r,c=0;c<s;c++,l++){var h=u?r:l,f=u?l:a,d=u?o:1,v=u?1:i,g=this.createFillDimension();g.setCellIndex([h,f]),g.setSourceRangeSize([d,v]),g.setInvisibleRowConfig({skipHiddenRow:this.skipHiddenRow,skipFilterRow:this.skipFilterRow});var m=this._getFillTrend(this.direction);null!=m&&g.setFillTrend(m),this.dimList.push(g)}}},{key:"_handleFill",value:function(){if(this.dimList.length&&this.fillRange)for(var e=this.fillRange.rowCount(),t=this.fillRange.colCount(),n=0;n<this.dimList.length;n++){var r=this.dimList[n],a=0===this._getFillSeries(this.direction)?e:1,o=0===this._getFillSeries(this.direction)?1:t;r.setFillRangeSize([a,o]),r.setFillCalcType(this.fillType)}}},{key:"getFillDataViewIter",value:function(){if(null==this.fillRange||null==this.direction)return null;this._isDirty&&this.refresh();var e=this.sheet.inject(QT);return e.init(this.fillRange,this.dimList,this.direction,this.skipHiddenRow,this.skipFilterRow),e}},{key:"setDefaultAutoFillCalcType",value:function(){if(this.sourceRange){var e=this.sourceRange.size(),t=this.reverseAutoFill;this.dimList.forEach((function(n){n.dimGroupList.forEach((function(n){if(n){var r=n.toJSON(),a=r.type,o=r.attrs[0];1!==e||a!==VT.SerialNumber||o!==NT.General&&o!==NT.Digital?n.setDefaultAutoFillCalcType(t?RT.CopyCells:RT.FillSeries):n.setDefaultAutoFillCalcType(t?RT.FillSeries:RT.CopyCells)}}))}))}}},{key:"getAutoFillCalcTypeList",value:function(){for(var e=[],t=0;t<this.dimList.length;t++)for(var n=this.dimList[t],r=0;r<n.dimGroupList.length;r++){var a,o=(null===(a=n.dimGroupList[r])||void 0===a?void 0:a.getDefaultAutoFillCalcType())||RT.CopyCells;e.push(o)}return e}},{key:"getAutoFillItemTypeList",value:function(){for(var e=[],t=0;t<this.dimList.length;t++)for(var n=this.dimList[t],r=0;r<n.dimGroupList.length;r++){var a,o=(null===(a=n.dimGroupList[r])||void 0===a?void 0:a.type)||VT.CopyOnly;e.includes(o)||e.push(o)}return e}},{key:"destroy",value:function(){this._sipltDimInfoSubscription.unsubscribe(),this._handleFillSubscription.unsubscribe(),this._handleFillTrendChange.unsubscribe(),this._handleReverseAutoFillChange.unsubscribe(),this.dimList.forEach((function(e){return e.destroy()})),this.dimList=[],this._fillType$.complete(),this._direction$.complete(),this._fillRange$.complete(),this._sourceRange$.complete()}},{key:"direction",get:function(){return this._direction$.getValue()}},{key:"fillType",get:function(){return this._fillType$.getValue()}},{key:"sourceRange",get:function(){return this._sourceRange$.getValue()}},{key:"fillRange",get:function(){return this._fillRange$.getValue()}},{key:"reverseAutoFill",get:function(){return this._reverseAutoFill$.getValue()}}]),e}();nA=Gi([(0,ct.b)(),Ji(0,(0,ht.f)(Pd))],nA);var rA="model/fill/fii-sel-range",aA=function(){function e(){(0,y.Z)(this,e),this._selRange$=new vt.X(null),this._selectionDashBorderStyle$=new vt.X(null),this._toolTipsText$=new vt.X(""),this._toolTipsCellPosition$=new vt.X([-1,-1]),this.selRange$=this._selRange$.asObservable(),this.selectionDashBorderStyle$=this._selectionDashBorderStyle$.asObservable(),this.toolTipsText$=this._toolTipsText$.asObservable(),this.toolTipsCellPosition$=this._toolTipsCellPosition$.asObservable()}return(0,C.Z)(e,[{key:"setSelRange",value:function(e){(0,pe.default)(e,this.selRange)||this._selRange$.next(e)}},{key:"setSelectionDashBorderStyle",value:function(e){(0,pe.default)(e,this.selectionDashBorderStyle)||this._selectionDashBorderStyle$.next(e)}},{key:"setToolTipsText",value:function(e){(0,pe.default)(e,this.toolTipsText)||this._toolTipsText$.next(e)}},{key:"setToolTipsCellPosition",value:function(e){(0,pe.default)(e,this.toolTipsCellPosition)||this._toolTipsCellPosition$.next(e)}},{key:"removeToolTips",value:function(){this._toolTipsCellPosition$.next([-1,-1]),this._toolTipsText$.next("")}},{key:"selRange",get:function(){return this._selRange$.getValue()}},{key:"selectionDashBorderStyle",get:function(){return this._selectionDashBorderStyle$.getValue()}},{key:"toolTipsText",get:function(){return this._toolTipsText$.getValue()}},{key:"toolTipsCellPosition",get:function(){return this._toolTipsCellPosition$.getValue()}}]),e}();aA=Gi([(0,ct.b)()],aA);var oA="model/fill/fill-corner",iA=function(){function e(){(0,y.Z)(this,e),this._cornerType$=new vt.X(null),this._preCornerType=null,this.cornerType$=this._cornerType$.asObservable()}return(0,C.Z)(e,[{key:"setCornerType",value:function(e){this.cornerType!==e&&(this._preCornerType=this.cornerType,this._cornerType$.next(e))}},{key:"mobileFilling",get:function(){return this.cornerType===we.LN0.MOBILE_FILL_CORNER}},{key:"cornerType",get:function(){return this._cornerType$.getValue()}},{key:"preCornerType",get:function(){return this._preCornerType}}]),e}();iA=Gi([(0,ct.b)()],iA);var uA=function(){function e(t){(0,y.Z)(this,e),this.sheetDataModelGetter=t}return(0,C.Z)(e,[{key:"getDataValidation",value:function(e,t){var n;return(null===(n=this.sheetDataModelGetter())||void 0===n?void 0:n.getDataValidation(e,t))||null}},{key:"getDataValidationJSON",value:function(e,t,n,r){var a,o=(null===(a=this.sheetDataModelGetter())||void 0===a?void 0:a.getDataValidation(e,t,r))||null;return o?o.toJSON(n):null}},{key:"hasDropdown",value:function(e,t){var n=this.getDataValidation(e,t);return!!n&&(Nm(n)||Mm(n))}},{key:"hasCheckbox",value:function(e,t){var n=this.getDataValidation(e,t);return!(!n||"checkbox"!==n.type)}},{key:"getDataValidationId",value:function(e,t){var n;return(null===(n=this.sheetDataModelGetter())||void 0===n?void 0:n.getDataValidationId(e,t))||null}}]),e}();uA=Gi([(0,ct.b)(),Ji(0,(0,ht.f)(Dd))],uA);var sA,lA=["filter","find","findAndReplace","hideCol","hideRow","openFilterMenu","addOutline","delOutline","unhideCOl","unhideRow"],cA=function(){function e(){(0,y.Z)(this,e),this.tabType$=new vt.X(void 0)}return(0,C.Z)(e,[{key:"getTabType",value:function(){return this.tabType$.getValue()}},{key:"setTabType",value:function(e){this.getTabType()!==e&&this.tabType$.next(e)}},{key:"isConnectorTab",value:function(){return this.getTabType()===we.Ec3.SheetTabType_CONNECTOR}},{key:"isShortcutAllowed",value:function(e){return!this.isConnectorTab()||-1!==lA.findIndex((function(t){return t===e}))}}]),e}();cA=Gi([(0,ct.b)()],cA),function(e){e[e.Normal=0]="Normal",e[e.ImportRange=1]="ImportRange",e[e.DataRange=2]="DataRange",e[e.DataRangev2=3]="DataRangev2"}(sA||(sA={}));var hA=Object.keys(we.Wa0).length/2,fA=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"getStyleId",value:function(e){return this.getStyleRefAndId(e).id}},{key:"getStyleJson",value:function(e){return this.getStyleRefAndId(e).ref}},{key:"getStyleRefAndId",value:function(e){this.styleJsonCache||(this.styleJsonCache=new Map);var t=this.styleJsonCache.get(e);if(t)return t;var n=e.toJSON(!0),r=this.add(n);return this.styleJsonCache.set(e,r),r}},{key:"equals",value:function(e,t){var n=Object.keys(e),r=Object.keys(t);if(n.length!==r.length)return!1;for(var a=0,o=n;a<o.length;a++){var i=o[a],u=e[i],s=t[i];switch(i){case dd:case gd:if((0,J.default)(u,"formatCached")!==(0,J.default)(s,"formatCached"))return!1;continue;case pd:case yd:case Cd:case md:if((0,J.default)(u,"color")===(0,J.default)(s,"color")&&(0,J.default)(u,"width")===(0,J.default)(s,"color"))return!1;continue}if(i===vd)return Kf(e[i],t[i]);if(e[i]!==t[i])return!1}return!0}},{key:"getHash",value:function(e){return xa(e)}},{key:"serializeRef",value:function(e){var t=[null];!ld()&&e.hasOwnProperty("fontInfo")?t[0]=e.fontInfo:e.hasOwnProperty("font")&&(t[0]=e.font);for(var n=!1,r=hA;r>=1;r--)e.hasOwnProperty(we.Wa0[r])?(n=!0,t[r]=e[we.Wa0[r]]):n&&(t[r]=null);return t}}],[{key:"deserialize",value:function(e){for(var t={},n=0;n<e.length;n++){var r={},a=e[n];if(a){for(var o=0;o<a.length;o++)if(!(0,ae.Z)(a[o])){if(o===we.Wa0.font){var i=a[0];"string"==typeof i?r.font=i:r.fontInfo=i;continue}r[we.Wa0[o]]=a[o]}t[n]=r}}return t}}]),t}(Vg),dA=function(e){function t(e,n,r,a,o){var i;return(0,y.Z)(this,t),(i=(0,d.Z)(this,(0,v.Z)(t).call(this,e._getModel().contentModel.dataModel.iter(n,r,a,o)))).sheet=e,i.rowFrom=n,i.colFrom=r,i.rowCount=a,i.colCount=o,i}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"exportCells",value:function(e){for(var t=this.rowFrom+this.rowCount,n=this.colFrom+this.colCount,r=this.rowFrom;r<t;r++)if(!this.sheet.getRowVisible(r))for(var a=this.colFrom;a<n;a++)e(r,a).isHidden=!0;for(var o=this.colFrom;o<n;o++)if(!this.sheet.getColVisible(o))for(var i=this.rowFrom;i<t;i++)e(i,o).isHidden=!0}},{key:"exportToCell",value:function(e,t){}}]),t}(Um),vA=function(e){function t(e){var n;return(0,y.Z)(this,t),(n=(0,d.Z)(this,(0,v.Z)(t).call(this))).sheet=e,n}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"getExporter",value:function(e,t,n,r){return new dA(this.sheet,e,t,n,r)}}]),t}(Kv);var gA=function(e){function t(e,n,r,a,o,i){var u;return(0,y.Z)(this,t),(u=(0,d.Z)(this,(0,v.Z)(t).call(this,n.iter(r,a,o,i)))).sheet=e,u.intersectRanges=[],u.styleMgr=new ap,u.intersectRanges=function(e,t,n,r,a){var o=e.getPivotTableManager();if(!o.hasPivotTable())return[];var i,u=[],s=new Oi(t,n,r,a,e),l=_n(o.getPivotInfoMap());try{for(l.s();!(i=l.n()).done;){var c=i.value[1],h=c.pageRange,f=c.contentRange,d=null==h?void 0:h.intersect(s);d&&u.push(d);var v=null==f?void 0:f.intersect(s);v&&u.push(v)}}catch(e){l.e(e)}finally{l.f()}return u}(e,r,a,o,i),u.styleMgr.maxId=e._getModel().styleDropdownModel.getStyleRefMgr().maxId,u}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"exportCells",value:function(e,t){var n=this;this.intersectRanges.length<=0||this.intersectRanges.forEach((function(r){for(var a=n.sheet.iterContent(r.rowFrom(),r.colFrom(),r.rowCount(),r.colCount()),o=a.next();null!==o;o=a.next()){var i=a.position();if(o&&o.variant){var u=o.variant.getValue(t);if(null!==u){var s=e(i.row,i.col);s.value=u,s.text=n.sheet.getText(i.row,i.col,void 0,void 0,t)}}}for(var l=n.sheet.iterCell(r.rowFrom(),r.colFrom(),r.rowCount(),r.colCount()),c=l.next();null!==c;c=l.next()){var h=l.position();if(c){var f=n.sheet._getModel().getStyle(h.row,h.col);f&&(e(h.row,h.col).styleId=n.styleMgr.add(f).id)}}}))}},{key:"exportExtraInfo",value:function(e){var t=this;this.styleMgr.idToRef.size<=0||(e.entities||(e.entities={}),e.entities.styles||(e.entities.styles={}),this.styleMgr.foreach((function(n,r){e.entities.styles[r]=n.toJSON(!0),t.styleMgr.useRefCounter&&(e.entities.styles[r].refCount=t.styleMgr.refCounter.get(n)||0)})))}},{key:"exportToCell",value:function(e,t){}}]),t}(Um),mA=function(e){function t(e){var n;return(0,y.Z)(this,t),(n=(0,d.Z)(this,(0,v.Z)(t).call(this))).sheet=e,n}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"getExporter",value:function(e,t,n,r){return new gA(this.sheet,this,e,t,n,r)}}]),t}(Kv),pA=function(e){function t(e,n,r,a,o){var i;return(0,y.Z)(this,t),(i=(0,d.Z)(this,(0,v.Z)(t).call(this,e._getModel().contentModel.dataModel.iter(n,r,a,o)))).sheet=e,i}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"exportCells",value:function(e){for(var t=this.iter.next();null!==t;t=this.iter.next()){var n=this.iter.position();t&&(e(n.row,n.col).text=this.sheet.getText(n.row,n.col))}}},{key:"exportToCell",value:function(e,t){}}]),t}(Um),yA=function(e){function t(e){var n;return(0,y.Z)(this,t),(n=(0,d.Z)(this,(0,v.Z)(t).call(this))).sheet=e,n}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"getExporter",value:function(e,t,n,r){return new pA(this.sheet,e,t,n,r)}}]),t}(Kv);function CA(e,t,n){if(!n.containCell(e,t))return"";var r=n.rowFrom(),a=n.colFrom();return e===r&&t===a+1?fn("CreationDoc_Sheets_PivotTable_ColumnWorkSpace"):e===r+1&&t===a?fn("CreationDoc_Sheets_PivotTable_RowWorkSpace"):e===r+1&&t===a+1?fn("CreationDoc_Sheets_PivotTable_ValueWorkSpace"):e===r+5&&t===a+1?fn("CreationDoc_Sheets_PivotTable_WorkSpacePlaceHolder"):""}function _A(){return fn("CreationDoc_Sheets_PivotTable_FilterWorkSpace")}function RA(e,t,n,a){var o=e.parent.pivotService;if("number"==typeof t)return t;if(t&&"object"==(0,_.Z)(t)){if(void 0!==t.errorCode)return t.value;var i=t.text,u=void 0===i?"":i,s=t.type,l=t.keyType,c=t.suffix,h=void 0===c?"":c,f=t.date,d=function(e,t){var n=t;switch(e){case 1:n=fn("CreationDoc_Sheets_PivotTable_All");break;case 2:n=fn("CreationDoc_Sheets_PivotTable_Several");break;case 3:n=" ".concat(fn("CreationDoc_Sheets_PivotTable_TotalAfterText"));break;case 0:n=fn("CreationDoc_Sheets_PivotTable_ValueTitle");break;default:t&&(n=" "+t)}return n}(l,h)||"";if(void 0!==f&&n){var v=n.fieldName,g=null==a?void 0:a.groupMap[v];return g?function(e,t,n,r){return(0,Ot.MN)(e,t,new Date(n),r).cellValue}(o.getFormatterService(),o.getText.bind(o),f,g)+d:u+d}if(5===l)return ut.ErrorConstant.NUM;if(0===s&&!d)return Number(t.text);if(2===s)return function(e,t,n,r,a){var o,i;if(o=n===String(Number(n))?Number(n):ke.SheetDate.fromUTCDate(new Date(n)).toNumber(),t&&("colDim"===t.areaType||"rowDim"===t.areaType||"page"===t.areaType)){var u,s=null==r||null===(u=r.getFieldFormat)||void 0===u?void 0:u.call(r,t.fieldName||"");i=(0,Se.createFormatter)(e.formatterService,s||"").format(o)+a}return i}(e,n,u,a,d);var p=u;if(3===s)p=fn("CreationDoc_Sheets_PivotTable_Blank");else if("string"==typeof p&&p.indexOf(Ot.kc)>-1){var y=p.split(Ot.kc),C=(0,r.Z)(y),R=C[0],w=C.slice(1);p=o.getText.apply(o,[R].concat((0,m.Z)(w)))}else 0===s&&(p="".concat(ar._parseFloat(Number(u))));return p?p+d:d.trimStart()}return t}function wA(e,t){var n=t.getSheetFromId(e.sheetId);return e.type===we.xj7.ALL?new Ni(n):e.type===we.xj7.ROW?new xi(e.row,e.rowCount,n):e.type===we.xj7.COL?new Vi(e.col,e.colCount,n):new Oi(e.row,e.col,e.rowCount,e.colCount,n)}var kA,SA="workbook/commandManager",EA="workbook/workbook",TA=Symbol("workbook/watchHub"),AA={source:xt.lU.SHEET,parent:xt.lU.SHEET,cross:!1},IA=function(e,t){var n,r,a=FA(t);return null===(n=e.getSheetFromId(a))||void 0===n||null===(r=n.rangeModel.getRangesFromId([t]))||void 0===r?void 0:r[0]};!function(e){e.ERR_RCE_LIVE_SYNC="1009"}(kA||(kA={}));var bA=function(e,t){var n,r=null===(n=e.sheet())||void 0===n?void 0:n.id();if(r){var a=e.rgType,o=e.toJSON(),i=o.row,u=o.col,s=o.rowCount,l=o.colCount;switch(a){case we.xj7.ALL:return{sheetId:r,rangeId:t,type:a};case we.xj7.ROW:return{sheetId:r,rangeId:t,type:a,row:i,rowCount:s};case we.xj7.COL:return{sheetId:r,rangeId:t,type:a,col:u,colCount:l};case we.xj7.NORMAL:return{sheetId:r,rangeId:t,type:a,row:i,col:u,rowCount:s,colCount:l};case we.xj7.CELL:return{sheetId:r,rangeId:t,type:we.xj7.NORMAL,row:i,col:u,rowCount:1,colCount:1};case we.xj7.INVALID:default:return}}},FA=function(e){return e.split("_")[0]};function MA(e){var t=e,n=t.sheet_id,r=t.value,a=t.target,o=r.range_id;switch(a.type){case 3:return{sheetId:n,rangeId:o,type:we.xj7.ALL};case 1:return e=e,{sheetId:n,rangeId:o,type:we.xj7.ROW,row:e.target.row,rowCount:e.target.row_count};case 2:return e=e,{sheetId:n,rangeId:o,type:we.xj7.COL,col:e.target.col,colCount:e.target.col_count};default:return e=e,{sheetId:n,rangeId:o,type:we.xj7.NORMAL,row:e.target.row,col:e.target.col,rowCount:e.target.row_count,colCount:e.target.col_count}}}var VA,NA=function(e,t){return"".concat(e).concat("_").concat(t||(0,we.zsn)(10))},OA=function(e,t){var n=e.split("_")[1];return NA(t,n)},xA=function(e,t){var n;if(!t)return"";var r=IA(e,t);if(!r)return"";var a=NA(r.sheetId),o=Object.assign({},r,{rangeId:a});return(null===(n=e.setDataRange)||void 0===n?void 0:n.call(e,[o]))?a:""};!function(e){e.UNDO="undo",e.REDO="redo",e.LOCAL="local",e.COLLA="colla"}(VA||(VA={}));var ZA,DA=function(e,t){return e?"undo"===e?VA.UNDO:VA.REDO:t&&t?VA.LOCAL:VA.COLLA};!function(e){e.DATA_RANGE_SELECTOR="DataRangeSelector",e.FORMULA_REF_ADJUST="FormulaRefAdjust",e.DATA_RANGE_ADJUST="dataRangeAdjust",e.PASSIVE="passive"}(ZA||(ZA={}));var PA=function(e,t){return!(!e.getSheetFromId(t.sheetId)||!wA(t,e))},LA=function(){function e(t){(0,y.Z)(this,e),this._spread=t,this._sourceRanges=new Map,this._dataRanges=new Map,this.bindEvents()}return(0,C.Z)(e,[{key:"bindEvents",value:function(){this._spread.subscribe(this.getWorkbookEvents())}},{key:"getWorkbookEvents",value:function(){return{SheetDataRangeAdjusted:this.handleDataRangeAdjusted,AfterApply:this.handleAfterApply,MoveRange:this.handleMoveRange}}},{key:"handleAfterApply",value:function(e){var t=this,n=e.actions;if(e.fromUndoRedo){var r,a=_n(this._dataRanges);try{var o=function(){var e=(0,p.Z)(r.value,2),a=e[0],o=e[1],i=o.sheetId,u=n.filter((function(e){var t=e.action,n=e.sheet_id;return!!["setDataRange"].includes(t)&&n===i}));if(!u.length)return"continue";for(var s={},c=0;c<u.length;c++){var h=MA(u[c]);s[h.rangeId]=h}var f=s[o.rangeId];if(!f)return"continue";(function(e,t){var n,r,a,o,i;if(!t)return!1;var u=e.toJSON(),s=u.row,c=u.col,h=u.rowCount,f=u.colCount;if((null===(n=e.sheet())||void 0===n?void 0:n.id())!==t.sheetId)return!1;var d=e.rgType,v=t.type;return null!==(r=null===(a=(i={},(0,l.Z)(i,we.xj7.ALL,(function(){return v===we.xj7.ALL})),(0,l.Z)(i,we.xj7.ROW,(function(){return v===we.xj7.ROW&&s===t.row&&h===t.rowCount})),(0,l.Z)(i,we.xj7.COL,(function(){return v===we.xj7.COL&&c===t.col&&f===t.colCount})),(0,l.Z)(i,we.xj7.CELL,(function(){return v===we.xj7.NORMAL&&s===t.row&&c===t.col&&h===t.rowCount&&f===t.colCount})),(0,l.Z)(i,we.xj7.NORMAL,(function(){return v===we.xj7.NORMAL&&s===t.row&&c===t.col&&h===t.rowCount&&f===t.colCount})),o=i)[d])||void 0===a?void 0:a.call(o))&&void 0!==r&&r})(t.getSourceRange(a),f)||t.updateSourceDataRange(a,f,ZA.PASSIVE)};for(a.s();!(r=a.n()).done;)o()}catch(e){a.e(e)}finally{a.f()}}}},{key:"handleDataRangeAdjusted",value:function(e){var t=this,n=e.sheetId,r=e.dataRangeMap;this._dataRanges.forEach((function(e,a){var o=e.sheetId,i=e.rangeId;if(n===o){var u=r.get(i);if(void 0===u)return void t.deleteSourceDataRange(a);var s=Object.assign({},u),l=t.getDataSourceJSON(a);if(!(0,pe.default)(s,l)){t.setDataSourceJSON(a,s);var c=wA(s,t._spread);t._sourceRanges.set(a,c)}}}))}},{key:"handleMoveRange",value:function(e,t,n){var r=this,a=e.toRange;e.toEdgeAdjust&&n!==VA.UNDO&&n!==VA.REDO&&this._sourceRanges.forEach((function(e,t){if(e.isIntersect(a)){var n,o=a.sheet(),i=null===(n=r._dataRanges.get(t))||void 0===n?void 0:n.rangeId;if(o&&i){var u=o.rangeModel.getRangeFromId(i);r.handleDataRangeAdjusted({sheetId:o.id(),dataRangeMap:new Map([[i,u]])})}}}))}},{key:"getSourceRange",value:function(e){return this._sourceRanges.get(e)}},{key:"getDataSourceJSON",value:function(e){return this._dataRanges.get(e)}},{key:"setDataSourceJSON",value:function(e,t){this._dataRanges.set(e,t)}},{key:"getRangeIdByToken",value:function(e){var t=this._dataRanges.get(e);if(t)return t.rangeId}},{key:"addSourceDataRange",value:function(e,t,n){if(!PA(this._spread,t))return!1;this.setDataSourceJSON(e,t);var r=wA(t,this._spread);return this._sourceRanges.set(e,r),this._spread.dispatch("PivotDataSourceChanged",{blockToken:e,sourceRange:r,source:n}),!0}},{key:"updateSourceDataRange",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:ZA.DATA_RANGE_SELECTOR,r=Object.assign({},t);if(!PA(this._spread,r))return!1;if(this._dataRanges.has(e)){var a=this._dataRanges.get(e);if((0,pe.default)(a,r))return!1;this.setDataSourceJSON(e,r);var o=wA(r,this._spread);return this._sourceRanges.set(e,o),this._spread.dispatch("PivotDataSourceChanged",{blockToken:e,sourceRange:o,source:n}),!0}return this.addSourceDataRange(e,r,n)}},{key:"deleteSourceDataRange",value:function(e){this._dataRanges.delete(e),this._sourceRanges.delete(e)}},{key:"clearSourceRange",value:function(){this._sourceRanges.clear()}},{key:"clearDataRange",value:function(){this._dataRanges.clear()}},{key:"validateFormHeader",value:function(e,t,n,r,a){return(0,Kt.FW)([],{},{row:t,col:n,rowCount:1,colCount:a,sheetId:e.id()})}},{key:"getData",value:function(e,t,n,r,a,o){var i=function(e,t,n,r,a){var o,i,u=new tg,s=e._getModel();u.addModel(s.contentModel).addModel(s.dataValidationModel).addModel(s.styleDropdownModel).addModel(s.extralModel).addModel(s.reminderModel).addModel(new vA(e)).addModel(new mA(e)),r||u.addModel(new yA(e));var l=u.getExporter(t.row,t.col,t.rowCount,t.colCount);l.setExportType(n);var c=s.genBlockTable(l,a),h={id:e.id(),name:e.name(),index:0,rowCount:t.rowCount,columnCount:t.colCount,hidden:e._hidden};l.exportExtraInfo(h);var f=(null===(o=h.entities)||void 0===o?void 0:o.styles)||{},d=Object.keys(f).map((function(e){return parseInt(e,10)})),v=d.length>0?Math.max.apply(Math,(0,m.Z)(d)):0;if(c){var g,p=_n(c.data.rows);try{for(p.s();!(g=p.n()).done;){var y=g.value;if(y){var C,_=_n(y.columns);try{for(_.s();!(C=_.n()).done;){var R=C.value;if(R&&R.autoFormat){var w=R.autoFormat,k=void 0;if(delete R.autoFormat,R.styleId){var S=f[R.styleId];if(S.formatter&&S.formatter.formatCached)continue;k=JSON.parse(JSON.stringify(S))}else k={};k.formatter={formatCached:w},delete k.autoFormatter,f[++v]=k,R.styleId=v}}}catch(e){_.e(e)}finally{_.f()}}}}catch(e){p.e(e)}finally{p.f()}}if(v>0&&!(null!==(i=h.entities)&&void 0!==i&&i.styles)&&(h.entities=h.entities||{},h.entities.styles=f),c&&c.startRowIndex>t.row&&(c.data.rows=Array(c.startRowIndex-t.row).fill({columns:[]}).concat(c.data.rows),c.rowsCount+=c.startRowIndex-t.row),c){h.blocks=[{startRowIndex:0,rowsCount:c.rowsCount}];var E,T=_n(c.data.rows);try{for(T.s();!(E=T.n()).done;){var A=E.value;A&&A.columns.splice(0,t.col)}}catch(e){T.e(e)}finally{T.f()}}var I,b=[],F=_n(e._spanModel.getSpans(new Oi(t.row,t.col,t.rowCount,t.colCount,e)));try{for(F.s();!(I=F.n()).done;){var M=I.value,V=M.rowFrom()-t.row,N=Math.min(M.rowCount()+Math.min(V,0),t.rowCount);V=Math.max(V,0);var O=M.colFrom()-t.col,x=Math.min(M.colCount()+Math.min(O,0),t.colCount);O=Math.max(O,0),b.push({row:V,col:O,rowCount:N,colCount:x})}}catch(e){F.e(e)}finally{F.f()}return h.spans=b,{sheetSnapshot:h,data:null==c?void 0:c.data}}(e,{row:t,col:n,rowCount:r,colCount:a},3,!0,o),u=i.sheetSnapshot,s=i.data;return(0,Kt.i7)(s,u,{row:t,col:n,rowCount:r,colCount:a},e.parent.pivotService)}},{key:"getSourceRangeMap",value:function(){return this._sourceRanges}},{key:"dispose",value:function(){delete this._spread,this.clearSourceRange(),this.clearDataRange()}}]),e}();Gi([(0,Nt.Bind)()],LA.prototype,"handleAfterApply",null),Gi([(0,Nt.Bind)()],LA.prototype,"handleDataRangeAdjusted",null),Gi([(0,Nt.Bind)()],LA.prototype,"handleMoveRange",null),LA=Gi([(0,ct.b)(),Ji(0,(0,ht.f)(EA))],LA);var BA=function(){function e(){(0,y.Z)(this,e),this._pivotTables=new Map,this._pivotTableInfoMap=new Map,this._pivotTablePreViews=new Map,this._pivotTableViews=new Map}return(0,C.Z)(e,[{key:"getPivotTableByToken",value:function(e){return this._pivotTables.get(e)}},{key:"setPivotTable",value:function(e,t){this._pivotTables.set(e,t)}},{key:"deletePivotTableByToken",value:function(e){this._pivotTables.delete(e)}},{key:"getPivotTableSize",value:function(){return this._pivotTableInfoMap.size}},{key:"getPivotInfoMap",value:function(){return this._pivotTableInfoMap}},{key:"getPivotInfoByToken",value:function(e){return this._pivotTableInfoMap.get(e)}},{key:"setPivotTableInfo",value:function(e,t){this._pivotTableInfoMap.set(e,t)}},{key:"deletePivotTableInfoByToken",value:function(e){this._pivotTableInfoMap.delete(e)}},{key:"updatePivotTableInfo",value:function(e,t){var n=this.getPivotInfoByToken(e);if(n){var r=Object.assign(n,t);this.setPivotTableInfo(e,r)}}},{key:"getPivotTablePreViewByToken",value:function(e){return this._pivotTablePreViews.get(e)}},{key:"setPivotTablePreView",value:function(e,t){this._pivotTablePreViews.set(e,t)}},{key:"deletePivotTablePreView",value:function(e){this._pivotTablePreViews.delete(e)}},{key:"getViewDataModelByToken",value:function(e){return this._pivotTableViews.get(e)}},{key:"setViewDataModel",value:function(e,t){this._pivotTableViews.set(e,t)}},{key:"deleteViewDataModel",value:function(e){this._pivotTableViews.delete(e)}},{key:"dispose",value:function(){this._pivotTableInfoMap.clear(),this._pivotTables.clear(),this._pivotTableViews.clear(),this._pivotTablePreViews.clear()}}]),e}();Gi([(0,ht.f)(Pd)],BA.prototype,"sheet",void 0),BA=Gi([(0,ct.b)()],BA);var UA,HA,WA,jA=function e(t){if("object"!=(0,_.Z)(t)||null===t)return t;if(Array.isArray(t))return t.map(e);var n={};for(var r in t)n[r]=e(t[r]);return n},zA=function(e){return"object"!=(0,_.Z)(e)||null===e?e:Array.isArray(e)?(0,m.Z)(e):Object.assign({},e)},GA=function(e){if("object"!=(0,_.Z)(e)||null===e)return e;var t={};for(var n in e){var r=e[n];t[n]="cacheFieldInfo"===n?zA(r):jA(r)}return t},JA=function(e){for(var t=-1,n=e.length,r=0;r<n;r+=1)"FROM_JSON"===e[r].type&&(t=r);return-1===t?{fromJSONMsg:null,validMsgList:e}:{fromJSONMsg:e[t],validMsgList:e.slice(t+1)}},qA=new Set(["UPDATE_CACHE_FIELD","REMOVE_CACHE_FIELD_ITEM","ADD_CACHE_FIELD_ITEM"]),$A=new Set(["ADD_FIELD","REMOVE_FIELD","MOVE_FIELD","RENAME_FIELD","SET_FIELD_LABEL_FILTER","SET_FIELD_SUMMARY_TYPE","UPDATE_VALUE_POSITION","UPDATE_CACHE_FIELD","REMOVE_CACHE_FIELD_ITEM"]),YA=function(e){var t=e.some((function(e){return qA.has(e.type)})),n=t||e.some((function(e){return $A.has(e.type)}));return{rebuildCache:{needRebuild:t},rebuildCube:n,rebuildView:n||!0}};!function(e){e.SNAPSHOT_SET="snapshotSet",e.OPS_RECEIVED="opsReceived"}(HA||(HA={}));var KA=function(e){function t(e,n){var r,a;return(0,y.Z)(this,t),(a=(0,d.Z)(this,(0,v.Z)(t).call(this,e)))._subscriptions=[],a._prevSnapshot=null,a._destroyHooks=[],a._getOpExtraFromRebuildInfo=function(e){if(Object.keys(e).length<1)return null;var t=e.rebuildCache||{needRebuild:!1},n=t.needRebuild||e.rebuildCube||!1;return{rebuildCache:t,rebuildCube:n,rebuildView:n||e.rebuildView||!0}},a._token=n.token,a.specificVersion=null!==(r=n.specificVersion)&&void 0!==r?r:-1,a._onInit(n.initSnapshot),a}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"_onInit",value:function(e){e?this.setSnapshot(e):this.fetchSnapshot(),this._createEventListeners()}},{key:"bindDestoryHook",value:function(e){var t=this;return this._destroyHooks.push(e),function(){t._destroyHooks=t._destroyHooks.filter((function(t){return t!==e}))}}},{key:"onDestroy",value:function(){this._subscriptions.forEach((function(e){return e.unsubscribe()})),this._destroyHooks.forEach((function(e){try{e()}catch(e){console.error("[PIVOT] destroy pivot sync model error",e)}})),this._destroyHooks=[],this.model.destroy()}},{key:"manualDestroy",value:function(){this.onDestroy()}},{key:"_getHookFromObservable",value:function(e){var t=this;return function(n){var r=e.subscribe(n);return t._subscriptions.push(r),function(){return r.unsubscribe()}}}},{key:"_getBaseSnapshotChangeFromEvent",value:function(e){return{isCollab:e.isCollab,isPassive:e.isPassive,snapshot:this.getSnapshot(),prevSnapshot:this._prevSnapshot}}},{key:"_createEventListeners",value:function(){var e=this;this.snapshotSet$=this.model.clientVarsReady$.pipe((0,Pt.map)((function(e){var t,n="COLLAB"===e.type,r=n;return{eventType:e.type,isPassive:r,isCollab:n,snapshot:null===(t=e.detail)||void 0===t?void 0:t.initData}}))),this.onSnapshotSet=this._getHookFromObservable(this.snapshotSet$),this.opsReceive$=this.model.didUpdate$.pipe((0,Pt.map)((function(e){var t=[Xt.M1.undo,Xt.M1.redo].includes(e.type),n="COLLAB"===e.type,r=!e.detail.length||t||n||"BATCH"===e.type;return{eventType:e.type,isPassive:r,isUndoRedo:t,isCollab:n,ops:e.detail}}))),this.onOpsReceive=this._getHookFromObservable(this.opsReceive$),this.snapshotChange$=new gt.xQ,this.onSnapshotChange=this._getHookFromObservable(this.snapshotChange$),(0,Ct.T)(this.snapshotSet$.pipe((0,Pt.map)((function(t){return Object.assign({},e._getBaseSnapshotChangeFromEvent(t),{type:"snapshotSet"})}))),this.opsReceive$.pipe((0,Pt.map)((function(t){return Object.assign({},e._getBaseSnapshotChangeFromEvent(t),{type:"opsReceived",isUndoRedo:t.isUndoRedo,ops:t.ops})})))).pipe((0,Wt.b)((function(t){var n=t.snapshot;e._prevSnapshot=GA(n)}))).subscribe(this.snapshotChange$),this.undoRedoStatus$=this.model.didUpdate$.pipe((0,Pt.map)((function(){return{canUndo:e.model.canUndo(),canRedo:e.model.canRedo()}})),(0,jt.distinctUntilChanged)((function(e,t){return e.canUndo!==t.canUndo||e.canRedo!==t.canRedo}))),this.onUndoRedoStatusChange=this._getHookFromObservable(this.undoRedoStatus$),this.error$=this.model.error$,this.onError=this._getHookFromObservable(this.error$),this.inited$=new _t.t(1),(0,Ct.T)(this.snapshotSet$,this.error$).pipe((0,zt.P)(),(0,Pt.map)((function(){return!0}))).subscribe(this.inited$),this.onInited=this._getHookFromObservable(this.inited$)}},{key:"toJSON",value:function(){var e=this.getSnapshot();return(0,Re.default)(e)}},{key:"setSnapshot",value:function(e){this.model.setSnapshot(e)}},{key:"getSnapshot",value:function(){return this.model.getSnapshot()}},{key:"getVersion",value:function(){return this.specificVersion}},{key:"setVersion",value:function(e){this.specificVersion=e}},{key:"fetchSnapshot",value:function(){-1===this.specificVersion?this.model.fetchClientVars():this.model.fetchClientVarsByVersion(this.specificVersion)}},{key:"undo",value:function(){this.model.canUndo()&&this.model.undo()}},{key:"redo",value:function(){this.model.canRedo()&&this.model.redo()}},{key:"opsApply",value:function(e,t,n){var r=t&&this._getOpExtraFromRebuildInfo(t),a=Array.isArray(e)?e:[e],o=r?a.map((function(e){return Object.assign({},e,{_pivotExtra:r})})):a,i=Object.assign({undoable:!0},n);return this.model.apply(o,i)}},{key:"token",get:function(){return this._token}},{key:"syncVersion",get:function(){return this.model.getRecord().getSync().version}}],[{key:"getOpsExtras",value:function(e){var t,n=new Set(["cacheFieldInfo","rangeId"]),r=new Set(["collapseInfo","hiddenTotalInfo","showDataAsInfo","repeatLabelInfo","autoFitCol","sortInfo"]),a=!1,o=_n(e);try{for(o.s();!(t=o.n()).done;){if(t.value.p.some((function(e){return n.has(e)}))){a=!0;break}}}catch(e){o.e(e)}finally{o.f()}var i,u=a||!1,s=_n(e);try{for(s.s();!(i=s.n()).done;){var l=i.value,c=l.p,h=l.action;if(c.includes("summaryType")&&((null==h?void 0:h.oi)===Ot.wl.distinct||(null==h?void 0:h.oi)===Ot.wl.mid)){u=!0;break}if(!c.some((function(e){return r.has(e)}))){u=!0;break}}}catch(e){s.e(e)}finally{s.f()}return{rebuildCache:{needRebuild:a},rebuildCube:u,rebuildView:!0}}},{key:"getDefaultSnapshot",value:function(e,t,n){return{fields:{dim:{row:[],col:[],page:[],hide:[]},measure:[],cacheName:n,collapseInfo:{},hiddenTotalInfo:{},valueIndex:0,valuePosition:0,repeatLabelInfo:{}},cacheFieldInfo:t,emptyValueShowAs:"",errorValueShowAs:"",cacheName:n,rangeId:e,config:{},version:1}}}]),t}(Qt.yh);UA=KA,KA.handleClipboardData=function(){return Promise.resolve()},KA.type=xt.kH.PIVOT_TABLE,KA.syncType="PIVOT_TABLE",KA.apiConfig=function(){return{CLIENT_VARS:"/api/v2/sheet/blocks/pivot_table/snapshot/",CLIENT_VARS_BY_VERSION:"/api/v2/sheet/blocks/pivot_table/history/",NEW_CHANGES:"/api/v2/sheet/blocks/pivot_table/changesets/",USER_CHANGES:"/api/v2/sheet/blocks/pivot_table/user_change/"}},KA.createBlock=function(){var e=(0,u.Z)(i().mark((function e(t,n){var r;return i().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,n({headers:{"Content-Type":"application/json"},method:"post",url:"/api/v2/sheet/blocks/pivot_table/create/",data:{parentType:t.parentType,parentToken:t.parentToken,snapshot:JSON.stringify(t.snapshot),source:t.source,dataSource:null===(r=t.dataSource)||void 0===r?void 0:r[0]}});case 2:return e.abrupt("return",e.sent.data);case 3:case"end":return e.stop()}}),e)})));return function(t,n){return e.apply(this,arguments)}}(),KA.modifyUserChangePayloadBeforeSend=function(e){var t,n=null==e||null===(t=e.content)||void 0===t?void 0:t.operations;if(n){var r=n.map((function(e){e._pivotExtra;return(0,s.Z)(e,mn)})),a=UA.getOpsExtras(n);e.extra=JSON.stringify(a),e.content.operations=r}},function(e){e.SnapshotSet="SnapshotSet",e.OpsReceived="OpsReceive",e.SnapshotChanged="SnapshotChanged",e.UndoRedoStatusChanged="UndoRedoStatusChange",e.SyncError="SyncError",e.Initialized="Initialized"}(WA||(WA={}));var XA,QA,eI=function(){function e(t){var n=this;(0,y.Z)(this,e),this.page=null,this.corner=null,this.cornerBottom=null,this.row=null,this.rowRepeatLabel=null,this.rowWithButton=null,this.rowFields=null,this.rowCollapseFields=null,this.col=null,this.colRepeatLabel=null,this.colFields=null,this.value=null,this.rowSummary=null,this.bottomRowTotal=null,this._newStyleByOld={page:0,corner:1,cornerBottom:2,row:3,rowWithButton:4,rowFields:5,rowCollapseFields:6,col:7,colFields:8,colBottomField:9,value:10,rowSummary:11,bottomRowTotal:12},this.handleUIStateChange=function(){n.initStyles()},this.name=t,this._unsubscribeUIState=(0,en.onUIStateChange)(this.handleUIStateChange)}return(0,C.Z)(e,[{key:"initStyles",value:function(){this.initCommonStyle(),this.initPageAreaStyles(),this.initCornerAreaStyles(),this.initColAreaStyles(),this.initRowAreaStyles(),this.initValueStyles()}},{key:"getCellStyle",value:function(e){return{0:this.page,1:this.corner,14:this.colRepeatLabel,2:this.cornerBottom,3:this.row,13:this.rowRepeatLabel,4:this.rowWithButton,5:this.rowFields,6:this.rowCollapseFields,8:this.colFields,7:this.col,10:this.value,11:this.rowSummary,12:this.bottomRowTotal}[this._newStyleByOld[e]||e]||null}},{key:"dispose",value:function(){var e;null===(e=this._unsubscribeUIState)||void 0===e||e.call(this)}}]),e}(),tI=function(e){function t(e){var n;return(0,y.Z)(this,t),(n=(0,d.Z)(this,(0,v.Z)(t).call(this,e))).initStyles(),n}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"initCommonStyle",value:function(){this.whiteTextColor="#ffffff",this.blackTextColor="#1f2329";var e="#1c4cba";this.borderLine=new hd(e,1),this.dimStyle1=Ad.newStyle({backColor:"#f0f4ff",foreColor:this.blackTextColor,vAlign:we.g$I.Center,fontInfo:{fontWeight:700},textDecoration:we.aBM.none}),this.dimStyle2=Ad.newStyle({backColor:e,foreColor:this.whiteTextColor,vAlign:we.g$I.Center,fontInfo:{fontWeight:700},textDecoration:we.aBM.none},this.dimStyle1)}},{key:"initPageAreaStyles",value:function(){this.page=Ad.newStyle({vAlign:we.g$I.Center,backColor:"#f8f9fa",foreColor:this.blackTextColor,textDecoration:we.aBM.none})}},{key:"initCornerAreaStyles",value:function(){this.corner=this.dimStyle1.clone(),this.cornerBottom=this.dimStyle1.clone()}},{key:"initColAreaStyles",value:function(){this.col=this.dimStyle2.clone(),this.colRepeatLabel=this.col.clone(),this.colFields=this.dimStyle1.clone()}},{key:"initRowAreaStyles",value:function(){this.page?(this.row=this.page.clone(),this.rowWithButton=this.row.clone(),this.rowWithButton=Ad.newStyle({fontInfo:{fontWeight:700}},this.row),this.rowRepeatLabel=this.rowWithButton.clone(),this.rowFields=this.dimStyle1.clone(),this.rowCollapseFields=this.dimStyle1.clone()):console.warn("[Pivot Table]: Theme Row Area Style Init Fail!")}},{key:"initValueStyles",value:function(){this.rowSummary=this.dimStyle1.clone(),this.bottomRowTotal=Ad.newStyle({borderTop:this.borderLine},this.dimStyle1)}}]),t}(eI),nI=function(){function e(){var t=this;(0,y.Z)(this,e),this.handleUIStateChange=function(){t.initStyles()},this.initStyles(),this._unsubscribeUIState=(0,en.onUIStateChange)(this.handleUIStateChange)}return(0,C.Z)(e,[{key:"initStyles",value:function(){this.bgColor1="#f5f6f7",this.bgColor2="#8f959e",this.bgColor3="#ffffff",this.tipTextColor="#8f959e",this.whiteTextColor="#ffffff",this.blackTextColor="#1f2329";var e=new hd(this.bgColor1,1);this.row=Ad.newStyle({backColor:this.bgColor1,foreColor:this.blackTextColor,borderRight:e,borderTop:e,vAlign:we.g$I.Center,textDecoration:we.aBM.none}),this.page=Ad.newStyle({textDecoration:we.aBM.none,backColor:this.bgColor1,foreColor:this.blackTextColor,vAlign:we.g$I.Center}),this.corner=Ad.newStyle({textDecoration:we.aBM.none});var t=new hd(this.bgColor2,1);this.col=Ad.newStyle({backColor:this.bgColor2,foreColor:this.whiteTextColor,borderLeft:t,borderBottom:t,borderTop:t,vAlign:we.g$I.Center,textDecoration:0});var n=new hd(this.bgColor3,1);this.value=Ad.newStyle({backColor:this.bgColor3,borderTop:n,borderLeft:n,vAlign:we.g$I.Center,textDecoration:0}),this.valueTip=Ad.newStyle({foreColor:this.tipTextColor,vAlign:we.g$I.Center,hAlign:we.KqL.Center,wordWrap:1},this.value)}},{key:"getPageStyle",value:function(){return this.page}},{key:"getCornerStyle",value:function(){return this.corner}},{key:"getColStyle",value:function(){return this.col}},{key:"getRowStyle",value:function(){return this.row}},{key:"getValueStyle",value:function(){return this.value}},{key:"getValueTipStyle",value:function(){return this.valueTip}},{key:"dispose",value:function(){var e;null===(e=this._unsubscribeUIState)||void 0===e||e.call(this)}}]),e}(),rI=function(){function e(){(0,y.Z)(this,e),this.themeMap=new Map}return(0,C.Z)(e,[{key:"initEmptyTheme",value:function(){this.emptyTheme=new nI}},{key:"getCellStyle",value:function(e,t){var n=this.themeMap.get(e);return n||(n=this.createTheme(e),this.themeMap.set(e,n)),n.getCellStyle(t)}},{key:"createTheme",value:function(e){return new tI(e)}},{key:"getEmptyPivotTableStyle",value:function(e,t,n,r){if(this.emptyTheme||this.initEmptyTheme(),e)return this.emptyTheme.getPageStyle();if(void 0===t||void 0===n||!r)return null;if(!r.containCell(t,n))return null;var a=r.rowFrom(),o=r.colFrom(),i=r.rowTo(),u=r.colTo();return t===a&&n===o?this.emptyTheme.getCornerStyle():t===a&&n>o&&n<=u?this.emptyTheme.getColStyle():n===o&&t>a&&t<=i?this.emptyTheme.getRowStyle():t===a+5&&n<=u?this.emptyTheme.getValueTipStyle():t<=i&&n<=u?this.emptyTheme.getValueStyle():null}},{key:"composePivotStyle",value:function(e,t){return t?e?Ad.composeStyles(t,e):t:e}},{key:"dispose",value:function(){this.emptyTheme.dispose();var e,t=_n(this.themeMap);try{for(t.s();!(e=t.n()).done;){var n=(0,p.Z)(e.value,2);n[0];n[1].dispose()}}catch(e){t.e(e)}finally{t.f()}this.themeMap.clear(),this.emptyTheme=null}}]),e}(),aI=new rI,oI="sheet-proxy-pivot-model",iI="pivot-table-manager-v2",uI="sheet-pivot-data-source-manager",sI="sync-model-manager",lI="sync-model-manager-in-worker",cI=function(){function e(){(0,y.Z)(this,e),this.cellPivotCache={shareKey:{},id:0}}return(0,C.Z)(e,[{key:"getSheet",value:function(){return this.sheet}},{key:"getPivotTableByToken",value:function(e){return this._sheetProxyPivotModel.getPivotTableByToken(e)}},{key:"getPivotTableByName",value:function(e){return this._sheetProxyPivotModel.getPivotTableByToken(e)}},{key:"getPivotInfoByToken",value:function(e){return this._sheetProxyPivotModel.getPivotInfoByToken(e)}},{key:"getPivotInfoByName",value:function(e){return this._sheetProxyPivotModel.getPivotInfoByToken(e)}},{key:"getPivotInfoMap",value:function(){return this._sheetProxyPivotModel.getPivotInfoMap()}},{key:"getCellPivotCache",value:function(e,t){if(this.cellPivotCache[e]&&void 0!==this.cellPivotCache[e][t])return this.cellPivotCache.shareKey[this.cellPivotCache[e][t]]}},{key:"setCellPivotCache",value:function(e,t,n){this.cellPivotCache[e]||(this.cellPivotCache[e]={}),void 0===this.cellPivotCache.shareKey[n]&&(this.cellPivotCache.shareKey[n]=this.cellPivotCache.id,this.cellPivotCache.shareKey[this.cellPivotCache.id]=n,this.cellPivotCache.id++),this.cellPivotCache[e][t]=this.cellPivotCache.shareKey[n]}},{key:"updateCellPivotCache",value:function(e,t,n){var r=this,a=t.pageRange,o=t.contentRange,i=t.spanRange,u=n.pageRange,s=n.contentRange,l=n.spanRange;[a,o,i].forEach((function(t){if(t)for(var n=t.rowFrom(),a=t.colFrom(),o=t.rowCount(),i=t.colCount(),u=n;u<n+o;u++)for(var s=a;s<a+i;s++)r.deleteCellPivotCache(u,s,e)})),[u,s,l].forEach((function(t){if(t)for(var n=t.rowFrom(),a=t.colFrom(),o=t.rowCount(),i=t.colCount(),u=n;u<n+o;u++)for(var s=a;s<a+i;s++)r.setCellPivotCache(u,s,e)}))}},{key:"deleteCellPivotCache",value:function(e,t,n){var r=this.cellPivotCache.shareKey[n];this.cellPivotCache[e]&&void 0!==r&&this.cellPivotCache[e][t]===r&&(this.cellPivotCache[e][t]=void 0)}},{key:"deleteCellPivotCacheByToken",value:function(e){var t=this.cellPivotCache.shareKey[e];void 0!==t&&(this.cellPivotCache.shareKey[t]=void 0,this.cellPivotCache.shareKey[e]=void 0)}},{key:"clearCellPivotCache",value:function(){this.cellPivotCache={shareKey:{},id:0}}},{key:"getViewDataModelByToken",value:function(e){return this._sheetProxyPivotModel.getViewDataModelByToken(e)}},{key:"getAllPivotTableRanges",value:function(){var e,t=[],n=_n(this.getPivotInfoMap());try{for(n.s();!(e=n.n()).done;){var r=(0,p.Z)(e.value,2)[1],a=r.pageRange,o=r.contentRange;a&&t.push(a),o&&t.push(o)}}catch(e){n.e(e)}finally{n.f()}return t}},{key:"getViewDataModelByName",value:function(e){return this._sheetProxyPivotModel.getViewDataModelByToken(e)}},{key:"getPivotTablePreViewByToken",value:function(e){return this._sheetProxyPivotModel.getPivotTablePreViewByToken(e)}},{key:"getPositionCell",value:function(e){if(this.hasPivotTable()){var t=this._sheetProxyPivotModel.getPivotInfoByToken(e);return t?{row:t.row,col:t.col}:void 0}}},{key:"getPivotTableByCell",value:function(e,t){var n=this.getPivotTableNameByCell(e,t);if(n)return this.getPivotTableByToken(n)}},{key:"getActivePivotTable",value:function(){var e=this.sheet.getActiveCellIndex();return this.getPivotTableByCell(e.row,e.column)}},{key:"getPivotTableNameByCell",value:function(e,t){return this.getCellPivotCache(e,t)||""}},{key:"hasPivotTableAtCell",value:function(e,t){return!!this.hasPivotTable()&&!!this.getPivotTableNameByCell(e,t)}},{key:"getPivotErrorStateByCell",value:function(e,t){if(!this.hasPivotTableAtCell(e,t))return null;var n=this.getPivotTableNameByCell(e,t);if(!n)return null;var r=this.getPivotInfoByToken(n);return r?r.errorState:null}},{key:"getViewDataModelByPosition",value:function(e,t){if(this.hasPivotTableAtCell(e,t)){var n=this.getPivotTableNameByCell(e,t);return this.getViewDataModelByToken(n)}}},{key:"getFilterSort",value:function(e,t){var n=this.getPivotTableNameByCell(e,t),r=this.getPivotInfoByToken(n);if(r&&!r.errorState&&!r.isHidden&&!r.isEmpty){var a,o=this.getViewDataModelByToken(n),i=r.pageRange,u=r.contentRange;return null!=i&&i.containCell(e,t)&&(a=null==o?void 0:o.getPageCellButtonState(e-i.rowFrom(),t-i.colFrom())),null!=u&&u.containCell(e,t)&&(a=null==o?void 0:o.getCellButtonState(e-u.rowFrom(),t-u.colFrom())),void 0!==a&&a<=32?a:void 0}}},{key:"getCollapse",value:function(e,t){var n=this.getPivotTableNameByCell(e,t),r=this.getPivotInfoByToken(n);if(r&&r.errorState===Zf.None&&!r.isHidden&&!r.isEmpty){var a=this.getViewDataModelByToken(n),o=r.contentRange;if(null!=o&&o.containCell(e,t)){var i=null==a?void 0:a.getCellButtonState(e-o.rowFrom(),t-o.colFrom());return 64===i||128===i?i:void 0}}}},{key:"getRepeatLabelInfo",value:function(e,t){var n,r,a={isRepeatLabel:!1},o=this.getPivotTableNameByCell(e,t),i=null===(n=this.getPivotInfoByToken(o))||void 0===n?void 0:n.contentRange;return o&&i&&(null===(r=this.getViewDataModelByToken(o))||void 0===r?void 0:r.getRepeatLabelInfo(e-i.rowFrom(),t-i.colFrom()))||a}},{key:"getCellInfo",value:function(e,t){if(this.hasPivotTableAtCell(e,t)){var n=this.getPivotTableNameByCell(e,t),r=this.getViewDataModelByToken(n),a=this.getPivotTableByToken(n),o=this.getPivotInfoByToken(n),i=o.pageRange;if(null!=i&&i.containCell(e,t))return null==r?void 0:r.getPageCellInfo(e-i.rowFrom(),t-i.colFrom());var u=o.contentRange;return null!=u&&u.containCell(e,t)?null==r?void 0:r.getCellInfo(e-u.rowFrom(),t-u.colFrom(),(null==a?void 0:a._fieldsModel)||null):void 0}}},{key:"getCellValue",value:function(e,t){if(!this.hasPivotTableAtCell(e,t))return null;var n=this.getPivotTableNameByCell(e,t),r=this.getPivotInfoByToken(n),a=r.contentRange,o=r.pageRange,i=r.isEmpty,u=r.errorState,s=r.isHidden,l=r.loaded,c=r.row,h=r.col;if(s)return null;switch(!0){case c===e&&h===t&&(u===Zf.Loading||!l):return ut.ErrorConstant.WAIT_ASYNC;case l&&u===Zf.None:var f,d=this.getViewDataModelByToken(n),v=this.getPivotTableByToken(n);if(null!=o&&o.containCell(e,t)){if(i)return _A();f=null==d?void 0:d.getPageCellValue(e-o.rowFrom(),t-o.colFrom())}if(null!=a&&a.containCell(e,t)){if(i)return CA(e,t,a)||null;f=null==d?void 0:d.getCellValue(e-a.rowFrom(),t-a.colFrom(),null==v?void 0:v.getEmptyValueShowAs())}var g=this.getCellInfo(e,t),m=RA(this.sheet,f,g,d||null);return""===m||void 0===m?null:m;case c===e&&h===t&&l&&u===Zf.Circle:return ut.ErrorConstant.CIRCULAR_DEPENDENCY;case c===e&&h===t&&l&&u!==Zf.None:return ut.ErrorConstant.REF}return null}},{key:"getCellStyle",value:function(e,t){if(!this.hasPivotTableAtCell(e,t))return null;var n=this.getPivotTableNameByCell(e,t),r=this.getPivotInfoByToken(n),a=r.pageRange,o=r.contentRange,i=r.errorState,u=r.isEmpty,s=r.themeName;if(r.isHidden)return null;if(null!=a&&a.containCell(e,t))return i?null:u?aI.getEmptyPivotTableStyle(!0):aI.getCellStyle(s,0);if(o){if(u)return aI.getEmptyPivotTableStyle(!1,e,t,o);if(i)return null;var l=this.getPivotTableByCell(e,t),c=this.getViewDataModelByToken(n);if(!c)return null;var h=c.getCellInfo(e-o.rowFrom(),t-o.colFrom(),(null==l?void 0:l._fieldsModel)||null),f=c.getCellStyleType(e-o.rowFrom(),t-o.colFrom());f||"none"===h.areaType||(f=h.styleType);var d=aI.getCellStyle(s,f);return function(e,t,n,r){var a=null==t?void 0:t.areaType,o="value"===a||"colSummary"===a||"rowSummary"===a||"total"===a;if(!t||!o&&"colDim"!==a&&"rowDim"!==a)return n;var i="",u=1,s=!1;if("colDim"===a||"rowDim"===a){s=!0;var l=t.fieldName,c=t.fieldNameList,h=t.types,f=c.indexOf(l||"");f>-1&&(i=l,u=h[f])}else i=t.measureFieldName;var d=e.getPivotTableManager().getPivotTableByName(r);if(d&&i){var v=n||Md(),g=null==d?void 0:d.getFieldFormat(i,o);return s&&g&&2===u||!s&&g?Ad.withFormatter(v,(0,Se.createFormatter)(e.formatterService,g)):v}return n}(this.sheet,h,d,n)}return null}},{key:"getCellErrorInfo",value:function(e,t){var n,r=this.getCellInfo(e,t),a=null==r||null===(n=r.value)||void 0===n?void 0:n.errorCode;if(void 0!==a){var o=this.getPivotTableNameByCell(e,t),i=this.getViewDataModelByToken(o),u=r.value.errorInfoArgsId;return{errorCode:a,errorInfoArgs:null==i?void 0:i.getErrorInfoArgsFromId(u)}}}},{key:"getFieldValueInfo",value:function(e,t,n){var r=n.fieldName,a=n.value,o=n.isSubTotal,i=n.isTopSubTotal,u=n.buttonState,s=(o||i)&&!(u&&(128&u||64&u)),l=this.getFilterSort(e,t);return void 0===r||"object"!=(0,_.Z)(a)||void 0===a.text||void 0===a.type||s||l?null:{type:a.type,fieldName:r,value:a.text}}},{key:"isIntersectPivotTable",value:function(e,t,n,r){var a=arguments.length>4&&void 0!==arguments[4]?arguments[4]:[];if(!this.hasPivotTable())return!1;for(var o=e;o<e+n;o++)for(var i=t;i<t+r;i++){var u=this.getPivotTableNameByCell(o,i);if(u&&!a.includes(u))return!0}return!1}},{key:"isEmptyPivotTable",value:function(e){var t;return!(null===(t=this.getPivotInfoByToken(e))||void 0===t||!t.isEmpty)}},{key:"getPivotTableSize",value:function(){return this._sheetProxyPivotModel.getPivotTableSize()}},{key:"hasPivotTable",value:function(){return!!this.getPivotTableSize()}},{key:"setPivotTable",value:function(e,t){this._sheetProxyPivotModel.setPivotTable(e,t)}},{key:"setPivotTableInfo",value:function(e,t){this._sheetProxyPivotModel.setPivotTableInfo(e,t),this.setCellPivotCache(t.row,t.col,e)}},{key:"setPivotTablePreView",value:function(e,t){this._sheetProxyPivotModel.setPivotTablePreView(e,t)}},{key:"setViewDataModel",value:function(e,t){this._sheetProxyPivotModel.setViewDataModel(e,t)}},{key:"updatePivotTableInfo",value:function(e,t){var n=this.getPivotInfoByToken(e);if(n){var r=Object.assign(n,t);this.setPivotTableInfo(e,r)}}},{key:"updatePivotTableInfoByPosition",value:function(e,t,n){var r,a,o=this.getPivotInfoByToken(e);if(o&&(t!==o.row||n!==o.col)){var i=Object.assign({},o,{pageRange:null===(r=o.pageRange)||void 0===r?void 0:r.clone(),contentRange:null===(a=o.contentRange)||void 0===a?void 0:a.clone()}),u=i.pageRange,s=i.contentRange,l=i.spanRange,c=i.isEmpty,h=c?mk(this.sheet,t,n):mk(this.sheet,t,n,null==u?void 0:u.toJSON(),null==s?void 0:s.toJSON()),f=h.pageRange,d=h.contentRange,v=h.spanRange,g=Object.assign({},i,{row:t,col:n,pageRange:f,contentRange:d,spanRange:v});this.updatePivotTableInfo(e,g),this.updateCellPivotCache(e,i,g),c&&(l&&this.sheet.removeEmptyPivotTableSpan(l),v&&this.sheet.setEmptyPivotTableSpan(v))}}},{key:"deletePivotTableInfoByToken",value:function(e){this._sheetProxyPivotModel.deletePivotTableInfoByToken(e)}},{key:"deletePivotTablePreView",value:function(e){this._sheetProxyPivotModel.deletePivotTablePreView(e)}},{key:"deleteViewDataModel",value:function(e){this._sheetProxyPivotModel.deleteViewDataModel(e)}},{key:"deletePivotTableByToken",value:function(e){this._sheetProxyPivotModel.deletePivotTableByToken(e)}},{key:"composePivotStyle",value:function(e,t,n){var r=this.getCellStyle(t,n);return aI.composePivotStyle(e,r)}},{key:"dispose",value:function(){this._sheetProxyPivotModel.dispose()}}]),e}();Gi([(0,ht.f)(Pd)],cI.prototype,"sheet",void 0),Gi([(0,ht.f)(oI)],cI.prototype,"_sheetProxyPivotModel",void 0),cI=Gi([(0,ct.b)()],cI),function(e){e.REFETCH_META="REFETCH_META",e.TOO_OLD="TOO_OLD",e.NORMAL="NORMAL"}(XA||(XA={})),function(e){e.WAITING_REFETCH="WAITING_REFETCH",e.SNAPSHOT_TOO_OLD="SNAPSHOT_TOO_OLD",e.VERSION_INVALID="VERSION_OUTDATED",e.RETRY_FETCH_META="RETRY_FETCH_META"}(QA||(QA={}));var hI=function(){function e(t,n,r,a){(0,y.Z)(this,e),this.spread=a,this._versionData={version:-1,configMd5:"",status:"NORMAL",respCache:null},this._configMd5Calculator=function(){return""},this._token=t,this._request=n,this._configMd5Calculator=r}var t,n,r,a,o,s,l;return(0,C.Z)(e,[{key:"bindSyncModel",value:function(e){this._syncModel=e}},{key:"markNotWaitingRefetchMeta",value:function(){this._versionData.status="NORMAL"}},{key:"setVersion",value:function(e,t){return this._versionData.version===e||(this._versionData={version:e,configMd5:this._configMd5Calculator(t),status:"NORMAL",respCache:null}),this}},{key:"updateVersion",value:function(){var e;return this._syncModel?(this.setVersion(null!==(e=this._syncModel.syncVersion)&&void 0!==e?e:-1,this._syncModel.getSnapshot()||{}),this):(console.error("[PIVOT] no syncModel bind to requester, cannot auto update version"),this)}},{key:"_retryRequest",value:(l=(0,u.Z)(i().mark((function e(t){var n,r,a,o=arguments;return i().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:n=o.length>1&&void 0!==o[1]?o[1]:3,e.prev=1,r=0;case 3:if(!(r<n)){e.next=12;break}return e.next=6,this._request(t);case 6:if(!(a=e.sent).data||0!==a.code){e.next=9;break}return e.abrupt("return",a.data);case 9:r+=1,e.next=3;break;case 12:throw Error("failed after retry ".concat(n," times! url: ").concat(t.url));case 15:e.prev=15,e.t0=e.catch(1),console.error("[PIVOT] request service calc: error happened",e.t0);case 18:case"end":return e.stop()}}),e,this,[[1,15]])}))),function(e){return l.apply(this,arguments)})},{key:"_askRefreshMeta",value:(s=(0,u.Z)(i().mark((function e(){return i().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this._retryRequest({url:"api/v2/sheet/blocks/pivot_table/rebuild",method:"POST",data:{token:this._token,buildCache:!0,buildCube:!0,buildView:!0}}));case 1:case"end":return e.stop()}}),e,this)}))),function(){return s.apply(this,arguments)})},{key:"_getVersion",value:function(){return this._versionData.version}},{key:"_assertIsLatestVersion",value:function(e){if(this._getVersion()!==e)throw"VERSION_OUTDATED"}},{key:"_getCache",value:function(){return this._versionData.respCache}},{key:"_setCacheItem",value:function(e,t){var n=this._getCache();n&&(n[e]=t)}},{key:"triggerServiceCalcStatus",value:function(e){this.spread.dispatch("PivotServiceCalcStatusChanged",{pivotTableToken:this._token,status:e})}},{key:"_fetchViewMeta",value:(o=(0,u.Z)(i().mark((function e(){var t,n,r,a,o;return i().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if("REFETCH_META"!==this._versionData.status){e.next=2;break}throw"WAITING_REFETCH";case 2:if("TOO_OLD"!==this._versionData.status){e.next=4;break}throw"SNAPSHOT_TOO_OLD";case 4:if(!(t=this._getCache())){e.next=7;break}return e.abrupt("return",t.meta);case 7:return n=this._getVersion(),e.next=10,this._retryRequest({url:"/api/v2/sheet/blocks/pivot_table/view_meta",params:{token:this._token},method:"GET"});case 10:if(r=e.sent,this._assertIsLatestVersion(n),r.isLatest){e.next=13;break}throw this._versionData.status="REFETCH_META",this.triggerServiceCalcStatus("Loading"),"WAITING_REFETCH";case 13:if(a=r.viewMeta,!((o="string"==typeof a?JSON.parse(a):a).blockRev>n)){e.next=16;break}throw this._versionData.status="TOO_OLD",console.log("[PIVOT] Snapshot version too old. viewMeta: ".concat(o.blockRev,", snapshot: ").concat(n)),"SNAPSHOT_TOO_OLD";case 16:if(!(o.blockRev<n)){e.next=18;break}throw this._askRefreshMeta(),this._versionData.status="REFETCH_META",this.triggerServiceCalcStatus("Loading"),"WAITING_REFETCH";case 18:return e.abrupt("return",(this._versionData.status="NORMAL",this._versionData.respCache={meta:o},o));case 19:case"end":return e.stop()}}),e,this)}))),function(){return o.apply(this,arguments)})},{key:"_getViewMeta",value:(a=(0,u.Z)(i().mark((function e(){var t;return i().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(null==(t=this._getCache())||!t.meta){e.next=3;break}return e.abrupt("return",t.meta);case 3:return e.next=5,this._fetchViewMeta();case 5:return e.abrupt("return",e.sent);case 6:case"end":return e.stop()}}),e,this)}))),function(){return a.apply(this,arguments)})},{key:"_extractDataFromSliceParts",value:function(e,t){var n={};e.forEach((function(e){var t=e.key,r=e.value;n[t]=r}));var r=t.map((function(e){return n[e]})).filter((function(e){return"string"==typeof e}));if(r.length!==t.length)throw this._versionData.respCache=null,this._versionData.status="NORMAL","RETRY_FETCH_META";var a=r.join("");return a?(0,we.ecX)(a):null}},{key:"fetchView",value:(r=(0,u.Z)(i().mark((function e(){var t,n;return i().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:t=0;case 1:if(!(t<3)){e.next=17;break}return e.prev=2,e.next=5,this._getViewMeta();case 5:return n=e.sent,e.abrupt("return",this.fetchViewDataFromViewMeta(n));case 9:if(e.prev=9,e.t0=e.catch(2),"RETRY_FETCH_META"===e.t0){e.next=13;break}throw e.t0;case 13:this.triggerServiceCalcStatus("Loading"),console.log("[PIVOT] viewMeta fetch failed.");case 14:t+=1,e.next=1;break;case 17:case"end":return e.stop()}}),e,this,[[2,9]])}))),function(){return r.apply(this,arguments)})},{key:"handleMessageFromServer",value:(n=(0,u.Z)(i().mark((function e(t){var n,r,a;return i().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=JSON.parse(t),r={blockRev:n.block_rev,dataSourceRev:n.data_source_rev,viewSlices:n.view_slice_keys},e.prev=1,e.next=4,this.fetchViewDataFromViewMeta(r);case 4:return a=e.sent,e.abrupt("return",(console.log("[PIVOT] viewData",a),this._setCacheItem("view",a),this.triggerServiceCalcStatus("Loaded"),a));case 8:if(e.prev=8,e.t0=e.catch(1),"RETRY_FETCH_META"===e.t0){e.next=12;break}throw e.t0;case 12:this.triggerServiceCalcStatus("Loading"),console.log("[PIVOT] message invaild from server");case 13:case"end":return e.stop()}}),e,this,[[1,8]])}))),function(e){return n.apply(this,arguments)})},{key:"fetchViewDataFromViewMeta",value:(t=(0,u.Z)(i().mark((function e(t){var n,r,a,o,u,s,l,c;return i().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(null==(n=this._getCache())||!n.view){e.next=3;break}return e.abrupt("return",(this.triggerServiceCalcStatus("Loaded"),n.view));case 3:if(this.triggerServiceCalcStatus("Loading"),r=this._getVersion(),(a=t.viewSlices||[]).length){e.next=7;break}throw Error("[PIVOT] view slices length is 0");case 7:e.prev=7,o=[],u=0;case 10:if(!(u<a.length)){e.next=19;break}return s=a[u],e.next=14,this._retryRequest({url:"/api/v2/sheet/blocks/pivot_table/view_slices/",params:{token:this._token,sliceKeys:[s]},method:"GET"});case 14:l=e.sent.slices,o.push.apply(o,(0,m.Z)(l));case 16:u++,e.next=10;break;case 19:return this._assertIsLatestVersion(r),c=this._extractDataFromSliceParts(o,a),e.abrupt("return",(console.log("[PIVOT] viewData",c),this._setCacheItem("view",c),this.triggerServiceCalcStatus("Loaded"),c));case 24:if(e.prev=24,e.t0=e.catch(7),"RETRY_FETCH_META"===e.t0){e.next=28;break}throw e.t0;case 28:console.log("[PIVOT] viewData is invalid, retry fetch meta.");case 29:case"end":return e.stop()}}),e,this,[[7,24]])}))),function(e){return t.apply(this,arguments)})}]),e}(),fI={source:xt.lU.SHEET,parent:xt.lU.SHEET,cross:!1},dI=function(){function e(){(0,y.Z)(this,e),this.$watcher=new we.CPL}return(0,C.Z)(e,[{key:"subscribe",value:function(e,t){return this.$watcher.subscribe(e,t)}},{key:"dispatch",value:function(e,t){this.$watcher.dispatch(e,t)}},{key:"dispose",value:function(){this.$watcher.destroy()}}]),e}(),vI=function(e){function t(){var e;return(0,y.Z)(this,t),(e=(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))).subscribers=new Map,e.syncModels=new Map,e}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"toJSON",value:function(){var e,t={},n=_n(this.syncModels);try{for(n.s();!(e=n.n()).done;){var r=(0,p.Z)(e.value,2),a=r[0],o=r[1];t[a]=o.toJSON()}}catch(e){n.e(e)}finally{n.f()}return t}},{key:"createSyncModel",value:function(e){var t,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:-1,r=this._spread,a={token:e,type:xt.kH.PIVOT_TABLE,specificVersion:n,circulationInfo:fI},o=null===(t=r.sheetBlocksManager)||void 0===t?void 0:t.modelManager.createBlockModel(a);return o&&this.setSyncModel(e,o),o}},{key:"subscribePivotSyncPropagation",value:function(e,t){var n=this,r=[t.onSnapshotSet((function(t){n.dispatch("SnapshotSet",{blockToken:e,data:t})})),t.onOpsReceive((function(t){n.dispatch("OpsReceive",{blockToken:e,data:t})})),t.onSnapshotChange((function(t){n.dispatch("SnapshotChanged",{blockToken:e,data:t})})),t.onUndoRedoStatusChange((function(t){n.dispatch("UndoRedoStatusChange",{blockToken:e,data:t})})),t.onError((function(t){n.dispatch("SyncError",{blockToken:e,data:t})})),t.onInited((function(t){n.dispatch("Initialized",{blockToken:e,data:t})}))];this.subscribers.set(e,r)}},{key:"setSyncModel",value:function(e,t){this.syncModels.set(e,t),this.subscribePivotSyncPropagation(e,t)}},{key:"getSyncModel",value:function(e){return this.syncModels.get(e)}},{key:"deleteSyncModel",value:function(e){var t;this.clearSyncSubscribe(e),null!==(t=this.syncModels.get(e))&&void 0!==t&&t.manualDestroy(),this.syncModels.delete(e)}},{key:"opsApply",value:function(e,t){var n=this.syncModels.get(e);if(!n)return console.log("[PIVOT SYNC] syncModel is not created by token: ",e),[];var r=t.ops,a=t.rebuildInfo,o=t.applyOptions;return n.opsApply(r,a,o)}},{key:"getSnapshot",value:function(e){var t;return null===(t=this.syncModels.get(e))||void 0===t?void 0:t.getSnapshot()}},{key:"getVersion",value:function(e){var t;return null===(t=this.syncModels.get(e))||void 0===t?void 0:t.getVersion()}},{key:"reset",value:function(){var e=this;this.syncModels.forEach((function(t,n){e.deleteSyncModel(n)}))}},{key:"clearSyncSubscribe",value:function(e){var t;null!==(t=this.subscribers.get(e))&&void 0!==t&&t.forEach((function(e){e()})),this.subscribers.delete(e)}},{key:"dispose",value:function(){this.reset(),(0,f.Z)((0,v.Z)(t.prototype),"dispose",this).call(this)}}]),t}(dI=Gi([(0,ct.b)()],dI));Gi([(0,ht.f)(EA)],vI.prototype,"_spread",void 0),vI=Gi([(0,ct.b)()],vI);var gI=function(e){function t(){var e;return(0,y.Z)(this,t),(e=(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))).snapshotMap=new Map,e}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"getSnapshot",value:function(e){return this.snapshotMap.get(e)}},{key:"setSnapshot",value:function(e,t){var n=t.snapshot;this.snapshotMap.set(e,n),this.dispatch("SnapshotChanged",{blockToken:e,data:t})}},{key:"deleteSyncModel",value:function(e){this.snapshotMap.delete(e)}},{key:"fromJSON",value:function(e){for(var t=0,n=Object.entries(e);t<n.length;t++){var r=(0,p.Z)(n[t],2),a=r[0],o=r[1];this.setSnapshot(a,{type:"snapshotSet",isPassive:!0,isCollab:!0,snapshot:o,prevSnapshot:null})}}},{key:"reset",value:function(){this.snapshotMap.clear()}},{key:"dispose",value:function(){this.reset(),(0,f.Z)((0,v.Z)(t.prototype),"dispose",this).call(this)}}]),t}(dI);gI=Gi([(0,ct.b)()],gI);function mI(e){var t=new dt.W;return t.bind(Dd).toDynamicValue(e.getSheetDataModel),t.bind(Ud).toDynamicValue(e.getI18n),t.bind("worksheet/watcher").toDynamicValue(e.getWatch),t.bind(Ld).toDynamicValue(e.getFilterWatchHub),t.bind(Hd).toDynamicValue(e.getCalcEngine).inSingletonScope(),t.bind(Bd).toDynamicValue((function(){return t.get.bind(t)})),t.bind(Wd).toDynamicValue(e.getStageTracker),t.bind(Pd).toDynamicValue(e.getSheet),t.bind(uA).toSelf().inSingletonScope(),t.bind(AE).toSelf().inSingletonScope(),t.bind(IE).toSelf().inSingletonScope(),t.bind(cA).toSelf().inSingletonScope(),t.bind(sE).toSelf().inSingletonScope(),t.bind(zd).toSelf().inSingletonScope(),t.bind(cE).toSelf().inSingletonScope(),t.bind(uE).toSelf().inSingletonScope(),t.bind(bE).toSelf().inSingletonScope(),t.bind(uT).toSelf(),t.bind(jd).toDynamicValue(e.getMoirae),t.bind(Gd).toSelf().inSingletonScope(),function(e){e.bind(sT).toSelf().inSingletonScope()}(t),function(e){e.bind(fT).toSelf().inSingletonScope()}(t),function(e){e.bind(wE).toSelf(),e.bind(SE).toSelf().inSingletonScope(),e.bind(_E).toSelf(),e.bind(CE).toSelf().inSingletonScope()}(t),function(e){e.bind(vT).toSelf(),e.bind(gT).toSelf().inSingletonScope()}(t),function(e){e.bind(uu).toSelf().inSingletonScope()}(t),function(e){e.bind(dT).toSelf().inSingletonScope()}(t),tb(t),function(e){e.bind(tA).to(nA).inSingletonScope(),e.bind(KT).to(XT).inTransientScope(),e.bind(FT).to(MT).inTransientScope(),e.bind(IT).to(bT).inSingletonScope(),e.bind(ZT).to(DT).inTransientScope(),e.bind(LT).to(BT).inTransientScope(),e.bind(zT).to(GT).inTransientScope(),e.bind(WT).to(jT).inTransientScope(),e.bind(JT).to(qT).inSingletonScope(),e.bind(QT).to(eA).inTransientScope(),e.bind($T).to(YT).inTransientScope(),e.bind(rA).to(aA).inSingletonScope(),e.bind(oA).to(iA).inSingletonScope()}(t),function(e){e.bind(oI).to(BA).inSingletonScope(),e.bind(iI).to(cI).inSingletonScope()}(t),t}var pI=function(){function e(){(0,y.Z)(this,e),this._crossHighlightEnabled$=new vt.X(!1),this._crossHighlightColor$=new vt.X("crossLightYellow"),this.crossHighlightEnabled$=this._crossHighlightEnabled$.asObservable(),this.crossHighlightColor$=this._crossHighlightColor$.asObservable()}return(0,C.Z)(e,[{key:"init",value:function(e){e.crossHighlightState&&this.setEnable(e.crossHighlightState),e.crossHighlightColor&&this.setColor(e.crossHighlightColor)}},{key:"setEnable",value:function(e){e!==this.crossHighlightEnabled&&this._crossHighlightEnabled$.next(e)}},{key:"setColor",value:function(e){e!==this.crossHighlightColor&&this._crossHighlightColor$.next(e)}},{key:"crossHighlightEnabled",get:function(){return this._crossHighlightEnabled$.getValue()}},{key:"crossHighlightColor",get:function(){return this._crossHighlightColor$.getValue()}}]),e}();function yI(e){var t=new dt.W;return t.bind(SA).toDynamicValue(e.getCommandManager),t.bind(EA).toDynamicValue(e.getWorkbook),t.bind(Ft.UU).to(Ft.lO).inSingletonScope(),t.bind(Ft.tb).to(Ft.E4).inSingletonScope(),t.bind(Ft.QX).to(Ft.mQ).inSingletonScope(),t.bind(Ft.zv).to(Ft.zB).inSingletonScope(),t.bind(Ft.Jv).to(Ft.Dp).inSingletonScope(),t.bind(TA).toDynamicValue(e.getWatchHub),function(e){e.bind(pI).toSelf().inSingletonScope()}(t),function(e,t){e.bind(uI).to(LA).inSingletonScope(),t?e.bind(lI).to(gI).inSingletonScope():e.bind(sI).to(vI).inSingletonScope()}(t,e.isWorker),t}pI=Gi([(0,ct.b)()],pI);var CI,_I=function(){function e(){(0,y.Z)(this,e),this.ready=!1,this.token="",this.permMap=new Map}return(0,C.Z)(e,[{key:"getPermMap",value:function(){return this.permMap}},{key:"setToken",value:function(e){this.token=e}},{key:"getToken",value:function(){return this.token}},{key:"setReady",value:function(){var e=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];this.ready=e}},{key:"hasEditPerm",value:function(e){var t,n=null===(t=this.permMap.get(e))||void 0===t?void 0:t.type;return void 0===n||4===n}},{key:"hasVisiblePerm",value:function(e){var t,n=null===(t=this.permMap.get(e))||void 0===t?void 0:t.type;return void 0===n||0!==n}},{key:"hasPerm",value:function(e){return this.permMap.has(e)}},{key:"getPermType",value:function(e){var t,n;return null!==(t=null===(n=this.permMap.get(e))||void 0===n?void 0:n.type)&&void 0!==t?t:4}},{key:"getHasInivisible",value:function(e){var t,n;return null!==(t=null===(n=this.permMap.get(e))||void 0===n?void 0:n.hasInvisible)&&void 0!==t&&t}},{key:"setPermType",value:function(e,t,n){if(!e||0===e.length)return 2;var r=this.permMap.get(e)||{type:t,hasInvisible:!1};return r.type=t,void 0!==n&&(r.hasInvisible=n),this.permMap.set(e,r),0}},{key:"removePerm",value:function(e){return e&&0!==e.length?!0!==this.permMap.has(e)?3:(this.permMap.delete(e),0):2}},{key:"reset",value:function(){this.permMap.clear(),this.ready=!1,this.token=""}},{key:"isReady",get:function(){return this.ready}}]),e}(),RI=new Map,wI="default",kI=function(e){var t="translate"===e||"history"===e?RI.get(wI):RI.get(e||wI);return t||(t=new _I,RI.set(e||wI,t)),t},SI=function(e){var t=RI.get(e||wI);t&&t.reset(),RI.delete(e||wI)},EI="";function TI(){return EI}var AI=function(e,t,n,r,a){return r&&function(e){EI=e,clearTimeout(CI),CI=setTimeout((function(){EI=""}),1e3)}(e),kI(a).setPermType(e,t,n)};function II(e,t){return bI.apply(this,arguments)}function bI(){return bI=(0,u.Z)(i().mark((function e(t,n){var r,a;return i().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if((r=kI().getToken())||console.error("token is ".concat(r," fetch permission error")),!(t.length>0&&r)){e.next=12;break}return e.prev=2,e.next=5,we.Ps3.serverApi.protectionRange.bufferBatchPermFilter(r,t);case 5:a=e.sent,t.forEach((function(e){AI(e,a.includes(e)?4:1,!1)})),n&&n(),e.next=12;break;case 9:e.prev=9,e.t0=e.catch(2),we.Ps3.Toast.show({type:"error",content:fn("sheet.protection.sync_permission_fail"),duration:3e3});case 12:case"end":return e.stop()}}),e,null,[[2,9]])}))),bI.apply(this,arguments)}function FI(e,t,n,r){return MI.apply(this,arguments)}function MI(){return MI=(0,u.Z)(i().mark((function e(t,n,r,a){var o;return i().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r||console.error("token is ".concat(r," fetch permission error")),!(t.length>0&&r)){e.next=13;break}return e.prev=1,e.next=4,we.Ps3.serverApi.protectionRangeV2.bufferBatchPermFilter(r,t);case 4:if(o=e.sent,kI(a).getToken()===r){e.next=7;break}return e.abrupt("return");case 7:t.forEach((function(e){var t,n=o.get(e.permId)||{},r=n.permissionType,i=n.extraInfo;AI(e.permId,null!==(t=r)&&void 0!==t?t:1,null==i?void 0:i.some((function(e){return 1===e})),void 0,a)})),n&&n(),e.next=13;break;case 10:throw e.prev=10,e.t0=e.catch(1),we.Ps3.Toast.show({type:"error",content:fn("sheet.protection.sync_permission_fail"),duration:3e3}),e.t0;case 13:case"end":return e.stop()}}),e,null,[[1,10]])}))),MI.apply(this,arguments)}var VI=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"";return bt()("".concat(e,"-").concat(Date.now()))};function NI(e,t){return OI.apply(this,arguments)}function OI(){return OI=(0,u.Z)(i().mark((function e(t,n){var r,a,o;return i().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,we.Ps3.serverApi.protectionRange.queryPermUser(t,n);case 2:return r=e.sent,a=[],o=[],e.abrupt("return",(r&&r.owners&&(o=r.owners.map((function(e){return 4===e.owner_type||6===e.owner_type?we.Oc7:e.owner_id})),a=r.owners.filter((function(e){return e.permissions&we.Ps3.permission.FULL_ACCESS})).map((function(e){return e.owner_id}))),{memberIds:o,managerIds:a}));case 5:case"end":return e.stop()}}),e)}))),OI.apply(this,arguments)}function xI(e,t){return ZI.apply(this,arguments)}function ZI(){return ZI=(0,u.Z)(i().mark((function e(t,n){var r,a,o;return i().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,we.Ps3.serverApi.protectionRangeV2.queryPermUser(t,n);case 2:return r=e.sent,a=r.has_more,o=r.members,e.abrupt("return",{hasMore:a,members:o});case 6:case"end":return e.stop()}}),e)}))),ZI.apply(this,arguments)}function DI(e,t){return PI.apply(this,arguments)}function PI(){return PI=(0,u.Z)(i().mark((function e(t,n){var r,a,o,u=arguments;return i().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=u.length>2&&void 0!==u[2]?u[2]:[],a=u.length>3&&void 0!==u[3]?u[3]:[],o=u.length>4?u[4]:void 0,e.next=5,we.Ps3.serverApi.protectionRangeV2.replacePermUser(t,n,r,a,o);case 5:return e.abrupt("return",e.sent);case 6:case"end":return e.stop()}}),e)}))),PI.apply(this,arguments)}function LI(e,t,n){var r=(0,U.Z)(e,t);setTimeout(n,r)}function BI(e,t,n){var r=e.parent.permissionManager;return!(!r.userPerm.isReady||!r.hasSheetVisiblePermission(e.id()))}function UI(e){var t;return e.ranges.reduce((function(e,t){return e[t.type].push(Object.assign({},t)),e}),(t={},(0,l.Z)(t,we.xj7.NORMAL,[]),(0,l.Z)(t,we.xj7.ROW,[]),(0,l.Z)(t,we.xj7.COL,[]),t))}function HI(e){return e.type===we.xj7.ALL||e.type===we.xj7.COL?0:e.row}function WI(e,t){return e.type===we.xj7.ALL||e.type===we.xj7.COL?1/0:t+e.rowCount-1}function jI(e){return e.type===we.xj7.ALL||e.type===we.xj7.ROW?0:e.col}function zI(e,t){return e.type===we.xj7.ALL||e.type===we.xj7.ROW?1/0:t+e.colCount-1}function GI(e,t){return e.type===we.xj7.ALL||t.type===we.xj7.ALL}function JI(e,t){return function(e,t){if(GI(e,t))return!0;var n=HI(e),r=WI(e,n),a=HI(t);return n<=WI(t,a)&&r>=a}(e,t)&&function(e,t){if(GI(e,t))return!0;var n=jI(e),r=zI(e,n),a=jI(t);return n<=zI(t,a)&&r>=a}(e,t)}function qI(e,t){var n=127,r=HI(e),a=WI(e,r),o=HI(t),i=WI(t,o),u=jI(e),s=zI(e,u),l=jI(t),c=zI(t,l),h=r<=i&&a>=o,f=u<=c&&s>=l;return h||f?(h&&(n&=95,r<o&&(n&=111),a>i&&(n&=119)),f&&(n&=123,u<l&&(n&=125),s>c&&(n&=126)),h&&f&&(n&=63),n):n}function $I(e,t){return"add"===t.type?function(e,t){var n=t.dimension,r=t.startIndex,a=t.count,o=t.dimCountKey;return e[n]>=r?e[n]+=a:e[o]+=a,e}(e,t):function(e,t){var n=t.dimension,r=t.startIndex,a=t.count,o=t.dimCountKey;if(e[n]>=r){var i=r+a,u=e[n]+e[o];if(i>=u)return null;i<=e[n]?e[n]-=a:(e[n]=r,e[o]=u-i)}else{var s=e[n]+e[o]-r,l=Math.min(s,a);e[o]-=l}return e}(e,t)}function YI(e,t){var n=t.dimension,r=t.startIndex,a=t.dimCountKey;return!(e.type===we.xj7.ROW&&"col"===n||e.type===we.xj7.COL&&"row"===n)&&(e[n]>=r||e[n]+e[a]>r)}var KI="worksheet/protection-model",XI={curRangeEditable:!0,curRowEditable:!0,curColEditable:!0},QI=function(){function e(t){var n=this;(0,y.Z)(this,e),this.sheet=t,this.protectionMap=new Map,this.sheetWatcherSubscriber=null,this._curRowColRangeProtectionPermission$=new vt.X(XI),this.curRowColRangeProtectionPermission$=this._curRowColRangeProtectionPermission$.asObservable(),this.sheetWatcherSubscriber=t.subscribe("SelectionChanged",(function(){n.refreshPermission()}))}return(0,C.Z)(e,[{key:"setProtection",value:function(e,t){var n=this.getProtectionById(e),r=t.creatorId;n&&(r=n.creatorId),t.creatorId=r;var a=this.setProtectionImpl(e,t);return a&&this.syncPermissionAndHandleProtectionChange(e),a}},{key:"delProtection",value:function(e){var t=this.delProtectionImpl(e);return t&&this.handleProtectionChange(),t}},{key:"getProtectionById",value:function(e){return this.protectionMap.get(e)}},{key:"getProtectionsByRange",value:function(e,t){var n,r=[],a=t?function(e,t){var n=kI(e.options.situation);return"allowed"===t?function(e){return n.hasEditPerm(e)}:function(e){return!n.hasEditPerm(e)}}(this.sheet.parent,t):void 0,o=!e,i=e?li(e):null,u=_n(this.protectionMap.values());try{for(u.s();!(n=u.n()).done;){var s=n.value;a&&!a(s.id)||(o||0!==s.ranges.length&&(!i||i&&s.ranges.some((function(e){return JI(i,e)}))))&&r.push(s)}}catch(e){u.e(e)}finally{u.f()}return r}},{key:"getProtectionRangesByRange",value:function(e,t){var n=this.sheet,r=this.getProtectionsByRange(e,t);if(0===r.length)return[];var a=e?li(e):null;return r.reduce((function(e,t){return t.ranges.forEach((function(t){return(a&&JI(t,a)||!a)&&e.push(Oi.fromJSON(t,t.type,n)),e})),e}),[])}},{key:"getAllProtections",value:function(){return this.allProtectionListCache||(this.allProtectionListCache=Array.from(this.protectionMap.values())),this.allProtectionListCache}},{key:"getProtectionsCount",value:function(){return this.protectionMap.size}},{key:"getRangePermissions",value:function(e){if(!this._userPerm.isReady)return{hasPermission:!0,rowPermission:!0,colPermission:!0};var t=this.getRangesPermissionDetail(e);return{hasPermission:t[0],rowPermission:t[1],colPermission:t[4]}}},{key:"refreshPermission",value:function(e){if(this._userPerm.isReady){var t=this.sheet,n=t.getSelections(),r=this.getRangePermissions(n);!e&&(0,pe.default)(r,this.prevRangePermissions)||(t.dispatch("PermissionChanged",{permissions:r}),this.prevRangePermissions=r);var a={curRangeEditable:r.hasPermission,curRowEditable:r.rowPermission,curColEditable:r.colPermission};!e&&(0,pe.default)(this.curRowColRangeProtectionPermission,a)||this._curRowColRangeProtectionPermission$.next(a)}}},{key:"adjustProtectionRange",value:function(e,t,n,r){if(this.protectionMap.size){var a,o={dimension:e,type:t,startIndex:n,count:r,dimCountKey:"row"===e?"rowCount":"colCount"},i=_n(this.protectionMap.values());try{for(i.s();!(a=i.n()).done;){for(var u=a.value,s=[],l=0,c=u.ranges.length;l<c;l++){var h=u.ranges[l];if(YI(h,o)){var f=$I(h,o);f&&s.push(f)}else s.push(h)}0===s.length?this.delProtectionImpl(u.id):u.ranges=s}}catch(e){i.e(e)}finally{i.f()}this.handleProtectionChange()}}},{key:"getRangesPermissionDetail",value:function(e){return function(e,t){for(var n=[],r=t-1;r>=0;r--)n.push(!!(e>>r&1));return n}(this.getRangesPermissionStatus(e),7)}},{key:"destroy",value:function(){var e;this._curRowColRangeProtectionPermission$.complete(),this.prevRangePermissions=void 0,this.clearAllProtectionsCache(),this.protectionMap.clear(),null!==(e=this.sheetWatcherSubscriber)&&void 0!==e&&e.unsubscribe(),this.sheetWatcherSubscriber=null}},{key:"setProtectionImpl",value:function(e,t){return this.delProtectionImpl(e),this.protectionMap.set(e,Object.assign({},t,{id:e})),!0}},{key:"delProtectionImpl",value:function(e){return!!this.protectionMap.get(e)&&(this.protectionMap.delete(e),!0)}},{key:"clearAllProtectionsCache",value:function(){this.allProtectionListCache=void 0}},{key:"onProtectionMapDirty",value:function(){this.clearAllProtectionsCache()}},{key:"syncPermissionAndHandleProtectionChange",value:function(e){var t=this,n=this._userPerm;n.isReady&&!n.hasPerm(e)?LI(10,500,(function(){II([e],(function(){return t.handleProtectionChange()}))})):this.handleProtectionChange()}},{key:"handleProtectionChange",value:function(){this.onProtectionMapDirty(),this.prevRangePermissions=void 0,this.refreshPermission(),this.sheet.dispatch("ProtectedRangeChanged")}},{key:"getRangesPermissionStatus",value:function(e){var t=127,n=this._userPerm;if(!e.length)return t;if(!n.isReady)return t;var r,a=[],o=_n(this.protectionMap.values());try{for(o.s();!(r=o.n()).done;){var i=r.value;if(0===t)break;if(!n.hasEditPerm(i.id))for(var u=0,s=i.ranges.length;u<s&&0!==t;u++)for(var l=i.ranges[u],c=0,h=e.length;c<h;c++){var f=e[c],d=void 0;if(a[c]?d=a[c]:(d=li(f),a[c]=d),0===t)break;t&=qI(l,d)}}}catch(e){o.e(e)}finally{o.f()}return t}},{key:"getTargetRangeTypeProtection",value:function(e,t){var n=this.getProtectionById(e);return n?n.ranges.length>1||!function(e,t){return e.ranges.some((function(e){return e.type===t}))}(n,t)?null:n:null}},{key:"_userPerm",get:function(){return kI(this.sheet.parent.options.situation)}},{key:"curRowColRangeProtectionPermission",get:function(){return this._curRowColRangeProtectionPermission$.getValue()}}]),e}();QI=Gi([(0,ct.b)(),Ji(0,(0,ht.f)(Pd))],QI);var eb,tb=function(e){e.bind(KI).to(QI).inSingletonScope()};!function(e){e[e.Add=0]="Add",e[e.Set=1]="Set",e[e.Del=2]="Del",e[e.Refresh=3]="Refresh"}(eb||(eb={}));var nb,rb,ab,ob=function(){function e(t){var n=this;(0,y.Z)(this,e),this._blocksMap=t,this.refreshBlockSet=new Set,this.oldFloatBlocks=new Map,this.raiseRefresh=ub((function(){var e=n.refreshBlockSet;e.size>0&&(e.forEach((function(e,t){var r=n._blocksMap[t];r&&n.raiseFloatBlockChange(t,3,r)})),n.clearRefresh())})),this.raiseChange=ub((function(){var e=n.oldFloatBlocks;return e.size>0&&(e.forEach((function(e,t){var r=n._blocksMap[t];r&&n.raiseFloatBlockChange(t,1,r)})),n.clearChange()),e}))}return(0,C.Z)(e,[{key:"markBlockChange",value:function(e){this.oldFloatBlocks.has(e)||(this.oldFloatBlocks.set(e,this._blocksMap[e]),this._blocksMap[e]=(0,Re.default)(this._blocksMap[e]))}},{key:"markBlockRefresh",value:function(e){return this.refreshBlockSet.add(e)}},{key:"hasMarkedRefresh",value:function(e){return this.refreshBlockSet.has(e)}},{key:"hasMarkedChange",value:function(e){return this.oldFloatBlocks.has(e)}},{key:"clearRefresh",value:function(){this.refreshBlockSet=new Set}},{key:"clearChange",value:function(){this.oldFloatBlocks=new Map}},{key:"registerFloatBlockChangeHandler",value:function(e){this.floatBlockChangeHandler=e}},{key:"unRegisterFloatBlockChangeHandler",value:function(){this.floatBlockChangeHandler=void 0}},{key:"raise",value:function(){this.raiseRefresh(),this.raiseChange()}},{key:"raiseFloatBlockChange",value:function(e,t,n){this.floatBlockChangeHandler&&this.floatBlockChangeHandler({blockToken:e,changeType:t,floatBlock:n})}}]),e}(),ib=function(){function e(t){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};(0,y.Z)(this,e),this.sheet=t,this._blocksMap={},this._blocksMap=this._ensureSheetId(n),this.changeManager=new ob(n)}return(0,C.Z)(e,[{key:"_ensureSheetId",value:function(e){var t=this.sheet.id();return Object.values(e).forEach((function(e){return e.sheetId=t})),e}},{key:"getChangeManager",value:function(){return this.changeManager}},{key:"registerFloatBlockChangeHandler",value:function(e){this.changeManager.registerFloatBlockChangeHandler(e)}},{key:"addBlock",value:function(e,t){if(!e||e!==t.blockToken)throw new Error("Please make sure your blockToken correct");return this._blocksMap[e]?(console.error("blockToken 为 ".concat(e," 的 FloatBlock 已经存在")),!1):(this._blocksMap[e]=(0,Re.default)(t),this.changeManager.raiseFloatBlockChange(e,0,t),!0)}},{key:"setBlock",value:function(e,t,n){if(!e||e!==t.blockToken)throw new Error("Please make sure your blockToken correct");return n||this._blocksMap[e]?(this._blocksMap[e]=(0,Re.default)(t),this.changeManager.raiseFloatBlockChange(e,1,t),!0):(console.error("blockToken 为 ".concat(e," 的 floatBlock 不存在")),!1)}},{key:"delBlock",value:function(e){if(!this._blocksMap[e])return console.error("blockToken 为 ".concat(e," 的 floatBlock 不存在")),!1;var t=this._blocksMap[e];return delete this._blocksMap[e],this.changeManager.raiseFloatBlockChange(e,2,t),!0}},{key:"getBlock",value:function(e){return this._blocksMap[e]}},{key:"getFloatBlocksMap",value:function(){return this._blocksMap}},{key:"getFloatBlockNextZIndex",value:function(){var e=1;return Object.values(this._blocksMap).forEach((function(t){var n=t.blockSetting;e=Math.max(e,n.zIndex)})),e+1}},{key:"fromJSON",value:function(e){this._blocksMap=(0,Re.default)(e)||{}}},{key:"toJSON",value:function(){return(0,Re.default)(this._blocksMap)}},{key:"serialize",value:function(){var e=(0,l.Z)({},xt.kH.CHART,we.B2l.FloatBlockType.FloatBlockType_CHART);return Object.values(this._blocksMap).filter((function(t){return Boolean(e[t.blockType])})).map((function(t){var n=t.blockSetting;return{id:t.blockToken,anchor:{cell:{startRow:n.row,startCol:n.col,endRow:n.row+1,endCol:n.col+1},cellOff:{x:n.x,y:n.y},size:{w:n.width,h:n.height},zIndex:n.zIndex},type:e[t.blockType]}}))}},{key:"addRows",value:function(e,t){this.adjustBlockPos4AddRows(e,t),this.changeManager.raise()}},{key:"addColumns",value:function(e,t){this.adjustBlockPos4AddCols(e,t),this.changeManager.raise()}},{key:"removeRows",value:function(e,t){this.adjustBlockPos4DelRows(e,t),this.changeManager.raise()}},{key:"removeColumns",value:function(e,t){this.adjustBlockPos4DelCols(e,t),this.changeManager.raise()}},{key:"adjustBlockPos4AddRows",value:function(e,t){var n=this;(0,H.Z)(this._blocksMap,(function(r,a){var o=r.blockSetting,i=n.getNewTarget4Add(e,t,o.row);i!==o.row&&(n.updateFloatBlockMap(a,"blockSetting.row",i),n.changeManager.markBlockRefresh(a))}))}},{key:"adjustBlockPos4AddCols",value:function(e,t){var n=this;(0,H.Z)(this._blocksMap,(function(r,a){var o=r.blockSetting,i=n.getNewTarget4Add(e,t,o.col);i!==o.col&&(n.updateFloatBlockMap(a,"blockSetting.col",i),n.changeManager.markBlockRefresh(a))}))}},{key:"adjustBlockPos4DelRows",value:function(e,t){var n=this;(0,H.Z)(this._blocksMap,(function(r,a){var o=r.blockSetting,i=n.getNewTarget4Del(e,t,o.row);e===o.row&&i===o.row&&(n.updateFloatBlockMap(a,"blockSetting.y",0),n.changeManager.markBlockRefresh(a)),i!==o.row&&(n.updateFloatBlockMap(a,"blockSetting.row",i),n.changeManager.markBlockRefresh(a));var u=n.sheet.getRowCount()-1;i>u&&n.updateFloatBlockMap(a,"blockSetting.row",u)}))}},{key:"adjustBlockPos4DelCols",value:function(e,t){var n=this;(0,H.Z)(this._blocksMap,(function(r,a){var o=r.blockSetting,i=n.getNewTarget4Del(e,t,o.col);e===o.col&&i===o.col&&(n.updateFloatBlockMap(a,"blockSetting.x",0),n.changeManager.markBlockRefresh(a)),i!==o.col&&(n.updateFloatBlockMap(a,"blockSetting.col",i),n.changeManager.markBlockRefresh(a));var u=n.sheet.getColumnCount()-1;i>u&&n.updateFloatBlockMap(a,"blockSetting.col",u)}))}},{key:"getNewTarget4Add",value:function(e,t,n){return n>=e?n+t:n}},{key:"getNewTarget4Del",value:function(e,t,n){var r=e+t-1;return n>=e&&n<=r?e>0?e:0:n>r?n-t:n}},{key:"updateFloatBlockMap",value:function(e,t,n){(0,te.Z)(this._blocksMap[e],t,n)}},{key:"checkDelInfluence",value:function(e,t,n){var r=new Map;return(0,H.Z)(this._blocksMap,(function(n,a){n.blockSetting[e]>=t&&r.set(a,n)})),r}}],[{key:"createDefault",value:function(e,t,n,r){return{sheetId:e.id(),blockToken:t,blockType:n,blockSetting:Object.assign({},(0,B.Z)(r.floatBlockSetting,["row","col","x","y","width","height"]),{zIndex:e.floatBlocksModel&&e.floatBlocksModel.getFloatBlockNextZIndex()||1})}}},{key:"fromJSON",value:function(t,n){return new e(t,(0,Re.default)(n))}}]),e}();function ub(e){var t;return window.cancelAnimationFrame?function(){var n=this,r=arguments;t||window.requestAnimationFrame&&(t=requestAnimationFrame((function(){t=null,e.apply(n,r)})))}:function(){}}ib.defaultBlockRect=(nb=6,rb=18,(ab=window.screen?window.screen.height:1080)>=1080?(nb=6,rb=18):ab>=850?(nb=5,rb=15):(nb=4,rb=12),{width:105*nb,height:27*rb,x:0,y:0});var sb=0,lb=function(){return sb},cb=function(){return++sb};function hb(e){e&&lb()<e&&function(e){sb=e}(e)}function fb(e,t){return e.permissionManager.hasPermission(t)}var db,vb=513,gb=function(){function e(t){var n=this,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};(0,y.Z)(this,e),this.sheet=t,this.floatImageMap=r,this._activeFloatImageIds=[],this.updateFloatIndex=function(){(0,H.Z)(n.floatImageMap,(function(e){(0,ge.default)(e.floatImageSetting.zIndex)||(e.floatImageSetting.zIndex=0),hb(e.floatImageSetting.zIndex)}))},this.updateFloatIndex()}return(0,C.Z)(e,[{key:"setActiveId",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1],n=this._activeFloatImageIds;this._activeFloatImageIds=e,this.triggerFloatObjectChangedEvent(n),t&&this.raiseChange()}},{key:"appendActiveId",value:function(e){var t=this._activeFloatImageIds;this._activeFloatImageIds=[].concat((0,m.Z)(t),[e]),this.triggerFloatObjectChangedEvent(t)}},{key:"removeActiveId",value:function(e){if(this.activeFloatImageIds.length&&this.activeFloatImageIds.includes(e)){var t=this._activeFloatImageIds;this._activeFloatImageIds=this.activeFloatImageIds.filter((function(t){return t!==e})),this.triggerFloatObjectChangedEvent(t)}}},{key:"triggerFloatObjectChangedEvent",value:function(e){(0,pe.default)(e,this._activeFloatImageIds)||this.sheet.dispatch("ActiveFloatObjectChanged",{prevActiveIds:e,currentActiveIds:this._activeFloatImageIds})}},{key:"fromJSON",value:function(e){this.floatImageMap=(0,Re.default)(e)||{},this.updateFloatIndex()}},{key:"toJSON",value:function(){return(0,Re.default)(this.floatImageMap)}},{key:"serialize",value:function(){var e=[];return(0,H.Z)(this.floatImageMap,(function(t){var n=t.floatImageSetting;e.push({id:t.floatImageId,token:n.imageToken,anchor:{cell:{startRow:n.row,startCol:n.col},cellOff:{x:n.x,y:n.y},size:{w:n.width,h:n.height},zIndex:n.zIndex}})})),e}},{key:"add",value:function(e,t){if(!e||e!==t.floatImageId)throw new Error("Please make sure your id correct");return this.floatImageMap[e]?(console.error("id 为 ".concat(e," 的 float image 已经存在")),!1):(this.floatImageMap[e]=(0,Re.default)(t),t.floatImageSetting.zIndex||(t.floatImageSetting.zIndex=cb()),hb(t.floatImageSetting.zIndex),this.raiseChange(),!0)}},{key:"set",value:function(e,t,n){if(!e||e!==t.floatImageId)throw new Error("Please make sure your id correct");return n||this.floatImageMap[e]?(this.floatImageMap[e]||hb(t.floatImageSetting.zIndex),this.floatImageMap[e]=(0,Re.default)(t),this.raiseChange(),!0):(console.error("id 为 ".concat(e," 的 float image 不存在")),!1)}},{key:"del",value:function(e){return this.floatImageMap[e]?(delete this.floatImageMap[e],this.setActiveId([]),this.raiseChange(),!0):(console.error("id 为 ".concat(e," 的 float image 不存在")),!1)}},{key:"getFloatImageById",value:function(e){return this.floatImageMap[e]}},{key:"getFloatImageMap",value:function(){return this.floatImageMap}},{key:"setRowColInfoChange",value:function(e,t){this.raiseChange()}},{key:"addRows",value:function(e,t){this.rangeAdjust({index:e,count:t,indexKey:"row",type:"add"}),this.raiseChange()}},{key:"addColumns",value:function(e,t){this.rangeAdjust({index:e,count:t,indexKey:"col",type:"add"}),this.raiseChange()}},{key:"removeRows",value:function(e,t){this.rangeAdjust({index:e,count:t,indexKey:"row",type:"del"}),this.raiseChange()}},{key:"removeColumns",value:function(e,t){this.rangeAdjust({index:e,count:t,indexKey:"col",type:"del"}),this.raiseChange()}},{key:"addRowOrColForTarget",value:function(e,t,n){return n>=e?n+t:n}},{key:"delRowOrColForTarget",value:function(e,t,n){var r=e+t-1;return n>=e&&n<=r?e>0?e:0:n>r?n-t:n}},{key:"getTargetAdjustFn",value:function(e){if("add"===e)return this.addRowOrColForTarget;if("del"===e)return this.delRowOrColForTarget;throw new Error("error function type")}},{key:"rangeAdjust",value:function(e){var t=this,n=e.index,r=e.count,a=e.indexKey,o=e.type,i=this.getTargetAdjustFn(o);this.floatImageMap=(0,H.Z)(this.floatImageMap,(function(e,u){var s=e.floatImageSetting,l=i(n,r,s[a]);if([n,l].every((function(e){return e===s[a]}))&&"del"===o&&t.setChange(u,"floatImageSetting."+("row"===a?"y":"x"),0),l!==s[a]){var c=i(n,r,s[a]);t.setChange(u,"floatImageSetting.".concat(a),c)}t.checkDelete(a,l,u)}))}},{key:"checkDelete",value:function(e,t,n){var r=this.sheet.getRowCount()-1,a=this.sheet.getColumnCount()-1;"row"===e&&t>r?this.setChange(n,"floatImageSetting.".concat(e),r):"col"===e&&t>a&&this.setChange(n,"floatImageSetting.".concat(e),a)}},{key:"setChange",value:function(e,t,n){(0,te.Z)(this.floatImageMap[e],t,n)}},{key:"checkDelInfluence",value:function(e,t,n){var r=new Map;return(0,H.Z)(this.floatImageMap,(function(n,a){n.floatImageSetting[e]>=t&&r.set(a,n)})),r}},{key:"raiseChange",value:function(){this.sheet.notifyShell(0)}},{key:"activeFloatImageIds",get:function(){return this._activeFloatImageIds}}],[{key:"fromJSON",value:function(t,n){return new e(t,(0,Re.default)(n))}},{key:"createDefault",value:function(e){var t=e.sheet.id(),n=Object.assign({x:e.x||0,y:e.y||0},(0,B.Z)(e,["row","col","width","height","imageToken"]),{zIndex:cb()});return this.adjustDefaultRect(n),{floatImageId:(0,we.zsn)(10),sheetId:t,floatImageSetting:n}}},{key:"adjustDefaultRect",value:function(e){var t=vb<e.height,n=525<e.width,r=!t&&n||t&&n&&e.height<=e.width,a=t&&!n||t&&n&&e.height>e.width;return r&&(e.height=e.height*(525/e.width),e.height=e.height>vb?vb:e.height,e.width=525),a&&(e.width=e.width*(vb/e.height),e.height=vb),e}}]),e}();!function(e){e[e.Set=0]="Set",e[e.Del=1]="Del",e[e.None=2]="None"}(db||(db={}));var mb=function(){function e(t){var n=this,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};(0,y.Z)(this,e),this.sheet=t,this.ranges=new Map,this.waitRanges=new Map,this.rangeWatchers=new Map,this.toJSON=function(){return n.rangesToRangeMap()},this.delRangesBySheet=function(e){n.ranges.delete(e)},this.rangesToRangeMap=function(){var e={};return n.ranges.forEach((function(t,r){e[r]=n.dataRange2Data(t)})),e},this.rangeMapToRanges=function(e){var t=new Map;return Object.keys(e).forEach((function(r){var a=n.getSheetIdByRangeId(r);a!==n.sheetId&&console.error("[rangeMapToRanges] sheetId error");var o=Object.assign({sheetId:a,rangeId:r},e[r]);t.set(r,o)})),t},this.getSheetIdByRangeId=function(e){return e.split("_")[0]},this.setRange=function(e){if(n.getRangeSheetId(e)!==n.sheetId)return console.error("[setRange] sheetId error"),!1;var t=e.rangeId,r=!n.ranges.has(t);if(n.ranges.set(t,e),r){var a=n.waitRanges.get(t);a&&(n.waitRanges.delete(t),a[1]());var o=n.rangeWatchers.get(t);o&&(o.forEach((function(t){return t(e)})),n.rangeWatchers.delete(t))}return!0},this.delRange=function(e){return n.getRangeSheetId(e)!==n.sheetId?(console.error("[delRange] sheetId error"),!1):n.ranges.has(e)?(n.ranges.delete(e),!0):(console.error("[delRange] rangeId 为".concat(e,"的range不存在")),!1)},this.getRangesFromId=function(e){for(var t=[],r=0;r<e.length;r++){var a=e[r],o=n.ranges.get(a);o?t.push(o):console.warn("[getRangesFromId] range with id=".concat(a," not exist"))}return t},this.getRangeFromId=function(e){return n.ranges.get(e)},this.waitRangesById=function(e){var t,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:4e3,a=[],o=_n(e);try{for(o.s();!(t=o.n()).done;){var i=t.value;if(!n.ranges.has(i)){n.waitRanges.get(i)||n.waitRanges.set(i,ek());var u=n.waitRanges.get(i),s=(0,p.Z)(u,1),l=s[0];a.push(l)}}}catch(e){o.e(e)}finally{o.f()}if(a.length){var c,h=ek(),f=(0,p.Z)(h,2),d=f[0],v=f[1];return Promise.all(a).then((function(){v(),clearTimeout(c)})),c=window.setTimeout((function(){var t,r=_n(e);try{for(r.s();!(t=r.n()).done;){var a=t.value;n.waitRanges.has(a)&&n.waitRanges.delete(a)}}catch(e){r.e(e)}finally{r.f()}v("timeout")}),r),d}return Promise.resolve()},this.getRangeSheetId=function(e){return"string"==typeof e?e.split("_")[0]:e.rangeId.split("_")[0]},this.handleRangeAdd=function(e,t,n,r,a){var o=e[t],i=e[t]+e[n]-1,u=r-1;if(u>=o&&u<i)e[n]+=a;else{if(!(u<o))return 2;e[t]+=a}return 0},this.handleRangeDel=function(e,t,n,r,a){var o=e[t],i=e[t]+e[n]-1,u=r+a-1;if(u<o)e[t]-=a;else if(r<=o&&u>=o&&u<i)e[t]=r,e[n]-=u-o+1;else if(r>o&&r<i&&u<i)e[n]-=a;else{if(r<=o&&u>=i)return 1;if(!(r>o&&r<=i&&u>=i))return 2;e[n]=r-o}return 0},this._handleRowColUpdate=function(e,t,r,a,o){n.ranges.forEach((function(i,u){1===("add"===e?n.handleRangeAdd(i,t,r,a,o):n.handleRangeDel(i,t,r,a,o))&&n.ranges.delete(u)})),n.sheet.dispatch("SheetDataRangeAdjusted",{sheetId:n.sheet.id(),dataRangeMap:n.ranges})},this.checkDelInfluence=function(e,t,r){var a=[];return n.ranges.forEach((function(n){var r,o=t;if("row"===e){if(n.type===we.xj7.ALL||n.type===we.xj7.COL)return;r=n.row+n.rowCount-1}else{if(n.type===we.xj7.ALL||n.type===we.xj7.ROW)return;r=n.col+n.colCount-1}if(o<=r){var i=(0,Re.default)(n);a.push(i)}})),a},this.addRows=function(e,t){n._handleRowColUpdate("add","row","rowCount",e,t)},this.delRows=function(e,t){n._handleRowColUpdate("del","row","rowCount",e,t)},this.addCols=function(e,t){n._handleRowColUpdate("add","col","colCount",e,t)},this.delCols=function(e,t){n._handleRowColUpdate("del","col","colCount",e,t)},this.sheetId=t.id(),this.ranges=this.rangeMapToRanges(r)}return(0,C.Z)(e,[{key:"dataRange2Data",value:function(e){var t=(0,Re.default)(e);return delete t.rangeId,delete t.sheetId,t}},{key:"forEach",value:function(e){this.ranges.forEach(e)}},{key:"watchRangeExists",value:function(e,t){var n=this;if(this.ranges.has(e))return t(this.ranges.get(e)),function(){};var r=this.rangeWatchers.get(e)||[];return r.push(t),this.rangeWatchers.set(e,r),function(){return n.unwatchRangeExists(e,t)}}},{key:"unwatchRangeExists",value:function(e,t){var n=this.rangeWatchers.get(e);if(n){var r=n.filter((function(e){return e!==t}));r.length>0?this.rangeWatchers.set(e,r):this.rangeWatchers.delete(e)}}},{key:"getDataRangeFromData",value:function(e,t){var n,r=_n(this.ranges.values());try{for(r.s();!(n=r.n()).done;){var a=n.value;if((!t||a.usageType===t)&&a.type===e.type){if(a.type===we.xj7.ALL)return a;if(a.type===we.xj7.NORMAL&&e.type===we.xj7.NORMAL&&a.row===e.row&&a.col===e.col&&a.rowCount===e.rowCount&&a.colCount===e.colCount)return a;if(a.type===we.xj7.ROW&&e.type===we.xj7.ROW&&a.row===e.row&&a.rowCount===e.rowCount)return a;if(a.type===we.xj7.COL&&e.type===we.xj7.COL&&a.col===e.col&&a.colCount===e.colCount)return a;if(a.type===we.xj7.CELL&&e.type===we.xj7.CELL&&a.row===e.row&&a.col===e.col)return a}}}catch(e){r.e(e)}finally{r.f()}}}]),e}();mb.fromJSON=function(e,t){return new mb(e,t)};var pb=function(e){function t(){var e;return(0,y.Z)(this,t),(e=(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))).ruleType="cellIs",e.getFormulaStr=function(t){var n=e.getAttr(),r=n.operator,a=n.formula;switch(r){case"equal":return"ARRAYFORMULA(PRIVATE_AND(".concat(t," = ").concat(a[0],", NOT(ISBLANK(").concat(t,"))))");case"notEqual":return"ARRAYFORMULA(PRIVATE_OR(NOT(".concat(t," = ").concat(a[0],"), ISBLANK(").concat(t,")))");case"greaterThan":case"greaterThanOrEqual":case"lessThan":case"lessThanOrEqual":var o="NOT(PRIVATE_AND(NOT(ISNUMBER(".concat(t,")), ISNUMBER(").concat(a[0],")))");return"ARRAYFORMULA(PRIVATE_AND(".concat(t).concat({greaterThan:">",greaterThanOrEqual:">=",lessThanOrEqual:"<=",lessThan:"<"}[r]).concat(a[0],", ").concat(o,"))");case"between":return"ARRAYFORMULA(PRIVATE_AND(PRIVATE_OR(\n            PRIVATE_AND(".concat(t," >= ").concat(a[0],", ").concat(t," <= ").concat(a[1],"),\n            PRIVATE_AND(").concat(t," >= ").concat(a[1],", ").concat(t," <= ").concat(a[0],")\n          ),\n            NOT(ISBLANK(").concat(t,"))\n          ))");case"notBetween":return"ARRAYFORMULA(NOT(PRIVATE_OR(\n          PRIVATE_AND(".concat(t," >= ").concat(a[0],", ").concat(t," <= ").concat(a[1],"),\n          PRIVATE_AND(").concat(t," >= ").concat(a[1],", ").concat(t," <= ").concat(a[0],")\n        )))")}},e}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"serialize",value:function(){var e=this.getAttr(),t=e.operator,n=e.plaintext,r=e.formula;return{ruleType:we.B2l.ConditionalFormatRuleTypes.ConditionalFormatRuleTypes_CELL_IS,cellIs:{operator:Cb[t],plainText:null==n?void 0:n.slice(),formula:null==r?void 0:r.slice()}}}}]),t}(oT),yb=(Pe={},(0,l.Z)(Pe,we.B2l.CellIsRuleOperatorType.CellIsRuleOperatorType_EQUAL,"equal"),(0,l.Z)(Pe,we.B2l.CellIsRuleOperatorType.CellIsRuleOperatorType_NOT_EQUAL,"notEqual"),(0,l.Z)(Pe,we.B2l.CellIsRuleOperatorType.CellIsRuleOperatorType_GREATER,"greaterThan"),(0,l.Z)(Pe,we.B2l.CellIsRuleOperatorType.CellIsRuleOperatorType_GREATER_OR_EQUAL,"greaterThanOrEqual"),(0,l.Z)(Pe,we.B2l.CellIsRuleOperatorType.CellIsRuleOperatorType_LESS,"lessThan"),(0,l.Z)(Pe,we.B2l.CellIsRuleOperatorType.CellIsRuleOperatorType_LESS_OR_EQUAL,"lessThanOrEqual"),(0,l.Z)(Pe,we.B2l.CellIsRuleOperatorType.CellIsRuleOperatorType_BETWEEN,"between"),(0,l.Z)(Pe,we.B2l.CellIsRuleOperatorType.CellIsRuleOperatorType_NOT_BETWEEN,"notBetween"),Pe),Cb={equal:we.B2l.CellIsRuleOperatorType.CellIsRuleOperatorType_EQUAL,notEqual:we.B2l.CellIsRuleOperatorType.CellIsRuleOperatorType_NOT_EQUAL,greaterThan:we.B2l.CellIsRuleOperatorType.CellIsRuleOperatorType_GREATER,greaterThanOrEqual:we.B2l.CellIsRuleOperatorType.CellIsRuleOperatorType_GREATER_OR_EQUAL,lessThan:we.B2l.CellIsRuleOperatorType.CellIsRuleOperatorType_LESS,lessThanOrEqual:we.B2l.CellIsRuleOperatorType.CellIsRuleOperatorType_LESS_OR_EQUAL,between:we.B2l.CellIsRuleOperatorType.CellIsRuleOperatorType_BETWEEN,notBetween:we.B2l.CellIsRuleOperatorType.CellIsRuleOperatorType_NOT_BETWEEN},_b=function(e){function t(){var e;return(0,y.Z)(this,t),(e=(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))).ruleType="duplicateValues",e.getFormulaStr=function(e){return"PRIVATE_DUPLICATE(".concat(e,")")},e}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"serialize",value:function(){return{ruleType:we.B2l.ConditionalFormatRuleTypes.ConditionalFormatRuleTypes_DUPLICATE_VALUES}}}]),t}(oT),Rb=function(e){function t(){var e;return(0,y.Z)(this,t),(e=(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))).ruleType="containsText",e.getOperator=function(){return e.getAttr().operator},e.getFormulaStr=function(t){var n=e.getAttr(),r=n.operator,a=n.text,o=(0,we.dNX)(a);return"PRIVATE_CELL_CONTAINTEXT(".concat(t,", ").concat({beginsWith:0,endsWith:1,is:4,containsText:2,notContains:3}[r],', "').concat(o,'")')},e}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"serialize",value:function(){var e=this.getAttr(),t=e.operator,n=e.text;return{ruleType:we.B2l.ConditionalFormatRuleTypes.ConditionalFormatRuleTypes_CONTAINS_TEXT,containText:{operator:kb[t],text:n}}}}]),t}(oT),wb=(Le={},(0,l.Z)(Le,we.B2l.ContainTextRuleOperatorType.ContainTextRuleOperatorType_BEGINS_WITH,"beginsWith"),(0,l.Z)(Le,we.B2l.ContainTextRuleOperatorType.ContainTextRuleOperatorType_ENDS_WITH,"endsWith"),(0,l.Z)(Le,we.B2l.ContainTextRuleOperatorType.ContainTextRuleOperatorType_CONTAINS,"containsText"),(0,l.Z)(Le,we.B2l.ContainTextRuleOperatorType.ContainTextRuleOperatorType_DOES_NOT_CONTAIN,"notContains"),(0,l.Z)(Le,we.B2l.ContainTextRuleOperatorType.ContainTextRuleOperatorType_IS,"is"),Le),kb={beginsWith:we.B2l.ContainTextRuleOperatorType.ContainTextRuleOperatorType_BEGINS_WITH,endsWith:we.B2l.ContainTextRuleOperatorType.ContainTextRuleOperatorType_ENDS_WITH,containsText:we.B2l.ContainTextRuleOperatorType.ContainTextRuleOperatorType_CONTAINS,notContains:we.B2l.ContainTextRuleOperatorType.ContainTextRuleOperatorType_DOES_NOT_CONTAIN,is:we.B2l.ContainTextRuleOperatorType.ContainTextRuleOperatorType_IS},Sb=function(e){function t(){var e;return(0,y.Z)(this,t),(e=(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))).ruleType="containsBlanks",e.getFormulaStr=function(e){return"ARRAYFORMULA(LEN(TRIM(".concat(e,"))=0)")},e}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"serialize",value:function(){return{ruleType:we.B2l.ConditionalFormatRuleTypes.ConditionalFormatRuleTypes_CONTAINS_BLANKS}}}]),t}(oT),Eb=function(e){function t(){var e;return(0,y.Z)(this,t),(e=(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))).ruleType="notContainsBlanks",e.getFormulaStr=function(e){return"ARRAYFORMULA(LEN(TRIM(".concat(e,"))>0)")},e}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"serialize",value:function(){return{ruleType:we.B2l.ConditionalFormatRuleTypes.ConditionalFormatRuleTypes_NOT_CONTAINS_BLANKS}}}]),t}(oT),Tb=function(e){function t(){var e;return(0,y.Z)(this,t),(e=(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))).ruleType="timePeriod",e.getFormulaStr=function(t){switch(e.getAttr().timePeriod){case"today":return"ARRAYFORMULA(FLOOR(".concat(t,",1) = TODAY())");case"yesterday":return"ARRAYFORMULA(FLOOR(".concat(t,", 1) = TODAY() - 1)");case"tomorrow":return"ARRAYFORMULA(FLOOR(".concat(t,", 1) = TODAY() + 1)");case"last7Days":return"ARRAYFORMULA(PRIVATE_AND(TODAY()-FLOOR(".concat(t,",1) <= 6,FLOOR(").concat(t,",1) <= TODAY()))");default:return""}},e}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"serialize",value:function(){var e=this.getAttr(),t=e.operator,n=e.timePeriod;return{ruleType:we.B2l.ConditionalFormatRuleTypes.ConditionalFormatRuleTypes_TIME_PERIOD,timePeriod:{operator:Ib[t],period:Fb[n]}}}}]),t}(oT),Ab=(Be={},(0,l.Z)(Be,we.B2l.TimePeriodRuleOperatorType.TimePeriodRuleOperatorType_BEFORE,"before"),(0,l.Z)(Be,we.B2l.TimePeriodRuleOperatorType.TimePeriodRuleOperatorType_IS,"is"),(0,l.Z)(Be,we.B2l.TimePeriodRuleOperatorType.TimePeriodRuleOperatorType_AFTER,"after"),Be),Ib={before:we.B2l.TimePeriodRuleOperatorType.TimePeriodRuleOperatorType_BEFORE,is:we.B2l.TimePeriodRuleOperatorType.TimePeriodRuleOperatorType_IS,after:we.B2l.TimePeriodRuleOperatorType.TimePeriodRuleOperatorType_AFTER},bb=(Ue={},(0,l.Z)(Ue,we.B2l.TimePeriodType.TimePeriodType_TODAY,"today"),(0,l.Z)(Ue,we.B2l.TimePeriodType.TimePeriodType_YESTERDAY,"yesterday"),(0,l.Z)(Ue,we.B2l.TimePeriodType.TimePeriodType_TOMORROW,"tomorrow"),(0,l.Z)(Ue,we.B2l.TimePeriodType.TimePeriodType_LAST_7_DAYS,"last7Days"),(0,l.Z)(Ue,we.B2l.TimePeriodType.TimePeriodType_THIS_MONTH,"thisMonth"),(0,l.Z)(Ue,we.B2l.TimePeriodType.TimePeriodType_LAST_MONTH,"lastMonth"),(0,l.Z)(Ue,we.B2l.TimePeriodType.TimePeriodType_NEXT_MONTH,"nextMonth"),(0,l.Z)(Ue,we.B2l.TimePeriodType.TimePeriodType_THIS_WEEK,"thisWeek"),(0,l.Z)(Ue,we.B2l.TimePeriodType.TimePeriodType_LAST_WEEK,"lastWeek"),(0,l.Z)(Ue,we.B2l.TimePeriodType.TimePeriodType_NEXT_WEEK,"nextWeek"),Ue),Fb={today:we.B2l.TimePeriodType.TimePeriodType_TODAY,yesterday:we.B2l.TimePeriodType.TimePeriodType_YESTERDAY,tomorrow:we.B2l.TimePeriodType.TimePeriodType_TOMORROW,last7Days:we.B2l.TimePeriodType.TimePeriodType_LAST_7_DAYS,thisMonth:we.B2l.TimePeriodType.TimePeriodType_THIS_MONTH,lastMonth:we.B2l.TimePeriodType.TimePeriodType_LAST_MONTH,nextMonth:we.B2l.TimePeriodType.TimePeriodType_NEXT_MONTH,thisWeek:we.B2l.TimePeriodType.TimePeriodType_THIS_WEEK,lastWeek:we.B2l.TimePeriodType.TimePeriodType_LAST_WEEK,nextWeek:we.B2l.TimePeriodType.TimePeriodType_NEXT_WEEK},Mb=function(e){function t(){var e;return(0,y.Z)(this,t),(e=(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))).ruleType="uniqueValues",e.getFormulaStr=function(e){return"PRIVATE_UNIQUE(".concat(e,")")},e}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"serialize",value:function(){return{ruleType:we.B2l.ConditionalFormatRuleTypes.ConditionalFormatRuleTypes_UNIQUE_VALUES}}}]),t}(oT),Vb=(He={},(0,l.Z)(He,we.B2l.AttrValueType.AttrValueType_MIN_VALUE,"minValue"),(0,l.Z)(He,we.B2l.AttrValueType.AttrValueType_MAX_VALUE,"maxValue"),(0,l.Z)(He,we.B2l.AttrValueType.AttrValueType_NUM,"num"),(0,l.Z)(He,we.B2l.AttrValueType.AttrValueType_PERCENTILE,"percentile"),(0,l.Z)(He,we.B2l.AttrValueType.AttrValueType_PERCENT,"percent"),(0,l.Z)(He,we.B2l.AttrValueType.AttrValueType_FORMULA,"formula"),(0,l.Z)(He,we.B2l.AttrValueType.AttrValueType_AUTO,"auto"),He),Nb={minValue:we.B2l.AttrValueType.AttrValueType_MIN_VALUE,maxValue:we.B2l.AttrValueType.AttrValueType_MAX_VALUE,num:we.B2l.AttrValueType.AttrValueType_NUM,percentile:we.B2l.AttrValueType.AttrValueType_PERCENTILE,percent:we.B2l.AttrValueType.AttrValueType_PERCENT,formula:we.B2l.AttrValueType.AttrValueType_FORMULA,auto:we.B2l.AttrValueType.AttrValueType_AUTO},Ob=function(e){function t(){var e;return(0,y.Z)(this,t),(e=(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))).ruleType="dataBar",e.getFormulaStr=function(t){if(!e.attrs)return"";var n=e.attrs[0],r=e.attrs[1],a=n.valueType,o=r.valueType,i=n.value,u=r.value;return"PRIVATE_DATA_BAR(".concat(KE(i,a,t,!1),", ").concat(KE(u,o,t,!0),", ").concat(t,")")},e}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"getDataBarStyle",value:function(e,t){try{var n=this.isMatch(e,t);if(n)return this.getDataBarStyleByAttr(n)}catch(e){console.error(e),we.Ps3.collectSuiteEvent("client_sheet_conditional_format_exception",{stage:"get_format_style",type:"p0",rule_type:this.ruleType,error_name:e&&e.name,error_msg:e&&e.message,error_stack:e&&e.stack})}return null}},{key:"getDataBarStyleByAttr",value:function(e){var t=this.attrs[0],n=this.attrs[1];return{percent:e.percent,originPoint:e.originPoint,color:e.percent<0?t.color:n.color,isGradient:t.gradient}}},{key:"serialize",value:function(){return{ruleType:we.B2l.ConditionalFormatRuleTypes.ConditionalFormatRuleTypes_DATA_BAR,dataBar:this.attrs.map((function(e){return{gradient:e.gradient,value:""===e.value||null===e.value?void 0:Number(e.value),color:e.color?{rgb:e.color}:void 0,hideValue:e.hideValue,valueType:Nb[e.valueType]}}))}}}]),t}(oT),xb=function(e){function t(){var e;return(0,y.Z)(this,t),(e=(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))).ruleType="colorScale",e.setStyle=function(t){e.style=t},e.getFormulaStr=function(t){var n=e.attrs||[],r=(0,p.Z)(n,3),a=r[0],o=r[1],i=r[2];if(!a||!o)return"";if(2===e.attrs.length){var u=KE(o.value,o.valueType,t,!0);return"PRIVATE_TWO_COLOR_SCALE(".concat(KE(a.value,a.valueType,t,!1),", ").concat(u,",").concat(t,")")}if(3===e.attrs.length&&i){var s=KE(i.value,i.valueType,t,!0),l=KE(o.value,o.valueType,t,!1);return"PRIVATE_THREE_COLOR_SCALE(".concat(KE(a.value,a.valueType,t,!1),",").concat(l,", ").concat(s,",").concat(t,")")}return""},e.getColorScaleStyle=function(t){return LE(t.percent,t.level,e.colorLevel)},e}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"getFormatStyle",value:function(e,t){try{var n=this.isMatch(e,t);if(n){var r=this.getColorScaleStyle(n);return r?{backColor:r}:{}}}catch(e){console.error(e),we.Ps3.collectSuiteEvent("client_sheet_conditional_format_exception",{stage:"get_format_style",type:"p0",rule_type:this.ruleType,error_name:e&&e.name,error_msg:e&&e.message,error_stack:e&&e.stack})}return null}},{key:"serialize",value:function(){return{ruleType:we.B2l.ConditionalFormatRuleTypes.ConditionalFormatRuleTypes_COLOR_SCALE,colorScale:this.attrs.map((function(e){return{valueType:Nb[e.valueType],value:""===e.value||null===e.value?void 0:Number(e.value),color:e.color?{rgb:e.color}:void 0}}))}}},{key:"colorLevel",get:function(){return this.attrs.map((function(e){return e.color}))}}]),t}(oT),Zb=function(e){function t(){var e;return(0,y.Z)(this,t),(e=(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))).ruleType="rank",e.getFormulaStr=function(t){var n=e.attrs[0],r=n.isBottom,a=void 0!==r&&r,o=n.valueType,i=n.value,u=void 0===i?0:i;return"PRIVATE_RANK(PRIVATE_SORT(".concat(t,'),"').concat(o,'",').concat(u,",").concat(a,",").concat(t,")")},e}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"getFormatStyle",value:function(e,t){try{if(this.isMatch(e,t))return this.style}catch(e){console.error(e),we.Ps3.collectSuiteEvent("client_sheet_conditional_format_exception",{stage:"get_format_style",type:"p0",rule_type:this.ruleType,error_name:e&&e.name,error_msg:e&&e.message,error_stack:e&&e.stack})}return null}},{key:"serialize",value:function(){var e=this.getAttr(),t=e.isBottom,n=e.valueType,r=e.value;return{ruleType:we.B2l.ConditionalFormatRuleTypes.ConditionalFormatRuleTypes_RANK,rank:{isBottom:t,value:""===r||null===r?void 0:Number(r),valueType:Pb[n]}}}}]),t}(oT),Db=(We={},(0,l.Z)(We,we.B2l.RankType.RankType_PERCENT,"percent"),(0,l.Z)(We,we.B2l.RankType.RankType_SORT,"sort"),We),Pb={percent:we.B2l.RankType.RankType_PERCENT,sort:we.B2l.RankType.RankType_SORT},Lb=function(e){function t(){var e;return(0,y.Z)(this,t),(e=(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))).ruleType="aboveAverage",e.getFormulaStr=function(t){var n=e.attrs[0].operator;return"PRIVATE_AVERAGE(AVERAGE(".concat(t,'),"').concat(n,'",').concat(t,")")},e}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"getFormatStyle",value:function(e,t){try{if(this.isMatch(e,t))return this.style}catch(e){console.error(e),we.Ps3.collectSuiteEvent("client_sheet_conditional_format_exception",{stage:"get_format_style",type:"p0",rule_type:this.ruleType,error_name:e&&e.name,error_msg:e&&e.message,error_stack:e&&e.stack})}return null}},{key:"serialize",value:function(){return{ruleType:we.B2l.ConditionalFormatRuleTypes.ConditionalFormatRuleTypes_AVERAGE,average:{operator:Ub[this.getAttr().operator]}}}}]),t}(oT),Bb=(je={},(0,l.Z)(je,we.B2l.AverageType.AverageType_GREATER,"greaterThan"),(0,l.Z)(je,we.B2l.AverageType.AverageType_LESS,"lessThan"),(0,l.Z)(je,we.B2l.AverageType.AverageType_GREATER_OR_EQUAL,"greaterThanOrEqual"),(0,l.Z)(je,we.B2l.AverageType.AverageType_LESS_OR_EQUAL,"lessThanOrEqual"),je),Ub={greaterThan:we.B2l.AverageType.AverageType_GREATER,lessThan:we.B2l.AverageType.AverageType_LESS,greaterThanOrEqual:we.B2l.AverageType.AverageType_GREATER_OR_EQUAL,lessThanOrEqual:we.B2l.AverageType.AverageType_LESS_OR_EQUAL},Hb=function(e){function t(){var e;return(0,y.Z)(this,t),(e=(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))).ruleType="iconSet",e.setStyle=function(t){e.style=t},e.getFormulaStr=function(t){var n=e.attrs;if(!Array.isArray(n))return"";var r=[];return n.forEach((function(e){var n=e.operator,a=KE(e.value,e.valueType,t,!1);r.push('"'.concat(n,'"'),a)})),"PRIVATE_ICONS(".concat(n.length,",").concat(r.join(","),",").concat(t,")")},e}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"getIconSetStyle",value:function(e,t){try{var n=this.attrs;if(!Array.isArray(n)||n.length<=0)return null;var r=n[0].iconType,a=n[0].reverseIcons||!1,o=this.isMatch(e,t);if(o)return function(e,t,n){if(n){var r=t-1-e.iconLevel;return Object.assign({},e,{iconLevel:r})}return e}({iconType:r,iconLevel:o.iconLevel},n.length+1,a)}catch(e){console.error(e),we.Ps3.collectSuiteEvent("client_sheet_conditional_format_exception",{stage:"get_format_style",type:"p0",rule_type:this.ruleType,error_name:e&&e.name,error_msg:e&&e.message,error_stack:e&&e.stack})}return null}},{key:"serialize",value:function(){return{ruleType:we.B2l.ConditionalFormatRuleTypes.ConditionalFormatRuleTypes_ICON_SET,iconSet:this.attrs.map((function(e){return{iconType:Ek[e.iconType],hideValue:e.hideValue,valueType:Nb[e.valueType],operator:Ak[e.operator],value:""===e.value||null===e.value?void 0:Number(e.value),reverseIcons:e.reverseIcons}}))}}}]),t}(oT);function Wb(e){switch(e.ruleType){case"duplicateValues":default:return new _b(e);case"cellIs":return new pb(e);case"containsText":return new Rb(e);case"containsBlanks":return new Sb(e);case"notContainsBlanks":return new Eb(e);case"timePeriod":return new Tb(e);case"uniqueValues":return new Mb(e);case"dataBar":return new Ob(e);case"colorScale":return new xb(e);case"rank":return new Zb(e);case"aboveAverage":return new Lb(e);case"expression":return new iT(e);case"iconSet":return new Hb(e)}}var jb,zb,Gb,Jb,qb=(ze={},(0,l.Z)(ze,we.B2l.ConditionalFormatRuleTypes.ConditionalFormatRuleTypes_DUPLICATE_VALUES,"duplicateValues"),(0,l.Z)(ze,we.B2l.ConditionalFormatRuleTypes.ConditionalFormatRuleTypes_UNIQUE_VALUES,"uniqueValues"),(0,l.Z)(ze,we.B2l.ConditionalFormatRuleTypes.ConditionalFormatRuleTypes_CELL_IS,"cellIs"),(0,l.Z)(ze,we.B2l.ConditionalFormatRuleTypes.ConditionalFormatRuleTypes_CONTAINS_TEXT,"containsText"),(0,l.Z)(ze,we.B2l.ConditionalFormatRuleTypes.ConditionalFormatRuleTypes_TIME_PERIOD,"timePeriod"),(0,l.Z)(ze,we.B2l.ConditionalFormatRuleTypes.ConditionalFormatRuleTypes_CONTAINS_BLANKS,"containsBlanks"),(0,l.Z)(ze,we.B2l.ConditionalFormatRuleTypes.ConditionalFormatRuleTypes_NOT_CONTAINS_BLANKS,"notContainsBlanks"),(0,l.Z)(ze,we.B2l.ConditionalFormatRuleTypes.ConditionalFormatRuleTypes_DATA_BAR,"dataBar"),(0,l.Z)(ze,we.B2l.ConditionalFormatRuleTypes.ConditionalFormatRuleTypes_COLOR_SCALE,"colorScale"),(0,l.Z)(ze,we.B2l.ConditionalFormatRuleTypes.ConditionalFormatRuleTypes_RANK,"rank"),(0,l.Z)(ze,we.B2l.ConditionalFormatRuleTypes.ConditionalFormatRuleTypes_AVERAGE,"aboveAverage"),(0,l.Z)(ze,we.B2l.ConditionalFormatRuleTypes.ConditionalFormatRuleTypes_EXPRESSION,"expression"),(0,l.Z)(ze,we.B2l.ConditionalFormatRuleTypes.ConditionalFormatRuleTypes_ICON_SET,"iconSet"),ze);function $b(e){if(e)switch(e.ruleType){case we.B2l.ConditionalFormatRuleTypes.ConditionalFormatRuleTypes_DUPLICATE_VALUES:case we.B2l.ConditionalFormatRuleTypes.ConditionalFormatRuleTypes_UNIQUE_VALUES:case we.B2l.ConditionalFormatRuleTypes.ConditionalFormatRuleTypes_CONTAINS_BLANKS:case we.B2l.ConditionalFormatRuleTypes.ConditionalFormatRuleTypes_NOT_CONTAINS_BLANKS:return;case we.B2l.ConditionalFormatRuleTypes.ConditionalFormatRuleTypes_CELL_IS:return[{operator:yb[e.cellIs.operator],plaintext:e.cellIs.plainText,formula:e.cellIs.formula}];case we.B2l.ConditionalFormatRuleTypes.ConditionalFormatRuleTypes_CONTAINS_TEXT:return[{operator:wb[e.containText.operator],text:e.containText.text}];case we.B2l.ConditionalFormatRuleTypes.ConditionalFormatRuleTypes_TIME_PERIOD:return[{operator:Ab[e.timePeriod.operator],timePeriod:bb[e.timePeriod.period]}];case we.B2l.ConditionalFormatRuleTypes.ConditionalFormatRuleTypes_DATA_BAR:return e.dataBar.map((function(e){return{gradient:e.gradient,value:e.value,color:e.color.rgb,hideValue:e.hideValue,valueType:Vb[e.valueType]}}));case we.B2l.ConditionalFormatRuleTypes.ConditionalFormatRuleTypes_COLOR_SCALE:return e.colorScale.map((function(e){return{valueType:Vb[e.valueType],value:e.value,color:e.color.rgb}}));case we.B2l.ConditionalFormatRuleTypes.ConditionalFormatRuleTypes_RANK:return[{isBottom:e.rank.isBottom,valueType:Db[e.rank.valueType],value:e.rank.value}];case we.B2l.ConditionalFormatRuleTypes.ConditionalFormatRuleTypes_AVERAGE:return[{operator:Bb[e.average.operator]}];case we.B2l.ConditionalFormatRuleTypes.ConditionalFormatRuleTypes_EXPRESSION:return[{formula:e.customFormula.formula}];case we.B2l.ConditionalFormatRuleTypes.ConditionalFormatRuleTypes_ICON_SET:return e.iconSet.map((function(e){return{iconType:Tk[e.iconType],hideValue:e.hideValue,valueType:Vb[e.valueType],operator:Ik[e.operator],value:e.value,reverseIcons:e.reverseIcons}}));default:return}}!function(e){e.ReceiveCompleteServerSideCacheTime="ReceiveCompleteServerSideCacheTime",e.CalculationStartTime="CalculationStartTime",e.FormulaCount="FormulaCount",e.ServerSideCacheHitFormulaCount="ServerSideCacheHitFormulaCount",e.ModuleInitStartTime="ModuleInitStartTime",e.ServerSideCacheFormulaCount="ServerSideCacheFormulaCount"}(Jb||(Jb={}));var Yb=function(){function e(){(0,y.Z)(this,e),this.lock=!0,this.map=new Map,this.reportIdsQueue=[],this.bizType="formula",this.shouldReport=!0,this.isModuleInit=!1,this.isFirstCalcEnd=!1,this.isFirstCalcFinish=!1,this.isFirstApplyResult=!1,this.disableApplyResultReport=!0,this.calcCount=0,this[jb]=0,this[zb]=0,this[Gb]=0}return(0,C.Z)(e,[{key:"getSheetStatistics",value:function(e){return this.map.has(e)||this.map.set(e,new Map),this.map.get(e)}},{key:"initModule",value:function(){this.isModuleInit||(this[Jb.ModuleInitStartTime]=Date.now(),this.isModuleInit=!0)}},{key:"stopReport",value:function(){this.shouldReport=!1}},{key:"unlock",value:function(){var e=this;this.lock=!1,this.reportIdsQueue.forEach((function(t){return e.reportCacheHitRate(t)}))}},{key:"getAll",value:function(){var e,t,n=0,r=0,a=0,o=_n(this.map);try{for(o.s();!(t=o.n()).done;){var i=(0,p.Z)(t.value,1)[0],u=this.get(i,Jb.FormulaCount);u<=0||(n+=u,r+=this.get(i,Jb.ServerSideCacheFormulaCount),a+=this.get(i,Jb.ServerSideCacheHitFormulaCount))}}catch(e){o.e(e)}finally{o.f()}return e={},(0,l.Z)(e,Jb.FormulaCount,n),(0,l.Z)(e,Jb.ServerSideCacheFormulaCount,r),(0,l.Z)(e,Jb.ServerSideCacheHitFormulaCount,a),e}},{key:"get",value:function(e,t){return e in Jb?this[e]||0:void 0!==t&&this.getSheetStatistics(e).get(t)||0}},{key:"add",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1,r=this.getSheetStatistics(e),a=r.get(t)||0;r.set(t,a+n)}},{key:"sub",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1,r=this.getSheetStatistics(e),a=r.get(t)||0;r.set(t,a-n)}},{key:"remove",value:function(e){this.map.delete(e)}},{key:"set",value:function(e,t){this[e]=t}},{key:"onFirstCalcStart",value:function(){if(this.isModuleInit)try{this.unlock(),this.set(Jb.CalculationStartTime,Date.now()),this.tryReportCalculationCacheTimeDifference(),this.reportFirstCalcCacheHitRate()}catch(e){console.error("onFirstCalc Error",e)}}},{key:"onFirstCalcEnd",value:function(e,t){this.isFirstCalcFinish||this.calcCount++,!this.isFirstCalcEnd&&this.isModuleInit?(this.reportFirstCalcDurationWithCacheHitRate(e,t,"firstCalcEnd"),this.isFirstCalcEnd=!0):this.isFirstCalcEnd=!0}},{key:"onFirstApplyResult",value:function(e){this.disableApplyResultReport||this.isFirstApplyResult||!this.isModuleInit||e<=0||this.reportFirstCalcDurationWithCacheHitRate(Date.now()-this[Jb.ModuleInitStartTime],e,"firstApply"),this.isFirstApplyResult=!0}},{key:"onFirstCalcFinished",value:function(e){if(this.isFirstCalcFinish||e<=0||!this.isModuleInit||this[Jb.CalculationStartTime]<=0)this.isFirstCalcFinish=!0;else{this.isFirstCalcFinish=!0;try{this.reportFirstCalcDurationWithCacheHitRate(Date.now()-this[Jb.CalculationStartTime],e,"firstCalcFinish")}catch(e){console.error("onFirstCalcFinished Error type: ".concat(this.bizType),e)}this.stopReport()}}},{key:"tryReportCalculationCacheTimeDifference",value:function(){var e=this[Jb.CalculationStartTime],t=this[Jb.ReceiveCompleteServerSideCacheTime];e&&t&&we.PxA.collectSheetEvent("sheet_calculation_cache_time_diff_dev",{diff_time:e-t})}},{key:"getCacheHitRateData",value:function(e){var t=0,n=0,r=0,a=0,o=0,i=0;if("string"!=typeof e){var u=this.getAll();t=u[Jb.FormulaCount],n=u[Jb.ServerSideCacheFormulaCount],a=(r=u[Jb.ServerSideCacheHitFormulaCount])/n,o=n/t,i=r/t}else t=this.get(e,Jb.FormulaCount),n=this.get(e,Jb.ServerSideCacheFormulaCount),a=(r=this.get(e,Jb.ServerSideCacheHitFormulaCount))/n,o=n/t,i=r/t;return{formula_count:t,cache_formula_count:n,cached_formula_count:r,cache_hit_rate:Number.isFinite(a)?a:0,formula_cache_hit_rate:Number.isFinite(i)?i:0,server_cache_hit_rate:Number.isFinite(o)?o:0,is_shortcut:(0,we.pPK)().toString(),biz_type:this.bizType}}},{key:"reportFirstCalcDurationWithCacheHitRate",value:function(e,t,n){this.shouldReport&&we.PxA.collectSheetEvent("sheet_first_calculation_duration_with_cache_hit_rate_dev",Object.assign({duration:e,type:n,calc_formula_count:t,calc_count:this.calcCount},this.getCacheHitRateData()))}},{key:"reportFirstCalcCacheHitRate",value:function(){if(!this.lock&&this.shouldReport){var e=this.getCacheHitRateData();e.formula_count<=0||we.PxA.collectSheetEvent("sheet_calculation_cache_hit_rate_dev",Object.assign({},e,{is_sheet:!1}))}}},{key:"reportCacheHitRate",value:function(e){if(this.lock)this.reportIdsQueue.push(e);else if(this.shouldReport){var t=this.getCacheHitRateData(e);t.formula_count<=0||we.PxA.collectSheetEvent("sheet_calculation_cache_hit_rate_dev",Object.assign({},t,{is_sheet:!0}))}}}]),e}();jb=Jb.ModuleInitStartTime,zb=Jb.CalculationStartTime,Gb=Jb.ReceiveCompleteServerSideCacheTime;var Kb=function(e){function t(){var e;return(0,y.Z)(this,t),(e=(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))).bizType="conditionalFormat",e}return(0,g.Z)(t,e),t}(Yb),Xb=function(e){function t(){var e;return(0,y.Z)(this,t),(e=(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))).bizType="pivot",e.allPivotCalcTime=0,e.pivotCalcCount=0,e}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"onCalcEnd",value:function(e,t){this.allPivotCalcTime+=e,this.pivotCalcCount+=t}},{key:"onCalcFinished",value:function(){this.allPivotCalcTime<=0||(we.QYs.reportAllPivotPerformance({sub_event_name:"pivot_formula_all_calculated",duration_time:this.allPivotCalcTime,calc_pivot_count:this.pivotCalcCount}),this.allPivotCalcTime=0,this.pivotCalcCount=0)}}]),t}(Yb),Qb=function(){function e(t){var n=this;(0,y.Z)(this,e),this.collectCFByCopy=[],this.formulasMap=new Map,this.rules=[],this.cellRuleIdsMap=new lv,this.removeFormulaVar=function(e){var t,r,a=n.getRangeByFormula(e),o=null===(t=n.formulasMap.get(e))||void 0===t?void 0:t.ruleId;if(void 0!==o){var i=n.getRuleById(o);a&&i&&(null===(r=i.formulaVarManager.getFormulaVarMap())||void 0===r||r.delete(a))}},this.sheet=t,this.bindEvents()}return(0,C.Z)(e,[{key:"bindEvents",value:function(){this.sheet.getCalcEngine().formulaSpace.addListener(ut.FormulaSpaceEvents.onFormulaUnregistered,this.removeFormulaVar)}},{key:"getRuleById",value:function(e){return this.rules.find((function(t){return t.cfId===e}))}},{key:"getRuleIndex",value:function(e){return this.rules.findIndex((function(t){return t.cfId===e}))}},{key:"getAllRules",value:function(){return this.rules}},{key:"hasRules",value:function(){return this.rules.length>0}},{key:"getAllRuleIds",value:function(){return this.rules.map((function(e){return e.cfId}))}},{key:"addRuleImp",value:function(e,t){var n=t.ranges,r=t.ruleType,a=t.style,o=t.attrs,i=t.index,u=this.getRuleIndex(e);if(ZE[r]&&!(u>=0)){var s=Wb({sheet:this.sheet,cfId:e,ranges:n,ruleType:r,style:a,attrs:o});return void 0!==i&&i>=0?this.rules.splice(i,0,s):this.rules.push(s),s}}},{key:"addRule",value:function(e,t){var n=this.addRuleImp(e,t);this.afterAddRule(e,n)}},{key:"addRuleV2",value:function(e){if(e.value){var t=e.value,n=e.index,r=t.id;if(t.rule&&null!=t.rule.ruleType&&r&&!(this.getRuleIndex(r)>=0)){var a=function(e,t){var n,r,a=qb[e.rule.ruleType];if(a){var o=e.id,i=e.ranges,u=e.style,s=e.rule;return Wb({ruleType:a,cfId:null!==(n=o)&&void 0!==n?n:"",sheet:t,ranges:i?i.map((function(e){return Zc(e,t)})).map((function(e){return li(e,!0)})):[],style:null!==(r=Fk(u))&&void 0!==r?r:{},attrs:$b(s)})}}(t,this.sheet);a&&(null!=n?this.rules.splice(n,0,a):this.rules.push(a)),this.afterAddRule(r,a)}}}},{key:"afterAddRule",value:function(e,t){t&&(t.initFormula(),this.setRuleFormulasSymbolAndIdsMap(t)),this.dispatchChange({type:"addConditionalFormat",cfId:e}),this.sheet.getCalcEngine().cfmStatistics.isModuleInit||this.sheet.getCalcEngine().cfmStatistics.initModule()}},{key:"setRule",value:function(e,t){var n=t.ranges,r=t.ruleType,a=t.style,o=t.attrs,i=this.getRuleIndex(e);if(ZE[r]&&-1!==i){var u=this.rules[i],s=u.formulaVarManager.getFormulaVarMap();u.toJSON();var l=Wb({sheet:this.sheet,cfId:e,ranges:n,ruleType:r,style:a,attrs:o});this.rules[i]=l,l.initFormula(),this.setRuleFormulasSymbolAndIdsMap(l),this.clearRuleFormulasIdMap(u),this.clearCellRuleIdsMapByRuleId(e),this.dispatchChange({type:"setConditionalFormat",affectedRanges:null!=s&&s.size?(0,m.Z)(s.keys()):u.getBaseRanges(),cfId:e}),u.destroy()}}},{key:"deleteRule",value:function(e){var t=this.getRuleIndex(e);if(-1!==t){var n=this.rules.splice(t,1),r=(0,p.Z)(n,1)[0];this.clearRuleFormulasIdMap(r),this.clearCellRuleIdsMapByRuleId(e);var a=r.formulaVarManager.getFormulaVarMap();this.dispatchChange({type:"delConditionalFormat",cfId:e,affectedRanges:null!=a&&a.size?(0,m.Z)(a.keys()):r.getBaseRanges()}),r.destroy()}}},{key:"moveRule",value:function(e){var t=e.source,n=e.target;if(this.getRuleByIndex(t)){var r=this.rules.splice(t,1).shift(),a=r.formulaVarManager.getFormulaVarMap();this.rules.splice(n,0,r),this.dispatchChange({type:"moveConditionalFormat",cfId:r.cfId,affectedRanges:null!=a&&a.size?(0,m.Z)(a.keys()):r.getBaseRanges()})}}},{key:"getRangeByFormula",value:function(e){var t;return null===(t=this.formulasMap.get(e))||void 0===t?void 0:t.range}},{key:"getRuleIdByFormula",value:function(e){var t;return null===(t=this.formulasMap.get(e))||void 0===t?void 0:t.ruleId}},{key:"getCellRuleIdsMap",value:function(){return this.cellRuleIdsMap}},{key:"setCellRuleIdsMap",value:function(e,t,n){var r=this.cellRuleIdsMap.get(e,t);r instanceof Set?r.add(n):"string"!=typeof r?this.cellRuleIdsMap.set(e,t,n):this.cellRuleIdsMap.set(e,t,new Set([r,n]))}},{key:"clearCellRuleIdsMapByRuleId",value:function(e){this.cellRuleIdsMap.forEach((function(t,n,r,a){if(t instanceof Set)return t.delete(e),void(0===t.size&&a.delete(n,r));"string"!=typeof t||t!==e||a.delete(n,r)}))}},{key:"getStylesByRange",value:function(e){var t=this;if(e){var n=new lv;return(e instanceof vu?e.getRanges():[e]).forEach((function(e){for(var r=e.toJSON(),a=r.row,o=r.col,i=r.rowCount,u=r.colCount,s=a;s<a+i;s++)for(var l=o;l<o+u;l++)n.set(s,l,t.getCellStyleInRules(s,l,t.getCellRuleIdsMap()))})),n}}},{key:"dispatchChange",value:function(e){this.sheet.dispatch("ConditionalFormatChanged",e)}},{key:"getRulesByRange",value:function(e){return this.rules.filter((function(t){return t.getBaseRanges().some((function(t){return Array.isArray(e)?e.some((function(e){return t.isIntersect(e)})):t.isIntersect(e)}))}))}},{key:"getRuleIds",value:function(e){return this.getRulesByRange(e).map((function(e){return e.cfId}))}},{key:"getLastIndex",value:function(){return this.rules.length}},{key:"getRuleByIndex",value:function(e){return this.rules[e]}},{key:"getRuleIdsByCell",value:function(e,t,n){return n.get(e,t)}},{key:"isIconsStyle",value:function(e){return void 0!==e.iconType&&void 0!==e.iconLevel}},{key:"isDataBarStyleInfo",value:function(e){return void 0!==e.percent&&void 0!==e.originPoint}},{key:"isConditionalFormatStyle",value:function(e){return e.backColor||e.foreColor||void 0!==e.textDecoration||e.font}},{key:"getCellStyleInRules",value:function(e,t,n){var r=this.getRuleIdsByCell(e,t,n);if(!r)return null;for(var a=function(e,t){return["colorScale","dataBar","iconSet"].includes(e)?e:"expression"===e?t:"cellIs"},o=function(e){return"string"==typeof r&&r!==e||r instanceof Set&&!r.has(e)},i={},u={},s=this.getAllRules(),l=s.length-1;l>=0;l--){var c=s[l],h=c.cfId;if(!o(h)){var f=a(c.ruleType,h);if(!i[f]){var d=null;switch(c.ruleType){case"dataBar":this.sheet.hasCheckbox(e,t)||(d=c.getDataBarStyle(e,t));break;case"iconSet":this.sheet.hasCheckbox(e,t)||this.sheet.getReminder(e,t)||(d=c.getIconSetStyle(e,t));break;default:d=c.getFormatStyle(e,t)}d&&(i[f]=1,u=Object.assign({},d,{},u))}}}return"transparent"===u.foreColor&&delete u.foreColor,Object.keys(u).length?u:null}},{key:"getCellStyle",value:function(e,t){return this.sheet._getModel().getConditionalFormatStyle(e,t)}},{key:"setCellStyle",value:function(e,t,n){this.sheet._getModel().setConditionalFormatStyle(e,t,n)}},{key:"clearStylesByRange",value:function(e,t,n,r){this.sheet._getModel().clearConditionalFormatStyle(e,t,n,r)}},{key:"getAdjustedBaseRangesIfAddRowCol",value:function(e,t){var n={isAdjust:!1,isExpand:!1,value:[]},r=e.getBaseRanges().map((function(e){return e.clone()}));return this.isAdjustBaseRangesIfAddRowCol(r,t,this.expandBaseRangeIfAddRowCol,n)&&(n.isAdjust=!0,n.value=r),n}},{key:"expandBaseRangeIfAddRowCol",value:function(e,t,n,r,a){var o,i=t.type,u=t.count;e instanceof Ni||(e instanceof Zi&&(e=new Oi(e.rowFrom(),e.colFrom(),e.rowCount(),e.colCount(),e.sheet()),null!=r&&r.splice(a||0,1,e)),"row"!==i||e instanceof Vi?"col"!==i||e instanceof xi||(o=e.colCount(),e.setColCount(o+u),n&&(n.isExpand=!0)):(o=e.rowCount(),e.setRowCount(o+u),n&&(n.isExpand=!0)))}},{key:"isAdjustBaseRangesIfAddRowCol",value:function(e,t,n,r){var a=!1,o=t.type,i=t.target,u=t.count,s=t.source;return e.forEach((function(l,c){var h,f,d;if("row"===o?(h=l.rowFrom(),f=l.rowTo(),d=l.rowCount()):"col"===o?(h=l.colFrom(),f=l.colTo(),d=l.colCount()):(h=0,f=0,d=0),!(l instanceof Ni)){var v=i===s+1&&f===s||i===s&&h===s,g=i<=h,m=h<i&&i<=f;"row"===o?v?(n(l,t,r,e,c),a=!0):g?(l.setRowFrom(h+u),a=!0):m&&(l.setRowCount(d+u),a=!0):"col"===o&&(v?(n(l,t,r,e,c),a=!0):g?(l.setColFrom(h+u),a=!0):m&&(l.setColCount(d+u),a=!0))}})),a}},{key:"getAdjustedFormulaStrIfAddRowCol",value:function(e,t){var n={isAdjust:!1,value:""};if("expression"!==e.ruleType)return n;var r=t.target,a=t.source,o=Number(a)-Number(r)>=0,i=Number(a)-Number(r)>=0,u=e.getFirstCell();if("row"===t.type?t.source===(null==u?void 0:u.rowFrom())&&o:t.source===(null==u?void 0:u.colFrom())&&i)return n;var s=e.getFirstAbsoluteRefMap();return s?(n.isAdjust=this.isAdjustFirstCellRefMapIfAddRowCol(s,t),n.isAdjust&&(n.value=e.getAdjustedFormulaStr(s)),n):n}},{key:"isAdjustFirstCellRefMapIfAddRowCol",value:function(e,t){var n=!1,r=t.target,a=t.source,o=t.type,i=t.count,u=Number(a)-Number(r)>=0,s=Number(a)-Number(r)>=0,l=function(e,t,n){e.setRowFrom(t+n)},c=function(e,t,n){e.setColFrom(t+n)};for(var h in e){var f,d=e[h];if((null===(f=d.sheet())||void 0===f?void 0:f.id())===this.sheet.id())if("row"===o){var v=d.rowFrom();(a<v||a===v&&u)&&(l(d,v,i),n=!0)}else if("col"===o){var g=d.colFrom();(a<g||a===g&&s)&&(c(d,g,i),n=!0)}}return n}},{key:"getRulesByAddRowCol",value:function(e,t,n,r){var a=this,o=new Map,i={source:t,type:e,target:n,count:r};return"row"!==e&&"col"!==e||this.rules.forEach((function(e){var t=a.getAdjustedFormulaStrIfAddRowCol(e,i),n=e.cfId,r=void 0===n?"":n,u={attrs:null,ranges:null};if(t.isAdjust&&""!==t.value){var s=[];s.push({formula:[t.value]}),u.attrs=s}var l=a.getAdjustedBaseRangesIfAddRowCol(e,i);l.isAdjust&&l.value.length&&(u.ranges=new vu(l.value,a.sheet,!0)),(t.isAdjust&&""!==t.value||l.isExpand&&l.value.length)&&o.set(r,u)})),o}},{key:"getAdjustedBaseRangesIfDel",value:function(e,t){var n={isAdjust:!1,value:[]},r=e.getBaseRanges().map((function(e){return e.clone()}));return n.isAdjust=this.isAdjustBaseRangesIfDelRowCol(r,t),n.value=r,n}},{key:"isAdjustBaseRangesIfDelRowCol",value:function(e,t){var n=this,r=!1,a=t.index,o=t.count,i=t.type,u=a+o-1;return e.forEach((function(e){var t=n.baseRangeTool(i).rowColFrom(e),s=n.baseRangeTool(i).rowColTo(e);if(u<t){var l=t-o;n.baseRangeTool(i).adjustRowColFrom(e,l),r=!0}else if(a<t&&u>=t&&u<=s){n.baseRangeTool(i).adjustRowColFrom(e,a);var c=s-u;n.baseRangeTool(i).adjustRowColCount(e,c),r=!0}else if(a<=t&&u>=s)n.baseRangeTool(i).setRowColOfBaseRangeMissing(e),r=!0;else if(a>=t&&a<=s&&u<=s){var h=a-t+s-u;n.baseRangeTool(i).adjustRowColCount(e,h),r=!0}else if(a>=t&&a<=s&&u>s){var f=a-t;n.baseRangeTool(i).adjustRowColCount(e,f),r=!0}})),r}},{key:"getRulesByDelRowCol",value:function(e,t,n){var r=this,a=new Map,o={index:t,count:n,type:e};return"row"!==e&&"col"!==e||this.rules.forEach((function(i){var u="row"===e?new xi(t,n,r.sheet):new Vi(t,n,r.sheet),s={subRange:null,attrs:null,newBaseRanges:null,setAttrs:function(e){this.attrs=[{formula:[e]}]},setNewBaseRanges:function(e){this.newBaseRanges=e},setSubRange:function(e){this.subRange=e}};if(i.isIntersect(u)){var l=function(e,t){var n=[];return e.forEach((function(e){var r=e.sub(t);n.push.apply(n,(0,m.Z)(r))})),n}(i.getBaseRanges(),u);if(s.setSubRange&&s.setSubRange(l),s.subRange&&0===s.subRange.length)a.set(i.cfId,s);else{var c=r.getAdjustedFormulaStrIfDelRowCol(i,o);if(c.isAdjust&&""!==c.value){s.setAttrs(c.value);var h=r.getAdjustedBaseRangesIfDel(i,o);return h.isAdjust&&s.setNewBaseRanges(h.value),void a.set(i.cfId,s)}a.set(i.cfId,s)}}else{var f=r.getAdjustedFormulaStrIfDelRowCol(i,o);if(f.isAdjust&&""!==f.value){s.setAttrs(f.value);var d=r.getAdjustedBaseRangesIfDel(i,o);d.isAdjust&&s.setNewBaseRanges(d.value),a.set(i.cfId,s)}}})),a}},{key:"baseRangeTool",value:function(e){return"row"===e?{adjustRowColFrom:function(e,t){e.setRowFrom(t)},adjustRowColCount:function(e,t){e.setRowCount(t)},rowColFrom:function(e){return e.rowFrom&&e.rowFrom()},rowColTo:function(e){return e.rowTo&&e.rowTo()},setRowColOfBaseRangeMissing:function(e){e.setRowCount(0)}}:{adjustRowColFrom:function(e,t){e.setColFrom(t)},adjustRowColCount:function(e,t){e.setColCount(t)},rowColFrom:function(e){return e.colFrom&&e.colFrom()},rowColTo:function(e){return e.colTo&&e.colTo()},setRowColOfBaseRangeMissing:function(e){e.setColCount(0)}}}},{key:"isAdjustFirstCellRefMapIfDelRowCol",value:function(e,t){var n=!1,r=function(e){e.setRowCount(0),e.setColCount(0)},a=t.type,o=t.index,i=t.count,u=o+i-1;for(var s in e){var l,c=e[s];if((null===(l=c.sheet())||void 0===l?void 0:l.id())===this.sheet.id()){var h=this.baseRangeTool(a).rowColFrom(c),f=this.baseRangeTool(a).rowColTo(c),d=o>=h&&o<=f&&u<=f;if(u<h){var v=h-i;this.baseRangeTool(a).adjustRowColFrom(c,v),n=!0}else if(o<h&&u>=h&&u<=f){this.baseRangeTool(a).adjustRowColFrom(c,o);var g=f-u;this.baseRangeTool(a).adjustRowColCount(c,g),n=!0}else if(o<=h&&u>=f)r(c),n=!0;else if(d){var m=o-h+f-u;this.baseRangeTool(a).adjustRowColCount(c,m),n=!0}else if(o>=h&&o<=f&&u>f){var p=o-h;this.baseRangeTool(a).adjustRowColCount(c,p),n=!0}}}return n}},{key:"getAdjustedFormulaStrIfDelRowCol",value:function(e,t){var n={isAdjust:!1,value:""};if("expression"!==e.ruleType)return n;var r=e.getFirstAbsoluteRefMap();return r?(n.isAdjust=this.isAdjustFirstCellRefMapIfDelRowCol(r,t),n.isAdjust&&(n.value=e.getAdjustedFormulaStr(r)),n):n}},{key:"getAdjustedRulesByMoveRange",value:function(e,t,n){var r=this,a=new Map,o={toRange:e,fromRange:t,targetSheet:n};return this.rules.forEach((function(e){if("expression"===e.ruleType){var t={attrs:null,newBaseRanges:null,setAttrs:function(e){this.attrs=[{formula:[e]}]},setNewBaseRanges:function(e){this.newBaseRanges=e}},n=r.getAdjustedFormulaStrIfMoveRange(e,o);if(n.isAdjust&&""!==n.value){t.setAttrs(n.value);var i=r.getAdjustedBaseRangesIfMoveRange(e,o);i.isAdjust&&0!==i.value.length&&t.setNewBaseRanges(i.value),a.set(e.cfId,t)}}})),a}},{key:"isAdjustBaseRangesIfMoveRange",value:function(e,t){var n=!1,r=t.fromRange,a=t.toRange,o=t.targetSheet;return e.forEach((function(e){if(r.contain(e)){var t,i=function(e,t){var n={col:0,row:0},r=e.rowFrom(),a=e.colFrom(),o=t.rowFrom(),i=t.colFrom();return n.row=o-r,n.col=i-a,n}(r,e),u=a.rowFrom(),s=a.colFrom();(function(e,t,n){e.setRowFrom(t+n)})(e,u,i.row),function(e,t,n){e.setColFrom(t+n)}(e,s,i.col),o.id()!==(null===(t=e.sheet())||void 0===t?void 0:t.id())&&function(e){e.setColCount(0),e.setRowCount(0)}(e),n=!0}})),n}},{key:"getAdjustedBaseRangesIfMoveRange",value:function(e,t){var n={isAdjust:!1,value:[]},r=e.getBaseRanges().map((function(e){return e.clone()}));return n.isAdjust=this.isAdjustBaseRangesIfMoveRange(r,t),n.isAdjust&&(n.value=r),n}},{key:"isAdjustFirstCellRefMapIfMoveRange",value:function(e,t){var n=!1,r=function(e,t){var n={col:0,row:0},r=e.rowFrom(),a=e.colFrom(),o=t.rowFrom(),i=t.colFrom();return n.row=o-r,n.col=i-a,n},a=function(e,t,n){e.setRowFrom(t+n)},o=function(e,t,n){e.setColFrom(t+n)},i=t.toRange,u=t.fromRange,s=t.targetSheet;for(var l in e){var c=e[l];if(u.contain(c)){var h,f=r(u,c),d=i.rowFrom(),v=i.colFrom();a(c,d,f.row),o(c,v,f.col),s.id()!==(null===(h=c.sheet())||void 0===h?void 0:h.id())&&c.setSheet(s),n=!0}}return n}},{key:"getAdjustedFormulaStrIfMoveRange",value:function(e,t){var n={isAdjust:!1,value:""},r=e.getFirstAbsoluteRefMap();return r?(n.isAdjust=this.isAdjustFirstCellRefMapIfMoveRange(r,t),n.isAdjust&&(n.value=e.getAdjustedFormulaStr(r)),n):n}},{key:"getAdjustedRulesByDelSheet",value:function(e,t){var n=this,r=new Map,a=t.getSheetIds(),o=[];return a.forEach((function(n){if(n!==e){var r=t.getSheetFromId(n);r&&o.push(r)}})),o.forEach((function(t){t.conditionalFormatModel.rules.forEach((function(a){if("expression"===a.ruleType){var o={attrs:null,cfId:null,setAttrs:function(e){this.attrs=[{formula:[e]}]}},i=n.getAdjustedFormulaStrIfDelSheet(a,e);if(i.isAdjust&&""!==i.value){o.setAttrs(i.value),o.cfId=a.cfId;var u=r.get(t.id());u||(u=[],r.set(t.id(),u)),u.push(o)}}}))})),r}},{key:"getAdjustedFormulaStrIfDelSheet",value:function(e,t){var n={isAdjust:!1,value:""};if("expression"!==e.ruleType)return n;var r=e.getFirstAbsoluteRefMap();return r?(Object.values(r).forEach((function(e){var r;(null===(r=e.sheet())||void 0===r?void 0:r.id())===t&&(function(e){e.setRowCount(0),e.setColCount(0)}(e),n.isAdjust=!0)})),n.isAdjust&&(n.value=e.getAdjustedFormulaStr(r)),n):n}},{key:"getAdjustedBaseRangesIfMoveRowCol",value:function(e,t,n,r){var a={isAdjust:!1,value:[]},o=e.getBaseRanges().map((function(e){return e.clone()})),i=this.isAdjustBaseRangesIfAddRowCol(o,t,(function(e,t){var n=t.count,r=t.type;if("row"===r){var a=e.rowFrom();e.setRowFrom(a+n)}else if("col"===r){var o=e.colFrom();e.setColFrom(o+n)}}));i&&function(e,t,n){if("row"===n){var r=e.rowFrom()+t;e.setRowFrom(r)}else if("col"===n){var a=e.colFrom()+t;e.setColFrom(a)}}(r.fromRange,t.count,t.type);var u=this.isAdjustBaseRangesIfMoveRange(o,r);return i&&function(e){n.index+=e}(t.count),i===this.isAdjustBaseRangesIfDelRowCol(o,n)&&!u||(a.isAdjust=!0),a.isAdjust&&(a.value=o),a}},{key:"getAdjustedFormulaStrIfMoveRowCol",value:function(e,t,n,r){var a={isAdjust:!1,value:""},o=e.getFirstAbsoluteRefMap();if(!o)return a;var i=this.isAdjustFirstCellRefMapIfAddRowCol(o,t);i&&function(e,t,n){if("row"===n){var r=e.rowFrom()+t;e.setRowFrom(r)}else if("col"===n){var a=e.colFrom()+t;e.setColFrom(a)}}(r.fromRange,t.count,t.type);var u=this.isAdjustFirstCellRefMapIfMoveRange(o,r);return i&&function(e){n.index+=e}(t.count),i===this.isAdjustFirstCellRefMapIfDelRowCol(o,n)&&!u||(a.isAdjust=!0),a.isAdjust&&(a.value=e.getAdjustedFormulaStr(o)),a}},{key:"getAdjustedRulesByMoveRowCol",value:function(e,t,n,r){var a,o,i,u=this,s=new Map;"row"===t?(a=n.rowFrom(),o=r.rowFrom(),i=n.rowCount()):"col"===t?(a=n.colFrom(),o=r.colFrom(),i=n.colCount()):(a=0,o=0,i=0);var l={type:t,source:o,target:o,count:i},c={type:t,index:a,count:i},h={fromRange:n.clone(),toRange:r.clone(),targetSheet:e},f=function(){l={type:t,source:o,target:o,count:i},c={type:t,index:a,count:i},h={fromRange:n.clone(),toRange:r.clone(),targetSheet:e}};return this.rules.forEach((function(e){if("expression"===e.ruleType){var t={attrs:null,newBaseRanges:null,setAttrs:function(e){this.attrs=[{formula:[e]}]},setNewBaseRanges:function(e){this.newBaseRanges=e}};f();var n=u.getAdjustedFormulaStrIfMoveRowCol(e,l,c,h);if(n.isAdjust&&""!==n.value){t.setAttrs(n.value),f();var r=u.getAdjustedBaseRangesIfMoveRowCol(e,l,c,h);r.isAdjust&&r.value.length&&t.setNewBaseRanges(r.value),s.set(e.cfId,t)}}})),s}},{key:"setRuleFormulasSymbolAndIdsMap",value:function(e){var t=e.formulaVarManager.getFormulaVarMap();if(t&&0!==t.size){var n,r=_n(t.entries());try{for(r.s();!(n=r.n()).done;){var a=(0,p.Z)(n.value,2),o=a[0],i=a[1];this.formulasMap.set(i,{ruleId:e.cfId,range:o}),i[ME]=ME}}catch(e){r.e(e)}finally{r.f()}}this.sheet.getCalcEngine().pivotStatistics.add(this.sheet.id(),Jb.FormulaCount)}},{key:"clearRuleFormulasIdMap",value:function(e){var t=e.formulaVarManager.getFormulaVarMap();if(t&&0!==t.size){var n,r=_n(t.values());try{for(r.s();!(n=r.n()).done;){var a=n.value;this.formulasMap.delete(a)}}catch(e){r.e(e)}finally{r.f()}}}},{key:"toJSON",value:function(){if(this.rules&&0!==this.rules.length)return this.rules.map((function(e){return e.toJSON()}))}},{key:"unBindEvents",value:function(){this.sheet.getCalcEngine().formulaSpace.removeListener(ut.FormulaSpaceEvents.onFormulaUnregistered,this.removeFormulaVar)}},{key:"destroy",value:function(){this.rules.forEach((function(e){e.destroy()})),this.unBindEvents(),this.rules=[],this.formulasMap.clear(),this.cellRuleIdsMap.clear()}}],[{key:"fromJSON",value:function(t,n){var r=new e(t);return Array.isArray(n)&&n.forEach((function(e){var t=(0,Re.default)(e);delete t.cfId,r.addRuleImp(e.cfId,t)})),r}}]),e}(),eF=function(e){return 0===Object.keys(e).length};function tF(e){var t=JSON.parse(JSON.stringify(e));if(delete t.schemaVersion,t.sheets){var n=function(e){var n=t.sheets[e];n.entities&&!eF(n.entities)&&iF(n.entities);var r=n.data&&n.data.dataTable;if(r)for(var a in r)if(r[a])for(var o in r[a])r[a][o]&&(r[a][o].styleId&&(r[a][o].style=n.entities.styles[r[a][o].styleId],delete r[a][o].styleId),r[a][o].value&&Array.isArray(r[a][o].value)&&(r[a][o].value=r[a][o].value.map((function(e){if(e.type)switch(e.type){case"mention":return n.mention[e.id];case"embed-image":return n.image[e.id]}return e}))));if(n.comment&&!eF(n.comment))for(var i in r||(r={}),n.comment)for(var u in r[i]||(r[i]={}),n.comment[i])r[i][u]||(r[i][u]={}),r[i][u].comments=n.comment[i][u];r&&(n.data?n.data.dataTable=r:n.data={dataTable:r}),delete n.comment,delete n.image,delete n.mention,delete n.entities,t.sheets[e]=n};for(var r in t.sheets)n(r)}return t}function nF(e){var t=JSON.parse(JSON.stringify(e));t.entities&&!eF(t.entities)&&iF(t.entities);var n=t.data&&t.data.dataTable;if(n)for(var r in n)if(n[r])for(var a in n[r])n[r][a]&&(n[r][a].styleId&&(n[r][a].style=t.entities.styles[n[r][a].styleId],delete n[r][a].styleId),n[r][a].value&&Array.isArray(n[r][a].value)&&(n[r][a].value=n[r][a].value.map((function(e){if(e.type)switch(e.type){case"mention":return t.mention[e.id];case"embed-image":return t.image[e.id]}return e}))));if(t.comment&&!eF(t.comment))for(var o in n||(n={}),t.comment)for(var i in n[o]||(n[o]={}),t.comment[o])n[o][i]||(n[o][i]={}),n[o][i].comments=t.comment[o][i];return n&&(t.data?t.data.dataTable=n:t.data={dataTable:n}),delete t.comment,delete t.image,delete t.mention,delete t.entities,t}function rF(e){var t=new Map;return{sheetSnapshot:oF(e.sheetSnapshot,e.blocks,t),blocks:t}}function aF(e){var t=JSON.parse(JSON.stringify(e.snapshot)),n=new Map;if(t.sheets)for(var r in t.sheets)t.sheets[r]=oF(t.sheets[r],e.blocks,n),delete t.sheets[r].comment,delete t.sheets[r].mention,delete t.sheets[r].image,delete t.sheets[r].entities;return delete t.schemaVersion,{snapshot:t,blocks:n}}function oF(e,t,n){var r=JSON.parse(JSON.stringify(e));if(r.blocks){var a=r.blocks.length,o=JSON.parse(JSON.stringify(r.blocks));o.sort((function(e,t){return e.startRowIndex-t.startRowIndex})),o.forEach((function(e,i){var u=t.get(e.token),s=JSON.parse(JSON.stringify(u)),l=!1,c=!1;0===i&&(l=!0),i===a-1&&(c=!0),function(e,t,n,r,a,o){if((void 0===e.entities||eF(e.entities))&&(void 0===e.comment||eF(e.comment))&&(void 0===e.image||eF(e.image))&&(void 0===e.mention||eF(e.mention)))return;var i=e;i.entities&&!eF(i.entities)&&iF(i.entities);var u=function(e,t,n){var r=!1,a=!1;if(e&&!eF(e)&&(r=!0),t&&!eF(t)&&(a=!0),n&&!eF(n)&&(a=!0),a&&r)return function(r){r&&r.hasOwnProperty("styleId")&&uF(r,e),r&&r.hasOwnProperty("value")&&sF(r,t,n)};if(a)return function(e){e&&e.hasOwnProperty("value")&&sF(e,t,n)};if(r)return function(t){t&&t.hasOwnProperty("styleId")&&uF(t,e)}}(i.entities&&!eF(i.entities)?i.entities.styles:void 0,i.image,i.mention);if(u&&function(e,t){if(t.rows&&t.rows.length)for(var n=0,r=t.rows.length;n<r;n++){var a=t.rows[n];if(a&&a.columns&&a.columns.length)for(var o=0,i=a.columns.length;o<i;o++)e(a.columns[o])}}(u,t),i.comment&&!eF(i.comment)){var s,l,c=_n(i.blocks);try{for(c.s();!(l=c.n()).done;){var h=l.value;if(h.startRowIndex===n){s=h;break}}}catch(e){c.e(e)}finally{c.f()}if(a&&0!==n){var f=n;for(var d in i.comment)f=Math.min(f,Number(d));f<n&&(t.rows=new Array(n-f).fill(null).concat(t.rows),s.startRowIndex=f,s.rowsCount+=n-f,n=f)}if(o){var v=200;r=i.rowCount?i.rowCount:v}(function(e,t,n,r){var a=t.rows.length+n;for(var o in e)Number(o)>=a&&Number(o)<r&&(a=Number(o)+1);for(var i=n;i<a;i++){var u=Number(i)-n;if(void 0===t.rows[u]&&(t.rows[u]=null),e[i]){var s=0;for(var l in e[i])s=Math.max(s,Number(l));for(var c in t.rows[u]||(t.rows[u]={columns:new Array(s).fill(null)}),e[i])t.rows[u].columns[c]||(t.rows[u].columns[c]={}),t.rows[u].columns[c].comments=e[i][c];delete e[i]}}})(i.comment,t,n,r),s.rowsCount=t.rows.length}}(r,s,e.startRowIndex,c?r.rowCount||200:o[i+1].startRowIndex,l,c),n.set(e.token,s)}))}return r}function iF(e){if(e.styles&&e.dropdowns){for(var t in e.styles)e.styles[t].hasOwnProperty("dropdown")&&(e.styles[t].dropdown=e.dropdowns[e.styles[t].dropdown]);delete e.dropdowns}return e}function uF(e,t){return e.styleId&&(e.style=t[e.styleId],delete e.styleId),e}function sF(e,t,n){if(Array.isArray(e.value))for(var r in e.value)if(e.value[r].hasOwnProperty("type")){var a=e.value[r].id;switch(e.value[r].type){case"embed-image":e.value[r]=t[a];break;case"mention":e.value[r]=n[a]}}}function lF(e){if(null==e)return e;if("object"!=(0,_.Z)(e))return e;for(var t in e)void 0===e[t]&&delete e[t];return Object.keys(e).sort().reduce((function(t,n){return Array.isArray(e[n])?t[n]=e[n].map(lF):"object"==(0,_.Z)(e[n])?t[n]=lF(e[n]):t[n]=e[n],t}),{})}function cF(e){var t=lF(e),n=JSON.stringify(t);return bt()(n)}function hF(e){if(!e)return!0;var t=e.columns;return!t||0===t.length||t.filter((function(e){return null===e||0===Object.keys(e).length})).length===t.length}var fF=function(){function e(t){for(var n in(0,y.Z)(this,e),this._sheetSnapshot=t,this._comment={},this._mention={},this._mentionHashs={},this._image={},this._imageHashs={},this._styles={},this._stylesHashs={},this._dropdowns={},this._dropdownsHashs={},this._comment=t.comment||{},this._mention=t.mention||{},this._mention)this._mentionHashs[cF(this._mention[n])]=n;for(var r in this._image=t.image||{},this._image)this._imageHashs[cF(this._image[r])]=r;for(var a in this._styles=t.entities&&t.entities.styles||{},this._styles)this._stylesHashs[cF(this._styles[a])]=a;for(var o in this._dropdowns=t.entities&&t.entities.dropdowns||{},this._dropdowns)this._dropdownsHashs[cF(this._dropdowns[o])]=o;this._mentionsIndex=1+this._getMaxIndex(this._mention),this._imagesIndex=1+this._getMaxIndex(this._image),this._stylesIndex=1+this._getMaxIndex(this._styles),this._dropdownsIndex=1+this._getMaxIndex(this._dropdowns)}return(0,C.Z)(e,[{key:"_getMaxIndex",value:function(e){var t=0;for(var n in e)Number(n)>t&&(t=Number(n));return t}},{key:"_AddComment",value:function(e,t,n){this._comment[e]||(this._comment[e]={}),this._comment[e][t]=n}},{key:"_ExtractComments",value:function(e,t,n){n.hasOwnProperty("comments")&&(this._AddComment(e,t,n.comments),delete n.comments)}},{key:"_ExtractMentionsAndImages",value:function(e){var t=this;e.hasOwnProperty("value")&&Array.isArray(e.value)&&(e.value=e.value.map((function(e){if(e.hasOwnProperty("type"))switch(e.type){case"mention":var n=cF(e),r=Number(t._mentionHashs[n])||-1;return-1===r&&(t._mention[t._mentionsIndex]=e,t._mentionHashs[n]=t._mentionsIndex,r=t._mentionsIndex++),{type:e.type,id:r};case"embed-image":var a=cF(e),o=Number(t._imageHashs[a])||-1;return-1===o&&(t._image[t._imagesIndex]=e,t._imageHashs[a]=t._imagesIndex,o=t._imagesIndex++),{type:e.type,id:o}}return e})))}},{key:"_ExtractStyles",value:function(e){if(e.hasOwnProperty("style")){var t=e.style;if(t.hasOwnProperty("dropdown")){var n=cF(t.dropdown),r=Number(this._dropdownsHashs[n])||-1;-1===r&&(this._dropdowns[this._dropdownsIndex]=t.dropdown,this._dropdownsHashs[n]=this._dropdownsIndex,r=this._dropdownsIndex++),t.dropdown=r}var a=cF(t),o=Number(this._stylesHashs[a])||-1;-1===o&&(this._styles[this._stylesIndex]=t,this._stylesHashs[a]=this._stylesIndex,o=this._stylesIndex++),e.styleId=o,delete e.style}}},{key:"_VisitCell",value:function(e,t,n){return this._ExtractComments(e,t,n),this._ExtractMentionsAndImages(n),this._ExtractStyles(n),n}},{key:"_IsObjectEmpty",value:function(e){return 0===Object.getOwnPropertyNames(e).length}},{key:"_OldToNew_DataTable",value:function(e){for(var t in e)if(e[t])for(var n in e[t])e[t][n]&&(e[t][n]=this._VisitCell(Number(t),Number(n),e[t][n]));return e}},{key:"_UpdateItems",value:function(){if(this._IsObjectEmpty(this._comment)||(this._sheetSnapshot.comment=this._comment),this._IsObjectEmpty(this._mention)||(this._sheetSnapshot.mention=this._mention),this._IsObjectEmpty(this._image)||(this._sheetSnapshot.image=this._image),!this._IsObjectEmpty(this._styles)){var e={styles:this._styles};this._IsObjectEmpty(this._dropdowns)||(e.dropdowns=this._dropdowns),this._sheetSnapshot.entities=e}}},{key:"OldToNew",value:function(){var e=this._sheetSnapshot.data&&this._sheetSnapshot.data.dataTable;e&&(this._sheetSnapshot.data.dataTable=this._OldToNew_DataTable(e),this._UpdateItems())}},{key:"getSheetSnapshot",value:function(){return this._sheetSnapshot}},{key:"OldBlockToNewBlock",value:function(e,t){var n=t.rows.length;if(n<=0)return t;for(var r=0;r<n;r++)if(null!==t.rows[r]&&null!==t.rows[r].columns){var a=t.rows[r].columns.length;if(!(a<=0))for(var o=0;o<a;o++)null!==t.rows[r].columns[o]&&(t.rows[r].columns[o]=this._VisitCell(r+e.startRowIndex,o,t.rows[r].columns[o]))}this._UpdateItems(),function(e,t){for(var n=0,r=t.rows.length-1;hF(t.rows[n])&&n<r;)n++;for(;hF(t.rows[r])&&r>n;)r--;t.rows=t.rows.slice(n,r+1),e.startRowIndex=e.startRowIndex+n,e.rowsCount=t.rows.length,t.rows=t.rows.map((function(e){return hF(e)?null:function(e){for(var t=e.columns.length-1;t>=0&&null===e.columns[t];)t--;return e.columns=e.columns.slice(0,t+1),e}(e)}))}(e,t)}}]),e}();function dF(e){var t=JSON.parse(JSON.stringify(e));if(t.schemaVersion=1,t.sheets)for(var n in t.sheets){var r=t.sheets[n],a=new fF(r);a.OldToNew(),t.sheets[n]=a.getSheetSnapshot()}return t}function vF(e){var t=new fF(JSON.parse(JSON.stringify(e)));return t.OldToNew(),t.getSheetSnapshot()}function gF(e){var t=JSON.parse(JSON.stringify(e.snapshot)),n=new Map;if(t.sheets)for(var r in t.sheets)t.sheets[r]=pF(t.sheets[r],e.blocks,n);return t.schemaVersion=1,{snapshot:t,blocks:n}}function mF(e){var t=new Map;return{sheetSnapshot:pF(e.sheetSnapshot,e.blocks,t),blocks:t}}function pF(e,t,n){var r=JSON.parse(JSON.stringify(e)),a=new fF(r);return a.OldToNew(),r.blocks&&r.blocks.forEach((function(e){var r=t.get(e.token);if(r){var o=JSON.parse(JSON.stringify(r));a.OldBlockToNewBlock(e,o),n.set(e.token,o)}})),a.getSheetSnapshot()}function yF(e){return e.schemaVersion=2,e}function CF(e){var t=e.snapshot,n=e.blocks;return t.schemaVersion=2,{snapshot:t,blocks:n}}function _F(e){return e}function RF(e){return e}function wF(e){return e.schemaVersion=1,delete e.extra,e}function kF(e){var t=e.snapshot,n=e.blocks;return t.schemaVersion=1,delete t.extra,{snapshot:t,blocks:n}}function SF(e){return e}function EF(e){return e}var TF=function(){function e(){(0,y.Z)(this,e),this.managers={},this.managers[0]={},this.managers[1]={},this.managers[0][1]={convertWithDataTable:dF,convertWithBlocks:gF,convertSheetWithDataTable:vF,convertSheetWithBlocks:mF},this.managers[1][0]={convertWithDataTable:tF,convertWithBlocks:aF,convertSheetWithDataTable:nF,convertSheetWithBlocks:rF},this.managers[2]={},this.managers[1][2]={convertWithDataTable:yF,convertWithBlocks:CF,convertSheetWithDataTable:_F,convertSheetWithBlocks:RF},this.managers[2][1]={convertWithDataTable:wF,convertWithBlocks:kF,convertSheetWithDataTable:SF,convertSheetWithBlocks:EF}}return(0,C.Z)(e,[{key:"getInvokers",value:function(e,t){var n=[];if(e<t)for(;e+1<=t;)n.push(this.managers[e][e+1]),e++;else for(;e-1>=t;)n.push(this.managers[e][e-1]),e--;return n}},{key:"convert",value:function(e,t,n,r){if(e===t)return{snapshot:n,blocks:r};var a=this.getInvokers(e,t);if(void 0===r)return a.forEach((function(e){n=e.convertWithDataTable(n)})),{snapshot:n,blocks:null};var o={snapshot:n,blocks:r};return a.forEach((function(e){o=e.convertWithBlocks(o)})),o}},{key:"convertSheet",value:function(e,t,n,r){if(e===t)return{sheetSnapshot:n,blocks:r};var a=this.getInvokers(e,t);if(void 0===r)return a.forEach((function(e){n=e.convertSheetWithDataTable(n)})),{sheetSnapshot:n,blocks:null};var o={sheetSnapshot:n,blocks:r};return a.forEach((function(e){o=e.convertSheetWithBlocks(o)})),o}}]),e}();function AF(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,n=arguments.length>2?arguments[2]:void 0,r=arguments.length>3?arguments[3]:void 0,a=arguments.length>4?arguments[4]:void 0,o=arguments.length>5?arguments[5]:void 0;if(e)return IF(t,r);if(t&&t.formatter)return t.formatter;if(n&&n.variant&&n.variant.isFormula()){var i=n.variant.getInfo(o);if(i&&i.customData&&i.customData.autoFormat)return(0,Se.createFormatter)(r.formatterService,i.customData.autoFormat)}if(null!=n&&n.variant&&zf(n.variant)){var u=n.variant.getVar().getSpecialInfo();if(null!=u&&u.customData&&u.customData.autoFormat)return(0,Se.createFormatter)(r.formatterService,u.customData.autoFormat)}if((0,tn.isShortCut)()&&null!=n&&n.variant&&n.variant.isNumber()){var s=n.variant.getVar().getSpecialInfo();if(null!=s&&s.customData&&s.customData.autoFormat)return(0,Se.createFormatter)(r.formatterService,s.customData.autoFormat)}return!a&&t&&t.autoFormatter?t.autoFormatter:null}function IF(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,t=arguments.length>1?arguments[1]:void 0,n=bF(e);return n&&(0,Se.isDateTimeFormatter)(n)?n:t.getDefaultReminderFormatter()}function bF(e){return(null==e?void 0:e.formatter)||(null==e?void 0:e.autoFormatter)}var FF=function(e){var t={divider:!0},n=(0,L.Z)(e,om);return[n("general"),n("plain_text"),t,n("digital_without_separator"),n("digital"),n("digital_round"),t,n("percentage_rounded"),n("percentage"),n("scientific"),t].concat((0,m.Z)((0,tn.isLark)()?[]:[n("cyn_rounded"),n("cyn")]),[n("dollar_rounded"),n("dollar"),t,n("date_with_slash"),n("date_with_hyphen"),n("time"),n("date_time"),{key:"Sheets_Formats_MoreFormats",name:fn("LarkCCM_Sheets_Toolbar_MoreFormats_Menu")}])},MF=function(e){function t(e,n,r,a){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).call(this,e,n,r,a))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"fromJSON",value:function(e){e&&this.setDefaultNodeData(e)}}]),t}(mS),VF=la,NF=".gcSheet",OF=".gcSheetInternal";function xF(e,t){for(var n=0,r=e.length;n<r;n++){var a=e[n];if(!t.contain(a)&&t.isIntersect(a))return e.splice(n--,1),xF(e,t.union(a))}return t}function ZF(e){return e?e.getColumnCount():(console.error("这里不应该传入一个空对象"),0)}function DF(e){return e?e.getRowCount():(console.error("这里不应该传入一个空对象"),0)}function PF(e){return e.frozenColumnCount()}function LF(e){return e.frozenRowCount()}var BF={isProtected:!0,protectionOptions:{},showFormulaText:!1},UF=function(){function e(t,n){var r=this,a=arguments.length>2&&void 0!==arguments[2]&&arguments[2],o=arguments.length>3?arguments[3]:void 0;if((0,y.Z)(this,e),this._delTime="",this._copySheetFloatBlocks=null,this._copySheetEmbeddedBlocks=null,this._disposed=!1,this.needNotify=!0,this.lastRowHeaderWidth=0,this.lastCalcRowCount=0,this._isFirstSetFocus=!0,this._filterWatchHub=new $t.WatchedRefHub,this.$watcher=new we.CPL,this.frozenColumnCount=Od("frozenColumnCount",0,(function(e){var t=this._scrollLeftCol,n={sheet:this,sheetName:this._name,propertyName:"frozenColumnCount",newValue:e,oldValue:t};this._scrollLeftCol=e,this.chartModel.frozen("col",e),this.dispatch("FrozenChanged",n)}),(function(e){return e>=0})),this.frozenRowCount=Od("frozenRowCount",0,(function(e){var t=this._scrollTopRow,n={sheet:this,sheetName:this._name,propertyName:"frozenRowCount",newValue:e,oldValue:t};this._scrollTopRow=e,this.chartModel.frozen("row",e),this.dispatch("FrozenChanged",n)}),(function(e){return e>=0})),this._cellRangeInflate=xF,arguments.length<2||!n||!t)throw new Error("Worksheet not assign an _id_");this.initContainerAndServices(o),this.initSheetWatchHub(),this.parent=o,this._id_=t,this._id=e._ID++,this._version=e.latestVersion,this.options=xd(BF,(function(e,t,n){r._onOptionChanged(e,t,n)})),this._init(n,a),this.chartModel=new tE(this),this.rangeModel=new mb(this),this.floatImageModel=new gb(this),this.floatBlocksModel=new ib(this),this.embeddedBlocksModel=new iE(this),this._delTime="",this.conditionalFormatModel=new Qb(this),this.selectionType=1,Object.assign(this.defaults,this.parent?this.parent.defaults:{}),this._initStyle()}return(0,C.Z)(e,[{key:"initContainerAndServices",value:function(e){var t=this;return this.sheetIOC=mI({getSheetDataModel:function(){return function(){return t._getModel()}},getWatch:function(){return t.$watcher},getFilterWatchHub:function(){return t.filterWatchHub},getSheet:function(){return t},getI18n:function(){return fn.bind(we.Ps3)},getCalcEngine:this.getCalcEngine.bind(this),getStageTracker:function(){return we.vRF},getMoirae:function(){return we.Ps3.moirae}}),e.bindWorksheetIOCService(this.sheetIOC),this.inject=this.sheetIOC.get.bind(this.sheetIOC),this.dataValidationService=this.sheetIOC.get(uA),this.sheetFilterModel=this.sheetIOC.get(SE),this.viewsModel=this.sheetIOC.get(gT),this.outlineGroupModel=this.sheetIOC.get(uu),this.protectionModel=this.sheetIOC.get(KI),this.sheetIOC}},{key:"isHiddenByOutlineGroup",value:function(e,t){return this.outlineGroupModel.isRowColHidden("row"===e?we.xj7.ROW:we.xj7.COL,t)}},{key:"subscribe",value:function(e,t){return this.$watcher.subscribe(e,t)}},{key:"subscribePropagation",value:function(e){return this.$watcher.subscribe(we.MSA,e)}},{key:"dispatch",value:function(e,t,n){this.$watcher.dispatch(e,t,n),this.$watcher.dispatch(we.MSA,{type:e,props:t,$sheet:this,source:n})}},{key:"iterCell",value:function(e,t,n,r){return this._dataModel.iterCell(e,t,n,r)}},{key:"iterDataValidationWithPos",value:function(e,t,n,r){return this._getModel().iterDataValidationWithPos(e,t,n,r)}},{key:"iterSparklineWithPos",value:function(e,t,n,r){return this._getModel().iterSparklineWithPos(e,t,n,r)}},{key:"iterDropdownWithPos",value:function(e,t,n,r){return this._getModel().iterDropdownWithPos(e,t,n,r)}},{key:"getSparklineGroupByGroupId",value:function(e){return this._getModel().getSparklineGroupByGroupId(e)}},{key:"getSparklineGroupBySparklineId",value:function(e){return this._getModel().getSparklineGroupBySparklineId(e)}},{key:"getSparklineConfigByGroupId",value:function(e){var t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];return this._getModel().getSparklineConfigByGroupId(e,t)}},{key:"getSparklineById",value:function(e){return this._getModel().getSparklineById(e)}},{key:"getSparklinesByGroupId",value:function(e){return this._getModel().getSparklinesByGroupId(e)}},{key:"getSparklineByCell",value:function(e,t){return this._getModel().getSparklineByCell(e,t)}},{key:"getSparklineModel",value:function(){return this._getModel().sparklineModel}},{key:"iterVisibleRow",value:function(e,t,n){return this._getRowInfos().iterEachActualVisible(e,t,n)}},{key:"iterVisibleCol",value:function(e,t,n){return this._getColInfos().iterEachActualVisible(e,t,n)}},{key:"getIsCellVisible",value:function(e,t){return this.filterModel.isVisible(e)&&this.getRowVisible(e)&&this.getColumnVisible(t)}},{key:"setSelectionType",value:function(e){if(e!==this.selectionType){var t=this.getSelections();this.selectionType=e,this._raiseSelectionChanged(t)}}},{key:"getIsSpanVisible",value:function(e){return null!=e&&!!this.cellModel.iterVisibleSpan(e.rowFrom(),e.colFrom(),e.rowTo(),e.colTo()).first_if((function(e){return!!e}))}},{key:"_onOptionChanged",value:function(e,t,n){}},{key:"id",value:function(e){return 0===arguments.length?(this._id_||(console.warn("Worksheet 没有 _id_ "),this._id_="1"),this._id_):(this._id_=e,this)}},{key:"name",value:function(e){var t=this;if(0===arguments.length)return t._name;if(!t._isValidSheetName(e))return t;t._setNameCore(e);var n=this.parent;return t.dispatch("Renamed",{sheet:t}),n&&n.calcEngine.recoverInvalidRefs(this),t}},{key:"getHiddenStatus",value:function(){return this._hidden}},{key:"setHidden",value:function(e){var t=this;return 0===arguments.length?this.getHiddenStatus():(t._setHiddenCore(e),e?this.dispatch("SheetHidden",{sheetId:t.id()}):this.dispatch("SheetVisible",{sheetId:t.id()}),t)}},{key:"_setNameCore",value:function(e){this._name=e}},{key:"_isRowFilterOut",value:function(e){return!this.filterModel.isVisible(e)}},{key:"_setHiddenCore",value:function(e){this._hidden=e}},{key:"isSoftDeleted",value:function(){return Boolean(this._delTime)}},{key:"setDelTime",value:function(e){this._delTime=e}},{key:"clearDelTime",value:function(){this._delTime=""}},{key:"version",value:function(e){return null!=e&&(this._version=e),this._version}},{key:"isRefCountValid",value:function(){return this.version()>=e.refCountValidVersion}},{key:"setToRefCountValidVersion",value:function(){this._version=e.refCountValidVersion}},{key:"visible",value:function(){return!this.getHiddenStatus()}},{key:"addRows",value:function(e,t,n){if(!(t<=0)){var r=this,a=DF(r);(e<0||e>a)&&(e=a);var o=this.inject(cE);this._getRowInfos().addItems(e,t),this._localRowInfos.addItems(e,t),this._getModel().addRows(e,t),r._rowHeaderModel.addRows(e,t);var i=r._getSpanModel(2);i.addRows(e,t),(i=r._getSpanModel()).addRows(e,t),o.actionEventBus$.next({type:"addRows",row:e,count:t}),r.chartModel.addRows(e,t),r.rangeModel.addRows(e,t),r.floatImageModel.addRows(e,t),r.protectionModel.adjustProtectionRange("row","add",e,t),r.floatBlocksModel.addRows(e,t),r.embeddedBlocksModel.addRows(e,t,n);var u=new Wi(!0,"add",e,t,this);this.getParent().watchHubsOnRefOp(u);this.updateFreezeWhenLayoutChanged({changeType:0,row:e,oldValue:a,rowCount:t})}}},{key:"initSheetWatchHub",value:function(){this._filterWatchHub.setRefOpHandler("MoveRangeOp",(function(e,t){var n=t.srcRange(),r=t.targetRange();n.sheet()===r.sheet()&&(e.onOp(t),e.$&&e.$.next(e))}))}},{key:"deleteRows",value:function(e,t,n){var r=DF(this);if(!(0>e||e>=r||t<=0)){var a=this.inject(cE),o=this.getColumnCount();this.unRegisterFmlByRange(e,0,t,o);var i=new Wi(!0,"delete",e,t,this);this.getParent().watchHubsOnRefOp(i),this._localRowInfos.deleteItems(e,t),this._getRowInfos().deleteItems(e,t),this._getModel().deleteRows(e,t),this._rowHeaderModel.deleteRows(e,t);var u=this._getSpanModel(2);u.removeRows(e,t),(u=this._getSpanModel()).removeRows(e,t),a.actionEventBus$.next({type:"deleteRows",row:e,count:t}),this.chartModel.removeRows(e,t),this.rangeModel.delRows(e,t),this.floatImageModel.removeRows(e,t),this.protectionModel.adjustProtectionRange("row","del",e,t),this.floatBlocksModel.removeRows(e,t),this.embeddedBlocksModel.removeRows(e,t);var s=r;this.getActiveRowIndex()>=s&&this.setActiveCell(s-1,this.getActiveColumnIndex());this.updateFreezeWhenLayoutChanged({changeType:1,row:e,oldValue:r,rowCount:t})}}},{key:"addColumns",value:function(e,t,n){if(!(t<=0)){var r=this,a=ZF(r);(e<0||e>a)&&(e=a),r._getColInfos().addItems(e,t),this._localColInfos.addItems(e,t),r._getModel().addColumns(e,t),r._colHeaderModel.addColumns(e,t);var o=r._getSpanModel(1);o.addColumns(e,t),(o=r._getSpanModel()).addColumns(e,t),r.chartModel.addColumns(e,t),r.rangeModel.addCols(e,t),r.floatImageModel.addColumns(e,t),r.protectionModel.adjustProtectionRange("col","add",e,t),r.floatBlocksModel.addColumns(e,t),r.embeddedBlocksModel.addColumns(e,t,n);var i=new Wi(!1,"add",e,t,this);this.getParent().watchHubsOnRefOp(i);this.updateFreezeWhenLayoutChanged({changeType:0,col:e,oldValue:a,colCount:t})}}},{key:"getCalcEngine",value:function(){return this.getParent().getCalcEngine()}},{key:"deleteColumns",value:function(e,t,n){var r=this,a=ZF(r);if(!(0>e||e>=a||t<=0)){this.inject(cE).actionEventBus$.next({type:"deleteCols",col:e,count:t});var o=this.getRowCount();this.unRegisterFmlByRange(0,e,o,t);var i=new Wi(!1,"delete",e,t,this);this.getParent().watchHubsOnRefOp(i),this._localColInfos.deleteItems(e,t),r._getColInfos().deleteItems(e,t),r._getModel().deleteColumns(e,t),r._colHeaderModel.deleteColumns(e,t);var u=r._getSpanModel(1);u.removeColumns(e,t),(u=r._getSpanModel()).removeColumns(e,t),r.chartModel.removeColumns(e,t),r.rangeModel.delCols(e,t),r.floatImageModel.removeColumns(e,t),r.protectionModel.adjustProtectionRange("col","del",e,t),r.floatBlocksModel.removeColumns(e,t),r.embeddedBlocksModel.removeColumns(e,t);var s=a;r.getActiveColumnIndex()>=s&&r.setActiveCell(r.getActiveRowIndex(),s-1);this.updateFreezeWhenLayoutChanged({changeType:1,col:e,oldValue:a,colCount:t})}}},{key:"setCopySheetFloatBlocks",value:function(e){this._copySheetFloatBlocks=e}},{key:"getCopySheetFloatBlocks",value:function(){return this._copySheetFloatBlocks}},{key:"clearCopySheetFloatBlocks",value:function(){this._copySheetFloatBlocks=null}},{key:"setCopySheetEmbeddedBlocks",value:function(e){this._copySheetEmbeddedBlocks=e}},{key:"getCopySheetEmbeddedBlocks",value:function(){return this._copySheetEmbeddedBlocks}},{key:"clearCopySheetEmbeddedBlocks",value:function(){this._copySheetEmbeddedBlocks=null}},{key:"_setFloatBlock",value:function(e,t,n){return this.floatBlocksModel.setBlock(e,t,n)}},{key:"_delFloatBlock",value:function(e){return this.floatBlocksModel.delBlock(e)}},{key:"getFloatBlockByToken",value:function(e){return this.floatBlocksModel.getBlock(e)}},{key:"getFloatBlocksMap",value:function(){return this.floatBlocksModel.getFloatBlocksMap()}},{key:"_setEmbeddedBlock",value:function(e,t,n){return this.embeddedBlocksModel.setBlock(e,t,n)}},{key:"_delEmbeddedBlock",value:function(e){return this.embeddedBlocksModel.delBlock(e)}},{key:"getEmbeddedBlockByToken",value:function(e){return this.embeddedBlocksModel.getBlock(e)}},{key:"getEmbeddedBlocksMap",value:function(){return this.embeddedBlocksModel.getBlocksMap()}},{key:"_setDataRange",value:function(e){return this.rangeModel.setRange(e)}},{key:"_delDataRange",value:function(e){return this.rangeModel.delRange(e)}},{key:"_addChart",value:function(e,t){return this.chartModel.addChart(e,t)}},{key:"_setChart",value:function(e,t,n){return this.chartModel.setChart(e,t,n)}},{key:"_deleteChart",value:function(e){return this.chartModel.deleteChart(e)}},{key:"getChartById",value:function(e){return this.chartModel.getChartById(e)}},{key:"getChartMap",value:function(){return this.chartModel.getChartMap()}},{key:"getCellNoteJSON",value:function(e,t){return this._dataModel.getCellNoteJSON(e,t)}},{key:"_getCellNote",value:function(e,t){return this._dataModel.getCellNote(e,t)}},{key:"_setCellNote",value:function(e,t,n){return this._dataModel.setCellNote(e,t,n||null)}},{key:"getFloatImageMap",value:function(){return this.floatImageModel.getFloatImageMap()}},{key:"_addFloatImage",value:function(e,t){return this.floatImageModel.add(e,t)}},{key:"_setFloatImage",value:function(e,t,n){return this.floatImageModel.set(e,t,n)}},{key:"_deleteFloatImage",value:function(e){return this.floatImageModel.del(e)}},{key:"getFloatImageById",value:function(e){return this.floatImageModel.getFloatImageById(e)}},{key:"getAtiveFloatImageIds",value:function(){return this.floatImageModel.activeFloatImageIds}},{key:"protectionRangesToRanges",value:function(e){var t=this.getRowCount(),n=this.getColumnCount();return e.map((function(e){return function(e,t,n){return yi(e)?new Oi(e.rowFrom(),0,e.rowCount(),n,e.sheet()):Ci(e)?new Oi(0,e.colFrom(),t,e.colCount(),e.sheet()):e}(e,t,n)}))}},{key:"getPermissionDeniedRangeList",value:function(e){var t,n=(null===(t=this.protectionModel)||void 0===t?void 0:t.getProtectionRangesByRange(e,"denied"))||[];return this.protectionRangesToRanges(n)}},{key:"getPermissionAllowedRangeList",value:function(e){var t,n=this.parent.permissionManager.hasPermission(this.id())&&(null===(t=this.protectionModel)||void 0===t?void 0:t.getProtectionRangesByRange(e,"allowed"))||[];return this.protectionRangesToRanges(n)}},{key:"_addConditionalFormat",value:function(e,t){this.conditionalFormatModel.addRule(e,t)}},{key:"_addConditionalFormatV2",value:function(e){this.conditionalFormatModel.addRuleV2(e)}},{key:"_setConditionalFormat",value:function(e,t){this.conditionalFormatModel.setRule(e,t)}},{key:"_deleteConditionalFormat",value:function(e){this.conditionalFormatModel.deleteRule(e)}},{key:"_moveConditionalFormat",value:function(e){this.conditionalFormatModel.moveRule(e)}},{key:"getFrozenColumnCount",value:function(){return this.frozenColumnCount()}},{key:"getFrozenRowCount",value:function(){return this.frozenRowCount()}},{key:"getRowCount",value:function(){var e;return null===(e=this._dataModel)||void 0===e?void 0:e.getRowCount()}},{key:"getColumnCount",value:function(){var e;return null===(e=this._dataModel)||void 0===e?void 0:e.getColumnCount()}},{key:"setRowCount",value:function(e){if(!isNaN(e)&&!(e<0||e===this.getRowCount())){var t=this._getModel(),n=this._getRowInfos();t.setRowCount(e),n.length=e,this._getLocalRowInfos().length=e,this._activeRowIndex>=e&&this.setActiveCell(e-1,this.getActiveColumnIndex())}}},{key:"setColumnCount",value:function(e){if(!isNaN(e)&&!(e<0||e===this.getColumnCount())){var t=this._getModel(),n=this._getColInfos();t.setColumnCount(e),n.length=e,this._getLocalColInfos().length=e,this._activeColIndex>=e&&this.setActiveCell(this.getActiveRowIndex(),e-1)}}},{key:"getInternationalText",value:function(e,t){var n=this.getSegmentArray(e,t);return Pv(n)?function(e){return["name","en_name"].map((function(t){return e.reduce((function(e,n){return e+(Dv(n)?"@"+n[t]:n.text)}),"")}))}(n):this.getText(e,t)}},{key:"getTextByTextWithValues",value:function(e){return e.map((function(e){return e.text})).join(fm)}},{key:"getText",value:function(e,t,n,r,a,o){if(this.options.showFormulaText&&this.hasFormula(e,t))return"=".concat(this.getFormula(e,t));var i=this.getDataValidation(e,t),u=Boolean(i&&Mm(i)),s=this.getTextWithValues(e,t,u,a,o);return this.getTextByTextWithValues(s)}},{key:"getTextWithValues",value:function(e,t,n,r,a){var o=this.getImmutableContent(e,t,r,a);if(null==o)return[];var i=o.multipleValues,u=o.segmentArray;if(i){if(n)return function(e,t,n,r){for(var a=[],o=e.getUserFormatter(t,n),i=0;i<r.length;++i){var u=r.get(i),s=u.segmentArray,l=u.variant,c=u.autoFormatter,h=Yg(e.parent,{segmentArray:s,variant:l},{formatter:o||c||null});a.push({text:h,variant:l||null,segmentArray:s||null})}return a}(this,e,t,i);var s=this.getUserFormatter(e,t)||null;return[Kg(this,e,t,i.mergeToSingleValue({formatter:s}),r)]}if(u)return[{text:new xv(this.parent,u).getText(this.parent.userLanguage),variant:null,segmentArray:u}];var l=this.getValue(e,t,void 0,r,a);if(null==l)return[];var c="",h=this.getActualFormatter(e,t,r);return c=h instanceof Se.Formatter?h.format(l):(0,Se.createFormatter)(this.formatterService).format(l),(0,Se.isString)(c)?c=c.replace(/\r\n?/g,"\n"):console.error("should be text",c),[{text:c,variant:o.variant||null,segmentArray:null}]}},{key:"formatSheetValue",value:function(e,t,n,r){var a;return a=r instanceof Se.Formatter?r.format(n):(0,Se.createFormatter)(this.formatterService).format(n),(0,Se.isString)(a)||console.error("should be text",a),a}},{key:"getDefaultReminderFormatter",value:function(){if(!this._defaultReminderFormatter){var e=fn("sheet.format_code.date_time"),t=(0,Se.createFormatter)(this.formatterService,e&&"sheet.format_code.date_time"!==e?e:"yyyy/MM/dd HH:mm:ss");this._defaultReminderFormatter=t}return this._defaultReminderFormatter}},{key:"getUserFormatter",value:function(e,t){return this.getStyle(e,t).formatter}},{key:"getCellFormatter",value:function(e,t){return bF(this.getStyle(e,t))}},{key:"setText",value:function(e,t,n){var r=this,a=n,o={value:n,sheet:this};if(ca(o.value)){var i=(0,Se.getPreferredFormatter)(o.sheet.formatterService,o.value),u=i.value;u instanceof ke.SheetDate&&(u=u.toNumber()),"number"==typeof u&&(o.value=u)}var s=n=o.value,l=r.getActualFormatter&&r.getActualFormatter(e,t);if(l instanceof Se.Formatter){var c=l.getFormatCode();c&&(s=Mn(s=r.parseText(a,c))?n:s)}r.setValue(e,t,s)}},{key:"parseText",value:function(e,t){var n=Mn(t),r=Mn(e);if(!n&&!r){var a=(0,Se.getPreferredFormatter)(this.formatterService,e,(0,Se.createFormatter)(this.formatterService,t)).value;return a instanceof ke.SheetDate&&(a=a.toNumber()),a}return r?"":e.toString()}},{key:"getSegmentArray",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:3;return 3===n?this._getModel().getSegmentArray(e,t):null}},{key:"getImmutableSegmentArray",value:function(e,t){return this._getModel().getImmutableSegmentArray(e,t)}},{key:"getMultipleValues",value:function(e,t){return this._getModel().getMultipleValues(e,t)}},{key:"getMultipleValuesJSON",value:function(e,t){var n=this._getModel().getMultipleValues(e,t);return n?n.toJSON():null}},{key:"getFormulaHyperLink",value:function(e,t){return Cp(this._getModel().getImmutableContent(e,t))}},{key:"hasInternationalUserMention",value:function(e,t){return Pv(this.getSegmentArray(e,t))}},{key:"getValue",value:function(e,t,n,r,a,o){if(0===n)return null;var i=this._getModel().getValue(e,t,r,o);return"number"==typeof i&&(i=ar._parseFloat(i)),i}},{key:"getRowValue",value:function(e){return e+1}},{key:"getColValue",value:function(e){return this._indexToLetters(e+1)}},{key:"getSafeValue",value:function(e,t,n){var r=this._getModel(),a=r.getImmutableContent(e,t,n);if(!a)return null;if(a.multipleValues){var o=a.multipleValues.mergeToSingleValue({formatter:this.getUserFormatter(e,t)||null}),i=o.segmentArray,u=o.variant;return i?xv.getSegmentArray4Changeset(i):u?u.getValue():null}return a.segmentArray?xv.getSegmentArray4Changeset(a.segmentArray):a.variant?r.getValue(e,t,void 0,n):null}},{key:"getChangesetValue",value:function(e,t,n){return this.isProxyArrayFormula(e,t,n)?null:this.getSafeValue(e,t,!0)}},{key:"getRangeDatas",value:function(e){for(var t=e.row,n=e.col,r=e.rowCount,a=e.colCount,o=[],i=t;i<t+r;i++){for(var u=[],s=n;s<n+a;s++)u.push(this.getPointValue(i,s));o.push(u)}return o}},{key:"getVisibleRangeDatas",value:function(e){for(var t=this.getHiddenRows(),n=this.getHiddenCols(),r=e.row,a=e.col,o=e.rowCount,i=e.colCount,u=[],s=r;s<r+o;s++)if(!t[s]){for(var l=[],c=a;c<a+i;c++)n[c]||l.push(this.getPointValue(s,c));l.length&&u.push(l)}return u.length?u:null}},{key:"isHiddenRange",value:function(e){if(e.type===we.xj7.ALL||e.type===we.xj7.INVALID)return!1;for(var t=e.row,n=void 0===t?0:t,r=e.col,a=void 0===r?0:r,o=e.rowCount,i=void 0===o?this.getRowCount():o,u=e.colCount,s=void 0===u?this.getColumnCount():u,l=this.getHiddenRows(),c=this.getHiddenCols(),h=n;h<n+i;h++)for(var f=a;f<a+s;f++)if(!l[h]&&!c[f])return!1;return!0}},{key:"getPointValue",value:function(e,t){var n=this.getActualFormatter(e,t)||(0,Se.createFormatter)(this.formatterService),r=0,a=am(sm(this.parent,n.getFormatCode()));return a?r=a.type:(0,Se.isDateTimeFormatter)(n)&&(r=5),{value:this.getValue(e,t),text:this.getText(e,t),type:r,row:e,col:t,sheetId:this.id()}}},{key:"getAllReminders",value:function(){return this._dataModel.getAllReminders()}},{key:"getReminder",value:function(e,t){return this._dataModel.getReminder(e,t)}},{key:"getReminderJSON",value:function(e,t){var n=this._getModel().getReminder(e,t);return n?n.toJSON():null}},{key:"getReminderChangeset",value:function(e,t){var n=this.getReminder(e,t);return n&&n.toChangeset()||null}},{key:"_setReminder",value:function(e,t,n){this._dataModel.setReminder(e,t,n)}},{key:"getReminderCount",value:function(){return this._dataModel.getReminderCount()}},{key:"iterReminder",value:function(e,t,n,r){return this._dataModel.iterReminder(e,t,n,r)}},{key:"getColHeaderWidth",value:function(){return this.lastRowHeaderWidth||this._getSheetRowHeaderWidth()}},{key:"getRowHeaderHeight",value:function(){return this._getSheetColHeaderHeight()}},{key:"getActualFormatter",value:function(e,t,n,r){return AF(this.getReminder(e,t),this.getCellStyle(e,t),this.getImmutableContent(e,t,n),this,r,n)}},{key:"getReminderFormatter",value:function(e,t){return IF(this.getStyle(e,t),this)}},{key:"getCellHAlign",value:function(e,t,n){if(n||(n=this.getImmutableStyle(e,t)),this.options.showFormulaText&&this.hasFormula(e,t))return we.KqL.Left;var r=n.hAlign;if(!(0,ae.Z)(r)&&r!==we.KqL.General)return r;var a=this.getDataValidation(e,t);if(a){var o=this.getDataValidationHorizontalAlign(a,e,t);if(o)return o}return this.getReminder(e,t)?we.KqL.Left:n.toFasterHAlign(this._dataModel.getVar(e,t))}},{key:"hitViewPortOrHeader",value:function(e){return 2===e||1===e||3===e}},{key:"getActualStyle",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:3,r=arguments.length>3?arguments[3]:void 0;if(!this.hitViewPortOrHeader(n))return new Ad;if(-1===e&&-1===t)return this.getDefaultStyle(n);var a=this._getModel().getStyle(e,t,r);return this._getCompositeStyle(e,t,n,a)}},{key:"getActualStylePure",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:3,r=arguments.length>3?arguments[3]:void 0;return 0===n||-1===e&&-1===t?null:this._getModel().getStyle(e,t,r)}},{key:"getStyleWithConditionalFormat",value:function(e,t){var n=this.getActualStyle(e,t);return this.updateConditionFormatStyle(e,t,n)}},{key:"updateConditionFormatStyle",value:function(e,t,n){if(this.conditionalFormatModel&&this.conditionalFormatModel.hasRules()){var r=this.conditionalFormatModel.getCellStyle(e,t);if(r&&this.conditionalFormatModel.isConditionalFormatStyle(r)){var a,o,i={};if(r.font){var u={};r.font.includes("italic")&&(u.fontStyle="italic"),r.font.includes("bold")&&(u.fontWeight=700),i.fontInfo=u}r.foreColor&&(i.foreColor=r.foreColor),r.backColor&&(i.backColor=r.backColor),r.textDecoration&&(i.textDecoration=(null!==(a=r.textDecoration)&&void 0!==a?a:we.aBM.none)|(null!==(o=null==n?void 0:n.textDecoration)&&void 0!==o?o:we.aBM.none));var s=n||this.getDefaultStyle();return Ad.withUpdateStyle(s,i)}}return n}},{key:"getStyleWithDropdownAndConditionalFormat",value:function(e,t){var n=this.getDropdown(e,t),r=this.getStyleWithConditionalFormat(e,t);return n||r?(r=r||this.getDefaultStyle(),r=n&&n.list?Ad.withDropdown(r,n):Ad.withDropdown(r,void 0,!0)):null}},{key:"_getStyleProperty",value:function(e,t,n,r){var a=this.getActualStyle(e,t,r)[n];return"locked"===n&&!!Mn(a)||a}},{key:"getStyle",value:function(e,t,n,r){return this._getStyleImp(e,t,n,r)||this.getDefaultStyle().clone()}},{key:"getPureStyle",value:function(e,t,n,r){return this._getStyleImp(e,t,n,r)}},{key:"getCellStyle",value:function(e,t,n,r){if(0!==n){var a=this._getModel().getCellStyle(e,t,r);if(!Mn(a))return a}return null}},{key:"getActiveCellStyle",value:function(){var e=this.getActiveCellIndex(),t=e.row,n=e.column;return this.getStyle(t,n)}},{key:"getStyleWithoutPartialStyle",value:function(e,t){return this._getModel().getStyleWithoutPartialStyle(e,t)||this.getDefaultStyle().clone()}},{key:"getImmutableStyle",value:function(e,t,n){return this._getStyleImp(e,t,3,n)||this.getDefaultStyle(3)}},{key:"_getStyleImp",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:3,r=arguments.length>3?arguments[3]:void 0;if(0!==n){var a=this._getModel().getStyle(e,t,r);if(!Mn(a))return a}return null}},{key:"setStyle",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;this._dataModel.setStyle(e,t,n)}},{key:"getDataValidationId",value:function(e,t){return this.dataValidationService.getDataValidationId(e,t)}},{key:"getDataValidation",value:function(e,t){return this.dataValidationService.getDataValidation(e,t)}},{key:"getDataValidationJSON",value:function(e,t,n,r){return this.dataValidationService.getDataValidationJSON(e,t,n,r)}},{key:"getValidationRefCount",value:function(){return this._getModel().getValidationRefCount()}},{key:"setDataValidation",value:function(e,t,n){var r=this._getModel();null!=n&&this.setDropdown(e,t,null),r.setDataValidation(e,t,n)}},{key:"hasCheckbox",value:function(e,t){return this.dataValidationService.hasCheckbox(e,t)}},{key:"iterDataValidation",value:function(e,t,n,r){return this._getModel().iterDataValidation(e,t,n,r)}},{key:"getDropdown",value:function(e,t){return this._getModel().getDropdown(e,t)}},{key:"iterDropdown",value:function(e,t,n,r){return this._getModel().iterDropdown(e,t,n,r)}},{key:"iterStyle",value:function(e,t,n,r){return this._getModel().iterStyle(e,t,n,r)}},{key:"iterStyleWithPos",value:function(e,t,n,r){return this._getModel().iterStyleWithPos(e,t,n,r)}},{key:"hasContent",value:function(e,t){return this._getModel().hasContent(e,t)}},{key:"hasMultipleValues",value:function(e,t){return this._getModel().hasMultipleValues(e,t)}},{key:"getStyleWithDropdown",value:function(e,t,n){var r=this.getDropdown(e,t),a=this.getStyle(e,t,void 0,n);return r||a?(a=a||this.getDefaultStyle(),a=r&&r.list?Ad.withDropdown(a,r,!0):Ad.withDropdown(a,void 0,!0)):null}},{key:"setDropdown",value:function(e,t,n){if(!(e<0||t<0)){var r=this._getModel();null!=n&&this.setDataValidation(e,t,null),r.setDropdown(e,t,n),this.chartModel.setValue(e,t),this._raiseCellChanged()}}},{key:"_setStyleWithoutLocked",value:function(e,t,n,r){this.setStyle(e,t,n)}},{key:"_getStyleObject",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:3,r=null;return 0!==n&&(r=this._getModel().getStyle(e,t)),r}},{key:"setStyleById",value:function(e,t,n){var r=this._getModel(),a=DF(r),o=ZF(r);e<-1||e>=a||t<-1||t>=o||r.setStyleById(e,t,n)}},{key:"setDataValidationById",value:function(e,t,n){var r=this._getModel(),a=DF(r),o=ZF(r);e<-1||e>=a||t<-1||t>=o||r.setDataValidationById(e,t,n)}},{key:"getRangeByRowCol",value:function(e,t){return-1===e&&-1===t?new Ni(this):-1===e?new Vi(t,1,this):-1===t?new xi(e,1,this):new Oi(e,t,1,1,this)}},{key:"getDefaultStyle",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:3,t=this,n=t._composedDefaultStyle,r=n[e];if(r)return r;var a=t._getModel(),o=a.getDefaultStyle();return o||(o=Md(),a.setDefaultStyle(o)),n[e]=o,o}},{key:"setDefaultStyle",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:3,n=this;0!==t&&n._getModel().setDefaultStyle(Object.freeze(e)),n._composedDefaultStyle[t]=null}},{key:"getCellPadding",value:function(){return this.defaults.cellPadding||e._defaultCellPadding}},{key:"getLineHeightFactor",value:function(){return this.defaults.lineHeightFactor||1.5}},{key:"getInlineAlign",value:function(){return"boolean"!=typeof this.defaults.inlineAlign||this.defaults.inlineAlign}},{key:"getDataValidationHorizontalAlign",value:function(e,t,n){return"checkbox"===e.type&&e.checkCellValid(t,n).getValue()?we.KqL.Center:null}},{key:"_getCompositeStyle",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:3,r=arguments.length>3?arguments[3]:void 0,a=arguments.length>4?arguments[4]:void 0,o=this;if(!this.hitViewPortOrHeader(n))return Ad.EMPTY;var i=o._getModel(),u=DF(i),s=ZF(i),l=o.getDefaultStyle(n);if(0<=e&&e<u&&0<=t&&t<s){var c=void 0!==r?r:i.getStyle(e,t,a);if(c)return Ad.composeStyles(l,c)}return l}},{key:"_addSpanImp",value:function(e,t,n,r){var a=arguments.length>4&&void 0!==arguments[4]?arguments[4]:3,o=this,i=o._getSpanModel(a),u=new Oi(e,t,n,r,o);if(u.rowCount()*u.colCount()<=1)return!1;var s=u;if(i.addSpan(s),3===a){var l=o._selectionModel;if(l){for(var c=this.getSelections(),h=0;h<c.length;h++)c[h].isIntersect(new Oi(e,t,n,r,o))&&(c[h]=c[h].union(u));l.fromArray(c)}}return!0}},{key:"addSpan",value:function(e,t,n,r,a){if(!(1===n&&1===r||void 0!==a&&!this.hitViewPortOrHeader(a))){var o=this._getSpanModel(a),i=o.getIntersectSpansInfo(e,t,n,r);if(i.hasPartSpans.size>0)return console.error("Invalid Span ".concat(e," ").concat(t," ").concat(n," ").concat(r)),void console.error("SpanModel ".concat(JSON.stringify(o)));i.containedSpans.forEach((function(e){o.remove(e)})),this._addSpanImp(e,t,n,r,a)}}},{key:"spansFromJSON",value:function(e){this._getSpanModel().fromJSON(e)}},{key:"clearSpans",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:3;return this._getSpanModel(t).clearAll(e)}},{key:"removeSpan",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:3,r=this._getSpanModel(n),a=r.find(e,t);a&&r.remove(a)}},{key:"hasSpans",value:function(e,t,n,r){return this._getSpanModel().hasSpans(e,t,n,r)}},{key:"getSpans",value:function(e,t,n){return void 0===t||this.hitViewPortOrHeader(t)?this._getSpanModel(t).getSpans(e,n):[]}},{key:"getSpan",value:function(e,t,n){return void 0===n||this.hitViewPortOrHeader(n)?this._getSpanModel(n).find(e,t):null}},{key:"setEmptyPivotTableSpan",value:function(e){this.removeSpan(e.rowFrom(),e.colFrom()),this._getSpanModel().addSpan(e,!0)}},{key:"removeEmptyPivotTableSpan",value:function(e){this._getSpanModel().removePivotRange(e)}},{key:"_setActiveCellCore",value:function(e,t,n){var r,a,o=this._activeRowIndex,i=this._activeColIndex,u=!1;Mn(e)||(this._activeRowIndex=e,u=!0),Mn(t)||(this._activeColIndex=t,u=!0),n||(this._firstTabCol=void 0);var s=o!==e||i!==t,l=this._isFirstSetFocus;u&&(s||l)&&(l&&(this._isFirstSetFocus=!1),this.dispatch("ActiveCellChanged",{sheetId:this.id(),row:null!==(r=e)&&void 0!==r?r:0,col:null!==(a=t)&&void 0!==a?a:0}))}},{key:"_setActiveCellImp",value:function(e,t,n,r){var a=this,o=DF(a),i=ZF(a);if(e<0){e=0;for(var u=a._getSpanModel().get(e,t);u.rowCount()>1||u.colCount()>1;)e+=1,u=a._getSpanModel().get(e,t)}else e>=o&&(e=o-1);if(t<0){t=0;for(var s=a._getSpanModel().get(e,t);s.rowCount()>1||s.colCount()>1;)t+=1,s=a._getSpanModel().get(e,t)}else t>=i&&(t=i-1);var l=a._getSpanModel().get(e,t);a._activeRowCount=l.rowCount(),a._activeColCount=l.colCount(),a._activeRowViewportIndex=n,a._activeColViewportIndex=r,a._setActiveCellCore(l.rowFrom(),l.colFrom()),a._leadingCellRow=e,a._leadingCellCol=t}},{key:"setActiveCell",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},r=n.rowViewportIndex,a=n.colViewportIndex,o=n.source,i=n.clearSelection,u=void 0===i||i,s=n.setSelection,l=void 0===s||s,c=n.triggerEvent,h=void 0===c||c;if(this.parent.apiHookManager.getHooks(2).every((function(n){return n(e,t)}))){var f=this.getSelections();this._selectionModel&&this._setActiveCellAndSelection(e,t,{rowViewportIndex:r,colViewportIndex:a,source:o,clearSelection:u,setSelection:l});var d=this.getSelections();h&&this._raiseSelectionChanging(f,d)&&this._raiseSelectionChanged(f,o)}}},{key:"_setActiveCellAndSelection",value:function(e,t,n){var r=n.rowViewportIndex,a=n.colViewportIndex,o=n.source,i=n.clearSelection,u=void 0===i||i,s=n.setSelection,l=void 0===s||s,c=this,h=c.getSelections()[0],f=DF(c),d=ZF(c);if(e<0?e=0:e>=f&&(e=f-1),t<0?t=0:t>=d&&(t=d-1),u&&c._clearSelectionImp(),c._setActiveCellImp(e,t,r,a),l){var v=c._getSpanModel().get(e,t).clone();!h||"ADD_ROW"!==o&&"ADD_COL"!==o&&"DEL_ROW"!==o&&"DEL_COL"!==o||(v.setRowCount(h.rowCount()),v.setColCount(h.colCount())),c._setSelectedRange(v)}}},{key:"getActiveRowIndex",value:function(){return this._activeRowIndex}},{key:"getActiveColumnIndex",value:function(){return this._activeColIndex}},{key:"getActiveCellIndex",value:function(){return{row:this.getActiveRowIndex(),column:this.getActiveColumnIndex()}}},{key:"_setRowColInfo",value:function(e,t,n,r){var a,o=arguments.length>4&&void 0!==arguments[4]?arguments[4]:3,i=arguments.length>5&&void 0!==arguments[5]?arguments[5]:1,u=r?this._getRowInfos(o):this._getColInfos(o);switch(n){case"visible":a=u.getVisible(e),u.setVisible(e,t,i);break;case"height":case"width":a=u.getSize(e),u.setSize(e,t,i);break;case"fId":a=u.getFId(e),u.setFId(e,t)}return this.chartModel.setRowColInfoChange(e,r?"row":"col"),{value:t,oldValue:a}}},{key:"_getRowColInfo",value:function(e,t,n){var r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:3,a=n?this._getRowInfos(r):this._getColInfos(r);if("fId"===t)return a.getFId(e)}},{key:"getRowHeight",value:function(e){return!this.filterModel.isVisible(e)||this.isHiddenByOutlineGroup("row",e)?0:this._getRowInfos().getSize(e)}},{key:"getColWidth",value:function(e){return this.isHiddenByOutlineGroup("col",e)?0:this._getColInfos().getSize(e)}},{key:"getForceRowHeight",value:function(e){return!this.filterModel.isVisible(e)||this.isHiddenByOutlineGroup("row",e)?0:null}},{key:"getForceColWidth",value:function(e){return this.isHiddenByOutlineGroup("col",e)?0:null}},{key:"_getActualRowHeight",value:function(e,t){return this._rowInfos.getActualSize(e)}},{key:"needAutoRowHeight",value:function(e){return 0===this._rowInfos.getActualSize(e)}},{key:"setAutoRowHeight",value:function(e,t){var n=Math.max(t,this.defaults.rowHeight);return this._rowInfos.setAutoFitSize(e,n)}},{key:"setRowHeight",value:function(e,t,n){var r=arguments.length>3&&void 0!==arguments[3]&&arguments[3],a=arguments.length>4&&void 0!==arguments[4]?arguments[4]:1,o=this._setRowColInfo(e,t,"height",!0,n,a);return r&&this._localRowInfos.setSize(e,t,a),o}},{key:"setRowColProperty",value:function(e,t,n,r){var a=this;Object.keys(t).forEach((function(o){var i=t[o];a._setRowColInfo(e,i,o,n,r)}))}},{key:"getRowColProperty",value:function(e,t,n,r){return this._getRowColInfo(e,t,n,r)}},{key:"getRowVisible",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:3;return!(!t&&!this.filterModel.isVisible(e))&&!this.isHiddenByOutlineGroup("row",e)&&this._getRowInfos(n).getVisible(e)}},{key:"setRowVisible",value:function(e,t,n){var r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:1,a=this,o=a._setRowColInfo(e,t,"visible",!0,n,r);return a.chartModel.setRowColVisible(e,t,"row"),o}},{key:"getColVisible",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:3;return!this.isHiddenByOutlineGroup("col",e)&&this._getColInfos(t).getVisible(e)}},{key:"isRowOrColHidden",value:function(e,t){return!(t?this._getRowInfos():this._getColInfos()).getVisible(e)}},{key:"getCellWidth",value:function(e,t,n){if(!n)return this.getColumnWidth(t);var r=this.getSpan(e,t,3);if(!r||r.colCount()<=1)return this.getColumnWidth(t);for(var a=0,o=0;o<r.colCount();o++)a+=this.getColumnWidth(t+o);return a}},{key:"getCellHeight",value:function(e,t,n){if(!n)return this.getRowHeight(e);var r=this.getSpan(e,t,3);if(!r||r.rowCount()<=1)return this.getRowHeight(e);for(var a=0,o=0;o<r.rowCount();o++)a+=this.getRowHeight(e+o);return a}},{key:"getColumnWidth",value:function(e){return this._getColInfos().getSize(e)}},{key:"localRowHeightChanged",value:function(e,t){for(var n=e;n<e+t;n++)if(this._localRowInfos.getRawSize(n))return!0;return!1}},{key:"localColumnWidthChanged",value:function(e,t){for(var n=e;n<e+t;n++)if(this._localColInfos.getRawSize(n))return!0;return!1}},{key:"getRowByFId",value:function(e){return this._getRowInfos().getRowColIndexByFId(e)}},{key:"getColByFId",value:function(e){return this._getColInfos().getRowColIndexByFId(e)}},{key:"_getSheetRowHeaderWidth",value:function(){return this.defaults.rowHeaderColWidth}},{key:"_getSheetColHeaderHeight",value:function(){return this.defaults.colHeaderRowHeight}},{key:"_getActualColumnWidth",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:3,n=this.defaults,r=n.colWidth;2===t&&(r=n.rowHeaderColWidth);var a=this._getColInfos(t).getActualSize(e);return a||0===a?a:r}},{key:"setColumnWidth",value:function(e,t,n){var r=arguments.length>3&&void 0!==arguments[3]&&arguments[3],a=arguments.length>4&&void 0!==arguments[4]?arguments[4]:1,o=this._setRowColInfo(e,t,"width",!1,n,a);return r&&this._localColInfos.setSize(e,t,a),o}},{key:"getColumnVisible",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:3,n=this;return!n.isHiddenByOutlineGroup("col",e)&&n._getColInfos(t).getVisible(e)}},{key:"setColumnVisible",value:function(e,t,n){var r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:1,a=this,o=a._setRowColInfo(e,t,"visible",!1,n,r);return a.chartModel.setRowColVisible(e,t,"col"),o}},{key:"getViewportTopRow",value:function(e){var t=LF(this);return 0===e?0:1===e?Math.max(t,0):2===e?Math.max(t,DF(this)):-1}},{key:"getViewportLeftColumn",value:function(e){var t=PF(this);return 0===e?0:1===e?Math.max(t,0):2===e?Math.max(t,ZF(this)):-1}},{key:"_getRowViewportIndex",value:function(e){var t=1;return e<LF(this)?t=0:e>=DF(this)&&(t=2),t}},{key:"_getColumnViewportIndex",value:function(e){var t=1;return e<PF(this)?t=0:e>=ZF(this)&&(t=2),t}},{key:"suspendEvent",value:function(){this._eventSuspended++}},{key:"resumeEvent",value:function(){this._eventSuspended--,this._eventSuspended<0&&(this._eventSuspended=0)}},{key:"isEventSuspended",value:function(){return this._eventSuspended>0}},{key:"reset",value:function(){this._resetImp()}},{key:"getLogger",value:function(){return this.parent?this.parent.logger:console}},{key:"_resetImp",value:function(){var t,n=this;n._initializeActiveCell(),n._activeRowViewportIndex=0,n._activeColViewportIndex=0,n.defaults={rowHeight:e._defaultRowHeight,colWidth:e._defaultColWidth,rowHeaderColWidth:e._defaultRowHeaderColWidth,colHeaderRowHeight:e._defaultColHeaderRowHeight},n._initOptions(),n._scrollTopRow=0,n._scrollLeftCol=0,n.frozenRowCount(0),n.frozenColumnCount(0),n._composedDefaultStyle={},n._dataModel=t=new mS(e._defaultRowCount,e._defaultColCount,n),n._rowHeaderModel=new MF(t.getRowCount(),e._defaultRowHeaderColumnCount,n),n._colHeaderModel=new MF(e._defaultColHeaderRowCount,t.getColumnCount(),n),n._rowInfos=new GS((function(){return n.defaults.rowHeight}),e._defaultRowCount,(function(e){return n.getForceRowHeight(e)}),50),n._localRowInfos=new GS((function(){return n.defaults.rowHeight}),e._defaultRowCount,(function(e){return n.getForceRowHeight(e)}),50),n._colInfos=new GS((function(){return n.defaults.colWidth}),e._defaultColCount,(function(e){return n.getForceColWidth(e)}),120),n._localColInfos=new GS((function(){return n.defaults.colWidth}),e._defaultColCount,(function(e){return n.getForceColWidth(e)}),120),n._colHeaderRowInfos=new GS((function(){return n.defaults.colHeaderRowWidth}),n.defaults._defaultColHeaderRowCount,void 0,50),n._rowHeaderColInfos=new GS((function(){return n.defaults.rowHeaderColWidth}),n.defaults._defaultRowHeaderColumnCount,void 0,120),n._spanModel=new IS(n),n._colHeaderSpanModel=new IS(n),n._rowHeaderSpanModel=new IS(n),n.cellModel=new XS(n),n._eventSuspended=0,n._dirtySuspended=0,n._disposed=!1}},{key:"_initOptions",value:function(){var e=this;VF.each(BF,(function(t,n){if(!Mn(n)){var r=n;"object"==(0,_.Z)(r)&&(r=VF.extend({},n)),e.options[t]=r}}))}},{key:"_initStyle",value:function(){var e=this.getDefaultStyle(),t=e,n=!0;this.parent&&this.parent.defaultStyle?(n=!1,t=Ad.fromJSON(this.parent.formatterService,this.parent.defaultStyle,t)):this.defaults.style&&(n=!1,t=Ad.fromJSON(this.parent.formatterService,this.defaults.style)),n||(e.equals(t)||(t=Ad.composeStyles(e,t)),t.setDefault(t),this.setDefaultStyle(t))}},{key:"_onAttached",value:function(e){var t=this;t.parent=e,t._eventSuspended=e._eventSuspended||0,Object.assign(this.defaults,this.parent?this.parent.defaults:{}),t._initStyle()}},{key:"_canChange",value:function(e,t,n,r,a){var o=this;return!o.options.isProtected||!o._isAnyCellInRangeLocked(new Oi(e,t,n,r,o))||(a&&o._raiseInvalidOperation(1,a),!1)}},{key:"checkRangesProtected",value:function(e){var t=Array.isArray(e)?e:[e];return!this.protectionModel.getRangePermissions(t).hasPermission}},{key:"checkCellProtected",value:function(e,t){var n=this.getParent();return!(!n||!n.permissionManager||n.permissionManager.hasPermission(this.id()))||!this.protectionModel.getRangePermissions([new Oi(e,t,1,1,this)]).hasPermission}},{key:"isCellEditable",value:function(e,t){return!this.options.isProtected&&!this.checkCellProtected(e,t)}},{key:"checkRowProtected",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1;return!this.protectionModel.getRangePermissions([new xi(e,t,this)]).hasPermission}},{key:"checkColProtected",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1;return!this.protectionModel.getRangePermissions([new Vi(e,t,this)]).hasPermission}},{key:"setValue",value:function(e,t,n,r){var a=this._getModel(),o=this.getImmutableContent(e,t);return n instanceof dm?(a.setMultipleValues(e,t,n,null),void this.notifyValueChange(e,t,o)):Array.isArray(n)?(a.setSegmentArray(e,t,n,null),void this.notifyValueChange(e,t,o)):(a.setVar(e,t,n,r,null),void this.notifyValueChange(e,t,o))}},{key:"notifyValueChange",value:function(e,t,n){var r;this.chartModel.setValue(e,t);var a=(null==n?void 0:n.segmentArray)||null,o=(null===(r=this.getImmutableContent(e,t))||void 0===r?void 0:r.segmentArray)||null;(a||o)&&this._raiseSegmentChangedIgnoreSuspended(e,t,3,a,o),this.isEventSuspended()||this._raiseCellChanged()}},{key:"getFormula",value:function(e,t,n,r){return this._getModel().getFormula(e,t,n,r)}},{key:"getFormulaData",value:function(e,t,n,r,a){return this._getModel().getFormulaData(e,t,n,r,a)}},{key:"getImportRangeData",value:function(e,t,n){var r=this.getVar(e,t);if(!r.isFormula())return null;var a=this.getParent().importRangeManager;if(!th(r))return null;var o=a.getMetaFromFormula(r);return o?{importRangeId:o.importRangeId,spreadToken:o.spreadToken,ref:o.ref,isSyncStyle:!1,spreadSource:o.spreadSource}:null}},{key:"getHasFormulaByRange",value:function(e){var t=e.rowFrom(),n=e.rowCount(),r=e.colFrom(),a=e.colCount();return null!==this._getModel().iterContent(t,r,n,a).first_if((function(e){return!(!e.variant||!e.variant.isFormula())}))}},{key:"getHasFormulaOrArrayFormulaByRange",value:function(e){var t=e.rowFrom(),n=e.rowCount(),r=e.colFrom(),a=e.colCount();return null!==this._getModel().iterContent(t,r,n,a).first_if((function(e){return!(!e.variant||!e.variant.isFormula()&&!zf(e.variant))}))}},{key:"hasImportRangeByRange",value:function(e){for(var t=this.parent.importRangeManager.getImportRangeFormulas(),n=0;n<t.length;n++){var r=t[n];if(Wf(r)&&1===r.canArrayExpand().arrayFormulaCanExpand){var a=r.getArrayRef();if(a&&a.isIntersect(e))return!0}}return!1}},{key:"getHasAllKindFormulaByRange",value:function(e){return this.hasImportRangeByRange(e)||this.getHasFormulaOrArrayFormulaByRange(e)}},{key:"getFormulaCountByRange",value:function(e){var t=e.rowFrom(),n=e.rowCount(),r=e.colFrom(),a=e.colCount();return this._getModel().iterContent(t,r,n,a).reduce((function(e,t){return e.variant&&e.variant.isFormula()?t+1:t}),0)}},{key:"unRegisterFmlByRange",value:function(e,t,n,r){for(var a=this.getCalcEngine().formulaSpace,o=this._getModel().iterContent(e,t,n,r),i=o.next();null!==i;i=o.next())if(i){var u=i.variant;u&&u.isFormula()&&a.unRegisterFml(u)}}},{key:"hasFormula",value:function(e,t){if(void 0!==e&&void 0!==t){var n=this.getVar(e,t);return!!n&&n.isFormula()}for(var r=this.getRowCount(),a=this.getColumnCount(),o=0;o<r;o++)for(var i=0;i<a;i++){var u=this.getVar(o,i);if(u&&u.isFormula())return!0}return!1}},{key:"isArrayFormula",value:function(e,t){return this._getModel().isArrayFormula(e,t)}},{key:"isProxyArrayFormula",value:function(e,t,n){return this._getModel().isProxyArrayFormula(e,t,n)}},{key:"getImmutableContent",value:function(e,t,n,r){return this._dataModel.getImmutableContent(e,t)}},{key:"getVar",value:function(e,t,n){return this._dataModel.getVar(e,t,n)}},{key:"iterContent",value:function(e,t,n,r,a){return this._getModel().iterContent(e,t,n,r,a)}},{key:"iterContentWithPos",value:function(e,t,n,r,a){return this._getModel().iterContentWithPos(e,t,n,r,a)}},{key:"removeComposedStyleCache",value:function(e,t,n,r){this._dataModel.removeComposedStyleCache(e,t,n,r)}},{key:"getParent",value:function(){return this.parent}},{key:"suspendDirty",value:function(){this._dirtySuspended++,this._getModel()._dirtySuspended++}},{key:"resumeDirty",value:function(){var e=this,t=e._getModel();e._dirtySuspended--,t._dirtySuspended--,e._dirtySuspended<0&&(e._dirtySuspended=0,t._dirtySuspended=0)}},{key:"isDirtySuspended",value:function(){return this._dirtySuspended>0}},{key:"markSheetDirty",value:function(){var e=this,t=this.parent.getCalcEngine(),n=new Ni(this);t.markDirty([n],{isDirtyAlwaysCalc:!0,validator:{validateFn:function(t){var n;return t instanceof Kc&&!t.isDirty()&&!(null!==(n=e.parent.formulaCacheManager)&&void 0!==n&&n.isFormulaCached(t))},isValidateAll:!0}})}},{key:"_isValidSheetName",value:function(e){if(!e||""===e)return!1;var t,n;for(n=0;n<e.length;n++)if("*"===(t=e.charAt(n))||":"===t||"["===t||"]"===t||"?"===t||"\\"===t||"/"===t)return!1;var r=this.parent;if(!r)return!0;var a=r.sheets,o=a.length;for(n=0;n<o;n++){var i=a[n];if(i!==this&&e===i._name)return!1}return!0}},{key:"_init",value:function(e,t){this._name=e,this._hidden=t||!1,this._resetImp(),this._selectionModel=new FS(this)}},{key:"_dispose",value:function(e){var t,n=this.inject(cE),r=this,a=r.parent.options;r._firstTabCol=void 0,!1!==e?n.lifeCycle$.next({type:"destroy"}):n.lifeCycle$.next({type:"deactive"}),!1!==e&&(r._disposed=!0,r.$watcher.destroy(),r._disposeUserEvents(),r.sheetIOC.get(SE).destroy(),r.viewsModel.destroy(),r.conditionalFormatModel&&(r.conditionalFormatModel.destroy(),delete r.conditionalFormatModel),delete r.parent,this.getSparklineModel().getDataManager().dispose(),this._colHeaderModel.sparklineModel.getDataManager().dispose(),this._rowHeaderModel.sparklineModel.getDataManager().dispose(),delete r._dataModel,delete r._rowHeaderModel,delete r._colHeaderModel,delete r._rowInfos,delete r._colInfos,delete r._colHeaderRowInfos,delete r._rowHeaderColInfos,delete r._spanModel,delete r._colHeaderSpanModel,delete r._rowHeaderSpanModel,delete r.chartModel,delete r.rangeModel,delete r.floatImageModel,delete r.sheetFilterModel,delete r._dataModel,delete r.cellModel,r.protectionModel&&!a.remainUserPerms&&(r.protectionModel.destroy(),delete r.protectionModel),null!==(t=this._pivotTableManagerV2)&&void 0!==t&&t.dispose(),this._pivotTableManagerV2=void 0,this.sheetIOC.unbindAll())}},{key:"_getModel",value:function(){return this._dataModel}},{key:"_getRowInfos",value:function(e){return 1===e||0===e?this._colHeaderRowInfos:this._rowInfos}},{key:"_getColInfos",value:function(e){return 2===e||0===e?this._rowHeaderColInfos:this._colInfos}},{key:"_getLocalColInfos",value:function(){return this._localColInfos}},{key:"_getLocalRowInfos",value:function(){return this._localRowInfos}},{key:"resetPivotTableManager",value:function(){this._pivotTableManagerV2||(this._pivotTableManagerV2=this.inject(iI))}},{key:"getPivotTableManager",value:function(){return this.getPivotTableManagerV2()}},{key:"getPivotTableManagerV2",value:function(){return this._pivotTableManagerV2||(this._pivotTableManagerV2=this.inject(iI)),this._pivotTableManagerV2}},{key:"getHiddenCols",value:function(){var e=this.getHiddenSeries(this._colInfos),t=this.outlineGroupModel.colHiddenSet;return t&&t.forEach((function(t){return e[t]=!0})),e}},{key:"getHiddenRows",value:function(){var e=this.filterModel.hasFilter()&&this.filterModel.getAllFilteredOutRows(),t=this.getHiddenSeries(this._rowInfos);e&&e.forEach((function(e){return t[e]=!0}));var n=this.outlineGroupModel.rowHiddenSet;return n&&n.forEach((function(e){return t[e]=!0})),t}},{key:"getHiddenSeries",value:function(e){var t={};return e.iterHidden().forEach((function(e){for(var n=e.index,r=e.count,a=n;a<n+r;a++)t[a]=!0})),t}},{key:"updateExcludedRows",value:function(){this._getRowInfos().updateExcluded(this.getExcludedRows())}},{key:"updateExcludedCols",value:function(){this._getColInfos().updateExcluded(this.getExcludedCols())}},{key:"getVisibleRowCount",value:function(e,t){return this._getVisibleAxisCount(e,t,!0)}},{key:"getVisibleColCount",value:function(e,t){return this._getVisibleAxisCount(e,t,!1)}},{key:"getHiddenRowCount",value:function(){return this._getRowInfos().iterHidden().reduce((function(e,t){return t+e.count}),0)}},{key:"getHiddenColCount",value:function(){return this._getColInfos().iterHidden().reduce((function(e,t){return t+e.count}),0)}},{key:"getFirstVisibleCellIndex",value:function(){var e=this._getFirstVisualRow(),t=this._getFirstVisualColumn();return{row:null===e?0:e,col:null===t?0:t}}},{key:"getExcludedRows",value:function(){var e=this.filterModel.getAllFilteredOutRows(),t=this.outlineGroupModel.rowHiddenSet;return new Set([].concat((0,m.Z)(e),(0,m.Z)(t)))}},{key:"getExcludedCols",value:function(){return this.outlineGroupModel.colHiddenSet}},{key:"_getVisibleAxisCount",value:function(e,t,n){return(n?this._getRowInfos():this._getColInfos()).iter(e,t).reduce((function(e,t){return e.value>0?t+e.count:t}),0)}},{key:"_isActiveCell",value:function(e,t){var n=this;return n._activeRowIndex<=e&&e<n._activeRowIndex+n._activeRowCount&&n._activeColIndex<=t&&t<n._activeColIndex+n._activeColCount}},{key:"_isColumnSelected",value:function(e){var t=this._selectionModel;return!!t&&t._isColumnSelected(e)}},{key:"_isRowSelected",value:function(e){var t=this._selectionModel;return!!t&&t._isRowSelected(e)}},{key:"_isSelected",value:function(e,t,n,r){var a=this,o=a._selectionModel;if(!o)return!1;var i=DF(a),u=ZF(a);try{return o._isSelected(e,t,n,i,u,r)}catch(e){we.Ps3.moirae.ravenCatch(e),we.Ps3.collectSuiteEvent("deprecated_func_invoked",{func_name:"selectionModel._isSelected",message:e.message})}}},{key:"_isAllSelected",value:function(e,t,n){var r=this,a=r._selectionModel;if(!a)return!1;var o=DF(r),i=ZF(r);try{return a._isAllSelected(e,t,n,o,i)}catch(e){we.Ps3.moirae.ravenCatch(e),we.Ps3.collectSuiteEvent("deprecated_func_invoked",{func_name:"selectionModel._isAllSelected",message:e.message})}}},{key:"_indexToLetters",value:function(e){for(var t="A".charCodeAt(0),n="";e>0;e=parseInt(((e-1)/26).toString(),10),10){var r=(e-1)%26;n=String.fromCharCode(t+r)+n}return n}},{key:"_getElem",value:function(){return this._$elem||(this._$elem=VF(Nd("input"))),this._$elem}},{key:"_initializeActiveCell",value:function(){var e=this;e._activeRowIndex=0,e._activeColIndex=0,e._activeRowCount=1,e._activeColCount=1,e._leadingCellRow=0,e._leadingCellCol=0}},{key:"_getFirstVisibleAxisIndex",value:function(e,t,n){return(n?this._getRowInfos():this._getColInfos()).iterEachActualVisible(e,t).first()}},{key:"_getLastVisibleAxisIndex",value:function(e,t,n){return(n?this._getRowInfos():this._getColInfos()).iterEachActualVisible(e,t,!0).first()}},{key:"_getFirstVisualColumn",value:function(){var e=DF(this)-1;return this._getFirstVisibleAxisIndex(0,e,!1)}},{key:"_getNextVisualColumn",value:function(e){var t=ZF(this)-1;return this._getFirstVisibleAxisIndex(e+1,t,!1)}},{key:"_getPrevVisualColumn",value:function(e,t){var n=PF(this);return e>n?this._getLastVisibleAxisIndex(n,e-1,!1):null}},{key:"_getFirstVisualRow",value:function(){var e=DF(this)-1;return this._getFirstVisibleAxisIndex(0,e,!0)}},{key:"_getNextVisualRow",value:function(e){var t=DF(this)-1;return this._getFirstVisibleAxisIndex(e+1,t,!0)}},{key:"_getPrevVisualRow",value:function(e,t,n){var r=n?0:LF(this);return e>r?this._getLastVisibleAxisIndex(r,e-1,!0):null}},{key:"_getSpanModel",value:function(e){return Mn(e)||3===e?this._spanModel:1===e?this._colHeaderSpanModel:2===e?this._rowHeaderSpanModel:void 0}},{key:"_disposeUserEvents",value:function(){this.unbindAll(),this._unbindAll()}},{key:"_isAnyCellInRangeLocked",value:function(e){for(var t=e.rowFrom(),n=e.colFrom(),r=t+e.rowCount(),a=n+e.colCount(),o=t;o<r;o++)for(var i=n;i<a;i++){var u=this.getSpan(o,i,3),s=u?u.rowFrom():o,l=u?u.colFrom():i;if(!0===this.getActualStyle(s,l).locked)return!0}return!1}},{key:"_isValidRange",value:function(e,t,n,r,a,o){if(-1<=e&&e<a&&-1<=t&&t<o){if(-1===e&&-1===t)return!0;if(-1===e){if(0!==r&&t+r<=o)return!0}else if(-1===t){if(0!==n&&e+n<=a)return!0}else if(0!==r&&t+r<=o&&0!==n&&e+n<=a)return!0}return!1}},{key:"_hasPartSpans",value:function(e,t,n,r,a){var o=this;if(e<0&&t<0)return!1;if(e<0){var i=o._getSpanModel(1);if(i&&i.length>0)return i.hasPartSpans(-1,t,-1,r,a)}if(t<0){var u=o._getSpanModel(2);if(u&&u.length>0)return u.hasPartSpans(e,-1,n,-1,a)}var s=o._getSpanModel();return!!(s&&s.length>0)&&s.hasPartSpans(e,t,n,r,a)}},{key:"_raiseInvalidOperation",value:function(e,t){this.dispatch("InvalidOperation",{invalidType:e,message:t})}},{key:"_raiseSegmentChangedIgnoreSuspended",value:function(e,t,n,r,a){this.dispatch("SegmentArrayChanged",{sheet:this,sheetName:this._name,row:e,col:t,sheetArea:n,oldValue:r,newValue:a})}},{key:"_raiseCellChanged",value:function(){this.notifyShell(3)}},{key:"_raiseValueChanged",value:function(e,t,n,r,a,o){var i={sheetName:this._name,row:e,col:t,oldValue:n,newValue:r,from:a,executeType:o};this.dispatch("ValueChanged",i),this.notifyShell(4,i)}},{key:"_raiseSelectionChanging",value:function(e,t){return!!function(e,t){var n=!0;if(e.length===t.length)for(var r=0;r<e.length;r++){var a=e[r],o=t[r];if(!a.equal(o)){n=!0;break}n=!1}return n}(e,t)}},{key:"_raiseSelectionChanged",value:function(e,t,n){var r={sheet:this,sheetName:this._name,oldSelections:e,newSelections:this.getSelections(),source:t,eventTargetSource:n};this.dispatch("SelectionChanged",r)}},{key:"bind",value:function(e,t,n){this._getElem().bind(e+NF,t,n)}},{key:"unbind",value:function(e,t){this._getElem().unbind(e+NF,t)}},{key:"trigger",value:function(e,t){this._trigger(e,t)}},{key:"_triggerIgnoreEventSuspended",value:function(e,t){this._getElem().trigger(e,t)}},{key:"_trigger",value:function(e,t){this.updateEventsData&&this.updateEventsData(e,t),0===this._eventSuspended&&this.needNotify&&this._getElem().trigger(e,t)}},{key:"unbindAll",value:function(){this.unbind(NF)}},{key:"_bind",value:function(e,t,n){e.indexOf(".")>=0?this.bind(e,t,n):this.bind(e+OF,t,n)}},{key:"_unbind",value:function(e,t){e.indexOf(".")>=0?this.unbind(e,t):this.unbind(e+OF,t)}},{key:"_unbindAll",value:function(){this.unbind(OF)}},{key:"notifyShell",value:function(e,t){if(this.needNotify)return this._shell&&this._shell(e,t)}},{key:"setRowHeaderColWidth",value:function(e){this.lastRowHeaderWidth=0,this.lastCalcRowCount=0,this.defaults.rowHeaderColWidth=e}},{key:"getRowHeaderColWidth",value:function(){return this.defaults.rowHeaderColWidth}},{key:"onRowColChanged",value:function(e,t,n,r,a){this.chartModel.setRowColInfoChange(e,a)}},{key:"resetDataModel",value:function(e,t){var n=this._getModel(),r=n.getRowCount(),a=n.getColumnCount(),o=n.getName(),i=n.getDefaultStyle();this._dataModel=new mS(r,a,this,o),null!=e&&this._dataModel.fromJSON(e,t),this._dataModel.setDefaultStyle(i)}},{key:"updateFreezeWhenLayoutChanged",value:function(e){var t=this,n=t.frozenRowCount(),r=t.frozenColumnCount();if(n||r){0===e.changeType?function(e){void 0!==e.row&&n>e.row&&t.frozenRowCount(n+e.rowCount),void 0!==e.col&&r>e.col&&t.frozenColumnCount(r+e.colCount)}(e):1===e.changeType&&function(e){if(void 0!==e.row&&n>e.row){var a=e.row+e.rowCount>n?n-e.row:e.rowCount;t.frozenRowCount(n-a)}if(void 0!==e.col&&r>e.col){var o=e.col+e.colCount>r?r-e.col:e.colCount;t.frozenColumnCount(r-o)}}(e)}}},{key:"sheetType",get:function(){return"sheet"}},{key:"watchHubs",get:function(){return[this._filterWatchHub]}},{key:"filterWatchHub",get:function(){return this._filterWatchHub}},{key:"formatterService",get:function(){return this.parent.formatterService}},{key:"_pivotTableManager",get:function(){return this.getPivotTableManagerV2()}},{key:"filterModel",get:function(){var e=this.sheetFilterModel;if(!this.viewsModel)return e;var t=this.viewsModel.activeView;return t&&t.getFilterModel()||e}}]),e}();UF._ID=1,UF._defaultVersion=0,UF._defaultOptions=BF,UF._defaultRowCount=200,UF._defaultColCount=20,UF._defaultChartMap={},UF._defaultRowHeaderColumnCount=1,UF._defaultColHeaderRowCount=1,UF._defaultRowHeight=28,UF._defaultColWidth=120,UF._defaultRowHeaderColWidth=46,UF._defaultColHeaderRowHeight=24,UF._defaultCellPadding=[2,2,3,1],UF.refCountValidVersion=4,UF.latestVersion=4;var HF=(Ge={},(0,l.Z)(Ge,we.kHU.BITABLE_BLOCK,we.B2l.ExternalBlockType.ExternalBlockType_BITABLE_BLOCK),(0,l.Z)(Ge,we.kHU.DOCX_BLOCK,we.B2l.ExternalBlockType.ExternalBlockType_DOCX_BLOCK),Ge),WF=(Je={},(0,l.Z)(Je,we.B2l.ExternalBlockType.ExternalBlockType_BITABLE_BLOCK,we.kHU.BITABLE_BLOCK),(0,l.Z)(Je,we.B2l.ExternalBlockType.ExternalBlockType_DOCX_BLOCK,we.kHU.DOCX_BLOCK),Je),jF=function(e){function t(){var e;return(0,y.Z)(this,t),(e=(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))).gridLineHidden=e.inject(AE),e.tabColor=e.inject(IE),e.tabType=e.inject(cA),e}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"serializeTopSnapshot",value:function(e){var t=[];return this.serializeInsertSheetMutation(t,e),this.serializeSheetProtectionMutation(t),t}},{key:"serializeResourceSnapshot",value:function(e,t){var n=[];return this.serializeDimensionMutation(n,t),this.serializeMergeCellsMutations(n),this.serializeExtraInfoMutations(n),this.serializeWorkbookRangeMutations(n),this.serializeFilterMutation(n,e,t),this.serializeCustomViewsMutation(n,e),this.serializeFloatImagesMutation(n),this.serializeFloatBlocksMutation(n),this.serializeEmbeddedBlocksMutation(n),this.serializeRangeProtectionMutation(n),this.serializeSparklineGroupMutation(n),function(e,t){t.getAllRules().forEach((function(t,n){e.push({type:we.B2l.MutationType.MutationType_AddConditionalFormatting,addConditionalFormatting:{value:{id:t.cfId,ranges:t.getBaseRanges().map((function(e){return e.toGridJSON()})),style:bk(t.style),rule:t.serialize()},index:n}})}))}(n,this.conditionalFormatModel),this.serializeChartMapMutation(n),n}},{key:"serializeTableSnapshot",value:function(e){return this.serializeSetRangeValuesMutation(e)}},{key:"serializePTViewDataModel",value:function(e){var t=this,n=[];e.forEach((function(e){var r=e.startRow||0,a=e.startCol||0,o=e.endRow||0-r,i=e.endCol||0-a;n.push.apply(n,(0,m.Z)(_k(t,r,a,o,i)))}));var r=new Set(n),a=this.getPivotTableManager(),o=[];return r.forEach((function(e){var t=a.getPivotInfoByName(e),n=t&&t.errorState!==Zf.None?void 0:a.getViewDataModelByName(e),r=null!=t&&t.errorState?t.errorState:void 0;o.push({id:e,viewModel:n?JSON.stringify(n.toJSON()):void 0,errorState:r})})),[{type:we.B2l.MutationType.MutationType_AddCalcResult,addCalcResult:{pivotTableViewModels:o}}]}},{key:"serializeInsertSheetMutation",value:function(e,t){var n={worksheetProperties:{id:this.id(),index:t,name:this.name(),rowCount:this.getRowCount(),colCount:this.getColumnCount(),sheetState:this.visible()?we.B2l.SheetState.SheetState_VISIBlE:we.B2l.SheetState.SheetState_HIDDEN,sheetView:{frozenRowCount:this.frozenRowCount(),frozenColCount:this.frozenColumnCount(),hideGridLines:this.gridLineHidden.getGridLine()},sheetPr:{tabColor:{rgb:this.tabColor.getTabColor()},tabType:this.tabType.getTabType()},softDelTime:this._delTime,importRanges:this.getImportRanges()}},r=this,a=r.blockId,o=r.blockToken,i=r.blockType;a&&o&&i&&(n.worksheetProperties.externalBlock={blockId:a,blockToken:o,blockType:HF[i]}),e.push({type:we.B2l.MutationType.MutationType_InsertSheet,insertSheet:n})}},{key:"serializeDimensionMutation",value:function(e,t){var n=this.serializeRowDimensions(t),r=this.serializeColDimensions(),a=this.serializeRowOutlineGroups(),o=this.serializeColOutlineGroups();(n.length>0||r.length>0||a.length>0||o.length>0)&&e.push({type:we.B2l.MutationType.MutationType_SetDimensionProperties,setDimensionProperties:{rowDimensions:n,colDimensions:r,rowOutlineGroups:a,colOutlineGroups:o}})}},{key:"serializeRowDimensions",value:function(e){var t=[];return this._getRowInfos().serialize(t,e),t}},{key:"serializeColDimensions",value:function(){var e=[];return this._getColInfos().serialize(e),e}},{key:"serializeRowOutlineGroups",value:function(){var e=[];return this.outlineGroupModel.serialize(e,!0),e}},{key:"serializeColOutlineGroups",value:function(){var e=[];return this.outlineGroupModel.serialize(e,!1),e}},{key:"serializeMergeCellsMutations",value:function(e){var t,n=[],r=_n(this._getSpanModel().toArray(!0));try{for(r.s();!(t=r.n()).done;){var a=t.value.toSimpleGridJSON();n.push(a)}}catch(e){r.e(e)}finally{r.f()}n.length>0&&e.push({type:we.B2l.MutationType.MutationType_MergeCells,mergeCells:{ranges:n}})}},{key:"serializeSetRangeValuesMutation",value:function(e){return this._getModel().serialize(e)}},{key:"serializeExtraInfoMutations",value:function(e){this._getModel().serializeExtraInfo(e)}},{key:"serializeWorkbookRangeMutations",value:function(e){var t=this;this.rangeModel.forEach((function(n,r){var a=Oi.fromJSON(n,n.type,t);e.push({type:we.B2l.MutationType.MutationType_AddWorkbookRange,addWorkbookRange:{value:{id:r,range:a.toGridJSON(),type:n.usageType||we.B2l.WorkbookRangeType.WorkbookRangeType_ChartOrPivotTable}}})}))}},{key:"serializeFilterMutation",value:function(e,t,n){var r=(n?this.filterModel:this.sheetFilterModel).serialize(t);r&&e.push({type:we.B2l.MutationType.MutationType_SetAutoFilter,setAutoFilter:{value:r}})}},{key:"serializeCustomViewsMutation",value:function(e,t){var n,r=_n(this.viewsModel.serialize(t));try{for(r.s();!(n=r.n()).done;){var a=n.value;e.push({type:we.B2l.MutationType.MutationType_AddCustomView,addCustomView:{value:a}})}}catch(e){r.e(e)}finally{r.f()}}},{key:"serializeFloatImagesMutation",value:function(e){var t,n=_n(this.floatImageModel.serialize());try{for(n.s();!(t=n.n()).done;){var r=t.value;e.push({type:we.B2l.MutationType.MutationType_AddFloatImage,addFloatImage:{value:r}})}}catch(e){n.e(e)}finally{n.f()}}},{key:"serializeFloatBlocksMutation",value:function(e){var t,n=_n(this.floatBlocksModel.serialize());try{for(n.s();!(t=n.n()).done;){var r=t.value;e.push({type:we.B2l.MutationType.MutationType_AddFloatBlock,addFloatBlock:{value:r}})}}catch(e){n.e(e)}finally{n.f()}}},{key:"serializeEmbeddedBlocksMutation",value:function(e){var t,n=_n(this.embeddedBlocksModel.serialize());try{for(n.s();!(t=n.n()).done;){var r=t.value;e.push({type:we.B2l.MutationType.MutationType_AddEmbeddedBlock,addEmbeddedBlock:{value:r}})}}catch(e){n.e(e)}finally{n.f()}}},{key:"serializeSheetProtectionMutation",value:function(e){var t,n=this.id(),r=_n(this.parent.permissionManager.findPermDetail(n));try{for(r.s();!(t=r.n()).done;){var a=t.value;e.push({type:we.B2l.MutationType.MutationType_SetSheetProtection,setSheetProtection:{sheetId:n,value:{id:a.permId,creatorId:a.creatorId,description:a.lockInfo}}})}}catch(e){r.e(e)}finally{r.f()}}},{key:"serializeRangeProtectionMutation",value:function(e){var t,n=this,r=_n(this.protectionModel.getAllProtections());try{var a=function(){var r=t.value,a=[];r.ranges.forEach((function(e){var t=Oi.fromJSON(e,e.type,n);a.push(t.toGridJSON())})),e.push({type:we.B2l.MutationType.MutationType_AddRangeProtection,addRangeProtection:{value:{id:r.id,creatorId:r.creatorId,description:r.description,ranges:a}}})};for(r.s();!(t=r.n()).done;)a()}catch(e){r.e(e)}finally{r.f()}}},{key:"serializeSparklineGroupMutation",value:function(e){var t,n=this.getSparklineModel(),r=_n(n.getSparklinesGroupMap());try{for(r.s();!(t=r.n()).done;){var a,o=(0,p.Z)(t.value,2),i=o[0],u=o[1],s=zp(n.getSparklineRawConfig(i)),l={},c=_n(u);try{for(c.s();!(a=c.n()).done;){var h=a.value,f=n.getSparklineById(h),d=f.getPosition(),v=d.row,g=d.col;l[h]={source:f.getSource(),position:{startRow:v,startCol:g,endRow:v+1,endCol:g+1}}}}catch(e){c.e(e)}finally{c.f()}e.push({type:we.B2l.MutationType.MutationType_AddSparklineGroup,addSparklineGroup:{value:{id:i,config:s,sparklines:l}}})}}catch(e){r.e(e)}finally{r.f()}}},{key:"getImportRanges",value:function(){for(var e=this.parent.importRangeManager.getImportRangeIDs(this.id()),t=[],n=0,r=Object.keys(e);n<r.length;n++){var a,o=r[n],i=e[o].ref,u=Oi.fromJSON(i,null!==(a=i.type)&&void 0!==a?a:we.xj7.NORMAL,this).toGridJSON();u.sheetName=i.sheetName,t.push(Object.assign({},e[o],{ref:u}))}return t}},{key:"serializeChartMapMutation",value:function(e){0!==Object.keys(this.chartModel.getChartMap()).length&&e.push({type:we.B2l.MutationType.MutationType_SetChartMap,setChartMap:{chartMap:JSON.stringify(this.chartModel.toJSON())}})}}]),t}(UF),zF=function(e){return[e.row,e.rowCount]},GF=function(e){var t=(0,p.Z)(e,2);return{row:t[0],rowCount:t[1],type:we.xj7.ROW}},JF=function(e){return[e.col,e.colCount]},qF=function(e){var t=(0,p.Z)(e,2);return{col:t[0],colCount:t[1],type:we.xj7.COL}},$F=function(e){return[e.row,e.rowCount,e.col,e.colCount]},YF=function(e){var t=(0,p.Z)(e,4);return{row:t[0],rowCount:t[1],col:t[2],colCount:t[3],type:we.xj7.NORMAL}},KF=la,XF=Vd,QF=KF.each,eM=KF.isEmptyObject,tM=vr._hasOwnProperty,nM="columns",rM="rows",aM="rowHeaderColInfos",oM="colHeaderRowInfos",iM="data",uM="rowHeaderData",sM="colHeaderData",lM="selections",cM="spans";var hM=function(e){function t(){var e;return(0,y.Z)(this,t),(e=(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))).gridLineHidden=e.inject(AE),e.tabColor=e.inject(IE),e.tabType=e.inject(cA),e.handleViewsModel=function(t){var n=e.viewsModel.toJSON();(0,se.default)(n)||(t.views=n)},e}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"_setValueToDataTable",value:function(e,t,n,r){var a=e[t]||(e[t]={});(a[n]||(a[n]={})).value=r}},{key:"toJSON",value:function(e){var t=this,n=arguments.length>1&&void 0!==arguments[1]&&arguments[1],r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1,a=function(e,t){switch(e){case nM:case rM:case aM:case oM:return!t||0===t.length;case"frozenRowCount":case"frozenColCount":case"activeRow":case"activeCol":return 0===t;case"zoomFactor":case"rowHeaderColCount":case"colHeaderRowCount":return 1===t;case"visible":return!0===t;case iM:case uM:case sM:return eM(t);case"tag":return null===t;case"version":return!t||0===t}return!1};function o(e,t,n,r,a){e[t]=n.toJSON(r,a)}function i(e,t,n){e[t]=n.toJSON()}var u=this,s=u.getRowCount(),l=u.getColumnCount(),c=u.getRowCount(),h=u.getColumnCount(),f=u.parent.importRangeManager.getImportRangeIDs(u._id_),d={id:u._id_,version:u.version(),name:u._name,frozenRowCount:u.frozenRowCount(),frozenColCount:u.frozenColumnCount(),rowCount:s,columnCount:l,activeRow:u._activeRowIndex,activeCol:u._activeColIndex,rowHeaderColCount:h,colHeaderRowCount:c,visible:u.visible(),delTime:void 0,hidden:u._hidden,chartMap:this.chartModel.toJSON(),dataRanges:this.rangeModel.toJSON(),floatImageMap:this.floatImageModel.toJSON(),floatBlocks:this.floatBlocksModel.toJSON(),embeddedBlocks:this.embeddedBlocksModel.toJSON(),conditionalFormats:this.conditionalFormatModel.toJSON(),importRangeIDs:f,gridLineHidden:this.gridLineHidden.getGridLine(),tabColor:this.tabColor.getTabColor(),tabType:this.tabType.getTabType(),group:this.outlineGroupModel.toJSON()},v=e&&e.isServerExport;o(d,cM,u._getSpanModel(),v),n||u._getModel().toJSON(3,d,v),v||o(d,lM,u._selectionModel,v),i(d,rM,u._getRowInfos()),i(d,nM,u._getColInfos()),v&&""!=u._delTime&&(d.delTime=u._delTime);var g={};for(var m in d)if(tM(d,m)){var p=d[m];a(m,p)||(g[m]=p)}if(QF(u.options,(function(e,n){var r=n,a=t.constructor;"_ps"!==e&&a._defaultOptions[e]!==r&&("object"==(0,_.Z)(r)&&eM(r)||(g[e]=r))})),u.sheetFilterModel.hasFilter()&&(g.rowFilter=u.sheetFilterModel.toJSON()),this.handleViewsModel(g),u.parent){var y=u.parent.permissionManager,C=u.protectionModel,R=y&&C,w={columns:{},rows:{},sheet:{}};R&&y.iter((function(e,t){e.sheetId===u.id()&&(w.sheet[t]={creatorId:e.creatorId,info:e.lockInfo})})),g.perms=w;var k=R&&C.getAllProtections()||[];if(k.length>0){g.protections={};var S=zF,E=JF,T=$F;k.forEach((function(e){var t=e.id,n=e.creatorId,r=e.description,a={};r&&(a.desc=r),n&&(a.creatorId=n);var o=UI(e),i=o[we.xj7.NORMAL],u=o[we.xj7.ROW],s=o[we.xj7.COL];if(u.length>0&&(a.rows=u.map(S)),s.length>0&&(a.cols=s.map(E)),i.length>0&&(a.cells=i.map(T)),g.protections[t]=a,!(i.length>0))if(1===u.length&&s.length<1){g.perms||(g.perms={rows:{}}),g.perms.rows||(g.perms.rows={});var l=u[0];g.perms.rows[t]={info:r,creatorId:n,range:{row:l.row,rowCount:l.rowCount,col:0,colCount:0}}}else if(1===s.length&&u.length<1){g.perms||(g.perms={columns:{}}),g.perms.columns||(g.perms.columns={});var c=s[0];g.perms.columns[t]={info:r,creatorId:n,range:{row:0,rowCount:0,col:c.col,colCount:c.colCount}}}}))}}if(n||1===r)return g;var A=(new TF).convertSheet(1,r,g),I=A.sheetSnapshot;return I}},{key:"fromJSON",value:function(e,t,n,r){if(e){var a=this;a._initOptions();var o=this.constructor,i=P(e.rowCount,o._defaultRowCount),u=P(e.columnCount,o._defaultColCount);try{if(a._id_=e.id,a._hidden=e.hidden||!1,a._name=e.name,a.version(e.version||UF._defaultVersion),a.conditionalFormatModel&&a.conditionalFormatModel.destroy(),a.defaults=P(e.defaults,a.defaults),a.setRowCount(i),a.setColumnCount(u),this.gridLineHidden.setGridLine(e.gridLineHidden),this.tabColor.setTabColor(e.tabColor),this.tabType.setTabType(e.tabType),e.rowFilter){var s=a.inject(SE);TE(e.rowFilter,s,{sheetRowCount:i})}var l=a.inject(gT);e.views&&function(e,t,n){(0,H.Z)(t,(function(t){if(t.rowFilter){var r=e.addView(t.id,t.name);mT(r.filterModel,t.rowFilter,n)}}))}(l,e.views,{sheetRowCount:i}),a.conditionalFormatModel=Qb.fromJSON(this,e.conditionalFormats),a.chartModel=tE.fromJSON(this,e.chartMap),a.floatImageModel=gb.fromJSON(this,e.floatImageMap),a.floatBlocksModel=ib.fromJSON(this,e.floatBlocks),a.embeddedBlocksModel=iE.fromJSON(this,e.embeddedBlocks),a.rangeModel=mb.fromJSON(this,e.dataRanges),e.group&&a.outlineGroupModel.fromJSON(e.group);var c=a.options;for(var h in c)if(tM(c,h)){var f=e[h];if("protectionOptions"===h&&(f=f||e.protectionOption),XF(f))if("object"==(0,_.Z)(f))for(var d in f)tM(f,d)&&(a.options[h][d]=f[d]);else a.options[h]=f}var v=P(e.activeRow,a._activeRowIndex),g=P(e.activeCol,a._activeColIndex);if(a._setActiveCellImp(v,g),L(a,a.frozenRowCount,e.frozenRowCount),L(a,a.frozenColumnCount,e.frozenColCount),e.importRangeIDs){var m=a.parent.importRangeManager;for(var p in e.importRangeIDs)e.importRangeIDs[p].sheetId=e.id,m.setFromJsonImportRangeMeta(e.importRangeIDs[p]);var y=Object.keys(e.importRangeIDs),C=y.length;if(C>0){var R=0,w=0;y.forEach((function(e){var t=m.getFormulaCountById(e);w=Math.max(w,t),R+=t})),m.collectImportRangeCount(R,C,w)}}var k=P(e.rowHeaderColCount,o._defaultRowHeaderColumnCount),S=P(e.colHeaderRowCount,o._defaultColHeaderRowCount);if(L(a,a.visible,e.visible),Z(a._getSpanModel(),e[cM],n),Z(a._getSpanModel(2),e.rowHeaderSpan,n),Z(a._getSpanModel(1),e.colHeaderSpan,n),a._getModel().fromJSON(e,r),Z(a._rowHeaderModel,e[uM],n),Z(a._colHeaderModel,e[sM],n),e[lM]&&a._selectionModel.fromJSON(e[lM],a),D(a._getRowInfos(),e.rows,i),D(a._getColInfos(),e.columns,u),D(a._getColInfos(2),e.rowHeaderColInfos,k),D(a._getRowInfos(1),e.colHeaderRowInfos,S),D(a._getLocalRowInfos(),[],i),D(a._getLocalColInfos(),[],u),e.delTime&&a.setDelTime(e.delTime),this._initStyle(),a.parent){var E=a.parent.permissionManager,T=a.protectionModel;if(E&&T){var A;(null===(A=e.perms)||void 0===A?void 0:A.sheet)&&Object.getOwnPropertyNames(e.perms.sheet).forEach((function(t){var n=e.perms.sheet[t];E.setPerm(t,{permId:t,lockInfo:n.info,sheetId:a.id(),creatorId:n.creatorId,sheetName:a.name()})}));var I=e.protections,b=e.perms;if(I)!function(){var e=GF,t=qF,n=YF,r=function(r){var a=I[r],o=[];(a.rows||[]).map((function(t){o.push(e(t))})),(a.cols||[]).map((function(e){o.push(t(e))})),(a.cells||[]).map((function(e){o.push(n(e))})),T.setProtection(r,{description:a.desc,creatorId:a.creatorId,ranges:o})};for(var a in I)r(a)}();else if(b){var F=b.columns||{};for(var M in F){var V=F[M];T.setProtection(M,{description:V.info,creatorId:V.creatorId,ranges:[{col:V.range.col,colCount:V.range.colCount,type:we.xj7.COL}]})}var N=b.rows||{};for(var O in N){var x=N[O];T.setProtection(O,{description:x.info,creatorId:x.creatorId,ranges:[{row:x.range.row,rowCount:x.range.rowCount,type:we.xj7.ROW}]})}}}}}finally{}}function Z(e,t,n,r){t&&e.fromJSON(t,n,r)}function D(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[],n=arguments.length>2?arguments[2]:void 0;e.setItems(t.map((function(e){return Object.assign({},e)})),n)}function P(e,t){return XF(e)?e:t}function L(e,t,n){XF(n)&&t.call(e,n,!1)}}}]),t}(jF),fM=Sv._createElement,dM=la,vM=function(e){function t(){var e;return(0,y.Z)(this,t),(e=(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))).lockClickEmbedImage=!1,e._highlightCells=null,e._dropdownApply2AllHighlightCell=null,e._dropdownApply2AllHighlightRange=null,e.getLastBlankRowPos=function(){for(var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,n=e.getRowCount(),r=n-1;r>=t;){var a=new xi(r,1,(0,c.Z)(e));if(!e._dataModel.isRowContentEmpty(r)||!e.protectionModel.getRangePermissions([a]).hasPermission)break;--r}return r+1>=n?-1:r+1},e.getLastBlankColPos=function(){for(var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,n=e.getColumnCount(),r=n-1;r>=t;){var a=new Vi(r,1,(0,c.Z)(e));if(!e._dataModel.isColContentEmpty(r)||!e.protectionModel.getRangePermissions([a]).hasPermission)break;--r}return r+1>=n?-1:r+1},e}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"setLockClickEmbedImage",value:function(){var e=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];this.lockClickEmbedImage=e}},{key:"getLockClickEmbedImage",value:function(){return this.lockClickEmbedImage}},{key:"_onOptionChanged",value:function(e,t,n){this.dispatch("OptionChanged",{value:t,old:n,pn:e,sheet:this})}},{key:"notifyShell",value:function(e,t){if(this.needNotify)return this._shell&&this._shell(e,t)}},{key:"closeNotify",value:function(){this.needNotify=!1}},{key:"resumeNotify",value:function(){this.needNotify=!0}},{key:"registerShell",value:function(e){this._shell=e}},{key:"unRegisterShell",value:function(){this._shell=null}},{key:"cellWidthHint",value:function(e,t){return this.notifyShell(106,{row:e,col:t})}},{key:"_scrollByMoveCell",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]&&arguments[2],r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:3;1&r&&this._scrollToCol(t,n),2&r&&this._scrollToRow(e,n)}},{key:"getCellRect",value:function(e,t){return this.notifyShell(30,{row:e,col:t})}},{key:"getNotExpendCellRect",value:function(e,t){return this.notifyShell(98,{row:e,col:t})}},{key:"getCanvasBoundingClientRect",value:function(){return this.notifyShell(97)}},{key:"scrollTo",value:function(e,t){return this.notifyShell(45,{offsetX:e,offsetY:t})}},{key:"setScrollPos",value:function(e,t){return this.notifyShell(46,{posX:e,posY:t})}},{key:"scroll",value:function(e){var t=e.posX,n=e.posY;return this.setScrollPos(t,n)}},{key:"nextPage",value:function(){var e=this.notifyShell(35);return e?(this._scrollTopRow=e.row,e):null}},{key:"prePage",value:function(){var e=this.notifyShell(36);return e?(this._scrollTopRow=e.row,e):null}},{key:"showCell",value:function(e,t,n,r){var a=arguments.length>4&&void 0!==arguments[4]&&arguments[4],o=arguments.length>5&&void 0!==arguments[5]?arguments[5]:3;this._showCellCore(e,t,a,o)}},{key:"_showCellCore",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]&&arguments[2],r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:3;e<0||e>=this.getRowCount()||t<0||t>=this.getColumnCount()||this._scrollByMoveCell(e,t,n,r)}},{key:"showColumn",value:function(e,t){this.showCell(this._scrollTopRow,e,0,t)}},{key:"showRow",value:function(e,t){this.showCell(e,this._scrollLeftCol,t,0)}},{key:"getCanvasOffset",value:function(){return{left:0,top:0}}},{key:"sheetContentRect",value:function(){return this.notifyShell(32)}},{key:"tableViewRect",value:function(e,t){return this.notifyShell(31,{row:e,col:t})}},{key:"_scrollToRow",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1],n=this._scrollTopRow,r=this.notifyShell(33,{row:e,needMoveToCenter:t});return null==r?0:(this.dispatch("TopRowChanged",{sheet:this,sheetName:this._name,oldTopRow:n,newTopRow:r.row}),this._scrollTopRow=r.row,r)}},{key:"_scrollToCol",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1],n=this.notifyShell(34,{col:e,needMoveToCenter:t});return null==n?0:(this._scrollLeftCol=n.col,n)}},{key:"_scrollToRange",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];this.notifyShell(110,{typedRange:e,needMoveToCenter:t})}},{key:"_commandManager",value:function(){var e=this.parent;if(e)return e.commandManager()}},{key:"_getElem",value:function(){return this._$elem||(this._$elem=dM(fM("input"))),this._$elem}},{key:"invalidateRowHeight",value:function(){this.notifyShell(1),this.dispatch("InvalidateRowHeight")}},{key:"_resetImp",value:function(){(0,f.Z)((0,v.Z)(t.prototype),"_resetImp",this).call(this)}},{key:"_init",value:function(e,n){(0,f.Z)((0,v.Z)(t.prototype),"_init",this).call(this,e,n)}},{key:"_dispose",value:function(e){!1!==e&&(this.unRegisterShell(),this._$elem=null),(0,f.Z)((0,v.Z)(t.prototype),"_dispose",this).call(this,e)}},{key:"_isPartofMergeCell",value:function(e,t){return!!this._getSpanModel().find(e,t)}}]),t}(hM),gM=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),t}(vM),mM={userId:"",token:"",getScene:function(){return"backup"},isEmbed:P.default,setEmbed:P.default,trigger:P.default,getToken:function(){return mM.token},getHistoryType:P.default,setHistoryType:P.default,bind:P.default,unbind:P.default,once:P.default,addListeners:P.default,removeListeners:P.default,addEventHandler:P.default,removeEventHandler:P.default,isFullScreenMode:P.default,setFullScreenMode:P.default,setToken:function(e){return mM.token=e},setMemberId:P.default,getMemberId:P.default,getAllMembers:P.default},pM=["pie"],yM={text:"",value:null,type:0,row:-1,col:-1,sheetId:""};function CM(e,t){return function(e){return pM.includes(e)}(e.type)?new wM(e,t):new kM(e,t)}var _M=[0,2,3,4],RM=function(){function e(t,n){var r=this;(0,y.Z)(this,e),this.setting=t,this.table=n,this.isEmptyTable=function(){return 0===r.table.length||0===r.table[0].length},this.filterInvalidCell=function(e){return e.filter((function(e){return-1!==e.row&&-1!==e.col&&e.sheetId}))},this.getCanHaveRowAxis=function(){return r.table.length>1},this.getCanHaveColAxis=function(){return r.table.length>0&&r.table[0].length>1},this.getHasRowAxis=function(){var e=r.setting,t=e.xAxisPos,n=e.hasLabels,a=e.hasHeaders;return"row"===t&&n||"col"===t&&a},this.getHasColAxis=function(){var e=r.setting,t=e.xAxisPos,n=e.hasLabels,a=e.hasHeaders;return"row"===t&&a||"col"===t&&n},this.transformV0ToV1GraphSetting=function(e,t){if(r.setting.hasHeaders=!1,r.setting.hasLabels=!1,!r.isEmptyTable()){var n=r.isRowAxis(),a=r.getAxisValues(e,t),o=a.xAxisValues,i=a.yAxisValues,u=r.getOneDimensionCombinedSeries(o,n,!0),s=r.getOneDimensionCombinedSeries(i,!n,!0);r.setting.hasLabels=!!u,r.setting.hasHeaders=!!s}},this.filterEmptyRows(),this.filterEmptyCols()}return(0,C.Z)(e,[{key:"NaNToZero",value:function(e){return Number.isNaN(e)?0:e}},{key:"filterEmptyRows",value:function(){for(var e=this.table,t=0,n=0;n<e.length&&!e[n].some((function(e){return null!=e.value}));n++)t++;t&&(e.splice(0,t),t=0);for(var r=e.length-1;r>=0&&!e[r].some((function(e){return null!=e.value}));r--)t+=1;t&&e.splice(e.length-t)}},{key:"filterEmptyCols",value:function(){for(var e=Z.Z.apply(void 0,(0,m.Z)(this.table)),t=0,n=0;n<e.length&&!e[n].some((function(e){return!!e&&null!=e.value}));n++)t++;t&&(this.table.forEach((function(e){return e.splice(0,t)})),t=0);for(var r=e.length-1;r>=0&&!e[r].some((function(e){return!!e&&null!=e.value}));r--)t++;t&&this.table.forEach((function(e){return e.splice(e.length-t)}))}},{key:"isRowAxis",value:function(){return"row"===this.setting.xAxisPos}},{key:"isNumeric",value:function(e){return!Number.isNaN(Number(e))}},{key:"isAxisDataNumber",value:function(e){return _M.includes(e.type)&&this.isNumeric("".concat(e.value))}},{key:"getValidArrayValue",value:function(e,t){var n=this;return t.map((function(t){return n.getValidCellValue(e,t)}))}},{key:"getValidCellValue",value:function(e,t){var n=t.text,r=t.value,a=t.type;if(e)return Object.assign({},t,{text:(null==n?"":n).toString()});try{return Object.assign({},t,{value:5===a?NaN:this.isNumeric("".concat(r))?parseFloat("".concat(r)):NaN})}catch(e){return Object.assign({},t,{value:NaN})}}},{key:"isSequentialNum",value:function(e){for(var t=1;t<e.length;t++)if(e[t]!==e[t-1]+1)return!1;return!0}},{key:"isValidSeries",value:function(e,t){if(e=this.filterInvalidCell(e),t){var n=e.map((function(e){return e.col}));return this.isSequentialNum(n)&&e.every((function(t){return t.row===e[0].row}))}var r=e.map((function(e){return e.row}));return this.isSequentialNum(r)&&e.every((function(t){return t.col===e[0].col}))}},{key:"getOneDimensionCombinedSeries",value:function(e,t,n){e=this.filterInvalidCell(e);var r=!!n||this.isValidSeries(e,t);return 0!==e.length&&r?{row:e[0].row,col:e[0].col,rowCount:t?1:e.length,colCount:t?e.length:1,sheetId:e[0].sheetId}:null}},{key:"getTwoDimensionCombinedSeries",value:function(e,t){var n=this,r=(e=e.map(this.filterInvalidCell)).every((function(e){return n.isValidSeries(e,t)}));if(0===e.length||0===e[0].length||!r)return null;var a=[];return e.forEach((function(e){e.length>0&&a.push({row:e[0].row,col:e[0].col,rowCount:t?1:e.length,colCount:t?e.length:1,sheetId:e[0].sheetId})})),a}},{key:"canBeAggregate",value:function(e){return!!(e&&e.length>1&&e.some((function(e){return!!e.text})))}},{key:"aggregate",value:function(e,t){var n=this,r=new Map;e.forEach((function(e,t){var n=e.text;n&&r.has(n)?r.get(n).push(t):r.set(n,[t])}));var a=[];r.forEach((function(e,r){e.length>1&&(n.aggregateValues(t,e),(0,we.hTd)(a,e.slice(1)))})),(0,D.Z)(e,a),this.multiSpliceTableValues(t,a)}},{key:"sumIdenticalCategoryToBase",value:function(e,t,n){var r=this,a=n.reduce((function(t,n){return(0,ut.convertTo15Digits)(parseFloat(t+r.NaNToZero((0,fe.Z)(e[n].value))))}),this.NaNToZero((0,fe.Z)(e[t].value)));e[t].value=a,e[t].text="".concat(a)}},{key:"getHeadersQuote",value:function(e,t){return e?"row"===t?{enabled:this.getCanHaveColAxis(),dimension:"col",position:(0,we.hdC)(e.col)}:{enabled:this.getCanHaveRowAxis(),dimension:"row",position:e.row+1}:{enabled:!1}}},{key:"getLabeslQuote",value:function(e,t){return e?"row"===t?{enabled:this.getCanHaveRowAxis(),dimension:"row",position:e.row+1}:{enabled:this.getCanHaveColAxis(),dimension:"col",position:(0,we.hdC)(e.col)}:{enabled:!1}}},{key:"getAxisValues",value:function(e,t){var n,r,a=this.table;return e=e&&this.table.length>1,t=t&&this.table.length>0&&this.table[0].length>1,e||t?e&&!t?(n=this.getValidArrayValue(!0,a[0]),r=a.map((function(e){return yM})).slice(1)):!e&&t?(n=a[0].map((function(e){return yM})).slice(1),r=this.getValidArrayValue(!0,a.map((function(e){return e[0]})))):(n=this.getValidArrayValue(!0,a[0].slice(1)),r=this.getValidArrayValue(!0,a.map((function(e){return e[0]})).slice(1))):(n=a[0].map((function(e){return yM})),r=a.map((function(e){return yM}))),"row"===this.setting.xAxisPos?{xAxisValues:n,yAxisValues:r}:{xAxisValues:r,yAxisValues:n}}},{key:"getDataTable",value:function(e,t){var n=this.table,r=this.setting,a=n.map((function(e){return t&&e.length>1?e.slice(1):e}));return a=e&&n.length>1?a.slice(1):a,"row"===r.xAxisPos?a:Z.Z.apply(void 0,(0,m.Z)(a))}},{key:"getLabelsAndHeaderOptions",value:function(){var e=this.setting.xAxisPos,t=this.isRowAxis(),n=this.getAxisValues(!0,!0),r=n.xAxisValues,a=n.yAxisValues;return{labelsOptions:this.getLabeslQuote(this.getOneDimensionCombinedSeries(r,t,!0),e),headersOptions:this.getHeadersQuote(this.getOneDimensionCombinedSeries(a,!t,!0),e)}}},{key:"isVersion0Setting",value:function(){var e=this.setting;return void 0===e.hasLabels||void 0===e.hasHeaders}},{key:"parseInfoNewChart",value:function(){for(var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[],t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[],n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:[],r=[this.filterInvalidCell(e)],a=t.map(this.filterInvalidCell),o=this.filterInvalidCell(n),i=0;i<o.length;i++){var u,s=o[i];null===(u=a[i])||void 0===u||u.unshift(s)}return{firstCells:r,secondCells:a}}}]),e}(),wM=function(e){function t(e,n){var r;return(0,y.Z)(this,t),(r=(0,d.Z)(this,(0,v.Z)(t).call(this,e,n))).defaultGraphData={values:[],xAxisValues:[]},r.defaultSettingsData={allowedAggregate:!1,isStack:!1,headersOptions:{enabled:!1},title:"",type:"pie",valueRanges:null,labelsOptions:{enabled:!1},xAxisRange:null},r.hasLeftTopContent=function(){return r.table.length>0&&r.table[0].length>0&&null!==r.table[0][0].value},r.hasHeaderBaseValues=function(){var e=!1,t=!1,n=r.isRowAxis();return(n&&r.table.length>1||!n&&r.table.length>0&&r.table[0].length>1)&&(t=!r.hasLeftTopContent(),e=!0),{hasRowAxis:n?e:t,hasColAxis:n?t:e}},r.isVersion0Setting()&&r.transformSettingV0ToV1(),r}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"transformSettingV0ToV1",value:function(){var e=this.hasHeaderBaseValues(),t=e.hasRowAxis,n=e.hasColAxis;this.transformV0ToV1GraphSetting(t,n)}},{key:"genBaseData",value:function(){var e=this.getHasRowAxis(),t=this.getHasColAxis();if(this.isEmptyTable())return this.defaultGraphData;var n=this.getDataTable(e,t),r=this.getAxisValues(e,t);return{xAxisValues:r.xAxisValues,yAxisValuesForNewChart:r.yAxisValues,values:this.getValidArrayValue(!1,n[0])}}},{key:"gen",value:function(){var e=this.setting,t=e.title,n=e.type,r=this.genBaseData(),a=(0,Re.default)(r.values),o=(0,Re.default)(r.xAxisValues),i=[];a.forEach((function(e,t){e.value&&e.value<0&&i.push(t)})),(0,D.Z)(o,i),(0,D.Z)(a,i);var u=this.canBeAggregate(o);return e.isAggregate&&u&&this.aggregate(o,a),delete r.yAxisValuesForNewChart,Object.assign({title:t,type:n,isStack:e.isStack},r,{values:a,xAxisValues:o})}},{key:"genChartSettingData",value:function(){var e=this.setting,t=e.title,n=e.type,r=this.isRowAxis();if(this.isEmptyTable())return this.defaultSettingsData;var a=this.genBaseData(),o=a.xAxisValues,i=a.values,u=a.yAxisValuesForNewChart,s=this.getLabelsAndHeaderOptions(),l=s.labelsOptions,c=s.headersOptions,h=e.hasLabels&&this.canBeAggregate(o),f=this.getOneDimensionCombinedSeries(o,r),d=this.getOneDimensionCombinedSeries(i,r),v=this.parseInfoNewChart(o,[i],u),g=v.firstCells,m=v.secondCells;return{title:t,type:n,isStack:e.isStack,valueRanges:d?[d]:null,xAxisRange:f,allowedAggregate:h,labelsOptions:l,headersOptions:c,newChart:{firstCells:g,secondCells:m}}}},{key:"aggregateValues",value:function(e,t){var n=t[0],r=t.slice(1);this.sumIdenticalCategoryToBase(e,n,r)}},{key:"multiSpliceTableValues",value:function(e,t){(0,D.Z)(e,t)}}]),t}(RM),kM=function(e){function t(e,n){var r;return(0,y.Z)(this,t),(r=(0,d.Z)(this,(0,v.Z)(t).call(this,e,n))).defaultGraphData={values:[[]],xAxisValues:[],yAxisValues:[]},r.defaultSettingsData={allowedAggregate:!1,isStack:!1,headersOptions:{enabled:!1},title:"",type:"bar",valueRanges:null,labelsOptions:{enabled:!1},xAxisRange:null},r.isRowAxisIncludeNumber=function(){return r.table.length>0&&r.table[0].some((function(e){return r.isAxisDataNumber(e)}))},r.isColAxisIncludeNumber=function(){return r.table.length>0&&r.table[0].length>0&&r.table.map((function(e){return e[0]})).some((function(e){return r.isAxisDataNumber(e)}))},r.isVersion0Setting()&&r.transformSettingV0ToV1(),r}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"transformSettingV0ToV1",value:function(){var e=!this.isRowAxisIncludeNumber(),t=!this.isColAxisIncludeNumber();this.transformV0ToV1GraphSetting(e,t)}},{key:"gen",value:function(){var e=this.setting,t=e.title,n=e.type,r=this.genBaseData(),a=(0,Re.default)(r.values),o=(0,Re.default)(r.xAxisValues),i=this.canBeAggregate(o);return e.isAggregate&&i&&this.aggregate(o,a),Object.assign({title:t,type:n,isStack:e.isStack},r,{values:a,xAxisValues:o})}},{key:"genBaseData",value:function(){if(this.isEmptyTable())return this.defaultGraphData;var e=this.getHasRowAxis(),t=this.getHasColAxis(),n=this.getValidTwoDimensionValue(!1,this.getDataTable(e,t)),r=this.getAxisValues(e,t);return{xAxisValues:r.xAxisValues,yAxisValues:r.yAxisValues,values:n}}},{key:"genChartSettingData",value:function(){if(this.isEmptyTable())return this.defaultSettingsData;var e=this.getLabelsAndHeaderOptions(),t=e.labelsOptions,n=e.headersOptions,r=this.genBaseData(),a=r.xAxisValues,o=void 0===a?[]:a,i=r.values,u=void 0===i?[]:i,s=r.yAxisValues,l=void 0===s?[]:s,c=this.setting,h=c.title,f=c.type,d=this.isRowAxis(),v=c.hasLabels&&this.canBeAggregate(o),g=this.getOneDimensionCombinedSeries(o,d),m=this.getTwoDimensionCombinedSeries(u,d),p=this.parseInfoNewChart(o,u,l),y=p.firstCells,C=p.secondCells;return{title:h,type:f,isStack:c.isStack,allowedAggregate:v,xAxisRange:g,valueRanges:m,labelsOptions:t,headersOptions:n,newChart:{firstCells:y,secondCells:C}}}},{key:"aggregateValues",value:function(e,t){var n=this,r=t[0],a=t.slice(1);e.forEach((function(e){n.sumIdenticalCategoryToBase(e,r,a)}))}},{key:"multiSpliceTableValues",value:function(e,t){e.forEach((function(e){(0,D.Z)(e,t)}))}},{key:"getValidTwoDimensionValue",value:function(e,t){var n=this;return t.map((function(t){return n.getValidArrayValue(e,t)}))}}]),t}(RM),SM=function(){function e(t){(0,y.Z)(this,e),this.dataSource=t}return(0,C.Z)(e,[{key:"detectWhileCreating",value:function(e,t){var n=e.graphSetting;this.avoidInvalidRange(n),!t&&this.detectV1GraphSetting(n)}},{key:"gen",value:function(e){return this.avoidInvalidRange(e),CM(e,this.genVirtualTable(e)).gen()}},{key:"genChartSettingData",value:function(e){return this.avoidInvalidRange(e),CM(e,this.genVirtualTable(e)).genChartSettingData()}},{key:"genChartSettingDataForNewChart",value:function(e){return this.avoidInvalidRange(e),CM(e,this.genVirtualTable(e,!0)).genChartSettingData()}},{key:"detectV1GraphSetting",value:function(e){return CM(e,this.genVirtualTable(e)).transformSettingV0ToV1()}},{key:"genVirtualTable",value:function(e){var t=this,n=arguments.length>1&&void 0!==arguments[1]&&arguments[1],r=e.dataRanges,a=e.combineDirection,o=e.xAxisPos;if(0===r.length)return[[]];var i=this.getMaxRowCountInRange(a,r,n),u=this.getMaxColCountInRange(a,r,n);if(0===i||0===u)return[[]];var s=this.getInitialVirtualTable(o,u,i),l=0;return r.forEach((function(e){var r=t.getRangeValues(e,n);r.length&&("horizontal"===a?(r.forEach((function(e,t){return e.forEach((function(e,n){return s[t][l+n]=e}))})),l+=r[0].length):(r.forEach((function(e,t){return e.forEach((function(e,n){return s[l+t][n]=e}))})),l+=r.length))})),s}},{key:"avoidInvalidRange",value:function(e){e.dataRanges.forEach((function(e){e.row=Math.max(0,e.row),e.col=Math.max(0,e.col)}))}},{key:"getRangeValues",value:function(e,t){var n=this.dataSource,r=e.sheetId,a=n.getRangeDatas(r,e);if(!t){var o=this.getHiddenRowColInRange(e),i=o.hiddenRowIndexes,u=o.hiddenColIndexes;i.forEach((function(e){return a.splice(e,1)})),u.forEach((function(e){return a.forEach((function(t){return t.splice(e,1)}))}))}return a}},{key:"getHiddenRowColInRange",value:function(e){var t=e.row,n=e.col,r=e.rowCount,a=e.colCount,o=e.sheetId,i=this.dataSource.getHiddenCols(o),u=this.dataSource.getHiddenRows(o),s=[],l=[];if(u)for(var c=r-1;c>=0;c--)u[t+c]&&s.push(c);if(i)for(var h=a-1;h>=0;h--)i[n+h]&&l.push(h);return{hiddenRowIndexes:s,hiddenColIndexes:l}}},{key:"getInitialVirtualTable",value:function(e,t,n){var r={text:"",value:NaN,type:0,row:-1,col:-1,sheetId:""};return(0,m.Z)(Array(n)).map((function(){return Array(t).fill(Object.assign({},r))}))}},{key:"getMaxRowCountInRange",value:function(e,t,n){var r=this;return"horizontal"===e?this.getRangeRowCount((0,x.Z)(t,(function(e){return r.getRangeRowCount(e,n)})),n):t.reduce((function(e,t){return e+r.getRangeRowCount(t,n)}),0)}},{key:"getMaxColCountInRange",value:function(e,t,n){var r=this;return"horizontal"===e?t.reduce((function(e,t){return e+r.getRangeColCount(t,n)}),0):this.getRangeColCount((0,x.Z)(t,(function(e){return r.getRangeColCount(e,n)})),n)}},{key:"getRangeRowCount",value:function(e,t){if(!e)return 0;if(t)return e.rowCount;var n=e.row,r=e.rowCount,a=this.dataSource.getHiddenRows(e.sheetId),o=e.rowCount;if(!a)return o;for(var i=0;i<r;i++)a[n+i]&&o--;return o}},{key:"getRangeColCount",value:function(e,t){if(!e)return 0;if(t)return e.colCount;var n=this.dataSource.getHiddenCols(e.sheetId),r=e.col,a=e.colCount,o=e.colCount;if(!n)return o;for(var i=0;i<a;i++)n[r+i]&&o--;return o}}]),e}(),EM=function(){function e(){(0,y.Z)(this,e),this.map=new Map,this.permIdList=[],this.bindEvents()}return(0,C.Z)(e,[{key:"bindEvents",value:function(){}},{key:"destroy",value:function(){}},{key:"remove",value:function(e){return e&&0!==e.length?!0!==this.map.has(e)?3:(this.map.delete(e),this.permIdList=this.permIdList.filter((function(t){return t!==e})),0):2}},{key:"set",value:function(e,t){if(!e||0===e.length)return 2;if(this.map.has(e)){var n=this.map.get(e),r=(t.creatorId,(0,s.Z)(t,pn));this.map.set(e,Object.assign({},n,{},r))}else this.map.set(e,t),this.permIdList.push(e);return 0}},{key:"all",value:function(){return new Map(this.map)}},{key:"iter",value:function(e){this.map.forEach(e)}},{key:"has",value:function(e){return this.map.has(e)}},{key:"get",value:function(e){return this.map.get(e)}},{key:"size",value:function(){return this.map.size}}]),e}(),TM=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"bindSheetEvents",value:function(e){console.log("bindSheetEvents")}},{key:"unbindSheetEvents",value:function(e){console.log("unbindSheetEvents")}},{key:"findPerm",value:function(e){var t=this;return this.permIdList.filter((function(n){var r=t.map.get(n);return!(!r||r.sheetId!==e)}))}},{key:"existPerm",value:function(e){var t=this;return this.permIdList.some((function(n){var r=t.map.get(n);return!(!r||r.sheetId!==e)}))}}]),t}(EM),AM=function(){function e(t){var n=this,r=arguments.length>1&&void 0!==arguments[1]&&arguments[1];(0,y.Z)(this,e),this.lastActiveSheetId="",this.subscriber=null,this._curSheetEditable$=new vt.X(!1),this._editableSheets$=new vt.X({}),this._curSheetVisiblePerm$=new vt.X(!1),this._invisibleSheets$=new vt.X({}),this.curSheetEditable$=this._curSheetEditable$.asObservable(),this.editableSheets$=this._editableSheets$.asObservable(),this.curSheetVisiblePerm$=this._curSheetVisiblePerm$.asObservable(),this.invisibleSheets$=this._invisibleSheets$.asObservable(),this.syncSheetPermission=function(){var e=(0,u.Z)(i().mark((function e(t,r,a,o){var u,s,l,c;return i().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(u=(0,we.pPK)(),s=n.getPermIdList(),l=n.spread,n.userPerm.getToken()!==r&&(n.userPerm.reset(),n.userPerm.setToken(r)),u||!s||!s.length){e.next=15;break}if(e.prev=2,!we.Ps3.getSheetInvisibleProtectionPortEnabled()){e.next=8;break}return e.next=6,FI(s.map((function(e){return{permId:e,userId:t,userType:we.$AG.user,actionType:[we.KXM.view,we.KXM.edit]}})),void 0,r||l._context.token,l.options.situation);case 6:e.next=10;break;case 8:return e.next=10,II(s);case 10:e.next=15;break;case 12:return e.prev=12,e.t0=e.catch(2),e.abrupt("return",void(o&&o(e.t0)));case 15:return c=n.userPerm.isReady,n.userPerm.setReady(!0),a&&a(),e.next=20,n.refresh();case 20:c||l.dispatch("PermissionReady");case 21:case"end":return e.stop()}}),e,null,[[2,12]])})));return function(t,n,r,a){return e.apply(this,arguments)}}(),this.getAllPermissionList=function(){var e=n.spread,t=new Map,r=n.userPerm;return e.sheets.forEach((function(e){var a=[],o=e.id(),i=n.findPermDetail(o);if(i&&i.length>0&&i.forEach((function(e){a.push(Object.assign({},e,{type:3,permissionType:r.getPermType(e.permId),sheetId:o}))})),e.protectionModel){var u=e.protectionModel.getAllProtections();u.forEach((function(e){a.push(Object.assign({},e,{type:0,permissionType:r.getPermType(e.id),sheetId:o}))})),a&&a.length&&t.set(o,a)}})),t},this.onActiveSheetChanged=function(){if(n.userPerm.isReady){var e=n.spread;if(e){var t=e.getActiveSheet();n.lastActiveSheetId!==t.id()&&(n.refreshPermission(),n.lastActiveSheetId=t.id())}}},this.sheetPerm=new TM,this.spread=t,this._curSheetEditable$.next(r),this._curSheetVisiblePerm$.next(r),this.bindEvents()}return(0,C.Z)(e,[{key:"getDepends",value:function(){return{ActiveSheetChanged:this.onActiveSheetChanged}}},{key:"bindEvents",value:function(){this.subscriber=this.spread.subscribe(this.getDepends())}},{key:"reset",value:function(){this.sheetPerm=new TM}},{key:"destroy",value:function(){this.subscriber&&this.subscriber.unsubscribe(),this.subscriber=null,this._curSheetEditable$.complete(),this._editableSheets$.complete(),this._curSheetVisiblePerm$.complete(),this._invisibleSheets$.complete(),SI(this.spread.options.situation)}},{key:"setPerm",value:function(){var e=this,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:VI(),n=arguments.length>1?arguments[1]:void 0,r=this.sheetPerm.set(t,n);return this.userPerm.isReady?LI(10,300,(function(){var n;we.Ps3.getSheetInvisibleProtectionPortEnabled()?FI([{permId:t,userId:(null===(n=window.User)||void 0===n?void 0:n.id)||"",userType:we.$AG.user,actionType:[we.KXM.view,we.KXM.edit]}],(function(){return e.refresh()}),e.spread._context.token,e.spread.options.situation):II([t],(function(){return e.refresh()}))})):this.refresh(),r}},{key:"refresh",value:function(){var e=this;if("history"!==this.spread.options.situation)return new Promise((function(t){setTimeout((function(){e.refreshPermission(),t(!0)}))}))}},{key:"removePerm",value:function(e){var t=this.sheetPerm.remove(e);return this.refresh(),t}},{key:"refreshPermission",value:function(){var e=this,t=this.spread;if(t){var n={},r={};t.sheets.forEach((function(t){var a=t.id(),o=e.hasPermission(a),i=!e.hasSheetVisiblePermission(a);o&&(n[a]=!0),i&&(r[a]=!0)})),(0,pe.default)(this._editableSheets$.getValue(),n)||this._editableSheets$.next(n),(0,pe.default)(this._invisibleSheets$.getValue(),r)||(this._invisibleSheets$.next(r),this.spread.dispatch("InvisiblePermissionChanged"));var a=t.getActiveSheet();if(a){var o=a.id(),i=n[o]||!1,u=!r[o]||!1;(function(e,t){e.dispatch("PermissionChanged",{permissions:t})})(a,{sheetPermission:i,sheetVisibilityPermission:u}),i!==this.curSheetEditable&&this._curSheetEditable$.next(i),u!==this.curSheetVisiblePerm&&this._curSheetVisiblePerm$.next(u);var s=a.protectionModel;s&&s.refreshPermission(!0)}}}},{key:"findPerm",value:function(e){return this.sheetPerm.findPerm(e)}},{key:"existPerm",value:function(e){return this.sheetPerm.existPerm(e)}},{key:"hasInvisible",value:function(e){var t=this;return this.findPerm(e).some((function(e){return t.userPerm.getHasInivisible(e)}))}},{key:"findPermDetail",value:function(e){var t=this,n=[];return this.findPerm(e).forEach((function(e){var r=t.findPermById(e);r&&n.push(r)})),n}},{key:"findPermById",value:function(e){return this.sheetPerm.get(e)}},{key:"iter",value:function(e){return this.sheetPerm.iter(e)}},{key:"hasPermission",value:function(e){var t=this;if(!this.userPerm.isReady)return!1;var n=this.findPerm(e);return 0===n.length||n.every((function(e){return t.userPerm.hasEditPerm(e)}))}},{key:"hasInvisiblePermissionAllSheet",value:function(){for(var e in this.invisibleSheets)if(this.invisibleSheets[e])return!0;return!1}},{key:"hasSheetVisiblePermission",value:function(e){var t=this;if(!this.userPerm.isReady)return!1;var n=this.findPerm(e);return 0===n.length||n.every((function(e){return t.userPerm.hasVisiblePerm(e)}))}},{key:"getPermIdList",value:function(){var e=this.spread,t=[];return(0,H.Z)(e.sheets,(function(e){var n;((null===(n=e.protectionModel)||void 0===n?void 0:n.getAllProtections())||[]).forEach((function(e){var n=e.id;t.push(n)}))})),e.permissionManager&&e.permissionManager.iter((function(e){t.push(e.permId)})),t}},{key:"curSheetEditable",get:function(){return this._curSheetEditable$.getValue()}},{key:"editableSheets",get:function(){return this._editableSheets$.getValue()}},{key:"curSheetVisiblePerm",get:function(){return this._curSheetVisiblePerm$.getValue()}},{key:"invisibleSheets",get:function(){return this._invisibleSheets$.getValue()}},{key:"userPerm",get:function(){return kI(this.spread.options.situation)}}]),e}();function IM(e,t,n,r){for(var a=t.startRow,o=t.endRow,i=t.startCol,u=t.endCol,s=uo(o,e.getRowCount()),l=uo(u,e.getColumnCount()),c=a;c<s;c++)for(var h=i;h<l;h++){var f=e.getVar(c,h,!0);if(ah(f)){if(n(c,h,f))return!0}else r&&r(c,h,f)}return!1}var bM,FM=function(e){function t(){var e;return(0,y.Z)(this,t),(e=(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))).transformVariant=rw,e}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"isArgMappable",value:function(e,t,n){return!(n.hasOwnProperty("isMappable")&&!n.isMappable)&&(Fu(t)&&!(0,ut.varTypeCheck)(t,n.type)?!0===e.isArray&&t.size()>1:!(!Au(t)||(0,ut.varTypeCheck)(t,n.type)))}},{key:"createSheetTArgument",value:function(e,t,n,r){return B_(e,n,t.operandDesc(r))?new lw(e,t,n,r):new cw(e,t,n,r)}},{key:"createSheetTArguments",value:function(){return new hw}}]),t}(ut.ArgumentService),MM=function(e){function t(e){var n;return(0,y.Z)(this,t),(n=(0,d.Z)(this,(0,v.Z)(t).call(this,e))).service=e,n}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"getFuncMeta",value:function(e){return this.sr[e]}},{key:"sr",get:function(){return we.Ps3.SheetCalcI18nMap}}]),t}(ut.I18nService),VM=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"resolveArgument",value:function(e,t,n,r){if(Mu(n)){var a,o=n.getSheetRef(null===(a=e.formula)||void 0===a?void 0:a.getRefMap());n=o instanceof Ei?new Su(ki(o,e.ref)):o}if(gf(n)){var i=t.operandDesc(r);i&&!(0,ut.isTypeCompatible)(n,i)&&(n=n.getVar(e))}return n}},{key:"calc",value:function(e,t,n){var r=n.length;this.resolveDefaultArguments(t,n,e);var a=this.checkArgs(t,n);if(a)return a;void 0===e.info.customData&&null===e.info.customData||(e.info.customData=null);for(var o=[],i=0;i<r;i++){var u,s,l,c,h=n[i];o.push(null!==(u=null===(s=h.getSpecialInfo())||void 0===s?void 0:s.customData)&&void 0!==u?u:null),h.isNull()&&(h=null!==(l=this.resolveDefaultArgument(t,i,ut.DefaultParam.IfInputNull))&&void 0!==l?l:ut.NULL_VAR),h.isOp()&&!(0,ut.varTypeCheck)(h,t.operandType(i))&&(e.info.customData=null,h=h.getVar(e),o[i]=null===(c=e.info)||void 0===c?void 0:c.customData,e.info.customData=null),n[i]=this.resolveArgument(e,t,h,i)}var f=e.service.arg,d=f.createSheetTArguments();r=n.length;for(var v=0;v<r;v++)d.appendArgument(f.createSheetTArgument(e,t,n[v],v));if(!d.hasMatrixArgument){var g=this.callFunction(e,t,d.getArgs(0,0));return void 0!==e.info.customData&&null!==e.info.customData||(e.info.customData=t.calcCustomData(this.lazyGetRefCustomData.bind(null,n,o,e))),e.info.customData&&g.setSpecialInfo({customData:e.info.customData}),g}for(var m,p=[],y=d.getExpandSize(),C=y.row,_=y.col,R=C,w=_,k=!1,S=0;S<C;S++){p[S]=[];for(var E=0;E<_;E++){var T=d.getArgs(S,E),A=this.callFunction(e,t,T);if(A.isAsync())throw A;if(!A.isCollection()&&!A.isPrimitive())return ut.tractorErrorVarCreators[ut.ErrorCode.UNKNOWN]("The return value of function is not primitive or collection.");p[S][E]=A,(Au(A)||Fu(A))&&(k=!0,R=Math.max(R,A.rowCount()),w=Math.max(w,A.colCount()))}}return m=k?new Eu(p,C,_,R,w):new Ru(p),void 0!==e.info.customData&&null!==e.info.customData||(e.info.customData=t.calcCustomData(this.lazyGetRefCustomData.bind(null,n,o,e))),e.info.customData&&m.setSpecialInfo({customData:e.info.customData}),m}},{key:"lazyGetRefCustomData",value:function(e,t,n){for(var r=0;r<e.length;r++){var a,o=e[r];if(o.isRef()){var i=o.getRef();if(i.isValid()){var u=null===(a=i.getCustomData)||void 0===a?void 0:a.call(i,n);u&&(t[r]=u)}else t[r]=null}}return t}}]),t}(ut.OpService),NM=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"registerSyncFml",value:function(e){this.registerFml(e)}},{key:"markDirtyCompleted",value:function(e){}},{key:"registerFml",value:function(e,t){var n=e.getRef();this.formulas.add(e),e.isDirty(n)&&this.addDirtyFormula(e),this.addAlwaysCalcFmls(e),this.emit(ut.FormulaSpaceEvents.onFormulaRegistered,e)}},{key:"unRegisterFml",value:function(e){this.formulas.delete(e),this.deleteDirtyFormula(e),this.alwaysCalcFormulas.delete(e),this.formulaService.removeValueChangedFormula(e),this.emit(ut.FormulaSpaceEvents.onFormulaUnregistered,e)}},{key:"addDirtyFormula",value:function(e){this.dirtyFormulas.has(e)||this.dirtyFormulas.add(e)}},{key:"deleteDirtyFormula",value:function(e){this.dirtyFormulas.has(e)&&this.dirtyFormulas.delete(e)}},{key:"initial",value:function(){}},{key:"dispose",value:function(){}}]),t}(ut.FormulaSpace),OM=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"registerFml",value:function(e){(0,f.Z)((0,v.Z)(t.prototype),"registerFml",this).call(this,e,{dependRefAdjust:!0,mountedRefAdjust:!0,dirtinessTransfer:!1})}},{key:"iterFormulasDependOn",value:function(e,t,n){var r,a=_n(this.reactivitySpace.dependenciesWatch.refIter());try{for(a.s();!(r=a.n()).done;){var o=(0,p.Z)(r.value,2),i=o[0],u=o[1];if(e.isIntersect(i)){var s,l=_n(u);try{for(l.s();!(s=l.n()).done;){var c=s.value;if(ah(c)&&n(c,i))return}}catch(e){l.e(e)}finally{l.f()}}}}catch(e){a.e(e)}finally{a.f()}}}]),t}(NM);!function(e){e.COMMON="Common",e.INVERTED_INDEX="InvertedIndex",e.SORT="Sort",e.AI="AI",e.CONDITION="Condition"}(bM||(bM={}));var xM,ZM,DM,PM={isDirtyAlwaysCalc:!1},LM=function(e){function t(e,n,r){var a,o;return(0,y.Z)(this,t),(o=(0,d.Z)(this,(0,v.Z)(t).call(this,{OpService:VM,I18nService:MM,ArgumentService:FM}))).calcEngine=e,o.spread=n,o.globalFormulaIds=0,o.sheetFormulaIds=new Map,o.sheetFormulas=new Map,o.dirtyFormula=[],o.asyncFormulaState={calculatingFormulas:new Set},o.handleFormulaRegistered=function(e){var t=e.getRef().sheet().id(),n=o.sheetFormulas.get(t);n||(n=new Set,o.sheetFormulas.set(t,n)),n.add(e)},o.handleFormulaUnregistered=function(e){var t,n=e.getRef().sheet().id();null===(t=o.sheetFormulas.get(n))||void 0===t||t.delete(e)},o.handleAfterWaitAsyncCalc=function(e,t){o.removeCalculatingAsyncFormula(e),o.dirtyFormula.push(e),o.markDirtyThrottle()},o.markDirtyThrottle=(0,O.default)((function(){o.markDirtyImmediately()}),5e3),o.formulaSpace=new(null!==(a=r)&&void 0!==a?a:NM)((0,c.Z)(o)),o.formulaSpace.addListener(ut.FormulaSpaceEvents.onFormulaRegistered,o.handleFormulaRegistered).addListener(ut.FormulaSpaceEvents.onFormulaUnregistered,o.handleFormulaUnregistered),o.addListener("afterWaitAsyncCalc",o.handleAfterWaitAsyncCalc),o}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"getFormulasInSheet",value:function(e){return this.sheetFormulas.get(e)}},{key:"markDirtyImmediately",value:function(){0!==this.dirtyFormula.length&&(this.calcEngine.markDirty(this.dirtyFormula.map((function(e){return e.getRef()})),PM),this.dirtyFormula.forEach((function(e){e.resolve&&(e.resolve(e.getVar()),e.resolve=void 0)})),this.dirtyFormula.length=0)}},{key:"addCalculatingAsyncFormula",value:function(e){this.asyncFormulaState.calculatingFormulas.add(e)}},{key:"removeCalculatingAsyncFormula",value:function(e){this.asyncFormulaState.calculatingFormulas.delete(e)}},{key:"getCalculatingAsyncFormulas",value:function(){return this.asyncFormulaState.calculatingFormulas}},{key:"dispose",value:function(){this.formulaSpace.removeListener(ut.FormulaSpaceEvents.onFormulaRegistered,this.handleFormulaRegistered).removeListener(ut.FormulaSpaceEvents.onFormulaUnregistered,this.handleFormulaUnregistered),this.sheetFormulas.clear(),this.sheetFormulaIds.clear()}}]),t}(ut.FormulaService);!function(e){e.SnapshotChanged="SnapshotChanged",e.EmbeddedBlockChanged="EmbeddedBlockChanged",e.PivotDataSourceRanged="PivotDataSourceRanged",e.MarkDirty="MarkDirty"}(xM||(xM={}));var BM=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e,t,n){var r;if(!Fu(t))return wR(this.name,1);var a=n.getValue();if(!a.length)return ut.VALUE_ERR_VAR;var o=e.ref.sheet();if(!o)return ut.REF_ERR_VAR;var i=t.getRef();if(!i.sheet())return ut.REF_ERR_VAR;var u=o.getCalcEngine();e.customCtx||(e.customCtx={}),e.customCtx=Object.assign({markDirtyCache:!0,markDirtyCube:!0,isPassive:null===(r=u.pivotCalculateEngine.getPassiveEffect(a))||void 0===r||r,source:xM.MarkDirty},e.customCtx);var s=e.customCtx,l=s.markDirtyCache,c=s.isPassive,h=u.pivotCalculateEngine.pivotCalcService.calculateView(e,a,i),f=h.dataView,d=new Hc(f,{isDirtyCache:l,isPassive:c,isError:h.isError,errorType:h.errorType});return zc(d)}}]),t}(gC("PRIVATE_PIVOT_TABLE",2,0,0,cC,[{type:iC},{type:nC}]));function UM(e){return{isError:!0,errorType:e}}function HM(e){return{isError:!1,dataView:e}}!function(e){e.Cache="Cache",e.Cube="Cube",e.View="View"}(ZM||(ZM={})),function(e){e.onCacheCalculateStart="onCacheCalculateStart",e.onCacheCalculated="onCacheCalculated",e.onCubeCalculateStart="onCubeCalculateStart",e.onCubeCalculated="onCubeCalculated",e.onViewCalculateStart="onViewCalculateStart",e.onViewCalculated="onViewCalculated"}(DM||(DM={}));var WM=function(e){function t(e){var n;return(0,y.Z)(this,t),(n=(0,d.Z)(this,(0,v.Z)(t).call(this))).spread=e,n.cacheMap=new Map,n.cubeMap=new Map,n.dataViewMap=new Map,n.cacheDirtyMap=new Map,n.cubeDirtyMap=new Map,n.pivotService=e.pivotService,n}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"getCacheJSON",value:function(e){var t;return null===(t=this.cacheMap.get(e))||void 0===t?void 0:t.toJSON()}},{key:"getSnapshot",value:function(e){return this.spread.getPivotSyncModelManager().getSnapshot(e)}},{key:"getData",value:function(e,t){if(t){var n=t.sheet(),r=t.toJSON(),a=r.row,o=r.col,i=r.rowCount,u=r.colCount;return this.spread.getPivotDataSourceManagerV2().getData(n,a,o,i,u,e)}}},{key:"getHeaderData",value:function(e,t,n){if(n){var r=n.sheet(),a=n.toJSON(),o=a.row,i=a.col,u=a.colCount;return this.spread.getPivotDataSourceManagerV2().getData(r,o,i,1,u,e)}}},{key:"checkHeaderValid",value:function(e,t,n){if(!n)return!1;var r=this.getHeaderData(e,t,n);if(!r)return!1;var a=this.getSnapshot(t);if(!a||(0,se.default)(a))return!1;var o=a.cacheFieldInfo,i=n.colFrom();return function(e,t){e&&0!==e.length||(e=new Array(i||0));for(var n=0;n<t.length;n++){var r=e[n];if(void 0!==r&&""!==r&&null!==r||(r=(0,Ot.V8)(fn,(0,Ot.Og)(i+n+1))),!t[n].fieldName.includes(r.toString()))return!1}return!0}(r.data[0],(0,kt.L9)(r.formatMap,o))}},{key:"createCache",value:function(e,t,n){if(!n)return!1;var r=this.getData(e,n);if(!r)return!1;var a=r.data,o=r.formatMap,i=this.getSnapshot(t);if(!i||(0,se.default)(i)||!a.length)return!1;var u=i.cacheFieldInfo,s=i.cacheName,l=(0,Ot._R)(a,o,n.toJSON(),u,fn),c=new Ot.SL(s,l,a.slice(1),u,{t:fn,formatterService:this.pivotService.getFormatterService()});return this.cacheMap.set(t,c),!0}},{key:"updateCache",value:function(e,t,n){var r=this.cacheMap.get(t);if(!r)return!1;var a=this.getData(e,n);if(!a)return!1;var o=a.data,i=a.formatMap,u=this.getSnapshot(t);if(!u||(0,se.default)(u))return!1;var s=u.cacheFieldInfo,l=(0,Ot._R)(o,i,n.toJSON(),s,fn);return r.refresh(l,o.slice(1),s),!0}},{key:"markDirtyCache",value:function(e){this.cacheDirtyMap.set(e,!0)}},{key:"clearDirtyCache",value:function(e){this.cacheDirtyMap.set(e,!1)}},{key:"markDirtyCube",value:function(e){this.cubeDirtyMap.set(e,!0)}},{key:"clearDirtyCube",value:function(e){this.cubeDirtyMap.set(e,!1)}},{key:"isCacheDirty",value:function(e){return!!this.cacheDirtyMap.get(e)}},{key:"isCubeDirty",value:function(e){return!!this.cubeDirtyMap.get(e)}},{key:"calculateCache",value:function(e,t,n){var r=(e.customCtx||{}).source,a=this.cacheDirtyMap.get(t),o=this.cacheMap.get(t);return!a&&o?(this.getData(e,n),o):r!==xM.SnapshotChanged||this.checkHeaderValid(e,t,n)?(o?this.updateCache(e,t,n):this.createCache(e,t,n),this.clearDirtyCache(t),this.cacheMap.get(t)):void 0}},{key:"calculateCube",value:function(e){var t=this.cubeDirtyMap.get(e),n=this.cubeMap.get(e);if(!t&&n)return n;var r=this.cacheMap.get(e),a=this.getSnapshot(e);if(r&&a&&!(0,se.default)(a)&&!(0,se.default)(a.fields)){var o=(0,kt.ak)(r,a,this.pivotService);return this.cubeMap.set(e,o),this.clearDirtyCube(e),o}}},{key:"calculateView",value:function(e,t,n){var r=e.customCtx||{},a=r.markDirtyCache,o=void 0===a||a,i=r.markDirtyCube,u=void 0===i||i,s=this.dataViewMap.get(t),l=this.isCacheDirty(t),c=this.isCubeDirty(t);if(!o&&!u&&s&&!l&&!c)return this.getData(e,n),HM(s);o&&this.markDirtyCache(t),u&&this.markDirtyCube(t),this.emit(DM.onCacheCalculateStart,t);var h=this.calculateCache(e,t,n);if(this.emit(DM.onCacheCalculated,t,Boolean(h)),!h)return console.log("[PIVOT] calculate cache error @blockToken: ",t),UM(ZM.Cache);this.emit(DM.onCubeCalculateStart,t);var f=this.calculateCube(t);if(this.emit(DM.onCubeCalculated,t,Boolean(f)),!f)return console.log("[PIVOT] calculate cube error @blockToken: ",t),UM(ZM.Cube);this.emit(DM.onViewCalculateStart,t);var d=this.getSnapshot(t);if(!d||(0,se.default)(d)||(0,se.default)(d.fields))return console.log("[PIVOT] calculate view error @blockToken: ",t),this.emit(DM.onViewCalculated,t,!1),UM(ZM.View);var v=(0,kt.MP)(h,f,d,this.pivotService);return this.dataViewMap.set(t,v),this.emit(DM.onViewCalculated,t,!0),HM(v)}},{key:"getDataView",value:function(e){return this.dataViewMap.get(e)}},{key:"getDataSourceInfo",value:function(e,t){var n;return null===(n=this.cacheMap.get(e))||void 0===n?void 0:n.getDataSourceInfo(t)}},{key:"reset",value:function(){this.cacheMap.forEach((function(e){return e.reset()})),this.cacheMap.clear(),this.cubeMap.forEach((function(e){return e.dispose()})),this.cubeMap.clear(),this.dataViewMap.forEach((function(e){return e.destroy()})),this.dataViewMap.clear(),this.cacheDirtyMap.clear(),this.cubeDirtyMap.clear(),this.pivotService.dispose()}},{key:"dispose",value:function(){this.reset()}}]),t}(we.vpe),jM=new Set(["AI_WRITE","AI_DEEPSEEK_WRITE","AI_ASK","AI_CLASSIFY","AI_EXTRACT","AI_IMPORTDATA","AI_INFER","AI_POLISH","AI_SENTIMENT","AI_SUMMARY","AI_TRANSLATE"].concat(["IMPORTRANGE","LOOKUP","RAND","TODAY","NOW","COLUMN","COLUMNS","VLOOKUP","XLOOKUP","XMATCH","ROW","ROWS","QUERY","OFFSET","MATCH","INDEX","HLOOKUP","HYPERLINK"])),zM=function(e){function t(e){var n;return(0,y.Z)(this,t),(n=(0,d.Z)(this,(0,v.Z)(t).call(this))).pivotIllegalFuncs=jM,n.spread=e,n.calcEngine=new YJ,n.compiler=new GM(n.calcEngine),n.builders=new Map,n.formulaVarsMap=new Map,n.dependencyMap=new Map,n}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"translateFieldName",value:function(e){return"'"+e+"'"}},{key:"compileFormula",value:function(e,t,n){for(var r=Uy.getTractorParserA1().getBaseCstVisitorConstructor(),a=n.concat(),o=0;o<a.length;o++){var i=a[o],u=this.translateFieldName(i);a[o]=u}var s=new(function(e,t){var n=new Set(t);return function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"referenceFunction",value:function(e){if(void 0!==e.LocalReferenceA1){var t=e.LocalReferenceA1[0].image;this.visitLocalRef(t)}else if(void 0!==e.ExternalReferenceA1){var r=e.ExternalReferenceA1[0].image;this.visitExternalRef(r)}else if(void 0!==e.RefConstant)this.visitError(ut.REF_ERR_VAR.getValue());else if(void 0!==e.Name)this.visitNameRef(e);else if(void 0!==e.FieldNameLocalReferenceA1)this.visitFieldNameRef(e,n);else if(void 0!==e.parenExp)this.visit(e.parenExp);else{if(void 0===e.funcExp)throw new Error("Invalid token in the referenceFunction expression!");this.visit(e.funcExp)}}}]),t}(Ow(xw(e)))}(r,a));this.builders.set(e,s),this.compiler.setVisitBuilder(s);var l={spread:this.spread,ref:new Zi(-1,-1,this.spread.getActiveSheet()),enableCalculation:!0},c=this.compiler.compile(t,l),h=c.errors,f=c.formulaVar;if(h||!f)return{errors:h,dependency:{},formulaVar:null,functionNames:null};var m=this.getFunctionInVar(f),p=m.functionNameSet,_=m.hasIllegalFunc,R=this.builders.get(e).getRefs(),w={};for(var k in R)w[k]=R[k].namespace();return{errors:h,dependency:w,formulaVar:f,builder:s,functionNames:p,hasIllegalFunc:_}}},{key:"decompileFormula",value:function(e,t){var n=e.formula.tokens;if(null===n)throw new Error("failed to decompile formula without tokens");return Cf({tokens:n,refStringGen:function(e){return t[e]},params:e.formula.params})}},{key:"decompile",value:function(e,t,n){var r=this.compileFormula(e,t,n),a=r.formulaVar,o=r.errors,i=r.dependency;try{if(!o&&a)return this.decompileFormula(a,i)}catch(e){console.error("Error decompiling formula:",e)}return t}},{key:"initFormula",value:function(e,t,n,r){var a=this.compileFormula(e,n,r),o=a.formulaVar,i=a.errors,u=a.dependency;return i||!o?(this.updateFormulaMap(e,t,null,{}),{errors:i,dependency:{},formulaVar:null}):(this.updateFormulaMap(e,t,o,u),{errors:i,dependency:u,formulaVar:o})}},{key:"updateFormulaMap",value:function(e,t,n,r){void 0===this.formulaVarsMap.get(e)&&this.formulaVarsMap.set(e,{}),this.formulaVarsMap.get(e)[t]=n,void 0===this.dependencyMap.get(e)&&this.dependencyMap.set(e,{}),this.dependencyMap.get(e)[t]=r}},{key:"getFunctionInVar",value:function(e){for(var t=new Set,n=e.formula.expression,r=!1,a=n.length-1;a>=0;a--){var o=n[a];if(o.isOp()){var i=o.op();if(i instanceof ut.FuncOpBase){var u=i.name;this.pivotIllegalFuncs.has(u)&&(r=!0),t.add(u)}}}return{functionNameSet:t,hasIllegalFunc:r}}},{key:"getValue",value:function(e,t,n){var r,a,o,i=this.builders.get(e),u=null===(r=this.formulaVarsMap.get(e))||void 0===r?void 0:r[t],s=null===(a=this.dependencyMap.get(e))||void 0===a?void 0:a[t];if(!i||!u||!s)throw Error("");var l=u.getRefMap();for(var c in u.markDirty(),l){var h=s[c],f=h.length;"'"===h[0]&&"'"===h[f-1]&&(h=h.substr(1,f-2)),l[c].setData(n[h])}var d=u.calc().getVar(),v=d.getValue();return d.isError()&&void 0!==d.errorCode?{isError:!0,value:v,errorCode:d.errorCode,errorInfoArgs:null===(o=d.info)||void 0===o?void 0:o.args}:{isError:!1,value:v}}},{key:"getRefList",value:function(e,t){var n,r,a=null===(n=this.formulaVarsMap.get(e))||void 0===n?void 0:n[t],o=null===(r=this.dependencyMap.get(e))||void 0===r?void 0:r[t],i=[];if(a&&o){var u=a.getRefMap();for(var s in u){var l=o[s],c=l.length;"'"===l[0]&&"'"===l[c-1]&&(l=l.substr(1,c-2)),i.push(l)}}return i}},{key:"renameField",value:function(e,t,n,r){var a=this.builders.get(e),o=null==a?void 0:a.getTokens();return a&&o?o.map((function(e){var a=t[e];return a?a===n?r:a:e})).join():""}}]),t}(kt.G7),GM=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"compile",value:function(e,t){var n;void 0===t.refStyle&&(t.refStyle="A1");var r,a=[],o=this.compileTokens(e,"A1"),i=o.lexer,u=_n(null!==(n=o.errors)&&void 0!==n?n:[]);try{for(u.s();!(r=u.n()).done;){var s=r.value;a.push(s)}}catch(e){u.e(e)}finally{u.f()}var l=Uy.getTractorParserA1(Ks);l.input=o.tokens;var c,h=l.entry(),f=_n(l.errors);try{for(f.s();!(c=f.n()).done;){var d=c.value;a.push(d)}}catch(e){f.e(e)}finally{f.f()}if(a.length>0)return{formulaVar:null,lexer:i,parser:l,errors:a};var v=null;try{v=this.builder.visitTree(h,t)}catch(e){a.push(e)}if(null==v)return{formulaVar:null,lexer:i,parser:l,errors:a};var g=this.calcEngine.formulaRefService.fromBuilder(this.builder,t.ref,null,v,null,!0),m=(0,p.Z)(g,2),y=m[0],C=m[1],_=this.calcEngine.createFormula(t.ref,{refMap:C,formula:y,isArrayFormula:this.builder.isArrayFormula}),R={};for(var w in C)R[w]=new tf(C[w].namespace(),C[w],[]);return _.setRefMap(R),{formulaVar:_,lexer:i,parser:l,errors:0===a.length?null:a}}},{key:"compileTokens",value:function(e,t){var n=Qs(e,t),r=n.lexingResult,a=r.tokens,o=r.errors;return{tokens:a,lexer:n.lexer,errors:0===o.length?null:o}}}]),t}(Yw),JM=Symbol(),qM=Symbol(),$M=Symbol(),YM=function(){function e(t,n){(0,y.Z)(this,e),this.calcEngine=t,this.spread=n,this.blockRefMap=new Map,this.formulaMap=new Map,this.formulaKeyMap=new Map,this.suspended=0,this._subscribers=[],this._firstLoadFormula=!0,this._collectEffect=new Map,this._loadPinyinModuleCompleted=(0,we.n5s)(),this.pivotCalcService=new WM(n),this.syncModelManager=n.getPivotSyncModelManager(),this.bindEvents()}return(0,C.Z)(e,[{key:"suspend",value:function(){this.suspended++}},{key:"resume",value:function(){this.suspended<=0||this.suspended--}},{key:"isSuspended",value:function(){return this.suspended>0}},{key:"bindEvents",value:function(){this._subscribers.push(this.spread.subscribe(this.getWorkbookEvents()),this.syncModelManager.subscribe(this.getPivotSyncModelEvents())),this.calcEngine.formulaService.addListener(ut.FormulaEvents.onFormulaValueChanged,this.handleFormulaValueChanged)}},{key:"unbindEvents",value:function(){this._subscribers.forEach((function(e){return e.unsubscribe()})),this.calcEngine.formulaService.removeListener(ut.FormulaEvents.onFormulaValueChanged,this.handleFormulaValueChanged)}},{key:"getWorkbookEvents",value:function(){return{EmbeddedBlockChanged:this.handleEmbeddedBlockChanged,PivotDataSourceChanged:this.handleDataSourceChanged}}},{key:"collectEffect",value:function(e){var t,n=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];this._collectEffect.get(e)||this._collectEffect.set(e,[]),null===(t=this._collectEffect.get(e))||void 0===t||t.push(n)}},{key:"getPassiveEffect",value:function(e){if(this._collectEffect.get(e))return this._collectEffect.get(e).every(Boolean)}},{key:"resumeEffect",value:function(e){this._collectEffect.delete(e)}},{key:"loadPinyinModule",value:function(){var e=this;(0,we.QFC)().finally((function(){e.onLoadPinyinCompleted()}))}},{key:"onLoadPinyinCompleted",value:function(){this._loadPinyinModuleCompleted=!0;var e,t=[],n=_n(this.formulaMap.values());try{for(n.s();!(e=n.n()).done;){var r=e.value;r.markDirty(),t.push(r.getRef())}}catch(e){n.e(e)}finally{n.f()}this.calcEngine.markDirty(t)}},{key:"getPivotSyncModelEvents",value:function(){return{SnapshotChanged:this.handlePivotSnapshotChanged}}},{key:"addPivotCalcEventListener",value:function(e){for(var t in e){var n=e[t];this.pivotCalcService.addListener(t,n)}}},{key:"removePivotCalcEventListener",value:function(e){for(var t in e){var n=e[t];this.pivotCalcService.removeListener(t,n)}}},{key:"getTokenByFormula",value:function(e){if(rh(e)){var t=this.getFormulaKeyByFml(e);if(t)return this.formulaKeyMap.get(t)}}},{key:"getPivotSheetByBlockToken",value:function(e){var t,n=this.formulaMap.get(e);if(n)return null===(t=n.getRef())||void 0===t?void 0:t.sheet()}},{key:"markDirtyByBlockToken",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};this.handleFormulaCalc(e,Object.assign({markDirtyCache:!0,markDirtyCube:!0,isPassive:!0,source:xM.SnapshotChanged},t))}},{key:"markDirtyBySheetId",value:function(e){var t,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},r=_n(this.formulaKeyMap);try{for(r.s();!(t=r.n()).done;){var a=(0,p.Z)(t.value,2),o=a[0],i=a[1],u=o.split("_"),s=(0,p.Z)(u,1),l=s[0];e===l&&this.handleFormulaCalc(i,Object.assign({markDirtyCache:!0,markDirtyCube:!0,isPassive:!0,source:xM.SnapshotChanged},n))}}catch(e){r.e(e)}finally{r.f()}}},{key:"getFormulaKeyByFml",value:function(t){if(!rh(t))return"";var n=t.getRef(),r=t.getId(),a=null==n?void 0:n.sheet();if(!n||!r||!a)return"";var o=a.id();return e.getFormulaKey(o,r)}},{key:"getFormulaKeys",value:function(){return Array.from(this.formulaKeyMap.keys())}},{key:"handleFormulaValueChanged",value:function(e){var t=this.getFormulaKeyByFml(e);if(t){var n=this.formulaKeyMap.get(t);if(void 0!==n){this.resumeEffect(n);var r=e.getState().cache;if(null!=r){var a=e.getRef().sheet();if(a){var o=r.getRawVar();a.dispatch("PivotFormulaCalculated",{blockToken:n,sheetId:a.id()});var i=o.getValue();this._watchExpandArea(e,o.type===ut.VAR_TYPE.CUSTOM_PRIMITIVE&&(null==i?void 0:i.dataView)instanceof kt.b$?this.getArrayRefByFml(e):null),this.calcEngine.pivotStatistics.isFirstApplyResult||this.calcEngine.pivotStatistics.onFirstApplyResult(1)}}}}}},{key:"getPivotFormulaCount",value:function(){return this.formulaMap.size}},{key:"getArrayRefByFml",value:function(e){var t;if(!rh(e))return[];var n=e.getRef(),r=n.sheet();if(!r)return[];var a=e.getState().cache;if(!a)return[];var o=null===(t=a.getRawVar().getValue())||void 0===t?void 0:t.dataView;if(o instanceof kt.b$){var i=o.getRangeSize(),u=mk(r,n.startRow,n.startCol,i.page,i.content);return[u.pageRange,u.contentRange].filter(Boolean)}return[new Oi(n.startRow,n.startCol,1,1,r)]}},{key:"handlePivotSnapshotChanged",value:function(e){var t=e.blockToken,n=e.data;if("snapshotSet"===n.type)this.handleFormulaCalc(t,{markDirtyCache:!0,markDirtyCube:!0,isPassive:n.isPassive,source:xM.SnapshotChanged});else{var r=n.prevSnapshot,a=n.snapshot,o=n.isPassive,i=n.ops,u=(null==r?void 0:r.rangeId)!==(null==a?void 0:a.rangeId)||i.some((function(e){var t,n;return null===(t=e._pivotExtra)||void 0===t||null===(n=t.rebuildCache)||void 0===n?void 0:n.needRebuild}))||o&&i.some((function(e){return e.p.includes("cacheFieldInfo")}));this.handleFormulaCalc(t,{markDirtyCache:u,markDirtyCube:!0,isPassive:o,source:xM.SnapshotChanged})}}},{key:"handleDataSourceChanged",value:function(e){var t=e.blockToken,n=e.source,r=this.blockRefMap.get(t);r&&n!==ZA.FORMULA_REF_ADJUST&&this.setPivotTableFormula(t,r)&&this.handleFormulaCalc(t,{markDirtyCache:!0,markDirtyCube:!0,isPassive:n===ZA.PASSIVE,source:xM.PivotDataSourceRanged})}},{key:"handleEmbeddedBlockChanged",value:function(e,t,n){var r=e.embeddedBlockChangeParams,a=e.sheetId,o=function(e){return!e||e===VA.UNDO||e===VA.REDO||e===VA.COLLA}(n),i=r.changeType,u=r.blockToken,s=r.embeddedBlock;switch(i){case 2:return void this.deletePivotTableFormula(u);case 1:var l=s.position,c=this.spread.getSheetFromId(a),h=new Zi(l.row,l.col,c);return this.blockRefMap.set(u,h),void(this.formulaMap.get(u)?this.handleFormulaCalc(u,{markDirtyCache:!1,markDirtyCube:!1,isPassive:!0,source:xM.EmbeddedBlockChanged}):this.setPivotTableFormula(u,h)&&this.handleFormulaCalc(u,{markDirtyCache:!0,markDirtyCube:!0,isPassive:o,source:xM.EmbeddedBlockChanged}));case 3:return void this.handleFormulaCalc(u,{markDirtyCache:!1,markDirtyCube:!1,isPassive:!0,source:xM.EmbeddedBlockChanged})}}},{key:"getFormula",value:function(e){return this.formulaMap.get(e)}},{key:"getFormulaByPos",value:function(e,t,n){var r,a=_n(this.formulaMap.values());try{for(a.s();!(r=a.n()).done;){var o,i=r.value,u=i.getRef();if(u.rowFrom()===e&&u.colFrom()===t&&(null===(o=u.sheet())||void 0===o?void 0:o.id())===n)return i}}catch(e){a.e(e)}finally{a.f()}}},{key:"createFormulaStr",value:function(e){var t=this.spread.getPivotDataSourceManagerV2().getSourceRange(e);return t?"PRIVATE_PIVOT_TABLE(".concat(t.toString({isShowSheetName:!0,ref:t}),', "').concat(e,'")'):""}},{key:"setPivotTableFormula",value:function(e,t){if(this.isSuspended())return!1;var n=this.createFormulaStr(e);if(!n||!t)return!1;var r=this.calcEngine.compile(n,{spread:this.spread,ref:t}),a=r.formulaVar;if(r.errors||!a)return!1;this.formulaMap.get(e)&&this.deletePivotTableFormula(e),a.setId(e),this.calcEngine.formulaSpace.registerFml(a);var o=this.getFormulaKeyByFml(a);if(!o)return!1;this._initializeFormulaRefWatcher(a),this.formulaKeyMap.set(o,e),this.formulaMap.set(e,a),this.blockRefMap.set(e,t),this.calcEngine.pivotStatistics.add(t.hostId,Jb.FormulaCount);var i=!(this.calcEngine instanceof KJ);return this._firstLoadFormula&&i&&!this._loadPinyinModuleCompleted&&(this._firstLoadFormula=!1,(0,we.n5s)()?this.onLoadPinyinCompleted():this.loadPinyinModule()),this.calcEngine.pivotStatistics.isModuleInit||this.calcEngine.pivotStatistics.initModule(),!0}},{key:"deletePivotTableFormula",value:function(e){var t=this.formulaMap.get(e);if(t){for(var n=[qM,JM,$M],r=0;r<n.length;++r){var a=n[r];t[a]&&(t[a](),t[a]=null)}this.calcEngine.formulaSpace.unRegisterFml(t);var o=this.getFormulaKeyByFml(t);this.formulaKeyMap.delete(o),this.formulaMap.delete(e),this.calcEngine.pivotStatistics.sub(t.getRef().hostId,Jb.FormulaCount),this.blockRefMap.delete(e)}}},{key:"_initializeFormulaRefWatcher",value:function(e){var t=this,n=this.calcEngine.depRefManager,r=e.getRef();this._watchSourceArea(e);var a=r.clone();e[JM]&&e[JM](),e[JM]=n.watchRef(r,null,null,(function(n,o){var i=a.startRow-n.startRow,u=a.startCol-n.startCol;a=r.clone();for(var s={},l=Object.keys(e.refMap),c=0;c<l.length;++c)s[l[c]]=Xo(e.refMap[l[c]],i,u);e.refMap=s;var h=r.sheet(),f=t.getTokenByFormula(e);if(h&&f){var d=h.getPivotTableManager(),v=d.getPivotInfoByToken(f);if(v){var g,m,p=Object.assign({},v,{pageRange:null===(g=v.pageRange)||void 0===g?void 0:g.clone(),contentRange:null===(m=v.contentRange)||void 0===m?void 0:m.clone()});d.updatePivotTableInfoByPosition(f,r.startRow,r.startCol);var y=d.getPivotInfoByToken(f),C=[p.pageRange,p.contentRange,p.spanRange,null==y?void 0:y.pageRange,null==y?void 0:y.contentRange,null==y?void 0:y.spanRange].filter(Boolean);e.markDirty(),t.calcEngine.markDirty(C,{pivotToken:f}),C.forEach((function(e){h.dispatch("PivotTableRangeChanged",{range:e})}))}}})),e[$M]&&e[$M](),e[$M]=null}},{key:"updateFormulaRefs",value:function(e,t){var n=t.getRef();t.refMap={R1:Si(e,n)},this._watchSourceArea(t);var r=n.sheet();if(r){var a=r.getPivotTableManager().getPivotInfoByToken(t.getId());a&&[a.pageRange,a.contentRange,a.spanRange].filter(Boolean).forEach((function(e){r.dispatch("PivotTableRangeChanged",{range:e})}))}}},{key:"_watchSourceArea",value:function(e){var t=this;e[qM]&&e[qM](),e[qM]=this.calcEngine.depRefManager.watchRef(ki(e.refMap.R1,e.getRef()),(function(n,r){e.isDirty()||t.markDirtyFormula(e)}),null,(function(n,r){t.updateFormulaRefs(n,e),t.markDirtyFormula(e,{markDirtyCache:!0,markDirtyCube:!0})}),(function(n,r){t.updateFormulaRefs(n,e),t.markDirtyFormula(e,{markDirtyCache:!0,markDirtyCube:!0})}))}},{key:"_watchExpandArea",value:function(e,t){var n=this;e[$M]&&(e[$M](),e[$M]=null),t&&t.length&&(e[$M]=this.calcEngine.depRefManager.watchRefs(t,(function(r,a,o){var i,u=e.getRef(),s=u.sheet();if(s){var l=n.getFormulaKeyByFml(e);if(l){var c=n.formulaKeyMap.get(l);if(c&&(null==a?void 0:a.pivotToken)!==c){var h=null===(i=e.getState().cache)||void 0===i?void 0:i.getRawVar();if(h){r&&(n.markDirtyFormula(e),t.forEach((function(e){s.dispatch("PivotTableRangeChanged",{range:e})})));var f=h.getValue();if((null==f?void 0:f.dataView)instanceof kt.b$){if(o&&o.some((function(e){return function(e,t){return e.startRow===t.startRow&&e.endRow===t.endRow&&e.startCol===t.startCol&&e.endCol===t.endCol&&e.hostId===t.hostId&&e.hostName==e.hostName&&e.status==e.status}(u,e)})))return;var d=s.getPivotTableManager().getPivotErrorStateByCell(u.startRow,u.startCol)!==Zf.None;if(h.type===ut.VAR_TYPE.CUSTOM_PRIMITIVE){var v=f.dataView.getRangeSize(),g=mk(s,u.startRow,u.startCol,v.page,v.content),m=[g.pageRange,g.contentRange].filter(Boolean);if((!o||o.some((function(e){return function(e){return m.some((function(t){return t.isIntersect(e)}))}(e)})))&&m.some((function(e){return!function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:[],r=e.getPivotTableManager(),a=t.rowFrom(),o=t.colFrom();if(a<0||o<0)return!1;var i=t.rowCount(!0),u=t.colCount(!0),s=e.getRowCount(),l=e.getColumnCount(),c=o+u>l?o+u-l:0,h=a+i>s?a+i-s:0,f=(0,we.$$w)();if((c||h)&&(s+h)*(l+c)>f)return!1;if(i!==t.rowCount(!0)||u!==t.colCount(!0))return!1;if(e.checkRangesProtected(t))return!1;if(r.isIntersectPivotTable(a,o,i,u,n))return!1;var d=function(){return e._spanModel.iter(t.rowFrom(),t.colFrom(),t.rowTo(),t.colTo(),!0).next()},v=function(){return e._getModel().iterDataValidation(t.rowFrom(),t.colFrom(),t.rowCount(),t.colCount()).next()};return!(e._getModel().iterContent(t.rowFrom(),t.colFrom(),t.rowCount(),t.colCount(),!0).next()||d()||v())}(s,e,[c])}))===d)return void n._watchExpandArea(e,m)}s.dispatch("PivotFormulaCalculated",{blockToken:c,sheetId:s.id()})}}}}}})))}},{key:"handleFormulaCalc",value:function(e,t){var n;this.collectEffect(e,null!==(n=t.isPassive)&&void 0!==n&&n);var r=this.formulaMap.get(e);if(!r)return!1;if(!this._loadPinyinModuleCompleted)return!1;t.isPassive=this.getPassiveEffect(e),this.resumeEffect(e);var a=t||{markDirtyCache:!0,markDirtyCube:!0,isPassive:!0},o={calcId:-1,executeMode:ut.ExecuteMode.FORCE,customCtx:a};return this.markDirtyFormula(r),r.calc(o),!0}},{key:"markDirtyFormula",value:function(e,t){var n=this.getFormulaKeyByFml(e),r=this.formulaKeyMap.get(n);t&&r&&(t.markDirtyCache&&this.pivotCalcService.markDirtyCache(r),t.markDirtyCube&&this.pivotCalcService.markDirtyCube(r)),e.markDirty(),this.calcEngine.markDirty([e.getRef()],{isDirtyAlwaysCalc:!1,pivotToken:e.getId()})}},{key:"resetFormula",value:function(){this.formulaMap.clear(),this.formulaKeyMap.clear()}},{key:"destoryBySheetId",value:function(e){var t,n=_n(this.formulaKeyMap);try{for(n.s();!(t=n.n()).done;){var r=(0,p.Z)(t.value,2),a=r[0],o=r[1],i=a.split("_");e===(0,p.Z)(i,1)[0]&&(this.blockRefMap.delete(o),this.formulaMap.delete(o),this.formulaKeyMap.delete(a),this.syncModelManager.deleteSyncModel(o))}}catch(e){n.e(e)}finally{n.f()}this.calcEngine.pivotStatistics.remove(e)}},{key:"dispose",value:function(){this.unbindEvents(),this.syncModelManager.dispose(),this.pivotCalcService.reset(),this.blockRefMap.clear(),this.resetFormula()}}],[{key:"getFormulaKey",value:function(e,t){return"".concat(e,"_").concat(t)}}]),e}();Gi([(0,Nt.Bind)()],YM.prototype,"handleFormulaValueChanged",null),Gi([(0,Nt.Bind)()],YM.prototype,"handlePivotSnapshotChanged",null),Gi([(0,Nt.Bind)()],YM.prototype,"handleDataSourceChanged",null),Gi([(0,Nt.Bind)()],YM.prototype,"handleEmbeddedBlockChanged",null);var KM=function(){return ut.REF_ERR_VAR},XM=function(e){function t(e){var n;return(0,y.Z)(this,t),(n=(0,d.Z)(this,(0,v.Z)(t).call(this,e[0]))).refs=e,n}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"iter",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{skipEmptyRef:!0};return void 0===e.skipEmptyRef&&(e.skipEmptyRef=!0),new mu(this.getRefs(),e)}},{key:"getRefs",value:function(){return this.refs}},{key:"size",value:function(){for(var e=0,t=this.getRefs(),n=0;n<t.length;n++)e+=t[n].size();return e}},{key:"getRawVarByIndex",value:function(e){var t=this.refs.find((function(t){return t.size()>e||(e-=t.size(),!1)}));if(void 0===t)return ut.NULL_VAR;var n=this.getSheetByRange(t);if(n instanceof ut.ErrorVar)return n;var r=t.colCount();return n.getVar(t.rowFrom()+Math.floor(e/r),t.colFrom()+e%r)}},{key:"getVar",value:function(){return we.d$b[we.O6N.INVALID_CELL_REFERENCE]({funcName:"",index:-1,value:""})}},{key:"equals",value:function(e){if(e instanceof t){var n=this.getRefs(),r=e.getRefs();return n.length===r.length&&n.every((function(e,t){return e.equal(r[t])}))}return!1}},{key:"iterIf",value:function(e){var t=this,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{skipEmptyRef:!0},r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:mu;void 0===n.skipEmptyRef&&(n.skipEmptyRef=!0);var a=new r(this.getRefs(),n),o=0,i=0,u=this.getRefs(),s=u[o],l={row:void 0,col:void 0};return a.filter((function(r){if(i>=s.size()){if(o++,!(s=u[o]))return!1;i=0}l.row=a.getCurrRow(),l.col=a.getCurrCol();var c=e.every((function(e){return e(r,n,t,s,l)}));return i++,c}))}},{key:"iterWithPos",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{skipEmptyRef:!0};void 0===e.skipEmptyRef&&(e.skipEmptyRef=!0);var t=new mu(this.getRefs(),e),n=new Array(3);return t.map((function(e){return n[0]=e,n[1]=t.getCurrRow(),n[2]=t.getCurrCol(),n}))}},{key:"clone",value:function(){return new t(this.getRefs().map((function(e){return e.clone()})))}},{key:"isValid",value:function(){return this.getRefs().every((function(e){return e.isValid()}))}},{key:"toRefMatrix",value:function(){var e=new ku(this);return e.getVarByPos=KM,e}},{key:"customType",get:function(){return"MultipleRefsVar"}}]),t}(Su),QM=function(e){function t(){var e;return(0,y.Z)(this,t),(e=(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))).operands=2,e.optionOperands=0,e.resultType=ut.VAR_TYPE.COLLECTION,e.paramsDesc=[iw.SHEET_REF,iw.SHEET_REF],e}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e,t,n){var r,a=bu(t)?t.getRefs():[t.getRef()],o=bu(n)?n.getRefs():[n.getRef()],i=this.opImpl(a,o);if(i.isError())return i;var u=bu(i)?i.getRefs():[i.getRef()];return e.info&&(Array.isArray(e.info.customDepends)?(r=e.info.customDepends).push.apply(r,(0,m.Z)(u)):e.info.customDepends=Array.from(u)),i}}]),t}(ut.BinaryOpBase),eV=function(e){function t(){var e;return(0,y.Z)(this,t),(e=(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))).name=":",e}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"opImpl",value:function(e,t){var n=oc(e),r=oc(t);return n.isError()?n:r.isError()?r:oc([n.getRef(),r.getRef()])}}]),t}(QM),tV=function(e){function t(){var e;return(0,y.Z)(this,t),(e=(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))).name=" ",e}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"opImpl",value:function(e,t){var n=[];return e.forEach((function(e){t.forEach((function(t){var r=e.intersect(t);null!=r&&n.push(r)}))})),0===n.length?ut.NULL_ERR_VAR:1===n.length?new Su(n[0]):new XM(n)}}]),t}(QM),nV=function(e){function t(){var e;return(0,y.Z)(this,t),(e=(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))).name=",",e}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"opImpl",value:function(e,t){var n=[];return Array.prototype.push.apply(n,e),Array.prototype.push.apply(n,t),new XM(n)}}]),t}(QM),rV=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e,t,n,r,a){var o=this,i=[],u=n.getValue(),s=t.getRef().sheet();if(s){var l=this.getBetweenNumbers(r,a),c=l.number1,h=l.number2;t.iterIf([function(e,t,n,r,a){return o.numberCompare(s,a,u,c,h,t)||i.push(new ut.StringVar("".concat(a.row,"_").concat(a.col))),!1}],Object.assign({skipEmptyRef:!1},e)).forEach((function(){}))}return new Ru([i])}},{key:"tryParseStr2Float",value:function(e){var t=parseFloat(e);return Number.isNaN(t)?e:t}},{key:"numberCompare",value:function(e,t,n,r,a,o){var i=e.getValue(t.row,t.col,void 0,o);if(null===i)return!1;switch(n){case 0:return"string"==typeof r&&"string"==typeof i?r.trim()===i.trim():i===r;case 1:return"string"==typeof r&&"string"==typeof i?r.trim()!==i.trim():i!==r;case 2:return i>r;case 3:return i>=r;case 4:return i<r;case 5:return i<=r;case 6:return r<=i&&i<=a;case 7:return!(r<=i&&i<=a);default:return!1}}},{key:"getBetweenNumbers",value:function(e,t){var n=this.tryParseStr2Float(e.getValue()),r=t.isNull()?n:this.tryParseStr2Float(t.getValue());return n>r?{number1:r,number2:n}:{number1:n,number2:r}}}]),t}(gC("PRIVATE_CELLIS",3,1,0,iC,[iw.SHEET_REF,{type:tC},{type:nC},{type:nC|eC,default:ut.NULL_VAR}])),aV=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e,t,n,r){var a=this,o=[],i=n.getValue(),u=t.getRef().sheet(),s=r.getValue().toUpperCase();return u&&t.iterIf([function(t,n,r,l,c){return a.textCompare(u,c,i,s,e)?o.push(ut.BOOLEAN_VAR_MAP[ut.BooleanConstant.TRUE]):o.push(ut.BOOLEAN_VAR_MAP[ut.BooleanConstant.FALSE]),!1}],Object.assign({skipEmptyRef:!1},e)).forEach((function(){})),new Ru([o])}},{key:"textCompare",value:function(e,t,n,r,a){var o=e.getText(t.row,t.col,void 0,!0,a,!0).toUpperCase();switch(n){case 0:return o.startsWith(r);case 5:return!o.startsWith(r);case 1:return o.endsWith(r);case 6:return!o.endsWith(r);case 2:return o.includes(r);case 3:return!o.includes(r);case 4:return o===r;default:return!1}}}]),t}(gC("PRIVATE_CELL_CONTAINTEXT",3,0,0,iC,[iw.SHEET_REF,{type:tC},{type:nC},{type:rC}])),oV=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e,t,n,r){var a=this,o=[],i=n.getValue(),u=t.getRef().sheet(),s=r.getValue().toUpperCase();return u&&t.iterIf([function(e,t,n,r,l){return a.textCompare(u,l,i,s)||o.push(new ut.StringVar("".concat(l.row,"_").concat(l.col))),!1}],Object.assign({skipEmptyRef:!1},e)).forEach((function(){})),new Ru([o])}},{key:"textCompare",value:function(e,t,n,r){var a=e.getText(t.row,t.col).toUpperCase();switch(n){case 2:return 0===(0,ee.Z)(a).indexOf(r);case 3:return 0!==(0,ee.Z)(a).indexOf(r);case 4:var o=(0,X.Z)(a);return-1!==o.indexOf(r,o.length-r.length);case 5:var i=(0,X.Z)(a);return-1===i.indexOf(r,i.length-r.length);case 6:return-1!==a.indexOf(r);case 7:return-1===a.indexOf(r)}return!1}}]),t}(gC("PRIVATE_CONTAINTEXT",3,0,1,iC,[iw.SHEET_REF,{type:tC},{type:nC},{type:nC}])),iV=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e,t,n){var r,a=[],o=n.getValue(),i=t.getValue(),u=!1;i>o&&(o=(r=[i,o])[0],i=r[1],u=!0);for(var s=arguments.length,l=new Array(s>3?s-3:0),c=3;c<s;c++)l[c-3]=arguments[c];for(var h=function(){var t=d[f],n=[];t.iter(Object.assign({},e,{skipEmptyRef:!1})).forEach((function(e){return n.push(uV(e,i,o,u))})),a.push(n)},f=0,d=l;f<d.length;f++)h();var v=0;i<0&&(v=Math.abs(Number((o>0?i/(o-i):1).toFixed(3))));var g=new Ru(a);return g.setSpecialInfo({ratio:v,maxValue:o,minValue:i}),g}}]),t}(gC("PRIVATE_DATA_BAR",2,256,1,iC,[{type:tC},{type:tC},iw.SHEET_REF]));function uV(e,t,n){var r=arguments.length>3&&void 0!==arguments[3]&&arguments[3];if(!e.isNumber())return new ut.NullVar;var a=e.getValue(),o=0,i=function(){return Math.abs(a)===Math.abs(t)?a<0?-.5:.5:Math.abs(a)<Math.abs(t)?0:o=a/Math.abs(a)},u=function(){return a<t?0:(a-t)/(n-t)},s=function(){return a>n?0:(a-n)/Math.abs(t-n)},l=function(){return a>=0?a/Math.abs(n):a/Math.abs(t)};return o=t===n?i():t>=0?u():n<=0?s():l(),Math.abs(o)>1&&(o=o<0?-1:1),Math.abs(o)>1&&(o=o<0?-1:1),Number.isNaN(o)&&(o=0),r&&(o=o<0?-1-o:1-o),new ut.NumberVar(Number(o.toFixed(3)))}function sV(e,t,n){var r=e.get(t);return null==r&&(r=new Set,e.set(t,r)),!!r.has(n)||(r.add(n),!1)}iV=Gi([cc("PRIVATE_DATA_BAR")],iV);var lV=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),r=1;r<t;r++)n[r-1]=arguments[r];for(var a=new Map,o=[],i=new Map,u=new Set,s=n.length>1,l=0,c=n;l<c.length;l++){var h=c[l];h.iterIf([function(e,t,n,r,a){var o=a.row,u=a.col;return!(""===e.getValue()||e.isNull()||s&&sV(i,o,u))}],e).forEach((function(e){var t=e.getValue();if(e.isNumber()&&(t=(0,Se.toPrecision)(t)),sV(a,e.type,t)){var n="".concat(e.type,"_").concat(t);u.has(n)||(o.push(e),u.add(n))}}))}return new Ru([o])}}]),t}(gC("PRIVATE_DUPLICATE",1,256,1,iC,[iw.SHEET_REF,iw.SHEET_REF])),cV=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e){return new Su(e.ref)}}]),t}(gC("PRIVATE_GET_REF",0,0,0,iC,[])),hV=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e,t,n){return new ut.BooleanVar(t.getValue()&&n.getValue())}}]),t}(gC("PRIVATE_AND",2,0,0,rC,[{type:rC},{type:rC}])),fV=function(e){function t(){var e;return(0,y.Z)(this,t),(e=(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))).isNeedStyle=function(e,t,n){switch(n){case"greaterThan":return t>e;case"lessThan":return t<e;case"greaterThanOrEqual":return t>=e;case"lessThanOrEqual":return t<=e}return!1},e}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e,t,n){for(var r=this,a=[],o=arguments.length,i=new Array(o>3?o-3:0),u=3;u<o;u++)i[u-3]=arguments[u];for(var s=function(){var o=c[l],i=o.getRef().sheet(),u=[];o.iterWithPos(Object.assign({},e,{skipEmptyRef:!1})).forEach((function(e){var a=(0,p.Z)(e,3),o=a[0],s=a[1],l=a[2];if(!i||!o.isNumber()||i.hasCheckbox(s,l))return u.push(ut.BOOLEAN_VAR_MAP[ut.BooleanConstant.FALSE]),null;var c=o.getValue(),h=r.isNeedStyle(t.getValue(),c,n.getValue());return u.push(ut.BOOLEAN_VAR_MAP[h?ut.BooleanConstant.TRUE:ut.BooleanConstant.FALSE]),null})),a.push(u)},l=0,c=i;l<c.length;l++)s();return new Ru(a)}}]),t}(gC("PRIVATE_AVERAGE",2,255,1,iC,[{type:tC},{type:nC},iw.SHEET_REF]));fV=Gi([cc("PRIVATE_AVERAGE")],fV);var dV=function(e){function t(){var e;return(0,y.Z)(this,t),(e=(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))).calcCustomData=ut.getFirstValidCustomData,e}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),r=1;r<t;r++)n[r-1]=arguments[r];return(0,Mt.maxVar)(lc(e,n))}}]),t}(gC("PRIVATE_MAX_REFS",0,255,1,tC,[{type:tC|iC}])),vV=function(e){function t(){var e;return(0,y.Z)(this,t),(e=(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))).calcCustomData=ut.getFirstValidCustomData,e}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),r=1;r<t;r++)n[r-1]=arguments[r];return(0,Mt.minVar)(lc(e,n))}}]),t}(gC("PRIVATE_MIN_REFS",0,255,1,tC,[{type:tC|iC}])),gV=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e,t,n){return new ut.BooleanVar(t.getValue()||n.getValue())}}]),t}(gC("PRIVATE_OR",2,0,0,rC,[{type:rC},{type:rC}])),mV=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e,t){var n=t.getValue();if(n<0||n>1)return ut.NUM_ERR_VAR;for(var r=[],a=arguments.length,o=new Array(a>2?a-2:0),i=2;i<a;i++)o[i-2]=arguments[i];for(var u=0,s=o;u<s.length;u++){var l=s[u];l.iterWithPos(e).filter((function(t){var n=(0,p.Z)(t,3),r=n[0],a=n[1],o=n[2];return!(e&&e.ref&&e.ref.sheet().hasCheckbox(a,o))&&r.isNumber()})).forEach((function(t){var n=(0,p.Z)(t,1)[0];return r.push(n.getValue(e))}))}var c=r.length;if(0===c)return ut.NUM_ERR_VAR;if(1===c)return new ut.NumberVar(r[0]);if(r=r.sort((function(e,t){return e-t})),ut.NumberVar.doubleEqual(n,1))return new ut.NumberVar(r[c-1]);var h=n*(c-1),f=Math.floor(h),d=h-f,v=r[f],g=r[f+1];return new ut.NumberVar(v+d*(g-v))}}]),t}(gC("PRIVATE_PERCENTILE_REFS",1,255,1,tC,[{type:tC},{type:tC|iC}])),pV=function(e){function t(){var e;return(0,y.Z)(this,t),(e=(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))).getTargetValue=(0,N.Z)((function(e,t,n){var r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,a=e.size()||0,o=function(e){return Math.min(Math.max(t?a-e:e-1,0),a-1)};switch(n){case"sort":var i=o(r),u=e.nth(i).getValue();return Number(u);case"percent":var s=o(Math.round(a*r/100)),l=e.nth(s).getValue();return Number(l)}})),e}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e,t,n,r,a){for(var o=[],i=n.getValue(),u=r.getValue(),s=a.getValue(),l=this.getTargetValue(t,s,i,u),c=arguments.length,h=new Array(c>5?c-5:0),f=5;f<c;f++)h[f-5]=arguments[f];for(var d=function(){var t=g[v],n=t.getRef().sheet(),r=[];t.iterWithPos(Object.assign({},e,{skipEmptyRef:!1})).forEach((function(e){var t=(0,p.Z)(e,3),a=t[0],o=t[1],i=t[2];if(!n||!a.isNumber()||n.hasCheckbox(o,i))return r.push(ut.BOOLEAN_VAR_MAP[ut.BooleanConstant.FALSE]),null;var u=a.getValue(),c=s?u<=l:u>=l;return r.push(ut.BOOLEAN_VAR_MAP[c?ut.BooleanConstant.TRUE:ut.BooleanConstant.FALSE]),null})),o.push(r)},v=0,g=h;v<g.length;v++)d();return new Ru(o)}}]),t}(gC("PRIVATE_RANK",4,255,1,iC,[{type:iC},{type:nC},{type:tC},{type:rC},iw.SHEET_REF]));pV=Gi([cc("PRIVATE_RANK")],pV);var yV,CV,_V,RV=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e){for(var t=[],n=arguments.length,r=new Array(n>1?n-1:0),a=1;a<n;a++)r[a-1]=arguments[a];for(var o=0,i=r;o<i.length;o++){var u=i[o];u.iter(Object.assign({},e,{skipEmptyRef:!1})).forEach((function(e){e.isNumber()&&t.push(e)}))}return t=t.sort((function(e,t){return t.getValue()-e.getValue()})),new Ru([t])}}]),t}(gC("PRIVATE_SORT",0,255,1,iC,[iw.SHEET_REF]));function wV(e,t,n){for(var r=0,a=-1,o=t.size();o>0;){var i=SV(e,t,r+(o+1>>1)-1,r+o,n);if(i>=0){var u=EV(e,t,i,r+o),s=t.nth(u,e);if((0,ut.equals)(e,s,n))return u;(0,ut.lessThan)(e,s,n)?(o=r+o-u-1,a=u,r=u+1):o=(o+1>>1)-1}else o=(o+1>>1)-1}return a}function kV(e,t,n){var r;if(n.isString()){var a=(0,Mt.wildcardToFastRegExp)(n.getValue());r=function(e){return!!e.isString()&&a.test(e.getValue())}}else r=function(e){return n.equals(e)};var o=-1,i=-1;return t.iter(Object.assign({},e,{skipEmptyRef:!1})).first_if((function(e){return o++,!!r(e)&&(i=o,!0)})),i}function SV(e,t,n,r,a){for(var o=a.type,i=n;i<r;i++)if(t.nth(i,e).type&o)return i;return-1}function EV(e,t,n,r){for(var a=t.nth(n,e);n<r-1;){var o=t.nth(n+1,e);if(a.getValue()!==o.getValue())return n;n++}return n}function TV(e,t,n){var r=e.getRef(),a=r.rowCount(),o=r.colCount(),i=[],u=r.sheet();if(!u)return ut.REF_ERR_VAR;for(var s=0;s<a;s++){i[s]=[];for(var l=0;l<o;l++){var c=r.rowFrom()+s,h=r.colFrom()+l,f=u.getVar(c,h);i[s][l]=t(f)}}return 1!==i.length||1!==i[0].length||n?new Ru(i):i[0][0]}function AV(e,t){var n=e.ref.sheet();if(!n)return null;var r=(0,Se.getPreferredFormatter)(n.formatterService,t),a=r.formatter,o=r.value;if((0,Se.isDateTimeFormatter)(a)&&o instanceof ke.SheetDate){var i=o.toNumber();if(i>=ke.SheetDate.MIN_DATE_VALUE&&i<=ke.SheetDate.MAX_DATE_VALUE)return o}return null}function IV(e){var t=[];if("number"==typeof e)switch(e){case 1:t[6]=!0,t[0]=!0;break;case 2:t[0]=!0,t[1]=!0;break;case 3:t[1]=!0,t[2]=!0;break;case 4:t[2]=!0,t[3]=!0;break;case 5:t[3]=!0,t[4]=!0;break;case 6:t[4]=!0,t[5]=!0;break;case 7:t[5]=!0,t[6]=!0;break;case 11:t[0]=!0;break;case 12:t[1]=!0;break;case 13:t[2]=!0;break;case 14:t[3]=!0;break;case 15:t[4]=!0;break;case 16:t[5]=!0;break;case 17:t[6]=!0;break;default:return null}else{if(7!==e.length)return null;for(var n=0;n<7;n++){var r=6===n?0:n+1;switch(e[n]){case"0":t[r]=!1;break;case"1":t[r]=!0;break;default:return null}}}return t}function bV(e,t,n){if(n){if(n.isRef()&&bu(n))return ut.VALUE_ERR_VAR;if(n.isBool())return yR("",3,n.getValue().toString().toUpperCase(),ut.FormulaErrorPhrases.DATA_TYPE_BOOLEAN,ut.FormulaErrorPhrases.DATA_TYPE_DOUBLE);if(n.isNumber()){var r=Math.floor(n.getValue());if(r<0)return H_("",3);t.add(r)}else{var a;if(n.iter(Object.assign({},e,{skipEmptyRef:!0})).exitWhen((function(n){if(n.isError())return a=n,!0;var r;if(n.isNumber()&&(r=n.getValue()),n.isString()){var o=n.toNumberVar(e.service);o.isNull()||(r=o.getValue())}return void 0!==r?r<0?(a=H_("",3),!0):(t.add(Math.floor(r)),!1):(a=yR("",3,n.getValue(),ut.FormulaErrorPhrases.DATA_TYPE_STRING,ut.FormulaErrorPhrases.DATA_TYPE_DOUBLE),!0)})).forEach(P.default),a)return a.isError()?a:ut.VALUE_ERR_VAR}}}function FV(e){var t=e.getValue(),n=e.type;return e.isNumber()&&(t=(0,Se.toPrecision)(t)),"".concat(n,"_").concat(t)}function MV(e,t){var n=!(arguments.length>2&&void 0!==arguments[2])||arguments[2];return fv(dv(e.isNumber()?e.getCompareValue():e.getValue()),dv(t.isNumber()?t.getCompareValue():t.getValue()),n)}function VV(e,t,n,r){for(var a=0,o=t.rowCount()-1;a<=o;){var i=Math.floor((a+o)/2);switch(n(t.nth(i,e),i)){case 0:return;case-1:r?o=i-1:a=i+1;break;case 1:r?a=i+1:o=i-1;break;default:throw Error("Can't compare value with binary search mode.")}}}function NV(e,t,n,r){switch(n){case CV.Sequence:for(var a=0,o=t.size();a<o&&0!==r(t.nth(a,e),a);a++);break;case CV.Reverse:for(var i=t.size()-1;i>=0&&0!==r(t.nth(i,e),i);i--);break;case CV.BinaryAscending:VV(e,t,r,!0);break;case CV.BinaryDescending:VV(e,t,r,!1)}}RV=Gi([cc("PRIVATE_SORT")],RV),function(e){e[e.ExactMatch=0]="ExactMatch",e[e.SmallerExactMatch=-1]="SmallerExactMatch",e[e.LargerExactMatch=1]="LargerExactMatch",e[e.WildcardMatch=2]="WildcardMatch"}(yV||(yV={})),function(e){e[e.Sequence=1]="Sequence",e[e.Reverse=-1]="Reverse",e[e.BinaryAscending=2]="BinaryAscending",e[e.BinaryDescending=-2]="BinaryDescending"}(CV||(CV={})),function(e){e[e.Equal=0]="Equal",e[e.NotEqual=2]="NotEqual",e[e.LessThan=-1]="LessThan",e[e.GreaterThan=1]="GreaterThan"}(_V||(_V={}));var OV=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),r=1;r<t;r++)n[r-1]=arguments[r];for(var a=new Map,o=new Map,i=new Map,u=n.length>1,s=0,l=n;s<l.length;s++){var c=l[s];c.iterIf([function(e,t,n,r,a){var o=a.row,s=a.col;return!(""===e.getValue()||e.isNull()||u&&sV(i,o,s))}],e).forEach((function(e){var t=FV(e),n=o.has(t),r=a.get(t);r||a.set(t,!0),r&&n?o.delete(t):r||n||o.set(t,e)}))}var h=Array.from(o.values());return new Ru([h])}}]),t}(gC("PRIVATE_UNIQUE",1,256,1,iC,[iw.SHEET_REF,iw.SHEET_REF])),xV=function(e,t){if(!function(e){return!!Array.isArray(e)&&e.every((function(e){return"number"==typeof e.value&&["greaterThan","greaterThanOrEqual"].includes(e.operator)}))}(t))return null;if(["",void 0].includes(e))return null;var n=t.length;return t.some((function(t,r){return("greaterThan"===t.operator&&e>t.value||"greaterThanOrEqual"===t.operator&&e>=t.value)&&(n=r,!0)})),n},ZV=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e,t){for(var n=arguments.length,r=new Array(n>2?n-2:0),a=2;a<n;a++)r[a-2]=arguments[a];var o,i=[],u=t.getValue(),s=r.slice(0,2*u),l=Array.from({length:u}).map((function(e,t){return{operator:s[2*t].getValue(),value:s[2*t+1].getValue()}})),c=r.slice(2*u),h=_n(c);try{var f=function(){var t=o.value,n=[];t.iter(Object.assign({},e,{skipEmptyRef:!1})).forEach((function(e){if(e.isNumber()){var t=e.getValue(),r=xV(t,l);null!==r?n.push(new ut.NumberVar(r)):n.push(ut.NULL_VAR)}else n.push(ut.NULL_VAR)})),i.push(n)};for(h.s();!(o=h.n()).done;)f()}catch(e){h.e(e)}finally{h.f()}return new Ru(i)}}]),t}(gC("PRIVATE_ICONS",1,255,1,iC,[{type:tC},uw(ow,nC|tC|iC)]));ZV=Gi([cc("PRIVATE_ICONS")],ZV);var DV=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e,t,n){var r=[],a=t.getValue(),o=n.getRef(),i=o.sheet(),u=null==i?void 0:i.conditionalFormatModel.getRuleById(a),s=function(){var t=[];return n.iter(Object.assign({},e,{skipEmptyRef:!1})).forEach((function(){t.push(ut.BOOLEAN_VAR_MAP[ut.BooleanConstant.FALSE])})),r.push(t),new Ru(r)};if(!i||!u)return s();if(!u.getBaseCustomFormulaVar())return s();var l=this.compute(n,e,u,new Oi(o.rowFrom(),o.colFrom(),1,1,i));return r.push(l),new Ru(r)}},{key:"compute",value:function(e,t,n,r){var a=this,o=[],i=n.getBaseCustomFormulaVar();return e.iterWithPos(Object.assign({},t,{skipEmptyRef:!1})).forEach((function(e){var n=(0,p.Z)(e,3),u=(n[0],n[1]),s=n[2];r.setRowFrom(u),r.setColFrom(s),o.push(a.getBooleanValue(i,Object.assign({customRef:r},t)))})),i.resetState(),o}},{key:"getBooleanValue",value:function(e,t){if(e.isFormula()){e.resetState();var n=e.getVar(t);if(n.isBool())return n;if(n.isNumber()){var r=e.getValue(t);return ut.BOOLEAN_VAR_MAP[r?ut.BooleanConstant.TRUE:ut.BooleanConstant.FALSE]}return ut.BOOLEAN_VAR_MAP[ut.BooleanConstant.FALSE]}return ut.BOOLEAN_VAR_MAP[ut.BooleanConstant.FALSE]}}]),t}(gC("PRIVATE_CUSTOM_FORMULA",2,0,0,iC,[{type:nC},iw.SHEET_REF]));DV=Gi([cc("PRIVATE_CUSTOM_FORMULA")],DV);var PV;!function(e){e[e.TwoColors=2]="TwoColors",e[e.ThreeColors=3]="ThreeColors"}(PV||(PV={}));var LV=function(e,t){if(!function(e){return!(!e||![2,3].includes(e.length))}(t))return null;if(["",void 0].includes(e))return null;var n=function(e){return(0,m.Z)(e).sort((function(e,t){return e-t}))}(t),r=null;if(n.some((function(t){return t===e}))){var a=n.length;3===a&&n[1]===e&&(r=[1,1]),n[0]===e&&(r=[1,0]),n[a-1]===e&&(r=[1,a-1])}else n.some((function(t,a){if(e<t){if(0===a)return r=[1,a],!0;var o=n[a-1];return r=[(e-o)/(t-o),a],!0}return a===n.length-1&&e>t&&(r=[1,a],!0)}));return r},BV=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e,t,n,r){for(var a=[],o=t.getValue(),i=n.getValue(),u=r.getValue(),s=arguments.length,l=new Array(s>4?s-4:0),c=4;c<s;c++)l[c-4]=arguments[c];for(var h=function(){var t=d[f],n=[];t.iter(Object.assign({},e,{skipEmptyRef:!1})).forEach((function(e){if(e.isNumber()){var t=e.getValue(),r=LV(t,[o,i,u]);if(r){var a=(0,p.Z)(r,2),s=a[0],l=a[1],c=new ut.NumberVar(s);c.setSpecialInfo({level:l}),n.push(c)}else n.push(ut.NULL_VAR)}else n.push(ut.NULL_VAR)})),a.push(n)},f=0,d=l;f<d.length;f++)h();return new Ru(a)}}]),t}(gC("PRIVATE_THREE_COLOR_SCALE",3,255,1,iC,[{type:tC},{type:tC},{type:tC},iw.SHEET_REF]));BV=Gi([cc("PRIVATE_THREE_COLOR_SCALE")],BV);var UV=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e,t,n){for(var r=[],a=t.getValue(),o=n.getValue(),i=arguments.length,u=new Array(i>3?i-3:0),s=3;s<i;s++)u[s-3]=arguments[s];for(var l=function(){var t=h[c],n=[];t.iter(Object.assign({},e,{skipEmptyRef:!1})).forEach((function(e){if(e.isNumber()){var t=e.getValue(),r=LV(t,[a,o]);if(r){var i=(0,p.Z)(r,2),u=i[0],s=i[1],l=new ut.NumberVar(u);l.setSpecialInfo({level:s}),n.push(l)}else n.push(ut.NULL_VAR)}else n.push(ut.NULL_VAR)})),r.push(n)},c=0,h=u;c<h.length;c++)l();return new Ru(r)}}]),t}(gC("PRIVATE_TWO_COLOR_SCALE",2,255,1,iC,[{type:tC},{type:tC},iw.SHEET_REF]));UV=Gi([cc("PRIVATE_TWO_COLOR_SCALE")],UV);var HV=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"numberAsStringEq",value:function(e,t){return"number"==typeof e||"number"==typeof t?String(e)===String(t):e===t}},{key:"func",value:function(e,t,n,r){if(t.isNull())return pg(!0,{visible:!0,checked:!1});var a=t.getValue();return this.numberAsStringEq(a,n.getValue())?pg(!0,{visible:!0,checked:!0}):this.numberAsStringEq(a,r.getValue())?pg(!0,{visible:!0,checked:!1}):pg(!1,{visible:!1})}}]),t}(gC("PRIVATE_CHECKBOX",3,0,0,rC,[{type:nC|rC|eC|tC},{type:nC|rC|tC},{type:nC|rC|tC}])),WV=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e,t,n,r){if(n.isRef()){var a=n;if(bu(a))return AR(this.name,2,"");var o=a.getRef(),i=o.colCount(),u=o.rowCount();if(i>1&&u>1)return GR(this.name)}else{var s=n;if(s.colCount()>1&&s.rowCount()>1)return GR(this.name)}var l,c=r.getValue();return l=0===c?jV(e,n,t):c<0?function(e,t,n){var r=n.getValue(),a=-1,o=!1;return t.iter(Object.assign({},e,{skipEmptyRef:!1})).first_if((function(e){if(a++,e.type!==n.type)return!1;var t=e.getValue();return t>r?(o=!0,!1):t===r?(o=!0,!0):(a--,!0)})),o?a:-1}(e,n,t):function(e,t,n){var r=[];t.iter(Object.assign({},e,{skipEmptyRef:!1})).forEach((function(e){return r.push(e)}));var a=n.getValue();function o(e,t){var i=e+t>>1;if(e>t)return-1;var u=r[i],s=u.getValue();if(u.type!==n.type){var l=o(i+1,t);return-1!==l?l:o(e,i-1)}if(s===a){for(var c=i;c<=t&&r[c].getValue()===a;c++);return c-1}if(s<a){var h=o(i+1,t);return-1!==h?h:i}return o(e,i-1)}return o(0,r.length-1)}(e,n,t),-1===l?OR(this.name,null===t.getValue()?"":t.isBool()?t.getValue().toString().toUpperCase():t.getValue().toString()):new ut.NumberVar(l+1)}}]),t}(gC("MATCH",2,1,0,dC,[{type:tC|nC|rC},{type:iC},{type:tC,default:(qe={},(0,l.Z)(qe,ut.DefaultParam.IfInputNull,new ut.NumberVar(0)),(0,l.Z)(qe,ut.DefaultParam.IfNotInput,new ut.NumberVar(1)),qe)}]));function jV(e,t,n){var r,a=arguments.length>3&&void 0!==arguments[3]?arguments[3]:new ut.BooleanVar(!0),o=a.getValue(),i=n.getValue();if(n.isString()&&o){var u=(0,Mt.wildcardToFastRegExp)(i.toLowerCase());r=function(e){return u.test(e.toLowerCase())}}else r=function(e){return e===i};var s=-1,l=!1;return t.iter(Object.assign({},e,{skipEmptyRef:!1})).first_if((function(e){return s++,e.type===n.type&&r(e.getValue())&&(l=!0),l})),l?s:-1}function zV(e,t){var n=new ut.BooleanVar(e);return n.setSpecialInfo({listValidationFuncInfo:t}),n}var GV,JV=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e,t,n,r,a){var o,i=[];if(t.isRef()){if(bu(t)||1!==t.size())return ut.VALUE_ERR_VAR;var u=t.getRef(),s=u.sheet();if(!s)return ut.REF_ERR_VAR;var l=u.rowFrom(),c=u.colFrom(),h=r.getValue();i=s.getTextWithValues(l,c,h,e)}else{if(1!==t.rowCount())return ut.VALUE_ERR_VAR;if(!r.getValue()&&1!==t.size())return ut.VALUE_ERR_VAR;for(var f=0;f<t.colCount();++f){var d=t.getVarByPos(0,f);if(!d.isString())return ut.VALUE_ERR_VAR;i.push({segmentArray:null,variant:d,text:d.getValue()})}}if(0===i.length)return zV(!0);if(n.isRef()){if(bu(n))return ut.VALUE_ERR_VAR;var v=n.getRef(),g=v.sheet();if(!g)return ut.REF_ERR_VAR;for(var m=v.rowFrom(),p=v.colFrom(),y=v.rowTo(),C=v.colTo(),_=[],R=m;R<=y;++R)for(var w=p;w<=C;++w)_.push(g.getText(R,w,void 0,!1,e));o=new Ru([_.map((function(e){return new ut.StringVar(e)}))])}else{if(1!==n.rowCount())return ut.VALUE_ERR_VAR;o=n}var k,S=[],E=!0,T=_n(i);try{for(T.s();!(k=T.n()).done;){var A=k.value,I=A.text,b=A.variant,F=A.segmentArray,M=jV(e,o,new ut.StringVar(I),null!=b&&b.isBool()?new ut.BooleanVar(!0):a);M<0&&(E=!1),S.push({segmentArray:F,variant:b,text:I,index:M})}}catch(e){T.e(e)}finally{T.f()}return zV(E,S)}}]),t}(gC("PRIVATE_LIST_VALIDATION",4,0,0,rC|aC,[{type:iC},{type:iC},{type:rC},{type:rC,default:new ut.BooleanVar(!0)}])),qV={null:function(e){return null==e},general:function(e){return!!e&&(0,Se.isGeneralFormatter)(e)},text:function(e){return!!e&&(0,Se.isTextFormatter)(e)},digital:function(e){return!!e&&(0,Se.isDigitalFormatter)(e)},dateTime:function(e){return!!e&&(0,Se.isDateTimeFormatter)(e)}},$V=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e,t,n){var r=t.getValue(),a=n.getValue();return a?this.checkFormatterByCode(e.ref,r,a):this.checkFormatterByRef(e,e.ref,r)}},{key:"checkFormatterByCode",value:function(e,t,n){var r=e.sheet(),a=r&&(0,Se.createFormatter)(r.formatterService,n),o=qV[t],i=o&&o(a);return new ut.BooleanVar(!!i)}},{key:"checkFormatterByRef",value:function(e,t,n){var r=this.getCellFormatterByRange(e,t),a=qV[n],o=a&&a(r);return new ut.BooleanVar(!!o)}},{key:"getCellFormatterByRange",value:function(e,t){var n=t.sheet(),r=t.toJSON(),a=r.row,o=r.col;return null==n?void 0:n.getActualFormatter(a,o,e)}}]),t}(gC("PRIVATE_FORMATTER_VALIDATION",2,0,0,rC,[{type:nC},{type:nC}])),YV=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e,t){return new ut.BooleanVar(t.isNumber()&&Number.isInteger(t.getValue()))}}]),t}(gC("PRIVATE_IS_INT",1,0,0,rC,[{type:fC}]));function KV(e,t){return e.isCollection()?0===t?e.rowCount():e.colCount():1}!function(e){e[e.ROW=0]="ROW",e[e.COL=1]="COL"}(GV||(GV={}));var XV=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),r=1;r<t;r++)n[r-1]=arguments[r];for(var a=[],o=KV(n[0],0),i=0;i<o;i++)a.push([]);for(var u=1,s=0,l=n;s<l.length;s++){var c=l[s],h=KV(c,0),f=h!==o,d=Fu(c)&&bu(c);if(f||d){f?a[0]=[we.d$b[we.O6N.REF_ARRAY_ROW_ROW_NO_MATCH]({count:u,correctRowCount:o,actualRowCount:h})]:d&&(a[0]=[TR("PRIVATE_ARRAY_ROW",u,"")]);for(var v=1;v<o;v++)a.pop();break}for(var g=KV(c,1),m=KV(c,0),p=0;p<m;p++)for(var y=0;y<g;y++)if(c.isPrimitive())a[p].push(c);else{var C=c.getVarByPos(p,y,e);a[p].push(C)}u++}return new Ru(a)}}]),t}(gC("PRIVATE_ARRAY_ROW",1,1/0,1,iC,[{type:fC|iC}]));XV=Gi([cc("PRIVATE_ARRAY_ROW")],XV);var QV,eN,tN=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),r=1;r<t;r++)n[r-1]=arguments[r];for(var a=[],o=n[0].colCount(),i=0,u=n;i<u.length;i++){var s=u[i];if(s.isRef()&&(s=TV(s,(function(e){return e}),!0)),o!==s.colCount())return we.d$b[we.O6N.REF_ARRAY_LITERAL_COL_NO_MATCH]({funcName:this.name});var l,c=s.getCollectionValue(),h=_n(c);try{for(h.s();!(l=h.n()).done;){var f=l.value;a.push(f)}}catch(e){h.e(e)}finally{h.f()}}return new Ru(a)}}]),t}(gC("PRIVATE_ARRAY_LITERAL",1,1/0,1,iC,[{type:iC}]));function nN(e,t){var n=e.getValue(),r=t.getValue(),a=rN(n,r);return a.isValid?{settlement:ke.SheetDate.fromNumber(n),maturity:ke.SheetDate.fromNumber(r)}:a.err}function rN(e,t){if(e<0||t<0){var n=e<0?1:2;return{isValid:!1,err:ut.tractorErrorVarCreators[ut.ErrorCode.NUM_PARAMETER_SHOULD_BE_POSITIVE_OR_ZERO]({funcName:"",index:n})}}return e>=t?{isValid:!1,err:we.d$b[we.O6N.NUM_SETTLEMENT_DATE_NOT_BEFORE_MATURITY_DATE]({funcName:"",settlementDate:(0,Mt.excelDateToJSDate)(e),maturityDate:(0,Mt.excelDateToJSDate)(t)})}:{isValid:!0}}tN=Gi([cc("PRIVATE_ARRAY_LITERAL")],tN),function(e){e[e.ANNUAL=1]="ANNUAL",e[e.SEMIANNUAL=2]="SEMIANNUAL",e[e.MONTHLY=4]="MONTHLY"}(QV||(QV={})),function(e){e[e.UsPsa30_360=0]="UsPsa30_360",e[e.ActualActual=1]="ActualActual",e[e.Actual360=2]="Actual360",e[e.Actual365=3]="Actual365",e[e.Europe30_360=4]="Europe30_360"}(eN||(eN={}));var aN=function(e,t){return 12*(t.year-e.year)+(t.month-e.month)},oN=function(e,t){var n=e.getUTCDate(),r=new Date(n);return r.setUTCDate(1),r.setUTCMonth(n.getMonth()+t+1),r.setUTCDate(0),r.setUTCDate(Math.min(r.getUTCDate(),n.getUTCDate())),ke.SheetDate.fromUTCDate(r)},iN=function(e,t,n){for(var r=12/n,a=aN(e,t),o=Math.floor(a/r),i=oN(t,-o*r);0<o&&i.toNumber()<=e.toNumber();)i=oN(t,-(o-=1)*r);return i};function uN(e,t,n){for(var r=12/n|0,a=aN(e,t),o=Math.floor(a/r),i=oN(t,-o*r);i.toNumber()>e.toNumber();)i=oN(t,-(o+=1)*r);return i}var sN=function(e,t,n){return fN(e.toNumber(),t.toNumber(),n).duration};function lN(e,t,n,r){if(r===eN.ActualActual){var a=uN(e,t,n),o=iN(e,t,n);return sN(a,o,r)}return(r===eN.Actual365?365:360)/n}var cN=function(e,t,n){var r=uN(e,t,n),a=aN(r,t),o=12/n;return Math.floor(a/o)},hN=function e(t,n){(0,y.Z)(this,e),this.duration=t,this.total=n,this.value=t/n};function fN(e,t,n){var r=ke.SheetDate.fromNumber(e),a=ke.SheetDate.fromNumber(t),o=(0,ke.daysBetween)(r,a),i=r.date,u=a.date,s=r.month,l=a.month,c=r.year,h=a.year;switch(n){case eN.UsPsa30_360:return vN(r)&&vN(a)?(u=30,i=30):(31===i||vN(r))&&(i=30,31===u&&(u=30)),new hN(360*(h-c)+30*(l-s)+(u-i),360);case eN.ActualActual:var f=365;if((c===h||c+1===h)&&(s>l||s===l&&i>=u))return(c===h&&(0,ke.isLeapYear)(c)||function(e,t){var n=ke.SheetDate.fromNumber(e),r=ke.SheetDate.fromNumber(t),a=n.year,o=ke.SheetDate.from({year:a,month:3,date:1});if((0,ke.isLeapYear)(a)&&e<o.toNumber()&&t>=o.toNumber())return!0;var i=r.year,u=ke.SheetDate.from({year:i,month:3,date:1});return(0,ke.isLeapYear)(i)&&t>=u.toNumber()&&e<u.toNumber()}(e,t)||1===l&&29===u)&&(f=366),new hN(o,f);var d=h-c+1,v=(new Date(h+1,0,1).getTime()-new Date(c,0,1).getTime())/1e3/60/60/24;return new hN(o,v/d);case eN.Actual360:return new hN(o,360);case eN.Actual365:return new hN(o,365);case eN.Europe30_360:return 31===u&&(u=30),31===i&&(i=30),new hN(u+30*l+360*h-(i+30*s+360*c),360);default:return null}}function dN(e){return(e+6)%7}function vN(e){if(2===e.month)if((0,ke.isLeapYear)(e.year)){if(29===e.date)return!0}else if(28===e.date)return!0;return!1}var gN=[];function mN(e){return e.date===(0,ke.getDaysOfMonth)(e.year,e.month)}function pN(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1,r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:e,a=n*t,o=r.month,i=r.year,u=r.date;o-=a,i+=Math.floor((o-1)/12),o=((o-1)%12+12)%12+1;var s=(0,ke.getDaysOfMonth)(i,o);return u=mN(e)?s:Math.min(s,u),ke.SheetDate.from({year:i,month:o,date:u})}function yN(e,t,n){var r=function(e){return 12/e}(n),a=t.month-e.month+12*(t.year-e.year),o=0===a?1:Math.floor((a-1)/r)+1,i=pN(t,r,o-1),u=pN(t,r,1,i);return u.toNumber()>e.toNumber()&&(o++,u=pN(t,r,1,i=u)),{start:u,end:i,count:o}}gN[0]=!0,gN[6]=!0;var CN=[QV.ANNUAL,QV.SEMIANNUAL,QV.MONTHLY],_N=CN.join(", ");function RN(e){return CN.includes(e)}function wN(e){return e in eN}var kN=function(e,t,n){return ut.tractorErrorVarCreators[ut.ErrorCode.NUM_PARAMETER_VALUE_NOT_IN_LIST]({funcName:e,index:n,value:String(t),validValues:_N})},SN=function(e,t,n){return ut.tractorErrorVarCreators[ut.ErrorCode.NUM_SHOULD_BE_BETWEEN_INCLUSIVE_PARAMETER]({funcName:e,index:n,value:t,lowerBound:eN.UsPsa30_360,upperBound:eN.Europe30_360})};function EN(e,t,n,r,a){var o=rN(e,t);return o.isValid?RN(n)?wN(r)?{basis:r,frequency:n,maturity:ke.SheetDate.fromNumber(t),settlement:ke.SheetDate.fromNumber(e)}:SN("",r,a?a+1:4):kN("",n,a||3):o.err}function TN(e,t,n,r){var a=EN(e.getValue(),t.getValue(),n.getValue(),r.getValue());return a instanceof ut.ErrorVar?a:yN(a.settlement,a.maturity,a.frequency)}function AN(e,t,n,r,a){var o,i,u,s;if(null!==(o=e.info)&&void 0!==o&&null!==(i=o.args)&&void 0!==i&&i.hasOwnProperty("funcName")&&(e.info.args.funcName=t),null!==(u=e.info)&&void 0!==u&&null!==(s=u.args)&&void 0!==s&&s.hasOwnProperty("settlementDate")&&e.info.args.hasOwnProperty("maturityDate")){var l=a.ref.sheet();if(!l)return ut.VALUE_ERR_VAR;var c=(0,we.L0c)(l.formatterService,n.getValue()),h=(0,we.L0c)(l.formatterService,r.getValue());e.info.args.settlementDate=c,e.info.args.maturityDate=h}return e}function IN(e,t,n,r,a,o){for(var i=yN(ke.SheetDate.fromNumber(e),ke.SheetDate.fromNumber(t),a),u=fN(e,i.end.toNumber(),o),s=u.duration/(u.total/a),l=i.count,c=n/a*100,h=(l-1|0)+s,f=1+r/a,d=100/Math.pow(f,h),v=0,g=0,m=0;m<l;m++){var p=m+s,y=c/Math.pow(f,p);v+=y,g+=y*p}return(g+d*h)/(d+v)/a}function bN(e){var t=e.basis,n=e.frequency;if(0===t||2===t||4===t)return 12/n*30;if(3===t)return 12/n*(365/12);var r=yN(e.settlement,e.maturity,n),a=r.start,o=r.end;return o.date>a.date&&a.toNumber()>0&&o.setDateTime({date:a.date}),fN(a.toNumber(),o.toNumber(),t).duration}var FN=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e,t,n,r,a,o,i,u,s){var l=Math.floor(t.getValue()),c=Math.floor(n.getValue()),h=Math.floor(r.getValue()),f=a.getValue(),d=o.getValue(),v=Math.floor(i.getValue()),g=Math.floor(u.getValue());if(null===s.toBooleanVar().getValue())return nR(this.name,String(s.getValue()),8,"TRUE, FALSE");var m=[{val:l,index:1},{val:c,index:2},{val:h,index:3}].find((function(e){return e.val<0}));if(m)return K_(this.name,m.val,m.index,0);if(l>=h){var p=e.ref.sheet();return p?eR(this.name,p,l,1,h,3):ut.VALUE_ERR_VAR}var y,C=[{val:f,index:5},{val:d,index:6}].find((function(e){return e.val<=0}));if(C)return q_(this.name,C.val,C.index,0);if(!RN(v))return kN(this.name,v,6);if(!wN(g))return SN(this.name,g,7);var _=ke.SheetDate.fromNumber(l),R=ke.SheetDate.fromNumber(c),w=ke.SheetDate.fromNumber(h);if(h<c){var k=iN(_,R,v),S=uN(w,R,v);if(S<k)y=sN(_,w,g)/lN(_,R,v,g);else{var E=sN(_,k,g)/lN(_,R,v,g),T=sN(S,w,g)/lN(w,R,v,g);y=E+(cN(_,R,v)-cN(w,R,v)-1)+T}}else y=function(e,t,n,r){var a=iN(e,t,n);return-sN(a,e,r)}(_,w,v,g)/lN(_,w,v,g)+Math.floor(cN(_,w,v))-1;return new ut.NumberVar(d*(f/v)*y)}}]),t}(gC("ACCRINT",6,2,0,tC,[{type:tC},{type:tC},{type:tC},{type:tC},{type:tC,default:new ut.NumberVar(1e3)},{type:tC},{type:tC,default:new ut.NumberVar(eN.UsPsa30_360)},{type:rC|tC|nC,default:new ut.BooleanVar(!0)}])),MN=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e,t,n,r,a,o){var i=Math.floor(t.getValue()),u=Math.floor(n.getValue()),s=r.getValue(),l=a.getValue(),c=Math.floor(o.getValue());if(i<=0||u<=0){var h=u,f=2;return i<=0&&(h=i,f=1),q_(this.name,h,f,0)}if(i>=u){var d=e.ref.sheet();return d?eR(this.name,d,i,1,u,2):ut.VALUE_ERR_VAR}if(s<=0||l<=0)return ut.NUM_ERR_VAR;var v=fN(i,u,c);return null===v?j_(this.name,5,c,0,4):new ut.NumberVar(l*s*v.value)}}]),t}(gC("ACCRINTM",4,1,0,tC,[{type:tC},{type:tC},{type:tC},{type:tC,default:new ut.NumberVar(1e3)},{type:tC,default:new ut.NumberVar(0)}])),VN=new Map([["I",1],["V",5],["X",10],["L",50],["C",100],["D",500],["M",1e3]]),NN=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e,t){var n=t.getValue().toUpperCase(),r=0,a="-"===n[0];a&&(n=n.substr(1));for(var o=0;o<n.length;o++){var i=VN.get(n[o])||0,u=VN.get(n[o+1])||0,s=VN.get(n[o+2])||0,l=VN.get(n[o+3])||0;if(!i||s>=u&&s>i||i===u&&i===s&&i===l||i===u/2)return we.d$b[we.O6N.INVALID_ROMAN_NUMERAL]({funcName:this.name});i<u?r-=i:r+=i}return a&&(r=-r),new ut.NumberVar(r)}}]),t}(gC("ARABIC",1,0,0,tC,[{type:nC}])),ON=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e,t){return t.isPrimitive()?t:hc(e,t)}}]),t}(gC("ARRAYFORMULA",1,0,0,dC,[{type:dC}]));ON=Gi([cc("ARRAYFORMULA")],ON);var xN=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e,t,n,r){var a=n.getValue(),o=r.getValue();return o<1||a<1?ZR:t.isPrimitive()?t:hc(e,t,a,o)}}]),t}(gC("ARRAY_CONSTRAIN",3,0,0,dC,[{type:dC},{type:tC},{type:tC}]));xN=Gi([cc("ARRAY_CONSTRAIN")],xN);var ZN,DN=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e){for(var t=0,n=0,r=arguments.length,a=new Array(r>1?r-1:0),o=1;o<r;o++)a[o-1]=arguments[o];for(var i=function(){var r=s[u],a=void 0;if(r.iter(e).exitWhen((function(e){var t=e.isError();return t&&(a=e),t})).forEach((function(e){r.isNumber()?(t+=e.getValue(),n++):r.isRef()?e.isNumber()?(t+=e.getValue(),n++):e.isBool()?(t+=e.toNumberVar().getValue(),n++):e.isString()&&n++:e.isNumber()?(n++,t+=e.getValue()):e.isString()&&n++})),a)return{v:a}},u=0,s=a;u<s.length;u++){var l=i();if("object"===(0,_.Z)(l))return l.v}return 0===n?PR(this.name):new ut.NumberVar(t/n)}}]),t}(gC("AVERAGEA",1,256,1,tC,[{type:tC|iC},{type:tC|iC}]));function PN(e,t,n){return Array.from({length:e},(function(){return void 0!==n?Array(t).fill(n):Array(t)}))}function LN(e){for(var t=PN(e.length,e[0].length),n=0;n<e.length;n++)for(var r=0;r<e[n].length;r++)t[n][r]=e[n][r];return t}function BN(e){for(var t=PN(e[0].length,e.length),n=0;n<e.length;n++)for(var r=0;r<e[n].length;r++)t[r][n]=e[n][r];return t}function UN(e,t){for(var n=e.length,r=t.length,a=t[0].length,o=new Array(n),i=n-1;i>=0;i--){o[i]=new Array(a);for(var u=a-1;u>=0;u--){var s=void 0,l=e[i][r-1]*t[r-1][u];for(s=r-2;s>=1;s-=2)l+=e[i][s]*t[s][u]+e[i][s-1]*t[s-1][u];0===s&&(l+=e[i][0]*t[0][u]),o[i][u]=l}}return o}function HN(e,t){var n=0;return Math.abs(e)>Math.abs(t)?(n=t/e,Math.abs(e)*Math.sqrt(1+n*n)):0!==t?(n=e/t,Math.abs(t)*Math.sqrt(1+n*n)):0}function WN(e){for(var t=function(e){var t,n=Number.EPSILON,r=1e-64/n,a=0,o=0,i=0,u=0,s=0,l=LN(e),c=l.length,h=l[0].length;if(c<h)throw new Error("Need more rows than columns");for(var f=new Array(h),d=new Array(h),v=0;v<h;v++)f[v]=d[v]=0;var g=PN(h,h,0),m=0,p=0,y=0,C=0,_=0,R=0,w=0;for(o=0;o<h;o++){f[o]=p;for(var k=0,S=o+1,E=o;E<c;E++)k+=l[E][o]*l[E][o];if(k<=r)p=0;else for(m=l[o][o],p=Math.sqrt(k),m>=0&&(p=-p),y=m*p-k,l[o][o]=m-p,i=S;i<h;i++){for(k=0,u=o;u<c;u++)k+=l[u][o]*l[u][i];for(m=k/y,u=o;u<c;u++)l[u][i]+=m*l[u][o]}for(d[o]=p,k=0,i=S;i<h;i++)k+=l[o][i]*l[o][i];if(k<=r)p=0;else{for(m=l[o][o+1],p=Math.sqrt(k),m>=0&&(p=-p),y=m*p-k,l[o][o+1]=m-p,i=S;i<h;i++)f[i]=l[o][i]/y;for(i=S;i<c;i++){for(k=0,u=S;u<h;u++)k+=l[i][u]*l[o][u];for(u=S;u<h;u++)l[i][u]+=k*f[u]}}(_=Math.abs(d[o])+Math.abs(f[o]))>C&&(C=_)}for(o=h-1;-1!==o;o--){if(0!==p){for(y=p*l[o][o+1],i=s;i<h;i++)g[i][o]=l[o][i]/y;for(i=s;i<h;i++){for(w=0,u=s;u<h;u++)w+=l[o][u]*g[u][i];for(u=s;u<h;u++)g[u][i]+=w*g[u][o]}}for(i=s;i<h;i++)g[o][i]=0,g[i][o]=0;g[o][o]=1,p=f[o],s=o}for(o=h-1;-1!==o;o--){for(s=o+1,p=d[o],i=s;i<h;i++)l[o][i]=0;if(0!==p){for(y=l[o][o]*p,i=s;i<h;i++){for(w=0,u=s;u<c;u++)w+=l[u][o]*l[u][i];for(m=w/y,u=o;u<c;u++)l[u][i]+=m*l[u][o]}for(i=o;i<c;i++)l[i][o]=l[i][o]/p}else for(i=o;i<c;i++)l[i][o]=0;l[o][o]+=1}for(n*=C,u=h-1;-1!==u;u--)for(var T=0;T<50;T++){var A=!1;for(s=u;-1!==s;s--){if(Math.abs(f[s])<=n){A=!0;break}if(Math.abs(d[s-1])<=n)break}if(!A){a=0,w=1;var I=s-1;for(o=s;o<u+1&&(m=w*f[o],f[o]=a*f[o],!(Math.abs(m)<=n));o++)for(y=HN(m,p=d[o]),d[o]=y,a=p/y,w=-m/y,i=0;i<c;i++)_=l[i][I],R=l[i][o],l[i][I]=_*a+R*w,l[i][o]=-_*w+R*a}if(R=d[u],s===u){if(R<0)for(d[u]=-R,i=0;i<h;i++)g[i][u]=-g[i][u];break}if(T>=49)throw new Error("Error: no convergence.");for(C=d[s],p=HN(m=(((_=d[u-1])-R)*(_+R)+((p=f[u-1])-(y=f[u]))*(p+y))/(2*y*_),1),m=m<0?((C-R)*(C+R)+y*(_/(m-p)-y))/C:((C-R)*(C+R)+y*(_/(m+p)-y))/C,a=1,w=1,o=s+1;o<u+1;o++){for(p=f[o],_=d[o],y=w*p,p*=a,R=HN(m,y),f[o-1]=R,m=C*(a=m/R)+p*(w=y/R),p=-C*w+p*a,y=_*w,_*=a,i=0;i<h;i++)C=g[i][o-1],R=g[i][o],g[i][o-1]=C*a+R*w,g[i][o]=-C*w+R*a;for(R=HN(m,y),d[o-1]=R,m=(a=m/R)*p+(w=y/R)*_,C=-w*p+a*_,i=0;i<c;i++)_=l[i][o-1],R=l[i][o],l[i][o-1]=_*a+R*w,l[i][o]=-_*w+R*a}f[s]=0,f[u]=m,d[u]=C}for(o=0;o<d.length;o++)d[o]<n&&(d[o]=0);for(o=0;o<h;o++)for(i=o-1;i>=0;i--)if(d[i]<d[o]){for(a=d[i],d[i]=d[o],d[o]=a,u=0;u<l.length;u++)t=l[u][o],l[u][o]=l[u][i],l[u][i]=t;for(u=0;u<g.length;u++)t=g[u][o],g[u][o]=g[u][i],g[u][i]=t;o=i}return{U:l,S:d,V:g}}(e),n=t.S,r=BN(t.U),a=PN(n.length,e[0].length,0),o=Math.max(e.length,e[0].length)*Number.EPSILON*n[0],i=0;i<n.length;i++)Math.abs(n[i])>o&&(a[i][i]=1/n[i]);return UN(t.V,UN(a,r))}function jN(e){var t=zN(e),n=t.luMatrix,r=t.permutation;return!t.smallPivotDetected&&function(e,t){for(var n=t.length,r=PN(n,n,0),a=0;a<n;a++)r[a][a]=1;for(var o=PN(n,n,0),i=0;i<n;i++)for(var u=t[i],s=0;s<n;s++)o[i][s]=r[u][s];for(var l=0;l<n;l=l+1|0)for(var c=o[l],h=l+1;h<n;h++)for(var f=e[h][l],d=0;d<n;d+=1)o[h][d]-=c[d]*f;for(var v=n-1;0<=v;v--){for(var g=o[v],m=e[v][v],p=0;p<n;p++)g[p]/=m;for(var y=0;y<v;y++)for(var C=e[y][v],_=0;_<n;_++)o[y][_]-=g[_]*C}return o}(n,r)}function zN(e){for(var t=LN(e),n=t.length,r=t[0].length,a=!0,o=!1,i=PN(n,r,0),u=new Array(r).fill(0).map((function(e,t){return t})),s=0;s<r;s++){for(var l,c,h,f=0;f<s;f++){for(var d=t[f][s],v=0;v<f;v++)d-=i[f][v]*i[v][s];i[f][s]=d}for(var g=-1/0,m=s,p=s;p<n;p++){for(var y=t[p][s],C=0;C<s;C++)y-=i[p][C]*i[C][s];i[p][s]=y;var _=Math.abs(y);_>g&&(g=_,m=p)}if(Math.abs(i[m][s])<1e-11){o=!0;break}m!==s&&(l=[i[s],i[m]],i[m]=l[0],i[s]=l[1],c=[t[s],t[m]],t[m]=c[0],t[s]=c[1],h=[u[s],u[m]],u[m]=h[0],u[s]=h[1],a=!a);for(var R=i[s][s],w=s+1;w<n;w++)i[w][s]/=R}return{rowSwap:a,smallPivotDetected:o,luMatrix:i,permutation:u}}function GN(e,t,n,r,a){var o,i=e.rowCount(),u=e.colCount(),s=e.size(),l=1===s,c=ZN.SIMPLE;if(t.isNull())return l&&r&&(o=we.d$b[we.O6N.TREND_POINT_NUM_UNENOUGHT]({funcName:n,expectedNum:2,receivedNum:s})),{error:o,type:c};var h=t.rowCount(),f=t.colCount(),d=t.size(),v=1===d,g=i===h,m=u===f;return 1===u&&1!==f||1===i&&1!==h?(o=function(e,t,n,r,a){var o,i,u=e.rowCount(),s=e.colCount(),l=t.rowCount(),c=t.colCount(),h=1===s,f=1===u;if(h?(o=c,i=u):(o=l,i=s),h&&u!==l)return we.d$b[we.O6N.TREND_ROW_NO_MATCH]({funcName:n,yRowCount:u,xRowCount:l});if(f&&s!==c)return we.d$b[we.O6N.TREND_COL_NO_MATCH]({funcName:n,yColCount:s,xColCount:c});if(a&&!a.isNull()){if(h&&a.colCount()!==o)return we.d$b[we.O6N.TREND_COL_NO_MATCH]({funcName:n,yColCount:o,xColCount:a.colCount()});if(f&&a.rowCount()!==o)return we.d$b[we.O6N.TREND_ROW_NO_MATCH]({funcName:n,yRowCount:o,xRowCount:a.rowCount()})}return r&&o+1>i||o>i?we.d$b[we.O6N.TREND_POINT_NUM_UNENOUGHT]({funcName:n,expectedNum:r?o+1:o,receivedNum:i}):void 0}(e,t,n,r,a),{error:o,type:c=ZN.MULTIPLE}):g||m?g?m?l&&v&&r?{error:o=we.d$b[we.O6N.TREND_POINT_NUM_UNENOUGHT]({funcName:n,expectedNum:d+1,receivedNum:s}),type:c}:{error:o,type:c}:{error:o=we.d$b[we.O6N.TREND_COL_NO_MATCH]({funcName:n,yColCount:u,xColCount:f}),type:c}:{error:o=we.d$b[we.O6N.TREND_ROW_NO_MATCH]({funcName:n,yRowCount:i,xRowCount:h}),type:c}:{error:o=we.d$b[we.O6N.TREND_ROW_COL_NO_MATCH]({funcName:n,yRowCount:i,yColCount:u,xRowCount:h,xColCount:f}),type:c}}function JN(e,t,n,r,a,o,i){var u,s=t.rowCount(),l=t.colCount(),c=qN(e,t,r,1,a,i);c.error&&(u=c.error);var h=n.isNull()?function(e,t,n){if(n===ZN.SIMPLE){for(var r=[],a=1;a<=e*t;a++)r.push(a);return{error:void 0,numberArray:r}}for(var o=[],i=1,u=0;u<e;u++)for(var s=0;s<t;s++)o[u]||(o[u]=[]),o[u].push(i++);return{error:void 0,numberArray:o}}(s,l,ZN.SIMPLE):qN(e,n,r,2,a);!u&&h.error&&(u=h.error);var f=o&&!o.isNull()?qN(e,o,r,3,a):h;return!u&&f.error&&(u=f.error),{error:u,knownYTransformResult:c,knownXTransformResult:h,newXTransformResult:f}}function qN(e,t,n,r,a,o){var i,u,s=[],l=0,c=0,h=a===ZN.SIMPLE,f=o&&1===r,d=t.colCount();return f&&(u=[]),t.iter(Object.assign({},e,{skipEmptyRef:!1})).exitWhen((function(e){return e.isError()?i=e:e.isString()?i=we.d$b[we.O6N.TREND_ARGUMENT_NOT_STIRNG]({funcName:n,index:r,content:e.toStringVar().getValue()}):e.isBool()?i=we.d$b[we.O6N.TREND_ARGUMENT_NOT_BOOLEAN]({funcName:n,index:r,content:e.toStringVar().getValue()}):e.isNull()?i=we.d$b[we.O6N.TREND_ARGUMENT_NOT_NULL]({funcName:n,index:r,content:e.toStringVar().getValue()}):f&&e.isNumber()&&e.getValue()<=0&&(i=ut.tractorErrorVarCreators[ut.ErrorCode.NUM_PARAMETER_SHOULD_BE_GREATER_THAN]({funcName:n,index:1,value:e.getValue(),lowerBound:0})),!!i})).forEach((function(e){var t=e.getValue();h?(s.push(t),u&&u.push(Math.log(t))):(c>=d&&l++,s[l]||(s[l]=[],u&&(u[l]=[]),c=0),s[l].push(t),u&&u[l].push(Math.log(t)),c++)})),{error:i,numberArray:s,lnKnowYArray:u}}function $N(e,t,n,r){var a,o;if(n){var i=new Yt.Z(t,e);a=i.slope,o=i.intercept,i=null}else a=function(e,t){for(var n=[JSON.parse(JSON.stringify(e))],r=JSON.parse(JSON.stringify(t)),a=n[0].length,o=n.length,i=Math.min(a,o),u=new Array(i).fill(0),s=0;s<i;s++){for(var l=n[s],c=0,h=s;h<a;h++)c+=l[h]*l[h];if(c=0<l[s]?-Math.sqrt(c):Math.sqrt(c),u[s]=c,0!==c){l[s]-=c;for(var f=s+1;f<o;f++){for(var d=n[f],v=0,g=s;g<a;g++)v-=d[g]*u[g];v/=c*u[s];for(var m=s;m<a;m++)d[m]-=v*u[m]}}}for(var p=n.length,y=n[0].length,C=new Array(p).fill(0),_=Math.min(p,y),R=0;R<_;R++){for(var w=n[R],k=0,S=R;S<y;S++)k+=r[S]*w[S];k/=u[R]*w[R];for(var E=R;E<y;E++)r[E]+=k*w[E]}for(var T=u.length-1;0<=T;T--){r[T]/=u[T];var A=r[T],I=n[T];C[T]=A;for(var b=0;b<T;b++)r[b]-=A*I[b]}return C[0]}(t,e),o=0;return r?[[Math.exp(a),Math.exp(o)]]:[[a,o]]}function YN(e){return e.reduce((function(e,t){return e+t}),0)/e.length}function KN(e,t,n){for(var r=0,a=e.length,o=0;o<a;o++){var i=e[o];r+=n?Math.pow(i-t,2):Math.pow(i,2)}return r}function XN(e,t){for(var n=0,r=e.length,a=0;a<r;a++){var o=e[a],i=t[a];n+=(o-i)*(o-i)}return n}function QN(e,t,n){return n?Math.sqrt(e/n/t):0}function eO(e,t,n,r,a){return r?Math.sqrt(e/r*(1/a+Math.pow(t,2)/n)):0}function tO(e,t){return e/(e+t)}function nO(e,t){return t?Math.sqrt(e/t):0}function rO(e,t,n){return e/(t/n)}function aO(e,t,n,r){return e/t/(n/r)}function oO(e,t){return e-t}function iO(e){for(var t=[],n=0;n<e.length;n++){t[n]||(t[n]=[]);for(var r=0;r<e[0].length;r++)t[n][r]=new ut.NumberVar(e[n][r])}return t}function uO(e,t,n){var r=t[0][0],a=t[0][1],o=e.length;if(n){for(var i=[],u=o/n,s=0;s<n;s++){i[s]||(i[s]=[]);for(var l=0;l<u;l++)i[s][l]=r*e[s*u+l]+a}return i}for(var c=[],h=0;h<o;h++)c.push(e[h]*r+a);return c}function sO(e,t,n){var r=t[0][0],a=t[0][1],o=e.length;if(n){for(var i=[],u=o/n,s=[],l=0;l<n;l++){i[l]||(i[l]=[],s[l]=[]);for(var c=0;c<u;c++){var h=a*Math.pow(r,e[l*u+c]);i[l][c]=h,s[l][c]=h}}return{predictResult:i,lnPredictResult:s}}for(var f=[],d=[],v=0;v<o;v++){var g=a*Math.pow(r,e[v]);f.push(g),d.push(Math.log(g))}return{predictResult:f,lnPredictResult:d}}function lO(e,t,n){for(var r=e.length,a=t[0].pop(),o=t[0].length,i=[],u=0;u<r;u++){for(var s=a,l=o-1;l>=0;l--)s+=t[0][o-1-l]*e[u][l];n?(i[u]||(i[u]=[]),i[u].push(s)):i.push(s)}return i}function cO(e,t,n){for(var r=e.length,a=t[0].pop(),o=t[0].length,i=[],u=[],s=0;s<r;s++){for(var l=a,c=o-1;c>=0;c--){var h=t[0][o-1-c];l*=Math.pow(h,e[s][c])}n?(i[s]||(i[s]=[],u[s]=[]),i[s].push(l),u[s].push(Math.log(l))):(i.push(l),u.push(Math.log(l)))}return{predictResult:i,lnPredictResult:u}}function hO(e,t,n,r,a,o,i){var u=JN(e,t,n,r,ZN.SIMPLE,i,o),s=u.error,l=u.knownYTransformResult,c=u.knownXTransformResult,h=u.newXTransformResult;if(s)return{error:s};var f,d=l.numberArray,v=c.numberArray,g=h&&h.numberArray,m=l.lnKnowYArray,p=t.rowCount();return i&&!i.isNull()?p=i.rowCount():n.isNull()||(p=n.rowCount()),f=$N(o?m:d,v,a,o),isNaN(f[0][0])&&!a&&(f[0][0]=0),{newXArray:g,weights:f,newXRowCount:p,error:s,knownXArray:v,knownYArray:d,lnKnowYArray:m}}function fO(e,t,n,r,a,o,i){var u=1===t.colCount(),s=JN(e,t,n,r,ZN.MULTIPLE,i,o),l=s.error,c=s.knownYTransformResult,h=s.knownXTransformResult,f=s.newXTransformResult;if(l)return{error:l};var d,v=c.numberArray,g=h.numberArray,m=c.lnKnowYArray,p=f&&f.numberArray;return u||(g=BN(g),v=BN(v),p=BN(p),m&&(m=BN(m))),d=function(e,t,n,r){if(n)for(var a=0;a<t.length;a++)t[a].push(1);var o=BN(t),i=UN(o,t),u=UN(o,e),s=jN(i)||WN(i),l=UN(s,u);n||l.push([0]);var c=(l=BN(l))[0].pop();if(l[0].reverse(),l[0].push(c),r)for(var h=0;h<l[0].length;h++)l[0][h]=Math.exp(l[0][h]);return{weights:l,inverseMatrix:s}}(o?m:v,g,a,o),{newXMatrix:p,isYColCountEqualOne:u,weights:d.weights,error:l,inverseMatrix:d.inverseMatrix,knownXMatrix:g,knownYMatrix:v,lnKnowYMatrix:m}}!function(e){e.SIMPLE="SIMPLE",e.MULTIPLE="MULTIPLE"}(ZN||(ZN={}));var dO=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),r=1;r<t;r++)n[r-1]=arguments[r];for(var a=n.length,o=[],i=[],u=0;u<a;u+=2){var s=n[u].rowCount(),l=n[u].colCount(),c=n[u+1].rowCount(),h=n[u+1].colCount();if(s!==c||l!==h)return CR(this.name,s,c,l,h)}for(var f=0;f<a;f++){var d=n[f],v=qN(e,d,this.name,f+1,ZN.SIMPLE),g=v.error,p=v.numberArray;if(g)return g;f%2==0?o.push.apply(o,(0,m.Z)(p)):i.push.apply(i,(0,m.Z)(p))}for(var y=o.length,C=0,_=0;_<y;_++){if(i[_]<0)return DR;C+=i[_]}for(var R=0,w=0;w<y;w+=1)R+=o[w]*i[w];if(0===C)return PR(this.name);R/=C;for(var k=0,S=0;S<y;S+=1)k+=i[S]*(o[S]-R);return new ut.NumberVar(R+k/C)}}]),t}(gC("AVERAGE.WEIGHTED",2,256,2,tC,[{type:iC},{type:iC},{type:iC},{type:iC}])),vO=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e,t,n,r){var a=Math.floor(t.getValue()),o=Math.floor(n.getValue()),i=r.getValue();if(a<0||a>Number.MAX_SAFE_INTEGER)return j_(this.name,1,a,0,Number.MAX_SAFE_INTEGER);if(o<2||o>36)return j_(this.name,2,o,2,36);if(i<0||i>255)return j_(this.name,3,i,0,255);var u=a.toString(o).toUpperCase(),s=Math.floor(Math.max(i-u.length,0));return new ut.StringVar("0".repeat(s)+u)}}]),t}(gC("BASE",2,1,0,nC,[{type:tC},{type:tC},{type:tC,default:new ut.NumberVar(0)}])),gO=4294967296,mO=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e,t,n){var r=281474976710656,a=t.getValue(),o=n.getValue();if(a<0)return H_(this.name,1);if(a%1!=0)return tR(this.name,1,a);if(a>=r)return Q_(this.name,a,1,r);if(this.name.includes("SHIFT")){if(0===a)return new ut.NumberVar(0);o=Math.trunc(o)}else{if(o<0)return H_(this.name,2);if(o%1!=0)return tR(this.name,2,o);if(o>r)return Q_(this.name,o,2,r)}return this.bitClac(a,o)}},{key:"generate64BitInteger",value:function(e){return e>0?{high32bits:0|e,low32bits:e/gO|0}:{high32bits:0|-e,low32bits:-e/gO|0}}}]),t}(gC("",2,0,0,tC,[{type:tC},{type:tC}])),pO=function(e){function t(){var e;return(0,y.Z)(this,t),(e=(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))).name="BITAND",e}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"bitClac",value:function(e,t){return new ut.NumberVar(e&t)}}]),t}(mO),yO=function(e){function t(){var e;return(0,y.Z)(this,t),(e=(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))).name="BITLSHIFT",e}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"bitClac",value:function(e,t){if(t>53||t<-53)return j_(this.name,2,t,-53,53);if(t<0&&e<1<<-t)return new ut.NumberVar(0);var n=0xffffffffffff,r=Math.floor(e*Math.pow(2,t));return r>n?function(e,t,n){return we.d$b[we.O6N.FUNCTION_RESULT_SHOULD_BE_LESS_THAN_OR_EQUAL_TO]({funcName:e,value:t,upperBound:n})}(this.name,r,n):new ut.NumberVar(r)}}]),t}(mO),CO=function(e){function t(){var e;return(0,y.Z)(this,t),(e=(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))).name="BITOR",e}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"bitClac",value:function(e,t){var n=this.generate64BitInteger(e),r=this.generate64BitInteger(t),a=n.high32bits|r.high32bits,o=n.low32bits|r.low32bits;return new ut.NumberVar(gO*o+(a>>>0))}}]),t}(mO),_O=function(e){function t(){var e;return(0,y.Z)(this,t),(e=(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))).name="BITRSHIFT",e}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"bitClac",value:function(e,t){if(t>53||t<-53)return j_(this.name,2,t,-53,53);var n=Math.floor(e/Math.pow(2,t));return new ut.NumberVar(n)}}]),t}(mO),RO=function(e){function t(){var e;return(0,y.Z)(this,t),(e=(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))).name="BITXOR",e}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"bitClac",value:function(e,t){var n=this.generate64BitInteger(e),r=this.generate64BitInteger(t),a=n.high32bits^r.high32bits,o=n.low32bits^r.low32bits;return new ut.NumberVar(gO*o+(a>>>0))}}]),t}(mO),wO=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e,t){var n=t.getValue();if(""===n)return IR(this.name,1);var r=n.codePointAt(0);return new ut.NumberVar(r)}}]),t}(gC("CODE",1,0,0,tC,[{type:nC}]));function kO(e){if(e.isNull())return"null";var t=e.getValue();return e.isNumber()?t=(0,Se.toPrecision)(e.getValue()):e.isString()&&(t=e.getValue().toUpperCase()),t}var SO=100;var EO,TO={Common:512,Sort:2048,AI:50,Condition:512,InvertedIndex:100,CommonCacheInner:512};!function(e){e.INVERTED_INDEX="x_"}(EO||(EO={}));var AO="MATRIX_SHEET",IO=function(){function e(t){(0,y.Z)(this,e),this.type=t,this.cache={}}return(0,C.Z)(e,[{key:"addCache",value:function(e,t){this.cache[e]||(this.cache[e]=t)}},{key:"addCacheByKey",value:function(){}},{key:"getCacheByKey",value:function(){return null}},{key:"getKey",value:function(){return null}},{key:"getCache",value:function(e){var t=this.cache[e];return t||(t=new we.z6B(TO[this.type]),this.cache[e]=t),t}},{key:"isCacheValid",value:function(){return!0}},{key:"removeCache",value:function(){this.cache={}}}]),e}(),bO=/~~|~\?|~\*|\?|\*/,FO=/[|\\{}()[\]^$+.]/,MO=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e,t,n,r,a){var o,i=!a.getValue(),u=Math.floor(r.getValue()),s=n.isRef()?n.toRefMatrix():n,l=Ou(s,0,1);if(i){var c=t.isString()&&bO.test(t.getValue().replace(FO,"\\$&")),h=e.service.getFuncCacheManager(),f=null;!c&&(n.isRef()&&n.getRef().rowCount()>SO||Nu(n)&&n.rowCount()>SO)&&(f=h.getInnerFuncCache("InvertedIndex",{autoBuildCache:!1})),o=null==f?kV(e,l,t):function(e,t,n,r){var a,o,i,u,s=n.type,l=kO(n),c="",h="",f=0,d=null;if(Nu(r)&&(c=r.id(),h=AO,d=Ou(r,0,1)),r.isRef()){var v,g=r.getRef(),m=g.sheet();h=null!==(v=null==m?void 0:m.id())&&void 0!==v?v:"";var y=g.colFrom(),C=g.rowFrom(),_=g.rowCount(),R=new Oi(C,y,_,1,m);c=R.id(!1),d=new Su(R),f=C}if(!c||!h||!d)return-1;var w=t.getCache(h,e),k=w.get(c);if(k)return null!==(a=null===(o=k[s])||void 0===o?void 0:o.get(l))&&void 0!==a?a:-1;var S=function(e,t,n){var r={};return e.iterWithPos(Object.assign({},t,{skipEmptyRef:!0})).forEach((function(e){var t,a=(0,p.Z)(e,2),o=a[0],i=a[1],u=o.type;u in r?t=r[u]:(t=new Map,r[u]=t);var s=kO(o);t.has(s)||t.set(s,i-n)})),r}(d,e,f);return w.set(c,S),null!==(i=null===(u=S[s])||void 0===u?void 0:u.get(l))&&void 0!==i?i:-1}(e,f,t,n)}else o=wV(e,l,t);return o<0?we.d$b[we.O6N.LOOKUP_VALUE_NOT_FOUND]({funcName:this.name,value:null==t.getValue()?"":t.isBool()?t.getValue().toString().toUpperCase():t.getValue().toString()}):u<=0?Y_(this.name,u,3,1):u>s.colCount()?we.d$b[we.O6N.REFERENCE_OUT_OF_BOUNDS]({funcName:this.name}):s.nth(o*s.colCount()+u-1,e)}}]),t}(gC("VLOOKUP",3,1,0,nC,[{type:nC|tC|rC,default:new ut.NumberVar(0)},{type:iC},{type:tC},{type:rC,default:($e={},(0,l.Z)($e,ut.DefaultParam.IfNotInput,new ut.BooleanVar(!0)),(0,l.Z)($e,ut.DefaultParam.IfInputNull,new ut.BooleanVar(!1)),$e)}]));function VO(e,t,n){if(t.equals(n))return 0;if(t.isString()&&n.isString()){if(t.greaterThan(n))return 1}else if(t.getValue(e)>n.getValue(e))return 1;return-1}function NO(e,t,n,r,a,o,i){if(e.service.getFuncCacheManager().getInnerFuncCache("Condition",{autoBuildCache:!1})&&n*r>SO&&!a)(function(e){var t=e[0].clone();return e.forEach((function(e){return t.intersect(e)})),t.toArray()})(t.map((function(t){return function(e,t){var n=function(e,t){var n,r,a,o,i=t.target,u=t.criteria;Fu(i)?(a=i.getRef().sheet().id(),o=i.getRef().id(!1)):(a=AO,o=i.id());var s=null===(n=e.service.getFuncCacheManager().getInnerFuncCache("Condition",{autoBuildCache:!1}))||void 0===n?void 0:n.getCache(a,e);if(!s||!o)return null;var l=kO(u);return(null===(r=s.get(l))||void 0===r?void 0:r.get(o))||null}(e,t);if(n)return n;var r=LO(e,t.target);r||(r=BO(e,t.target));var a=OO((0,Mt.getCriteriaType)(t.criteria),e,t.criteria),o=(0,p.Z)(a,3),i=o[0],u=o[1],s=o[2];if(!r||!i||void 0===u||void 0===s)return PO(e,t,function(e,t){var n=new Set,r=-1;return t.target.iter(Object.assign({},e,{skipEmptyRef:!1})).forEach((function(e){r++,t.predicate(e)&&n.add(r)})),n}(e,t));if(u&&u.isNull()&&"="!==s&&"<>"!==s)return PO(e,t,new Set);return PO(e,t,function(e,t,n){var r=t.range,a=t.criteriaVar,o=t.compareType;switch(a.type){case eC:return function(e,t,n){var r=t[eC];return"="===e?new Set(r):DO(new Set,n.size(),r)}(o,n,r);case rC:return function(e,t,n,r){var a=n[rC];switch(t){case"=":return new Set(a[e?0:1]);case"<>":return DO(new Set,r.size(),a[e?0:1]);case">":return e?new Set:new Set(a[0]);case"<":return e?new Set(a[1]):new Set;case">=":return new Set(e?a[0]:a[0].concat(a[1]));case"<=":return new Set(e?a[0].concat(a[1]):a[1]);default:return new Set}}(!0===a.getValue(),o,n,r);default:return function(e,t,n,r){var a=t.type,o=new Set,i=r[a];if(i){var u=(0,p.Z)(i,2),s=u[0],l=u[1],c=ZO(e,t,n),h=Di(s,t,c,!1);if(h>=0){o.add(l[h]);for(var f=h;++h<l.length&&0===c(t,s[h]);)o.add(l[h]);for(h=f;--h>=0&&0===c(t,s[h]);)o.add(l[h])}}if(a===tC&&"="===n){var d=r[nC];d&&d[0].forEach((function(n,r){t.equals(n.toNumberVar(e.service))&&o.add(d[1][r])}))}return o}(e,a,o,n)}}(e,{range:t.target,criteriaVar:u,compareType:s},r))}(e,t)}))).forEach((function(e){var t=Math.floor(e/r);o(t,e%r)}));else if(void 0===i)for(var u=0;u<n;u++)for(var s=0;s<r;s++){for(var l=!0,c=0;c<t.length;c++){var h=t[c],f=gu(h.target.getVarByPos(u,s,e),e);if(!h.predicate(f)){l=!1;break}}l&&o(u,s)}else i()}function OO(e,t,n){var r,a;if(e===Mt.CriteriaType.Single){if((r=(0,Mt.convertCriteriaVar)(t,n)).isNumber())return[!0,r,a="="]}else if(e===Mt.CriteriaType.Compare){var o=n.getValue();a=/^(<>|=|[><]=?)/.exec(o)[0];var i=o.substr(a.length);return r=""===i?ut.NULL_VAR:(0,Mt.convertCriteriaVar)(t,new ut.StringVar(i)),"="!==a&&"<>"!==a||r.isBool()||r.isNull()?[!0,r,a]:[!1]}return[!1]}function xO(e,t){var n={},r=-1;return t.iter(Object.assign({},e,{skipEmptyRef:!1})).forEach((function(e){r++;var t=e.type,a=n[t];switch(t){case eC:a||(a=[],n[t]=a),a.push(r);break;case rC:a||(a=[[],[]],n[t]=a),!0===e.getValue()?a[0].push(r):a[1].push(r);break;default:a||(a=[[],[]],n[t]=a),a[0].push(e),a[1].push(r)}})),Object.keys(n).forEach((function(e){var t=Number(e);t!==eC&&t!==rC&&(n[e]=function(e,t){for(var n=[],r=0;r<e[0].length;r++)n.push(r);var a=function(e,t){return e<t?-1:e>t?1:0};switch(t){case nC:n.sort((function(t,n){var r=e[0][t],o=e[0][n],i=r.getValue().toLowerCase(),u=o.getValue().toLowerCase();return a(i,u)}));break;case aC:n.sort((function(t,n){var r=e[0][t].errorType,o=e[0][n].errorType;return a(r,o)}));break;default:n.sort((function(t,n){var r=e[0][t],o=e[0][n],i=r.getValue(),u=o.getValue();return a(i,u)}))}for(var o=e[0],i=e[1],u=0;u<n.length;u++)for(var s=n[u];u!==s;){var l,c,h;l=[o[n[s]],o[s]],o[s]=l[0],o[n[s]]=l[1],c=[i[n[s]],i[s]],i[s]=c[0],i[n[s]]=c[1],h=[n[s],n[u]],n[u]=h[0],n[s]=h[1],s=n[u]}return e}(n[e],t))})),n}function ZO(e,t,n){var r;switch(n){case"=":r=function(n,r){return VO(e,t,r)};break;case">=":r=function(n,r){return function(e,t,n){return(0,Mt.isComparableVar)(n)&&n.greaterThan(t)||t.isError()&&n.isError()&&t.errorType<n.errorType?0:VO(e,t,n)}(e,t,r)};break;case"<=":r=function(n,r){return function(e,t,n){if((0,Mt.isComparableVar)(n))return n.lessThan(t)?0:VO(e,t,n);if(t.isError()&&n.isError())return t.errorType>n.errorType?0:VO(e,t,n);var r=VO(e,t,n);return 0===r?0:r}(e,t,r)};break;case">":r=function(n,r){return function(e,t,n){return(0,Mt.isComparableVar)(n)?n.greaterThan(t)?0:1:t.isError()&&n.isError()?t.errorType<n.errorType?0:1:t.getValue(e)<n.getValue(e)?0:1}(e,t,r)};break;case"<":r=function(n,r){return function(e,t,n){return(0,Mt.isComparableVar)(n)?n.lessThan(t)?0:-1:t.isError()&&n.isError()?t.errorType>n.errorType?0:-1:t.getValue(e)>n.getValue(e)?0:-1}(e,t,r)};break;default:throw new Error("Unexpected info type")}return r}function DO(e,t,n){var r=0,a=0;if(n)for(;a<n.length;){for(;r<n[a];)e.add(r++);r++,a++}for(;r<t;)e.add(r++);return e}function PO(e,t,n){var r,a,o,i=t.target,u=t.criteria,s=new Ot.$w(n);Fu(i)?(a=i.getRef().sheet().id(),o=i.getRef().id(!1)):(a=AO,o=i.id());var l=null===(r=e.service.getFuncCacheManager().getInnerFuncCache("Condition",{autoBuildCache:!1}))||void 0===r?void 0:r.getCache(a,e);if(!l||!o)return s;var c=kO(u),h=l.get(c);if(h)h.set(o,s);else{var f=new Map;f.set(o,s),l.set(c,f)}return s}function LO(e,t){var n,r,a;Fu(t)?(r=t.getRef().sheet().id(),a=t.getRef().id(!1)):(r=AO,a=t.id());var o=null===(n=e.service.getFuncCacheManager().getInnerFuncCache("Sort",{autoBuildCache:!1}))||void 0===n?void 0:n.getCache(r,e);return o&&a&&o.get(a)||null}function BO(e,t){var n,r,a;if(Fu(t)?(r=t.getRef().sheet().id(),a=t.getRef().id(!1)):(r=AO,a=t.id()),!a)return null;var o=null===(n=e.service.getFuncCacheManager().getInnerFuncCache("Sort",{autoBuildCache:!1}))||void 0===n?void 0:n.getCache(r,e),i=xO(e,t);return o.set(a,i),i}var UO=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),r=1;r<t;r++)n[r-1]=arguments[r];for(var a=n[0].rowCount(),o=n[0].colCount(),i=new Array(a*o),u=0;u<n.length;u++){var s=n[u];if(0!==u&&(a!==s.rowCount()||o!==s.colCount()))return CR(this.name,a,o,s.rowCount(),s.colCount());if(bu(s)||s.size()<=SO||s.ignoreCache){var l=HO(e,s,i);if(l)return l}else{var c=LO(e,s);if(c||(c=BO(e,s)),c){var h=c[aC];if(null!=h&&h.length)return h[0][0];var f=c[tC];if(f)for(var d=function(e){var t=f[1].findIndex((function(t){return t===e}));if(-1!==t){var n=f[0][t];void 0!==i[e]?i[e]*=n.getValue():i[e]=n.getValue()}else i[e]=0},v=0;v<i.length;v++)d(v);else for(var g=0;g<i.length;g++)i[g]=0}else{var m=HO(e,s,i);if(m)return m}}}var p=i.reduce((function(e,t){return void 0===t?e:e+t}),0);return new ut.NumberVar(p)}}]),t}(gC("SUMPRODUCT",1,256,1,tC,[{type:iC},{type:iC}]));function HO(e,t,n){var r,a=0;if(t.iter(Object.assign({},e,{skipEmptyRef:!1})).exitWhen((function(e){var t=e.isError();return t&&(r=e),t})).forEach((function(e){e.isNumber()?void 0===n[a]?n[a]=e.getValue():n[a]*=e.getValue():n[a]=0,a++})),r)return r}UO=Gi([cc("SUMPRODUCT")],UO);var WO;!function(e){e.AddTask="addTask",e.RemoveTask="removeTask",e.FinishTask="FinishTask"}(WO||(WO={}));function jO(e){return zO.apply(this,arguments)}function zO(){return zO=(0,u.Z)(i().mark((function e(t){var n,r,a,o,u,s,l,c,h;return i().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:n=t.indexOf("{"),r=t.indexOf("["),a=/^[^{]+/,o=/[^}]+$/,u=/^[^\[]+/,s=/[^\]]+$/,c=t.replace(/\t/g,"  "),h="",-1!==n&&-1!==r?n<r?(h=c.replace(a,""),c=h.replace(o,"")):(h=c.replace(u,""),c=h.replace(s,"")):n>-1?(h=c.replace(a,""),c=h.replace(o,"")):r>-1&&(h=c.replace(u,""),c=h.replace(s,"")),e.prev=3,l=JSON.parse(c),e.next=12;break;case 7:return e.prev=7,e.t0=e.catch(3),e.next=11,qO(c).catch((function(e){return XO(h)}));case 11:l=e.sent;case 12:return e.abrupt("return",l);case 13:case"end":return e.stop()}}),e,null,[[3,7]])}))),zO.apply(this,arguments)}function GO(){return JO.apply(this,arguments)}function JO(){return(JO=(0,u.Z)(i().mark((function e(){return i().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,n.e("vsh_2884").then(n.t.bind(n,"vsh_22884",23));case 2:return e.abrupt("return",e.sent);case 3:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function qO(e){return $O.apply(this,arguments)}function $O(){return $O=(0,u.Z)(i().mark((function e(t){return i().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,GO();case 2:return e.abrupt("return",e.sent.parse(t));case 3:case"end":return e.stop()}}),e)}))),$O.apply(this,arguments)}function YO(){return KO.apply(this,arguments)}function KO(){return(KO=(0,u.Z)(i().mark((function e(){return i().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,n.e("vsh_5786").then(n.bind(n,"vsh_95786"));case 2:return e.abrupt("return",e.sent);case 3:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function XO(e){return QO.apply(this,arguments)}function QO(){return QO=(0,u.Z)(i().mark((function e(t){var n;return i().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,YO();case 2:return n=e.sent.jsonrepair(t),e.abrupt("return",JSON.parse(n));case 4:case"end":return e.stop()}}),e)}))),QO.apply(this,arguments)}function ex(e,t){return"object"==(0,_.Z)(e)&&t.every((function(t){return t in e}))}function tx(e,t){return nx.apply(this,arguments)}function nx(){return nx=(0,u.Z)(i().mark((function e(t,n){var r,a,o,u,s;return i().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=n.formatterService,e.prev=1,e.next=4,jO(t);case 4:if(a=e.sent,!Array.isArray(a)){e.next=8;break}return o=a[0],u=Object.keys(o),s=[u.map((function(e){return new ut.StringVar(String(e))}))],e.abrupt("return",(ex(a[a.length-1],u)||a.pop(),a.forEach((function(e){var t=[];u.forEach((function(n){var a=e[n]||"";t.push(rx(a,r))})),s.push(t)})),s));case 8:return e.abrupt("return",ut.RUNTIME_ERR_VAR);case 11:return e.prev=11,e.t0=e.catch(1),e.abrupt("return",ut.RUNTIME_ERR_VAR);case 14:case"end":return e.stop()}}),e,null,[[1,11]])}))),nx.apply(this,arguments)}var rx=function(e,t,n){if("number"==typeof e||/^-?[1-9]\d*(\.\d+)?$/.test(e)){var r,a=String(e);return((null===(r=a.match(/\d/g))||void 0===r?void 0:r.length)||0)>15?new ut.StringVar(a):new ut.NumberVar(Number(e))}var o=(0,Se.getPreferredFormatter)(t,e),i=o.value,u=o.formatter;if(i instanceof ke.SheetDate){var s=new ut.NumberVar(i.toNumber()),l=u.getFormatCode();return s.setSpecialInfo({customData:{autoFormat:l}}),s}return new ut.StringVar(e)},ax=new ut.ErrorVar(ut.ErrorType.RUNTIME_ERROR,ut.ErrorConstant.RUNTIME_ERROR,we.O6N.REQUEST_FAIL),ox=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=we.crM.TNS_AREA,n=we.crM.TNS_BRAND,r=we.crM.TNS_INPUT,a=we.crM.TNS_OUTPUT,o=we.crM.PermissionDeny,i=we.crM.MyAIStop,u=we.crM.LongTimeToWait,s=we.crM.ContextTooLong,l=e.text,c=e.status,h=e.funcName;return c===i?new ut.ErrorVar(ut.ErrorType.NAME,ut.ErrorConstant.NAME,we.O6N.SHEET_AI_NO_PERMISSION_ADMIN):c===o?new ut.ErrorVar(ut.ErrorType.NAME,ut.ErrorConstant.NAME,we.O6N.SHEET_AI_NO_PERMISSION_FG):[t,n,r,a].includes(c)?new ut.StringVar(l):c===u?new ut.ErrorVar(ut.ErrorType.WAIT_ASYNC,ut.ErrorConstant.WAIT_ASYNC,we.O6N.SHEET_AI_TAG_DATABASE_LOADING):c===s?new ut.ErrorVar(ut.ErrorType.RUNTIME_ERROR,ut.ErrorConstant.RUNTIME_ERROR,we.O6N.SHEET_AI_CONTEXT_TOO_LONG,{args:h}):ax};function ix(e,t,n,r,a){var o,i=Ax(t);if(t.cache_key=i,e.cache.has(i)&&!t[we.nbU])return e.cache.get(i);r||(r=function(t){var r=t;return 0!==r.status?e.statusNot0Err:rx(r.text,n)});var u=null===(o=e.resultMapFromServer)||void 0===o?void 0:o.get(i);if(u){var s=r(u);return s instanceof Promise?(s.then((function(t){return e.resultMapFromServer.delete(i),l(t)})).finally((function(){a&&a.service.emit("afterWaitAsyncCalc",a.formula,2)})),ut.WAIT_ASYNC_ERR_VAR):(e.resultMapFromServer.delete(i),l(s))}function l(t){return t.isError()&&t.errorType===ut.ErrorType.WAIT_ASYNC&&t.errorCode!==we.O6N.SHEET_AI_TAG_DATABASE_LOADING||e.cache.set(i,t),t}return e.addTask(t,null==a?void 0:a.ref).then((function(e){var t=r(e);return t instanceof Promise?t.then(l):l(t)})).catch((function(t){return t.status===we.crM.LongTimeToWait&&a&&e.longTimeTaskSet.add(t.key),l(ox(t))})).finally((function(){a&&a.service.emit("afterWaitAsyncCalc",a.formula,2)})),a&&a.service.addCalculatingAsyncFormula(a.formula),ut.WAIT_ASYNC_ERR_VAR}var ux=function(e,t,n,r){var a,o=e.getValue(t,n,void 0,r,!0);if(o&&"object"==(0,_.Z)(o))return null!==(a=o.text)&&void 0!==a?a:"";var i=e.getActualFormatter(t,n,r),u=e.parent.formatterService;return i?u.getFormattedText(i,o):o},sx=function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:",",r=!(arguments.length>3&&void 0!==arguments[3])||arguments[3];if(e.isRef&&e.isRef()){for(var a=e.getRef(),o=a.sheet(),i=a.rowFrom(),u=a.colFrom(),s=[],l=0;l<a.rowCount();l++)for(var c=0;c<a.colCount();c++){var h=ux(o,i+l,u+c,t);s.push(h)}return r?s.join(n):s}return e.getValue()},lx=function(e){if(!Fu(e))return!1;var t=e.getRef();return 1!==t.rowCount()||1!==t.colCount()},cx=function(e){return!!Fu(e)&&1===e.getRef().rowCount()},hx=function(e){return!!Fu(e)&&1===e.getRef().colCount()},fx=function(){return new ut.ErrorVar(ut.ErrorType.VALUE,ut.ErrorConstant.VALUE,we.O6N.SHEET_AI_FORBIDDEN_RANGE)},dx=function(e){return 0===String(e).trim().length},vx=function(){return(we.Ps3.browser.isMobile?"mb-":"pc-")+(0,At.v4)()+(new Date).getTime().toString()},gx=vx(),mx=function(){gx=vx()},px=function(){return gx};function yx(e){e.setSpecialInfo({refresh:!0})}function Cx(e){var t,n=null===(t=e.getSpecialInfo())||void 0===t?void 0:t.refresh;return n&&e.setSpecialInfo({refresh:null}),n}function _x(e,t){return ut.tractorErrorVarCreators[ut.ErrorCode.NO_VALID_DATA]({funcName:e},t)}var Rx,wx=[[2,5e3],[4,1e4],[1/0,3e4]],kx=0,Sx=null,Ex=new Map,Tx=new Set;function Ax(e){if(e.cache_key)return e.cache_key;var t=[e.sheet_id];Object.keys(e.user_input).forEach((function(n){t.push(e.user_input[n])})),t.push(e.action_type),e.target_data&&t.push(e.target_data);var n=t.join("");return bt()(n)}var Ix,bx=function(e){var t=e.maxTask,n=e.retryTime,r=e.fetch,a=e.resetOperateId,o=e.getOperateId,i=e.dispatch,u=new Set,s=[],l=[],c={},h=new Map,f=function(e){delete c[e],h.delete(e),null==i||i(WO.RemoveTask)},d=function(e){var t=h.get(e);t&&(f(e),t[1]("".concat(e," ").concat("max retry")))};function v(){var e=function(){var e=s.splice(0,t),g=!1;if(!e.length)return{v:void 0};var m=r(e,(null==o?void 0:o())||"");u.add(m),m.then((function(t){e.forEach((function(e){var r=Ax(e),a=h.get(r);if(a){var o;try{o=function(e,t){return t.formula_results[e]||{}}(r,t)}catch(e){return null!=a&&a[1](e),void f(r)}switch(o.status){case we.crM.Success:null!=a&&a[0](o),f(r),g=!0;break;case we.crM.Pending:if((c[r]||0)>=n)return void d(r);c[r]=(c[r]||0)+1,l.push(e);break;case we.crM.PermissionDeny:case we.crM.Fail:case we.crM.Unsupported:case we.crM.MyAIStop:case we.crM.LongTimeToWait:case we.crM.TNS_AREA:case we.crM.TNS_BRAND:case we.crM.TNS_INPUT:case we.crM.TNS_OUTPUT:default:null!=a&&a[1](Object.assign({},o,{key:r})),f(r)}}}))})).catch((function(t){console.error("request fail",e,t),e.forEach((function(e){var t=Ax(e);c[t]=(c[t]||0)+1,(c[t]||0)>=n&&d(t)})),e.forEach((function(e){c[Ax(e)]<n&&s.push(e)}))})).finally((function(){if(u.delete(m),s.length)v();else if(0===u.size&&l.length){var e;s=(e=[l,s])[0],l=e[1],kx++;for(var t=wx.length-1,n=wx[t][1],r=0;r<t;r++)if(kx<=wx[r][0]){n=wx[r][1];break}setTimeout(v,n)}else 0===u.size&&0===l.length&&(kx=0,null!==Sx&&clearTimeout(Sx),Sx=setTimeout((function(){s.length||u.size||l.length||null!=a&&a(),Sx=null}),100));g&&(null==i||i(WO.FinishTask))}))};for(Rx=void 0;s.length&&u.size<2;){var g=e();if("object"===(0,_.Z)(g))return g.v}}return{addTask:function(e,t){var n=e.cache_key;if(t){var r=Ex.get(n);r?r.push(t):Ex.set(n,[t])}if(h.has(n))return h.get(n)[2];var a=function(){var e=function(){},t=e,n=e,r=new Promise((function(e,r){t=e,n=r}));return[t,n,r]}();return s.push(e),h.set(n,a),0===u.size&&void 0===Rx&&(Rx=setTimeout(v,0)),null!=i&&i(WO.AddTask),a[2]},removeTask:function(e){h.has(e)&&f(e)},statusNot0Err:ax,cache:new Map,taskToCellMap:Ex,longTimeTaskSet:Tx,resetOperateId:a,getOperateId:o,getAiCacheKey:Ax}},Fx=new Map;var Mx={getActionIdByActionType:function(e,t){var n="".concat(e,",").concat(t),r=Fx.get(n);return!r&&Ix&&(r=function(e,t,n){var r,a=e.filter((function(e){return(0,J.default)(e,"extraMap.oldActionType")===t})),o=a.find((function(e){return(0,J.default)(e,"extraMap.lang")===n}));if(o)return o.id;var i=a.find((function(e){return"en"===(0,J.default)(e,"extraMap.lang")}));return i?i.id:null===(r=a[0])||void 0===r?void 0:r.id}(Ix,e,t),Fx.set(n,r)),r},prefetchAIActions:function(){return!!Ix||(0,J.default)(we.Ps3,"serverApi.aiRequest.getAiActionList",(function(){return console.log("sheet base version error")}))().then((function(e){return Ix=e,!0}))}},Vx=[we.O6N.REQUEST_FAIL,we.O6N.IMPORT_ERR_UNKNOWN,we.O6N.IMPORT_ERR_CRAWL_WAITING,we.O6N.IMPORT_ERR_CRAW_RUNNING,we.O6N.IMPORT_ERR_CRAW_FAIL],Nx=3e3,Ox=3e3,xx=function(){function e(t){var n=this,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:new Zx;(0,y.Z)(this,e),this.spread=t,this.netWorkController=r,this.importFormulaContentMap=new Map,this.formulasMap=new Map,this.uniqueKeyCache=new we.z6B(50),this.refreshImportFormulaIds=new Set,this.onFormulaCalcFinished=function(){var e=n.spread.calcEngine,t=e.formulaSpace,r=e.formulaService;0===t.dirtyFormulas.size&&0===r.getCalculatingAsyncFormulas().size&&(n.refreshErrorContent(),n.uniqueKeyCache.clear())},this.onFormulaUnregister=function(e){var t=n.formulasMap.get(e);t&&t.size&&(t.forEach((function(t){var r=n.importFormulaContentMap.get(t);r&&(r.formulas.delete(e),r.formulas.size||n.importFormulaContentMap.delete(t))})),n.formulasMap.delete(e))},this.bindEvents()}var t;return(0,C.Z)(e,[{key:"bindEvents",value:function(){var e=this.spread.calcEngine,t=e.formulaSpace;e.formulaService.addListener(ut.FormulaEvents.onFormulaValueChanged,this.onFormulaCalcFinished),t.addListener(ut.FormulaSpaceEvents.onFormulaUnregistered,this.onFormulaUnregister)}},{key:"unbindEvents",value:function(){var e=this.spread.calcEngine,t=e.formulaSpace;e.formulaService.removeListener(ut.FormulaEvents.onFormulaValueChanged,this.onFormulaCalcFinished),t.removeListener(ut.FormulaSpaceEvents.onFormulaUnregistered,this.onFormulaUnregister)}},{key:"setImportFormulaContent",value:function(e,t,n,r,a){var o=this.importFormulaContentMap.get(n);o?o.formulas.add(e):this.importFormulaContentMap.set(n,{id:n,paramsJson:t,link:r,category:a,formulas:new Set([e])});var i=this.formulasMap.get(e);i?i.add(n):this.formulasMap.set(e,new Set([n]))}},{key:"fetchFormulaDataById",value:function(e){var t=this.getCurrentSpreadToken(),n=this.importFormulaContentMap.get(e);return n?(n.promise||(n.promise=this.createFetchPromise(t,n)),n.promise):Promise.reject((0,we.NN_)(we.O6N.IMPORT_ERR_INVAILD_PARAM,""))}},{key:"createFetchPromise",value:function(e,t){var n=this,r=_C(),a=r.promise,o=r.resolve,i=r.reject;return this.netWorkController.handleFetchData(e,{uniqueKey:t.id,content:(0,we.h$Q)(t.paramsJson),category:t.category,resolve:o,reject:i}),a.then((function(e){return t.promise=void 0,t.data=e,e})).catch((function(r){return r instanceof we.AXu&&Vx.includes(r.code)?t.retryTimes&&t.retryTimes>=2?(t.promise=void 0,t.data=r,r):(0,we.Dc1)(Nx).then((function(){return void 0===t.retryTimes?t.retryTimes=1:t.retryTimes++,n.createFetchPromise(e,t)})):(t.promise=void 0,t.data=r,r)}))}},{key:"getImportFormulaId",value:function(e,t){var n=this.uniqueKeyCache.get("".concat(e,"_").concat(t));if(n)return n;var r=bt()(e,t);return this.uniqueKeyCache.set("".concat(e,"_").concat(t),r),r}},{key:"getFormulaDataById",value:function(e){var t,n;return null!==(t=null===(n=this.importFormulaContentMap.get(e))||void 0===n?void 0:n.data)&&void 0!==t?t:null}},{key:"getImportFormulasById",value:function(e){var t,n=null===(t=this.importFormulaContentMap.get(e))||void 0===t?void 0:t.formulas;return n&&n.size?Array.from(n):[]}},{key:"getIdsByFormula",value:function(e){var t=this.formulasMap.get(e);return t&&t.size?Array.from(t):[]}},{key:"getIdByFormula",value:function(e){var t=this.getIdsByFormula(e);return t.length?1===t.length?t[0]:t.sort()[0]:null}},{key:"getLabelInfoById",value:function(e){var t=this.importFormulaContentMap.get(e);return t?!t.data||t.data instanceof we.AXu?{id:e,link:t.link,category:t.category}:{id:e,link:t.link,category:t.category,lastModifyTime:t.data.crawlTimestamp}:null}},{key:"getImportFmlContent",value:function(e){return this.importFormulaContentMap.get(e)}},{key:"getCurrentSpreadToken",value:function(){return this.spread.getService(Ft.UU).token}},{key:"refreshImportFormula",value:(t=(0,u.Z)(i().mark((function e(t){var n,r,a,o,u,s=this;return i().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:n=[],r=_n(t);try{for(r.s();!(a=r.n()).done;)o=a.value,(u=this.importFormulaContentMap.get(o))&&(u.data=void 0,this.refreshImportFormulaIds.add(o),n.push({uniqueKey:o,category:u.category,content:(0,we.h$Q)(u.paramsJson)}),this.markDirtyFormulasById(o))}catch(e){r.e(e)}finally{r.f()}this.netWorkController.requestImportFormulaRefresh(this.getCurrentSpreadToken(),n),this.refreshImportFormulaTimer&&clearTimeout(this.refreshImportFormulaTimer),this.refreshImportFormulaTimer=setTimeout((function(){s.refreshImportFormulaIds.size&&(s.refreshImportFormulaIds.forEach((function(e){return s.fetchFormulaDataById(e)})),s.refreshImportFormulaIds.clear()),s.refreshImportFormulaTimer&&clearTimeout(s.refreshImportFormulaTimer)}),Ox);case 4:case"end":return e.stop()}}),e,this)}))),function(e){return t.apply(this,arguments)})},{key:"handleServerMessage",value:function(e,t){this.refreshImportFormulaIds.delete(e);var n=this.importFormulaContentMap.get(e);if(n){var r=(0,we.R5d)(t);r?n.data=r:this.fetchFormulaDataById(e),this.markDirtyFormulasById(e)}}},{key:"markDirtyFormulasById",value:function(e){if(this.importFormulaContentMap.get(e)){var t=this.getImportFormulasById(e);this.spread.calcEngine.markDirty(t.map((function(e){return e.getRef()})),PM)}}},{key:"reCalcImportFormulas",value:function(){var e=this,t=[];this.formulasMap.forEach((function(n,r){r.isDirty()||(n.forEach((function(t){return e.importFormulaContentMap.delete(t)})),t.push(r.getRef()))})),t.length&&this.spread.calcEngine.markDirty(t,PM)}},{key:"refreshErrorContent",value:function(){this.importFormulaContentMap.forEach((function(e){e.data&&(e.data instanceof we.AXu||e.data instanceof ut.ErrorVar)&&(e.data=void 0)}))}},{key:"hasBlackToken",value:function(e){var t=e.formula.tokens;if(!t||!t.length)return!0;var n=function(e){var n=t[e];if(we.nFA.find((function(e){return n.includes(e)})))return{v:!0}};for(var r in t){var a=n(r);if("object"===(0,_.Z)(a))return a.v}return!1}},{key:"reset",value:function(){this.importFormulaContentMap.clear(),this.uniqueKeyCache.clear(),this.netWorkController.reset()}},{key:"dispose",value:function(){this.reset(),this.unbindEvents()}}]),e}();xx.ImportFormulaPromiseMap=new Map;var Zx=function(){function e(){(0,y.Z)(this,e)}var t;return(0,C.Z)(e,[{key:"setMetaProvider",value:function(e){this.metaRequestProvider=e}},{key:"setBlockProvider",value:function(e){this.blockRequestProvider=e}},{key:"setRefreshProvider",value:function(e){this.refreshRequestProvider=e}},{key:"initRequestQueue",value:function(e){this.requestQueue||(this.requestQueue=new DC((0,l.Z)({},Xy.ImportFormulas,this.requestImportFormulaData.bind(this))),void 0!==e&&this.requestQueue.setDelayTime(e))}},{key:"handleFetchData",value:function(e,t){var n;this.initRequestQueue();var r=_C(),a=r.promise,o=r.resolve,i=r.reject;return null!==(n=this.requestQueue)&&void 0!==n&&n.push({type:Xy.ImportFormulas,spreadToken:e,params:t,resolve:o,reject:i}),a}},{key:"requestImportFormulaData",value:function(e,t){var n=this;this.metaRequestProvider||(this.metaRequestProvider=we.Ps3.serverApi.importFormula.requestImportFormulaMeta);kC(t.reduce((function(e,t){return e.find((function(e){return e.uniqueKey===t.uniqueKey}))||e.push(t),e}),[]),(function(t){return n.metaRequestProvider({token:e,formulas:t.map((function(e){return{category:e.category,content:e.content,uniqueKey:e.uniqueKey}}))}).then((function(r){r||t.forEach((function(e){return(0,e.reject)(we.rur[we.O6N.REQUEST_FAIL])}));for(var a=function(a){var o=r[a],i=t.find((function(e){return e.uniqueKey===o.uniqueKey})),u=(0,we.R5d)(o.status);if(u)null==i||i.reject(u);else if(o.formulaData)if("IMAGE"!==o.category)n.requestImportFormulaBlock(e,o).then((function(e){null==i||i.resolve(e)}));else{var s=JSON.parse((0,we.tVG)(o.formulaData)).fileToken;null==i||i.resolve({id:o.uniqueKey,category:o.category,crawlTimestamp:o.crawlTimestamp,fileToken:s})}else null==i||i.reject(we.rur[we.O6N.IMPORT_ERR_CRAW_FAIL])},o=0;o<r.length;o++)a(o)})).catch((function(e){t.forEach((function(t){return(0,t.reject)(e)}))}))}))}},{key:"requestImportFormulaBlock",value:(t=(0,u.Z)(i().mark((function e(t,n){var r,a,o,s,l,c,h,f,d=this;return i().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.blockRequestProvider||(this.blockRequestProvider=we.Ps3.serverApi.importFormula.requestImportFormulaBlock),r=JSON.parse((0,we.tVG)(n.formulaData)),a=r.blockTokens,o=r.rowCounts,s=r.rowStarts,l=r.totalRowCount,c=r.totalColCount,a){e.next=4;break}return e.abrupt("return",we.rur[we.O6N.NO_QUERY_OUTPUT]);case 4:return h=[],f=function(){var e=(0,u.Z)(i().mark((function e(n){var r,a,u,l;return i().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,d.blockRequestProvider({token:t,blockTokens:n});case 2:for(r=e.sent,a=0;a<r.length;a++)u=r[a],l=n.indexOf(u.blockToken),h.push({rowStart:s[l],rowCount:o[l],gzipDataTable:u.gzipDataTable});case 4:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),e.next=7,kC(a,f);case 7:return e.abrupt("return",{id:n.uniqueKey,category:n.category,crawlTimestamp:n.crawlTimestamp,totalRowCount:l,totalColCount:c,table:Dx(h,l,c)});case 8:case"end":return e.stop()}}),e,this)}))),function(e,n){return t.apply(this,arguments)})},{key:"requestImportFormulaRefresh",value:function(e,t){this.refreshRequestProvider||(this.refreshRequestProvider=we.Ps3.serverApi.importFormula.requestImportFormulaRefresh),this.refreshRequestProvider({token:e,formulas:t})}},{key:"reset",value:function(){this.requestQueue&&(this.requestQueue.dispose(),this.requestQueue=void 0)}}]),e}();function Dx(e,t,n){for(var r=[],a=0,o=0;o<e.length;o++){for(var i=e[o],u=i.rowStart,s=i.rowCount,l=i.gzipDataTable,c=a;c<u;c++)r[c]=new Array(n).fill(ut.NULL_VAR);for(var h=(0,we.ecX)(l),f=u+s,d=a;d<f;d++){var v;if(h.rows[d-a]){r[d]||(r[d]=[]);for(var g=null!==(v=h.rows[d-a].columns)&&void 0!==v?v:[],m=0;m<n;++m){var p=ut.NULL_VAR;if(m<g.length&&g[m])p=RC(g[m].value,{});r[d][m]=p}}else r[d]=new Array(n).fill(ut.NULL_VAR)}a=f}for(var y=a;y<t;++y)r[y]=[ut.NULL_VAR];return r}function Px(e,t,n){if(t.colCount()>n.colCount()||t.rowCount()>n.rowCount()){var r=new Oi(n.rowFrom(),n.colFrom(),t.rowCount(),t.colCount(),n.sheet());Array.isArray(e.info.customDepends)||(e.info.customDepends=[]),e.info.customDepends.push(r)}}var Lx=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e,t,n,r){if(!Fu(t)&&!Au(t))return wR(this.name,1);if(!Fu(r)&&!r.isNull())return wR(this.name,3);if(!r.isNull()&&!r.getRef().sheet())return ut.REF_ERR_VAR;var a=(0,Mt.buildCriteria)(e,n);if(null===a)return new ut.NumberVar(0);if(r.isNull())r=t;else if(Fu(t)&&Fu(r)&&r.size()!==t.size()){var o=t.getRef(),i=(r=r.clone()).getRef();i.setRowCount(o.rowCount()),i.setColCount(o.colCount()),Px(e,o,i)}var u=0;return NO(e,[{target:t,criteria:n,predicate:a}],t.rowCount(),t.colCount(),t.ignoreCache,(function(t,n){var a=gu(r.getVarByPos(t,n,e),e);a.isNumber()&&(u+=a.getValue())})),new ut.NumberVar(u)}}]),t}(gC("SUMIF",2,1,0,tC,[{type:iC},{type:nC|tC|rC|aC},{type:iC|eC,default:{ifInputNull:ut.VALUE_ERR_VAR,ifNotInput:ut.NULL_VAR}}])),Bx=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e,t){if(!Fu(t))return wR(this.name,1);for(var n=[],r=t.rowCount(),a=t.colCount(),o=arguments.length,i=new Array(o>2?o-2:0),u=2;u<o;u++)i[u-2]=arguments[u];for(var s=0;s<i.length;s++)if(s%2==0){var l=i[s];if(!Fu(l)&&!Au(l))return wR(this.name,s);if(l.rowCount()!==r||l.colCount()!==a)return kR(this.name);var c=i[s+1],h=(0,Mt.buildCriteria)(e,c);if(null===h)return new ut.NumberVar(0);n.push({target:l,criteria:c,predicate:h})}var f=0,d=function(n,r){var a=t.getVarByPos(n,r,e);a.isNumber()&&(f+=a.getValue())};return NO(e,n,r,a,t.ignoreCache,d),new ut.NumberVar(f)}}]),t}(gC("SUMIFS",3,256,2,tC,[iw.MATRIX_AND_SHEET_REF,iw.MATRIX_AND_SHEET_REF,{type:nC|tC|rC|aC},iw.MATRIX_AND_SHEET_REF,{type:nC|tC|rC|aC}])),Ux=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e,t,n,r,a){var o=n.getValue(),i=r.isNull()?0:r.getValue(),u=a.getValue();if(o<0||i<0){var s=o<0?2:3;return W_(this.name,s)}if(u<=0)return $_(this.name,u,4,1);var l=function(e,t){if(Au(e))return t>1?we.d$b[we.O6N.REF_PARAMETER_SHOULD_BE_LESS_THAN_OR_EQUAL_TO]({funcName:"",index:-1,value:t,upperBound:1}):e;if(Fu(e)){var n=1,r=null;return bu(e)&&(n=(r=e.getRefs()).length),t>n?we.d$b[we.O6N.REF_PARAMETER_SHOULD_BE_LESS_THAN_OR_EQUAL_TO]({funcName:"",index:-1,value:t,upperBound:n}):null===r?e:new Su(r[t-1])}return e}(t,u);if(l.isError())return l.info.args.funcName=this.name,l.info.args.index=4,l;if(r.isNull()&&(1===l.rowCount()&&(i=o,o=1),1===l.colCount()&&(i=1)),o>l.rowCount()||i>l.colCount()){var c=3,h=i;return o>l.rowCount()&&(c=2,h=o),we.d$b[we.O6N.REF_OUT_OF_RANGE_PARAMETER]({funcName:this.name,index:c,value:h.toString()})}return Au(l)?function(e,t,n,r){if(0===n&&0===r)return t;if(0===n){for(var a=[],o=0;o<t.rowCount();o++)a.push([t.getVarByPos(o,r-1,e)]);return new Ru(a)}if(0===r){for(var i=[],u=0;u<t.colCount();u++)i.push(t.getVarByPos(n-1,u,e));return new Ru([i])}return t.getVarByPos(n-1,r-1,e)}(e,l,o,i):r.isNull()&&0===i?we.d$b[we.O6N.REF_RANGE_MUST_BE_SINGLE_ROW_OR_COLUMN]({funcName:this.name}):function(e,t,n){var r=e.getRef();return new Su(0===t&&0===n?r:0===t?new Oi(r.rowFrom(),r.colFrom()+n-1,r.rowCount(),1,r.sheet(),r.refStatus()):0===n?new Oi(r.rowFrom()+t-1,r.colFrom(),1,r.colCount(),r.sheet(),r.refStatus()):new Oi(r.rowFrom()+t-1,r.colFrom()+n-1,1,1,r.sheet(),r.refStatus()))}(l,o,i)}}]),t}(gC("INDEX",2,2,0,dC,[{type:iC},{type:tC,isMappable:!1},{type:tC|eC,default:(Ye={},(0,l.Z)(Ye,ut.DefaultParam.IfNotInput,ut.NULL_VAR),(0,l.Z)(Ye,ut.DefaultParam.IfInputNull,new ut.NumberVar(0)),Ye),isMappable:!1},{type:tC,default:new ut.NumberVar(1),isMappable:!1}]));var Hx=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e,t,n){if(n.isBool())return we.d$b[we.O6N.INVALID_FORMAT_PATTERN]({funcName:this.name,code:n.getValue().toString().toUpperCase()});t.isBool()&&(t=t.toStringVar());var r=t.getValue();if(t.isString()){var a=t.toNumberVar(e.service);a.isNumber()&&(r=a.getValue())}var o=e.ref.sheet();if(!o)return ut.VALUE_ERR_VAR;var i=n.getValue(),u=(0,Se.createFormatter)(o.formatterService,i);return u.hasSyntaxError()?we.d$b[we.O6N.INVALID_FORMAT_PATTERN]({funcName:this.name,code:i}):new ut.StringVar(u.format(r))}}]),t}(gC("TEXT",2,0,0,tC,[{type:tC|nC|rC},{type:nC|rC}])),Wx=function(e){function t(){var e;return(0,y.Z)(this,t),(e=(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))).calcCustomData=function(){return{autoFormat:"hh:mm"}},e}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e,t,n,r){var a=Math.floor(t.getValue()),o=Math.floor(n.getValue()),i=Math.floor(r.getValue());if(a<0||o<0||i<0){var u=a<0?1:o<0?2:3;return H_(this.name,u)}return new ut.NumberVar(ke.SheetDate.from({year:1899,month:12,date:30,hours:a,minutes:o,seconds:i}).toNumber()%1)}}]),t}(gC("TIME",3,0,0,tC,[{type:tC},{type:tC},{type:tC}])),jx=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e,t){var n=AV(e,t.getValue());return n?new ut.NumberVar(n.toNumber()%1):we.d$b[we.O6N.CANNOT_PARSE_TEXT_TO_DATE]({funcName:this.name,arg:t.getValue()})}}]),t}(gC("TIMEVALUE",1,0,0,tC,[{type:nC}])),zx=function(e){function t(){var e;return(0,y.Z)(this,t),(e=(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))).calcCustomData=function(){return{autoFormat:"yyyy/mm/dd"}},e.alwaysCalc=!0,e}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"shouldMarkDirty",value:function(){return Gx()!==t.todayCache}},{key:"func",value:function(){var e=Gx();return t.todayCache=e,new ut.NumberVar(e)}}]),t}(gC("TODAY",0,0,0,tC,[]));function Gx(){var e=ke.SheetDate.fromLocalDate(new Date).toNumber();return Math.floor(e)}zx.todayCache=null;var Jx=function(e){function t(){var e;return(0,y.Z)(this,t),(e=(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))).alwaysCalc=!0,e.calcCustomData=function(){return{autoFormat:"yyyy/mm/dd HH:mm"}},e}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e){var t=ke.SheetDate.fromLocalDate(new Date);return new ut.NumberVar(t.toNumber())}}]),t}(gC("NOW",0,0,0,tC,[])),qx=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e,t,n,r,a,o){if(Au(t))return wR(this.name,1);if(bu(t))return ER(this.name,1,"");var i=t.getRef(),u=i.sheet();if(!u)return ut.REF_ERR_VAR;var s=i.refStatus(),l=i.rowFrom()+n.getValue(),c=i.colFrom()+r.getValue(),h=a.isNull()?i.rowCount():a.getValue(),f=o.isNull()?i.colCount():o.getValue();if(0===h||0===f){var d=0===h?4:5;return we.d$b[we.O6N.REF_PARAMETER_SHOULD_BE_GREATER_THAN_OR_EQUAL_TO]({funcName:this.name,index:d,value:0,lowerBound:1})}var v=h<0?l+h+1:l,g=f<0?c+f+1:c,m=f<0?c:c+f-1;if(v<0||g<0||(h<0?l:l+h-1)>=u.getRowCount()||m>=u.getColumnCount())return ZR;var p=new Oi(v,g,Math.abs(h),Math.abs(f),u,s);return e.info&&(Array.isArray(e.info.customDepends)?e.info.customDepends.push(p):e.info.customDepends=[p]),new Su(p)}}]),t}(gC("OFFSET",3,2,0,iC,[{type:iC},{type:tC,isMappable:!1},{type:tC,isMappable:!1},{type:tC|eC,isMappable:!1,default:ut.NULL_VAR},{type:tC|eC,isMappable:!1,default:ut.NULL_VAR}]));function $x(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1;return H_(e,t)}var Yx=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e,t){var n=t.getValue();if(n<0)return $x(this.name);var r=ke.SheetDate.fromNumber(n).date;return new ut.NumberVar(r)}}]),t}(gC("DAY",1,0,0,tC,[{type:tC}])),Kx=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e,t){var n=t.getValue();if(n<0)return $x(this.name);var r=ke.SheetDate.fromNumber(n).month;return new ut.NumberVar(r)}}]),t}(gC("MONTH",1,0,0,tC,[{type:tC}])),Xx=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e,t){var n=t.getValue();if(n<0)return $x(this.name);var r=ke.SheetDate.fromNumber(n).year;return new ut.NumberVar(r)}}]),t}(gC("YEAR",1,0,0,tC,[{type:tC}])),Qx=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e,t){var n=t.getValue();if(n<0)return $x(this.name);var r=ke.SheetDate.fromNumber(n).seconds;return new ut.NumberVar(r)}}]),t}(gC("SECOND",1,0,0,tC,[{type:tC}])),eZ=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e,t){var n=t.getValue();if(n<0)return $x(this.name);var r=ke.SheetDate.fromNumber(n).minutes;return new ut.NumberVar(r)}}]),t}(gC("MINUTE",1,0,0,tC,[{type:tC}])),tZ=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e,t){var n=t.getValue();if(n<0)return $x(this.name);var r=ke.SheetDate.fromNumber(n).hours;return new ut.NumberVar(r)}}]),t}(gC("HOUR",1,0,0,tC,[{type:tC}])),nZ=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e,t,n,r){var a=r.getValue().toLocaleUpperCase(),o=Math.floor(t.getValue()),i=Math.floor(n.getValue());if(o<0||i<0){var u=o<0?1:2;return H_(this.name,u)}if(o>i){var s=e.ref.sheet();return s?eR(this.name,s,o,1,i,2):ut.VALUE_ERR_VAR}var l=ke.SheetDate.fromNumber(o).time,c=ke.SheetDate.fromNumber(i).time;switch(a){case"Y":return new ut.NumberVar(c.year-l.year+(c.month<l.month||c.month===l.month&&c.date<l.date?-1:0));case"M":return new ut.NumberVar(12*(c.year-l.year)+(c.month-l.month)+(c.date<l.date?-1:0));case"D":return new ut.NumberVar(i-o);case"MD":var h=c.date-l.date;return h+=h<0?(0,ke.getDaysOfMonth)(c.year,c.month-1):0,new ut.NumberVar(h);case"YM":var f=c.month-l.month;return f+=(f<0||0===f&&c.date<l.date?12:0)+(c.date<l.date?-1:0),new ut.NumberVar(f);case"YD":if(3===c.month&&c.month>l.month&&c.date<l.date){var d=c.year;return d-=c.month<l.month||c.month===l.month&&c.date<l.date?1:0,new ut.NumberVar((Date.UTC(c.year,c.month-1,c.date)-Date.UTC(d,l.month-1,l.date))/ke.SheetDate.DAY_MILLISECONDS)}var v=l.year;return v+=c.month<l.month||c.month===l.month&&c.date<l.date?1:0,new ut.NumberVar((Date.UTC(v,c.month-1,c.date)-Date.UTC(l.year,l.month-1,l.date))/ke.SheetDate.DAY_MILLISECONDS);default:return function(e,t,n,r){return ut.tractorErrorVarCreators[ut.ErrorCode.NUM_PARAMETER_VALUE_NOT_IN_LIST]({funcName:e,index:t,value:n,validValues:Array.isArray(r)?r.join(", "):r})}(this.name,3,a,"'Y', 'M', 'D', 'MD', 'YM', 'YD',")}}}]),t}(gC("DATEDIF",3,0,0,tC,[{type:tC},{type:tC},{type:nC}])),rZ=uw(ow,iC|tC),aZ=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e,t,n){var r=Math.floor(t.getValue(e)),a=Math.floor(n.getValue(e));if(r<0||a<0){var o=a<0?1:2;return H_(this.name,o)}return new ut.NumberVar(r-a)}}]),t}(gC("DAYS",2,0,0,tC,[rZ,rZ])),oZ=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e,t,n,r){var a=Math.floor(t.getValue()),o=Math.floor(n.getValue()),i=r.getValue();if(a<0||o<0){var u=a<0?1:2;return H_(this.name,u)}return new ut.NumberVar(function(e,t,n){var r=1,a=ke.SheetDate.fromNumber(e).time,o=ke.SheetDate.fromNumber(t).time;if(n&&t<e){var i=a;a=o,o=i,r=-1}var u=a.year,s=a.month,l=a.date,c=o.year,h=o.month,f=o.date,d=31,v=30;if(l===d)l-=1;else if(!n&&2===s)switch(l){case 28:(0,ke.isLeapYear)(a.year)||(l=v);break;case 29:l=v}return f===d&&(n?f=v:l===v&&f--),r*(f-l+(h-s)*v+360*(c-u))}(a,o,i))}}]),t}(gC("DAYS360",2,1,0,tC,[{type:tC},{type:tC},{type:rC,default:new ut.BooleanVar(!1)}]));var iZ=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e,t){if(0===t.size())return ut.NA_ERR_VAR;var n=t.getRef().sheet();if(!n)return ut.REF_ERR_VAR;var r=n.getCalcEngine();return TV(t,(function(t){return t.isFormula()?new ut.StringVar("=".concat(r.decompile(t,e))):we.d$b[we.O6N.INVALID_FORMULA_PARSED_RESULT]()}))}}]),t}(gC("FORMULATEXT",1,0,0,nC,[iw.SHEET_REF]));var uZ=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e,t,n){var r=null,a=[];if(t.iter(e).exitWhen((function(e){return!!e.isError()&&(r=e,!0)})).filter((function(e){return e.isNumber()})).forEach((function(e){return a.push(e.getValue())})),r)return r;if(!a.length)return new Ru([[new ut.NumberVar(0)],[new ut.NumberVar(0)]]);var o=[];if(n.iter(e).filter((function(e){return e.isNumber()})).forEach((function(e){return o.push(e.getValue())})),!o.length)return new Ru([[new ut.NumberVar(0)],[new ut.NumberVar(a.length)]]);var i=function(e){var t=[],n=e.map((function(e,t){return{num:e,idx:t}})).sort((function(e,t){return e.num-t.num}));return n.forEach((function(e,r){var a=e.num,o=e.idx;t[o]=0===r?{end:a}:{end:a,start:n[r-1].num}})),t.push({start:n[n.length-1].num}),t}(o),u=new Array(i.length).fill(0);return a.forEach((function(e){var t=i.findIndex((function(t){var n=!0,r=!0;return"number"==typeof t.start&&(n=t.start<e),"number"==typeof t.end&&(r=t.end>=e),n&&r}));-1!==t&&u[t]++})),new Ru(u.map((function(e){return[new ut.NumberVar(e)]})))}}]),t}(gC("FREQUENCY",2,0,0,iC|tC,[{type:iC},{type:iC}]));uZ=Gi([cc("FREQUENCY")],uZ);var sZ=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e,t){if(void 0===t){var n=e.ref;if(e.info){var r=n.clone();Array.isArray(e.info.customDepends)?e.info.customDepends.push(r):e.info.customDepends=[r]}var a=n.rowFrom();return new ut.NumberVar(a+1)}if(bu(t))return TR(this.name,1,"");var o=t.getRef(),i=o.rowFrom();if(e.isArray){for(var u=[],s=0;s<o.rowCount(!0);s++)u[s]=[new ut.NumberVar(i+s+1)];return new Ru(u)}return new ut.NumberVar(i+1)}}]),t}(gC("ROW",0,1,0,tC|iC,[iw.SHEET_REF])),lZ=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e,t){if(bu(t))return TR(this.name,1,"");var n=0;if(t.isRef())n=t.getRef().rowCount();else if(Au(t))n=t.rowCount();else{if(t.isString()||t.isBool())return yR(this.name,1,t.isString()?t.getValue().toString():t.getValue().toString().toUpperCase(),t.isString()?ut.FormulaErrorPhrases.DATA_TYPE_STRING:ut.FormulaErrorPhrases.DATA_TYPE_BOOLEAN,"".concat(ut.FormulaErrorPhrases.DATA_TYPE_DOUBLE,",").concat(ut.FormulaErrorPhrases.DATA_TYPE_REFERENCE,",").concat(ut.FormulaErrorPhrases.DATA_TYPE_MATRIX));if(t.isNumber())return new ut.NumberVar(1)}return new ut.NumberVar(n)}}]),t}(gC("ROWS",1,0,0,tC,[{type:iC|nC|rC|tC}])),cZ=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e,t){if(void 0===t){var n=e.ref;if(e.info){var r=n.clone();Array.isArray(e.info.customDepends)?e.info.customDepends.push(r):e.info.customDepends=[r]}var a=n.colFrom();return new ut.NumberVar(a+1)}if(bu(t))return TR(this.name,1,"");var o=t.getRef(),i=o.colFrom();if(e.isArray){for(var u=[],s=0;s<o.colCount(!0);s++)u[s]=new ut.NumberVar(i+s+1);return new Ru([u])}return new ut.NumberVar(i+1)}}]),t}(gC("COLUMN",0,1,0,tC|iC,[iw.SHEET_REF])),hZ=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e,t){var n=0;if(bu(t))return we.d$b[we.O6N.REF_INVALID_CELL_REFERENCE]({funcName:this.name,index:1,value:""});if(Fu(t))n=t.getRef().colCount();else if(Au(t))n=t.colCount();else{if(t.isString()||t.isBool())return yR(this.name,1,t.isString()?t.getValue().toString():t.getValue().toString().toUpperCase(),t.isString()?ut.FormulaErrorPhrases.DATA_TYPE_STRING:ut.FormulaErrorPhrases.DATA_TYPE_BOOLEAN,ut.FormulaErrorPhrases.DATA_TYPE_DOUBLE);if(t.isNumber())return new ut.NumberVar(1)}return new ut.NumberVar(n)}}]),t}(gC("COLUMNS",1,0,0,tC,[{type:iC|nC|rC|tC}])),fZ=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e,t,n){if(!t.isRef()&&!Au(t))return ut.REF_ERR_VAR;if((arguments.length<=3?0:arguments.length-3)%2!=0)return ut.VALUE_ERR_VAR;var r=t.rowCount(),a=t.colCount(),o=[],i=(0,Mt.buildCriteria)(e,n);if(null==i)return new ut.NumberVar(0);o.push({target:t,predicate:i,criteria:n});for(var u=0;u<(arguments.length<=3?0:arguments.length-3);u+=2){var s=u+3<3||arguments.length<=u+3?void 0:arguments[u+3];if(!s||r!==s.rowCount()||a!==s.colCount())return kR(this.name);if(!s.isRef()&&!Au(s))return ut.REF_ERR_VAR;n=u+1+3<3||arguments.length<=u+1+3?void 0:arguments[u+1+3];var l=(0,Mt.buildCriteria)(e,n);if(null===l)return new ut.NumberVar(0);o.push({target:s,predicate:l,criteria:n})}var c=0,h=function(){return c++},f=function(){for(var n=new Set,r=0,a=t.size();r<a;r++)n.add(r);n.forEach((function(t){for(var r=0;r<o.length;r++){var a=o[r].target;if(!o[r].predicate(a.nth(t,e))){n.delete(t);break}}})),c=n.size};return NO(e,o,r,a,t.ignoreCache||bu(t),h,bu(t)?f:void 0),new ut.NumberVar(c)}}]),t}(gC("COUNTIFS",2,256,2,tC,[iw.MATRIX_AND_SHEET_REF,{type:tC|nC|rC|aC},{type:iC},{type:tC|nC|rC|aC}])),dZ=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e,t,n,r){if(!Fu(t)&&!Au(t))return wR(this.name,1);if(!Fu(r)&&!r.isNull())return wR(this.name,3);if(t.isRef()&&bu(t)||r.isRef()&&bu(r))return ER(this.name,1,"");if(!r.isNull()&&!r.getRef().sheet())return ut.REF_ERR_VAR;var a=(0,Mt.buildCriteria)(e,n);if(null===a)return new ut.NumberVar(0);if(r.isNull())r=t;else if(Fu(t)&&Fu(r)&&r.size()!==t.size()){var o=t.getRef(),i=(r=r.clone()).getRef();i.setRowCount(o.rowCount()),i.setColCount(o.colCount()),Px(e,o,i)}var u=0,s=0;return NO(e,[{target:t,criteria:n,predicate:a}],t.rowCount(),t.colCount(),t.ignoreCache,(function(t,n){var a=gu(r.getVarByPos(t,n,e),e);a.isNumber()&&(u+=a.getValue(),s++)})),0===s?PR(""):new ut.NumberVar(u/s)}}]),t}(gC("AVERAGEIF",2,1,0,tC,[{type:iC},{type:nC|tC|rC|aC},{type:iC|eC,default:{ifInputNull:ut.VALUE_ERR_VAR,ifNotInput:ut.NULL_VAR}}])),vZ=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e,t){if(!Fu(t))return wR(this.name,1);if(t.isRef()&&bu(t))return ER(this.name,1,"");for(var n=[],r=t.rowCount(),a=t.colCount(),o=arguments.length,i=new Array(o>2?o-2:0),u=2;u<o;u++)i[u-2]=arguments[u];for(var s=0;s<i.length;s++)if(s%2==0){var l=i[s];if(!Fu(l)&&!Au(l))return wR(this.name,s);if(bu(l))return ER(this.name,1,"");if(l.rowCount()!==r||l.colCount()!==a)return kR(this.name);var c=i[s+1],h=(0,Mt.buildCriteria)(e,c);if(null===h)return new ut.NumberVar(0);n.push({target:l,criteria:c,predicate:h})}var f=0,d=0;return NO(e,n,r,a,t.ignoreCache,(function(n,r){var a=t.getVarByPos(n,r,e);a.isNumber()&&(f+=a.getValue(),d++)})),0===d?PR(""):new ut.NumberVar(f/d)}}]),t}(gC("AVERAGEIFS",3,256,2,tC,[iw.MATRIX_AND_SHEET_REF,iw.MATRIX_AND_SHEET_REF,{type:nC|tC|rC|aC},iw.MATRIX_AND_SHEET_REF,{type:nC|tC|rC|aC}])),gZ=1048576,mZ=[1,2,3,4],pZ=function(e){function t(){var e;return(0,y.Z)(this,t),(e=(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))).convertVariant=function(e,t){var n=rw(e,t);return 4===t.index&&t.argument.isRef()&&n.convertedArgument.isNull()?{isError:!1,convertedArgument:new ut.StringVar(""),srcArg:t.argument}:n},e}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e,t,n,r,a,o){var i=Math.floor(t.getValue()),u=Math.floor(n.getValue()),s=r.getValue();if(i!=i||u!=u)return ut.VALUE_ERR_VAR;if(i<1||i>gZ)return gR(this.name,1,i,1,gZ);if(u<1||u>16384)return gR(this.name,2,i,1,16384);if(!mZ.includes(s))return gR(this.name,3,i,mZ[0],mZ[mZ.length-1]);var l=a.getValue(),c="";return o&&!o.isNull()&&(c=si(o.getValue())+"!"),c+=l?(1&s?"$":"")+(0,we.hdC)(u-1)+(s<3?"$":"")+i:"R"+(s<3?i:"["+i+"]")+"C"+(1&s?u:"["+u+"]"),new ut.StringVar(c)}}]),t}(gC("ADDRESS",2,3,0,dC,[{type:tC},{type:tC},{type:tC,default:new ut.NumberVar(1)},{type:rC,default:new ut.BooleanVar(!0)},{type:nC|eC}])),yZ=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e,t,n){var r=t.getValue(),a=n.getValue();if(r=Math.floor(r),a=a<0?Math.ceil(a):Math.floor(a),r<0)return H_(this.name,1);var o=function(e,t){var n=ke.SheetDate.fromNumber(e),r=n.year,a=n.month,o=n.date,i=(0,ke.getDaysOfMonth)(r,a+t);return ke.SheetDate.from({year:r,month:a+t,date:Math.min(o,i)}).toNumber()}(r,a);return o<0?VR(this.name,o,0):new ut.NumberVar(o)}}]),t}(gC("EDATE",2,0,0,tC,[{type:tC,default:ut.NA_ERR_VAR},{type:tC,default:ut.NA_ERR_VAR}]));var CZ=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e,t,n){var r=t.getValue(),a=n.getValue();if(r=Math.floor(r),a=a<0?Math.ceil(a):Math.floor(a),r<0)return ut.NUM_ERR_VAR;var o=function(e,t){var n=ke.SheetDate.fromNumber(e),r=n.year,a=n.month,o=(0,ke.getDaysOfMonth)(r,a+t);return ke.SheetDate.from({year:r,month:a+t,date:o}).toNumber()}(r,a);return o<0?ut.NUM_ERR_VAR:new ut.NumberVar(o)}}]),t}(gC("EOMONTH",2,0,0,tC,[{type:tC,default:ut.NA_ERR_VAR},{type:tC,default:ut.NA_ERR_VAR}]));var _Z=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e,t,n){var r=t.getValue(),a=n.getValue(),o=e.ref,i=o.sheet();if(!i)return TR(this.name,-1,"");var u=ql(r,{ref:o,refStyle:a?"A1":"R1C1",spread:i.getParent()});return u&&u.isRef()?(e.info&&(Array.isArray(e.info.customDepends)?e.info.customDepends.push(u):e.info.customDepends=[u]),new Su(u)):ut.REF_ERR_VAR}}]),t}(gC("INDIRECT",1,1,0,dC,[{type:nC,isMappable:!1},{type:rC,isMappable:!1,default:new ut.BooleanVar(!0)}])),RZ=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),r=1;r<t;r++)n[r-1]=arguments[r];var a=TN.apply(void 0,n);if(a instanceof ut.ErrorVar)return AN(a,this.name,n[0],n[1],e);var o=n[3].getValue(),i=n[0].getValue(),u=a.start.toNumber(),s=fN(u<0?0:u,i,o);return null===s?ut.NUM_ERR_VAR:new ut.NumberVar(s.duration)}}]),t}(gC("COUPDAYBS",3,1,0,tC,[{type:tC},{type:tC},{type:tC,default:ut.NA_ERR_VAR},{type:tC,default:new ut.NumberVar(0)}])),wZ=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),r=1;r<t;r++)n[r-1]=arguments[r];var a=EN.apply(void 0,(0,m.Z)(n.map((function(e){return e.getValue()}))));if(a instanceof ut.ErrorVar)return AN(a,this.name,n[0],n[1],e);var o=a.basis,i=a.frequency,u=12,s=365;if(0===o||2===o||4===o)return new ut.NumberVar(u/i*30);if(3===o)return new ut.NumberVar(u/i*(s/u));var l=yN(a.settlement,a.maturity,i),c=l.start,h=l.end;h.date>c.date&&c.toNumber()>0&&h.setDateTime({date:c.date});var f=fN(c.toNumber(),h.toNumber(),o);return null===f?ut.NUM_ERR_VAR:new ut.NumberVar(f.duration)}}]),t}(gC("COUPDAYS",3,1,0,tC,[{type:tC},{type:tC},{type:tC,default:ut.NA_ERR_VAR},{type:tC,default:new ut.NumberVar(0)}])),kZ=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),r=1;r<t;r++)n[r-1]=arguments[r];var a=TN.apply(void 0,n);if(a instanceof ut.ErrorVar)return AN(a,this.name,n[0],n[1],e);var o=n[3].getValue(),i=fN(n[0].getValue(),a.end.toNumber(),o);return null===i?ut.NUM_ERR_VAR:new ut.NumberVar(i.duration)}}]),t}(gC("COUPDAYSNC",3,1,0,tC,[{type:tC},{type:tC},{type:tC,default:ut.NA_ERR_VAR},{type:tC,default:new ut.NumberVar(0)}])),SZ=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),r=1;r<t;r++)n[r-1]=arguments[r];var a=TN.apply(void 0,n);return a instanceof ut.ErrorVar?AN(a,this.name,n[0],n[1],e):new ut.NumberVar(a.end.toNumber())}}]),t}(gC("COUPNCD",3,1,0,tC,[{type:tC},{type:tC},{type:tC,default:ut.NA_ERR_VAR},{type:tC,default:new ut.NumberVar(0)}])),EZ=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),r=1;r<t;r++)n[r-1]=arguments[r];var a=TN.apply(void 0,n);return a instanceof ut.ErrorVar?AN(a,this.name,n[0],n[1],e):a.start.toNumber()<0?VR(this.name,a.start.toNumber(),0):new ut.NumberVar(a.count)}}]),t}(gC("COUPNUM",3,1,0,tC,[{type:tC},{type:tC},{type:tC,default:ut.NA_ERR_VAR},{type:tC,default:new ut.NumberVar(0)}])),TZ=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),r=1;r<t;r++)n[r-1]=arguments[r];if(n.some((function(e){return e.isBool()})))return ut.VALUE_ERR_VAR;var a=TN.apply(void 0,n);if(a instanceof ut.ErrorVar)return AN(a,this.name,n[0],n[1],e);var o=a.start.toNumber();return new ut.NumberVar(o<0?0:o)}}]),t}(gC("COUPPCD",3,1,0,tC,[{type:tC|rC},{type:tC|rC},{type:tC|rC,default:ut.NA_ERR_VAR},{type:tC|rC,default:new ut.NumberVar(0)}])),AZ=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e,t,n,r,a,o,i){var u,s=t.getValue(),l=n.getValue(),c=r.getValue(),h=a.getValue(),f=o.getValue(),d=i.getValue();if(s<=0)return q_(this.name,s,1,0);if(l<=0)return q_(this.name,l,2,0);if(l>999)return X_(this.name,l,2,999);if(c<=0)return q_(this.name,c,2,0);if(h<1)return K_(this.name,h,4,1);if(h>l)return X_(this.name,h,4,l);if(f<1)return K_(this.name,f,5,1);if(f>l)return X_(this.name,f,5,l);if(h>f)return K_(this.name,f,5,h);var v=d?Mt.PayTimeType.Begin:Mt.PayTimeType.End;for(u=0;h<f+1;h++)u+=(0,Mt.ipmt)(s,h,l,c,0,v);return new ut.NumberVar(u)}}]),t}(gC("CUMIPMT",6,0,0,tC,[{type:tC,default:new ut.NumberVar(0)},{type:tC,default:new ut.NumberVar(0)},{type:tC,default:new ut.NumberVar(0)},{type:tC,default:new ut.NumberVar(0)},{type:tC,default:new ut.NumberVar(0)},{type:rC,default:new ut.BooleanVar(!1)}])),IZ=function(e,t,n){if(0>e)return H_(n,1);if(1>t)return K_(n,t,2,1);if(1e10<t)return X_(n,t,2,1e10);var r=1-(0,Mt.gammadistCdf)(e,Math.floor(t)/2,2);return new ut.NumberVar(r)};function bZ(e,t,n){var r;return r=0===e?G_:new ut.NumberVar(function(e,t,n){var r,a,o,i=-1022,u=1023,s=Math.pow(2,i),l=Math.pow(2,u);if(t>=IZ(s,e,n).getValue())r=0,a=s;else if(t<IZ(l,e,n).getValue())r=0,a=Number.MAX_VALUE;else{for(;i+1<u;){var c=i+Math.floor((u-i)/2),h=Math.pow(2,c);IZ(h,e,n).getValue()<=t?u=c:i=c}r=Math.pow(2,i),a=Math.pow(2,u)}for(var f=0;r<a&&f<100;f++){var d=r+(a-r)/2,v=IZ(d,e,n).getValue();if(v<=t){if(a===d){var g=IZ(r,e,n).getValue();o=Math.abs(g-t)<Math.abs(v-t)?r:d;break}a=d}else{if(r===d){var m=IZ(a,e,n).getValue();o=Math.abs(m-t)<Math.abs(v-t)?a:d;break}r=d}o=d}return o}(t,e,n)),r}var FZ=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e,t,n){var r=t.getValue(),a=n.getValue();return IZ(r,a,this.name)}}]),t}(gC("CHIDIST",2,0,0,tC,[{type:tC},{type:tC}])),MZ=function(e){function t(){var e;return(0,y.Z)(this,t),(e=(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))).name="CHISQ.DIST.RT",e}return(0,g.Z)(t,e),t}(FZ),VZ=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e,t,n){var r=t.getValue(),a=n.getValue();if(0>r)return H_(this.name,1);if(1<r)return X_(this.name,r,1,1);if(1>a)return K_(this.name,a,2,1);if(1===r)return new ut.NumberVar(0);var o=(0,Mt.gammaInv)(1-r,.5*Math.floor(a),2);return o===1/0?G_:new ut.NumberVar(o)}}]),t}(gC("CHIINV",2,0,0,tC,[{type:tC},{type:tC}])),NZ=function(e){function t(){var e;return(0,y.Z)(this,t),(e=(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))).name="CHISQ.INV.RT",e}return(0,g.Z)(t,e),t}(VZ);var OZ=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e,t,n,r){var a=t.getValue(),o=n.getValue(),i=r.getValue();if(0>a)return H_(this.name,1);if(1>o)return K_(this.name,o,2,1);if(1e10<o)return X_(this.name,o,2,1e10);var u=i?(0,Mt.gammadistCdf)(a,Math.floor(o)/2,2):function(e,t){return e<0?0:0===e&&2===t?.5:Math.exp((t/2-1)*Math.log(e)-e/2-t/2*Math.log(2)-(0,Mt.gammaln)(t/2))}(a,Math.floor(o));return new ut.NumberVar(u)}}]),t}(gC("CHISQ.DIST",3,0,0,tC,[{type:tC},{type:tC},{type:rC,default:new ut.BooleanVar(!1)}])),xZ=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e,t,n){var r=[t.rowCount(),t.colCount()],a=r[0],o=r[1],i=[n.rowCount(),n.colCount()];if(a!==i[0]||o!==i[1])return SR(this.name);for(var u=0,s=0;s<a;s++)for(var l=0;l<o;l++){var c,h,f=t.getVarByPos(s,l,e),d=n.getVarByPos(s,l,e);if(null!==(c=f.isError)&&void 0!==c&&c.call(f))return f;if(null!==(h=d.isError)&&void 0!==h&&h.call(d))return d;var v=f.getValue(),g=d.getValue();if(0===g)return PR(this.name);f.isNumber()&&d.isNumber()&&(u+=(v-g)*(v-g)/g)}return IZ(u,Math.imul(Math.max(1,a-1|0),Math.max(1,o-1|0)),this.name)}}]),t}(gC("CHITEST",2,0,0,tC,[{type:iC},{type:iC}])),ZZ=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e,t,n){var r=t.getValue(),a=n.getValue();return 0>r?H_(this.name,1):1<r?X_(this.name,r,1,1):1>a?K_(this.name,a,2,1):bZ(1-r,Math.floor(a),this.name)}}]),t}(gC("CHISQ.INV",2,0,0,tC,[{type:tC},{type:tC}])),DZ=function(e){function t(){var e;return(0,y.Z)(this,t),(e=(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))).name="CHISQ.TEST",e}return(0,g.Z)(t,e),t}(xZ),PZ=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),r=1;r<t;r++)n[r-1]=arguments[r];var a,o=_n(n.entries());try{for(o.s();!(a=o.n()).done;){var i=(0,p.Z)(a.value,2),u=i[0],s=i[1];if(s.getValue()<=0)return q_(this.name,s.getValue(),u+1,0)}}catch(e){o.e(e)}finally{o.f()}var l=(Math.log(n[2].getValue())-Math.log(n[1].getValue()))/Math.log(1+n[0].getValue());return new ut.NumberVar(l)}}]),t}(gC("PDURATION",3,0,0,tC,[{type:tC},{type:tC},{type:tC}])),LZ=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e){for(var t,n,r=arguments.length,a=new Array(r>1?r-1:0),o=1;o<r;o++)a[o-1]=arguments[o];var i=nN(a[0],a[1]);if(i instanceof ut.ErrorVar)return null!==(t=i.info)&&void 0!==t&&null!==(n=t.args)&&void 0!==n&&n.hasOwnProperty("funcName")&&(i.info.args.funcName=this.name),i;var u=Math.floor(i.settlement.toNumber()),s=Math.floor(i.maturity.toNumber()),l=a[2].getValue(),c=a[3].getValue(),h=Math.floor(a[4].getValue());if(l<=0||c<=0){var f=c,d=2;return l<=0&&(f=l,d=1),q_(this.name,f,d,0)}if(!wN(h))return j_(this.name,5,h,0,4);var v=fN(u,s,h);if(null==v)return j_(this.name,5,h,0,4);var g=v.duration,m=v.total;return new ut.NumberVar((c-l)/c*(m/g))}}]),t}(gC("DISC",4,1,0,tC,[{type:tC,default:ut.NA_ERR_VAR},{type:tC,default:ut.NA_ERR_VAR},{type:tC,default:ut.NA_ERR_VAR},{type:tC,default:ut.NA_ERR_VAR},{type:tC,default:new ut.NumberVar(0)}])),BZ=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e,t,n,r){var a,o,i,u=0;if(n.isRef()){if(bu(n))return AR(this.name,2,"");i=n.toRefMatrix()}else i=n;i.rowCount()>=i.colCount()?a=Ou(i,0,1):(a=xu(i,0,1),u=1);var s=i.rowCount()>i.colCount()?i.rowCount():i.colCount(),l=this.getDisplayList(r,s);if(l.isError())return l;o=l.isNull()?i.rowCount()>=i.colCount()?Ou(i,i.colCount()-1,1):xu(i,i.rowCount()-1,1):l;var c=wV(e,a,t);if(c<0)return OR(this.name,null===t.getValue()?"":t.isBool()?t.getValue().toString().toUpperCase():t.getValue().toString());if(Au(n)&&a.rowCount()>1&&a.colCount()>1){var h=Math.min(a.rowCount(),a.colCount());c=Math.floor(c/h)}return c>=o.size()?we.d$b[we.O6N.OUT_OF_RANGE_FUNCTION]({funcName:this.name,rowOrCol:0===u?ut.FormulaErrorPhrases.DIMENSION_ROW:ut.FormulaErrorPhrases.DIMENSION_COLUMN,value:c+1}):o.nth(c,e)}},{key:"getDisplayList",value:function(e,t){if(e.isNull())return ut.NULL_VAR;if(Au(e))return e.rowCount()>1&&e.colCount()>1?GR(this.name):e;if(bu(e))return AR(this.name,3,"");var n=e.toRefMatrix();return n.rowCount()>1&&n.colCount()>1?GR(this.name):(t>e.size()&&(n.rowCount()>1?xu(n,0,t):Ou(n,0,t)),n)}}]),t}(gC("LOOKUP",2,1,0,nC,[{type:nC|tC|rC},{type:iC},{type:iC|eC,default:ut.NULL_VAR}]));BZ=Gi([cc("LOOKUP")],BZ);var UZ=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e){for(var t=0,n=!1,r=arguments.length,a=new Array(r>1?r-1:0),o=1;o<r;o++)a[o-1]=arguments[o];for(var i=0,u=a;i<u.length;i++){var s=u[i],l=void 0,c=null;if(c=s.isRef()?s.iter(e):s.iter(e).filter((function(e){return e.isNumber()||e.isBool()})),c.exitWhen((function(e){var t=e.isError();return t&&(l=e),t})).forEach((function(r){var a=r.toNumberVar(e.service).getValue();r.isString()&&(a=0),null!==a&&(!1===n||t<a)&&(t=a,n=!0)})),l)return l}return new ut.NumberVar(t)}}]),t}(gC("MAXA",1,256,1,tC,[{type:tC|iC},{type:tC|iC}])),HZ=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e,t,n,r,a,o,i){for(var u=Array.from(arguments),s=1;s<u.length-1;s++)if(u[s].isNull())return bR(this.name,1);var l=Math.trunc(t.getValue()),c=Math.trunc(n.getValue()),h=r.getValue(),f=a.getValue(),d=Math.trunc(o.getValue()),v=Math.trunc(i.getValue()),g=WZ(l,c,h,f,d,v,this.name);return g instanceof ut.ErrorVar?AN(g,this.name,t,n,e):this.getCouponDurationResult(l,c,h,f,d,v)}}]),t}(gC("",5,1,0,tC,[{type:tC|eC},{type:tC|eC},{type:tC|eC},{type:tC|eC},{type:tC|eC},{type:tC,default:new ut.NumberVar(0)}]));function WZ(e,t,n,r,a,o,i){return n<0||r<0?H_(i,n<0?3:4):EN(e,t,a,o,5)}var jZ=function(e){function t(){var e;return(0,y.Z)(this,t),(e=(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))).name="MDURATION",e}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"getCouponDurationResult",value:function(e,t,n,r,a,o){var i=IN(e,t,n,r,a,o);return new ut.NumberVar(i/(1+r/a))}}]),t}(HZ),zZ=function(e){function t(){var e;return(0,y.Z)(this,t),(e=(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))).name="DURATION",e}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"getCouponDurationResult",value:function(e,t,n,r,a,o){var i=IN(e,t,n,r,a,o);return new ut.NumberVar(i)}}]),t}(HZ),GZ=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e){for(var t=0,n=!1,r=arguments.length,a=new Array(r>1?r-1:0),o=1;o<r;o++)a[o-1]=arguments[o];for(var i=0,u=a;i<u.length;i++){var s=u[i],l=void 0,c=null;if(c=Fu(s)?s.iter(e):s.iter(e).filter((function(e){return e.isNumber()||e.isBool()})),c.exitWhen((function(e){var t=e.isError();return t&&(l=e),t})).forEach((function(r){var a=r.toNumberVar(e.service).getValue();r.isString()&&(a=0),null!==a&&(!1===n||t>a)&&(t=a,n=!0)})),l)return l}return new ut.NumberVar(t)}}]),t}(gC("MINA",1,256,1,tC,[{type:tC|iC},{type:tC|iC}])),JZ=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e,t,n,r,a,o,i,u){for(var s=Array.from(arguments),l=1;l<s.length-1;l++)if(s[l].isNull())return bR(this.name,1);var c=Math.trunc(t.getValue()),h=Math.trunc(n.getValue()),f=o.getValue(),d=a.getValue(),v=Math.trunc(i.getValue()),g=Math.trunc(u.getValue()),m=r.getValue(),p=qZ(this.name,c,h,m,d,f,v,g);return p instanceof ut.ErrorVar?AN(p,this.name,t,n,e):new ut.NumberVar($Z(c,h,m,d,f,v,g,p))}}]),t}(gC("PRICE",6,1,0,tC,[{type:tC|eC},{type:tC|eC},{type:tC|eC},{type:tC|eC},{type:tC|eC},{type:tC|eC},{type:tC,default:new ut.NumberVar(0)}]));function qZ(e,t,n,r,a,o,i,u){return r<0||a<0?H_(e,r<0?3:4):o<=0?q_(e,o,5,0):EN(t,n,i,u,6)}function $Z(e,t,n,r,a,o,i,u){var s=yN(ke.SheetDate.fromNumber(e),ke.SheetDate.fromNumber(t),o),l=fN(e,s.end.toNumber(),i).duration,c=bN(u),h=s.start.toNumber(),f=fN(h<0?0:h,e,i).duration,d=s.count;if(1===d)return(100*n/o+a)/(r/o*(c-f)/c+1)-100*n/o*f/c;for(var v=a/Math.pow(1+r/o,d-1+l/c),g=0,m=1;m<=d;m++)g+=100*n/o/Math.pow(1+r/o,m-1+l/c);return v+g-n/o*100*(f/c)}var YZ=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e,t,n,r,a,o){var i=Array.from(arguments).filter((function(e,t){return 0!==t&&e.isNull()}));if(i.length>0)return we.d$b[we.O6N.NA_REQUIRED_ARGUMENT_SIZES_NOT_EQUAL]({funcName:this.name,requiredOperandCount:this.operands,argCount:this.operands-i.length});var u=Math.trunc(t.getValue()),s=Math.trunc(n.getValue()),l=r.getValue(),c=a.getValue(),h=Math.trunc(o.getValue()),f=KZ(this.name,u,s,l,c,h);if(f instanceof ut.ErrorVar)return AN(f,this.name,t,n,e);var d=fN(u,s,h).value;return new ut.NumberVar(c-l*c*d)}}]),t}(gC("PRICEDISC",4,1,0,tC,[{type:tC|eC},{type:tC|eC},{type:tC|eC},{type:tC|eC},{type:tC,default:new ut.NumberVar(0)}]));function KZ(e,t,n,r,a,o){return r<=0||a<=0?q_(e,r<=0?r:a,r<=0?3:4,0):EN(t,n,1,o,4)}var XZ=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e){for(var t=1,n=new Map,r=arguments.length,a=new Array(r>1?r-1:0),o=1;o<r;o++)a[o-1]=arguments[o];for(var i=0,u=a;i<u.length;i++){var s=u[i];if(s.isRef()&&1===s.size()&&s.getVar().isNull())return qR(this.name);var l=null;if(s.iter(e).exitWhen((function(e){return e.isError()&&(l=e),e.isError()})).filter((function(e){return e.isNumber()})).forEach((function(e){var r=e.getValue();if(n.has(r)){var a=n.get(r)+1;t<a&&(t=a),n.set(r,a)}else n.set(r,1)})),l)return l}if(1===t)return $R(this.name);var c,h=[],f=_n(n.keys());try{for(f.s();!(c=f.n()).done;){var d=c.value;n.get(d)===t&&h.push([new ut.NumberVar(d)])}}catch(e){f.e(e)}finally{f.f()}return new Ru(h)}}]),t}(gC("MODE.MULT",1,256,1,iC,[{type:tC|iC},{type:tC|iC}]));function QZ(e,t,n,r,a){var o,i=!1,u=0,s=0;return t.iter(e).exitWhen((function(e){var t=e.isError();return t&&(o=e),t})).forEach((function(e){if(e.isNumber()){var t=e.getValue();if(t===n)s+=Number(i),i=!0;else{var a=t>n;u+=Number(r?a:!a)}}})),{err:o,exist:i,rankNum:a?u+1+s/2:u+1}}var eD,tD=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e,t,n,r){if(!Fu(n)&&!Au(n))return wR(this.name,2);var a=QZ(e,n,t.getValue(),!1===r.getValue(),!1);return a.err||(a.exist?new ut.NumberVar(a.rankNum):WR(this.name))}}]),t}(gC("RANK",2,1,0,tC,[{type:tC},{type:iC},{type:rC,default:new ut.BooleanVar(!1)}])),nD=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e,t,n){var r=t.getValue(),a=n.getValue();return a<0?W_(this.name,2):!Number.isFinite(a)||r.length*a>ut.MAX_CALC_RESULT_STRING_LENGTH?ut.tractorErrorVarCreators[ut.ErrorCode.TEXT_TOO_LONG]({funcName:this.name,maxCalcResultTextLength:ut.MAX_CALC_RESULT_STRING_LENGTH}):new ut.StringVar(r.repeat(a))}}]),t}(gC("REPT",2,0,0,nC,[{type:nC},{type:tC}]));function rD(e,t,n,r){for(;n-t>1;){var a=Math.floor((n+t)/2),o=r[a];if(o>e)n=a;else{if(!(o<e))return a;t=a}}return t!==n&&r[n]<=e?n:t}!function(e){e[e.I=1]="I",e[e.IV=4]="IV",e[e.V=5]="V",e[e.IX=9]="IX",e[e.X=10]="X",e[e.XL=40]="XL",e[e.VL=45]="VL",e[e.IL=49]="IL",e[e.L=50]="L",e[e.XC=90]="XC",e[e.VC=95]="VC",e[e.IC=99]="IC",e[e.C=100]="C",e[e.CD=400]="CD",e[e.LD=450]="LD",e[e.XD=490]="XD",e[e.VD=495]="VD",e[e.ID=499]="ID",e[e.D=500]="D",e[e.CM=900]="CM",e[e.LM=950]="LM",e[e.XM=990]="XM",e[e.VM=995]="VM",e[e.IM=999]="IM",e[e.M=1e3]="M"}(eD||(eD={}));var aD=[[1,4,5,9,10,40,50,90,100,400,500,900,1e3,4e3],[1,4,5,9,10,40,45,50,90,95,100,400,450,500,900,950,1e3,4e3],[1,4,5,9,10,40,45,49,50,90,95,99,100,400,450,490,500,900,950,990,1e3,4e3],[1,4,5,9,10,40,45,49,50,90,95,99,100,400,450,490,495,500,900,950,990,995,1e3,4e3],[1,4,5,9,10,40,45,49,50,90,95,99,100,400,450,490,495,499,500,900,950,990,995,999,1e3,4e3]],oD=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e,t,n){var r=Math.floor(t.getValue()),a=n.getValue();"boolean"==typeof a&&(a=a?0:4),a=Math.floor(a);var o="";if(r<0||r>=4e3)return gR(this.name,1,r,0,3999);if(a<0||a>4)return gR(this.name,2,a,0,4);for(var i=aD[a],u=i.length-1;r>0;){var s=i[u=rD(r,0,u,i)];r-=s,o+=eD[s]}return new ut.StringVar(o)}}]),t}(gC("ROMAN",1,1,0,nC,[{type:tC},{type:tC|rC,default:new ut.NumberVar(0)}])),iD=function(e){function t(){var e;return(0,y.Z)(this,t),(e=(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))).convertVariant=function(t,n){return Fu(n.argument)&&n.argument.size()>1?{isError:!0,convertedArgument:we.d$b[we.O6N.INVALID_SINGLE_CELL_REFERENCE]({funcName:e.name,index:1,value:""}),srcArg:n.argument}:rw(t,n)},e}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e,t){var n=null;return t.isNumber()?n=1:t.isString()?n=2:t.isBool()?n=4:Au(t)?n=64:t.isError()&&(n=16),null===n?ut.VALUE_ERR_VAR:new ut.NumberVar(n)}}]),t}(gC("TYPE",1,0,0,tC,[uw(aw,fC&~eC|hC)])),uD=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e,t,n,r,a){var o,i,u=!a.getValue(),s=Math.floor(r.getValue()),l=n.isRef()?n.toRefMatrix():n;o=xu(l,0,1),i=xu(l,s-1,1);var c=u?kV(e,o,t):wV(e,o,t);return c<0?OR(this.name,null===t.getValue()?"":t.isBool()?t.getValue().toString().toUpperCase():t.getValue().toString()):s<0?K_(this.name,s,3,0):s>l.rowCount()?function(e){return we.d$b[we.O6N.REFERENCE_OUT_OF_BOUNDS]({funcName:e})}(this.name):i.idxVar(c,e)}}]),t}(gC("HLOOKUP",3,1,0,nC,[{type:nC|tC|rC,default:new ut.NumberVar(0)},{type:iC},{type:tC},{type:rC,default:(Ke={},(0,l.Z)(Ke,ut.DefaultParam.IfInputNull,new ut.BooleanVar(!1)),(0,l.Z)(Ke,ut.DefaultParam.IfNotInput,new ut.BooleanVar(!0)),Ke)}])),sD=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e,t){var n=0;return t.iter(Object.assign({},e,{skipEmptyRef:!1})).map((function(t){return t.toStringVar(e.service)})).filter((function(e){return""===e.getValue()})).forEach((function(e){return n++})),new ut.NumberVar(n)}}]),t}(gC("COUNTBLANK",1,0,0,tC,[{type:iC},{type:iC}])),lD=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e,t,n){var r=t.isOp()?t.getVar(e):t;return r.isNull()?new ut.NumberVar(0):(Fu(r)&&(r=t.getVar(e)),r.getValue()===ut.NA_ERR_VAR.getValue()?n.isNull()?new ut.NumberVar(0):n.isOp()?n.getVar(e):n:r)}}]),t}(gC("IFNA",2,0,0,oC,[{type:oC},{type:oC}])),cD=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e,t){return new ut.BooleanVar(t.isError())}}]),t}(gC("ISERROR",1,0,0,rC,[{type:fC}])),hD=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e,t){return new ut.BooleanVar(t.isNull())}}]),t}(gC("ISBLANK",1,0,0,rC,[{type:fC}])),fD=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e,t){return t.isRef()?TV(t,(function(e){return new ut.BooleanVar(e.isFormula())})):new ut.BooleanVar(!1)}}]),t}(gC("ISFORMULA",1,0,0,rC,[{type:dC|fC}])),dD=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e,t){return new ut.BooleanVar(t.isRef())}}]),t}(gC("ISREF",1,0,0,rC,[{type:fC|iC|uC}])),vD=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e,t,n,r,a,o){var i=t.getValue(),u=n.getValue();if(i<0||u<0)return H_(this.name,i<0?1:2);if(i>=u)return we.d$b[we.O6N.NUM_SETTLEMENT_DATE_NOT_BEFORE_MATURITY_DATE]({funcName:this.name,settlementDate:(0,Mt.excelDateToJSDate)(i),maturityDate:(0,Mt.excelDateToJSDate)(u)});var s=r.getValue(),l=a.getValue();if(s<=0||l<=0)return q_(this.name,s<=0?s:l,s<=0?3:4,0);var c=Math.trunc(o.getValue());if(c<0||c>4)return j_(this.name,5,c,0,4);var h=(l-s)/s,f=fN(i,u,c),d=h*(f.total/f.duration);return new ut.NumberVar(d)}}]),t}(gC("INTRATE",4,1,0,tC,[{type:tC|rC},{type:tC|rC},{type:tC|rC},{type:tC|rC},{type:tC|rC,default:new ut.NumberVar(0)}])),gD=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e,t,n,r){var a,o,i=mD(e,t,n,r,gN);return i.isError()&&null!==(a=i.info)&&void 0!==a&&null!==(o=a.args)&&void 0!==o&&o.hasOwnProperty("funcName")&&(i.info.args.funcName=this.name),i}}]),t}(gC("NETWORKDAYS",2,1,0,tC,[{type:tC},{type:tC},{type:iC|tC|rC}]));function mD(e,t,n,r){var a=arguments.length>4&&void 0!==arguments[4]?arguments[4]:gN,o=Math.floor(t.getValue()),i=Math.floor(n.getValue()),u=new Set;if(o<0||i<0)return H_("",o<0?1:2);var s=bV(e,u,r);if(s)return s;var l=o>i;if(l){var c=o;o=i,i=c}var h=pD(o,i,a);return u.forEach((function(e){var t=dN(e);e>=o&&e<=i&&!a[t]&&h--})),new ut.NumberVar((l?-1:1)*h)}function pD(e,t,n){for(var r=t-e+1,a=Math.floor(r/7),o=r%7,i=7,u=0;u<7;u++)!0===n[u]&&i--;var s=dN(e),l=dN(t);if(o>0)for(l<s&&(l+=7);s<=l;)!0===n[s%7]&&o--,s++;return a*i+o}var yD=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e,t,n){var r=Math.floor(t.getValue());if(r<0)return H_(this.name,1);var a,o=0,i=n.getValue();switch(i){case 1:case 17:a=[0,1,2,3,4,5,6];break;case 2:case 11:a=[6,0,1,2,3,4,5];break;case 12:a=[5,6,0,1,2,3,4];break;case 13:a=[4,5,6,0,1,2,3];break;case 14:a=[3,4,5,6,0,1,2];break;case 15:a=[2,3,4,5,6,0,1];break;case 16:a=[1,2,3,4,5,6,0];break;case 21:a=[6,7,8,9,10,4,5],o=1;break;default:return dR(this.name,2,i.toString())}return new ut.NumberVar(CD(r,a,o))}}]),t}(gC("WEEKNUM",1,1,0,tC,[{type:tC},{type:tC,default:new ut.NumberVar(1)}]));function CD(e,t,n){var r=ke.SheetDate.fromNumber(e).year,a=ke.SheetDate.from({year:r,month:1,date:1});if(!n)return Math.floor((e-a.toNumber()+t[a.day]+7)/7);var o=ke.SheetDate.from({year:r,month:12,date:31}),i=Math.floor((e-a.toNumber()+t[a.day])/7);switch(i){case 0:return CD(a.toNumber()-1,t,n);case 53:return o.day<4?1:53;default:return i}}var _D=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e,t,n){var r=Math.floor(t.getValue());if(r<0)return H_(this.name,1);var a=dN(r),o=n.getValue();switch(o){case 1:case 17:return new ut.NumberVar(a+1);case 2:case 11:return new ut.NumberVar((a+6)%7+1);case 3:return new ut.NumberVar((a+6)%7);case 12:return new ut.NumberVar((a+5)%7+1);case 13:return new ut.NumberVar((a+4)%7+1);case 14:return new ut.NumberVar((a+3)%7+1);case 15:return new ut.NumberVar((a+2)%7+1);case 16:return new ut.NumberVar((a+1)%7+1)}return dR(this.name,2,o.toString())}}]),t}(gC("WEEKDAY",1,1,0,tC,[{type:tC},{type:tC,default:new ut.NumberVar(1)}])),RD=function(e){function t(){var e;return(0,y.Z)(this,t),(e=(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))).calcCustomData=function(){return{autoFormat:"yyyy/mm/dd"}},e}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e,t,n,r){var a=Math.floor(t.getValue()),o=Math.floor(n.getValue()),i=Math.floor(r.getValue()),u=1900;if(a>=0&&a<u)a+=u;else if(!(a>=u&&a<=9999))return j_(this.name,1,a,0,9999);var s=ke.SheetDate.from({year:a,month:o,date:i}).toNumber();return s<0?VR(this.name,s,0):new ut.NumberVar(s)}}]),t}(gC("DATE",3,0,0,tC,[{type:tC},{type:tC},{type:tC}])),wD=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e,t){var n=Math.floor(t.getValue());return n<1||n>(arguments.length<=2?0:arguments.length-2)?gR(this.name,1,n,1,arguments.length<=2?0:arguments.length-2):n-1+2<2||arguments.length<=n-1+2?void 0:arguments[n-1+2]}}]),t}(gC("CHOOSE",2,256,1,fC|iC,[{type:tC},{type:fC|iC},{type:fC|iC}])),kD=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e,t,n){var r,a=t.getValue();return(r=void 0===n?t.clone():n.clone()).isError()&&(r=r.clone()),(a=a.trim())&&(/^https?:|mailto:|ftp:/.test(a)||(a="http://"+a),r.setSpecialInfo({linkInfo:{link:a}})),r}}]),t}(gC("HYPERLINK",1,1,0,nC|tC|aC|rC,[{type:nC},{type:tC|nC|rC|aC}])),SD=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e,t){var n=AV(e,t.getValue());return n?new ut.NumberVar(Math.floor(n.toNumber())):function(e,t){return we.d$b[we.O6N.CANNOT_PARSE_TEXT_TO_DATE]({funcName:e,arg:t})}(this.name,t.getValue())}}]),t}(gC("DATEVALUE",1,0,0,tC,[{type:nC}])),ED=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e){return new ut.BooleanVar(!0)}}]),t}(gC("TRUE",0,0,0,rC,[])),TD=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e){return new ut.BooleanVar(!1)}}]),t}(gC("FALSE",0,0,0,rC,[])),AD=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e,t,n,r,a){var o,i,u=IV(r.getValue());if(null===u)return fR(this.name,3,"");var s=mD(e,t,n,a,u);return s.isError()&&null!==(o=s.info)&&void 0!==o&&null!==(i=o.args)&&void 0!==i&&i.hasOwnProperty("funcName")&&(s.info.args.funcName=this.name),s}}]),t}(gC("NETWORKDAYS.INTL",2,2,0,tC,[{type:tC},{type:tC},{type:nC|tC,default:new ut.NumberVar(1)},{type:iC|tC|rC}]));function ID(e,t){return 1===e.colCount()&&1===e.rowCount()?!!t&&ID(t):e.colCount()>1}function bD(e,t,n,r,a,o){var i=r.getValue(),u=a.getValue();if(o?n.rowCount()>1:n.colCount()>1)return zR("");if(!(i in yV))return nR("",i.toString(),3,"0, -1, 1, 2");if(!(u in CV))return nR("",u.toString(),4,"-2, -1, 1, 2");if(i===yV.WildcardMatch&&(u===CV.BinaryAscending||u===CV.BinaryDescending))return nR("",u.toString(),4,"1, -1");var s=e.service.getFuncCacheManager().getInnerFuncCache("InvertedIndex",{autoBuildCache:!1});if(i!==yV.ExactMatch||u!==CV.Sequence&&u!==CV.Reverse||!n.isRef()||null==s||n.size()<=SO)return(0,we.n5s)()?new ut.NumberVar(function(e,t,n,r,a){var o,i=-1,u=function(e,n){var r=MV(t,e);return 0===r&&(i=n),r};switch(r){case yV.ExactMatch:NV(e,n,a,u);break;case yV.LargerExactMatch:case yV.SmallerExactMatch:var s=r===yV.SmallerExactMatch;NV(e,n,a,(function(e,t){var n=u(e,t);return 0===n?0:(n!==(s?1:-1)||a!==CV.BinaryAscending&&a!==CV.BinaryDescending&&o&&-1!==MV(o,e,s)||(i=t,o=e),n)}));break;case yV.WildcardMatch:var l=t.isString()?(0,Mt.wildcardToFastRegExp)(t.getValue()):null;NV(e,n,a,(function(e,n){return e.isString()&&null!=l&&l.test(e.getValue())||e.getValue()===t.getValue()?(i=n,0):2}))}return i}(e,t,n,i,u)):((0,we.QFC)().finally((function(){e.service.emit("afterWaitAsyncCalc",e.formula,4)})),e.service.addCalculatingAsyncFormula(e.formula),ut.WAIT_ASYNC_ERR_VAR);var l=function(e,t,n,r,a){var o,i,u,s=n.getRef(),l=null===(o=s.sheet())||void 0===o?void 0:o.id();if(!l)return new ut.NumberVar(-1);var c,h="x_"+s.id(!1),f=r.type,d=kO(r),v=t.getCache(l,e),g=!0;v?v.has(h)?c=v.get(h):g=!1:(g=!1,v=new we.z6B(TO.InvertedIndex),t.addCache(l,v,e)),g||(c=function(e,t,n,r){var a={};return e.iterWithPos(Object.assign({},t,{skipEmptyRef:!0})).forEach((function(e){var t,o=(0,p.Z)(e,3),i=o[0],u=o[1],s=o[2],l=i.type;l in a?t=a[l]:(t=new Map,a[l]=t);var c=kO(i),h=(r?s:u)-n;t.has(c)?t.get(c)[1]=h:t.set(c,[h,h])})),a}(n,e,a?s.colFrom():s.rowFrom(),a),v.set(h,c));return null!==(i=null===(u=c[f])||void 0===u?void 0:u.get(d))&&void 0!==i?i:null}(e,s,n,t,o);return new ut.NumberVar(null==l?-1:u===CV.Sequence?l[0]:l[1])}var FD=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"getFuncResult",value:function(e,t){return-1===e.getValue()?we.d$b[we.O6N.LOOKUP_VALUE_NOT_FOUND]({funcName:this.name,value:null==t.getValue()?"":t.isBool()?t.getValue().toString().toUpperCase():t.getValue().toString()}):new ut.NumberVar(e.getValue()+1)}},{key:"func",value:function(e,t,n,r,a){var o,i,u=bD(e,t,n,r,a,ID(n));return u===ut.WAIT_ASYNC_ERR_VAR?u:u.isError()?(null!==(o=u.info)&&void 0!==o&&null!==(i=o.args)&&void 0!==i&&i.hasOwnProperty("funcName")&&(u.info.args.funcName=this.name),u):this.getFuncResult(u,t)}}]),t}(gC("XMATCH",2,2,0,tC|lC,[{type:fC},{type:iC},{type:tC,default:new ut.NumberVar(yV.ExactMatch)},{type:tC,default:new ut.NumberVar(CV.Sequence)}]));var MD=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"getFuncResult",value:function(e,t,n,r,a,o){var i;if(-1===a.getValue())return r;if(o?t.colCount()!==n.colCount():t.rowCount()!==n.rowCount())return CR(this.name,t.rowCount(),t.colCount(),n.rowCount(),n.colCount());var u=[[]],s=Fu(n)?n.getRef():null;if(o){if(n.isRef()){var l=n.getRef().offset(0,a.getValue(),0,1);return new Su(l)}for(var c=0;c<n.rowCount();c++){var h=n.getVarByPos(c,a.getValue(),e);u[c]=[ic(h,s,c,a.getValue())]}}else{if(n.isRef()){var f=n.getRef().offset(a.getValue(),0,1,0);return new Su(f)}for(var d=0;d<n.colCount();d++){var v=n.getVarByPos(a.getValue(),d,e);u[0][d]=ic(v,s,a.getValue(),d)}}return e.info&&(e.info.customData=null===(i=u[0][0].getSpecialInfo())||void 0===i?void 0:i.customData),new Ru(u)}},{key:"func",value:function(e,t,n,r,a,o,i){var u,s,l=ID(n,r),c=bD(e,t,n,o,i,l);return c===ut.WAIT_ASYNC_ERR_VAR?c:c.isError()?(null!==(u=c.info)&&void 0!==u&&null!==(s=u.args)&&void 0!==s&&s.hasOwnProperty("funcName")&&(c.info.args.funcName=this.name),c):this.getFuncResult(e,n,r,a,c,l)}}]),t}(gC("XLOOKUP",3,3,0,iC|tC|lC,[{type:fC},{type:iC},{type:iC},{type:fC|aC|iC,default:ut.NA_ERR_VAR},{type:tC,default:new ut.NumberVar(yV.ExactMatch)},{type:tC,default:new ut.NumberVar(CV.Sequence)}]));MD=Gi([cc("XLOOKUP")],MD);var VD=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e,t,n,r){var a=Math.floor(t.getValue()),o=Math.floor(n.getValue());if(a<0||o<0){var i=a<0?1:2;return H_(this.name,i)}var u=r.getValue(),s=fN(a,o,u);return null===s?j_(this.name,3,u,0,4):new ut.NumberVar(Math.abs(s.value))}}]),t}(gC("YEARFRAC",2,1,0,tC,[{type:tC},{type:tC},{type:tC,default:new ut.NumberVar(0)}])),ND=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e,t,n,r){var a,o,i=OD(e,t,n,r);return i.isError()&&null!==(a=i.info)&&void 0!==a&&null!==(o=a.args)&&void 0!==o&&o.hasOwnProperty("funcName")&&(i.info.args.funcName=this.name),i}}]),t}(gC("WORKDAY",2,1,0,tC,[{type:tC},{type:tC},{type:iC|tC|rC}]));function OD(e,t,n,r){var a=arguments.length>4&&void 0!==arguments[4]?arguments[4]:gN,o=Math.floor(t.getValue()),i=Math.floor(n.getValue()),u=new Set;if(o<0)return ut.tractorErrorVarCreators[ut.ErrorCode.NUM_PARAMETER_SHOULD_BE_POSITIVE_OR_ZERO]({funcName:"",index:1});var s=bV(e,u,r);if(s)return s;var l=xD(o,i,a,u);return l<0?we.d$b[we.O6N.FUNCTION_RESULT_SHOULD_BE_GREATER_THAN_OR_EQUAL_TO]({funcName:"",value:l,lowerBound:0}):new ut.NumberVar(l)}function xD(e,t,n,r){if(0===t)return e;var a=t>0?1:-1,o=function(e,t,n){for(var r=t>0?1:-1,a=7,o=0;o<7;o++)!0===n[o]&&a--;var i=t/a;i=i>0?Math.floor(i):Math.ceil(i);var u=t%a,s=e+7*i;if(0!==i)for(;n[dN(s)];)s-=r;for(;0!==u;)n[dN(s+=r)]||(u-=r);return s}(e,t,n),i=0;for(r.forEach((function(t){var r=dN(t);(t-e)*a>0&&(o-t)*a>=0&&!n[r]&&i++}));i>0;){var u=dN(o+=a);r.has(o)||n[u]||i--}return o}var ZD=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e,t,n,r,a){var o,i;if(r.isString()&&"1111111"===r.getValue())return fR(this.name,3,"1111111");var u=IV(r.getValue());if(null===u)return fR(this.name,3,r.getValue());var s=OD(e,t,n,a,u);return s.isError()&&null!==(o=s.info)&&void 0!==o&&null!==(i=o.args)&&void 0!==i&&i.hasOwnProperty("funcName")&&(s.info.args.funcName=this.name),s}}]),t}(gC("WORKDAY.INTL",2,2,0,tC,[{type:tC},{type:tC},{type:nC|tC,default:new ut.NumberVar(1)},{type:iC|tC|rC}])),DD=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e,t){return bu(t)?new ut.NumberVar(t.getRefs().length):new ut.NumberVar(1)}}]),t}(gC("AREAS",1,0,0,tC,[iw.SHEET_REF])),PD=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e,t,n){n.isNull()&&(n=new ut.NumberVar(0));var r=(0,Mt.buildCriteria)(e,n);if(null===r)return new ut.NumberVar(0);var a=0,o=function(){return a++};return NO(e,[{target:t,criteria:n,predicate:r}],t.rowCount(),t.colCount(),t.ignoreCache||bu(t),o,bu(t)?function(){t.iter(Object.assign({},e,{skipEmptyRef:!1})).forEach((function(e){r(e)&&o()}))}:void 0),new ut.NumberVar(a)}}]),t}(gC("COUNTIF",2,0,0,tC,[iw.MATRIX_AND_SHEET_REF,{type:oC,default:new ut.NumberVar(0)}])),LD=function(e){function t(){var e,n;return(0,y.Z)(this,t),(n=(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))).name="IF",n.operands=2,n.optionOperands=1,n.resultType=ut.VAR_TYPE.BASIC,n.repeatedLastParam=0,n.paramsDesc=[{type:ut.VAR_TYPE.BOOL},{type:ut.VAR_TYPE.ATOM|ut.VAR_TYPE.OPERATOR},{type:ut.VAR_TYPE.ATOM|ut.VAR_TYPE.OPERATOR,default:(e={},(0,l.Z)(e,ut.DefaultParam.IfNotInput,new ut.BooleanVar(!1)),(0,l.Z)(e,ut.DefaultParam.IfInputNull,ut.NULL_VAR),e)}],n}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e,t,n,r){return t.getValue()?n.isOp()?n.getVar(e):n:r.isOp()?r.getVar(e):r}}]),t}(ut.FuncOpBase),BD=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e){for(var t=0;t<(arguments.length<=1?0:arguments.length-1);t+=2){var n=t+1<1||arguments.length<=t+1?void 0:arguments[t+1],r=t+1+1<1||arguments.length<=t+1+1?void 0:arguments[t+1+1],a=n.getVar(e);if(a.isError())return a;if(a.getValue(e))return r.isOp()?r.getVar(e):r}return JR}}]),t}(gC("IFS",2,256,2,oC|iC,[{type:rC|sC},{type:dC|sC},{type:rC|sC},{type:dC|sC}])),UD=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e,t,n,r,a){var o=t.getValue(),i=n.getValue(),u=r.getValue(),s=a.getValue();return 0===u?ut.tractorErrorVarCreators[ut.ErrorCode.DIVIDE_BY_ZERO_FROM_PARAMETER_BEING_ZERO]({funcName:this.name,argIndex:3}):new ut.NumberVar(s*o*(i/u-1))}}]),t}(gC("ISPMT",4,0,0,tC,[{type:tC},{type:tC},{type:tC},{type:tC}])),HD=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e,t){var n=t.getValue();return n===Math.round(n)&&n<=0?we.d$b[we.O6N.NUM_NOT_BE_NEGATIVE_INTEGER_OR_ZERO]({funcName:this.name,index:1,value:n}):n>171?G_:new ut.NumberVar((0,Mt.gamma)(n))}}]),t}(gC("GAMMA",1,0,0,tC,[{type:tC}])),WD=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e){for(var t=this,n=1,r=0,a=arguments.length,o=new Array(a>1?a-1:0),i=1;i<a;i++)o[i-1]=arguments[i];for(var u=0,s=o;u<s.length;u++){var l=s[u],c=null;if(l.iter(e).exitWhen((function(e){if(e.isError())return c=e,!0;var n=e.getValue();return!!(e.isNumber()&&n<=0)&&(c=NR(t.name,n),!0)})).forEach((function(e){if(e.isNumber()){var t=e.getValue();r++,n*=t}})),c)return c}return new ut.NumberVar(Math.pow(n,1/r))}}]),t}(gC("GEOMEAN",1,255,1,tC,[{type:tC|iC},{type:tC|iC}])),jD=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e){for(var t=this,n=0,r=0,a=arguments.length,o=new Array(a>1?a-1:0),i=1;i<a;i++)o[i-1]=arguments[i];for(var u=0,s=o;u<s.length;u++){var l=s[u],c=null;if(l.iter(e).exitWhen((function(e){if(e.isError())return c=e,!0;var n=e.getValue();return!!(e.isNumber()&&n<=0)&&(c=NR(t.name,n),!0)})).forEach((function(e){if(e.isNumber()){var t=e.getValue();r++,n+=1/t}})),c)return c}return new ut.NumberVar(r/n)}}]),t}(gC("HARMEAN",1,255,1,rC,[{type:tC|iC},{type:tC|iC}])),zD=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e){for(var t=[],n=arguments.length,r=new Array(n>1?n-1:0),a=1;a<n;a++)r[a-1]=arguments[a];for(var o=0,i=r;o<i.length;o++){var u=i[o],s=null;if(u.iter(e).exitWhen((function(e){return!!e.isError()&&(s=e,!0)})).forEach((function(e){if(e.isNumber()){var n=e.getValue();t.push(n)}})),s)return s}var l=t.length;if(l<4)return xR(this.name,4,l);var c=t.reduce((function(e,t){return e+t}),0)/l,h=t.reduce((function(e,t){return e+Math.pow(t-c,2)}),0)/(l-1),f=Math.sqrt(h),d=l*(l+1)/((l-1)*(l-2)*(l-3))*t.reduce((function(e,t){return e+Math.pow((t-c)/f,4)}),0)-3*Math.pow(l-1,2)/((l-2)*(l-3));return new ut.NumberVar(d)}}]),t}(gC("KURT",1,255,1,tC,[{type:tC|iC},{type:tC|iC}])),GD=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e){for(var t=[],n=arguments.length,r=new Array(n>1?n-1:0),a=1;a<n;a++)r[a-1]=arguments[a];for(var o=0,i=r;o<i.length;o++){var u=i[o],s=null;if(u.iter(e).exitWhen((function(e){return!!e.isError()&&(s=e,!0)})).forEach((function(e){if(e.isNumber()){var n=e.getValue();t.push(n)}})),s)return s}var l=t.length;if(l<3)return xR(this.name,3,l);var c=JD(t,!0),h=c.isError,f=c.num;return h?PR(this.name):new ut.NumberVar(f)}}]),t}(gC("SKEW.P",1,254,1,tC,[{type:tC|iC},{type:tC|iC}]));function JD(e,t){var n={isError:!1,num:0},r=e.length,a=e.reduce((function(e,t){return{sum:e.sum+t,sumSquares:e.sumSquares+Math.pow(t,2)}}),{sum:0,sumSquares:0}),o=a.sum,i=a.sumSquares,u=o/r,s=t?Math.sqrt(i-Math.pow(o,2)/r):Math.sqrt((r*i-Math.pow(o,2))/(r*(r-1)));if(0===s)return n.isError=!0,n;var l=e.reduce((function(e,t){return e+Math.pow((t-u)/s,3)}),0);return n.num=l*(t?Math.sqrt(r):r/((r-1)*(r-2))),n}var qD=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e){for(var t=[],n=arguments.length,r=new Array(n>1?n-1:0),a=1;a<n;a++)r[a-1]=arguments[a];for(var o=0,i=r;o<i.length;o++){var u=i[o],s=null;if(u.iter(e).exitWhen((function(e){return!!e.isError()&&(s=e,!0)})).forEach((function(e){if(e.isNumber()){var n=e.getValue();t.push(n)}})),s)return s}var l=t.length;if(l<3)return xR(this.name,3,l);var c=JD(t,!1),h=c.isError,f=c.num;return h?PR(this.name):new ut.NumberVar(f)}}]),t}(gC("SKEW",1,255,1,tC,[{type:tC|iC},{type:tC|iC}])),$D=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e,t){var n=t.getValue();if(n<0)return H_(this.name,1);if(n>2958465)return dR(this.name,1,n.toString());var r=ke.SheetDate.fromNumber(n),a=ke.SheetDate.from({year:r.year,date:1,month:1}),o=n-a.toNumber()+1,i=(r.day+7-1)%7,u=YD(o,r.day),s=ke.SheetDate.from({year:r.year-1,date:1,month:1}),l=ke.SheetDate.from({year:a.year+1,date:1,month:1});0===u&&(u=YD(o+a.toNumber()-s.toNumber(),r.day));var c=l.toNumber()-a.toNumber();return new ut.NumberVar(7-(i+c-o+7)%7>4&&o+7-i>c?1:u)}}]),t}(gC("ISOWEEKNUM",1,0,0,rC,[{type:tC}]));function YD(e,t){var n=(t-1-e+1)%7;n<0&&(n+=7);var r=Math.floor((e+n-1)/7);return 7-n>=4&&(r+=1),r}var KD,XD=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e,t){var n;if(bu(t))return ER(this.name,1,"");if(Fu(t))n=t.toRefMatrix();else{if(!Au(t))return ut.VALUE_ERR_VAR;n=t}return new Ru(function(e,t){for(var n=t.rowCount(),r=t.colCount(),a=[],o=0;o<r;o++){a[o]||(a[o]=[]);for(var i=0;i<n;i++)a[o][i]=t.getVarByPos(i,o,e)}return a}(e,n))}}]),t}(gC("TRANSPOSE",1,0,0,iC,[{type:iC}]));function QD(e,t,n,r,a){var o,i=a?function(e,t,n,r){for(var a=t.rowCount(),o=t.colCount(),i=Fu(t)?t.getRef():null,u=[],s=(r-1)*o,l=0;l<o;l++)u[l]={index:l,variant:t.nth(s+l,e)};u.sort((function(e,t){return MV(e.variant,t.variant,1===n)}));for(var c=[[]],h=0;h<a;h++){c[h]||(c[h]=[]);for(var f=0;f<o;f++){var d=u[f].index,v=t.nth(h*o+d,e);null!==i&&(v=uc(v,i,h,f)),c[h][f]=v}}return new Ru(c)}(e,t,r,n):function(e,t,n,r){for(var a=t.rowCount(),o=t.colCount(),i=Fu(t)?t.getRef():null,u=[[]],s=0;s<a;s++){u[s]||(u[s]=[]);for(var l=0;l<o;l++){var c=t.nth(s*o+l,e);null!==i&&(c=uc(c,i,s,l)),u[s][l]=c}}return new Ru(u.sort((function(e,t){return MV(e[r-1],t[r-1],1===n)})))}(e,t,r,n);return e.info&&(e.info.customData=null===(o=i.getVarByPos(0,0).getSpecialInfo())||void 0===o?void 0:o.customData),i}XD=Gi([cc("TRANSPOSE")],XD),function(e){e[e.ascending=1]="ascending",e[e.descending=-1]="descending"}(KD||(KD={}));var eP=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e,t,n,r,a){var o=n.getValue(),i=r.getValue(),u=a.getValue();return(u?t.rowCount():t.colCount())<o||o<1?ut.tractorErrorVarCreators[ut.ErrorCode.OUT_OF_RANGE_PARAMETER]({funcName:this.name,index:2,value:o.toString()}):1!==i&&-1!==i?nR(this.name,i.toString(),3,"1, -1"):(0,we.n5s)()?QD(e,t,o,i,u):((0,we.QFC)().finally((function(){e.service.emit("afterWaitAsyncCalc",e.formula,4)})),e.service.addCalculatingAsyncFormula(e.formula),ut.WAIT_ASYNC_ERR_VAR)}}]),t}(gC("SORT",1,3,0,iC|lC,[{type:iC},{type:tC,default:new ut.NumberVar(1)},{type:tC,default:new ut.NumberVar(1)},{type:rC,default:new ut.BooleanVar(!1)}]));eP=Gi([cc("SORT")],eP);var tP=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e,t,n,r,a){var o=n.getValue();if(o.length<=0)return IR(this.name,2);var i=o.replace(/[-[\]{}()*+!<=:?.\\^$|]/g,"\\$&");r.getValue()&&(i="["+i+"]");var u=t.getValue().split(new RegExp(i));if(a.getValue()&&(u=u.filter((function(e){return e.length>0}))),u.length<=0)return we.d$b[we.O6N.CALC_PARAMETER_SHOULD_BE_NON_BLANK]({funcName:this.name,index:1});for(var s=[],l=0;l<u.length;++l){var c=u[l];c.length<=0?s.push(ut.NULL_VAR):s.push(new ut.StringVar(c))}return new Ru([s])}}]),t}(gC("SPLIT",2,2,0,iC,[{type:nC},{type:nC},{type:rC,default:new ut.BooleanVar(!0)},{type:rC,default:new ut.BooleanVar(!0)}]));function nP(e,t,n){for(var r=n.length,a=r%2==0?null:n[r-1],o=0;o<r-(a?1:0);o+=2){var i=n[o],u=n[o+1];if((0,ut.equals)(e,t,i))return u}return a||JR}tP=Gi([cc("SPLIT")],tP);var rP=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e,t){for(var n=Fu(t)?t.getRef():null,r=Au(t)?t:t.toRefMatrix(),a=r.rowCount(),o=r.colCount(),i=[],u=arguments.length,s=new Array(u>2?u-2:0),l=2;l<u;l++)s[l-2]=arguments[l];for(var c=0;c<a;c++){i[c]||(i[c]=[]);for(var h=0;h<o;h++){var f=nP(e,r.getVarByPos(c,h,e),s);null!==n&&(f=uc(f,n,c,h)),i[c][h]=f}}return new Ru(i)}}]),t}(gC("SWITCH",3,256,1,fC|iC,[{type:iC,default:(Xe={},(0,l.Z)(Xe,ut.DefaultParam.IfInputNull,new Ru([[ut.NULL_VAR]])),(0,l.Z)(Xe,ut.DefaultParam.IfNotInput,new Ru([[ut.NULL_VAR]])),Xe)},{type:fC},{type:fC}]));rP=Gi([cc("SWITCH")],rP);var aP=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e,t,n){var r,a=this,o=t.isRef()?t.toRefMatrix():t,i=Fu(t)?t.getRef():null,u=o.rowCount(),s=o.colCount(),l=[],c=n.isRef()?n.toRefMatrix():n,h=c.colCount(),f=c.rowCount();if(h>1&&f>1)return zR(this.name);if(s!==h&&1===f||u!==f&&1===h)return CR(this.name,u,s,f,h);l.push(c);for(var d=0;d<(arguments.length<=3?0:arguments.length-3);++d){var v=d+3<3||arguments.length<=d+3?void 0:arguments[d+3],g=v.isRef()?v.toRefMatrix():v,m=g.rowCount(),p=g.colCount();if(m!==f||p!==h)return CR(this.name,f,h,m,p);l.push(g)}var y=[];if(1===h)for(var C=function(t){var n,r=oP(e,l,t);if(r instanceof ut.ErrorVar&&null!==(n=r.info)&&void 0!==n&&n.args&&(r.info.args.funcName=a.name),"boolean"!=typeof r)return{v:r};if(!r)return"continue";var u=[],s=-1;xu(o,t,1).iter(Object.assign({},e,{skipEmptyRef:!1})).forEach((function(e){s++,null!==i&&(e=uc(e,i,t,s)),u.push(e)})),y.push(u)},R=0;R<f;R++){var w=C(R);if("continue"!==w&&"object"===(0,_.Z)(w))return w.v}else for(var k=function(t){var n=oP(e,l,t);if("boolean"!=typeof n)return{v:n};if(!n)return"continue";var r=-1;Ou(o,t,1).iter(Object.assign({},e,{skipEmptyRef:!1})).forEach((function(e){y[++r]||(y[r]=[]),null!==i&&(e=uc(e,i,t,r)),y[r].push(e)}))},S=0;S<h;S++){var E=k(S);if("continue"!==E&&"object"===(0,_.Z)(E))return E.v}return y.length<=0?we.d$b[we.O6N.NA_MATCH_NOT_AVAILABLE]({funcName:this.name}):(e.info&&(e.info.customData=null===(r=y[0][0].getSpecialInfo())||void 0===r?void 0:r.customData),new Ru(y))}}]),t}(gC("FILTER",2,256,1,iC,[{type:iC},{type:iC},{type:iC}]));function oP(e,t,n){for(var r=!0,a=0;a<t.length;++a){var o=t[a].nth(n,e);if(o.isError()&&o.isRuntimeError())return o;var i=o.toBooleanVar(e.service);if(i.isNull()||!i.getValue()){r=!1;break}}return r}aP=Gi([cc("FILTER")],aP);var iP=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e,t,n,r){var a,o,i=t.isRef()?t.toRefMatrix():t,u=n.getValue(),s=i.rowCount(),l=i.colCount();u&&(s=(a=[l,s])[0],l=a[1]);for(var c=new Map,h=new Map,f=0;f<s;f++){for(var d="",v=0;v<l;v++){var g,m=f,y=v;u&&(y=(g=[m,y])[0],m=g[1]),d+=FV(i.getVarByPos(m,y,e))+"#"}var C=h.has(d),_=c.get(d);r.getValue()?(_||c.set(d,!0),_&&C?h.delete(d):_||C||h.set(d,f)):C||h.set(d,f)}if(0===h.size)return we.d$b[we.O6N.NA_DELETED_REFERENCE]();var R,w=[],k=Fu(t)?t.getRef():null,S=-1,E=_n(h);try{for(E.s();!(R=E.n()).done;){var T=(0,p.Z)(R.value,2),A=(T[0],T[1]);S++;for(var I=0;I<l;I++)if(u){w[I]||(w[I]=[]);var b=i.getVarByPos(I,A,e);null!==k&&(b=uc(b,k,A,I)),w[I][S]=b}else{w[S]||(w[S]=[]);var F=i.getVarByPos(A,I,e);null!==k&&(F=uc(F,k,A,I)),w[S][I]=F}}}catch(e){E.e(e)}finally{E.f()}return e.info&&(e.info.customData=null===(o=w[0][0].getSpecialInfo())||void 0===o?void 0:o.customData),new Ru(w)}}]),t}(gC("UNIQUE",1,2,0,iC,[{type:iC},{type:rC,default:new ut.BooleanVar(!1)},{type:rC,default:new ut.BooleanVar(!1)}]));iP=Gi([cc("UNIQUE")],iP);var uP=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e,t){for(var n=t.getValue(),r=arguments.length<=2?0:arguments.length-2,a=[],o=0;o<r;o++){var i=o+2<2||arguments.length<=o+2?void 0:arguments[o+2];if((Au(i)||Fu(i))&&i.rowCount()>1&&i.colCount()>1)return zR(this.name);var u=null;if(i.iter(Object.assign({},e,{skipEmptyRef:!1})).first_if((function(e){if(e.isError())return u=e,!0;var t=e.toStringVar().getValue();return null!==t&&a.push(t),!1})),null!==u)return u}return new ut.StringVar(a.join(n))}}]),t}(gC("JOIN",2,255,1,nC,[{type:nC},{type:nC|iC},{type:nC|iC}])),sP=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e,t){return t.isString()?t:new ut.StringVar("")}}]),t}(gC("T",1,0,0,nC,[{type:tC|rC|nC|eC}])),lP=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e,t){var n=arguments.length<=2?0:arguments.length-2,r=[];if(!t.isRef())return wR(this.name,1);for(var a=0;a<n;a+=2){var o=a+2<2||arguments.length<=a+2?void 0:arguments[a+2];if(o.rowCount()!==t.rowCount()||o.colCount()!==t.colCount())return kR(this.name);var i=a+1+2<2||arguments.length<=a+1+2?void 0:arguments[a+1+2];i.isNull()&&(i=new ut.StringVar("0")),r.push({criteria:i,lookup:o,colFrom:o.isRef()?o.getRef().rowFrom():0,rowFrom:o.isRef()?o.getRef().colFrom():0})}return cP(e,t,r,this.comparator)}}]),t}(gC("",3,252,2,tC,[iw.MATRIX_AND_SHEET_REF,iw.MATRIX_AND_SHEET_REF,{type:tC|nC|rC|eC|aC},iw.MATRIX_AND_SHEET_REF,{type:tC|nC|rC|eC|aC}]));function cP(e,t,n,r){for(var a=[],o=0;o<n.length;o++){var i=(0,Mt.buildCriteria)(e,n[o].criteria);if(null===i)return new ut.NumberVar(0);a.push(i)}for(var u=null,s=null,l=t,c=l.rowCount(),h=l.colCount(),f=0;f<c;f++)for(var d=0;d<h;d++){var v=l.getVarByPos(f,d,e);if(!(v.isString()||v.isBool()||v.isNull())){for(var g=!0,m=0;m<a.length;m++)if(!(0,a[m])(gu(n[m].lookup.getVarByPos(f,d,e),e))){g=!1;break}if(g){if(v.isError()){s=v;break}u=null===u?v.getValue():r(u,v.getValue())}}}return s||(null!==u&&Number.isFinite(u)?new ut.NumberVar(u):new ut.NumberVar(0))}var hP=function(e){function t(){var e;return(0,y.Z)(this,t),(e=(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))).name="MAXIFS",e.comparator=Math.max,e}return(0,g.Z)(t,e),t}(lP),fP=function(e){function t(){var e;return(0,y.Z)(this,t),(e=(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))).name="MINIFS",e.comparator=Math.min,e}return(0,g.Z)(t,e),t}(lP),dP=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e,t,n){var r=vP(t),a=vP(n),o=r.colCount(),i=r.rowCount(),u=a.rowCount(),s=a.colCount();if(o!==u)return we.d$b[we.O6N.INCOMPATIBLE_MATRIX_SIZES]({funcName:this.name,cols:o,rows:u});for(var l=[],c=0;c<i;c++)for(var h=0;h<s;h++){l[c]||(l[c]=[]);for(var f=0,d=!1,v=0;v<u;v++){var g=r.getVarByPos(c,v,e),m=a.getVarByPos(v,h,e);if(!g.isNumber()||!m.isNumber()){var p=void 0,y=void 0;return g.isNumber()?(p=2,y=null==m.getValue()?"":m.isBool()?m.getValue().toString().toUpperCase():m.getValue().toString()):(p=1,y=null==g.getValue()?"":g.isBool()?g.getValue().toString().toUpperCase():g.getValue().toString()),yR(this.name,p,y,g.isBool()?ut.FormulaErrorPhrases.DATA_TYPE_BOOLEAN:g.isString()?ut.FormulaErrorPhrases.DATA_TYPE_STRING:g.isNull()?ut.FormulaErrorPhrases.DATA_TYPE_EMPTY:"",ut.FormulaErrorPhrases.DATA_TYPE_DOUBLE)}if(f+=g.getValue()*m.getValue(),!Number.isFinite(f)){d=!0;break}}l[c][h]=d?G_:new ut.NumberVar(f)}return new Ru(l)}}]),t}(gC("MMULT",2,0,0,iC,[{type:iC,default:ut.NA_ERR_VAR},{type:iC,default:ut.NA_ERR_VAR}]));function vP(e){return e.isRef()?e.toRefMatrix():e}function gP(e,t,n){return e===we.O6N.NO_QUERY_OUTPUT?new ut.ErrorVar(ut.ErrorType.NA,ut.ErrorConstant.NA,e):new ut.ErrorVar(ut.ErrorType.VALUE,ut.ErrorConstant.VALUE,e,{message:t,args:n})}dP=Gi([cc("MMULT")],dP);var mP=function(e){function t(e,n,r){var a;return(0,y.Z)(this,t),(a=(0,d.Z)(this,(0,v.Z)(t).call(this,n))).code=e,a.message=n,a.args=r,a}return(0,g.Z)(t,e),t}((0,a.Z)(Error)),pP={1:6,3:5,4:4,0:3,2:2,5:1,6:0};function yP(e,t){var n=t.rowFrom,r=t.columnDataTypeAssert,a=t.referencedColumns,o=t.headerCount,i=t.ctx,u=e.rowCount(),s=Object.keys(a),l=[],c={},h={},f=new EP;if(null===o||o<0){var d=function(e,t){for(var n=t.rowFrom,r=t.rowCount,a=t.dataTypeInfoCache,o=t.ctx,i=0,u=n+r-1,s=e.colCount(),l=n;l<=u;l++){for(var c=0;c<s;c++){var h=RP(e,l,c,o);if(h instanceof ut.ErrorVar)return h;if(a.setCache(l,c,h),2!==h.dataType&&6!==h.dataType)return i}i++}return i===r?0:i}(e,{rowFrom:n,rowCount:u,dataTypeInfoCache:f,ctx:i});if(d instanceof ut.ErrorVar)return d;o=d}for(var v=o>0?function(e){var t=e.rowFrom,n=e.rowCount,r=e.referencedColumns,a=e.dataTypeInfoCache,o=e.dataSource,i=e.ctx,u={},s=t+n-1;for(var l in r){for(var c=r[l],h=[],f=t;f<=s;f++){var d,v,g=null!==(d=a.getCache(f,c))&&void 0!==d?d:RP(o,f,c,i);a.setCache(f,c,g);var m=wP(g.dataType,g.value,null!==(v=g.formatter)&&void 0!==v?v:null,2);null===m||h.push(m)}u[l]=h.join(" ")}return u}({rowFrom:n,rowCount:o,referencedColumns:a,dataTypeInfoCache:f,dataSource:e,ctx:i}):{},g={colIndex:0,rowCount:u-=o,rowFrom:n+=o,dataTypeInfoCache:f,ctx:i},m=0,p=s;m<p.length;m++){var y=p[m],C=a[y];g.colIndex=C;var _=CP(e,g);if(_ instanceof ut.ErrorVar)return _;var R=_.maxDataType,w=_.maxFormatter;if(void 0!==r){var k=r[C];if(void 0!==k)for(var S=0;S<k.length;S++){var E=(0,k[S])(R);if(!1!==E)return gP(E.code,E.message,E.args)}}w&&(c[y]=w),h[C]=R}for(var T=0,A=s;T<A.length;T++){var I=a[A[T]],b=_P(e,{rowFrom:n,rowCount:u,colIndex:I,columnType:h[I],dataTypeInfoCache:f,ctx:i});if(b instanceof ut.ErrorVar)return b;l[I]=b}return{dataMatrix:l,rowCount:u,refNameTitleMap:v,formatterMap:c}}function CP(e,t){for(var n,r=t.rowFrom,a=t.rowCount,o=t.colIndex,i=t.dataTypeInfoCache,u=t.ctx,s={},l={},c=6,h=0,f=r+a-1,d=r;d<=f;d++){var v,g,m=null!==(v=i.getCache(d,o))&&void 0!==v?v:RP(e,d,o,u);if(m instanceof ut.ErrorVar)return m;var p=m.dataType,y=m.value;if(6!==p){var C=m.formatter;i.setCache(d,o,{dataType:p,value:y,formatter:C});var _=(null!==(g=l[p])&&void 0!==g?g:0)+1;if(l[p]=_,void 0===s[p]&&(void 0===C&&(C=e.getFormatterByPos(d,o,u)),null!==C&&(s[p]=C)),(_>h||_===h&&pP[p]>pP[c])&&(c=p,(h=_)>a/2))break}}return{maxDataType:c,maxFormatter:null!==(n=s[c])&&void 0!==n?n:null}}function _P(e,t){for(var n=t.rowFrom,r=t.rowCount,a=t.colIndex,o=t.columnType,i=t.dataTypeInfoCache,u=t.ctx,s=[],l=0,c=n+r,h=n;h<c;h++){var f,d,v=null!==(f=i.getCache(h,a))&&void 0!==f?f:RP(e,h,a,u);if(v instanceof ut.ErrorVar)return v;s[l]=wP(v.dataType,v.value,null!==(d=v.formatter)&&void 0!==d?d:null,o),l++}return s}function RP(e,t,n,r){var a,o=e.getValueByPos(t,n,r);if(o instanceof ut.ErrorVar)return o;if(null===o)return{dataType:6,value:o};if("boolean"==typeof o)return{dataType:1,value:o};if("string"==typeof o)return{dataType:2,value:o};if((a=e.getFormatterByPos(t,n,r))instanceof ut.ErrorVar)return a;if(null===a)return{dataType:0,formatter:null,value:o};var i=(0,Se.hasDate)(a),u=(0,Se.hasTime)(a),s=0;return i&&u?s=4:i?s=3:u&&(s=5),{dataType:s,formatter:a,value:o}}function wP(e,t,n,r){if(6===e||6===r)return null;if(0===r&&(0===e||kP(e)))return t;if(2===r){if(2===e)return t;if(0===e||kP(e))return null!==n?n.format(t):String(t);if(1===e)return!0===t?"TRUE":"FALSE"}if(1===r&&1===e)return t;if(kP(r)&&(kP(e)||0===e)){var a=new ke.SheetDate(t).getUTCDate();return isNaN(a.getTime())?null:a}return null}function kP(e){return 3===e||4===e||5===e}var SP,EP=function(){function e(){(0,y.Z)(this,e),this.cache=[]}return(0,C.Z)(e,[{key:"getCache",value:function(e,t){var n,r=this.cache[e];return void 0===r?null:null!==(n=r[t])&&void 0!==n?n:null}},{key:"setCache",value:function(e,t,n){var r=this.cache[e]||[];r[t]=n,this.cache[e]=r}}]),e}();!function(e){e.Identifier="Identifier",e.SelectKeyword="SelectKeyword",e.WhereKeyword="WhereKeyword",e.PivotKeyword="PivotKeyword",e.GroupByKeyword="GroupByKeyword",e.OrderByKeyword="OrderByKeyword",e.LimitKeyword="LimitKeyword",e.OffsetKeyword="OffsetKeyword",e.LabelKeyword="LabelKeyword",e.NumberLiteral="NumberLiteral",e.StringLiteral="StringLiteral",e.BooleanLiteral="BooleanLiteral",e.DateLiteral="DateLiteral",e.DateTimeLiteral="DateTimeLiteral",e.TimeOfDayLiteral="TimeOfDayLiteral",e.NullLiteral="NullLiteral",e.Not="Not",e.ComparisonOperator="ComparisonOperator",e.GreaterThan="GreaterThan",e.LessThan="LessThan",e.GreaterThanEqual="GreaterThanEqual",e.LessThanEqual="LessThanEqual",e.NotEqual="NotEqual",e.Equal="Equal",e.Is="Is",e.And="And",e.Or="Or",e.Like="Like",e.AdditionAndSubtraction="AdditionAndSubtraction",e.Plus="Plus",e.Minus="Minus",e.MultiplicationAndDivisionAndModulo="MultiplicationAndDivisionAndModulo",e.Asterisk="Asterisk",e.Divide="Divide",e.Modulo="Modulo",e.Comma="Comma",e.OpenParen="OpenParen",e.CloseParen="CloseParen",e.WhiteSpace="WhiteSpace",e.Desc="Desc",e.Asc="Asc"}(SP||(SP={}));var TP=(0,wt.createToken)({name:SP.Identifier,pattern:/[A-Za-z]\w*/}),AP=(0,wt.createToken)({name:SP.SelectKeyword,pattern:/SELECT/i}),IP=(0,wt.createToken)({name:SP.WhereKeyword,pattern:/WHERE/i}),bP=(0,wt.createToken)({name:SP.PivotKeyword,pattern:/PIVOT/i}),FP=(0,wt.createToken)({name:SP.GroupByKeyword,pattern:/GROUP\s+BY/i}),MP=(0,wt.createToken)({name:SP.OrderByKeyword,pattern:/ORDER\s+BY/i}),VP=(0,wt.createToken)({name:SP.LimitKeyword,pattern:/LIMIT/i}),NP=(0,wt.createToken)({name:SP.OffsetKeyword,pattern:/OFFSET/i}),OP=(0,wt.createToken)({name:SP.LabelKeyword,pattern:/LABEL/i}),xP=(0,wt.createToken)({name:SP.NumberLiteral,pattern:/(?:[0-9]+(\.[0-9]*)?|\.[0-9]+)/,longer_alt:TP}),ZP=(0,wt.createToken)({name:SP.StringLiteral,pattern:/(?:'[^']*')|(?:"[^"]*")|(?:`[^`]*`)/}),DP=(0,wt.createToken)({name:SP.BooleanLiteral,pattern:/TRUE|FALSE/i,longer_alt:TP}),PP=(0,wt.createToken)({name:SP.DateLiteral,pattern:/date\s+(?:('[^']*')|(?:"[^"]*"))/i}),LP=(0,wt.createToken)({name:SP.DateTimeLiteral,pattern:/datetime\s+(?:('[^']*')|(?:"[^"]*"))/i}),BP=(0,wt.createToken)({name:SP.TimeOfDayLiteral,pattern:/timeofday\s+(?:('[^']*')|(?:"[^"]*"))/i}),UP=(0,wt.createToken)({name:SP.NullLiteral,pattern:/NULL/i,longer_alt:TP}),HP=(0,wt.createToken)({name:SP.Not,pattern:/NOT/i,longer_alt:TP}),WP=(0,wt.createToken)({name:SP.ComparisonOperator,pattern:wt.Lexer.NA}),jP=(0,wt.createToken)({name:SP.GreaterThan,pattern:/>/,categories:WP}),zP=(0,wt.createToken)({name:SP.LessThan,pattern:/</,categories:WP}),GP=(0,wt.createToken)({name:SP.GreaterThanEqual,pattern:/>=/,categories:WP}),JP=(0,wt.createToken)({name:SP.LessThanEqual,pattern:/<=/,categories:WP}),qP=(0,wt.createToken)({name:SP.NotEqual,pattern:/<>|!=/,categories:WP}),$P=(0,wt.createToken)({name:SP.Equal,pattern:/=/,categories:WP}),YP=(0,wt.createToken)({name:SP.Like,pattern:/LIKE/i,categories:WP}),KP=(0,wt.createToken)({name:SP.Is,pattern:/IS/i,longer_alt:TP}),XP=(0,wt.createToken)({name:SP.And,pattern:/AND/i,longer_alt:TP}),QP=(0,wt.createToken)({name:SP.Or,pattern:/OR/i,longer_alt:TP}),eL=(0,wt.createToken)({name:SP.AdditionAndSubtraction,pattern:wt.Lexer.NA}),tL=(0,wt.createToken)({name:SP.Plus,pattern:/\+/,categories:eL}),nL=(0,wt.createToken)({name:SP.Minus,pattern:/-/,categories:eL}),rL=(0,wt.createToken)({name:SP.MultiplicationAndDivisionAndModulo,pattern:wt.Lexer.NA}),aL=(0,wt.createToken)({name:SP.Asterisk,pattern:/\*/,categories:rL}),oL=(0,wt.createToken)({name:SP.Divide,pattern:/\//,categories:rL}),iL=(0,wt.createToken)({name:SP.Modulo,pattern:/%/,categories:rL}),uL=(0,wt.createToken)({name:SP.Comma,pattern:/,/}),sL=(0,wt.createToken)({name:SP.OpenParen,pattern:/\(/}),lL=(0,wt.createToken)({name:SP.CloseParen,pattern:/\)/}),cL=[AP,IP,bP,FP,MP,VP,NP,OP,(0,wt.createToken)({name:SP.Desc,pattern:/DESC/i,longer_alt:TP}),(0,wt.createToken)({name:SP.Asc,pattern:/ASC/i,longer_alt:TP}),PP,LP,BP,xP,ZP,DP,UP,sL,lL,uL,HP,tL,nL,aL,oL,iL,KP,XP,QP,YP,GP,JP,qP,jP,zP,$P,TP,WP,eL,rL,(0,wt.createToken)({name:SP.WhiteSpace,pattern:/\s+/,group:wt.Lexer.SKIPPED})],hL=function(){var e={};return cL.forEach((function(t){e[t.name]=t})),e}(),fL=null;function dL(e){return(null===fL&&(fL=new wt.Lexer(cL)),fL).tokenize(e)}var vL=null;var gL,mL,pL,yL,CL,_L,RL,wL={LABEL:"lhs"},kL={LABEL:"rhs"},SL=function(e){function t(){var e;(0,y.Z)(this,t),e=(0,d.Z)(this,(0,v.Z)(t).call(this,cL,{skipValidations:!0}));var n=(0,c.Z)(e);return n.RULE("QueryStatement",(function(){n.OPTION((function(){n.SUBRULE(n.SelectClause)})),n.OPTION1((function(){n.SUBRULE(n.WhereClause)})),n.OPTION2((function(){n.SUBRULE(n.GroupByClause)})),n.OPTION3((function(){n.SUBRULE(n.PivotClause)})),n.OPTION4((function(){n.SUBRULE(n.OrderByClause)})),n.OPTION5((function(){n.SUBRULE(n.LimitClause)})),n.OPTION6((function(){n.SUBRULE(n.OffsetClause)})),n.OPTION7((function(){n.SUBRULE(n.LabelClause)}))})),n.RULE("SelectClause",(function(){n.CONSUME(hL[SP.SelectKeyword]),n.OR([{ALT:function(){return n.CONSUME(hL[SP.Asterisk])}},{ALT:function(){n.SUBRULE(n.Expression),n.MANY((function(){n.CONSUME(hL[SP.Comma]),n.SUBRULE1(n.Expression)}))}}])})),n.RULE("WhereClause",(function(){n.CONSUME(hL[SP.WhereKeyword]),n.SUBRULE(n.Expression)})),n.RULE("GroupByClause",(function(){n.CONSUME(hL[SP.GroupByKeyword]),n.SUBRULE(n.Expression),n.MANY((function(){n.CONSUME(hL[SP.Comma]),n.SUBRULE1(n.Expression)}))})),n.RULE("PivotClause",(function(){n.CONSUME(hL[SP.PivotKeyword]),n.SUBRULE(n.Expression),n.MANY((function(){n.CONSUME(hL[SP.Comma]),n.SUBRULE1(n.Expression)}))})),n.RULE("OrderByClause",(function(){n.CONSUME(hL[SP.OrderByKeyword]),n.SUBRULE(n.OrderByExpression),n.MANY((function(){n.CONSUME(hL[SP.Comma]),n.SUBRULE1(n.OrderByExpression)}))})),n.RULE("OrderByExpression",(function(){n.SUBRULE(n.Expression),n.OPTION((function(){n.OR([{ALT:function(){return n.CONSUME(hL[SP.Desc])}},{ALT:function(){return n.CONSUME(hL[SP.Asc])}}])}))})),n.RULE("LimitClause",(function(){n.CONSUME(hL[SP.LimitKeyword]),n.OPTION((function(){return n.CONSUME(hL[SP.Minus])})),n.CONSUME(hL[SP.NumberLiteral])})),n.RULE("OffsetClause",(function(){n.CONSUME(hL[SP.OffsetKeyword]),n.OPTION((function(){return n.CONSUME(hL[SP.Minus])})),n.CONSUME(hL[SP.NumberLiteral])})),n.RULE("LabelClause",(function(){n.CONSUME(hL[SP.LabelKeyword]),n.SUBRULE(n.LabelExpression),n.MANY((function(){n.CONSUME(hL[SP.Comma]),n.SUBRULE1(n.LabelExpression)}))})),n.RULE("LabelExpression",(function(){n.SUBRULE(n.Expression),n.CONSUME(hL[SP.StringLiteral])})),n.RULE("Expression",(function(){n.SUBRULE(n.AndExpression,wL),n.MANY((function(){n.CONSUME(hL[SP.Or]),n.SUBRULE1(n.AndExpression,kL)}))})),n.RULE("AndExpression",(function(){n.SUBRULE(n.IsExpression,wL),n.MANY((function(){n.CONSUME(hL[SP.And]),n.SUBRULE1(n.IsExpression,kL)}))})),n.RULE("IsExpression",(function(){n.SUBRULE(n.ComparisonExpression),n.OPTION((function(){n.CONSUME(hL[SP.Is]),n.OPTION1((function(){return n.CONSUME(hL[SP.Not])})),n.CONSUME(hL[SP.NullLiteral])}))})),n.RULE("ComparisonExpression",(function(){n.SUBRULE(n.AdditionAndSubtractionExpression,wL),n.MANY((function(){n.CONSUME(hL[SP.ComparisonOperator]),n.SUBRULE1(n.AdditionAndSubtractionExpression,kL)}))})),n.RULE("AdditionAndSubtractionExpression",(function(){n.SUBRULE(n.MultiplicationAndDivisionAndModuloExpression,wL),n.MANY((function(){n.CONSUME(hL[SP.AdditionAndSubtraction]),n.SUBRULE1(n.MultiplicationAndDivisionAndModuloExpression,kL)}))})),n.RULE("MultiplicationAndDivisionAndModuloExpression",(function(){n.SUBRULE(n.NotExpression,wL),n.MANY((function(){n.CONSUME(hL[SP.MultiplicationAndDivisionAndModulo]),n.SUBRULE1(n.NotExpression,kL)}))})),n.RULE("NotExpression",(function(){n.OR([{ALT:function(){return n.SUBRULE(n.Literal)}},{ALT:function(){return n.SUBRULE(n.GroupExpression)}},{ALT:function(){return n.SUBRULE(n.Function)}},{ALT:function(){return n.CONSUME(hL[SP.Identifier])}}])})),n.RULE("GroupExpression",(function(){n.CONSUME(hL[SP.OpenParen]),n.SUBRULE(n.Expression),n.CONSUME(hL[SP.CloseParen])})),n.RULE("Function",(function(){n.CONSUME(hL[SP.Identifier]),n.CONSUME(hL[SP.OpenParen]),n.OPTION((function(){n.SUBRULE(n.Expression,{LABEL:"argument1"})})),n.MANY((function(){n.CONSUME(hL[SP.Comma]),n.SUBRULE1(n.Expression,{LABEL:"restArguments"})})),n.CONSUME(hL[SP.CloseParen])})),n.RULE("Literal",(function(){n.OR([{ALT:function(){return n.CONSUME(hL[SP.DateLiteral])}},{ALT:function(){return n.CONSUME(hL[SP.DateTimeLiteral])}},{ALT:function(){return n.CONSUME(hL[SP.TimeOfDayLiteral])}},{ALT:function(){return n.CONSUME(hL[SP.BooleanLiteral])}},{ALT:function(){n.OPTION((function(){return n.CONSUME(hL[SP.Minus])})),n.CONSUME(hL[SP.NumberLiteral])}},{ALT:function(){return n.CONSUME(hL[SP.StringLiteral])}}])})),e.performSelfAnalysis(),e}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"parse",value:function(e){return this.input=e,this.QueryStatement()}}]),t}(wt.CstParser);!function(e){e[e.Ref=0]="Ref",e[e.Function=1]="Function",e[e.Constant=2]="Constant"}(gL||(gL={})),function(e){e[e.Number=0]="Number",e[e.Boolean=1]="Boolean",e[e.String=2]="String",e[e.Date=3]="Date",e[e.DateTime=4]="DateTime",e[e.TimeOfDay=5]="TimeOfDay",e[e.Null=6]="Null"}(mL||(mL={})),function(e){e.Desc="DESC",e.Asc="ASC"}(pL||(pL={})),function(e){e.Year="YEAR",e.Month="MONTH",e.Day="DAY"}(yL||(yL={})),function(e){e.Avg="AVG",e.Count="COUNT",e.Max="MAX",e.Min="MIN",e.Sum="SUM"}(CL||(CL={})),function(e){e.Group="GROUP",e.SelectAllColumn="SELECT_ALL_COLUMN",e.Label="LABLE"}(_L||(_L={})),function(e){e.Group="GROUP",e.Not="Not",e.Or="Or",e.And="And",e.Is="Is",e.Like="Like",e.GreaterThan="GreaterThan",e.LessThan="LessThan",e.GreaterThanEqual="GreaterThanEqual",e.LessThanEqual="LessThanEqual",e.Equal="Equal",e.NotEqual="NotEqual",e.Plus="Plus",e.Minus="Minus",e.Multiply="Asterisk",e.Divide="Divide",e.Modulo="Modulo",e.Desc="DESC",e.Asc="ASC",e.Year="YEAR",e.Month="MONTH",e.Day="DAY",e.Avg="AVG",e.Count="COUNT",e.Max="MAX",e.Min="MIN",e.Sum="SUM",e.SelectAllColumn="SELECT_ALL_COLUMN",e.Label="LABLE"}(RL||(RL={}));var EL,TL=[RL.Avg,RL.Count,RL.Max,RL.Min,RL.Sum],AL=[RL.Year,RL.Month,RL.Day],IL=[RL.Plus,RL.Minus,RL.Multiply,RL.Divide,RL.Modulo],bL=[RL.Year,RL.Month,RL.Day,RL.Avg,RL.Count,RL.Max,RL.Min,RL.Sum],FL=[RL.Or,RL.And,RL.Is,RL.Like,RL.GreaterThan,RL.LessThan,RL.GreaterThanEqual,RL.LessThanEqual,RL.Equal,RL.NotEqual];function ML(e,t,n){var r=e.valueMatrix,a=e.referencedColumns,o=e.rowCount,i=[],u={},s=Object.keys(a);s.forEach((function(e,t){u[e]=t}));for(var l=0,c=function(e){(null==n?void 0:n.has(e))||(i[l]=new Array(s.length),s.forEach((function(t,n){var o=a[t];i[l][n]=r[o][e]})),l++)},h=0;h<o;h++)c(h);for(var f in t)t[f].toArray(n).forEach((function(e,t){i[t].push(e)})),u[f]=i[0].length-1;return e.referencedColumns=u,i}function VL(e,t,n){var r=ML(e,t,n),a=Object.keys(e.referencedColumns).map((function(e){return ZL(e)}));return r.unshift(a),r}function NL(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[RL.Group];return 1===e.type&&t.includes(e.operator)&&Array.isArray(e.parameters)&&1===e.parameters.length?NL(e.parameters[0]):e}function OL(e){return NL(e,[RL.Group,RL.Asc,RL.Desc])}function xL(e,t){return e=e.toUpperCase(),t=t.toUpperCase(),e.includes(t)?1:0}function ZL(e){return e.replace(/[A-Z]+(?!(\(|\d|[A-Z]|[a-z]))/,(function(e){return"$$_".concat(e,"_$$")})).replace(/Col[0-9]+/,(function(e){return"$$_".concat(e,"_$$")}))}function DL(e,t){return null==e?e:e.replace(/(\$\$_((Col[0-9]+|[A-Z]+)|(?!\())_\$\$)/g,(function(){for(var e,n=arguments.length,r=new Array(n),a=0;a<n;a++)r[a]=arguments[a];return t&&r&&void 0!==t[r[2]]?t[r[2]]:null!==(e=r[2])&&void 0!==e?e:""}))}!function(e){e.QueryStatement="QueryStatement",e.SelectClause="SelectClause",e.WhereClause="WhereClause",e.GroupByClause="GroupByClause",e.PivotClause="PivotClause",e.OrderByClause="OrderByClause",e.LimitClause="LimitClause",e.OffsetClause="OffsetClause",e.LabelClause="LabelClause",e.Expression="Expression",e.OrderByExpression="OrderByExpression",e.Literal="Literal",e.Function="Function",e.GroupExpression="GroupExpression",e.IsExpression="IsExpression",e.AndExpression="AndExpression",e.AdditionAndSubtractionExpression="AdditionAndSubtractionExpression",e.MultiplicationAndDivisionAndModuloExpression="MultiplicationAndDivisionAndModuloExpression",e.ModuloExpression="ModuloExpression",e.ComparisonExpression="ComparisonExpression",e.NotExpression="NotExpression",e.IsNullExpression="IsNullExpression",e.LabelExpression="LabelExpression"}(EL||(EL={}));var PL,LL=null,BL=new Date(ke.SheetDate.BASE_MILLISECONDS),UL="".concat(BL.getFullYear(),"-").concat(BL.getMonth()+1,"-").concat(BL.getDate()),HL=/date\s+('(\d{4}-\d{1,2}-\d{1,2})'|"(\d{4}-\d{1,2}-\d{1,2})")/i,WL=/datetime\s+('(\d{4}-\d{1,2}-\d{1,2} \d{1,2}:\d{1,2}:\d{1,2}(?:\.\d+)?)'|"(\d{4}-\d{1,2}-\d{1,2} \d{1,2}:\d{1,2}:\d{1,2}(?:\.\d+)?)")/i,jL=/timeofday\s+('(\d{1,2}:\d{1,2}:\d{1,2}(?:\.\d+)?)'|"(\d{1,2}:\d{1,2}:\d{1,2}(?:\.\d+)?)")/i,zL=/[^A-Z]/,GL=/^Col([1-9]\d*)$/;!function(e){e.Select="SELECT",e.Where="WHERE",e.GroupBy="GROUP BY",e.Pivot="PIVOT",e.OrderBy="ORDER BY",e.Limit="LIMIT",e.Offset="OFFSET",e.Label="LABEL"}(PL||(PL={}));var JL={WHERE:we.O6N.CANNOT_BE_IN_WHERE,"GROUP BY":we.O6N.CANNOT_BE_IN_GROUP_BY,PIVOT:we.O6N.CANNOT_BE_IN_PIVOT},qL=(Qe={},(0,l.Z)(Qe,RL.Plus,we.O6N.CAN_NOT_PERFORM_THE_FUNCTION_SUM_ON_VALUES_THAT_ARE_NOT_NUMBERS),(0,l.Z)(Qe,RL.Minus,we.O6N.CAN_NOT_PERFORM_THE_FUNCTION_DIFFERENCE_ON_VALUES_THAT_ARE_NOT_NUMBERS),(0,l.Z)(Qe,RL.Multiply,we.O6N.CAN_NOT_PERFORM_THE_FUNCTION_PRODUCT_ON_VALUES_THAT_ARE_NOT_NUMBERS),(0,l.Z)(Qe,RL.Divide,we.O6N.CAN_NOT_PERFORM_THE_FUNCTION_QUOTIENT_ON_VALUES_THAT_ARE_NOT_NUMBERS),(0,l.Z)(Qe,RL.Modulo,we.O6N.CAN_NOT_PERFORM_THE_FUNCTION_MODULO_ON_VALUES_THAT_ARE_NOT_NUMBERS),Qe),$L=(et={},(0,l.Z)(et,RL.And,we.O6N.THE_LOGICAL_OPERATOR_AND_USING_TO_JOIN_MULTIPLE_CONDITION),(0,l.Z)(et,RL.Or,we.O6N.THE_LOGICAL_OPERATOR_OR_USING_TO_JOIN_MULTIPLE_CONDITION),et);function YL(e){return 0===e.type||2===e.type&&(3===e.constantType||4===e.constantType)}var KL=(tt={},(0,l.Z)(tt,RL.Year,{count:1,countError:we.O6N.NUMBER_OF_PARAMETERS_FOR_YEAR_IS_WRONG,check:YL,typeError:we.O6N.CAN_NOT_PERFORM_THE_FUNCTION_YEAR_ON_A_COLUMN_THAT_ARE_NOT_DATE_OR_DATETIME_COLUMN}),(0,l.Z)(tt,RL.Month,{count:1,countError:we.O6N.NUMBER_OF_PARAMETERS_FOR_MONTH_IS_WRONG,check:YL,typeError:we.O6N.CAN_NOT_PERFORM_THE_FUNCTION_MONTH_ON_A_COLUMN_THAT_ARE_NOT_DATE_OR_DATETIME_COLUMN}),(0,l.Z)(tt,RL.Day,{count:1,countError:we.O6N.NUMBER_OF_PARAMETERS_FOR_DAY_IS_WRONG,check:YL,typeError:we.O6N.CAN_NOT_PERFORM_THE_FUNCTION_DAY_ON_A_COLUMN_THAT_ARE_NOT_DATE_OR_DATETIME_COLUMN}),tt);function XL(e){if(null===LL){var t=function(e){return function(e){function t(){var e;return(0,y.Z)(this,t),(e=(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))).avgAndSumParamAssert=function(t){return function(n){return 0!==n&&new mP(we.O6N.AVG_SUM_ONLY_NUMERIC,e.errorMessage(we.O6N.AVG_SUM_ONLY_NUMERIC),{avgOrSum:t})}},e.scalarParamAssert=function(t,n){return function(r){return![3,4].includes(r)&&new mP(n,e.errorMessage(n),{scalarFunctionName:t})}},e.binaryOpParamAssert=function(t,n){return function(r){return 0!==r&&new mP(t,e.errorMessage(t),{binaryOperator:n})}},e}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"resetState",value:function(){this.phase="SELECT",this.output={},this.aggregationFunctionMap={},this.referencedColumns={},this.columnDataTypeAssert={},this.hasGroupByExpression=!1,this.hasPivotExpression=!1}},{key:"visitTree",value:function(e,t){return this.resetState(),this.options=t,this.visit(e)}},{key:"getColumnDataTypeAssert",value:function(){return this.columnDataTypeAssert}},{key:"getReferencedColumns",value:function(){return this.referencedColumns}},{key:"QueryStatement",value:function(e){var t;if(void 0!==e.GroupByClause&&(this.hasGroupByExpression=!0),void 0!==e.PivotClause&&(this.hasPivotExpression=!0),void 0!==e.SelectClause?this.output.select=this.visit(e.SelectClause):this.output.select=this.selectAllColumn(),void 0!==e.WhereClause&&(this.output.where=this.visit(e.WhereClause)),this.hasGroupByExpression&&(this.output.groupBy=this.visit(e.GroupByClause)),this.hasPivotExpression&&(this.output.pivot=this.visit(e.PivotClause)),void 0!==e.OrderByClause&&(this.output.orderBy=this.visit(e.OrderByClause)),void 0!==e.LimitClause&&(this.output.limit=this.visit(e.LimitClause)),void 0!==e.OffsetClause&&(this.output.offset=this.visit(e.OffsetClause)),void 0!==e.LabelClause&&(this.output.label=this.visit(e.LabelClause)),!this.hasGroupByExpression&&null!==(t=this.aggregationFunctionMap.SELECT)&&void 0!==t&&t.size)for(var n=0;n<this.output.select.length;n++){var r=this.output.select[n];this.paramUseAggregationFunction(r,"SELECT")||this.throwError(we.O6N.ADD_COL_TO_GROUP_BY_OR_AGG,{columnName:r.name})}return this.output}},{key:"SelectClause",value:function(e){return this.phase="SELECT",void 0!==e[SP.Asterisk]?this.selectAllColumn():this.visitClauseParameter(e.Expression,{getParameterName:function(e){return e.name},getValidParameter:NL})}},{key:"WhereClause",value:function(e){return this.phase="WHERE",[this.visit(e.Expression[0])]}},{key:"GroupByClause",value:function(e){this.phase="GROUP BY",this.isSelectUseAggregationFunction||this.throwError(we.O6N.CANNOT_GROUP_WITHOUT_AGG,{keyword:this.phase});for(var t=this.visitClauseParameter(e.Expression,{getParameterName:function(e){return e.name},getValidParameter:NL}),n=0;n<this.output.select.length;n++){var r=this.output.select[n];this.paramUseAggregationFunction(r,"SELECT")||this.haveSameParameter(r,t)||this.throwError(we.O6N.ADD_COL_TO_GROUP_BY_OR_AGG,{columnName:r.name})}return t}},{key:"PivotClause",value:function(e){return this.phase="PIVOT",this.isSelectUseAggregationFunction||this.throwError(we.O6N.CANNOT_PIVOT_WITHOUT_AGG,{keyword:this.phase}),this.visitClauseParameter(e.Expression,{getParameterName:function(e){return e.name},getValidParameter:NL})}},{key:"OrderByClause",value:function(e){this.phase="ORDER BY";var t=e.OrderByExpression;return this.visitClauseParameter(t,{getParameterName:function(e){return e.parameters[0].name},getValidParameter:OL})}},{key:"LimitClause",value:function(e){return this.phase="LIMIT",[this.visitNumberLiteral(e[SP.NumberLiteral][0],void 0!==e[SP.Minus])]}},{key:"OffsetClause",value:function(e){return this.phase="OFFSET",[this.visitNumberLiteral(e[SP.NumberLiteral][0],void 0!==e[SP.Minus])]}},{key:"LabelClause",value:function(e){this.phase="LABEL";var t=e.LabelExpression;return this.visitClauseParameter(t,{getParameterName:function(e){return e.name},getValidParameter:NL})}},{key:"OrderByExpression",value:function(e){var t,n,r,a=null;a=this.visit(e.Expression[0]),this.isSelectUseAggregationFunction&&(this.haveSameParameter(a,this.output.select)||this.throwError(we.O6N.COL_IN_ORDER_MUST_BE_IN_SELECT,{columnName:a.name}));var o=RL.Asc,i=null!==(t=null===(n=e[SP.Asc])||void 0===n||null===(r=n[0])||void 0===r?void 0:r.image)&&void 0!==t?t:"asc";return void 0!==e[SP.Desc]&&(o=RL.Desc,i=e[SP.Desc][0].image),{type:1,name:a.name+" "+i,operator:o,parameters:[a]}}},{key:"LabelExpression",value:function(e){var t=this.visit(e.Expression[0]),n=this.visitStringLiteral(e[SP.StringLiteral][0]),r=this.output.select;return 1===r[0].type&&r[0].operator===RL.SelectAllColumn||this.haveSameParameter(t,r)||this.throwError(we.O6N.COL_IN_LABEL_MUST_BE_IN_SELECT,{columnName:t.name}),{type:1,name:n.name,operator:RL.Label,parameters:[t,n]}}},{key:"Expression",value:function(e){return this.visitBinaryOp(e,SP.Or)}},{key:"AndExpression",value:function(e){return this.visitBinaryOp(e,SP.And)}},{key:"IsExpression",value:function(e){var t=this.visit(e.ComparisonExpression);if(void 0!==e[SP.Is]&&void 0!==e[SP.NullLiteral]){var n={type:2,name:e[SP.NullLiteral][0].image,constantType:6,value:null};void 0!==e[SP.Not]&&(n={type:1,name:e[SP.Not][0].image+" "+n.name,operator:RL.Not,parameters:[n]}),t={type:1,name:t.name+" "+e[SP.Is][0].image+" "+n.name,operator:RL.Is,parameters:[t,n]}}return t}},{key:"ComparisonExpression",value:function(e){return this.visitBinaryOp(e,SP.ComparisonOperator)}},{key:"AdditionAndSubtractionExpression",value:function(e){return this.visitBinaryOp(e,SP.AdditionAndSubtraction)}},{key:"MultiplicationAndDivisionAndModuloExpression",value:function(e){return this.visitBinaryOp(e,SP.MultiplicationAndDivisionAndModulo)}},{key:"NotExpression",value:function(e){var t=null,n=e.Literal;Array.isArray(n)&&(t=this.visit(n));var r=e.GroupExpression;Array.isArray(r)&&(t=this.visit(r));var a=e.Function;Array.isArray(a)&&(t=this.visit(a));var o=e[SP.Identifier];if(Array.isArray(o)&&1===o.length&&(t=this.visitColumn(o[0])),null===t)throw new Error;var i=e[SP.Not];return Array.isArray(i)&&(t={type:1,name:i[0].image+t.name,operator:RL.Not,parameters:[t]}),t}},{key:"GroupExpression",value:function(e){var t=this.visit(e.Expression);return{type:1,name:"("+t.name+")",operator:RL.Group,parameters:[t]}}},{key:"Function",value:function(e){var t=e[SP.Identifier][0].image,n=t.toUpperCase();bL.includes(n)||this.throwError(we.O6N.FUNCTION_NO_SUPPORT,{functionName:t});var r=[],a=0,o="";if(Array.isArray(e.argument1)){var i=this.visit(e.argument1[0]);r.push(i),o+=i.name,a++}if(Array.isArray(e.restArguments)){a+=e.restArguments.length;for(var u=0;u<e.restArguments.length;u++){var s=this.visit(e.restArguments[u]);r.push(s),o+=", "+s.name}}var l=t+"("+o+")";if(TL.includes(n)){var c=NL(r[0]);1===a&&0===c.type||this.throwError(we.O6N.AGG_CAN_ONLY_TAKE_A_COLUMN_AS_AN_ARGUMENT,{functionName:t,parameterName:o});var h=JL[this.phase];void 0!==h&&this.throwError(h,{keyword:this.phase,functionName:t}),"ORDER BY"===this.phase&&this.hasPivotExpression&&this.throwError(we.O6N.NO_AGG_IN_ORDER_WHEN_PIVOT,{functionName:t}),n!==RL.Avg&&n!==RL.Sum||this.appendToColumnDataTypeAssert(c.colIndex,this.avgAndSumParamAssert(l))}if(AL.includes(n)){var f=KL[n];a!==f.count&&this.throwError(f.countError,{scalarFunctionName:t});var d=NL(r[0]);f.check(d)||this.throwError(f.typeError,{scalarFunctionName:t}),0===d.type&&this.appendToColumnDataTypeAssert(d.colIndex,this.scalarParamAssert(l,f.typeError))}var v={type:1,name:l,operator:n,parameters:r};if(TL.includes(n)){var g=this.aggregationFunctionMap[this.phase]||new Set;g.add(v),this.aggregationFunctionMap[this.phase]=g}return v}},{key:"Literal",value:function(e){return void 0!==e[SP.NumberLiteral]?this.visitNumberLiteral(e[SP.NumberLiteral][0],void 0!==e[SP.Minus]):void 0!==e[SP.StringLiteral]?this.visitStringLiteral(e[SP.StringLiteral][0]):void 0!==e[SP.BooleanLiteral]?this.visitBooleanLiteral(e[SP.BooleanLiteral][0]):void 0!==e[SP.DateLiteral]?this.visitDateLiteral(e[SP.DateLiteral][0]):void 0!==e[SP.DateTimeLiteral]?this.visitDateTimeLiteral(e[SP.DateTimeLiteral][0]):this.visitTimeOfDay(e[SP.TimeOfDayLiteral][0])}},{key:"visitColumn",value:function(e){var t,n=e.image;n.startsWith("`")&&n.endsWith("`")&&(n=n.slice(1,-1));var r=null!==(t=this.referencedColumns[n])&&void 0!==t?t:-1;if(-1!==r||0!==this.options.refType||zL.test(n)){if(-1===r&&1===this.options.refType){var a=n.match(GL);null!==a&&(r=Number(a[1])-1)}}else((r=(0,we.pen)(n))<this.options.colFrom||r>=this.options.colFrom+this.options.colCount)&&(r=-1),r-=this.options.colFrom;return(Number.isNaN(r)||r<0)&&this.throwError(we.O6N.NO_COLUM,{columnName:n}),this.referencedColumns[n]=r,{type:0,name:n,colIndex:r}}},{key:"visitBinaryOp",value:function(e,t){var n=this.visit(e.lhs);if(void 0===e.rhs)return n;for(var r=0;r<e.rhs.length;r++){var a=this.getValidBinaryOperator(e[t][r].tokenType.name);0===n.type&&qL[a]&&this.appendToColumnDataTypeAssert(n.colIndex,this.binaryOpParamAssert(qL[a],e[t][r].image));var o=a===RL.And||a===RL.Or,i=NL(n);!o||1===i.type&&FL.includes(i.operator)||this.throwError($L[a]);var u=this.visit(e.rhs[r]);0===u.type&&qL[a]&&this.appendToColumnDataTypeAssert(u.colIndex,this.binaryOpParamAssert(qL[a],e[t][r].image));var s=NL(u);!o||1===s.type&&FL.includes(s.operator)||this.throwError($L[a]),"WHERE"!==this.phase&&FL.includes(a)&&this.throwError(we.O6N.LOGICAL_OPERATOR_ONLY_IN_WHERE),(1===i.type&&TL.includes(i.operator)||1===s.type&&TL.includes(s.operator))&&this.throwError(we.O6N.AGG_ARE_INCALCULABLE),n={type:1,name:n.name+e[t][r].image+u.name,operator:a,parameters:[n,u]}}return n}},{key:"appendToColumnDataTypeAssert",value:function(e,t){var n=this.columnDataTypeAssert[e]||[];n.push(t),this.columnDataTypeAssert[e]=n}},{key:"visitClauseParameter",value:function(e,t){for(var n=[],r=new Set,a=[],o=0;o<e.length;o++){var i=this.visit(e[o]),u=t.getValidParameter(i),s=t.getParameterName(i);this.haveSameParameter(u,a)&&this.throwError(we.O6N.COLUMN_ONLY_ONCE,{keyword:s}),r.add(s),n.push(i),a.push(u)}if("PIVOT"===this.phase){var l,c=_n(this.aggregationFunctionMap.SELECT.values());try{for(c.s();!(l=c.n()).done;){var h=l.value.parameters[0].name;r.has(h)&&this.throwError(we.O6N.AGG_IN_SELECT_NO_PIVOT,{columnName:h})}}catch(e){c.e(e)}finally{c.f()}}return n}},{key:"paramUseAggregationFunction",value:function(e,t){var n,r=this;return 1===e.type&&(!(null===(n=this.aggregationFunctionMap[t])||void 0===n||!n.has(e))||null!==e.parameters&&e.parameters.some((function(e){return r.paramUseAggregationFunction(e,t)})))}},{key:"haveSameParameter",value:function(e,t){for(var n=0;n<t.length;n++){var r=t[n];if(this.isSameParameter(e,r))return!0}return!1}},{key:"isSameParameter",value:function(e,t){var n=this;if(e.type!==t.type)return!1;switch(e.type){case 0:if(e.colIndex!==t.colIndex)return!1;break;case 2:if(e.constantType!==t.constantType)return!1;if(e.value instanceof Date&&e.value.getTime()!==t.value.getTime())return!1;if(e.value!==t.value)return!1;break;case 1:return e.operator===t.operator&&(null===e.parameters&&null===t.parameters||null!==e.parameters&&null!==t.parameters&&e.parameters.length===t.parameters.length&&e.parameters.every((function(e,r){return n.isSameParameter(e,t.parameters[r])})))}return!0}},{key:"getValidBinaryOperator",value:function(e){return e===SP.Asterisk?RL.Multiply:e}},{key:"selectAllColumn",value:function(){for(var e=this.options.colFrom+this.options.colCount-1,t=this.options.colFrom;t<=e;t++){var n=void 0,r=t;0===this.options.refType?(n=(0,we.hdC)(t),r-=this.options.colFrom):n="Col"+(t+1),this.referencedColumns[n]=r}return[{type:1,name:"*",operator:RL.SelectAllColumn,parameters:null}]}},{key:"visitNumberLiteral",value:function(e,t){return{type:2,name:t?"-"+e.image:e.image,constantType:0,value:Number(e.image)*(t?-1:1)}}},{key:"visitStringLiteral",value:function(e){var t=e.image;return t.startsWith("`")&&t.endsWith("`")?this.visitColumn(e):(t=t.slice(1,-1),{type:2,name:e.image,constantType:2,value:t})}},{key:"visitBooleanLiteral",value:function(e){var t="TRUE"===e.image.toUpperCase();return{type:2,name:e.image,constantType:1,value:t}}},{key:"visitDateLiteral",value:function(e){var t,n,r,a=e.image,o=a.match(/date\s+'(\d+\.?\d*)'/i);if(o&&o[1]){var i=ke.SheetDate.fromNumber(Number(o[1])).getUTCDate();return i&&Number.isFinite(i.getTime())||this.throwError(we.O6N.DATE_LITERAL_FORMATTER_ERROR),{type:2,name:a,constantType:3,value:i}}var u=a.match(HL),s=null!==(t=u&&(null!==(n=u[2])&&void 0!==n?n:u[3]))&&void 0!==t?t:"";""===s&&this.throwError(we.O6N.DATE_LITERAL_FORMATTER_ERROR);var l=null===(r=ke.SheetDate.fromString(s+" 00:00:00"))||void 0===r?void 0:r.getUTCDate();return l&&Number.isFinite(l.getTime())||this.throwError(we.O6N.DATE_LITERAL_FORMATTER_ERROR),{type:2,name:a,constantType:3,value:l}}},{key:"visitDateTimeLiteral",value:function(e){var t,n,r,a=e.image,o=a.match(/datetime\s+'(\d+\.?\d*)'/i);if(o&&o[1]){var i=ke.SheetDate.fromNumber(Number(o[1])).getUTCDate();return i&&Number.isFinite(i.getTime())||this.throwError(we.O6N.DATETIME_LITERAL_FORMATTER_ERROR),{type:2,name:a,constantType:4,value:i}}var u=a.match(WL),s=null!==(t=u&&(null!==(n=u[2])&&void 0!==n?n:u[3]))&&void 0!==t?t:"";""===s&&this.throwError(we.O6N.DATETIME_LITERAL_FORMATTER_ERROR);var l=null===(r=ke.SheetDate.fromString(s))||void 0===r?void 0:r.getUTCDate();return l&&Number.isFinite(l.getTime())||this.throwError(we.O6N.DATETIME_LITERAL_FORMATTER_ERROR),{type:2,name:a,constantType:4,value:l}}},{key:"visitTimeOfDay",value:function(e){var t,n,r,a=e.image,o=a.match(jL),i=null!==(t=o&&(null!==(n=o[2])&&void 0!==n?n:o[3]))&&void 0!==t?t:"";""===i&&this.throwError(we.O6N.TIMEOFDAY_LITERAL_FORMATTER_ERROR);var u=null===(r=ke.SheetDate.fromString(UL+" "+i))||void 0===r?void 0:r.getUTCDate();return u&&Number.isFinite(u.getTime())||this.throwError(we.O6N.TIMEOFDAY_LITERAL_FORMATTER_ERROR),{type:2,name:a,constantType:5,value:u}}},{key:"throwError",value:function(e,t){throw new mP(e,this.errorMessage(e),t)}},{key:"errorMessage",value:function(e){return"[Sheet Query Formula Error]: "+e}},{key:"isSelectUseAggregationFunction",get:function(){var e;return!(null===(e=this.aggregationFunctionMap.SELECT)||void 0===e||!e.size)}}]),t}(e)}(e.getBaseCstVisitorConstructor());LL=new t}return LL}function QL(e,t){var n=dL(e);if(Array.isArray(n.errors)&&0!==n.errors.length)return{error:new mP(we.O6N.PARSE_ERROR,n.errors[0].message)};var r=(null===vL&&(vL=new SL),vL),a=r.parse(n.tokens);if(Array.isArray(r.errors)&&0!==r.errors.length)return{error:new mP(we.O6N.PARSE_ERROR,r.errors[0].message)};var o=XL(r);try{return{result:o.visitTree(a,t),columnDataTypeAssert:o.getColumnDataTypeAssert(),referencedColumns:o.getReferencedColumns()}}catch(e){return{error:e}}}function eB(e,t){if(!t)return null;switch(e){case RL.Year:return t.getUTCFullYear();case RL.Month:return t.getUTCMonth()+1;case RL.Day:return t.getUTCDate()}return null}function tB(e,t,n){if(null===t||null===n)return null;switch(e){case RL.Plus:return t+n;case RL.Minus:return t-n;case RL.Multiply:return t*n;case RL.Divide:return t/n;case RL.Modulo:return t%n}return null}var nB=function(){function e(){(0,y.Z)(this,e)}return(0,C.Z)(e,[{key:"toArray",value:function(e){for(var t=[],n=0;n<this.size;n++)(null==e?void 0:e.has(n))||t.push(this.nth(n));return t}}]),e}(),rB=function(e){function t(e,n){var r;return(0,y.Z)(this,t),(r=(0,d.Z)(this,(0,v.Z)(t).call(this))).value=e,r.size=n,r}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"nth",value:function(e){return this.value}}]),t}(nB),aB=function(e){function t(e){var n;return(0,y.Z)(this,t),(n=(0,d.Z)(this,(0,v.Z)(t).call(this))).value=e,n.size=n.value.length,n}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"nth",value:function(e){var t;return null!==(t=this.value[e])&&void 0!==t?t:null}}]),t}(nB),oB=function(e){function t(e,n,r){var a;return(0,y.Z)(this,t),(a=(0,d.Z)(this,(0,v.Z)(t).call(this))).op=e,a.left=n,a.right=r,a.size=n.size,a}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"nth",value:function(e){return tB(this.op,this.left.nth(e),this.right.nth(e))}}]),t}(nB),iB=function(e){function t(e,n){var r;return(0,y.Z)(this,t),(r=(0,d.Z)(this,(0,v.Z)(t).call(this))).op=e,r.arg=n,r.size=r.arg.size,r}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"nth",value:function(e){var t;return null!==(t=eB(this.op,this.arg.nth(e)))&&void 0!==t?t:null}}]),t}(nB);function uB(e,t,n,r){if(null===t||null===n)return e===RL.NotEqual?t!==n:t===n;switch(r&&(t instanceof Date&&(t=ke.SheetDate.from({year:t.getFullYear(),month:t.getMonth()+1,date:t.getDate()}).getUTCDate()),n instanceof Date&&(n=ke.SheetDate.from({year:n.getFullYear(),month:n.getMonth()+1,date:n.getDate()}).getUTCDate())),e!==RL.Like&&(t instanceof Date&&(t=t.getTime()),n instanceof Date&&(n=n.getTime())),e){case RL.GreaterThan:return t>n;case RL.LessThan:return t<n;case RL.GreaterThanEqual:return t>=n;case RL.LessThanEqual:return t<=n;case RL.Equal:return t===n;case RL.NotEqual:return t!==n;case RL.Like:return function(e,t){e=sB(e);var n=(t=sB(t)).replace(/~|\?|\*/g,"~$1").replace(/%/g,"*").replace(/_/g,"?");return(0,Mt.wildcardToFastRegExp)(n).test(e)}(t,n)}return!1}function sB(e){return"string"==typeof e?e:null==e?"":e.toString()}var lB=function e(){(0,y.Z)(this,e)},cB=function(e){function t(e,n,r){var a;return(0,y.Z)(this,t),(a=(0,d.Z)(this,(0,v.Z)(t).call(this))).op=e,a.left=n,a.right=r,a}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"calc",value:function(e){var t=this.left.calc(e),n=this.right.calc(e);return tB(this.op,t,n)}}]),t}(lB),hB=function(e){function t(e,n){var r;return(0,y.Z)(this,t),(r=(0,d.Z)(this,(0,v.Z)(t).call(this))).op=e,r.value=n,r}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"calc",value:function(e){return eB(this.op,this.value.calc(e))}}]),t}(lB),fB=function(e){function t(e){var n;return(0,y.Z)(this,t),(n=(0,d.Z)(this,(0,v.Z)(t).call(this))).value=e,n}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"calc",value:function(e){var t;return 0===this.value.type?null!==(t=e[this.value.colIndex])&&void 0!==t?t:null:this.value.value}}]),t}(lB);function dB(e,t){if(1!==e.type)return new fB(e);if(AL.includes(e.operator))return new hB(e.operator,dB(NL(e.parameters[0])));if(!IL.includes(e.operator))throw Error("where condition is error, please recheck your input");var n=NL(e.parameters[0]),r=NL(e.parameters[1]);return new cB(e.operator,dB(n),dB(r))}var vB=function e(){(0,y.Z)(this,e)},gB=function(e){function t(e,n,r){var a;return(0,y.Z)(this,t),(a=(0,d.Z)(this,(0,v.Z)(t).call(this))).op=e,a.left=n,a.right=r,a}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"exec",value:function(e){var t=2===this.left.type&&3===this.left.constantType||2===this.right.type&&3===this.right.constantType;return uB(this.op,dB(this.left).calc(e),dB(this.right).calc(e),t)}}]),t}(vB),mB=function(e){function t(e,n,r){var a;return(0,y.Z)(this,t),(a=(0,d.Z)(this,(0,v.Z)(t).call(this))).op=e,a.left=n,a.right=r,a}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"exec",value:function(e){return function(e,t,n,r){switch(e){case RL.And:return t.exec(r)&&n.exec(r);case RL.Or:return t.exec(r)||n.exec(r)}return!1}(this.op,this.left,this.right,e)}}]),t}(vB);function pB(e,t){if(!e)return null;var n=[];if(1===e.type){var r=e.parameters;if(!r||0===r.length)return null;r.forEach((function(e){var r=pB(NL(e),t);r&&n.push(r)}))}if(2===e.type){var a=t.rowCount;return new rB(e.value,a)}if(0===e.type)return new aB(t.valueMatrix[e.colIndex]);if(1===e.type){var o=e.operator;if(IL.includes(o)){var i=n[0],u=n[1];return(null==i?void 0:i.size)!==(null==u?void 0:u.size)?null:new oB(o,i,u)}if(AL.includes(o))return new iB(o,n[0])}return null}function yB(e,t){var n={},r=e.select,a=e.groupBy,o=e.pivot,i=e.orderBy,u=function(e){if(!n[e.name]&&1===e.type){var r=pB(NL(e),t);r&&(n[e.name]=r)}};return null!=r&&r.forEach(u),null!=a&&a.forEach(u),null!=o&&o.forEach(u),null!=i&&i.forEach((function(e){return u(e.parameters[0])})),n}function CB(e){var t=NL(e.parameters[0]),n=NL(e.parameters[1]);if(e.operator===RL.Is)return function(e,t){return 1===t.type&&t.operator===RL.Not?new gB(RL.NotEqual,e,t.parameters[0]):new gB(RL.Equal,e,t)}(t,n);if([RL.And,RL.Or].includes(e.operator)){var r=CB(t),a=CB(n);return new mB(e.operator,r,a)}return new gB(e.operator,t,n)}var _B=function(){function e(){(0,y.Z)(this,e)}return(0,C.Z)(e,null,[{key:"pivotViewGeneratorFromDataSource",value:function(t,n){var r=e.pivotCacheGenerator("cache",t),a=e.queryCubeGenerator(r,n);return e.pivotViewGenerator(r,a,n)}},{key:"pivotCacheGenerator",value:function(e,t){var n=(0,Ot._R)(t,{});return new Ot.SL(e,n,t.slice(1))}},{key:"queryCubeGenerator",value:function(e,t){var n=(0,kt.Mp)(t),r=(0,kt.J0)(t);return new Ot.mx(e,n,r)}},{key:"pivotViewGenerator",value:function(e,t,n){var r=new kt.bY,a=new kt.pq({service:r,getName:function(){return""}},"");a.fromJSON(n),r.setCacheForService(a.getCacheName(),e);var o=new kt.b$;(0,kt.NK)(t,a,o,{errorValueShowAs:"",emptyValueShowAs:"Error"});var i=(0,kt.o_)(e,a);return o.setFormatMap(i),delete a._host,o.toJSON()}}]),e}(),RB=(nt={},(0,l.Z)(nt,RL.Avg,Ot.wl.average),(0,l.Z)(nt,RL.Count,Ot.wl.count),(0,l.Z)(nt,RL.Max,Ot.wl.max),(0,l.Z)(nt,RL.Min,Ot.wl.min),(0,l.Z)(nt,RL.Sum,Ot.wl.sum),nt);function wB(e,t,n,r){var a=function(e,t){var n=e.select,r=e.groupBy,a=e.pivot,o=[],i=[],u=[],s=new Set;return null!=r&&r.forEach((function(e){if(0===(e=NL(e)).type||1===e.type&&t[e.name]){var n=ZL(e.name);i.push({cacheFieldId:n,sourceName:n,fieldName:n,fieldType:kt.Tj.dim}),s.add(n)}})),null!=n&&n.forEach((function(e){var t=ZL((e=NL(e)).name);1===e.type&&TL.includes(e.operator)?o.push({cacheFieldId:ZL(e.parameters[0].name),sourceName:ZL(e.parameters[0].name),fieldName:t,fieldType:kt.Tj.measure,summaryType:RB[e.operator]}):s.has(t)||i.push({cacheFieldId:t,sourceName:t,fieldName:t,fieldType:kt.Tj.dim})})),null!=a&&a.forEach((function(e){var t=ZL((e=NL(e)).name);u.push({cacheFieldId:t,sourceName:t,fieldName:t,fieldType:kt.Tj.dim})})),{dim:{page:[],hide:[],row:i,col:u},measure:o,cacheName:"",valuePosition:1,valueIndex:1,hiddenTotalInfo:{row:!0,col:!0,fieldDefault:!0},collapseInfo:{},repeatLabelInfo:{}}}(e,n),o={data:VL(t,n,r),formatMap:{}};return{fieldsModel:a,viewDataModel:_B.pivotViewGeneratorFromDataSource(o.data,a)}}function kB(e,t){var n={0:function(e){return Number(e)},2:function(e){return Number(e)},4:function(e){return Boolean(e)},3:function(e){return null},1:function(e){return e}};return e.map((function(e,r){return n[t[r]](e)}))}function SB(e,t,n){var r=e.row,a=e.col,o=e.value,i={titles:{},values:[[]]},u=!!t.dim.row.length,s=!!t.dim.col.length,l=a.pivotInfos;if(!u&&s){var c=r.pivotInfos.map((function(e){return e.valueFieldName})),h=function(e){var t=l[e];t.fieldName.forEach((function(e,r){var a=DL(e);if(n[a]){var o,i,u=Number(t.items[r]);isNaN(u)||(t.items[r]=null!==(o=null===(i=n[a])||void 0===i?void 0:i.getDisplayText(u))&&void 0!==o?o:"")}}))};for(var f in l)h(f);for(var d in c){var v,g=null!==(v=c[d])&&void 0!==v?v:t.measure[0].fieldName;for(var m in i.titles[g]||(i.titles[g]=[]),l){var p=(l[m].items.join(" ")+" "+g).trimLeft(),y=Number(d)*a.range.colCount+Number(m);i.titles[g].push({value:p,colIndex:y}),i.values[0][y]=o.dataTable[Number(d)][Number(m)].value}}return i}var C=r.range.colCount;for(var _ in l){var R,w=l[_],k=w.items,S=w.valueFieldName,E=(k.join(" ")+" "+(null!==(R=S)&&void 0!==R?R:"")).trimLeft(),T=C+Number(_);if(S)i.titles[S]||(i.titles[S]=[]),i.titles[S].push({value:E,colIndex:T});else{var A=t.measure[0].fieldName;i.titles[A]||(i.titles[A]=[]),i.titles[A].push({value:E,colIndex:T})}}return i.values=function(e){var t=e.dataTable,n=[];for(var r in t){var a=Number(r);for(var o in n[a]||(n[a]=[]),t[r]){var i,u=Number(o);isNaN(u)||(n[a][u]=null!==(i=t[r][o].value)&&void 0!==i?i:null)}}return n}(o),i}function EB(e){var t=[];for(var n in e)Array.isArray(e[n])?e[n].forEach((function(e){var n=e.value,r=e.colIndex;t[r]=n})):t[e[n]]=n;return t}function TB(e,t,n){for(var r=function(e,t,n){var r=e.corner,a=e.row,o=e.col,i={titles:{},values:[]};if(!t.dim.row.length)return i;var u=o.range.rowCount-1,s=r.dataTable[u];for(var l in s){var c=s[l].value;c&&"string"==typeof c&&(i.titles[c]=Number(l))}for(var h=a.range.rowCount,f=a.range.colCount,d=0;d<h;d++){var v=a.pivotInfos[d],g=v.items,m=v.types;g.length===f&&i.values.push(kB(g,m))}return i}(e,t),a=SB(e,t,n),o=Object.assign(r.titles,a.titles),i=EB(o),u=[],s=0;s<a.values.length;s++){var l,c;u[s]=[].concat(null!==(l=r.values[s])&&void 0!==l?l:[],null!==(c=a.values[s])&&void 0!==c?c:[])}return{fieldNameColumnInfos:o,titles:i,valueMatrix:u}}function AB(e,t,n){for(var r=e[n-t];r<n;)r=e[r-t];return r}function IB(e,t,n,r){return e.sort((function(e,a){return function(e,t,n,r,a){for(var o=0,i=0;i<r.length;i++){if(r[i]){var u=r[i],s=u.index,l=u.ascending;if(0<=s){var c=void 0,h=void 0,f=n?e:s,d=n?s:e,v=n?t:s,g=n?s:t;a?(c=a[f][d],h=a[v][g]):(c=this.getCellToSortValue(f,d),h=this.getCellToSortValue(v,g)),o=fv(c,h,l)}}if(0!==o)break}return o}(e,a,t,n,r)}))}var bB=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"getCellToSortValue",value:function(e,t){return dv(this.getValue(e,t))}},{key:"_sortRange",value:function(e,t,n,r,a,o){try{return this.suspendEvent(),function(e,t,n,r,a,o,i,u){var s,l,c=o?r:a,h=o?t:n,f=[];for(s=0;s<c;s++)f[s]=h+s;var d=[];if(o)for(l=f.length-1;l>=0;l--){var v=f[l];(e._isRowFilterOut&&e._isRowFilterOut(v)||!e.getRowVisible(v))&&(f.splice(l,1),d.push({_index:l,_value:v}))}if(f=IB(f,o,i,u),o)for(l=d.length-1;l>=0;l--){var g=d[l];f.splice(g._index,0,g._value)}return f}(this,e,t,n,r,a,o,this.getCellValueCache(e,n,t,r))}catch(e){throw e}finally{(0,we.$1K)().clearPinyinCache(),this.resumeEvent()}}},{key:"getCellValueCache",value:function(e,t,n,r){for(var a=[],o=e;o<e+t;o++){a[o]=[];for(var i=n;i<n+r;i++)a[o][i]=this.getCellToSortValue(o,i)}return a}},{key:"iterSortedRangeToSwapNode",value:function(e,t,n,r,a,o){var i,u,s,l,c=this._getModel();o?(i=e,u=e+t,s=n,l=n+r):(i=n,u=n+r,s=e,l=e+t);for(var h,f=0,d=0,v=0,g=0,m=i;m<u;m++)if(m!==(h=AB(a,i,m))){o?(f=m,v=h):(d=m,g=h);for(var p=s;p<l;p++)o?(d=p,g=p):(f=p,v=p),c.swapNode(f,d,v,g)}}},{key:"iterSortedRangeToUpdateFormula",value:function(e,t,n,r,a,o){var i=this,u=[],s=new lv,l=this.getCalcEngine();return r.forEach((function(r,c){var h=r,f=c+n;if(f!==h){var d=u[u.length-1];(a?null==d?void 0:d.endRow:null==d?void 0:d.endCol)===h?a?d.endRow++:d.endCol++:u.push(a?new ui(h,h+1,e,t,o):new ui(e,t,h,h+1,o));for(var v=e;v<t;v++){var g=v,m=v;a?g=f:m=f;var p=i.getVar(g,m);if(p.isFormula()){var y=i._updateFmlSpaceWatch(p,g,m);s.set(g,m,l.formulaRefService.formulaRefPool.add({formula:y.formula,refMap:y.getRefMap()}))}}}})),[u,s]}},{key:"_updateFmlSpaceWatch",value:function(e,t,n){var r=e.getRef();return r.setRowFrom(t),r.setColFrom(n),this._getModel().setVar(t,n,e),e}}]),t}(vM);function FB(e,t,n){var r=[e[n],e[t]];e[t]=r[0],e[n]=r[1]}function MB(e,t,n){e.forEach((function(e){var r=[e[n],e[t]];e[t]=r[0],e[n]=r[1]}))}function VB(e,t){e.splice(t,1)}function NB(e,t){e.forEach((function(e){e.splice(t,1)}))}function OB(e,t,n,r){if(e.includes(void 0))throw Error("changeList value cannot be undefined");for(var a=0,o=e.length;a<o;a++)for(var i=e[a];a!==e[a];i=e[a])t?FB(n,i,e[i]):(MB(n,i,e[i]),r&&FB(r,i,e[i])),FB(e,a,i)}function xB(e,t){for(var n=t.fieldNameColumnInfos,r=t.valueMatrix,a=t.titles,o=function(e,t){var n,r,a=t.fieldNameColumnInfos,o=t.titles,i={};if(1===(null===(n=e[0])||void 0===n?void 0:n.type)&&(null===(r=e[0])||void 0===r?void 0:r.operator)===RL.SelectAllColumn){for(var u=0,s=0;u<o.length;u++)/^\$\$_(Col[0-9]*|[A-Z]+)_\$\$$/.exec(o[u])&&(i[o[u]]=s++);return i}for(var l=function(t,n){var r=ZL(NL(e[t]).name);a[r]&&Array.isArray(a[r])?a[r].forEach((function(e){var t=e.value;i[t]=n++})):i[r]=n++,h=n},c=0,h=0;c<e.length;c++)l(c,h);return i}(e,{fieldNameColumnInfos:n,titles:a}),i=[],u=0;u<a.length;u++){var s=o[a[u]];void 0!==s?i[s]=u:(NB(r,u),VB(a,u--))}return i}function ZB(e,t){OB(function(e,t){for(var n=t.titles,r=t.valueMatrix,a=e.map((function(e){var t=e=NL(e),r=t.parameters,a=t.operator;return{index:n.findIndex((function(e){return e===ZL(r[0].name)})),ascending:a===RL.Asc}})),o=new Array(r.length),i=0;i<r.length;i++)o[i]=i;return IB(o,!0,a,r)}(e,t),!0,t.valueMatrix)}function DB(e,t){var n=e.select,r=e.orderBy;return r&&ZB(r,t),n&&function(e,t){OB(xB(e,t),!1,t.valueMatrix,t.titles)}(n,t),t}function PB(e,t,n){var r,a=yB(t,n),o=function(e,t){if(e){for(var n=new Set,r=CB(NL(e[0])),a=function(e){var a=[];t.valueMatrix.forEach((function(t,n){a[n]=t[e]})),r.exec(a)||n.add(e)},o=0;o<t.rowCount;o++)a(o);return n}}(t.where,n),i=function(e){if(e&&e.length){var t={};return e.forEach((function(e){var n=e.parameters,r=ZL(n[0].name),a=n[1];t[r]=a.value})),t}}(t.label);if(function(e){var t=e.select,n=e.groupBy;if(null!=n&&n.length)return!0;if(null!=t&&t.length)for(var r=0;r<t.length;r++){var a=NL(t[r]);if(1===a.type&&TL.includes(a.operator))return!0}return!1}(t)){var u=wB(t,n,a,o);r=TB(u.viewDataModel,u.fieldsModel,n.formatterMap)}else r=function(e,t,n){var r=ML(e,t,n),a={};for(var o in e.referencedColumns)a[ZL(o)]=e.referencedColumns[o];return{valueMatrix:r,titles:EB(a),fieldNameColumnInfos:a}}(n,a,o);return r=DB(t,r),r=function(e,t,n){var r=n.valueMatrix.length,a=r,o=0;if(e){var i=e[0].value;i>=0&&i<r&&(a=i)}if(t){var u=t[0].value;u>=0&&u<=r?o=u:u>r&&(o=r)}return n.valueMatrix=n.valueMatrix.slice(o,a+o),n}(t.limit,t.offset,r),function(e,t,n,r){var a,o,i=e.titles,u=e.valueMatrix,s=t.refNameTitleMap,l=t.formatterMap,c=[];if(Object.keys(s).length>0){var h;c[0]=[];for(var f=Object.entries(null!==(h=n)&&void 0!==h?h:{}),d=0;d<i.length;d++){for(var v=i[d],g=0;g<f.length;g++){var m=(0,p.Z)(f[g],2),y=m[0],C=m[1];v.includes(y)&&(v=v.replace(y,C))}v=DL(v,s),c[0][d]=new ut.StringVar(v)}}for(var _=0;_<u.length;_++){var R=u[_];c.push(R.map((function(e,t){var n,r=Lg(e);if(null===r)return ut.NULL_VAR;var a=DL(i[t]);return!(null!=r&&r.isNull())&&l[a]&&null!=r&&r.setSpecialInfo({customData:{autoFormat:null===(n=l[a])||void 0===n?void 0:n.getFormatCode()}}),r})))}return 0===c.length?gP(we.O6N.NO_QUERY_OUTPUT,""):(null!=r&&r.info&&null!==(a=c[0][0].getSpecialInfo())&&void 0!==a&&a.customData&&(r.info.customData=null===(o=c[0][0].getSpecialInfo())||void 0===o?void 0:o.customData),new Ru(c))}(r,n,i,e)}var LB=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e,t,n,r){var a=r.getValue(),o=t.isRef()?0:1,i=QL(n.getValue(),{refType:o,colFrom:t.isRef()?t.getRef().colFrom():0,colCount:t.colCount()}),u=i.error,s=i.result,l=i.columnDataTypeAssert,c=i.referencedColumns;if(u)return gP(u.code,u.message,u.args);var h=yP(t,{rowFrom:0,columnDataTypeAssert:l,referencedColumns:c,headerCount:a,ctx:e});return h instanceof ut.ErrorVar?h:PB(e,s,{valueMatrix:h.dataMatrix,formatterMap:h.formatterMap,rowCount:h.rowCount,referencedColumns:c,refNameTitleMap:h.refNameTitleMap})}}]),t}(gC("QUERY",1,2,0,aC|hC,[iw.MATRIX_AND_SHEET_REF,{type:nC,default:new ut.StringVar("")},{type:tC|eC,default:ut.NULL_VAR}]));LB=Gi([cc("QUERY")],LB);var BB=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),t}(gC("",0,0,0,nC,[]));function UB(e,t){if(!function(e){return!(/\(\?<=.*?\)/g.test(e)&&!/\[.*?(\?<=.*?)\]/g.test(e)||/\(\?<!.*?\)/g.test(e)&&!/\[.*?(\?<!.*?)\]/g.test(e))}(e))return{regExp:null,error:we.d$b[we.O6N.REF_INVALID_REGULAR_EXPRESSION]()};try{var n=t?new RegExp(e,"ug"):new RegExp(e,"u");return rn()(n)?{regExp:n,error:null}:{regExp:null,error:we.d$b[we.O6N.REF_UNSAFE_REGULAR_EXPRESSION]()}}catch(e){return{regExp:null,error:we.d$b[we.O6N.REF_INVALID_REGULAR_EXPRESSION]()}}}var HB=function(e){function t(){var e;return(0,y.Z)(this,t),(e=(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))).name="REGEXMATCH",e.operands=2,e.resultType=nC,e.paramsDesc=[{type:nC},{type:nC}],e}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e,t,n){var r=UB(n.getValue(),!1);if(r.error)return r.error;var a=r.regExp.test(t.getValue());return new ut.BooleanVar(a)}}]),t}(BB);var WB=function(e){function t(){var e;return(0,y.Z)(this,t),(e=(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))).name="REGEXEXTRACT",e.operands=2,e.resultType=nC|iC,e.paramsDesc=[{type:nC|iC},{type:nC}],e}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e,t,n){var r=UB(n.getValue(),!1);if(r.error)return r.error;var a=t.isCollection()?function(e,t){var n=t.getVar(e);if(n.isPrimitive()){var r=n.toStringVar(e.service);return r.isNull()?n.isError()?n:ut.VALUE_ERR_VAR:r}return ut.VALUE_ERR_VAR}(e,t):t;if(a.isError())return a;var o=a.getValue().match(r.regExp);if(!o||Array.isArray(o)&&o.length<=0)return we.d$b[we.O6N.NA_REGULAR_EXPRESSION_NO_MATCH]();var i=o.length;if(i>1){for(var u=[],s=1;s<i;s++)u.push(new ut.StringVar(o[s]||""));return new Ru([u])}return new ut.StringVar(o[0])}}]),t}(BB);WB=Gi([cc("REGEXEXTRACT")],WB);var jB=function(e){function t(){var e;return(0,y.Z)(this,t),(e=(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))).name="REGEXREPLACE",e.operands=3,e.resultType=nC,e.paramsDesc=[{type:nC},{type:nC},{type:nC}],e}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e,t,n,r){var a=UB(n.getValue(),!0);if(a.error)return a.error;var o=t.getValue(),i=r.getValue(),u=o.replace(a.regExp,i);return new ut.StringVar(u)}}]),t}(BB);function zB(e,t){var n=e.getValue(),r=0|t.getValue();return{num:(0,Mt.round)(n,r),dec:Math.max(0,r)}}var GB,JB=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e,t,n,r){var a;if(n.getValue()>127)return pR(this.name,2,n.getValue(),127);var o=null===(a=e.service.spread)||void 0===a?void 0:a.formatterService;if(!o)return ut.VALUE_ERR_VAR;var i=zB(t,n),u=i.num,s=i.dec,l=o.getFormatter(um(s,!r.getValue())[1]),c=o.getFormattedText(l,u);return new ut.StringVar(c)}}]),t}(gC("FIXED",1,2,0,nC,[{type:tC,default:new ut.NumberVar(0)},{type:tC,default:new ut.NumberVar(2)},{type:rC,default:ut.BOOLEAN_VAR_MAP[ut.BooleanConstant.FALSE]}])),qB=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e,t,n){var r,a;if(n.getValue()>127)return pR(this.name,2,n.getValue(),127);var o=null===(r=e.service.spread)||void 0===r?void 0:r.formatterService;if(!o)return ut.VALUE_ERR_VAR;var i="USD";if(null!==(a=e.service.spread)&&void 0!==a&&a.locale){var u,s=(0,we.sBS)(null===(u=e.service.spread)||void 0===u?void 0:u.locale);s&&(i=s[0])}var l=zB(t,n),c=l.num,h=um(l.dec,!0,i)[1],f=o.getFormatter("".concat(h,";(").concat(h,")")),d=o.getFormattedText(f,c);return new ut.StringVar(d)}}]),t}(gC("DOLLAR",1,1,0,nC,[{type:tC,default:new ut.NumberVar(0)},{type:tC,default:new ut.NumberVar(2)}])),$B=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e,t){var n=t.getValue().toLowerCase().replace(/(^|\b|\W|\d|_)[a-z]/g,(function(e){return e.toUpperCase()}));return new ut.StringVar(n)}}]),t}(gC("PROPER",1,0,0,nC,[{type:nC,default:new ut.StringVar("")}])),YB=function(e){function t(){var e;return(0,y.Z)(this,t),(e=(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))).name="RANK.EQ",e}return(0,g.Z)(t,e),t}(tD),KB=function(e){function t(){var e;return(0,y.Z)(this,t),(e=(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))).name="RANK.AVG",e}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e,t,n,r){if(!Fu(n)&&!Au(n))return wR(this.name,2);var a=QZ(e,n,t.getValue(),!1===r.getValue(),!0);return a.err||(a.exist?new ut.NumberVar(a.rankNum):WR(this.name))}}]),t}(tD);function XB(e,t){var n=e.ref,r=t.getRef();return n.sheet()===r.sheet()&&n.rowFrom()===r.rowFrom()&&n.colFrom()===r.colFrom()}!function(e){e.ADDRESS="ADDRESS",e.COL="COL",e.CONTENTS="CONTENTS",e.FORMAT="FORMAT",e.PREFIX="PREFIX",e.ROW="ROW",e.TYPE="TYPE",e.WIDTH="WIDTH"}(GB||(GB={}));var QB=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e,t,n){if(n&&!Fu(n))return ut.VALUE_ERR_VAR;var r=n?n.getRef():e.ref,a=r.sheet();if(!a)return ut.VALUE_ERR_VAR;var o=t.getValue().toUpperCase(),i=r.rowFrom(),u=r.colFrom();switch(o){case GB.ADDRESS:var s="".concat(r.sheetNameToString({ref:e.ref}),"$").concat((0,we.hdC)(u),"$").concat(i+1);return new ut.StringVar(s);case GB.COL:return new ut.NumberVar(u+1);case GB.CONTENTS:return!n||XB(e,n)?ut.CIRCULAR_DEPENDENCY_ERR_VAR:n.nth(0,e);case GB.FORMAT:var l=function(e,t,n,r,a){return t?function(e,t){var n=t.getRef().sheet();if(!n)return null;var r=t.getRef().rowFrom(),a=t.getRef().colFrom();return XB(e,t)?n.getCellFormatter(r,a):n.getActualFormatter(r,a,e)}(e,t):n.getCellFormatter(r,a)}(e,n,a,i,u);return l?function(e){if((0,Se.isGeneralFormatter)(e)||(0,Se.isTextFormatter)(e))return new ut.StringVar("G");var t=e.getFormatCode(),n=function(e){var t=e.split(";")[0].replace(/_\(/g,"");return/\(/.test(t)}(t)?"()":"";if((0,Se.isDigitalFormatter)(e)){var r=e.getFormatters()[0],a=(0,Se.getDigitalFormatterDecimalState)(r).decimalSize;if(/^0(\.0+)?%$/.test(t))return new ut.StringVar("P"+a+n);if(/^0(\.0+)*E\+00$/.test(t))return new ut.StringVar("S"+a+n);if(!/%|(E\+00)/.test(t))return(0,we.MFi)().test(t)?new ut.StringVar("C"+a+n):/#,##/.test(t)?new ut.StringVar(","+a+n):new ut.StringVar("F"+a+n)}return we.d$b[we.O6N.CELL_FORMAT_NO_MATCH]()}(l):new ut.StringVar("G");case GB.PREFIX:return function(e){return e===we.KqL.Left?new ut.StringVar("'"):e===we.KqL.Right?new ut.StringVar('"'):e===we.KqL.Center?new ut.StringVar("^"):new ut.StringVar("")}(a.getStyle(i,u)._hAlign);case GB.ROW:return new ut.NumberVar(i+1);case GB.TYPE:return!n||XB(e,n)?ut.CIRCULAR_DEPENDENCY_ERR_VAR:function(e,t){return t.isNull()?new ut.StringVar("b"):t.isString()?new ut.StringVar("l"):new ut.StringVar("v")}(0,n.nth(0,e));case GB.WIDTH:var c=a.getColumnWidth(u),h=a.defaults.colWidth,f=Math.round((c-5)/7),d=c===h;return new Ru([[new ut.NumberVar(f),new ut.BooleanVar(d)]]);default:return we.d$b[we.O6N.INVALID_CELL_INFO_TYPE]({funcName:this.name,num:1,errorValue:o,correctValue:'"'.concat(Object.keys(GB).join('", "'),'"')})}}}]),t}(gC("CELL",1,1,0,nC||tC||iC,[{type:nC},{type:iC}]));QB=Gi([cc("CELL")],QB);var eU=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e,t,n,r,a){var o=r.getValue(),i=a.getValue();t.isPrimitive()&&(t=new Ru([[t]])),n.isPrimitive()&&!n.isNull()&&(n=new Ru([[n]]));var u=GN(t,n,this.name,o);return u.error?u.error:u.type===ZN.SIMPLE?function(e,t,n,r,a,o){var i=hO(e,t,n,r,a,!1);if(i.error)return i.error;var u=i.knownYArray,s=i.weights,l=i.knownXArray;if(isNaN(s[0][0]))return we.d$b[we.O6N.TREND_POINT_NUM_UNENOUGHT]({funcName:r,expectedNum:2,receivedNum:1});var c=iO(s);if(!o)return new Ru(c);var h,f,d,v=YN(u),g=YN(l),m=u.length,p=uO(l,s),y=XN(u,p),C=KN(p,v,a);if(a){h=oO(m,2);var _=KN(l,g,!0);f=new ut.NumberVar(QN(y,_,h)),d=new ut.NumberVar(eO(y,g,_,h,m))}else{h=oO(m,1);var R=KN(l,0,!1);f=new ut.NumberVar(QN(y,R,h)),d=we.d$b[we.O6N.LINEST_NO_STATISTICAL_INFO]()}var w=new ut.NumberVar(tO(C,y)),k=h&&y?new ut.NumberVar(rO(C,y,h)):G_,S=new ut.NumberVar(nO(y,h));return c.push([f,d],[w,S],[k,new ut.NumberVar(h)],[new ut.NumberVar(C),new ut.NumberVar(y)]),new Ru(c)}(e,t,n,this.name,o,i):function(e,t,n,r,a,o){var i=fO(e,t,n,r,a,!1);if(i.error)return i.error;var u=i.knownYMatrix,s=i.weights,l=i.knownXMatrix,c=i.inverseMatrix,h=s[0].length,f=iO(s);if(!o)return new Ru(f);for(var d=[],v=u.flat(),g=YN(v),m=v.length,p=lO(l,s),y=XN(v,p),C=KN(p,g,a),_=h-1,R=c.length,w=oO(m,R),k=w?new ut.NumberVar(aO(C,_,y,w)):G_,S=new ut.NumberVar(tO(C,y)),E=new ut.NumberVar(nO(y,w)),T=we.d$b[we.O6N.LINEST_NO_STATISTICAL_INFO](),A=[k,new ut.NumberVar(w),T],I=[S,E,T],b=[new ut.NumberVar(C),new ut.NumberVar(y),T],F=R-1;F>=0;F--)w?d.push(new ut.NumberVar(Math.sqrt(y/w*c[F][F]))):d.push(new ut.NumberVar(0)),F<R-2&&(A.push(T),I.push(T),b.push(T));if(a){var M=d.shift();d.push(M)}else d.push(T);return f.push(d,I,A,b),new Ru(f)}(e,t,n,this.name,o,i)}}]),t}(gC("LINEST",1,3,0,iC,[{type:iC|oC},{type:iC|oC,default:ut.NULL_VAR},{type:rC,default:new ut.BooleanVar(!0)},{type:rC,default:new ut.BooleanVar(!1)}]));eU=Gi([cc("LINEST")],eU);var tU=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e,t,n,r,a){t.isPrimitive()&&(t=new Ru([[t]])),n.isPrimitive()&&!n.isNull()&&(n=new Ru([[n]]));var o=a.getValue();r.isNumber()&&(r=new Ru([[r]]));var i=GN(t,n,this.name,o,r);return i.error?i.error:i.type===ZN.SIMPLE?function(e,t,n,r,a,o){var i=hO(e,t,n,a,o,!1,r);if(i.error)return i.error;var u=i.newXArray,s=i.weights,l=i.newXRowCount,c=s[0][0];if(isNaN(c))return we.d$b[we.O6N.TREND_POINT_NUM_UNENOUGHT]({funcName:a,expectedNum:2,receivedNum:1});var h=uO(u,s,l);return new Ru(iO(h))}(e,t,n,r,this.name,o):function(e,t,n,r,a,o){var i=fO(e,t,n,a,o,!1,r);if(i.error)return i.error;var u=i.newXMatrix,s=i.weights,l=i.isYColCountEqualOne,c=iO(lO(u,s,!0));return l||(c=BN(c)),new Ru(c)}(e,t,n,r,this.name,o)}}]),t}(gC("TREND",1,3,0,iC,[{type:iC|oC},{type:iC|oC,default:ut.NULL_VAR},{type:iC|eC|tC,default:ut.NULL_VAR},{type:rC,default:new ut.BooleanVar(!0)}]));var nU=function(e){function t(){var e;return(0,y.Z)(this,t),(e=(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))).name="GROWTH",e}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e,t,n,r,a){t.isPrimitive()&&(t=new Ru([[t]])),n.isPrimitive()&&!n.isNull()&&(n=new Ru([[n]]));var o=a.getValue();r.isNumber()&&(r=new Ru([[r]]));var i=GN(t,n,this.name,o,r);return i.error?i.error:i.type===ZN.SIMPLE?function(e,t,n,r,a,o){var i=hO(e,t,n,a,o,!0,r);if(i.error)return i.error;var u=i.newXArray,s=i.weights,l=i.newXRowCount,c=s[0][0];if(isNaN(c))return we.d$b[we.O6N.TREND_POINT_NUM_UNENOUGHT]({funcName:a,expectedNum:2,receivedNum:1});var h=sO(u,s,l).predictResult;return new Ru(iO(h))}(e,t,n,r,this.name,o):function(e,t,n,r,a,o){var i=fO(e,t,n,a,o,!0,r);if(i.error)return i.error;var u=i.newXMatrix,s=i.weights,l=i.isYColCountEqualOne,c=iO(cO(u,s,!0).predictResult);return l||(c=BN(c)),new Ru(c)}(e,t,n,r,this.name,o)}}]),t}(tU=Gi([cc("TREND")],tU));nU=Gi([cc("GROWTH")],nU);var rU=function(e){function t(){var e;return(0,y.Z)(this,t),(e=(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))).name="LOGEST",e}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e,t,n,r,a){var o=r.getValue(),i=a.getValue();t.isPrimitive()&&(t=new Ru([[t]])),n.isPrimitive()&&!n.isNull()&&(n=new Ru([[n]]));var u=GN(t,n,this.name,o);return u.error?u.error:u.type===ZN.SIMPLE?function(e,t,n,r,a,o){var i=hO(e,t,n,r,a,!0);if(i.error)return i.error;var u=i.lnKnowYArray,s=i.weights,l=i.knownXArray;if(isNaN(s[0][0]))return we.d$b[we.O6N.TREND_POINT_NUM_UNENOUGHT]({funcName:r,expectedNum:2,receivedNum:1});var c=iO(s);if(!o)return new Ru(c);var h,f,d,v=YN(u),g=YN(l),m=u.length,p=sO(l,s).lnPredictResult,y=XN(u,p),C=KN(p,v,a);if(a){h=oO(m,2);var _=KN(l,g,!0);f=new ut.NumberVar(QN(y,_,h)),d=new ut.NumberVar(eO(y,g,_,h,m))}else{h=oO(m,1);var R=KN(l,0,!1);f=new ut.NumberVar(QN(y,R,h)),d=we.d$b[we.O6N.LINEST_NO_STATISTICAL_INFO]()}var w=new ut.NumberVar(tO(C,y)),k=h&&y?new ut.NumberVar(rO(C,y,h)):G_,S=new ut.NumberVar(nO(y,h));return c.push([f,d],[w,S],[k,new ut.NumberVar(h)],[new ut.NumberVar(C),new ut.NumberVar(y)]),new Ru(c)}(e,t,n,this.name,o,i):function(e,t,n,r,a,o){var i=fO(e,t,n,r,a,!0);if(i.error)return i.error;var u=i.lnKnowYMatrix,s=i.weights,l=i.knownXMatrix,c=i.inverseMatrix,h=s[0].length,f=iO(s);if(!o)return new Ru(f);for(var d=[],v=u.flat(),g=YN(v),m=v.length,p=cO(l,s).lnPredictResult,y=XN(v,p),C=KN(p,g,a),_=h-1,R=c.length,w=oO(m,R),k=w?new ut.NumberVar(aO(C,_,y,w)):G_,S=new ut.NumberVar(tO(C,y)),E=new ut.NumberVar(nO(y,w)),T=we.d$b[we.O6N.LINEST_NO_STATISTICAL_INFO](),A=[k,new ut.NumberVar(w),T],I=[S,E,T],b=[new ut.NumberVar(C),new ut.NumberVar(y),T],F=R-1;F>=0;F--)w?d.push(new ut.NumberVar(Math.sqrt(y/w*c[F][F]))):d.push(new ut.NumberVar(0)),F<R-2&&(A.push(T),I.push(T),b.push(T));if(a){var M=d.shift();d.push(M)}else d.push(T);return f.push(d,I,A,b),new Ru(f)}(e,t,n,this.name,o,i)}}]),t}(eU);rU=Gi([cc("LOGEST")],rU);var aU=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e,t,n,r){var a=Math.trunc(t.getValue()),o=Math.trunc(n.getValue()),i=r.getValue();if(i<=0)return q_(this.name,i,3,0);var u=function(e,t){var n=ke.SheetDate.fromNumber(e),r=ke.SheetDate.fromNumber(t);if((0,ke.daysBetween)(n,r)>ke.SheetDate.from({year:n.year+1,month:n.month,date:n.date}).toNumber()-e)return we.d$b[we.O6N.NUM_MATURITY_DATE_NOT_THAN_SETTLEMENT_DATE_ONE_YEAR]({funcName:"",settlementDate:(0,Mt.excelDateToJSDate)(e),maturityDate:(0,Mt.excelDateToJSDate)(t)});var a=rN(e,t);return a.isValid?{settlement:n,maturity:r}:a.err}(a,o);return u instanceof ut.ErrorVar?AN(u,this.name,t,n,e):this.calcFuncResult(a,o,i)}}]),t}(gC("",3,0,0,tC,[{type:tC},{type:tC},{type:tC}])),oU=function(e){function t(){var e;return(0,y.Z)(this,t),(e=(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))).name="TBILLEQ",e}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"calcFuncResult",value:function(e,t,n){if(n>=1)return Q_(this.name,n,3,1);var r,a=ke.SheetDate.fromNumber(e),o=ke.SheetDate.fromNumber(t),i=(0,ke.daysBetween)(a,o),u=100*(1-(t-e)*n/360),s=i/365;return r=i<=182?(100-u)/u*(365/i):(-s+Math.sqrt(s*s-(2*s-1)*(1-100/u)))/(s-.5),new ut.NumberVar(r)}}]),t}(aU),iU=function(e){function t(){var e;return(0,y.Z)(this,t),(e=(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))).name="TBILLPRICE",e}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"calcFuncResult",value:function(e,t,n){if(n>=1)return Q_(this.name,n,3,1);var r=ke.SheetDate.fromNumber(e),a=ke.SheetDate.fromNumber(t),o=(0,ke.daysBetween)(r,a);return new ut.NumberVar(100*(1-n*o/360))}}]),t}(aU),uU=function(e){function t(){var e;return(0,y.Z)(this,t),(e=(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))).name="TBILLYIELD",e}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"calcFuncResult",value:function(e,t,n){var r=ke.SheetDate.fromNumber(e),a=ke.SheetDate.fromNumber(t),o=(0,ke.daysBetween)(r,a);return new ut.NumberVar((100-n)/n*360/o)}}]),t}(aU),sU=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e,t,n){var r=[],a=n.getValue(),o=1;if(t.isCollection()&&(o=t.size()),0===o)return ut.VALUE_ERR_VAR;var i=0,u=t.iter(e).first_if((function(e){return e.isError()}));if(u)return u;for(var s=a?e:Object.assign({},e,{skipEmptyRef:!1}),l=arguments.length,c=new Array(l>3?l-3:0),h=3;h<l;h++)c[h-3]=arguments[h];for(var f=0,d=c;f<d.length;f++){var v=d[f],g=void 0;if(v.iter(s).exitWhen((function(e){var t=e.isError();return t&&(g=e),t})).forEach((function(n){var u,s=n.toStringVar(e.service).getValue();(!a||""!==s&&null!==s)&&(t.isString()?u=t:(u=t.nth(i%o,e).toStringVar(e.service),i++),r.push(s||""),r.push(u.getValue()||""))})),g)return g}return r.pop(),new ut.StringVar(r.join(""))}}]),t}(gC("TEXTJOIN",3,256,1,nC,[{type:nC|iC},{type:rC,default:ut.BOOLEAN_VAR_MAP[ut.BooleanConstant.TRUE]},{type:nC|iC},{type:nC|iC}])),lU=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e,t){var n=t.getValue();return new ut.NumberVar(0===n?Math.PI/2:Math.atan(1/n)+(n>0?0:Math.PI))}}]),t}(gC("ACOT",1,0,0,tC,[{type:tC}])),cU=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e,t){var n=t.getValue();return Math.abs(n)<=1?function(e,t,n){return we.d$b[we.O6N.NUM_NOT_BE_BETWEEN_INCLUSIVE_PARAMETER]({funcName:e,index:t,value:n})}(this.name,1,n):new ut.NumberVar(.5*Math.log((n+1)/(n-1)))}}]),t}(gC("ACOTH",1,0,0,tC,[{type:tC}]));function hU(e,t,n){if(0===e&&!n)return PR(t);var r=Math.pow(2,27);return!(Math.abs(e)>=r)||z_(t,1,e,-r,r)}var fU=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e,t){var n=t.getValue(),r=hU(n,this.name);return r instanceof ut.ErrorVar?r:new ut.NumberVar(1/Math.tan(n))}}]),t}(gC("COT",1,0,0,tC,[{type:tC}])),dU=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e,t){var n=t.getValue(),r=hU(n,this.name);return r instanceof ut.ErrorVar?r:new ut.NumberVar(1/Math.tanh(n))}}]),t}(gC("COTH",1,0,0,tC,[{type:tC}])),vU=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e,t){var n=t.getValue(),r=hU(n,this.name);return r instanceof ut.ErrorVar?r:new ut.NumberVar(1/Math.sin(n))}}]),t}(gC("CSC",1,0,0,tC,[{type:tC}])),gU=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e,t){var n=t.getValue(),r=hU(n,this.name);return r instanceof ut.ErrorVar?r:new ut.NumberVar(1/Math.sinh(n))}}]),t}(gC("CSCH",1,0,0,tC,[{type:tC}])),mU=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e,t,n,r){var a=t.getValue();if(a>=1||a<=0)return z_(this.name,1,a,0,1);var o=n.getValue();if(o<=0)return q_(this.name,o,2,0);var i=Math.trunc(r.getValue());return i<1?K_(this.name,i,3,1):new ut.NumberVar(-(0,Mt.normInv)(a/2,0,1)*(o/Math.sqrt(i)))}}]),t}(gC("CONFIDENCE.NORM",3,0,0,tC,[{type:tC},{type:tC},{type:tC}])),pU=function(e){function t(){var e;return(0,y.Z)(this,t),(e=(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))).name="CONFIDENCE",e}return(0,g.Z)(t,e),t}(mU);function yU(e,t,n){return CU(-e,t,4)*n}function CU(e,t,n){var r=(0,Mt.betaDistCdf)(t/(t+e*e),t/2,.5);switch(n){case 1:return.5*r;case 2:default:return r;case 3:return Math.pow(1+e*e/t,-(t+1)/2)/(Math.sqrt(t)*(0,Mt.getBetaOrLogbeta)(!0,.5,t/2));case 4:var a=.5*(0,Mt.betaDistCdf)(t/(e*e+t),.5*t,.5);return e<0?a:1-a}}function _U(e,t,n){return function(e,t,n){function r(e,t){return e<0&&t>0||e>0&&t<0}var a,o,i=e(t),u=e(n);for(o=0;o<1e3&&!r(i,u);o++)Math.abs(i)<=Math.abs(u)?(a=t,(t+=2*(t-n))<0&&(t=0),n=a,u=i,i=e(t)):(a=n,n+=2*(n-t),t=a,i=u,u=e(n));if(0===i)return t;if(0===u)return n;if(!r(i,u))return 0;var s=t,l=i,c=n,h=u,f=t,d=i,v=.5*(t+n),g=!0;for(o=0;o<500&&Math.abs(d)>1e-307&&n-t>222045e-21*Math.max(Math.abs(t),Math.abs(n));)g&&(g=l!==h&&h!==d&&d!==l&&(t<(v=s*d*h/(d-l)/(h-l)+f*h*l/(h-d)/(l-d)+c*l*d/(l-h)/(d-h))&&v<n)),g||(v=.5*(t+n),s=t,l=i,c=n,h=u,g=!0),s=c,c=f,f=v,l=h,h=d,r(i,d=e(v))?(n=f,u=d):(t=f,i=d),g=g&&2*Math.abs(d)<=Math.abs(h),++o;return f}(function(){var r=e,a=t,o=n;return function(e){return r-CU(e,a,o)}}(),.5*t,t)}var RU=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e,t,n,r){var a=t.getValue();if(a>=1||a<=0)return z_(this.name,1,a,0,1);var o=n.getValue();if(o<=0)return q_(this.name,o,2,0);var i=Math.trunc(r.getValue());if(1===i)return PR(this.name);if(i<1)return K_(this.name,i,3,1);var u=1e10;return i>=u?Q_(this.name,i,3,u):new ut.NumberVar(o*_U(a,i-1,2)/Math.sqrt(i))}}]),t}(gC("CONFIDENCE.T",3,0,0,tC,[{type:tC},{type:tC},{type:tC}])),wU=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e,t){var n=t.getValue();if(0===n)return new ut.NumberVar(1);var r=hU(n,this.name,!0);return r instanceof ut.ErrorVar?r:new ut.NumberVar(1/Math.cos(n))}}]),t}(gC("SEC",1,0,0,tC,[{type:tC}])),kU=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e,t){var n=t.getValue();if(0===n)return new ut.NumberVar(1);var r=hU(n,this.name,!0);return r instanceof ut.ErrorVar?r:new ut.NumberVar(1/Math.cosh(n))}}]),t}(gC("SECH",1,0,0,tC,[{type:tC}])),SU=function(e){function t(){var e;return(0,y.Z)(this,t),(e=(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))).paramsDesc=[{type:tC|rC,default:WR(e.name)},{type:tC|rC,default:WR(e.name)}],e}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e,t,n){var r=this.name;if(t.isBool()||n.isBool())return ut.tractorErrorVarCreators[ut.ErrorCode.VALUE](r);var a=t.getValue(e),o=n.getValue(e);if(o<0)return q_(r,o,2,0);if(o>=0&&o<1)return PR(r);var i=Math.trunc(o),u=Math.trunc(a),s=a-u;if(i%10==0||1===i||!s)return new ut.NumberVar(a);for(var l=10;1<i/l;)l*=10;return this.financialCalc(u,s,i,l)}}]),t}(gC("",2,0,0,tC,[])),EU=function(e){function t(){var e;return(0,y.Z)(this,t),(e=(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))).name="DOLLARDE",e}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"financialCalc",value:function(e,t,n,r){return new ut.NumberVar(e+t/n*r)}}]),t}(SU),TU=function(e){function t(){var e;return(0,y.Z)(this,t),(e=(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))).name="DOLLARFR",e}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"financialCalc",value:function(e,t,n,r){return new ut.NumberVar(e+t*n/r)}}]),t}(SU);function AU(e,t,n){return q_(e,t,n,0)}function IU(e,t,n){return K_(e,t,n,0)}var bU=12,FU=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e,t,n,r,a,o){var i=t.getValue();if(i<0)return IU(this.name,i,1);var u=n.getValue();if(u<0)return IU(this.name,u,2);var s=r.getValue();if(s<=0)return AU(this.name,s,3);var l=a.getValue();if(l<=0)return AU(this.name,l,4);var c=Math.floor(o.getValue());if(c<=0)return AU(this.name,c,5);if(c>bU)return j_(this.name,c,5,1,bU);if(c===bU&&l>s)return mR(this.name,4,l,3,s);if(c<bU&&l>s+1)return X_(this.name,l,4,s+1);if(hm(e),0===i)return new ut.NumberVar(0);if(u===i)return new ut.NumberVar(0);var h=0===Math.floor(l)?1:Math.floor(l),f=Number((1-Math.pow(u/i,1/s)).toFixed(3)),d=i*f*c/bU;if(1===h)return new ut.NumberVar(d);var v,g=d;return g=(g-i)*Math.pow(1-f,h-2|0)+i,v=c!==bU&&h===s+1?(i-g)*f*(bU-c)/bU:(i-g)*f,new ut.NumberVar(v)}}]),t}(gC("DB",4,1,0,tC,[{type:tC,default:ut.NA_ERR_VAR},{type:tC,default:ut.NA_ERR_VAR},{type:tC,default:ut.NA_ERR_VAR},{type:tC,default:ut.NA_ERR_VAR},{type:tC,default:new ut.NumberVar(bU)}])),MU=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e,t,n,r,a,o,i,u){var s,l=Math.trunc(t.getValue()),c=Math.trunc(n.getValue()),h=r.getValue(),f=o.getValue(),d=a.getValue(),v=Math.trunc(i.getValue()),g=Math.trunc(u.getValue()),m=function(e,t,n,r,a,o,i,u){return t<=0?AU(e,t,1):n<=0?AU(e,n,2):r<0?IU(e,r,3):a<=0?AU(e,a,4):o<=0?AU(e,o,5):EN(t,n,i,u,6)}(this.name,l,c,h,d,f,v,g);if(m instanceof ut.ErrorVar)return AN(m,this.name,t,n,e);var p=yN(ke.SheetDate.fromNumber(l),ke.SheetDate.fromNumber(c),v),y=bN(m),C=p.start.toNumber(),_=fN(C<0?0:C,l,g).duration,R=null===(s=fN(l,c,g))||void 0===s?void 0:s.duration;if(!R)return new ut.NumberVar(0);var w,k=p.count,S=h/v,E=d/100+_/y*S;if(1!==k){for(var T=function(e){return $Z(l,c,h,e,f,v,g,m)},A=0,I=h||.01,b=T(I),F=b-d;100>=A&&1e-7<Math.abs(F);A++)b=T(1.01*I),F=(b=T(I=-F/(b-d-F)*I*.01+I))-d;return new ut.NumberVar(I)}return w=(f/100+S-E)/E*v*y/R,new ut.NumberVar(w)}}]),t}(gC("YIELD",6,1,0,tC,[{type:tC},{type:tC},{type:tC},{type:tC},{type:tC},{type:tC},{type:tC,default:new ut.NumberVar(0)}]));var VU=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e,t,n,r,a,o,i){var u=Math.trunc(t.getValue());if(u<=0)return AU(this.name,u,1);var s=Math.trunc(n.getValue());if(s<=0)return AU(this.name,s,2);if(u>=s)return vR(this.name,(0,Mt.excelDateToJSDate)(u),(0,Mt.excelDateToJSDate)(s));var l=r.getValue();if(l<0)return IU(this.name,l,3);if(l>u)return we.d$b[we.O6N.DATE_PARAMETER_SHOULD_BE_ON_OR_BEFORE_OTHER_DATE_PARAMETER]({funcName:this.name,index:3,firstDate:(0,Mt.excelDateToJSDate)(l),secondArgIndex:1,secondDate:(0,Mt.excelDateToJSDate)(u)});var c=a.getValue();if(c<0)return IU(this.name,c,4);var h=o.getValue();if(h<=0)return AU(this.name,h,5);var f=Math.floor(i.getValue());if(f>4||f<0)return j_(this.name,6,f,0,4);var d=fN(u,s,f),v=fN(l,u,f),g=fN(l,s,f);if(!d||!v||!g)return new ut.NumberVar(0);var m=((100+g.value*c*100)/(h+v.value*c*100)-1)/d.value;return new ut.NumberVar(m)}}]),t}(gC("YIELDMAT",5,1,0,tC,[{type:tC},{type:tC},{type:tC},{type:tC},{type:tC},{type:tC,default:new ut.NumberVar(0)}])),NU=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e,t,n,r,a,o){var i=Math.trunc(t.getValue());if(i<=0)return AU(this.name,i,1);var u=Math.trunc(n.getValue());if(u<=0)return AU(this.name,u,2);if(i>=u)return vR(this.name,(0,Mt.excelDateToJSDate)(i),(0,Mt.excelDateToJSDate)(u));var s=r.getValue();if(s<=0)return AU(this.name,s,3);var l=a.getValue();if(l<=0)return AU(this.name,l,4);var c=Math.floor(o.getValue());if(c>4||c<0)return j_(this.name,5,c,0,4);var h=fN(i,u,c);if(!h)return new ut.NumberVar(0);var f=(l/s-1)/h.value;return new ut.NumberVar(f)}}]),t}(gC("YIELDDISC",4,1,0,tC,[{type:tC},{type:tC},{type:tC},{type:tC},{type:tC,default:new ut.NumberVar(0)}])),OU=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e,t,n,r,a,o,i,u){var s=t.getValue();if(s<0)return IU(this.name,s,1);var l=n.getValue();if(l<0)return IU(this.name,l,2);if(l>s)return mR(this.name,l,2,1,s);var c=r.getValue();if(c<=0)return AU(this.name,c,3);var h=a.getValue();if(h<0)return IU(this.name,h,4);var f=o.getValue();if(f<0)return IU(this.name,f,5);if(f>999)return X_(this.name,f,5,999);if(f>c)return mR(this.name,f,5,3,c);if(h>f)return mR(this.name,h,4,5,f);var d=i.getValue();if(d<=0)return AU(this.name,d,6);var v=u.getValue();if(hm(e),0===s)return new ut.NumberVar(0);if(l===s)return new ut.NumberVar(0);var g=1/c*d;function m(e,t,n){var r=e-t,a=Math.floor(n),o=Math.min(e-e*Math.pow(1-g,a),r);return n>a&&(o+=Math.min((e-o)*g,r-o)*(n-a)),Math.min(r,o)}var p=s-l,y=Math.floor(h),C=Math.ceil(h),_=0;if(v){var R=m(s,l,y);if(h>y){var w=Math.min((s-R)*g,p-R);_=w*(C-h),R+=w}_+=m(s-R,l,f-C)}else{var k,S,E=h-y,T=!1,A=function(e){return 0|Math.max(Math.min(e,2147483647),-2147483648)}(c);for(S=0;S<f-E+1;S=S+1|0){var I=m(s,l,Math.max(E+S-1,0));if(m(s-I,l,1)<=(k=(p-I)/(c-Math.max(E+S-1,0)))){T=!0,A=S;break}}if(T)if(A<=y+1)_=(0===A?(p-k*E)/Math.max(c-E,1):k)*(f-h);else{var b=m(s,l,h);_=m(s-b,l,(A-1|0)-y)+k*(f-A-E+1)}else{var F=m(s,l,h);_=m(s-F,l,f-h)}}return new ut.NumberVar(_)}}]),t}(gC("VDB",5,2,0,tC,[{type:tC},{type:tC},{type:tC},{type:tC},{type:tC},{type:tC,default:new ut.NumberVar(2)},{type:rC,default:new ut.BooleanVar(!1)}])),xU=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e,t,n,r,a){var o=t.getValue(),i=n.getValue();if(i<0)return IU(this.name,i,2);var u=r.getValue();if(u<=0)return AU(this.name,u,3);var s=a.getValue();return s<=0?AU(this.name,s,4):s>u?mR(this.name,s,4,3,u):(hm(e),i===o?new ut.NumberVar(0):new ut.NumberVar((o-i)*(u-s+1)*2/(u*(u+1))))}}]),t}(gC("SYD",4,0,0,tC,[{type:tC},{type:tC},{type:tC},{type:tC}])),ZU=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e,t,n,r,a,o,i,u){var s=t.getValue();if(s<0)return IU(this.name,s,1);var l=n.getValue();if(l<=0)return q_(this.name,l,2,0);var c=r.getValue();if(c<=0)return q_(this.name,c,3,0);if(l>c){var h=e.ref.sheet();return h?eR(this.name,h,l,2,c,3):ut.VALUE_ERR_VAR}var f=a.getValue();if(f<0)return IU(this.name,f,4);if(f>s)return mR(this.name,4,f,1,s);var d=o.getValue();if(d<0)return IU(this.name,d,5);var v=i.getValue();if(v<=0)return AU(this.name,v,6);var g=Math.floor(u.getValue());if(g>4||g<0)return j_(this.name,7,g,0,4);if(f===s)return new ut.NumberVar(0);var m=fN(l,c,g);if(!m)return new ut.NumberVar(0);var p=d>0&&d<2?1:d,y=s*v,C=p+(m.value||0),_=s-(0===p?0:C-1)*y;_<f&&(_=f);var R=s-C*y;return R<f&&(R=f),new ut.NumberVar(_-R)}}]),t}(gC("AMORLINC",6,1,0,tC,[{type:tC},{type:tC},{type:tC},{type:tC},{type:tC},{type:tC},{type:tC,default:new ut.NumberVar(0)}])),DU=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e,t,n,r,a){var o=t.getValue();if(o<0)return H_(this.name,1);var i=n.getValue();if(i<=0)return q_(this.name,i,2,0);var u=r.getValue();if(u<=0)return q_(this.name,u,3,0);var s=a.getValue(),l=Math.exp(-Math.pow(o/u,i)),c=s?1-l:i/Math.pow(u,i)*Math.pow(o,i-1)*l;return new ut.NumberVar(c)}}]),t}(gC("WEIBULL.DIST",4,0,0,tC,[{type:tC},{type:tC},{type:tC},{type:rC}])),PU=function(e){function t(){var e;return(0,y.Z)(this,t),(e=(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))).name="WEIBULL",e}return(0,g.Z)(t,e),t}(DU),LU=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e,t,n){var r=t.getValue(),a=n.getValue(),o=1;if(r<0)return K_(this.name,r,1,0);if(r>2147483647)return X_(this.name,r,1,2147483647);if(a<0)return K_(this.name,a,2,0);if(r<a)return mR(this.name,a,2,1,r);for(var i=(r=Math.trunc(r))-(a=Math.trunc(a))+1;i<=r;i++)o*=i;return new ut.NumberVar(o)}}]),t}(gC("PERMUT",2,0,0,tC,[{type:tC},{type:tC}])),BU=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e,t,n){var r=t.getValue(),a=n.getValue();return r<1?K_(this.name,r,1,1):r>2147483647?X_(this.name,r,1,2147483647):a<0?K_(this.name,a,2,0):(r=Math.trunc(r),a=Math.trunc(a),new ut.NumberVar(Math.pow(r,a)))}}]),t}(gC("PERMUTATIONA",2,0,0,tC,[{type:tC},{type:tC}])),UU=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e,t,n,r){var a=t.getValue(),o=n.getValue(),i=r.getValue();if(a<0)return K_(this.name,a,1,0);if(o<=0)return q_(this.name,o,2,0);var u=Math.exp(-o*a);return new ut.NumberVar(i?1-u:o*u)}}]),t}(gC("EXPON.DIST",3,0,0,tC,[{type:tC},{type:tC},{type:rC}])),HU=function(e){function t(){var e;return(0,y.Z)(this,t),(e=(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))).name="EXPONDIST",e}return(0,g.Z)(t,e),t}(UU);function WU(e,t,n,r){if(t-e>r-n)return 0;if(r>=1029){var a=t>n?t:n,o=t>n?n:t,i=0,u=1,s=1,l=Math.floor(o*a/r);l===e&&i++;for(var c=l+1,h=1;c<=o&&1e-11<h;c++,s=h)u+=h=s*(a-c+1)*(o-c+1)/(c*(r-a-o+c)),c===e&&(i+=h);for(--l,s=c=1;0<=l&&1e-11<s;l--,c=s)u+=s=c*(l+1)*(r-a-o+l+1)/((a-l)*(o-l)),l===e&&(i+=s);return i/u}return(0,Mt.combin)(n,e)*(0,Mt.combin)(r-n,t-e)/(0,Mt.combin)(r,t)}var jU=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e,t,n,r,a){for(var o=Math.trunc(t.getValue()),i=Math.trunc(n.getValue()),u=Math.trunc(r.getValue()),s=Math.trunc(a.getValue()),l=[o,i,u,s],c=0;c<l.length;c++)if(l[c]<0)return q_(this.name,l[c],c+1,0);if(o>i)return new ut.NumberVar(0);if(u>s)return mR(this.name,u,3,4,s);if(i>s)return mR(this.name,i,2,4,s);var h=WU(o,i,u,s);return new ut.NumberVar(h)}}]),t}(gC("HYPGEOMDIST",4,0,0,tC,[{type:tC},{type:tC},{type:tC},{type:tC}])),zU=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e,t,n,r,a,o){for(var i=Math.trunc(t.getValue()),u=Math.trunc(n.getValue()),s=Math.trunc(r.getValue()),l=Math.trunc(a.getValue()),c=o.getValue(),h=[i,u,s,l],f=0;f<h.length;f++)if(h[f]<0)return q_(this.name,h[f],f+1,0);if(i>u)return new ut.NumberVar(c?1:0);if(s>l)return mR(this.name,s,3,4,l);if(u>l)return mR(this.name,u,2,4,l);if(c){for(var d=0,v=0;v<=i;v++)d+=WU(v,u,s,l);return new ut.NumberVar(d)}return new ut.NumberVar(WU(i,u,s,l))}}]),t}(gC("HYPGEOM.DIST",5,0,0,tC,[{type:tC},{type:tC},{type:tC},{type:tC},{type:rC}])),GU=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e,t){var n=t.getValue();if(0===n)return new ut.NumberVar(0);if(n>=1||n<=-1)return z_(this.name,1,n,-1,1);var r=Math.log((1+n)/(1-n))/2;return new ut.NumberVar(r)}}]),t}(gC("FISHER",1,0,0,tC,[{type:tC}])),JU=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e,t){var n=t.getValue(),r=Math.exp(2*n)-1,a=Math.exp(2*n)+1;return!Number.isFinite(r)&&r>0&&!Number.isFinite(a)&&a>0?new ut.NumberVar(1):new ut.NumberVar(r/a)}}]),t}(gC("FISHERINV",1,0,0,tC,[{type:tC}])),qU=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e,t,n,r){var a=Math.trunc(n.getValue());if(a<1)return K_(this.name,a,2,1);var o=t.getValue(),i=r.getValue();return new ut.NumberVar(CU(o,a,i?4:3))}}]),t}(gC("T.DIST",3,0,0,tC,[{type:tC},{type:tC},{type:rC}])),$U=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e,t,n,r){var a=t.getValue();if(a<0)return K_(this.name,a,1,0);var o=Math.trunc(n.getValue());if(o<1)return K_(this.name,o,2,1);var i=Math.trunc(r.getValue());if(i<1||i>2)return j_(this.name,3,i,1,2);var u=yU(a,o,i);return new ut.NumberVar(u)}}]),t}(gC("TDIST",3,0,0,tC,[{type:tC},{type:tC},{type:tC}])),YU=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e,t,n){var r=t.getValue();if(r<0)return K_(this.name,r,1,0);var a=Math.trunc(n.getValue());if(a<1)return K_(this.name,a,2,1);var o=yU(r,a,2);return new ut.NumberVar(o)}}]),t}(gC("T.DIST.2T",2,0,0,tC,[{type:tC},{type:tC}])),KU=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e,t,n){var r=Math.trunc(n.getValue());if(r<1)return K_(this.name,r,2,1);var a=yU(t.getValue(),r,1);return new ut.NumberVar(a)}}]),t}(gC("T.DIST.RT",2,0,0,tC,[{type:tC},{type:tC}])),XU=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e,t,n){var r=t.getValue();if(r<=0)return q_(this.name,r,1,0);if(r>1)return X_(this.name,r,1,1);if(1===r)return new ut.NumberVar(0);var a=Math.trunc(n.getValue());return a<1?K_(this.name,a,2,1):new ut.NumberVar(function(e,t){var n,r,a,o,i,u,s,l,c,h,f=179769e303,d=e/2,v=d;return t>1e20?(0,Mt.normInv)(d,0,1):(v<.5?(h=0,u=2*v):(h=1,u=2*(1-v)),Math.abs(t-2)<1e-12?s=u>0?Math.sqrt(2/(u*(2-u))-2):f:t<1+1e-12?u>0?(i=1.5707963267948966*(u+1),s=-Math.tan(i)):s=f:(o=((94.5/((r=48/((n=1/(t-.5))*n))+(a=((20700*n/r-98)*n-16)*n+96.36))-3)/r+1)*Math.sqrt(1.5707963267948966*n)*t,(c=Math.pow(o*u,2/t))>.05+n?(l=(0,Mt.normInv)(.5*u,0,1),t<5&&(a+=.3*(t-4.5)*(l+.6)),c=(((((.4*(c=l*l)+6.3)*c+36)*c+94.5)/(a=(((.05*o*l-5)*l-7)*l-2)*l+r+a)-c-3)/r+1)*l,c=(c*=n*c)>.002?Math.exp(c)-1:.5*c*c+c):c=((1/(((t+6)/(t*c)-.089*o-.822)*(t+2)*3)+.5/(t+4))*c-1)*(t+1)/(t+2)+1/c,s=Math.sqrt(t*c)),0!==h&&(s=-s),s)}(r,a))}}]),t}(gC("T.INV.2T",2,0,0,tC,[{type:tC},{type:tC}])),QU=function(e){function t(){var e;return(0,y.Z)(this,t),(e=(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))).name="TINV",e}return(0,g.Z)(t,e),t}(XU),eH=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e,t,n){var r=t.getValue();if(r<=0)return q_(this.name,r,1,0);if(r>=1)return Q_(this.name,r,1,1);var a=Math.trunc(n.getValue());if(a<1)return K_(this.name,a,2,1);var o=r<.5?-_U(1-r,a,4):_U(r,a,4);return new ut.NumberVar(o)}}]),t}(gC("T.INV",2,0,0,tC,[{type:tC},{type:tC}])),tH=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e,t,n,r,a){var o=t.size(),i=n.size(),u=Math.trunc(a.getValue());if(1===u&&o!==i)return SR(this.name);var s=[],l=[],c=0;if(1===u)for(var h=0;h<t.size();h++){var f=t.nth(h,e);if(f.isError())return f;var d=n.nth(h,e);if(d.isError())return d;if(f.isNumber()&&d.isNumber()){var v=f.getValue(),g=d.getValue();s.push(v),l.push(g),c++}}else{if(s=Sw(t.iter(e)),l=Sw(n.iter(e)),s instanceof ut.ErrorVar)return s;if(l instanceof ut.ErrorVar)return l;c=Math.min(s.length,l.length)}if(c<=1)return PR(this.name);var m,p,y,C,_,R,w,k,S,E=Math.trunc(r.getValue());if(E<1||E>2)return j_(this.name,3,E,1,2);if(u<1||u>3)return j_(this.name,4,u,1,3);if(1===u){for(var T=[],A=0;A<s.length;A++)T.push(s[A]-l[A]);var I=Ew(T);if(0===I.Q)return PR(this.name);C=Math.sqrt(I.Q/(I.N-1)),y=(m=I.sum/I.N)/(C/Math.sqrt(I.N)),w=I.N-1}else{var b=Ew(s),F=Ew(l);if(0===b.Q&&0===F.Q)return PR(this.name);if(_=b.Q/(b.N-1),R=F.Q/(F.N-1),m=b.sum/b.N,p=F.sum/F.N,k=b.N,S=F.N,2===u)w=k+S-2,y=(m-p)/(Math.sqrt(((k-1|0)*_+(l.length-1|0)*R)/w)*Math.sqrt(1/k+1/l.length));else{var M=_/k/(_/k+R/S);w=1/(M*M/(k-1)+(1-M)*(1-M)/(S-1)),y=(m-p)/Math.sqrt(_/k+R/S)}}var V=function(e,t,n){var r=0===n||1===n?0:Math.exp((0,Mt.gammaln)(e+t)-(0,Mt.gammaln)(e)-(0,Mt.gammaln)(t)+e*Math.log(n)+t*Math.log(1-n)),a=n>=(e+1)/(e+t+2);a&&(e=[t,t=e][0],n=1-n);var o=4450147717014403e-323,i=100,u=e+t,s=e+1,l=e-1,c=1,h=1-u*n/s;Math.abs(h)<o&&(h=o);for(var f=h=1/h,d=1,v=2;d<=i;d++,v+=2){var g=d*(t-d)*n/((l+v)*(e+v));h=1+g*h,Math.abs(h)<o&&(h=o),c=1+g/c,Math.abs(c)<o&&(c=o),f*=(h=1/h)*c,h=1+(g=-(e+d)*(u+d)*n/((e+v)*(s+v)))*h,Math.abs(h)<o&&(h=o),c=1+g/c,Math.abs(c)<o&&(c=o);var m=(h=1/h)*c;if(f*=m,Math.abs(m-1)<5e-324){var p=r*f/e;return a?1-p:p}}return 0}(.5*w,.5,w/(w+(y=Math.abs(y))*y));return new ut.NumberVar(.5*E*V)}}]),t}(gC("T.TEST",4,0,0,tC,[{type:iC},{type:iC},{type:tC},{type:tC}]));var nH=function(e){function t(){var e;return(0,y.Z)(this,t),(e=(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))).name="TTEST",e}return(0,g.Z)(t,e),t}(tH),rH=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e){for(var t=[],n=arguments.length,r=new Array(n>1?n-1:0),a=1;a<n;a++)r[a-1]=arguments[a];for(var o=0,i=r;o<i.length;o++){var u=i[o],s=Sw(u.iter(e));if(s instanceof ut.ErrorVar)return s;t=t.concat(s)}if(0===t.length)return HR(this.name);var l,c=t.reduce((function(e,t){return e+t}),0)/t.length,h=0,f=_n(t);try{for(f.s();!(l=f.n()).done;){var d=l.value,v=d-c;h+=v*v}}catch(e){f.e(e)}finally{f.f()}return new ut.NumberVar(h)}}]),t}(gC("DEVSQ",1,255,1,tC,[{type:tC|iC},{type:tC|iC}])),aH=function(e){function t(){var e;return(0,y.Z)(this,t),(e=(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))).name="VAR.S",e}return(0,g.Z)(t,e),t}(Mt.VARFunc),oH=function(e){function t(){var e;return(0,y.Z)(this,t),(e=(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))).name="VAR.P",e}return(0,g.Z)(t,e),t}(Mt.VARPFunc);function iH(e,t,n){var r=function(e,t){var n,r=0,a=0,o=_n(e());try{for(o.s();!(n=o.n()).done;){var i=n.value,u=null;if(i.exitWhen((function(e){var t=e.isError();return t&&(u=e),t})).forEach((function(e){e.isNumber()?(r+=e.getValue(),a++):e.isBool()?(r+=e.toNumberVar().getValue(),a++):e.isString()&&a++})),u)return u}}catch(e){o.e(e)}finally{o.f()}return 0===a?PR(t):new ut.NumberVar(r/a)}(t,n);if(r.isError())return r;var a,o=r.getValue(),i=0,u=0,s=_n(t());try{for(s.s();!(a=s.n()).done;){a.value.exitWhen((function(e){return e.isError()})).forEach((function(e){e.isNumber()?(u+=Math.pow(e.getValue()-o,2),i++):e.isBool()?(u+=Math.pow(e.toNumberVar().getValue()-o,2),i++):e.isString()&&(u+=Math.pow(0-o,2),i++)}))}}catch(e){s.e(e)}finally{s.f()}var l=e?i:i-1;return l<1?PR(n):(u/=l,new ut.NumberVar(u))}var uH=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),r=1;r<t;r++)n[r-1]=arguments[r];var a=iH(!1,(function(){var t,r=[],a=_n(n);try{for(a.s();!(t=a.n()).done;){var o=t.value;r.push(o.iter(e))}}catch(e){a.e(e)}finally{a.f()}return r}),this.name);return a.isError()||a.isNumber(),a}}]),t}(gC("VARA",1,255,1,tC,[{type:tC|iC},{type:tC|iC}])),sH=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),r=1;r<t;r++)n[r-1]=arguments[r];var a=iH(!0,(function(){var t,r=[],a=_n(n);try{for(a.s();!(t=a.n()).done;){var o=t.value;r.push(o.iter(e))}}catch(e){a.e(e)}finally{a.f()}return r}),this.name);return a.isError()||a.isNumber(),a}}]),t}(gC("VARPA",1,255,1,tC,[{type:tC|iC},{type:tC|iC}])),lH=function(e){function t(){var e;return(0,y.Z)(this,t),(e=(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))).name="STDEV.P",e}return(0,g.Z)(t,e),t}(Mt.STDEVPFunc),cH=function(e){function t(){var e;return(0,y.Z)(this,t),(e=(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))).name="STDEV.S",e}return(0,g.Z)(t,e),t}(Mt.STDEVFunc),hH=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),r=1;r<t;r++)n[r-1]=arguments[r];var a=iH(!1,(function(){var t,r=[],a=_n(n);try{for(a.s();!(t=a.n()).done;){var o=t.value;r.push(o.iter(e))}}catch(e){a.e(e)}finally{a.f()}return r}),this.name);if(a.isError()||!a.isNumber())return a;var o=Math.sqrt(a.getValue());return new ut.NumberVar(o)}}]),t}(gC("STDEVA",1,255,1,tC,[{type:tC|iC},{type:tC|iC}])),fH=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),r=1;r<t;r++)n[r-1]=arguments[r];var a=iH(!0,(function(){var t,r=[],a=_n(n);try{for(a.s();!(t=a.n()).done;){var o=t.value;r.push(o.iter(e))}}catch(e){a.e(e)}finally{a.f()}return r}),this.name);if(a.isError()||!a.isNumber())return a;var o=Math.sqrt(a.getValue());return new ut.NumberVar(o)}}]),t}(gC("STDEVPA",1,255,1,tC,[{type:tC|iC},{type:tC|iC}])),dH=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e,t,n,r,a,o){var i=t.getValue(),u=n.getValue();if(i<0)return IU(this.name,i,1);if(u<0)return IU(this.name,u,2);var s=r.getValue();if(s<=0)return AU(this.name,s,3);var l=a.getValue();if(l<=0)return AU(this.name,l,4);var c=o.getValue();if(c<=0)return AU(this.name,c,5);if(l>s)return mR(this.name,4,l,3,s);if(hm(e),0===i)return new ut.NumberVar(0);if(u>=i)return new ut.NumberVar(0);var h=Math.ceil(l),f=0,d=1-c/s;if(f=Math.pow(d,h-1)*(1-d)*i,(Math.pow(d,h)-1)/(d-1)*(c/s)*i>i-u&&(f=Math.max(Math.min(i-u-(Math.pow(d,h-1)-1)/(d-1)*(c/s)*i,f),0)),h<1e4&&d<0)for(var v=0,g=1;g<=h;g++)v+=f=Math.min(c/s*(i-v),i-u-v);return new ut.NumberVar(f)}}]),t}(gC("DDB",4,1,0,tC,[{type:tC,default:ut.NA_ERR_VAR},{type:tC,default:ut.NA_ERR_VAR},{type:tC,default:ut.NA_ERR_VAR},{type:tC,default:ut.NA_ERR_VAR},{type:tC,default:new ut.NumberVar(2)}]));function vH(e){return 55296<=e&&e<=56319}function gH(e){return 56320<=e&&e<=57343}function mH(e,t){return 65536+((1023&e)<<10)+(1023&t)}function pH(e,t){var n=e.length;if(t>=n)return 0;var r=e.charCodeAt(t);if(vH(r)&&t+1<n){var a=e.charCodeAt(t+1);if(gH(a))return mH(r,a)}return r}function yH(e,t,n){for(var r=n,a=Math.min(t+n,e.length),o=t;o<a;o+=1)pH(e,o)>255&&(r+=1);return r}function CH(e,t,n){for(var r=0,a=0,o=t;r<n&&o<e.length;o+=1)a+=1,r+=pH(e,o)>255?2:1;return a}var _H=function(e){function t(){var e;return(0,y.Z)(this,t),(e=(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))).name="MIDB",e}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e,t,n,r){var a=Math.floor(n.getValue());if(a<1)return Y_(this.name,a,2,1);var o=Math.floor(r.getValue());if(o<0)return W_(this.name,3);var i=t.getValue();if(a>i.length)return new ut.StringVar("");var u=CH(i,a-1,o);return new ut.StringVar(i.substr(a-1,u))}}]),t}(Mt.MIDFunc),RH=function(e){function t(){var e;return(0,y.Z)(this,t),(e=(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))).name="SEARCHB",e}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e,n,r,a){var o=(0,f.Z)((0,v.Z)(t.prototype),"func",this).call(this,e,n,r,a);if(o.isNumber()&&n.getValue().length>0){var i=o.getValue()-1,u=yH(r.getValue(),0,i);return new ut.NumberVar(u+1)}return o}}]),t}(Mt.SEARCHFunc),wH=function(e){function t(){var e;return(0,y.Z)(this,t),(e=(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))).name="FINDB",e}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e,n,r,a){var o=(0,f.Z)((0,v.Z)(t.prototype),"func",this).call(this,e,n,r,a);if(o.isNumber()&&n.getValue().length>0){var i=o.getValue()-1,u=yH(r.getValue(),0,i);return new ut.NumberVar(u+1)}return o}}]),t}(Mt.FINDFunc),kH=function(e){function t(){var e;return(0,y.Z)(this,t),(e=(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))).name="REPLACEB",e}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e,n,r,a,o){var i=n.getValue(),u=Math.floor(r.getValue()),s=Math.floor(a.getValue());if(u<1)return Y_(this.name,u,2,1);if(s<0)return W_(this.name,3);var l=CH(i,u-1,s);return(0,f.Z)((0,v.Z)(t.prototype),"func",this).call(this,e,n,r,new ut.NumberVar(l),o)}}]),t}(Mt.REPLACEFunc),SH=function(e){function t(){var e;return(0,y.Z)(this,t),(e=(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))).name="LEFTB",e}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e,t,n){var r=Math.floor(n.getValue());if(r<0)return W_(this.name,2);var a=t.getValue(),o=CH(a,0,r);return new ut.StringVar(a.substr(0,o))}}]),t}(Mt.LEFTFunc),EH=function(e){function t(){var e;return(0,y.Z)(this,t),(e=(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))).name="RIGHTB",e}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e,t,n){var r=Math.floor(n.getValue());if(r<0)return W_(this.name,2);var a=t.getValue(),o=function(e,t,n){for(var r=0,a=0,o=e.length-1;r<n&&o>=t;o-=1)a+=1,r+=pH(e,o)>255?2:1;return a}(a,0,r),i=Math.max(0,a.length-o);return new ut.StringVar(a.substr(i,o))}}]),t}(Mt.RIGHTFunc),TH=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e,t,n,r,a,o,i){var u=Math.floor(t.getValue()),s=Math.floor(n.getValue()),l=Math.floor(r.getValue()),c=a.getValue(),h=o.getValue(),f=Math.floor(i.getValue()),d=[{val:u,index:1},{val:s,index:2},{val:l,index:3}].find((function(e){return e.val<0}));if(d)return K_(this.name,d.val,d.index,0);var v=[[{val:l,index:3},{val:u,index:1}],[{val:u,index:1},{val:s,index:2}]].find((function(e){var t=(0,p.Z)(e,2),n=t[0],r=t[1];return n.val>=r.val}));if(v){var g=e.ref.sheet();if(!g)return ut.VALUE_ERR_VAR;var m=(0,p.Z)(v,2),y=m[0],C=m[1];return eR(this.name,g,y.val,y.index,C.val,C.index)}var _=[{val:c,index:4},{val:h,index:5}].find((function(e){return e.val<0}));if(_)return K_(this.name,_.val,_.index,0);if(!wN(f))return SN(this.name,f,6);var R=fN(l,s,f),w=fN(u,s,f),k=fN(l,u,f);return R&&w&&k?new ut.NumberVar((100+R.value*c*100)/(1+w.value*h)-k.value*c*100):ut.NUM_ERR_VAR}}]),t}(gC("PRICEMAT",5,1,0,tC,[{type:tC},{type:tC},{type:tC},{type:tC},{type:tC},{type:tC,default:new ut.NumberVar(eN.UsPsa30_360)}])),AH=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e,t,n,r){var a=t.getValue(),o=n.getValue(),i=r.getValue(),u=[{val:a,index:1},{val:o,index:2}].find((function(e){return e.val<=0}));return u?q_(this.name,u.val,u.index,0):i<0?K_(this.name,i,3,0):new ut.NumberVar(Math.pow(i/o,1/a)-1)}}]),t}(gC("RRI",3,0,0,tC,[{type:tC},{type:tC},{type:tC}])),IH=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e,t,n,r){var a=t.getValue(),o=n.getValue(),i=r.getValue();if(a<0)return H_(this.name,1);if(o<0)return H_(this.name,2);var u,s,l,c=Math.floor(a),h=0;if(170<c||290<c*Math.log10(o)){s=0,u=0,u++,((l=Math.floor(o))===c||i&&l<c)&&s++;for(var f=l+1,d=2*l,v=1;f<=d&&1e-11<v;++f)u+=v=v*o/f,(f===c||i&&f<c)&&(s+=v);--l;for(var g=1;0<=l&&1e-11<g;--l)u+=g=g*(l+1)/o,(l===c||i&&l<c)&&(s+=g);h=s/u}else if(i){var m=0;s=1,u=1,l=Math.exp(-o);for(var p=0;p<=c;p=p+1|0)m+=l*s/u,s*=o,u*=p+1|0;h=m}else h=Math.exp(-o)*Math.pow(o,c)/(0,Mt.factorialCalc)(c);return new ut.NumberVar(h)}}]),t}(gC("POISSON",3,0,0,tC,[{type:tC},{type:tC},{type:rC}])),bH=function(e){function t(){var e;return(0,y.Z)(this,t),(e=(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))).name="POISSON.DIST",e}return(0,g.Z)(t,e),t}(IH),FH=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e,t,n,r){var a=t.getValue(),o=n.getValue(),i=r.getValue();return i<=0?q_(this.name,i,3,0):new ut.NumberVar((a-o)/i)}}]),t}(gC("STANDARDIZE",3,0,0,tC,[{type:tC},{type:tC},{type:tC}])),MH=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e,t,n,r,a,o){var i=Math.floor(t.getValue()),u=Math.floor(n.getValue()),s=r.getValue(),l=a.getValue(),c=Math.floor(o.getValue()),h=[{val:i,index:1},{val:u,index:2}].find((function(e){return e.val<0}));if(h)return K_(this.name,h.val,h.index,0);if(i>=u){var f=e.ref.sheet();return f?eR(this.name,f,i,1,u,2):ut.VALUE_ERR_VAR}var d=[{val:s,index:3},{val:l,index:4}].find((function(e){return e.val<=0}));if(d)return q_(this.name,d.val,d.index,0);if(!wN(c))return SN(this.name,c,5);var v=fN(i,u,c);if(!v)return ut.NUM_ERR_VAR;var g=1-l*v.value;return g<=0?ut.NUM_ERR_VAR:new ut.NumberVar(s/g)}}]),t}(gC("RECEIVED",4,1,0,tC,[{type:tC},{type:tC},{type:tC},{type:tC},{type:tC,default:new ut.NumberVar(eN.UsPsa30_360)}])),VH=function(e){function t(){var e;return(0,y.Z)(this,t),(e=(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))).name="PERCENTILE.INC",e}return(0,g.Z)(t,e),t}(Mt.PERCENTILEFunc);function NH(e,t,n,r,a){var o=n.length;if(n.sort((function(e,t){return e-t})),0===o||e<n[0]||e>n[o-1])return WR(a);var i=1===o?1:function(e,t,n){var r,a,o=e.length;if(t!==e[0]){var i=0,u=e[0];for(a=1;a<o&&e[a]<t;a++)e[a]!==u&&(i=a,u=e[a]);if(e[a]!==u&&(i=a),t===e[a])r=n?i/(o-1):(a+1)/(o+1);else if(0===i)r=0;else{var s=(t-e[i-1])/(e[i]-e[i-1]);r=n?(i-1+s)/(o-1):(i+s)/(o+1)}}else r=n?0:1/(o+1);return r}(n,e,r);return(t=Math.floor(t))<1&&(t=3),new ut.NumberVar(0!==i?Math.round(i*Math.pow(10,t))/Math.pow(10,t):i)}var OH,xH=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e,t,n,r){var a=Sw(t.iter(e));return a instanceof ut.ErrorVar?a:NH(n.getValue(),r.getValue(),a,!1,this.name)}}]),t}(gC("PERCENTRANK.EXC",2,1,0,tC,[{type:iC},{type:tC},{type:tC,default:new ut.NumberVar(3)}])),ZH=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e,t,n,r){var a=Sw(t.iter(e));return a instanceof ut.ErrorVar?a:NH(n.getValue(),r.getValue(),a,!0,this.name)}}]),t}(gC("PERCENTRANK.INC",2,1,0,tC,[{type:iC},{type:tC},{type:tC,default:new ut.NumberVar(3)}])),DH=function(e){function t(){var e;return(0,y.Z)(this,t),(e=(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))).name="QUARTILE.INC",e}return(0,g.Z)(t,e),t}(Mt.QUARTILEFunc),PH=function(){return we.d$b[we.O6N.GETPIVOTDATA_NO_MATCHING_FIELD_ITEM_PAIR]()},LH=function(e){for(var t=e.length,n=new Map,r=0;r<t-1;r+=2){var a=e[r].getValue(),o=e[r+1].getValue(),i=null===o?"":o;if(n.has(a)&&n.get(a)!==i)return null;n.set(a,i)}return n},BH=function(){function e(t,n,r){(0,y.Z)(this,e),this.sheet=t,this.pivotContentRange=n,this.pivotView=r}return(0,C.Z)(e,[{key:"getBlankValue",value:function(e,t,n,r){if(void 0!==this.cacheBlankValue)return this.cacheBlankValue;if(this.pivotContentRange){var a,o;"row"===e?(a=this.pivotView.col.range.rowCount+n,o=t):(a=t+1,o=this.pivotView.row.range.colCount+n);var i=this.sheet.getValue(this.pivotContentRange.rowFrom()+a,this.pivotContentRange.colFrom()+o,void 0,r);return this.cacheBlankValue=i,i}}}]),e}(),UH=function(e,t,n){var r=HH(n);e.items.push([t,r]),e.maxCheckIndex=Math.max(e.maxCheckIndex,t)},HH=function(e){if("number"==typeof e){var t=String(e);return{strVal:t,dateVal:t}}if(function(e){if("CreationDoc_Sheets_PivotTable_Blank"===e)return!0;var t=e[0];return"("===t||"（"===t}(e))return{strVal:e,maybeBlankValue:!0};var n=e.split(" "),r=(0,p.Z)(n,2),a=r[0];if(r[1])return e;var o=a.split("/");if(3!==o.length||o.some((function(e){return e.startsWith("0")})))return e;var i=Date.UTC(Number(o[0]),Number(o[1])-1,Number(o[2]));return Number.isNaN(i)?e:{strVal:e,dateVal:String(ke.SheetDate.fromUTCDate(i).toNumber())}},WH=function(e,t,n,r,a,o){var i=n.items,u=n.maxCheckIndex;return t.reduce((function(t,n,s){if(!function(e,t,n,r,a,o,i,u){var s=n.items,l=n.types;return!(s.length<=a)&&(null===o||n.valueFieldName===o)&&r.every((function(n,r){var a=(0,p.Z)(n,2),o=a[0],c=a[1],h=s[o],f=l[r];return"string"==typeof c?h===c:3===f&&c.maybeBlankValue?i.getBlankValue(e,o,t,u)===c.strVal:h===(2===f?c.dateVal:c.strVal)}))}(e,s,n,i,u,r,a,o))return t;if(-1===t.index)return t.index=s,t.level=n.level,t.isSubTotal=n.isSubTotal,t.isConflict=!1,t;var l=t.isSubTotal,c=n.isSubTotal;if(l&&!c)return t;if(!l&&!c)return t.isConflict=!0,t;var h=t.level,f=n.level;return c&&!l||f<h?(t.index=s,t.level=n.level,t.isSubTotal=!0,t.isConflict=!1,t):f===h?(t.isConflict=!0,t):t}),{index:-1,level:1/0,isSubTotal:!1,isConflict:!1})},jH=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e,t,n){for(var r,a=arguments.length,o=new Array(a>3?a-3:0),i=3;i<a;i++)o[i-3]=arguments[i];if(o.length%2!=0)return ut.REF_ERR_VAR;var u=n.getRef(),s=u.sheet();if(!s)return ut.REF_ERR_VAR;var l=_k(s,u.rowFrom(),u.colFrom(),u.rowCount(),u.colCount());if(l.length<1)return ut.REF_ERR_VAR;var c=null===(r=s.embeddedBlocksModel)||void 0===r?void 0:r.getBlocksMap();if(!c)return ut.REF_ERR_VAR;var h=l.reduce((function(e,t){var n,r=null===(n=c[t])||void 0===n?void 0:n.position;if(!r)return e;var a=r.row,o=r.col,i=e.row,u=e.col;return(o<u||o===u&&a<i)&&(e.pivotTable=t,e.row=a,e.col=o),e}),{pivotTable:"",row:1/0,col:1/0}).pivotTable;if(!h)return ut.REF_ERR_VAR;var f=s.getPivotTableManager(),d=f.getPivotInfoByName(h);if((null==d?void 0:d.errorState)!==Zf.None)return ut.REF_ERR_VAR;var v=f.getViewDataModelByName(h);if(!v)return ut.REF_ERR_VAR;var g=v.valueFieldInfos;if(!g||g.length<1)return ut.REF_ERR_VAR;var m=t.getValue(),p=g.find((function(e){return e.cacheName===m||e.fieldName===m}));if(!p)return ut.REF_ERR_VAR;var y=p.fieldName,C=LH(o);if(!C)return ut.REF_ERR_VAR;var _,R=v.col,w=R.pivotInfos,k=R.colHeaderRowMap,S=v.row,E=S.pivotInfos,T=S.rowHeaderColMap,A=k&&kt.bI in k?"col":T&&kt.bI in T?"row":null,I={items:[],maxCheckIndex:-1},b={items:[],maxCheckIndex:-1},F=_n(C.keys());try{for(F.s();!(_=F.n()).done;){var M=_.value,V=C.get(M);if(k&&M in k)UH(b,k[M]-1,V);else{if(!T||!(M in T))return ut.REF_ERR_VAR;UH(I,T[M],V)}}}catch(e){F.e(e)}finally{F.f()}var N=new BH(s,d.contentRange,v),O=WH("row",E,I,"row"===A?y:null,N,e);if(O.isConflict)return PH();var x=WH("col",w,b,"col"===A?y:null,N,e);if(x.isConflict)return PH();var Z=O.index,D=x.index;if(-1===Z||-1===D)return PH();var P=v.col.range.rowCount+Z,L=v.row.range.colCount+D;return new ut.NumberVar(Number(v.getCellValue(P,L)))}}]),t}(gC("GETPIVOTDATA",2,256,2,tC,[{type:nC},iw.SHEET_REF,{type:nC},{type:nC|tC|eC}])),zH=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e,t){var n=t.getValue();if(n<=0)return $_(this.name,1,n,0);var r=function(e){return 65536<=e?[65535&(55296+((e-65536|0)>>10&1023)|0),65535&(56320+(1023&(e-65536|0))|0)]:[65535&e]}(n),a=String.fromCharCode.apply(null,r);return new ut.StringVar(a)}}]),t}(gC("UNICHAR",1,0,0,nC,[{type:tC}])),GH=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e,t){var n=t.getValue(),r=n.length;if(0===r)return we.d$b[we.O6N.PARAMETER_SHOULD_BE_NON_BLANK]({funcName:this.name,index:1});var a=n.charCodeAt(0),o=n.charCodeAt(1),i=vH(a)&&1<r&&gH(o)?mH(a,o):a;return new ut.NumberVar(i)}}]),t}(gC("UNICODE",1,0,0,tC,[{type:nC}]));!function(e){e.And="AND",e.Or="OR"}(OH||(OH={}));var JH=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e,t,n,r){if(t.rowCount()<2)return UR(this.name);if(r.rowCount()<2)return we.d$b[we.O6N.CONDITION_ROW_MORE_THEN_TO]({funcName:this.name,value:2});for(var a=new Array(t.colCount()),o=0;o<t.colCount();o++)a[o]=t.getVarByPos(0,o,e);var i=function(e,t){for(var n=[],r=0;r<t.length;r++){for(var a=[],o=0;o<t[r].length;o++){var i=(0,p.Z)(t[r][o],2),u=i[0],s=i[1];a.push(new qH(e,s,u))}n.push(new $H("AND",a))}return new $H("OR",n)}(e,function(e,t,n){for(var r=[],a=t.rowCount(),o=t.colCount(),i=1;i<a;i++){for(var u=[],s=0;s<o;s++){var l,c=t.getVarByPos(i,s,e);if(!c.isNull()&&""!==c.getValue()){var h=YH((null===(l=t.getValueByPos(0,s,e))||void 0===l?void 0:l.toString())||"",n,e);u.push([h,c])}}r.push(u)}return r}(e,r,a)),u=YH(n.getValue(),a,e);if(null===u)return n.isString()?nR(this.name,'"'.concat(n.getValue().toString(),'"'),2,a.map((function(e){return e.getValue().toString()}))):gR(this.name,2,n.getValue(),1,t.colCount());var s=function(e,t,n){for(var r=new Array(e.rowCount()),a=1;a<e.rowCount();a++){for(var o=new Array(e.colCount()),i=0;i<e.colCount();i++)o[i]=e.getVarByPos(a,i,n);t.exec(o)&&(r[a]=o)}return r}(t,i,e);return this.execute(function(e,t,n){return function(){var r=[];return t.forEach((function(t){return r.push(t[n].iter(e))})),r}}(e,s,u),e)}}]),t}(gC("",3,0,0,tC,[iw.MATRIX_AND_SHEET_REF,{type:tC|nC},iw.MATRIX_AND_SHEET_REF])),qH=function(){function e(t,n,r){if((0,y.Z)(this,e),this.fieldIndex=r,n.isString()){var a=n.getValue();!a.match(/^(<>|=|[><]=?)/)&&isNaN(Number(a))&&(n=new ut.StringVar(a+"*"))}this.criteriaFunc=(0,Mt.buildCriteria)(t,n)}return(0,C.Z)(e,[{key:"exec",value:function(e){return null!==this.fieldIndex&&this.criteriaFunc(e[this.fieldIndex])}}]),e}(),$H=function(){function e(t,n){(0,y.Z)(this,e),this.op=t,this.nodes=n}return(0,C.Z)(e,[{key:"exec",value:function(e){switch(this.op){case"AND":return this.nodes.every((function(t){return t.exec(e)}));case"OR":return this.nodes.some((function(t){return t.exec(e)}))}}}]),e}();function YH(e,t,n){if("number"==typeof e)return 0<e&&e<=t.length?e-1:null;e=e.toLowerCase();var r=t.findIndex((function(t){var r=t.toStringVar(n.service).getValue();return null===r?-1:r.toLowerCase()===e}));return-1===r?null:r}function KH(e){var t,n=0,r=0,a=_n(e());try{for(a.s();!(t=a.n()).done;){var o=t.value,i=null;if(o.exitWhen((function(e){var t=e.isError();return t&&(i=e),t})).filter((function(e){return e.isNumber()})).forEach((function(e){n+=e.getValue(),r++})),i)return i}}catch(e){a.e(e)}finally{a.f()}return 0===r?PR(""):new ut.NumberVar(n/r)}function XH(e,t){var n=KH(t);if(n.isError())return n;var r,a=n.getValue(),o=0,i=0,u=_n(t());try{for(u.s();!(r=u.n()).done;){r.value.exitWhen((function(e){return e.isError()})).filter((function(e){return e.isNumber()})).forEach((function(e){return i+=Math.pow(e.getValue()-a,2),o++,!1}))}}catch(e){u.e(e)}finally{u.f()}var s=e?o:o-1;return s<1?PR(""):(i/=s,new ut.NumberVar(i))}function QH(e){var t,n=0,r=_n(e());try{for(r.s();!(t=r.n()).done;){t.value.filter((function(e){return e.isNumber()})).forEach((function(){return n++}))}}catch(e){r.e(e)}finally{r.f()}return new ut.NumberVar(n)}var eW=function(e){function t(){var e;return(0,y.Z)(this,t),(e=(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))).name="DAVERAGE",e}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"execute",value:function(e){var t,n,r=KH(e);return r.isError()&&null!==(t=r.info)&&void 0!==t&&t.args&&Object.prototype.hasOwnProperty.call(null===(n=r.info)||void 0===n?void 0:n.args,"funcName")&&(r.info.args.funcName=this.name),r}}]),t}(JH),tW=function(e){function t(){var e;return(0,y.Z)(this,t),(e=(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))).name="DCOUNT",e}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"execute",value:function(e){return QH(e)}}]),t}(JH),nW=function(e){function t(){var e;return(0,y.Z)(this,t),(e=(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))).name="DCOUNTA",e}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"execute",value:function(e){return function(e){var t,n=0,r=_n(e());try{for(r.s();!(t=r.n()).done;)t.value.filter((function(e){return!e.isNull()})).forEach((function(){return n++}))}catch(e){r.e(e)}finally{r.f()}return new ut.NumberVar(n)}(e)}}]),t}(JH),rW=function(e){function t(){var e;return(0,y.Z)(this,t),(e=(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))).name="DPRODUCT",e}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"execute",value:function(e,t){return function(e,t){var n,r=1,a=!1,o=_n(t());try{for(o.s();!(n=o.n()).done;){var i=n.value.map((function(t){return t.isError()||t.isNull()||t.isString()?t:t.toNumberVar(e.service)})).filter((function(e){return!e.isNull()&&!e.isString()})).first_if((function(e){return!!e.isError()||(r*=e.getValue(),a=!0,!1)}));if(i)return i}}catch(e){o.e(e)}finally{o.f()}return new ut.NumberVar(a?r:0)}(t,e)}}]),t}(JH),aW=function(e){function t(){var e;return(0,y.Z)(this,t),(e=(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))).name="DSTDEV",e}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"execute",value:function(e){var t,n,r=XH(!1,e);if(r.isError()&&null!==(t=r.info)&&void 0!==t&&t.args&&Object.prototype.hasOwnProperty.call(null===(n=r.info)||void 0===n?void 0:n.args,"funcName"))return r.info.args.funcName=this.name,r;if(!r.isNumber())return r;var a=Math.sqrt(r.getValue());return new ut.NumberVar(a)}}]),t}(JH),oW=function(e){function t(){var e;return(0,y.Z)(this,t),(e=(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))).name="DSTDEVP",e}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"execute",value:function(e){var t,n,r=XH(!0,e);if(r.isError()&&null!==(t=r.info)&&void 0!==t&&t.args&&Object.prototype.hasOwnProperty.call(null===(n=r.info)||void 0===n?void 0:n.args,"funcName"))return r.info.args.funcName=this.name,r;if(!r.isNumber())return r;var a=Math.sqrt(r.getValue());return new ut.NumberVar(a)}}]),t}(JH),iW=function(e){function t(){var e;return(0,y.Z)(this,t),(e=(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))).name="DGET",e}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"execute",value:function(e){var t,n=[],r=_n(e());try{for(r.s();!(t=r.n()).done;){t.value.forEach((function(e){e.isPrimitive()&&n.push(e)}))}}catch(e){r.e(e)}finally{r.f()}return 0===n.length?we.d$b[we.O6N.MATCH_NOT_AVAILABLE]({funcName:"DGET"}):n.length>1?we.d$b[we.O6N.MORE_THEN_ONE_MATCH_FOUND]({funcName:"DGET"}):n[0]}}]),t}(JH),uW=function(e){function t(){var e;return(0,y.Z)(this,t),(e=(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))).name="DMAX",e}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"execute",value:function(e){return function(e){var t,n=0,r=!1,a=_n(e());try{for(a.s();!(t=a.n()).done;){var o=t.value,i=void 0;if(o.exitWhen((function(e){var t=e.isError();return t&&(i=e),t})).filter((function(e){return e.isNumber()})).forEach((function(e){(!1===r||n<e.getValue())&&(n=e.getValue(),r=!0)})),i)return i}}catch(e){a.e(e)}finally{a.f()}return new ut.NumberVar(n)}(e)}}]),t}(JH),sW=function(e){function t(){var e;return(0,y.Z)(this,t),(e=(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))).name="DMIN",e}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"execute",value:function(e){return function(e){var t,n=0,r=!1,a=_n(e());try{for(a.s();!(t=a.n()).done;){var o=t.value,i=null;if(o.exitWhen((function(e){var t=e.isError();return t&&(i=e),t})).filter((function(e){return e.isNumber()})).forEach((function(e){(!1===r||n>e.getValue())&&(n=e.getValue(),r=!0)})),i)return i}}catch(e){a.e(e)}finally{a.f()}return new ut.NumberVar(n)}(e)}}]),t}(JH),lW=function(e){function t(){var e;return(0,y.Z)(this,t),(e=(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))).name="DSUM",e}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"execute",value:function(e){return function(e){var t,n=0,r=_n(e());try{for(r.s();!(t=r.n()).done;){var a=t.value,o=null;if(a.exitWhen((function(e){return!!e.isError()&&(o=e,!0)})).forEach((function(e){e.isNumber()&&(n+=e.getValue())})),o)return o}}catch(e){r.e(e)}finally{r.f()}return new ut.NumberVar(n)}(e)}}]),t}(JH),cW=function(e){function t(){var e;return(0,y.Z)(this,t),(e=(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))).name="DVAR",e}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"execute",value:function(e){var t,n,r=XH(!1,e);return r.isError()&&null!==(t=r.info)&&void 0!==t&&t.args&&Object.prototype.hasOwnProperty.call(null===(n=r.info)||void 0===n?void 0:n.args,"funcName")&&(r.info.args.funcName=this.name),r}}]),t}(JH),hW=function(e){function t(){var e;return(0,y.Z)(this,t),(e=(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))).name="DVARP",e}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"execute",value:function(e){var t,n,r=XH(!0,e);return r.isError()&&null!==(t=r.info)&&void 0!==t&&t.args&&Object.prototype.hasOwnProperty.call(null===(n=r.info)||void 0===n?void 0:n.args,"funcName")&&(r.info.args.funcName=this.name),r}}]),t}(JH),fW=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e,t){var n=t.getValue(),r=(0,Mt.normsdistCdf)(n)-.5;return new ut.NumberVar(r)}}]),t}(gC("GAUSS",1,0,0,tC,[{type:tC}])),dW=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e,t,n,r){var a,o=t.getValue(),i=n.getValue(),u=r.getValue();return o<=0?q_(this.name,o,1,0):u<=0?q_(this.name,u,3,0):(a=(0,Mt.normsdistCdf)((Math.log(o)-i)/u),new ut.NumberVar(a))}}]),t}(gC("LOGNORMDIST",3,0,0,tC,[{type:tC},{type:tC},{type:tC}])),vW=function(e){function t(){var e;return(0,y.Z)(this,t),(e=(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))).name="LOGNORM.DIST",e}return(0,g.Z)(t,e),t}(dW),gW=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e,t,n,r){var a=t.getValue(),o=n.getValue(),i=r.getValue();if(a<=0||a>=1)return z_(this.name,1,a,0,1);if(i<=0)return q_(this.name,i,3,0);var u=(0,Mt.normInv)(a,0,1),s=Math.exp(o+i*u);return s>=ut.MAX_NUMBER_VALUE?G_:new ut.NumberVar(s)}}]),t}(gC("LOGINV",3,0,0,tC,[{type:tC},{type:tC},{type:tC}])),mW=function(e){function t(){var e;return(0,y.Z)(this,t),(e=(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))).name="LOGNORM.INV",e}return(0,g.Z)(t,e),t}(gW),pW=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e,t,n,r){var a=t.getValue(),o=n.getValue(),i=r.getValue();if(a<=0||a>=1)return z_(this.name,1,a,0,1);if(i<=0)return q_(this.name,i,3,0);var u=(0,Mt.normInv)(a,o,i);return u===ut.MAX_NUMBER_VALUE?G_:new ut.NumberVar(u)}}]),t}(gC("NORMINV",3,0,0,tC,[{type:tC},{type:tC},{type:tC}])),yW=function(e){function t(){var e;return(0,y.Z)(this,t),(e=(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))).name="NORM.INV",e}return(0,g.Z)(t,e),t}(pW);function CW(e,t){e=_W(e);var n=1;(t=_W(t))>(e-t|0)&&(t=e-t|0);for(var r=1;r<=t;r++)n*=(r+e-t|0)/r;return n}function _W(e){return 0|Math.max(Math.min(e,2147483647),-2147483648)}function RW(e,t,n,r){if(1029>=n){for(var a=0;e<=t;e=e+1|0)a+=CW(n,e)*Math.pow(r,e)*Math.pow(1-r,n-e|0);return a}var o,i=_W(n),u=_W(n*r),s=1,l=u<=t&&u>=e?1:0,c=1;for(o=u+1|0;o<=i&&1e-13<c;o=o+1|0)s+=c*=(i-o+1|0)*r/(o*(1-r)),o<=t&&o>=e&&(l+=c);for(c=1,o=u-1|0;o>=0&&1e-13<c;o=o-1|0)s+=c*=(o+1|0)*(1-r)/((i-o|0)*r),o<=t&&o>=e&&(l+=c);return l/s}function wW(e,t,n,r){if(e.value<0)return H_(r,e.index);var a=1e10;return t.value>a||t.value<0?j_(r,t.index,t.value,0,a):t.value<e.value?mR(r,e.value,e.index,t.index,t.value):n.value<0||n.value>1?j_(r,n.index,n.value,0,1):null}var kW=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e,t,n,r,a){var o=t.getValue(),i=n.getValue(),u=r.getValue(),s=wW({index:1,value:o},{index:2,value:i},{index:3,value:u},this.name);return s||(s=RW(a.getValue()?0:_W(o),_W(o),_W(i),u),new ut.NumberVar(s))}}]),t}(gC("BINOMDIST",4,0,0,nC,[{type:tC},{type:tC},{type:tC},{type:rC}])),SW=function(e){function t(){var e;return(0,y.Z)(this,t),(e=(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))).name="BINOM.DIST",e}return(0,g.Z)(t,e),t}(kW),EW=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e,t,n,r,a){var o=t.getValue(),i=n.getValue(),u=r.getValue(),s=wW({index:3,value:u},{index:1,value:o},{index:2,value:i},this.name),l=(null==a?void 0:a.getValue())||u;return!s&&(l>o||l<u)&&(s=j_(this.name,4,l,u,o)),s||(s=RW(_W(u),_W(l),_W(o),i),new ut.NumberVar(s))}}]),t}(gC("BINOM.DIST.RANGE",3,1,0,nC,[{type:tC},{type:tC},{type:tC},{type:tC}])),TW=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e,t,n,r){var a=t.getValue();if(a<0)return H_(this.name,1);var o=n.getValue();if(0>=o||1<=o)return z_(this.name,2,o,0,1);var i=r.getValue();if(0>=i||1<=i)return z_(this.name,3,i,0,1);for(var u,s=_W(a),l=0,c=s;l<c;)RW(0,_W(u=l+((c-l|0)/2|0)|0),s,o)>=i?c=u:l=u+1|0;return new ut.NumberVar(l)}}]),t}(gC("CRITBINOM",3,0,0,nC,[{type:tC},{type:tC},{type:tC}])),AW=function(e){function t(){var e;return(0,y.Z)(this,t),(e=(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))).name="BINOM.INV",e}return(0,g.Z)(t,e),t}(TW),IW=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e,t,n,r,a){var o=t.getValue(),i=n.getValue(),u=r.getValue(),s=o+i,l=this.getErrorBounding(o,i,u,s);if(l)return l;var c=u*RW(_W(i-1),_W(i-1),_W(s-1),u);return new ut.NumberVar(c)}},{key:"getErrorBounding",value:function(e,t,n,r){var a=1e10;return e>a||e<0?j_(this.name,1,e,0,a):t>a||t<1?j_(this.name,2,t,1,a):r>a?we.d$b[we.O6N.NUM_PARAMETER_SUM_EXCEED_LIMIT]({funcName:this.name,index:1,secondArgIndex:2,value:r,upperBound:a}):n<0||n>1?j_(this.name,3,t,0,1):null}}]),t}(gC("NEGBINOMDIST",3,0,0,nC,[{type:tC},{type:tC},{type:tC}])),bW=function(e){function t(){var e;return(0,y.Z)(this,t),(e=(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))).name="NEGBINOM.DIST",e.operands=4,e.paramsDesc=[{type:tC},{type:tC},{type:tC},{type:rC}],e}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e,t,n,r,a){var o=t.getValue(),i=n.getValue(),u=r.getValue(),s=a.getValue(),l=o+i,c=this.getErrorBounding(o,i,u,l);if(c)return c;var h=s?1-(0,Mt.betaDistCdf)(1-u,o+1,i):u*RW(_W(i-1),_W(i-1),_W(l-1),u);return new ut.NumberVar(h)}}]),t}(IW),FW=function(e,t,n,r){var a=arguments.length>4&&void 0!==arguments[4]&&arguments[4],o=MW(e,t,n);if(o instanceof ut.ErrorVar)return o;var i=o.sumx,u=o.sumy,s=o.sumx2,l=o.sumy2,c=o.sumxy,h=o.count;if(0===h)return jR(r);if(1===h||h*s-i*i==0||h*l-u*u==0)return PR(r);var f=(h*c-i*u)/Math.sqrt((h*s-i*i)*(h*l-u*u));return new ut.NumberVar(a?f*f:f)};function MW(e,t,n){for(var r=0,a=0,o=0,i=0,u=0,s=0,l=0;l<e.size();l++){var c=e.nth(l,n);if(c.isError())return c;var h=t.nth(l,n);if(h.isError())return h;if(c.isNumber()&&h.isNumber()){var f=c.getValue(),d=h.getValue();r+=f,a+=d,o+=f*f,i+=d*d,u+=f*d,s++}}return{sumx:r,sumy:a,sumx2:o,sumy2:i,sumxy:u,count:s}}var VW=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e,t,n){var r,a,o=t.size(),i=n.size();if(o!==i)return FR(this.name,i,o);var u=FW(t,n,e,this.name);return u.isError()&&null!==(r=u.info)&&void 0!==r&&r.args&&Object.prototype.hasOwnProperty.call(null===(a=u.info)||void 0===a?void 0:a.args,"funcName")&&(u.info.args.funcName=this.name),u}}]),t}(gC("CORREL",2,0,0,tC,[{type:iC},{type:iC}])),NW=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e,t,n){var r,a;if(1===t.size()&&t.nth(0,e).isNull()||1===n.size()&&n.nth(0,e).isNull())return UR(this.name);if(t.size()!==n.size())return FR(this.name,t.size(),n.size());var o=(0,Mt.covarVar)(t,n,e,!0);return o.isError()&&null!==(r=o.info)&&void 0!==r&&r.args&&Object.prototype.hasOwnProperty.call(null===(a=o.info)||void 0===a?void 0:a.args,"funcName")&&(o.info.args.funcName=this.name),o}}]),t}(gC("COVARIANCE.S",2,0,0,tC,[{type:iC},{type:iC}])),OW=function(e){function t(){var e;return(0,y.Z)(this,t),(e=(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))).name="COVARIANCE.P",e}return(0,g.Z)(t,e),t}(Mt.COVARFunc),xW=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e,t,n){var r=t.getValue(),a=n.getValue();if(r<0)return H_(this.name,1);if(a<0)return H_(this.name,2);var o=Math.floor(r+a);if(o-1>1029)return function(e,t,n,r,a){return we.d$b[we.O6N.NUM_PARAMETER_SUM_EXCEED_LIMIT]({funcName:e,index:t,secondArgIndex:n,value:r,upperBound:a})}(this.name,1,2,o,1031);var i=(0,Mt.combin)(o-1,Math.floor(r-1));return new ut.NumberVar(i)}}]),t}(gC("COMBINA",2,0,0,tC,[{type:tC},{type:tC}])),ZW=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e,t,n){var r=t.getValue(),a=r.length;if(255<a)return function(e,t,n,r){return ut.tractorErrorVarCreators[ut.ErrorCode.STRING_TOO_LONG]({funcName:e,index:t,textLength:n,maxTextLength:r})}(this.name,1,a,255);if(0===a)return new ut.NumberVar(0);var o=Math.floor(n.getValue());if(o<2||o>36)return j_(this.name,2,o,2,36);if("-"===r[0])return rR(this.name,r,String(o));for(var i=0;i<a&&" "===r[i];)i++;var u=0;if(i===a)return new ut.NumberVar(0);for(var s=1,l=a-1;l>=i;l--){var c=32|r.charCodeAt(l),h=c-97>=0?c-87:c-48;if(h<0||h>=o)return rR(this.name,r,String(o));u+=h*s,s*=o}return new ut.NumberVar(u)}}]),t}(gC("DECIMAL",2,0,0,tC,[{type:nC},{type:tC}])),DW=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e,t,n){var r=t.size(),a=n.size();if(r!==a)return FR(this.name,a,r);var o=MW(t,n,e);if(o instanceof ut.ErrorVar)return o;var i=o.sumx,u=o.sumy,s=o.sumy2,l=o.sumxy,c=o.count;return 0===c?WR(this.name):1===c||c*s-u*u==0?PR(this.name):new ut.NumberVar((c*l-i*u)/(c*s-u*u))}}]),t}(gC("SLOPE",2,0,0,tC,[{type:iC},{type:iC}])),PW=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e,t,n){var r=n.size(),a=t.size();if(a!==r)return FR(this.name,r,a);var o=MW(n,t,e);if(o instanceof ut.ErrorVar)return o;var i=o.sumx,u=o.sumy,s=o.sumx2,l=o.sumy2,c=o.sumxy,h=o.count;if(h<=2||h*s-i*i==0)return PR(this.name);var f=Math.sqrt((h*l-u*u-(h*c-u*i)*(h*c-u*i)/(h*s-i*i))/(h*(h-2)));return new ut.NumberVar(f)}}]),t}(gC("STEYX",2,0,0,tC,[{type:iC},{type:iC}])),LW=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e,t,n){var r,a,o=t.size(),i=n.size();if(o!==i)return FR(this.name,i,o);var u=FW(t,n,e,this.name);return u.isError()&&null!==(r=u.info)&&void 0!==r&&r.args&&Object.prototype.hasOwnProperty.call(null===(a=u.info)||void 0===a?void 0:a.args,"funcName")&&(u.info.args.funcName=this.name),u}}]),t}(gC("PEARSON",2,0,0,tC,[{type:iC},{type:iC}])),BW=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e,t,n){var r,a,o=t.size(),i=n.size();if(o!==i)return FR(this.name,i,o);var u=FW(t,n,e,this.name,!0);return u.isError()&&null!==(r=u.info)&&void 0!==r&&r.args&&Object.prototype.hasOwnProperty.call(null===(a=u.info)||void 0===a?void 0:a.args,"funcName")&&(u.info.args.funcName=this.name),u}}]),t}(gC("RSQ",2,0,0,tC,[{type:iC},{type:iC}])),UW=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e,t,n,r){var a=t.getValue(),o=n.size(),i=r.size();if(o!==i)return FR(this.name,i,o);if(1===o||1===i)return PR(this.name);for(var u=0,s=0,l=0,c=0,h=0,f=0;f<o;f++){var d=n.nth(f,e);if(d.isError())return d;var v=r.nth(f,e);if(v.isError())return v;if(d.isNumber()&&v.isNumber()){var g=v.getValue(),m=d.getValue();u+=g,s+=m,l+=g*g,c+=g*m,h++}if(0===h)return PR(this.name)}if(h*l==u*u)return PR(this.name);var p=(h*c-s*u)/(h*l-u*u);return new ut.NumberVar(s/h-p*(u/h)+p*a)}}]),t}(gC("FORECAST.LINEAR",3,0,0,tC,[{type:tC},{type:iC},{type:iC}])),HW=function(e){function t(){var e;return(0,y.Z)(this,t),(e=(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))).name="FORECAST",e}return(0,g.Z)(t,e),t}(UW),WW=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e,t,n,r){var a=t.getValue();if(a<0)return K_(this.name,a,1,0);var o=Math.trunc(n.getValue());if(o<1)return K_(this.name,o,2,1);var i=Math.trunc(r.getValue());if(i<1)return K_(this.name,i,3,1);var u=jW(a,o,i);return new ut.NumberVar(u)}}]),t}(gC("F.DIST.RT",3,0,0,tC,[{type:tC},{type:tC},{type:tC}]));function jW(e,t,n){return 1-(0,Mt.betaDistCdf)(t*e/(t*e+n),.5*t,.5*n)}var zW,GW=function(e){function t(){var e;return(0,y.Z)(this,t),(e=(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))).name="FDIST",e}return(0,g.Z)(t,e),t}(WW),JW=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e,t,n,r,a){var o=t.getValue();if(o<0)return K_(this.name,o,1,0);var i=Math.trunc(n.getValue());if(i<1)return K_(this.name,i,2,1);var u=Math.trunc(r.getValue());if(u<1)return K_(this.name,u,3,1);var s=0;return s=a.getValue()?1-(0,Mt.betaDistCdf)(u/(u+i*o),u/2,i/2):Math.pow(i/u,i/2)*Math.pow(o,i/2-1)/(Math.pow(1+o*i/u,(i+u)/2)*(0,Mt.getBetaOrLogbeta)(!0,i/2,u/2)),isFinite(s)?new ut.NumberVar(s):G_}}]),t}(gC("F.DIST",4,0,0,tC,[{type:tC},{type:tC},{type:tC},{type:rC}])),qW=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e,t,n,r){var a=t.getValue();if(a<0)return K_(this.name,a,1,0);if(a>1)return X_(this.name,a,1,1);var o=Math.trunc(n.getValue());if(o<1)return K_(this.name,o,2,1);var i=Math.trunc(r.getValue());if(i<1)return K_(this.name,i,3,1);var u=(0,Mt.betaInv)(1-(1-a),i/2,o/2,0,1);return new ut.NumberVar(i/o*(1/u-1))}}]),t}(gC("F.INV.RT",3,0,0,tC,[{type:tC},{type:tC},{type:tC}])),$W=function(e){function t(){var e;return(0,y.Z)(this,t),(e=(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))).name="FINV",e}return(0,g.Z)(t,e),t}(qW),YW=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e,t,n,r){var a=t.getValue();if(a<0)return K_(this.name,a,1,0);if(a>1)return X_(this.name,a,1,1);var o=Math.trunc(n.getValue());if(o<1)return K_(this.name,o,2,1);var i=Math.trunc(r.getValue());if(i<1)return K_(this.name,i,3,1);var u=(0,Mt.betaInv)(1-a,i/2,o/2,0,1);return new ut.NumberVar(i/o*(1/u-1))}}]),t}(gC("F.INV",3,0,0,tC,[{type:tC},{type:tC},{type:tC}])),KW=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e,t,n){var r=Sw(t.iter(e));if(r instanceof ut.ErrorVar)return r;var a=Sw(n.iter(e));if(a instanceof ut.ErrorVar)return a;if(1===r.length||1===r.length)return PR(this.name);var o=Ew(r),i=o.N-1,u=o.Q/(o.N-1);if(0===i||0===u)return PR(this.name);var s=Ew(a),l=s.N-1,c=s.Q/(s.N-1);if(0===l||0===c)return PR(this.name);var h=2*(1-jW(u/c,i,l));return h>1&&(h=2-h),new ut.NumberVar(h)}}]),t}(gC("F.TEST",2,0,0,tC,[{type:iC},{type:iC}])),XW=function(e){function t(){var e;return(0,y.Z)(this,t),(e=(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))).name="FTEST",e}return(0,g.Z)(t,e),t}(KW),QW=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e,t,n,r){var a=Sw(t.iter(e));if(a instanceof ut.ErrorVar)return a;if(0===a.length)return WR(this.name);if(1===a.length)return PR(this.name);var o=n.getValue(),i=r&&r.getValue();if(i<=0)return q_(this.name,i,3,0);var u=Ew(a),s=u.N,l=u.Q,c=u.M,h=u.sum,f=u.sum2;if(0===l)return PR(this.name);var d=void 0!==i?i:Math.sqrt((s*f-h*h)/(s*(s-1)));return new ut.NumberVar(1-(0,Mt.normsdistCdf)((c-o)/(d/Math.sqrt(s))))}}]),t}(gC("Z.TEST",2,1,0,tC,[{type:iC},{type:tC},{type:tC,default:void 0}])),ej=function(e){function t(){var e;return(0,y.Z)(this,t),(e=(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))).name="ZTEST",e}return(0,g.Z)(t,e),t}(QW),tj=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e,t,n,r,a){var o=t.size(),i=n.size();if(o!==i)return FR(this.name,i,o);for(var u=r.getValue(),s=void 0===a?u:a.getValue(),l=0,c=0,h=0,f=0;f<t.size();f++){var d=t.nth(f,e);if(d.isError())return d;var v=n.nth(f,e);if(v.isError())return v;d.isNumber()&&v.isNumber()&&(u<=d.getValue()&&d.getValue()<=s&&(l+=v.getValue()),c+=v.getValue(),h++)}return h<=0?jR(this.name):1!==(0,ut.convertTo15Digits)(c)?we.d$b[we.O6N.TOTAL_VALUE_SHOULD_BE_EQUAL_TO]({funcName:this.name,index:2,errorValue:c,correctValue:1}):new ut.NumberVar(l)}}]),t}(gC("PROB",3,1,0,tC,[{type:iC},{type:iC},{type:tC},{type:tC,default:void 0}])),nj=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e,t,n){var r,a=1-n.getValue();if(a>=1||a<=0)return z_(this.name,2,a,0,1);var o=function(){return[t.iter(e)]},i=QH(o).getValue();if(i<=1)return PR(this.name);var u=(0,Mt.varianceVar)(!1,o);if(u.isError()&&null!==(r=u.info)&&void 0!==r&&r.args&&(u.info.args.funcName=this.name),!u.isNumber())return u;var s=Math.sqrt(u.getValue());return s<=0?HR(this.name):new ut.NumberVar(s*_U(a,i-1,2)/Math.sqrt(i))}}]),t}(gC("MARGINOFERROR",2,0,0,tC,[{type:iC},{type:tC}])),rj=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e,t){var n=t.getValue();return new ut.NumberVar((0,Mt.normdistPdf)(n,0,1))}}]),t}(gC("PHI",1,0,0,tC,[{type:tC}])),aj=function(e,t,n){var r=n.ref.sheet();if(!r||!r.parent.aiManager)return ut.RUNTIME_ERR_VAR;for(var a=r.parent.aiManager,o=r.id(),i=[],u=0;u<(arguments.length<=3?0:arguments.length-3);u++){var s=u+3<3||arguments.length<=u+3?void 0:arguments[u+3];if(lx(s)){for(var c=[],h=s.rowCount(),f=s.colCount(),d=0;d<h;d++){for(var v=0;v<f;v++){var g=s.getVarByPos(d,v,n);if(g.isError())return g;var m=g.isNull()?"":sx(g,n,"");c.push("| ".concat(m," ")),v===f-1&&c.push("|")}d!==h-1&&c.push("\n")}i.push('"""'.concat(c.join(""),'"""'))}else{var p=s.getVar(n);if(p.isError())return p;var y=sx(s,n);i.push(s.isPrimitive()?y:'"""'.concat(y,'"""'))}}var C=i.join("");if(dx(C))return _x(e);var _=(0,l.Z)({user_input:{user_input:C},action_type:t,sheet_id:o,funcName:e},we.nbU,Cx(r.getVar(n.ref.rowFrom(),n.ref.colFrom())));return n.info.customData||(n.info.customData=[]),n.info.customData.push(Ax(_)),ix(a,_,r.formatterService,void 0,n)},oj=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),r=1;r<t;r++)n[r-1]=arguments[r];return aj.apply(void 0,[this.name,"sheet_textual_nlp",e].concat(n))}}]),t}(gC("AI_WRITE",1,255,1,nC,[{type:nC|iC|tC}])),ij=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),r=1;r<t;r++)n[r-1]=arguments[r];return aj.apply(void 0,[this.name,"sheet_textual_nlp_ds",e].concat(n))}}]),t}(gC("AI_DEEPSEEK_WRITE",1,255,1,nC,[{type:nC|iC|tC}])),uj=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),r=1;r<t;r++)n[r-1]=arguments[r];return aj.apply(void 0,[this.name,"enterprise_qa",e].concat(n))}}]),t}(gC("AI_ASK",1,255,1,nC,[{type:nC|iC|tC}])),sj=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e){var t=e.ref.sheet();if(!t||!t.parent.aiManager)return ut.RUNTIME_ERR_VAR;for(var n=t.parent.aiManager,r=t.id(),a=[],o=0;o<(arguments.length<=1?0:arguments.length-1);o++){var i=o+1<1||arguments.length<=o+1?void 0:arguments[o+1];if(lx(i))return fx();var u=i.getVar(e);if(u.isError())return u;a.push(sx(i,e))}var s=a.join(",");if(dx(s))return _x(this.name);var c=(0,l.Z)({user_input:{user_input:s},action_type:"sheet_import_data",sheet_id:r,funcName:this.name},we.nbU,Cx(t.getVar(e.ref.rowFrom(),e.ref.colFrom())));return e.info.customData||(e.info.customData=[]),e.info.customData.push(Ax(c)),ix(n,c,t.formatterService,(function(e){var r=e;return 0!==r.status?Promise.resolve(n.statusNot0Err):tx(r.text,t).then((function(e){return Array.isArray(e)?new Ru(e):ox({text:"AI_IMPORTDATA parse data to JSON failed"})}))}),e)}}]),t}(gC("AI_IMPORTDATA",1,256,1,fC|iC|lC,[{type:iC|nC}]));sj=Gi([cc("AI_IMPORTDATA")],sj),function(e){e[e.first=0]="first",e[e.second=1]="second",e[e.third=2]="third"}(zW||(zW={}));var lj=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:10,t=[],n=[],r=[];return{add:{addExampleInputList:function(n){var r=Array.isArray(n)?n:[n];t.length<e&&t.push.apply(t,(0,m.Z)(r))},addExampleOutputList:function(e){var r=Array.isArray(e)?e:[e];n.length<t.length&&n.push.apply(n,(0,m.Z)(r))},addTargetInputList:function(e){var t=Array.isArray(e)?e:[e];r.push.apply(r,(0,m.Z)(t))}},getState:function(){return{exampleInputList:t,exampleOutputList:n,targetInputList:r}}}},cj=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e){var t=e.ref.sheet();if(!t||!t.parent.aiManager)return ut.RUNTIME_ERR_VAR;for(var n=t.parent.aiManager,r=t.id(),a=lj(),o=0;o<(arguments.length<=1?0:arguments.length-1);o++){var s=o+1<1||arguments.length<=o+1?void 0:arguments[o+1];if(!cx(s)&&!hx(s))return zR(this.name);for(var c=void 0,h=s.iter(e).exitWhen((function(e){return!!e.isError()&&(c=e,!0)}));h.next(););if(c)return c;var f=sx(s,e,",",!1);o===zW.first?a.add.addExampleInputList(f):o===zW.second?a.add.addExampleOutputList(f):o===zW.third&&a.add.addTargetInputList(f)}var d=a.getState(),v=d.exampleInputList,g=d.exampleOutputList,p=d.targetInputList,y=(0,l.Z)({user_input:{example_input:JSON.stringify(v),example_output:JSON.stringify(g),target_input:JSON.stringify(p)},action_type:"sheet_infer",sheet_id:r,funcName:this.name},we.nbU,Cx(t.getVar(e.ref.rowFrom(),e.ref.colFrom())));return e.info.customData||(e.info.customData=[]),e.info.customData.push(Ax(y)),ix(n,y,t.formatterService,function(){var e=(0,u.Z)(i().mark((function e(t){var r,a;return i().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=[],e.prev=1,0===t.status){e.next=4;break}return e.abrupt("return",n.statusNot0Err);case 4:return e.next=6,jO(t.text);case 6:(a=e.sent).flat().slice(0,p.length),a.forEach((function(e){var t;if("number"==typeof(t="object"==(0,_.Z)(e)?e.value:e))r.push(new ut.NumberVar(t));else{var n=new ut.StringVar(String(t));r.push(n)}})),e.next=13;break;case 10:return e.prev=10,e.t0=e.catch(1),e.abrupt("return",we.d$b[we.O6N.NO_QUERY_OUTPUT]());case 13:return e.abrupt("return",new Ru((0,m.Z)(r.map((function(e){return[e]})))));case 14:case"end":return e.stop()}}),e,null,[[1,10]])})));return function(t){return e.apply(this,arguments)}}(),e)}}]),t}(gC("AI_INFER",3,0,1,iC|lC,[{type:iC}]));cj=Gi([cc("AI_INFER")],cj);var hj=3,fj=1e4,dj=new ut.ErrorVar(ut.ErrorType.REF,ut.ErrorConstant.REF,we.O6N.SHEET_AI_TAG_DATABASE_RANGE_ROW_LIMIT),vj=new ut.ErrorVar(ut.ErrorType.REF,ut.ErrorConstant.REF,we.O6N.SHEET_AI_TAG_DATABASE_RANGE_COL_LIMIT),gj=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"checkError",value:function(e,t){if(e.isRef()){var n=e.getRef();if(1!==n.rowCount()||1!==n.colCount())return null;var r=e.getVar(t);if(r.isError())return r}return null}},{key:"func",value:function(e,t,n,r,a){var o=e.ref.sheet();if(!o||!o.parent.aiManager)return ut.RUNTIME_ERR_VAR;var i=o.parent.aiManager;if(lx(t))return fx();for(var u=0,s=[t,n,r,a];u<s.length;u++){var c=s[u],h=this.checkError(c,e);if(h)return h}var f=[sx(t,e)],d=n.getValue();if("history"===o.parent.options.situation&&2===d)return fx();var v=function(e){switch(e){case 1:return"sheet_infer_tag";case 2:return"sheet_refer_tag";default:return"sheet_classify_tag"}}(d),g=o.id(),m=f.join(",");if(dx(m))return _x(this.name);var p=(0,l.Z)({user_input:{user_input:m},action_type:v,sheet_id:g,funcName:this.name},we.nbU,Cx(o.getVar(e.ref.rowFrom(),e.ref.colFrom())));if(2===d){var y,C;if(!r.isRef()&&!Nu(r))return ut.REF_ERR_VAR;if(r.isRef()){var _,R=r.getRef(),w=this.getTargetRangeInfo(e,R);if(w instanceof ut.ErrorVar)return w;C=w;var k=null===(_=R.sheet())||void 0===_?void 0:_.id(),S="".concat(k,"!").concat(R.toString({refStyle:"A1",ref:R}));if(!k||!S)return ut.REF_ERR_VAR;p.user_input.range=S}else{var E=this.getTargetImportRangeInfo(e,r);if(E instanceof ut.ErrorVar)return E;C=E,p.user_input.import_range=r.importRangeId}var T=null!==(y=a.getValue())&&void 0!==y?y:20;if(T<=0)return ut.VALUE_ERR_VAR;p.user_input.topk=String(T),p.cache_key=Ax(Object.assign({},p,{target_data:C}))}else{var A=sx(r,e);if(dx(A))return _x(this.name);p.user_input.tag_input=A}return e.info.customData||(e.info.customData=[]),e.info.customData.push(Ax(p)),ix(i,p,o.formatterService,void 0,e)}},{key:"getDataRowCount",value:function(e,t,n,r,a,o){if(a>hj)return vj;if(r<2)return ut.REF_ERR_VAR;var i=e.service.getFuncCacheManager().getInnerFuncCache("AI",{autoBuildCache:!1});if(i){var u=i.getCache(n,e).get(t);if(u)return u.valueRowCount>fj?dj:u.targetData}for(var s="",l=0,c=0;c<r;c++)for(var h=0;h<a;h++){var f,d=null!==(f=o(c,h))&&void 0!==f?f:"";if(d instanceof ut.ErrorVar)return d;s+=d,c&&0===h&&""!==d&&l++}var v={targetData:s,valueRowCount:l};return i&&r*a>300&&i.getCache(n,e).set(t,v),l>fj?(v.targetData="",dj):s}},{key:"getTargetRangeInfo",value:function(e,t){var n=t.toJSON(),r=n.row,a=n.col,o=n.rowCount,i=n.colCount,u=t.id(!1),s=t.sheet();if(!s)return ut.RUNTIME_ERR_VAR;var l=s.id();return this.getDataRowCount(e,u,l,o,i,(function(t,n){var o=s.getVar(r+t,a+n).getVar(e);return o.isError()?o:ux(s,r+t,a+n,e)}))}},{key:"getTargetImportRangeInfo",value:function(e,t){var n=t.importRangeId,r=t.getCollectionValue(),a=r.length,o=r[0].length;if(!n)return ut.REF_ERR_VAR;var i=e.ref.sheet();if(!i)return ut.RUNTIME_ERR_VAR;var u=i.id();return this.getDataRowCount(e,n,u,a,o,(function(e,t){var n,a;return null===(n=r[e])||void 0===n||null===(a=n[t])||void 0===a?void 0:a.getValue()}))}}]),t}(gC("AI_CLASSIFY",3,1,0,iC|lC,[{type:iC|nC},{type:tC},{type:iC|nC},{type:tC,default:new ut.NumberVar(20)}])),mj=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e){var t=e.ref.sheet();if(!t||!t.parent.aiManager)return ut.RUNTIME_ERR_VAR;for(var n=t.parent.aiManager,r=t.id(),a=[],o="",i=0;i<(arguments.length<=1?0:arguments.length-1);i++){var u=i+1<1||arguments.length<=i+1?void 0:arguments[i+1];if(lx(u))return fx();var s=u.getVar(e);if(s.isError())return s;0===i?a.push(sx(u,e)):1===i&&(o=sx(u,e))}var c=a.join(",");if(dx(c)||dx(o))return _x(this.name);var h=(0,l.Z)({user_input:{user_input:c,extract_type:o},action_type:"sheet_extract",sheet_id:r,funcName:this.name},we.nbU,Cx(t.getVar(e.ref.rowFrom(),e.ref.colFrom())));return e.info.customData||(e.info.customData=[]),e.info.customData.push(Ax(h)),ix(n,h,t.formatterService,void 0,e)}}]),t}(gC("AI_EXTRACT",2,0,1,nC,[{type:nC|iC},{type:nC|iC}])),pj=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e){var t=e.ref.sheet();if(!t||!t.parent.aiManager)return ut.RUNTIME_ERR_VAR;for(var n=t.id(),r=t.parent.aiManager,a=[],o="",i=0;i<(arguments.length<=1?0:arguments.length-1);i++){var u=i+1<1||arguments.length<=i+1?void 0:arguments[i+1];if(lx(u))return fx();var s=u.getVar(e);if(s.isError())return s;0===i?a.push(sx(u,e)):1===i&&(o=sx(u,e))}var c=a.join(",");if(dx(c)||dx(o))return _x(this.name);var h=(0,l.Z)({user_input:{user_input:c,target_language:o},action_type:"sheet_translate",sheet_id:n,funcName:this.name},we.nbU,Cx(t.getVar(e.ref.rowFrom(),e.ref.colFrom())));return e.info.customData||(e.info.customData=[]),e.info.customData.push(Ax(h)),ix(r,h,t.formatterService,void 0,e)}}]),t}(gC("AI_TRANSLATE",2,0,1,nC,[{type:nC|iC},{type:nC|iC}])),yj=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e){var t=e.ref.sheet();if(!t||!t.parent.aiManager)return ut.RUNTIME_ERR_VAR;for(var n=t.parent.aiManager,r=t.id(),a=[],o=0;o<(arguments.length<=1?0:arguments.length-1);o++){var i=o+1<1||arguments.length<=o+1?void 0:arguments[o+1];if(lx(i))return fx();var u=i.getVar(e);if(u.isError())return u;a.push(sx(i,e))}var s=a.join(",");if(dx(s))return _x(this.name);var c=(0,l.Z)({user_input:{user_input:s},action_type:"sheet_infer_sentiment",sheet_id:r,funcName:this.name},we.nbU,Cx(t.getVar(e.ref.rowFrom(),e.ref.colFrom())));return e.info.customData||(e.info.customData=[]),e.info.customData.push(Ax(c)),ix(n,c,t.formatterService,void 0,e)}}]),t}(gC("AI_SENTIMENT",1,0,1,nC,[{type:nC|iC}])),Cj=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e){var t=e.ref.sheet();if(!t||!t.parent.aiManager)return ut.RUNTIME_ERR_VAR;for(var n=t.parent.aiManager,r=t.id(),a=[],o=0;o<(arguments.length<=1?0:arguments.length-1);o++){var i=o+1<1||arguments.length<=o+1?void 0:arguments[o+1];if(lx(i))return fx();var u=i.getVar(e);if(u.isError())return u;a.push(sx(i,e))}var s=a.join(",");if(dx(s))return _x(this.name);var c=(0,l.Z)({user_input:{user_input:s},action_type:"sheet_summary",sheet_id:r,funcName:this.name},we.nbU,Cx(t.getVar(e.ref.rowFrom(),e.ref.colFrom())));return e.info.customData||(e.info.customData=[]),e.info.customData.push(Ax(c)),ix(n,c,t.formatterService,void 0,e)}}]),t}(gC("AI_SUMMARY",1,0,1,nC,[{type:nC|iC}])),_j=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e){var t=e.ref.sheet();if(!t||!t.parent.aiManager)return ut.RUNTIME_ERR_VAR;for(var n=t.parent.aiManager,r=t.id(),a=[],o=0;o<(arguments.length<=1?0:arguments.length-1);o++){var i=o+1<1||arguments.length<=o+1?void 0:arguments[o+1];if(lx(i))return fx();var u=i.getVar(e);if(u.isError())return u;a.push(sx(i,e))}var s=a.join(",");if(dx(s))return _x(this.name);var c=(0,l.Z)({user_input:{user_input:s},action_type:"sheet_polish",sheet_id:r,funcName:this.name},we.nbU,Cx(t.getVar(e.ref.rowFrom(),e.ref.colFrom())));return e.info.customData||(e.info.customData=[]),e.info.customData.push(Ax(c)),ix(n,c,t.formatterService,void 0,e)}}]),t}(gC("AI_POLISH",1,0,1,nC,[{type:nC|iC}])),Rj=function(e){function t(){var e;return(0,y.Z)(this,t),(e=(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))).calcCustomData=function(){return{autoFormat:"yyyy/mm/dd HH:mm"}},e}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e,t,n){var r=t.getValue();if(r<0)return H_(this.name,1);var a=Math.floor(n.getValue());return a<1||a>3?j_(this.name,2,a,1,3):new ut.NumberVar(25569+r*(1e3/Math.pow(10,3*(a-1)))/864e5)}}]),t}(gC("EPOCHTODATE",1,1,0,tC,[{type:tC},{type:tC,default:new ut.NumberVar(1)}]));function wj(e,t,n,r,a,o){var i=kj(t,r);if(isNaN(i))return BR;if(i<-o||o-1<i)return j_(e,1,i,-o,o-1);if("number"==typeof(n=n&&Math.floor(n))&&(n<=0||n>10))return j_(e,2,n,1,10);var u=function(e,t,n){return e<0&&(e+=Math.pow(t,10)),n||(n=0),e.toString(t).padStart(n,"0").toUpperCase()}(i,a,n);return 0<=i&&n&&n<u.length?ut.tractorErrorVarCreators[ut.ErrorCode.INSUFFICIENT_PLACES]({funcName:e,curPlaces:n,requiredPlaces:u.length}):new ut.StringVar(u)}function kj(e,t){var n=Math.pow(t,10),r=parseInt(e,t);return n/2<=r?r-n:r}function Sj(e,t){var n={strVal:""},r=t.getValue();return r.slice(0,2).toLowerCase()===Mt.HEX_PREFIX&&(r=r.slice(2)),r.length>10?(n.error=U_(e,1,r.length,10),n):(0,Mt.isValidHex)(r)?(n.strVal=r,n):(n.error=rR(e,r,ut.FormulaErrorPhrases.HEXADECIMAL),n)}function Ej(e,t){var n={strVal:""},r=t.getValue();return r.length>10?(n.error=U_(e,1,r.length,10),n):(0,Mt.isValidOct)(r)?(n.strVal=r,n):(n.error=rR(e,r,ut.FormulaErrorPhrases.OCTAL),n)}var Tj=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e,t,n){var r=Sj(this.name,t),a=r.error,o=r.strVal;if(a)return a;var i=o,u=n.getValue();return wj(this.name,i,u,16,2,512)}}]),t}(gC("HEX2BIN",1,1,0,tC,[{type:nC},{type:tC|eC,default:ut.NULL_VAR}])),Aj=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e,t,n){var r=Sj(this.name,t),a=r.error,o=r.strVal;if(a)return a;var i=o,u=n.getValue();return wj(this.name,i,u,16,8,536870912)}}]),t}(gC("HEX2OCT",1,1,0,tC,[{type:nC},{type:tC|eC,default:ut.NULL_VAR}])),Ij=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e,t,n){var r=Ej(this.name,t),a=r.error,o=r.strVal;if(a)return a;var i=o,u=n.getValue();return wj(this.name,i,u,8,2,512)}}]),t}(gC("OCT2BIN",1,1,0,tC,[{type:nC},{type:tC|eC,default:ut.NULL_VAR}])),bj=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e,t){var n=Ej(this.name,t),r=n.error,a=n.strVal;if(r)return r;var o=kj(a,8);return new ut.NumberVar(o)}}]),t}(gC("OCT2DEC",1,0,0,tC,[{type:nC}])),Fj=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e,t,n){var r=Ej(this.name,t),a=r.error,o=r.strVal;if(a)return a;var i=o,u=n.getValue();return wj(this.name,i,u,8,16,549755813888)}}]),t}(gC("OCT2HEX",1,1,0,tC,[{type:nC},{type:tC|eC,default:ut.NULL_VAR}])),Mj=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e,t){var n=!0;if(t.isString())return n=null!==AV(e,t.getValue()),new ut.BooleanVar(n);var r=e.ref.sheet();if(!r)return ut.VALUE_ERR_VAR;for(var a=t.getRef(),o=a.rowFrom(),i=a.rowTo(),u=a.colFrom(),s=a.colTo(),l=o;l<=i;l++)for(var c=u;c<=s;c++){var h=r.getVar(l,c).getVar(e);if(h.isError())return h;if(r.getVar(l,c).isNull())return ut.BOOLEAN_VAR_MAP[ut.BooleanConstant.FALSE];if(h.isString()){if(null!==AV(e,h.getValue()))continue;return ut.BOOLEAN_VAR_MAP[ut.BooleanConstant.FALSE]}var f=r.getCellFormatter(l,c);if(f&&!(0,Se.isDateTimeFormatter)(f)||!f)return ut.BOOLEAN_VAR_MAP[ut.BooleanConstant.FALSE]}return new ut.BooleanVar(n)}}]),t}(gC("ISDATE",1,0,0,rC,[{type:nC|iC}])),Vj=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e,t){var n,r=RegExp("^(?:[\\w+-]+\\.)*[\\w+-]+@[a-z0-9_-]+(?:\\.[a-z0-9_-]+)*\\.(?:".concat(we.HjE,")$"),"i"),a=t.getValue();return n=!(254<a.length)&&r.test(a),new ut.BooleanVar(n)}}]),t}(gC("ISEMAIL",1,0,0,rC,[{type:nC}])),Nj=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e,t){var n=t.getValue().replace(/^\s+|\s+$/g,""),r=n.length,a=!1,o=new RegExp("^(?:"+"(?:".concat(we.TfY,")://+[a-z0-9_-]+(?:\\.[a-z0-9_-]+)*(?::[0-9]+)?(?:/(?:[A-Za-z0-9\\-._~!$&'()*+,;=:@]|%[A-Fa-f0-9]{2})*)*/?(?:[?#]\\S*)?")+"|[a-z0-9_-]+(?:\\.[a-z0-9_-]+)*\\.(?:".concat(we.HjE,")(?::[0-9]+)?(?:/(?:[A-Za-z0-9\\-._~!$&'()*+,;=:@]|%[A-Fa-f0-9]{2})*)*/?(?:[?#]\\S*)?|mailto:(?:[\\w+-]+\\.)*[\\w+-]+@[a-z0-9_-]+(?:\\.[a-z0-9_-]+)*\\.(?:").concat(we.HjE,")|(?:news|aim):[%a-z0-9$_\\.+!*(),;/?#:@&~=-]+)$"),"i");return r<1e3&&(a=o.test(n)),new ut.BooleanVar(a)}}]),t}(gC("ISURL",1,0,0,rC,[{type:nC}])),Oj=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e,t){if(t.isBool())return yR(this.name,1,t.getValue().toString().toUpperCase(),ut.FormulaErrorPhrases.DATA_TYPE_BOOLEAN,ut.FormulaErrorPhrases.DATA_TYPE_STRING);for(var n=arguments.length,r=new Array(n>2?n-2:0),a=2;a<n;a++)r[a-2]=arguments[a];var o=this.checkArgs&&this.checkArgs([t].concat(r));if(o)return o;var i,u=t.getValue().replace(/\s/g,"");if(!(0,Mt.isValidComplex)(u))return LR;try{i=(0,Mt.createComplex)(u)}catch(e){return LR}var s=this.calcComplex(i,r);if(s instanceof ut.BaseVar)return s;if(isNaN(s.re))return BR;if(s.re===1/0)return G_;if(s.re===-1/0)return J_;var l=u.endsWith(Mt.ComplexSuffix.j)?Mt.ComplexSuffix.j:Mt.ComplexSuffix.i,c=(0,Mt.complexToString)(s,l);return new ut.StringVar(c)}}]),t}(gC("",1,0,0,nC,[{type:nC|rC}])),xj=function(e){function t(){var e;return(0,y.Z)(this,t),(e=(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))).name="IMSQRT",e}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"calcComplex",value:function(e){return e.sqrt()}}]),t}(Oj),Zj=function(e){function t(){var e;return(0,y.Z)(this,t),(e=(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))).name="IMCOSH",e}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"calcComplex",value:function(e){return e.cosh()}}]),t}(Oj),Dj=function(e){function t(){var e;return(0,y.Z)(this,t),(e=(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))).name="IMCOT",e}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"checkArgs",value:function(e){var t=e[0].getValue();if("0"===t||"0+0i"===t)return PR(this.name)}},{key:"calcComplex",value:function(e){return e.cot()}}]),t}(Oj),Pj=function(e){function t(){var e;return(0,y.Z)(this,t),(e=(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))).name="IMCOTH",e}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"checkArgs",value:function(e){var t=e[0].getValue();if("0"===t||"0+0i"===t)return PR(this.name)}},{key:"calcComplex",value:function(e){return e.coth()}}]),t}(Oj),Lj=function(e){function t(){var e;return(0,y.Z)(this,t),(e=(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))).name="IMCSC",e}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"calcComplex",value:function(e){return e.csc()}}]),t}(Oj),Bj=function(e){function t(){var e;return(0,y.Z)(this,t),(e=(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))).name="IMCSCH",e}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"calcComplex",value:function(e){return e.csch()}}]),t}(Oj),Uj=function(e){function t(){var e;return(0,y.Z)(this,t),(e=(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))).name="IMLOG",e.operands=2,e.resultType=nC,e.paramsDesc=[{type:nC|rC},{type:tC}],e}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"checkArgs",value:function(e){var t=e[0].getValue(),n=e[1].getValue();return"0"===t||"0+0i"===t?PR(this.name):n<=0?q_(this.name,n,2,0):void 0}},{key:"calcComplex",value:function(e,t){var n=t[0].getValue();return e.log().div(Math.log(n))}}]),t}(Oj),Hj=function(e){function t(){var e;return(0,y.Z)(this,t),(e=(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))).name="IMREAL",e.resultType=tC,e}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"calcComplex",value:function(e){return new ut.NumberVar(e.re)}}]),t}(Oj),Wj=function(e){function t(){var e;return(0,y.Z)(this,t),(e=(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))).name="IMSEC",e}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"calcComplex",value:function(e){return e.sec()}}]),t}(Oj),jj=function(e){function t(){var e;return(0,y.Z)(this,t),(e=(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))).name="IMSECH",e}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"calcComplex",value:function(e){return e.sech()}}]),t}(Oj),zj=function(e){function t(){var e;return(0,y.Z)(this,t),(e=(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))).name="IMSIN",e}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"calcComplex",value:function(e){return e.sin()}}]),t}(Oj),Gj=function(e){function t(){var e;return(0,y.Z)(this,t),(e=(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))).name="IMSINH",e}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"calcComplex",value:function(e){return e.sinh()}}]),t}(Oj),Jj=function(e){function t(){var e;return(0,y.Z)(this,t),(e=(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))).name="IMTAN",e}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"calcComplex",value:function(e){return e.tan()}}]),t}(Oj),qj=function(e){function t(){var e;return(0,y.Z)(this,t),(e=(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))).name="IMTANH",e}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"calcComplex",value:function(e){return e.tanh()}}]),t}(Oj),$j=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e){for(var t,n=this,r=[],a=arguments.length,o=new Array(a>1?a-1:0),i=1;i<a;i++)o[i-1]=arguments[i];for(var u=0,s=o;u<s.length;u++){var l=s[u];l.iter(e).exitWhen((function(r){return r.isError()?t=r:r.isString()&&!r.toNumberVar(e.service).isNumber()?t=lR(n.name,1,r.getValue()):r.isBool()&&(t=cR(n.name,1,r.toStringVar().getValue())),!!t})).forEach((function(e){r.push(e.getValue())}))}if(t)return t;for(var c=1,h=0,f=0,d=r;f<d.length;f++){var v=d[f];if(h+=v=Math.trunc(v),v<0)return NR(this.name,v);if(h>1029)return G_;c*=(0,Mt.combin)(h,v)}return new ut.NumberVar(c)}}]),t}(gC("MULTINOMIAL",1,255,1,tC,[{type:dC},{type:dC}])),Yj=function(e){function t(){var e;return(0,y.Z)(this,t),(e=(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))).name="ISO.CEILING",e}return(0,g.Z)(t,e),t}(Mt.CEILINGPRECISEFunc),Kj=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e,t){var n=null;if(t.isCollection()){var r=t.nth(0,e);if(r.isError())return r;if(r.isPrimitive()&&null===(n=r.toNumberVar(e.service).getValue()))return yR(this.name,1,r.getValue(),ut.FormulaErrorPhrases.DATA_TYPE_STRING,ut.FormulaErrorPhrases.DATA_TYPE_DOUBLE)}else n=t.getValue();if(null===n||n<=0)return q_(this.name,n||0,1,0);if(n>=3163)return aR;for(var a=[],o=0;o<n;++o){for(var i=[],u=0;u<n;++u){var s=o===u?1:0;i.push(new ut.NumberVar(s))}a.push(i)}return new Ru(a)}}]),t}(gC("MUNIT",1,0,0,iC,[{type:tC|iC}]));Kj=Gi([cc("MUNIT")],Kj);var Xj=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e,t,n,r,a){var o=t.getValue(),i=n.getValue(),u=r.getValue();if(a.isPrimitive()){if(a.isString())return lR(this.name,4,a.getValue());if(a.isBool())return cR(this.name,4,a.toStringVar().getValue());var s=a.getValue();return new ut.NumberVar(s*Math.pow(o,i))}for(var l,c=0,h=0;h<a.size();h++){var f=a.nth(h,e);if(f.isError()?l=f:f.isString()?l=lR(this.name,4,f.getValue()):f.isBool()&&(l=cR(this.name,4,f.toStringVar().getValue())),l)return l;c+=f.getValue()*Math.pow(o,i+h*u)}return new ut.NumberVar(c)}}]),t}(gC("SERIESSUM",4,0,0,tC,[{type:tC},{type:tC},{type:tC},{type:dC}])),Qj=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e){for(var t=0,n=null,r=arguments.length,a=new Array(r>1?r-1:0),o=1;o<r;o++)a[o-1]=arguments[o];for(var i=0,u=a;i<u.length;i++){var s=u[i];if(s.iter(e).exitWhen((function(e){return!!e.isError()&&(n=e,!0)})).forEach((function(e){(e.isNumber()||e.isBool())&&(t+=Math.pow(Number(e.getValue()),2))})),n)return n}return new ut.NumberVar(t)}}]),t}(gC("SUMSQ",1,255,1,tC,[{type:tC|iC},{type:tC|iC}])),ez=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e){for(var t=new Set,n=arguments.length,r=new Array(n>1?n-1:0),a=1;a<n;a++)r[a-1]=arguments[a];for(var o=0,i=r;o<i.length;o++){var u=i[o];u.iter(e).filter((function(e){return!e.isNull()&&""!==e.getValue()})).forEach((function(e){t.add(e.getValue())}))}return new ut.NumberVar(t.size)}}]),t}(gC("COUNTUNIQUE",1,255,1,tC,[{type:dC},{type:dC}]));function tz(e,t,n,r){var a=Math.floor(n.getValue()),o=Math.floor(r.getValue());if(a<0||o<0)return ut.VALUE_ERR_VAR;if(!a||!o){var i=a?[o,2]:[a,1],u=(0,p.Z)(i,2),s=u[0],l=u[1];return K_(t,s,l,1)}var c=e.ref.colFrom(),h=e.ref.rowFrom(),f=e.ref.sheet(),d=f.getColumnCount(),v=h+a-f.getRowCount(),g=c+o-d;return v>0||g>0?function(e){var t=e.needMoreRows,n=void 0===t?0:t,r=e.needMoreCols,a=void 0===r?0:r;return we.d$b[we.O6N.REF_RANDARRAY_ERROR_EXPAND]({needMoreRows:n,needMoreCols:a})}({needMoreRows:v,needMoreCols:g}):a*o>1e6?aR:{rowsValInt:a,colsValInt:o}}var nz=function(e){function t(){var e;return(0,y.Z)(this,t),(e=(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))).alwaysCalc=!0,e}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e,t,n,r,a,o){var i=tz(e,this.name,t,n);if(i instanceof ut.ErrorVar)return i;var u=r.getValue(),s=a.getValue(),l=o.getValue();if(u>s)return ut.VALUE_ERR_VAR;if(u>s)return ut.VALUE_ERR_VAR;if(l&&(!Number.isInteger(u)||!Number.isInteger(s)))return ut.VALUE_ERR_VAR;for(var c=i.rowsValInt,h=i.colsValInt,f=[],d=0;d<c;d++){for(var v=[],g=0;g<h;g++){var m=void 0;u===s&&(m=u);var p=s-u;m=l?p<1?u:u+Math.floor((p+1)*Math.random()):u+p*Math.random(),v.push(new ut.NumberVar(m))}f[d]=v}return new Ru(f)}}]),t}(gC("RANDARRAY",0,5,0,iC,[{type:tC,default:new ut.NumberVar(1)},{type:tC,default:new ut.NumberVar(1)},{type:tC,default:new ut.NumberVar(0)},{type:tC,default:new ut.NumberVar(1)},{type:rC,default:new ut.BooleanVar(!1)}]));nz=Gi([cc("RANDARRAY")],nz);var rz=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e,t,n,r,a){var o=tz(e,this.name,t,n);if(o instanceof ut.ErrorVar)return o;for(var i=o.rowsValInt,u=o.colsValInt,s=a.getValue(),l=r.getValue(),c=[],h=0;h<i;h++){for(var f=[],d=0;d<u;d++)f.push(new ut.NumberVar(l)),l+=s;c[h]=f}return new Ru(c)}}]),t}(gC("SEQUENCE",1,3,0,iC,[{type:tC},{type:tC,default:new ut.NumberVar(1)},{type:tC,default:new ut.NumberVar(1)},{type:tC,default:new ut.NumberVar(1)}]));rz=Gi([cc("SEQUENCE")],rz);var az=function(e){function t(){var e;return(0,y.Z)(this,t),(e=(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))).calcCustomData=function(){return{autoFormat:"yyyy-mm-dd"}},e}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e,t){if(!t.isNumber())return t;var n=t.getValue(),r=new Date(1900,0,1),a=n<0?2:1,o=new Date(r.getTime()+24*(Math.trunc(n)-a)*60*60*1e3),i=ke.SheetDate.fromLocalDate(o).toNumber();return function(e){return"Invalid Date"===e.toString()}(o)||isNaN(i)||i<ke.SheetDate.MIN_DATE_VALUE||i>ke.SheetDate.MAX_DATE_VALUE?t:new ut.NumberVar(i)}}]),t}(gC("TO_DATE",1,0,0,tC|nC,[{type:tC|nC|rC}])),oz=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e,t){var n,r;if(t.isRef()){var a,o=t.colCount(),i=t.rowCount();if(o>1||i>1)return ut.tractorErrorVarCreators[ut.ErrorCode.ARGUMENTS_COUNT_SHOULD_BE_EXACTLY]({funcName:this.name,requiredOperandCount:1,argCount:o*i});var u=t.getVarByPos(0,0,e),s=u.getValue(e);if(u.isError())return u;var l=t.getFormatterByPos(0,0,e);if(!l){var c=(null==s?void 0:s.toString())||"";return u.isBool()?new ut.StringVar(c.toUpperCase()):new ut.StringVar(c)}var h=null===(a=e.service.spread)||void 0===a?void 0:a.formatterService,f=(null==h?void 0:h.getFormattedText(l,s))||"";return new ut.StringVar(f)}var d=t.getValue(),v=d.toString();if(t.isBool())return new ut.StringVar(v.toUpperCase());var g=null===(n=t.specialInfo)||void 0===n||null===(r=n.customData)||void 0===r?void 0:r.autoFormat;if(g){var m,p=null===(m=e.service.spread)||void 0===m?void 0:m.formatterService,y=null==p?void 0:p.getFormatter(g);v=(null==p?void 0:p.getFormattedText(y,d))||""}return new ut.StringVar(v)}}]),t}(gC("TO_TEXT",1,0,0,tC,[{type:iC|tC|nC|rC}])),iz=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e,t){if(!t.isNumber())return t;var n=t.getValue();return new ut.NumberVar(n)}}]),t}(gC("TO_PURE_NUMBER",1,0,0,tC,[{type:tC|nC|rC}])),uz=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e,t){if(!t.isNumber())return t;hm(e);var n=t.getValue();return new ut.NumberVar(n)}}]),t}(gC("TO_DOLLARS",1,0,0,tC,[{type:tC|nC|rC}])),sz=function(e){function t(){var e;return(0,y.Z)(this,t),(e=(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))).calcCustomData=function(){return{autoFormat:"0%"}},e}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e,t){if(!t.isNumber())return t;var n=t.getValue();return new ut.NumberVar(n)}}]),t}(gC("TO_PERCENT",1,0,0,tC,[{type:tC|nC|rC}])),lz=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),t}(gC("",2,0,0,tC,[{type:tC},{type:tC}])),cz=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),t}(gC("",2,0,0,rC,[{type:tC|rC|nC|eC},{type:tC|rC|nC|eC}])),hz=function(e){function t(){var e;return(0,y.Z)(this,t),(e=(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))).name="ADD",e}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e,t,n){return(0,ut.addOpImpl)(t,n)}}]),t}(lz),fz=function(e){function t(){var e;return(0,y.Z)(this,t),(e=(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))).name="DIVIDE",e}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e,t,n){return(0,ut.divideOpImpl)(t,n)}}]),t}(lz),dz=function(e){function t(){var e;return(0,y.Z)(this,t),(e=(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))).name="EQ",e}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e,t,n){return new ut.BooleanVar((0,ut.equals)(e,t,n))}}]),t}(cz),vz=function(e){function t(){var e;return(0,y.Z)(this,t),(e=(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))).name="GT",e}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e,t,n){return new ut.BooleanVar((0,ut.greaterThan)(e,t,n))}}]),t}(cz),gz=function(e){function t(){var e;return(0,y.Z)(this,t),(e=(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))).name="GTE",e}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e,t,n){return new ut.BooleanVar((0,ut.greaterThanEquals)(e,t,n))}}]),t}(cz),mz=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e,t,n,r,a,o){var i=t.getValue(),u=n.getValue(),s=r.getValue(),l=a.getValue(),c=o.getValue();return t.isError()?t:n.isError()?n:r.isError()?r:u>s?mR(this.name,u,2,3,s):new ut.BooleanVar((l?i>=u:i>u)&&(c?i<=s:i<s))}}]),t}(gC("ISBETWEEN",3,2,0,rC,[{type:oC},{type:oC},{type:oC},{type:rC,default:ut.BOOLEAN_VAR_MAP[ut.BooleanConstant.TRUE]},{type:rC,default:ut.BOOLEAN_VAR_MAP[ut.BooleanConstant.TRUE]}])),pz=function(e){function t(){var e;return(0,y.Z)(this,t),(e=(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))).name="LT",e}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e,t,n){return new ut.BooleanVar((0,ut.lessThan)(e,t,n))}}]),t}(cz),yz=function(e){function t(){var e;return(0,y.Z)(this,t),(e=(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))).name="LTE",e}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e,t,n){return new ut.BooleanVar((0,ut.lessThanEquals)(e,t,n))}}]),t}(cz),Cz=function(e){function t(){var e;return(0,y.Z)(this,t),(e=(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))).name="MINUS",e}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e,t,n){return(0,ut.subOpImpl)(t,n)}}]),t}(lz),_z=function(e){function t(){var e;return(0,y.Z)(this,t),(e=(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))).name="MULTIPLY",e}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e,t,n){return(0,ut.multiplyOpImpl)(t,n)}}]),t}(lz),Rz=function(e){function t(){var e;return(0,y.Z)(this,t),(e=(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))).name="NE",e}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e,t,n){return new ut.BooleanVar((0,ut.notEquals)(e,t,n))}}]),t}(cz),wz=function(e){function t(){var e;return(0,y.Z)(this,t),(e=(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))).name="POW",e}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e,t,n){return(0,ut.power)(t,n)}}]),t}(lz),kz=function(e){function t(){var e;return(0,y.Z)(this,t),(e=(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))).calcCustomData=ut.getFirstValidCustomData,e}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e,t){var n=t.getValue();return new ut.NumberVar(-n)}}]),t}(gC("UMINUS",1,0,0,tC,[{type:tC}])),Sz=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e,t){var n=t.getValue();return new ut.NumberVar(n/100)}}]),t}(gC("UNARY_PERCENT",1,0,0,tC,[{type:tC}])),Ez=function(e){function t(){var e;return(0,y.Z)(this,t),(e=(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))).calcCustomData=ut.getFirstValidCustomData,e}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e,t){return t}}]),t}(gC("UPLUS",1,0,0,tC,[{type:tC}]));function Tz(e,t,n){0===n.length&&n.push({index:0,ascending:!0});for(var r=0,a=0;a<n.length;a++){var o=n[a],i=o.index,u=o.ascending;if(0!==(r=MV(e[i],t[i],u)))break}return r}var Az,Iz=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e,t){for(var n=t.rowCount(),r=t.colCount(),a=Fu(t)?t.getRef():null,o=[[]],i=[],u=[],s=!1,l=!1,c=0;c<(arguments.length<=2?0:arguments.length-2);c+=2){var h=c+1+2<2||arguments.length<=c+1+2?void 0:arguments[c+1+2],f=void 0;if(h.isNull())f=1;else{if(!(h.isNumber()||h.isCollection()&&1===h.size()))return ut.VALUE_ERR_VAR;f=h.getValue()}if(1!==f&&-1!==f)return nR(this.name,null!==f?f.toString():"",c+3,"1, -1");var d=c+2<2||arguments.length<=c+2?void 0:arguments[c+2];if(d.isPrimitive()||1===d.size())return s||l||1!==r&&1!==n?_R(this.name,c+2,n,1,1,1):t;var v=d.colCount(),g=d.rowCount();if(0===i.length&&(s=1===v,l=1===g),l){if(1!==g||v!==r)return _R(this.name,c+2,1,r,g,v)}else if(1!==v||g!==n)return _R(this.name,c+2,n,1,g,v);u.push(d),i.push({index:s?u.length+r-1:u.length-1,ascending:1===f})}for(var m=0;m<n;m++){o[m]||(o[m]=[]);for(var p=0;p<r;p++){var y=t.nth(m*r+p,e);null!==a&&(y=uc(y,a,m,p)),o[m][p]=y}if(s)for(var C=0;C<u.length;C++)o[m][r+C]=u[C].nth(m,e)}return(0,we.n5s)()?bz(e,o,i,u,s):((0,we.QFC)().finally((function(){e.service.emit("afterWaitAsyncCalc",e.formula,4)})),e.service.addCalculatingAsyncFormula(e.formula),ut.WAIT_ASYNC_ERR_VAR)}}]),t}(gC("SORTBY",2,255,2,lC|iC,[{type:iC},{type:iC},{type:tC|iC,default:new ut.NumberVar(1)},{type:iC},{type:eC|tC|iC}]));function bz(e,t,n,r,a){var o,i=[[]];if(a)i=t.sort((function(e,t){return Tz(e,t,n)})),r.length>0&&(i=t.map((function(e){return e.slice(0,e.length-r.length)})));else{var u=Array.from({length:t[0].length},(function(e,t){return t}));u=u.sort((function(t,a){return function(e,t,n,r,a){for(var o=0,i=0;i<a.length;i++){var u=a[i],s=u.index,l=u.ascending;if(0!==(o=MV(r[s].nth(e,n),r[s].nth(t,n),l)))break}return o}(t,a,e,r,n)}));for(var s=0;s<t.length;s++){i[s]||(i[s]=[]);for(var l=0;l<u.length;l++){var c=u[l];i[s][l]=t[s][c]}}}var h=new Ru(i);return e.info&&(e.info.customData=null===(o=h.getVarByPos(0,0).getSpecialInfo())||void 0===o?void 0:o.customData),h}Iz=Gi([cc("SORTBY")],Iz),function(e){e[e.TopN=0]="TopN",e[e.TopNDup=1]="TopNDup",e[e.TopNDistinct=2]="TopNDistinct",e[e.TopNWithRep=3]="TopNWithRep"}(Az||(Az={}));var Fz=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e,t,n,r){if(n.isCollection()&&n.size()>1)return K_(this.name,0,2,1);var a,o=Math.trunc(n.getValue(e));if(isNaN(o))return lR(this.name,2,n.getValue(e));if(o<1)return K_(this.name,n.getValue(e)||0,2,1);if(r.isCollection()&&r.size()>1&&(a=0),a=Math.trunc(r.getValue(e)),isNaN(a))return lR(this.name,3,r.getValue(e));if(a<0||a>3)return j_(this.name,3,r.getValue(e),0,3);for(var i=t.rowCount(),u=t.colCount(),s=Fu(t)?t.getRef():null,l=[[]],c=[],h=[],f=arguments.length,d=new Array(f>4?f-4:0),v=4;v<f;v++)d[v-4]=arguments[v];for(var g=0;g<d.length;g+=2){var m=d[g+1];if(m.isCollection()){if(m.size()>1)return ut.tractorErrorVarCreators[ut.ErrorCode.NA_NO_VALID_DATA]({funcName:this.name});if(m.getVar(e).isString())return yR(this.name,g+5,m.getValue(e),ut.FormulaErrorPhrases.DATA_TYPE_STRING,ut.FormulaErrorPhrases.DATA_TYPE_BOOLEAN)}var p=m.getValue(e);if(d[g].isNumber()){var y=Math.trunc(d[g].getValue(e))-1;(y<0||y>=u)&&(y=-1),c.push({index:y,ascending:p})}else{var C=d[g],_=C.colCount(),R=C.rowCount();if(1!==_||R!==i)return _R(this.name,g+2,i,1,R,_);var w=Fu(C)&&C.getRef();if(w&&s&&null!=s&&s.isIntersect(w)){var k=s.colFrom(),S=w.colFrom();c.push({index:S-k,ascending:p})}else h.push(C),c.push({index:h.length+u-1,ascending:p})}}for(var E=0;E<i;E++){l[E]||(l[E]=[]);for(var T=0;T<u;T++){var A=t.nth(E*u+T,e);null!==s&&(A=uc(A,s,E,T)),l[E][T]=A}for(var I=0;I<h.length;I++)l[E][u+I]=h[I].nth(E,e)}return(0,we.n5s)()?Mz(e,l,o,a,c,h.length):((0,we.QFC)().finally((function(){e.service.emit("afterWaitAsyncCalc",e.formula,4)})),e.service.addCalculatingAsyncFormula(e.formula),ut.WAIT_ASYNC_ERR_VAR)}}]),t}(gC("SORTN",1,255,2,lC|iC,[{type:iC},{type:tC|iC,default:new ut.NumberVar(1)},{type:tC|iC,default:new ut.NumberVar(0)},{type:tC|iC},{type:rC|iC}]));function Mz(e,t,n,r,a,o){var i,u;switch(u=0===a.length?t.sort((function(e,t){return Tz(e,t,a)})):0===(a=a.filter((function(e){return e.index>=0}))).length?t:t.sort((function(e,t){return Tz(e,t,a)})),r){case 0:u=function(e,t){return e.splice(0,t)}(t,n);break;case 1:u=function(e,t,n){for(var r=e[t-1],a=t;a<e.length;a++)if(!Vz(e[a],r,n))return e.slice(0,a);return e}(t,n,a);break;case 2:u=function(e,t,n){for(var r=[],a=function(a){var o=e[a];if(0!==a&&r.some((function(e){return Vz(o,e,n)}))||r.push(o),r.length===t)return{v:r}},o=0;o<e.length;o++){var i=a(o);if("object"===(0,_.Z)(i))return i.v}return r}(t,n,a);break;case 3:u=function(e,t,n){for(var r=[],a=0,o=function(o){var i=e[o];if(0!==o&&r.some((function(e){return Vz(i,e,n)}))||a++,a>t)return{v:r};r.push(i)},i=0;i<e.length;i++){var u=o(i);if("object"===(0,_.Z)(u))return u.v}return r}(t,n,a)}o>0&&(u=u.map((function(e){return e.slice(0,e.length-o)})));var s=new Ru(u);return e.info&&(e.info.customData=null===(i=s.getVarByPos(0,0).getSpecialInfo())||void 0===i?void 0:i.customData),s}function Vz(e,t,n){for(var r=0;r<n.length;r++){var a=n[r].index;if(e[a].getValue()!==t[a].getValue())return!1}return!0}Fz=Gi([cc("SORTN")],Fz);var Nz=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e,t){var n=t.rowCount(),r=t.colCount();if(n!==r)return YR(this.name,r,n);for(var a=[[]],o=0;o<n;o++){a[o]||(a[o]=[]);for(var i=0;i<r;i++){var u=t.nth(o*r+i,e);if(u.isString())return lR(this.name,1,u.getValue());if(u.isBool())return cR(this.name,1,u.toStringVar().getValue());if(u.isNull())return hR(this.name,1,u.toStringVar().getValue());if(u.isError())return u;a[o][i]=u.getValue()}}return new ut.NumberVar(function(e){var t=zN(e),n=t.rowSwap,r=t.smallPivotDetected,a=t.luMatrix,o=t.permutation;if(r)return 0;for(var i=o.length,u=n?1:-1,s=0;s<i;s++)u*=a[s][s];return u}(a))}}]),t}(gC("MDETERM",1,0,0,tC,[{type:iC}])),Oz=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e,t){var n=t.rowCount(),r=t.colCount();if(n!==r)return YR(this.name,r,n);for(var a=[],o=0;o<n;o++){a[o]||(a[o]=[]);for(var i=0;i<r;i++){var u=t.nth(o*r+i,e);if(u.isString())return lR(this.name,1,u.getValue());if(u.isBool())return cR(this.name,1,u.toStringVar().getValue());if(u.isNull())return hR(this.name,1,u.toStringVar().getValue());if(u.isError())return u;if(!u.isNumber())return(u=u.toStringVar(e.service)).isNull()?hR(this.name,1,u.toStringVar().getValue()):lR(this.name,1,u.getValue());a[o][i]=u.getValue()}}var s=jN(a);if(!s)return we.d$b[we.O6N.MATRIX_WAS_NOT_INVERTIBLE]({funcName:this.name});var l=s.map((function(e){return e.map((function(e){return new ut.NumberVar(e)}))}));return new Ru(l)}}]),t}(gC("MINVERSE",1,0,0,iC,[{type:iC}]));function xz(e,t,n,r,a,o){var i=r?-1:1,u=0;if(a.isPrimitive()||o.isPrimitive()){if(a.isError()||o.isError())return a.isError()?a:o;if(a.isCollection()&&1!==a.size()||o.isCollection()&&1!==o.size())return we.d$b[we.O6N.NA_ARRAY_SIZES_NOT_EQUAL]({funcName:t});var s=a.getValue(e),l=o.getValue(e);return new ut.NumberVar("number"==typeof s&&"number"==typeof l?n?(s-l)*(s-l):s*s+i*l*l:0)}if(a.size()!==o.size())return we.d$b[we.O6N.NA_ARRAY_SIZES_NOT_EQUAL]({funcName:t});for(var c=0;c<a.size();c++){var h=a.nth(c,e);if(h.isError())return h;var f=o.nth(c,e);if(f.isError())return f;if(h.isNumber()&&f.isNumber()){var d=h.getValue(),v=f.getValue();u+=n?(d-v)*(d-v):d*d+i*v*v}}return new ut.NumberVar(u)}Oz=Gi([cc("MINVERSE")],Oz);var Zz,Dz=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e,t,n){return xz(e,this.name,!1,!0,t,n)}}]),t}(gC("SUMX2MY2",2,0,0,tC,[{type:tC|iC},{type:tC|iC}])),Pz=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e,t,n){return xz(e,this.name,!1,!1,t,n)}}]),t}(gC("SUMX2PY2",2,0,0,tC,[{type:tC|iC},{type:tC|iC}])),Lz=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e,t,n){return xz(e,this.name,!0,!1,t,n)}}]),t}(gC("SUMXMY2",2,0,0,tC,[{type:tC|iC},{type:tC|iC}])),Bz=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e){for(var t=[],n=arguments.length,r=new Array(n>1?n-1:0),a=1;a<n;a++)r[a-1]=arguments[a];for(var o=0,i=r;o<i.length;o++){var u=i[o];u.iter(Object.assign({},e,{skipEmptyRef:!1})).forEach((function(e){e.isPrimitive()&&t.push([e])}))}return new Ru(t)}}]),t}(gC("FLATTEN",1,255,1,tC,[{type:dC},{type:dC}]));Bz=Gi([cc("FLATTEN")],Bz),function(e){e[e.keepAll=0]="keepAll",e[e.ignoreBlank=1]="ignoreBlank",e[e.ignoreErrors=2]="ignoreErrors",e[e.ignoreBlankErrors=3]="ignoreBlankErrors"}(Zz||(Zz={}));var Uz=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e,t,n,r){var a=Math.trunc(n.getValue());if(a<0||a>3)return nR(this.name,a.toString(),2,"0, 1, 2, 3");var o=r.getValue(),i=[];if(t.isPrimitive())Hz(a,t)||i.push(t);else for(var u=o?t.colCount():t.rowCount(),s=o?t.rowCount():t.colCount(),l=0;l<u;l++)for(var c=0;c<s;c++){var h=o?c:l,f=o?l:c,d=t.getVarByPos(h,f,e);Hz(a,d)||i.push(d)}return 0===i.length?ZR:"TOROW"===this.name?new Ru([i]):new Ru(i.map((function(e){return[e]})))}}]),t}(gC("",1,2,0,iC,[{type:oC|iC},{type:tC,default:new ut.NumberVar(0)},{type:rC,default:ut.BOOLEAN_VAR_MAP[ut.BooleanConstant.FALSE]}]));function Hz(e,t){switch(e){case Zz.ignoreBlank:return t.isNull();case Zz.ignoreErrors:return t.isError();case Zz.ignoreBlankErrors:return t.isNull()||t.isError();default:return!1}}var Wz=function(e){function t(){var e;return(0,y.Z)(this,t),(e=(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))).name="TOCOL",e}return(0,g.Z)(t,e),t}(Uz);Wz=Gi([cc("TOCOL")],Wz);var jz=function(e){function t(){var e;return(0,y.Z)(this,t),(e=(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))).name="TOROW",e}return(0,g.Z)(t,e),t}(Uz);jz=Gi([cc("TOROW")],jz);var zz=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e,t){for(var n,r=-1*(n=t.isPrimitive()?1:"CHOOSEROWS"===this.name?t.rowCount():t.colCount()),a=[],o=arguments.length,i=new Array(o>2?o-2:0),u=2;u<o;u++)i[u-2]=arguments[u];for(var s=0;s<i.length;s++){var l=Math.trunc(i[s].getValue());if(0===l)return KR(this.name,s+2);if(l<r||l>n)return j_(this.name,s+2,l,r,n);l<0&&(l+=n+1),a.push(l)}return this.calcChoose(e,t,a)}}]),t}(gC("",2,255,1,iC,[{type:oC|iC},{type:tC},{type:tC}])),Gz=function(e){function t(){var e;return(0,y.Z)(this,t),(e=(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))).name="CHOOSECOLS",e}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"calcChoose",value:function(e,t,n){if(t.isPrimitive())return new Ru([Array.from({length:n.length},(function(){return t}))]);for(var r=t.isRef()?t.toRefMatrix():t,a=[],o=0;o<r.rowCount();o++)for(var i=0;i<n.length;i++){var u=Ou(r,n[i]-1,1);a[o]||(a[o]=[]),a[o][i]=u.nth(o,e)}return new Ru(a)}}]),t}(zz);Gz=Gi([cc("CHOOSECOLS")],Gz);var Jz=function(e){function t(){var e;return(0,y.Z)(this,t),(e=(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))).name="CHOOSEROWS",e}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"calcChoose",value:function(e,t,n){if(t.isPrimitive())return new Ru((0,m.Z)(Array.from({length:n.length},(function(){return[t]}))));for(var r=t.isRef()?t.toRefMatrix():t,a=[],o=0;o<n.length;o++){var i=xu(r,n[o]-1,1);a[o]||(a[o]=[]);for(var u=0;u<i.size();u++)a[o][u]=i.nth(u,e)}return new Ru(a)}}]),t}(zz);Jz=Gi([cc("CHOOSEROWS")],Jz);var qz=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),r=1;r<t;r++)n[r-1]=arguments[r];for(var a=Math.max.apply(Math,(0,m.Z)(n.map((function(e){return e.isPrimitive()?1:e.colCount()})))),o=[],i=0;i<n.length;i++){var u=n[i],s=1,l=1;u.isPrimitive()||(s=u.rowCount(),l=u.colCount());for(var c=[],h=0;h<s;h++){c[h]||(c[h]=[]);for(var f=0;f<a;f++){var d=u.isPrimitive()?u:u.getVarByPos(h,f,e);c[h][f]=f<l?d:XR(this.name,ut.ErrorConstant.NA)}}o.push(c)}return new Ru(o.flat())}}]),t}(gC("VSTACK",1,255,1,iC,[{type:oC|iC},{type:oC|iC}]));qz=Gi([cc("VSTACK")],qz);var $z=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),r=1;r<t;r++)n[r-1]=arguments[r];for(var a=Math.max.apply(Math,(0,m.Z)(n.map((function(e){return e.isPrimitive()?1:e.rowCount()})))),o=[],i=0;i<n.length;i++){var u=n[i],s=1,l=1;u.isPrimitive()||(s=u.rowCount(),l=u.colCount());for(var c=0;c<a;c++){o[c]||(o[c]=[]);for(var h=0;h<l;h++){var f=u.isPrimitive()?u:u.getVarByPos(c,h,e);o[c].push(c<s?f:XR(this.name,ut.ErrorConstant.NA))}}}return new Ru(o)}}]),t}(gC("HSTACK",1,255,1,iC,[{type:oC|iC},{type:oC|iC}]));$z=Gi([cc("HSTACK")],$z);var Yz=function(e){function t(){var e;return(0,y.Z)(this,t),(e=(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))).paramsDesc=[{type:oC|iC},{type:tC},{type:oC,default:QR("pad_with",ut.ErrorConstant.NA)}],e}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e,t,n,r){if(!t.isPrimitive()&&1!==t.rowCount()&&1!==t.colCount())return zR(this.name);var a=Math.trunc(n.getValue());if(a<1)return K_(this.name,a,2,1);var o=[];if(t.isPrimitive()){var i=Array.from({length:a-1},(function(){return[r]}));return i.unshift([t]),new Ru(i)}for(var u=Math.ceil(t.size()/a),s=0;s<a;s++){o[s]||(o[s]=[]);for(var l=0;l<u;l++){var c=l*a+s,h=c<t.size()?t.nth(c,e):r;o[s][l]=h}}return new Ru(o)}}]),t}(gC("WRAPCOLS",2,1,0,iC,[]));Yz=Gi([cc("WRAPCOLS")],Yz);var Kz=function(e){function t(){var e;return(0,y.Z)(this,t),(e=(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))).paramsDesc=[{type:oC|iC},{type:tC},{type:oC,default:QR("pad_with",ut.ErrorConstant.NA)}],e}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e,t,n,r){if(!t.isPrimitive()&&1!==t.rowCount()&&1!==t.colCount())return zR(this.name);var a=Math.trunc(n.getValue());if(a<1)return K_(this.name,a,2,1);var o=[];if(t.isPrimitive()){var i=Array.from({length:a-1},(function(){return r}));return i.unshift(t),new Ru([i])}for(var u=Math.ceil(t.size()/a),s=0;s<u;s++){o[s]||(o[s]=[]);for(var l=0;l<a;l++){var c=s*a+l,h=c<t.size()?t.nth(c,e):r;o[s].push(h)}}return new Ru(o)}}]),t}(gC("WRAPROWS",2,1,0,iC,[]));Kz=Gi([cc("WRAPROWS")],Kz);var Xz=function(e){function t(){var e;return(0,y.Z)(this,t),(e=(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))).optionOperands=0,e.repeatedLastParam=0,e.resultType=ut.VAR_TYPE.ATOM,e}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),r=1;r<t;r++)n[r-1]=arguments[r];var a=n[n.length-1].isOp()?n[n.length-1].getVar(e):n[n.length-1];if(!dc(a))return oR;var o=a.getParams();return o.length!==n.length-1?MR("LAMBDA",o.length+1,n.length):this.calcLambda(e,a,n.slice(0,-1),o)}}]),t}(ut.FuncOpBase),Qz=function(e){function t(){var e;return(0,y.Z)(this,t),(e=(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))).name="BYROW",e.operands=2,e.paramsDesc=[{type:oC|iC},{type:vC}],e}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"calcLambda",value:function(e,t,n,r){var a=n[0];if(a.isPrimitive()){var o,i=null!==(o=e.parameterScope)&&void 0!==o?o:[];return i[r[0].index]=a,e.parameterScope=i,t.getVar(e)}for(var u=a.rowCount(),s=[],l=a.isRef()?a.toRefMatrix():a,c=0;c<u;c++){var h,f=xu(l,c,1),d=null!==(h=e.parameterScope)&&void 0!==h?h:[];d[r[0].index]=f,e.parameterScope=d;var v=t.getVar(e);if(v.isPrimitive())s.push([v]);else if(1===v.rowCount()){for(var g=[],m=0;m<v.size();m++)g.push(v.nth(m,e));s.push(g)}else s.push([uR])}return new Ru(s)}}]),t}(Xz);Qz=Gi([cc("BYROW")],Qz);var eG=function(e){function t(){var e;return(0,y.Z)(this,t),(e=(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))).name="BYCOL",e.operands=2,e.paramsDesc=[{type:oC|iC},{type:vC}],e}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"calcLambda",value:function(e,t,n,r){var a=n[0];if(a.isPrimitive()){var o,i=null!==(o=e.parameterScope)&&void 0!==o?o:[];return i[r[0].index]=a,e.parameterScope=i,t.getVar(e)}for(var u=a.colCount(),s=[[]],l=a.isRef()?a.toRefMatrix():a,c=0;c<u;c++){var h,f=Ou(l,c,1),d=null!==(h=e.parameterScope)&&void 0!==h?h:[];d[r[0].index]=f,e.parameterScope=d;var v=t.getVar(e);if(v.isPrimitive())s[0][c]=v;else if(1===v.colCount())for(var g=0;g<v.size();g++)s[g]||(s[g]=[]),s[g][c]=v.nth(g,e);else s[0][c]=iR}return new Ru(s)}}]),t}(Xz);eG=Gi([cc("BYCOL")],eG);var tG=function(e){function t(){var e;return(0,y.Z)(this,t),(e=(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))).name="MAKEARRAY",e.operands=3,e.paramsDesc=[{type:tC},{type:tC},{type:vC}],e}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"calcLambda",value:function(e,t,n,r){var a=n[0],o=Math.trunc(a.getValue());if(o<1)return K_(this.name,o,1,1);var i=n[1],u=Math.trunc(i.getValue());if(u<1)return K_(this.name,u,2,1);for(var s=[],l=0;l<o;l++){s[l]||(s[l]=[]);for(var c=0;c<u;c++){var h,f=null!==(h=e.parameterScope)&&void 0!==h?h:[];f[r[0].index]=new ut.NumberVar(l+1),f[r[1].index]=new ut.NumberVar(c+1),e.parameterScope=f;var d=t.getVar(e);d.isPrimitive()?s[l][c]=d:1===d.size()?s[l][c]=d.nth(0,e):1===u&&1!==d.colCount()?s[l][c]=uR:1===o&&1!==d.rowCount()?s[l][c]=iR:s[l][c]=sR}}return new Ru(s)}}]),t}(Xz);tG=Gi([cc("MAKEARRAY")],tG);var nG=function(e){function t(){var e;return(0,y.Z)(this,t),(e=(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))).name="MAP",e.operands=1,e.optionOperands=252,e.repeatedLastParam=1,e.paramsDesc=[{type:oC|iC},{type:oC|iC},{type:vC}],e}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"calcLambda",value:function(e,t,n,r){if(!function(e){for(var t=e[0],n=t.isPrimitive()||1===t.size(),r=1;r<e.length;r++){var a=e[r];if(n){if(!a.isPrimitive()&&1!==a.size())return!1}else if(a.isPrimitive()||t.rowCount()!==a.rowCount()||t.colCount()!==a.colCount())return!1}return!0}(n))return we.d$b[we.O6N.NA_ARRAY_SIZES_NOT_EQUAL]({funcName:this.name});var a=n[0];if(a.isPrimitive()||1===a.size()){for(var o,i=null!==(o=e.parameterScope)&&void 0!==o?o:[],u=0;u<n.length;u++)i[r[u].index]=n[u],e.parameterScope=i;return t.getVar(e)}for(var s=a.rowCount(),l=a.colCount(),c=[],h=0;h<s;h++)for(var f=0;f<l;f++){for(var d,v=null!==(d=e.parameterScope)&&void 0!==d?d:[],g=0;g<n.length;g++){var m=n[g];v[r[g].index]=new Ru([[m.getVarByPos(h,f)]])}e.parameterScope=v;var p=t.getVar(e);c[h]||(c[h]=[]),p.isPrimitive()?c[h][f]=p:1===p.size()?c[h][f]=p.nth(0,e):1===l&&1!==p.colCount()?c[h][f]=uR:1===s&&1!==p.rowCount()?c[h][f]=iR:c[h][f]=sR}return new Ru(c)}},{key:"repeatedParam",get:function(){return[mw.Head,1]}}]),t}(Xz);nG=Gi([cc("MAP")],nG);var rG=function(e){function t(){var e;return(0,y.Z)(this,t),(e=(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))).name="REDUCE",e.operands=3,e.paramsDesc=[{type:oC|iC},{type:oC|iC},{type:vC}],e}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"calcLambda",value:function(e,t,n,r){var a=n[0],o=n[1];if(o.isPrimitive()||1===o.size()){var i,u=null!==(i=e.parameterScope)&&void 0!==i?i:[];return u[r[0].index]=a,u[r[1].index]=o,e.parameterScope=u,t.getVar(e)}for(var s=0;s<o.size();s++){var l,c=null!==(l=e.parameterScope)&&void 0!==l?l:[];c[r[0].index]=a,c[r[1].index]=new Ru([[o.nth(s,e)]]),e.parameterScope=c,a=t.getVar(e)}return a}}]),t}(Xz);rG=Gi([cc("REDUCE")],rG);var aG=function(e){function t(){var e;return(0,y.Z)(this,t),(e=(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))).name="SCAN",e.operands=3,e.optionOperands=0,e.repeatedLastParam=0,e.paramsDesc=[{type:oC|iC},{type:oC|iC},{type:vC}],e}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"calcLambda",value:function(e,t,n,r){var a=n[0],o=n[1];if(o.isPrimitive()||1===o.size()){var i,u=null!==(i=e.parameterScope)&&void 0!==i?i:[];return u[r[0].index]=a,u[r[1].index]=o,e.parameterScope=u,t.getVar(e)}for(var s=o.rowCount(),l=o.colCount(),c=[],h=0;h<s;h++){c[h]||(c[h]=[]);for(var f=0;f<l;f++){var d,v=null!==(d=e.parameterScope)&&void 0!==d?d:[];v[r[0].index]=a,v[r[1].index]=new Ru([[o.nth(h*l+f,e)]]),e.parameterScope=v,(a=t.getVar(e)).isPrimitive()?c[h][f]=a:1===a.size()?c[h][f]=a.nth(0,e):1===l&&1!==a.colCount()?c[h][f]=uR:1===s&&1!==a.rowCount()?c[h][f]=iR:c[h][f]=sR}}return new Ru(c)}}]),t}(Xz);function oG(e,t,n,r,a,o,i,u,s){var l=ke.SheetDate.fromNumber(e),c=ke.SheetDate.fromNumber(t),h=ke.SheetDate.fromNumber(r),f=ke.SheetDate.fromNumber(n),d=lG(e),v=lG(t),g=lG(r),m=lG(n),p=sN(f,l,s),y=sN(l,h,s),C=sN(f,h,s),_=bN({settlement:l,maturity:c,frequency:u,basis:s}),R=yN(l,c,u).count,w=100*a/u,k=1+o/u;if(y>_){var S=sN(h,c,s),E=new Date(g.getFullYear(),g.getMonth(),g.getDate());switch(s){case 0:case 4:R=1+parseInt(Math.ceil(S/_).toString(),10);break;default:for(R=0;R<32767;R++){var T=ke.SheetDate.fromUTCDate(E);if(E.setMonth(E.getMonth()+12/u),E>=v){R+=parseInt((Math.ceil(sN(T,c,s))/bN({settlement:T,maturity:ke.SheetDate.fromUTCDate(E),frequency:u,basis:s})).toString(),10)+1;break}}p=_*uG(m,d,g,u,s),y=_*uG(d,g,g,u,s),C=_*uG(m,g,g,u,s)}}return i/Math.pow(k,R-1+y/_)+w*(C/_/Math.pow(k,y/_)+(1===k?1:Math.pow(k,-y/_)*(Math.pow(k,-R)-1/k)/(1/k-1))-p/_)}function iG(e,t,n,r){var a=t.getFullYear(),o=t.getMonth(),i=t.getDate(),u=new Date(1,0,1),s=0,l=i===(0,ke.getDaysOfMonth)(a,o),c=12/n,h=a-e.getFullYear();u.setFullYear(1),h>0&&(h=(h-1)*n);do{h++,(u=new Date(a,o,i)).setMonth(o-h*c),l&&(s=(0,ke.getDaysOfMonth)(u.getFullYear(),u.getMonth()),u=new Date(u.getFullYear(),u.getMonth(),s))}while(e<u);return r&&(h--,(u=new Date(a,o,i)).setMonth(o-h*c),l&&(s=(0,ke.getDaysOfMonth)(u.getFullYear(),u.getMonth()),u=new Date(u.getFullYear(),u.getMonth(),s))),u}function uG(e,t,n,r,a){var o=iG(e,n,r,!0),i=iG(e,n,r,!1);if(o>=t)return sN(ke.SheetDate.fromUTCDate(e),ke.SheetDate.fromUTCDate(t),a)/bN({settlement:ke.SheetDate.fromUTCDate(i),maturity:ke.SheetDate.fromUTCDate(o),frequency:r,basis:a});for(var u=sN(ke.SheetDate.fromUTCDate(e),ke.SheetDate.fromUTCDate(o),a)/bN({settlement:ke.SheetDate.fromUTCDate(i),maturity:ke.SheetDate.fromUTCDate(o),frequency:r,basis:a});;){if(i=new Date(o.getFullYear(),o.getMonth(),o.getDate()),o.setMonth(o.getMonth()+12/r),o>=t)return u+sN(ke.SheetDate.fromUTCDate(i),ke.SheetDate.fromUTCDate(t),a)/bN({settlement:ke.SheetDate.fromUTCDate(i),maturity:ke.SheetDate.fromUTCDate(o),frequency:r,basis:a});u+=1}}function sG(e,t,n,r,a,o,i,u,s){for(var l=lG(t),c=lG(n),h=lG(r),f=new Date(h.getFullYear(),h.getMonth(),h.getDate());f<c;)f=new Date(f.getFullYear(),f.getMonth()+12/u,f.getDate());var d=uG(h,l,f,u,s),v=uG(h,c,f,u,s),g=uG(l,c,f,u,s);return e?(i*u+100*a*(v-d*(1+o*g/u)))/(o*g+u):(u*(i-o)+100*a*(v-d))/(g*o+100*a*d*g/u)}function lG(e){var t=ke.SheetDate.fromNumber(e).time,n=t.year,r=t.month,a=t.date;return new Date(n,r-1,a)}function cG(e,t,n,r,a,o,i,u,s,l,c,h){var f=fG(t,n,o,u,s,l,c,!0);if(f instanceof ut.ErrorVar)return f;var d=f.s,v=f.m,g=f.r,m=f.redem,p=f.freq,y=f.b,C=e.ref.sheet();if(!C)return ut.VALUE_ERR_VAR;var _=r.getValue();if(_<=0)return q_(c,_,3,0);if(_>=d)return eR(c,C,_,3,d,1);var R=a.getValue();if(R<=0)return q_(c,R,4,0);if(d>=R)return eR(c,C,d,1,R,4);if(R>=v)return eR(c,C,R,4,v,2);var w=i.getValue();return h?w<0?K_(c,w,6,0):oG(d,v,_,R,g,w,m,p,y):w<=0?q_(c,w,6,0):function(e,t,n,r,a,o,i,u,s){function l(o){return oG(e,t,n,r,a,o,i,u,s)}for(var c=0,h=a||.01,f=l(h),d=f-o;100>=c&&1e-7<Math.abs(d);c++)f=l(1.01*h),d=(f=l(h=-d/(f-o-d)*h*.01+h))-o;return h}(d,v,_,R,g,w,m,p,y)}function hG(e,t,n,r,a,o,i,u,s,l,c){var h=fG(t,n,a,i,u,s,l,!1);if(h instanceof ut.ErrorVar)return h;var f=h.s,d=h.m,v=h.r,g=h.redem,m=h.freq,p=h.b,y=e.ref.sheet();if(!y)return ut.VALUE_ERR_VAR;if(f>=d)return vR(l,(0,Mt.excelDateToJSDate)(f),(0,Mt.excelDateToJSDate)(d));var C=r.getValue();if(C<=0)return q_(l,C,3,0);if(C>=f)return eR(l,y,C,3,f,1);var _=o.getValue();return c?_<0?K_(l,_,5,0):sG(!0,f,d,C,v,_,g,m,p):_<=0?q_(l,_,5,0):sG(!1,f,d,C,v,_,g,m,p)}function fG(e,t,n,r,a,o,i,u){var s=e.getValue();if(s<=0)return q_(i,s,1,0);var l=t.getValue();if(l<=0)return q_(i,l,2,0);var c=n.getValue();if(c<0)return K_(i,c,u?5:4,0);var h=r.getValue();if(h<=0)return q_(i,h,u?7:6,0);var f=Math.floor(a.getValue());if(!RN(f))return kN(i,a.getValue(),u?8:7);var d=Math.floor(o.getValue());return wN(d)?{s:s,m:l,r:c,redem:h,freq:f,b:d}:SN(i,o.getValue(),u?9:8)}aG=Gi([cc("SCAN")],aG);var dG=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e,t,n,r,a,o,i,u,s){var l=hG(e,t,n,r,a,o,i,u,s,this.name,!0);return l instanceof ut.ErrorVar?l:new ut.NumberVar(l)}}]),t}(gC("ODDLPRICE",7,1,0,tC,[{type:tC},{type:tC},{type:tC},{type:tC},{type:tC},{type:tC},{type:tC},{type:tC,default:new ut.NumberVar(0)}])),vG=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e,t,n,r,a,o,i,u,s){var l=hG(e,t,n,r,a,o,i,u,s,this.name,!1);return l instanceof ut.ErrorVar?l:new ut.NumberVar(l)}}]),t}(gC("ODDLYIELD",7,1,0,tC,[{type:tC},{type:tC},{type:tC},{type:tC},{type:tC},{type:tC},{type:tC},{type:tC,default:new ut.NumberVar(0)}])),gG=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e,t,n,r,a,o,i,u,s,l){var c=cG(e,t,n,r,a,o,i,u,s,l,this.name,!0);return c instanceof ut.ErrorVar?c:new ut.NumberVar(c)}}]),t}(gC("ODDFPRICE",8,1,0,tC,[{type:tC},{type:tC},{type:tC},{type:tC},{type:tC},{type:tC},{type:tC},{type:tC},{type:tC,default:new ut.NumberVar(0)}])),mG=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e,t,n,r,a,o,i,u,s,l){var c=cG(e,t,n,r,a,o,i,u,s,l,this.name,!1);return c instanceof ut.ErrorVar?c:new ut.NumberVar(c)}}]),t}(gC("ODDFYIELD",8,1,0,tC,[{type:tC},{type:tC},{type:tC},{type:tC},{type:tC},{type:tC},{type:tC},{type:tC},{type:tC,default:new ut.NumberVar(0)}])),pG=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e,t,n){var r=[],a=Math.floor(n.getValue());if(0!==a&&1!==a)return nR(this.name,a.toString(),2,"0, 1");if(t.isPrimitive()){var o=t.getValue().toString();return t.isBool()&&(o=o.toUpperCase()),new ut.StringVar(0===a?o:"{".concat(o,"}"))}if(t.iter(Object.assign({},e,{skipEmptyRef:!1})).forEach((function(e){if(e.isError())r.push(e.desc);else if(e.isString()){var t=1===a?'"'.concat(e.getValue(),'"'):e.getValue();r.push(t)}else e.isBool()?r.push(e.toStringVar().getValue().toUpperCase()):(e.isNumber()||e.isNull())&&r.push(e.toStringVar().getValue())})),0===a)return new ut.StringVar(r.join(", "));for(var i=t.colCount(),u=0;u<r.length-1;u++)r[u]+=(u+1)%i==0?";":",";return new ut.StringVar("{".concat(r.join(""),"}"))}}]),t}(gC("ARRAYTOTEXT",1,1,0,nC,[{type:oC|iC},{type:tC,default:new ut.NumberVar(0)}])),yG=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e,t){var n,r=t.getValue(),a=Math.abs(parseInt(r,10)),o=parseFloat((Math.abs(r)-a).toFixed(2));return n=0===a?0!==o?(r<0?"ลบ":"")+CG(100*o)+"สตางค์":"ศูนย์บาทถ้วน":0===o?(r<0?"ลบ":"")+CG(a)+"บาทถ้วน":(r<0?"ลบ":"")+CG(a)+"บาท"+CG(100*o)+"สตางค์",new ut.StringVar(n)}}]),t}(gC("BAHTTEXT",1,0,0,nC,[{type:tC}]));function CG(e){for(var t=["ล้าน","สิบ","ร้อย","พัน","หมื่น","แสน",""],n=["ศูนย์","หนึ่ง","สอง","สาม","สี่","ห้า","หก","เจ็ด","แปด","เก้า"],r=["ลบ","บาท","ถ้วน","สตางค์","ยี่","เอ็ด",","," ","฿"],a=0,o=0,i="",u="",s=e.toString(),l=s.length,c=l;0<c;--c){if(i=n[a=parseInt(s[l-c],10)],1==(o=1<c?(c-1)%6:6)&&2===a&&(i=r[4]),1===a)switch(o){case 0:case 6:u+=c<l?r[5]:i;break;case 1:break;default:u+=i}else{if(0===a){0===o&&(u+=t[o]);continue}u+=i}u+=t[o]}return u}var _G=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e,t){var n=t.getValue();"boolean"==typeof n&&(n=n.toString().toUpperCase());for(var r="",a=0;a<n.length;a++){var o=n.charCodeAt(a);r+=o>=33&&o<=126?String.fromCharCode(o+65248):32===o?String.fromCharCode(12288):n.charAt(a)}return new ut.StringVar(r)}}]),t}(gC("DBCS",1,0,0,nC,[{type:nC|rC}])),RG=function(e){function t(){var e;return(0,y.Z)(this,t),(e=(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))).name="JIS",e}return(0,g.Z)(t,e),t}(_G),wG=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e,t,n,r){var a=t.getValue();a=a.replace(/\s+/g,"");var o=n?n.getValue():".";if(null===o){var i=t.toNumberVar(e.service);return i.isNumber()?i:nw(this.name,a)}if(""===o)return yR(this.name,2,"",ut.FormulaErrorPhrases.DATA_TYPE_EMPTY,ut.FormulaErrorPhrases.DATA_TYPE_STRING);o=o[0];var u=a.split(o),s=r?r.getValue():null,l="",c=u[0].replace(/,/g,""),h=0;if(null!==s){if(""===s)return yR(this.name,3,"",ut.FormulaErrorPhrases.DATA_TYPE_EMPTY,ut.FormulaErrorPhrases.DATA_TYPE_STRING);if(o===(s=s[0]))return nw(this.name,a);c=c.split(s).join("")}if(""===a.trim())return new ut.NumberVar(0);if(null===a.match(/^\s*[+-]?\s*(?:(?:\d+(?:\.\d*)?)|(?:\.\d+))(?:[eE][+-]?\d+)?[ \t]*/))return nw(this.name,a);var f=c.length-1;if(u.length>2)return nw(this.name,a);if(1===u.length){for(","===o&&(c=c.replace(/\./g,""));"%"===c[f];)h++,f--;c=c.replace(new RegExp("%","g"),"")}else{if(f=(l=u[1]).length-1,isNaN(Number(c)))return nw(this.name,a);for(;"%"===l[f];)h++,f--;l=l.replace(new RegExp("%","g"),"")}var d=1===u.length?Number(c):Number("".concat(c,".").concat(l));if(isNaN(d))return nw(this.name,a);for(var v=0;v<h;v++)d/=100;return new ut.NumberVar(d)}}]),t}(gC("NUMBERVALUE",1,2,0,tC,[{type:nC},{type:nC},{type:nC}])),kG=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e,t,n,r,a,o,i){return SG(e,this.name,t,n,r,a,o,i,!1)}}]),t}(gC("TEXTAFTER",2,4,0,oC,[{type:nC},{type:nC|iC},{type:tC|eC,default:ut.NULL_VAR},{type:tC,default:new ut.NumberVar(0)},{type:tC,default:new ut.NumberVar(0)},{type:nC|aC,default:ew}]));function SG(e,t,n,r,a,o,i,u,s){var l=n.getValue(),c=a.isNumber()?Math.floor(a.getValue()):1;if(0===c)return KR(t,3);var h,f=[];if(r.isCollection()){if(r.iter(Object.assign({},e,{skipEmptyRef:!1})).exitWhen((function(e){return e.isError()&&(h=e),!!h})).forEach((function(e){e.isNull()?f.push(""):f.push(e.getValue().toString())})),h)return h}else f.push(r.getValue());if(f.some((function(e){return 0===e.length})))return s?c>0?new ut.StringVar(""):n:c>0?n:new ut.StringVar("");if(0===l.length&&0!==f.length&&a.isNumber())return IR(t,1);if(a.isNumber()&&c>l.length)return pR(t,3,c,l.length);var d=Math.floor(o.getValue());if(0!==d&&1!==d)return nR(t,d.toString(),4,"0, 1");var v=Math.floor(i.getValue());if(0!==v&&1!==v)return nR(t,v.toString(),5,"0, 1");1===d&&(l=l.toLocaleLowerCase(),f=f.map((function(e){return e.toLocaleLowerCase()})));for(var g=-1,m=-1,p=c>0?0:l.length-1,y=1;y<=Math.abs(c);y++){g=-1;for(var C=0;C<f.length;C++){var _=f[C],R=c>0?l.indexOf(_,p):l.lastIndexOf(_,p);if(-1!==R){g=R,m=C,p=c>0?R+1:R-1;break}}if(-1===g)return 1===v&&y===Math.abs(c)?s&&c>0||!s&&c<0?n:new ut.StringVar(""):u}var w=s?l.substring(0,g):l.substring(g+f[m].length);return new ut.StringVar(w)}var EG=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e,t,n,r,a,o,i){return SG(e,this.name,t,n,r,a,o,i,!0)}}]),t}(gC("TEXTBEFORE",2,4,0,oC,[{type:nC},{type:nC|iC},{type:tC|eC,default:ut.NULL_VAR},{type:tC,default:new ut.NumberVar(0)},{type:tC,default:new ut.NumberVar(0)},{type:nC|aC,default:ew}])),TG=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e,t,n,r,a,o,i){var u=t.getValue();if(""===u)return yR(this.name,1,"",ut.FormulaErrorPhrases.DATA_TYPE_EMPTY,ut.FormulaErrorPhrases.DATA_TYPE_STRING);var s=Math.floor(o.getValue());if(0!==s&&1!==s)return nR(this.name,s.toString(),5,"0, 1");if(u=1===s?u.toLowerCase():u,""===n.getValue())return yR(this.name,2,"",ut.FormulaErrorPhrases.DATA_TYPE_EMPTY,ut.FormulaErrorPhrases.DATA_TYPE_STRING);var l=[];if(n.isPrimitive())l.push(n.getValue());else if((l=IG(e,n,2,this.name))instanceof ut.ErrorVar)return l;var c=[];if(r.isPrimitive())c.push(r.getValue());else if((c=IG(e,r,3,this.name))instanceof ut.ErrorVar)return c;for(var h=a.getValue(),f=[],d=0;d<c.length;d++)l.includes(c[d])||f.push(c[d]);1===s&&(l=l.map((function(e){return e.toLowerCase()})),f=f.map((function(e){return e.toLowerCase()})));var v;v=0===f.length?[u]:AG(f,u,h);for(var g=[],m=1,p=0;p<v.length;p++){var y=AG(l,v[p],h).map((function(e){return new ut.StringVar(e)}));m=y.length>m?y.length:m,0===y.length&&h||g.push(y)}return g.forEach((function(e){for(var t=m-e.length,n=0;n<t;n++)e.push(i)})),new Ru(g)}}]),t}(gC("TEXTSPLIT",2,4,0,iC,[{type:nC},{type:nC|iC},{type:nC|iC,default:new ut.StringVar("")},{type:rC,default:ut.BOOLEAN_VAR_MAP[ut.BooleanConstant.FALSE]},{type:tC,default:new ut.NumberVar(0)},{type:oC,default:tw}]));function AG(e,t,n){if(""===t||1===e.length&&""===e[0])return[t];for(var r=[],a=0,o=1;o<=t.length;o++)for(var i=t.slice(a,o),u=0;u<e.length;u++){var s=e[u];if(-1!==i.indexOf(s)){r.push(i.split(s)[0]),o===t.length&&r.push(i.split(s)[1]),a=o;break}if(u===e.length-1&&o===t.length){r.push(i);break}}return n?r.filter((function(e){return""!==e})):r}function IG(e,t,n,r){var a,o=[];return t.iter(Object.assign({},e,{skipEmptyRef:!1})).exitWhen((function(e){return e.isError()?a=e:(e.isNull()||""===e.getValue())&&(a=yR(r,n,"",ut.FormulaErrorPhrases.DATA_TYPE_EMPTY,ut.FormulaErrorPhrases.DATA_TYPE_STRING)),!!a})).forEach((function(e){o.push(e.getValue().toString())})),a||o}TG=Gi([cc("TEXTSPLIT")],TG);var bG=function(e){function t(){var e;return(0,y.Z)(this,t),(e=(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))).convertVariant=function(e,t){var n=t.argument;return n.isCollection()&&1!==n.size()?{isError:!0,convertedArgument:ut.VALUE_ERR_VAR,srcArg:n}:rw(e,t)},e}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e,t,n){var r,a=Math.floor(n.getValue());return 0!==a&&1!==a?nR(this.name,a.toString(),2,"0, 1"):(r=t.isError()?t.desc:t.isString()?1===a?'"'.concat(t.getValue(),'"'):t.getValue():t.toStringVar(e.service).getValue()||"",new ut.StringVar(r))}}]),t}(gC("VALUETOTEXT",1,1,0,nC,[{type:oC},{type:tC,default:new ut.NumberVar(0)}]));function FG(e,t){for(var n=0,r=0;r<e.length;++r)n=t*n+e[r];return n}function MG(e,t,n,r,a){if(0===t)return n;if(1===t)return r;for(var o=2/e,i=r,u=1;u<t;++u)i=r*u*o+a*n,n=r,r=i;return i}function VG(e,t,n,r){return function(a,o){if(n){if(0===a)return 1===n?-1/0:1/0;if(a<0)return NaN}return 0===o?e(a):1===o?t(a):o<0?NaN:MG(a,o|=0,e(a),t(a),r)}}var NG=function(){var e=.636619772,t=[57568490574,-13362590354,651619640.7,-11214424.18,77392.33017,-184.9052456].reverse(),n=[57568490411,1029532985,9494680.718,59272.64853,267.8532712,1].reverse(),r=[1,-.001098628627,2734510407e-14,-2073370639e-15,2.093887211e-7].reverse(),a=[-.01562499995,.0001430488765,-6911147651e-15,7.621095161e-7,-9.34935152e-8].reverse();function o(o){var i=0,u=0,s=0,l=o*o;if(o<8)i=(u=FG(t,l))/(s=FG(n,l));else{var c=o-.785398164;u=FG(r,l=64/l),s=FG(a,l),i=Math.sqrt(e/o)*(Math.cos(c)*u-Math.sin(c)*s*8/o)}return i}var i=[72362614232,-7895059235,242396853.1,-2972611.439,15704.4826,-30.16036606].reverse(),u=[144725228442,2300535178,18583304.74,99447.43394,376.9991397,1].reverse(),s=[1,.00183105,-3516396496e-14,2457520174e-15,-2.40337019e-7].reverse(),l=[.04687499995,-.0002002690873,8449199096e-15,-8.8228987e-7,1.05787412e-7].reverse();function c(t){var n=0,r=0,a=0,o=t*t,c=Math.abs(t)-2.356194491;return Math.abs(t)<8?n=(r=t*FG(i,o))/(a=FG(u,o)):(r=FG(s,o=64/o),a=FG(l,o),n=Math.sqrt(e/Math.abs(t))*(Math.cos(c)*r-Math.sin(c)*a*8/Math.abs(t)),t<0&&(n=-n)),n}return function e(t,n){if(n=Math.round(n),!isFinite(t))return isNaN(t)?t:0;if(n<0)return(n%2?-1:1)*e(t,-n);if(t<0)return(n%2?-1:1)*e(-t,n);if(0===n)return o(t);if(1===n)return c(t);if(0===t)return 0;var r=0;if(t>n)r=MG(t,n,o(t),c(t),-1);else{for(var a=!1,i=0,u=0,s=1,l=0,h=2/t,f=2*Math.floor((n+Math.floor(Math.sqrt(40*n)))/2);f>0;f--)l=f*h*s-i,i=s,s=l,Math.abs(s)>1e10&&(s*=1e-10,i*=1e-10,r*=1e-10,u*=1e-10),a&&(u+=s),a=!a,f===n&&(r=i);r/=u=2*u-s}return r}}(),OG=function(){var e=.636619772,t=[-2957821389,7062834065,-512359803.6,10879881.29,-86327.92757,228.4622733].reverse(),n=[40076544269,745249964.8,7189466.438,47447.2647,226.1030244,1].reverse(),r=[1,-.001098628627,2734510407e-14,-2073370639e-15,2.093887211e-7].reverse(),a=[-.01562499995,.0001430488765,-6911147651e-15,7.621095161e-7,-9.34945152e-8].reverse();var o=[-4900604943e3,127527439e4,-51534381390,734926455.1,-4237922.726,8511.937935].reverse(),i=[249958057e5,424441966400,3733650367,22459040.02,102042.605,354.9632885,1].reverse(),u=[1,.00183105,-3516396496e-14,2457520174e-15,-2.40337019e-7].reverse(),s=[.04687499995,-.0002002690873,8449199096e-15,-8.8228987e-7,1.05787412e-7].reverse();return VG((function(o){var i=0,u=0,s=0,l=o*o,c=o-.785398164;return o<8?i=(u=FG(t,l))/(s=FG(n,l))+e*NG(o,0)*Math.log(o):(u=FG(r,l=64/l),s=FG(a,l),i=Math.sqrt(e/o)*(Math.sin(c)*u+Math.cos(c)*s*8/o)),i}),(function(t){var n=0,r=0,a=0,l=t*t,c=t-2.356194491;return t<8?n=(r=t*FG(o,l))/(a=FG(i,l))+e*(NG(t,1)*Math.log(t)-1/t):(r=FG(u,l=64/l),a=FG(s,l),n=Math.sqrt(e/t)*(Math.sin(c)*r+Math.cos(c)*a*8/t)),n}),1,-1)}(),xG=function(){var e=[1,3.5156229,3.0899424,1.2067492,.2659732,.0360768,.0045813].reverse(),t=[.39894228,.01328592,.00225319,-.00157565,.00916281,-.02057706,.02635537,-.01647633,.00392377].reverse();function n(n){return n<=3.75?FG(e,n*n/14.0625):Math.exp(n)/Math.sqrt(n)*FG(t,3.75/n)}var r=[.5,.87890594,.51498869,.15084934,.02658733,.00301532,32411e-8].reverse(),a=[.39894228,-.03988024,-.00362018,.00163801,-.01031555,.02282967,-.02895312,.01787654,-.00420059].reverse();function o(e){return e<3.75?e*FG(r,e*e/14.0625):Math.exp(e)/Math.sqrt(e)*FG(a,3.75/e)}return function e(t,r){if(0===r)return n(Math.abs(t));if(1===r)return Math.sign(t)*o(Math.abs(t));if(0===Math.abs(t))return 0;if(t===1/0)return 1/0;var a,i=0,u=0,s=1,l=0,c=2/Math.abs(t);for(a=2*Math.round((r+Math.round(Math.sqrt(40*r)))/2);a>0;a--)l=a*c*s+u,u=s,s=l,Math.abs(s)>1e10&&(s*=1e-10,u*=1e-10,i*=1e-10),a===r&&(i=u);return i*=e(t,0)/s,t<0&&r%2?-i:i}}(),ZG=function(){var e=[-.57721566,.4227842,.23069756,.0348859,.00262698,1075e-7,74e-7].reverse(),t=[1.25331414,-.07832358,.02189568,-.01062446,.00587872,-.0025154,53208e-8].reverse();var n=[1,.15443144,-.67278579,-.18156897,-.01919402,-.00110404,-4686e-8].reverse(),r=[1.25331414,.23498619,-.0365562,.01504268,-.00780353,.00325614,-68245e-8].reverse();return VG((function(n){return n<=2?-Math.log(n/2)*xG(n,0)+FG(e,n*n/4):Math.exp(-n)/Math.sqrt(n)*FG(t,2/n)}),(function(e){return e<=2?Math.log(e/2)*xG(e,1)+1/e*FG(n,e*e/4):Math.exp(-e)/Math.sqrt(e)*FG(r,2/e)}),2,1)}(),DG=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e,t,n){var r=t.getValue(),a=n.getValue();if(a<0)return K_(this.name,a,2,0);a=Math.floor(a);var o=xG(r,a);return o===1/0||isNaN(o)?G_:new ut.NumberVar(o)}}]),t}(gC("BESSELI",2,0,0,tC,[{type:tC},{type:tC}])),PG=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e,t,n){var r=t.getValue(),a=n.getValue();if(a<0)return K_(this.name,a,2,0);if(a>1e7)return X_(this.name,a,2,1e7);a=Math.floor(a);var o=NG(r,a);return new ut.NumberVar(o)}}]),t}(gC("BESSELJ",2,0,0,tC,[{type:tC},{type:tC}])),LG=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e,t,n){var r=t.getValue();if(r<=0)return q_(this.name,r,1,0);var a=n.getValue();if(a<0)return K_(this.name,a,2,0);a=Math.floor(a);var o=ZG(r,a);return o===1/0||isNaN(o)?G_:new ut.NumberVar(o)}}]),t}(gC("BESSELK",2,0,0,tC,[{type:tC},{type:tC}])),BG=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e,t,n){var r=t.getValue();if(r<=0)return q_(this.name,r,1,0);var a=n.getValue();if(a<0)return K_(this.name,a,2,0);a=Math.floor(a);var o=OG(r,a);return o===1/0||isNaN(o)?G_:new ut.NumberVar(o)}}]),t}(gC("BESSELY",2,0,0,tC,[{type:tC},{type:tC}])),UG=function(e){function t(){var e;return(0,y.Z)(this,t),(e=(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))).name="BETAINV",e}return(0,g.Z)(t,e),t}(Mt.BETAINVFunc),HG=function(e){function t(){var e;return(0,y.Z)(this,t),(e=(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))).alwaysCalc=!0,e}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e,t){var n=e.ref.sheet();if(!n)return TR(this.name,-1,"");var r,a=n.getParent();if(t.isNull())r=a.getSheetIndex(n.name());else if(t.isString())r=a.getSheetIndex(t.getValue());else{if(!Fu(t))return ut.NA_ERR_VAR;var o=t.getRef().sheet();if(!o)return TR(this.name,-1,"");r=a.getSheetIndex(o.name())}return null===r?ut.NA_ERR_VAR:new ut.NumberVar(r+1)}}]),t}(gC("SHEET",0,1,0,tC,[{type:iC|nC|eC,default:new ut.NullVar}])),WG=function(e){function t(){var e;return(0,y.Z)(this,t),(e=(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))).alwaysCalc=!0,e}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e){var t=e.ref.sheet();return t?new ut.NumberVar(t.getParent().sheets.length):TR(this.name,-1,"")}}]),t}(gC("SHEETS",0,0,0,tC,[])),jG=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e,t){var n=!!e.parameterScope;return new ut.BooleanVar(n&&t.isNull())}}]),t}(gC("ISOMITTED",1,0,0,rC,[{type:dC}])),zG=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e,t,n,r){var a=Math.trunc(n.getValue()),o=Math.trunc(r.getValue()),i=Fu(t)?t.toRefMatrix():t,u=a>0?a:0,s=i.rowCount()-Math.abs(a);if(s<1)return z_(this.name,2,a,-i.rowCount(),i.rowCount());var l=xu(i,u,s);if(0!==o){var c=o>0?o:0,h=i.colCount()-Math.abs(o);if(h<1)return z_(this.name,3,o,-i.colCount(),i.colCount());l=Ou(l,c,h)}return l}}]),t}(gC("DROP",2,1,0,iC,[{type:iC},{type:tC},{type:tC,default:new ut.NumberVar(0)}]));zG=Gi([cc("DROP")],zG);var GG=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e,t,n,r){var a=Math.trunc(n.getValue());if(0===a)return KR(this.name,2);var o=Fu(t)?t.toRefMatrix():t,i=a>0?0:o.rowCount()+a;if(o=xu(o,i,Math.abs(a)),!r)return o;var u=Math.trunc(r.getValue());if(0===u)return KR(this.name,3);var s=u>0?0:o.colCount()+u;return o=Ou(o,s,Math.abs(u))}}]),t}(gC("TAKE",2,1,0,iC,[{type:iC},{type:tC},{type:tC}]));GG=Gi([cc("TAKE")],GG);var JG=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e,t,n,r,a){var o=t.rowCount(),i=t.colCount(),u=Math.trunc(n.getValue()),s=r.isNull()?i:Math.trunc(r.getValue());if(u<o)return Y_(this.name,u,2,o);if(s<i)return Y_(this.name,s,3,i);for(var l=[],c=0;c<u;c++){l[c]=[];for(var h=0;h<s;h++)l[c][h]=c<o&&h<i?t.nth(c*i+h,e):a}return new Ru(l)}}]),t}(gC("EXPAND",2,2,0,iC,[{type:iC},{type:tC},{type:tC|eC,default:ut.NULL_VAR},{type:oC,default:tw}]));JG=Gi([cc("EXPAND")],JG);var qG=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e,t,n,r,a){var o=t.getValue(),i=e.ref.sheet();if(!i||!i.parent.importFormulaManager)return ut.RUNTIME_ERR_VAR;var u=!r.isNull(),s=!a.isNull(),l=Math.floor(n.getValue()),c=function(e,t,n){if(e<1)return Y_("IMAGE",e,2,1);if(e>4)return pR("IMAGE",2,e,4);var r=!t.isNull(),a=!n.isNull();if(4!==e&&(r||a))return FR("IMAGE",r&&a?4:3,2);if(4===e){if(!r||!a)return FR("IMAGE",r||a?3:2,4);var o=t.getValue(),i=n.getValue();if(o<=0)return Y_("IMAGE",o,3,1);if(i<=0)return Y_("IMAGE",i,4,1)}return null}(l,r,a);if(c)return c;var h=e.formula,f="IMAGE",d=i.parent.importFormulaManager;if(d.hasBlackToken(h))return we.d$b[we.O6N.IMPORT_ERR_CAN_NOT_USE_BLACK_LIST_FUNCTION]();if(!(0,we.CBv)(o)||o.endsWith("webp"))return we.d$b[we.O6N.IMPORT_ERR_INVAILD_URL]({value:o});var v=JSON.stringify({link:o}),g=d.getImportFormulaId(f,v);d.setImportFormulaContent(h,v,g,o,f);var m=d.getFormulaDataById(g),p=function(e){return new Pc(new Dc({width:100,height:100,link:o,fileToken:e,mode:l,customWidth:u?r.getValue():void 0,customHeight:s?a.getValue():void 0}))};if(m){if(m instanceof we.AXu){var y=we.d$b[m.code];return y?y():(0,we.NN_)(m.code,"")}if(m.fileToken)return p(m.fileToken)}return d.fetchFormulaDataById(g).then((function(e){if(e instanceof we.AXu){var t=we.d$b[e.code];return t?e.code===we.O6N.IMPORT_ERR_DATA_SIZE_OVER_LIMIT?t({num:2}):t():(0,we.NN_)(e.code,"")}if(!e.fileToken)throw e;return p(e.fileToken)})).catch((function(e){return e instanceof ut.ErrorVar?e:(0,we.NN_)(we.O6N.REQUEST_FAIL,null==e?void 0:e.message)})).finally((function(){e.service.emit("afterWaitAsyncCalc",e.formula,1)})),e.service.addCalculatingAsyncFormula(e.formula),ut.WAIT_ASYNC_ERR_VAR}}]),t}(gC("IMAGE",1,3,0,cC|lC,[{type:nC},{type:tC,default:new ut.NumberVar(1)},{type:tC|eC,default:ut.NULL_VAR},{type:tC|eC,default:ut.NULL_VAR}]));function $G(e,t,n,r,a,o){if(t.hasBlackToken(o))return we.d$b[we.O6N.IMPORT_ERR_CAN_NOT_USE_BLACK_LIST_FUNCTION]();if(!(0,we.CBv)(n))return we.d$b[we.O6N.IMPORT_ERR_INVAILD_URL]({value:n});var i=t.getImportFormulaId(r,a);t.setImportFormulaContent(o,a,i,n,r);var u=t.getFormulaDataById(i);if(u){if(u instanceof we.AXu){var s=we.d$b[u.code];return s?s():(0,we.NN_)(u.code,"")}if(u.table)return new Ru(u.table)}return t.fetchFormulaDataById(i).then((function(e){if(e instanceof we.AXu){var t=we.d$b[e.code];return t?e.code===we.O6N.IMPORT_ERR_DATA_SIZE_OVER_LIMIT?t({num:10}):t():(0,we.NN_)(e.code,"")}if(!e.table)throw e;return new Ru(e.table)})).catch((function(e){return e instanceof ut.ErrorVar?e:(0,we.NN_)(we.O6N.REQUEST_FAIL,null==e?void 0:e.message)})).finally((function(){e.service.emit("afterWaitAsyncCalc",e.formula,0)})),e.service.addCalculatingAsyncFormula(e.formula),ut.WAIT_ASYNC_ERR_VAR}var YG,KG=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e,t,n,r){var a=t.getValue(),o=e.service.spread;if(!o||!o.importFormulaManager)return ut.RUNTIME_ERR_VAR;var i=r.isNull()?e.service.spread.locale:r.getValue(),u=e.formula;return $G(e,o.importFormulaManager,a,"IMPORTXML",JSON.stringify({link:a,xpathQuery:n.getValue(),language:i}),u)}}]),t}(gC("IMPORTXML",2,1,0,iC|lC,[{type:nC},{type:nC},{type:nC|eC,default:ut.NULL_VAR}]));KG=Gi([cc("IMPORTXML")],KG),function(e){e.table="table",e.list="list"}(YG||(YG={}));var XG=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e,t,n,r,a){var o=t.getValue(),i=e.ref.sheet();if(!i||!i.parent.importFormulaManager)return ut.RUNTIME_ERR_VAR;var u=n.getValue().toLowerCase();if("table"!==u&&"list"!==u)return nR("IMPORTHTML",u,2,["table","list"]);var s=r.getValue();if(s<1)return Y_("IMPORTHTML",s,3,1);var l=a.isNull()?e.service.spread.locale:a.getValue(),c=e.formula;return $G(e,i.parent.importFormulaManager,o,"IMPORTHTML",JSON.stringify({link:o,query:u,index:Math.floor(s),language:l}),c)}}]),t}(gC("IMPORTHTML",3,1,0,iC|lC,[{type:nC},{type:nC},{type:tC},{type:nC|eC,default:ut.NULL_VAR}]));XG=Gi([cc("IMPORTHTML")],XG);var QG=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e,t,n,r){var a=t.getValue(),o=e.ref.sheet();if(!o||!o.parent.importFormulaManager)return ut.RUNTIME_ERR_VAR;n.isNull()&&(n=a.endsWith("tsv")?new ut.StringVar("\t"):new ut.StringVar(","));var i=n.getValue();if(1!==i.length&&"\\t"!==i||'"'===i||" "===i)return we.d$b[we.O6N.IMPORT_ERR_INVAILD_DELIMITER]({funcName:"IMPORTDATA",value:i});var u=r.isNull()?e.service.spread.locale:r.getValue(),s=e.formula;return $G(e,o.parent.importFormulaManager,a,"IMPORTDATA",JSON.stringify({link:a,delimiter:"\\t"===i?9:i.charCodeAt(0),language:u}),s)}}]),t}(gC("IMPORTDATA",1,2,0,iC|lC,[{type:nC},{type:nC|eC,default:ut.NULL_VAR},{type:nC|eC,default:ut.NULL_VAR}]));QG=Gi([cc("IMPORTDATA")],QG);var eJ=["feed","feed title","feed description","feed author","feed url","items","items title","items author","items url","items created","items summary"],tJ=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"func",value:function(e,t,n,r,a){var o=t.getValue(),i=e.ref.sheet();if(!i||!i.parent.importFormulaManager)return ut.RUNTIME_ERR_VAR;var u=n.getValue().trim().toLowerCase()||"items";if(-1===eJ.indexOf(u))return nR("IMPORTFEED",u,2,eJ);if(!a.isNull()){var s=a.getValue();if(s>250||s<1)return gR("IMPORTFEED",4,s,1,250)}var l=e.formula;return $G(e,i.parent.importFormulaManager,o,"IMPORTFEED",JSON.stringify({link:o,query:n.getValue(),needTitle:r.getValue(),limit:a.isNull()?void 0:a.getValue()}),l)}}]),t}(gC("IMPORTFEED",1,3,0,iC|lC,[{type:nC},{type:nC,default:new ut.StringVar("items")},{type:rC,default:ut.BOOLEAN_VAR_MAP[ut.BooleanConstant.FALSE]},{type:tC|eC,default:ut.NULL_VAR}]));tJ=Gi([cc("IMPORTFEED")],tJ);var nJ=new Map([["=",ut.EqualsOp],["<>",ut.NotEqualsOp],["<",ut.LessThanOp],["<=",ut.LessThanEqualsOp],[">",ut.GreaterThanOp],[">=",ut.GreaterThanEqualsOp],["+",Hy],["-",Wy],["*",ut.MultiplyOp],["/",ut.DivideOp],["%",ut.ModOp],["&",ut.ConcatenateOp],["^",ut.PowerOp],[" ",tV],[",",nV],[":",eV]]),rJ=new Map([["+",ut.PositiveOp],["-",ut.NegativeOp]]),aJ=new Map([["%",ut.PercentOp]]),oJ=new Map([["ACCRINT",FN],["ACCRINTM",MN],["ADD",hz],["ADDRESS",pZ],["ARABIC",NN],["AREAS",DD],["ACOT",lU],["ACOTH",cU],["ARRAY_CONSTRAIN",xN],["ARRAYFORMULA",ON],["AVERAGEA",DN],["AI_WRITE",oj],["AI_DEEPSEEK_WRITE",ij],["AI_ASK",uj],["AI_IMPORTDATA",sj],["AI_INFER",cj],["AI_CLASSIFY",gj],["AI_EXTRACT",mj],["AI_TRANSLATE",pj],["AI_SENTIMENT",yj],["AI_SUMMARY",Cj],["AI_POLISH",_j],["AVERAGEIF",dZ],["AVERAGEIFS",vZ],["AVERAGE.WEIGHTED",dO],["AMORLINC",ZU],["BINOMDIST",kW],["BINOM.DIST",SW],["BINOM.DIST.RANGE",EW],["BASE",vO],["BITAND",pO],["BITLSHIFT",yO],["BITOR",CO],["BITRSHIFT",_O],["BITXOR",RO],["CELL",QB],["CHOOSE",wD],["COLUMN",cZ],["COLUMNS",hZ],["COT",fU],["COTH",dU],["COUNTBLANK",sD],["COUNT",Mt.COUNTFunc],["COUNTIFS",fZ],["COUPDAYBS",RZ],["COUPDAYS",wZ],["COUPDAYSNC",kZ],["COUPNCD",SZ],["COUPNUM",EZ],["COUPPCD",TZ],["CSC",vU],["CSCH",gU],["CORREL",VW],["COVARIANCE.P",OW],["COVARIANCE.S",NW],["CONFIDENCE",pU],["CONFIDENCE.T",RU],["CONFIDENCE.NORM",mU],["DATEDIF",nZ],["DATE",RD],["DATEVALUE",SD],["DCOUNT",tW],["DCOUNTA",nW],["DGET",iW],["DMAX",uW],["DMIN",sW],["DPRODUCT",rW],["DSTDEV",aW],["DSTDEVP",oW],["DSUM",lW],["DVAR",cW],["DVARP",hW],["DAVERAGE",eW],["DAY",Yx],["DAYS360",oZ],["DAYS",aZ],["DB",FU],["DDB",dH],["DISC",LZ],["DOLLAR",qB],["DURATION",zZ],["EDATE",yZ],["ENCODEURL",Mt.ENCODEURLFunc],["EOMONTH",CZ],["EXPONDIST",HU],["EXPON.DIST",UU],["EPOCHTODATE",Rj],["FALSE",TD],["FIXED",JB],["FORMULATEXT",iZ],["FREQUENCY",uZ],["GAMMA",HD],["GAUSS",fW],["GEOMEAN",WD],["HARMEAN",jD],["LOGNORMDIST",dW],["LOGNORM.DIST",vW],["LOGINV",gW],["LOGNORM.INV",mW],["NORMINV",pW],["NORM.INV",yW],["FORECAST.LINEAR",UW],["FORECAST",HW],["FDIST",GW],["F.DIST",JW],["F.DIST.RT",WW],["F.INV",YW],["FINV",$W],["F.INV.RT",qW],["FTEST",XW],["F.TEST",KW],["ZTEST",ej],["Z.TEST",QW],["HLOOKUP",uD],["HOUR",tZ],["HYPERLINK",kD],["HYPGEOMDIST",jU],["HYPGEOM.DIST",zU],["IFNA",lD],["IMAGE",qG],["IMPORTDATA",QG],["IMPORTFEED",tJ],["IMPORTHTML",XG],["IMPORTRANGE",P_],["IMPORTXML",KG],["INDEX",Ux],["INDIRECT",_Z],["ISBLANK",hD],["ISDATE",Mj],["ISEMAIL",Vj],["ISURL",Nj],["ISERROR",cD],["ISFORMULA",fD],["ISREF",dD],["ISOWEEKNUM",$D],["JOIN",uP],["LOOKUP",BZ],["LAMBDA",Rw],["LET",ww],["MATCH",WV],["MAXA",UZ],["MAXIFS",hP],["MDURATION",jZ],["MINA",GZ],["MINIFS",fP],["MINUTE",eZ],["MMULT",dP],["MODE",Fw],["MODE.SNGL",Fw],["MODE.MULT",XZ],["MONTH",Kx],["NETWORKDAYS",gD],["NETWORKDAYS.INTL",AD],["NOW",Jx],["NEGBINOMDIST",IW],["NEGBINOM.DIST",bW],["OFFSET",qx],["PDURATION",PZ],["PRICEMAT",TH],["PRIVATE_AND",hV],["PRIVATE_ARRAY_LITERAL",tN],["PRIVATE_ARRAY_ROW",XV],["PRIVATE_OR",gV],["PRIVATE_CELL_CONTAINTEXT",aV],["PRIVATE_CELLIS",rV],["PRIVATE_CONTAINTEXT",oV],["PRIVATE_DUPLICATE",lV],["PRIVATE_GET_REF",cV],["PRIVATE_ICONS",ZV],["PRIVATE_UNIQUE",OV],["PRIVATE_DATA_BAR",iV],["PRIVATE_TWO_COLOR_SCALE",UV],["PRIVATE_THREE_COLOR_SCALE",BV],["PRIVATE_PERCENTILE_REFS",mV],["PRIVATE_MIN_REFS",vV],["PRIVATE_MAX_REFS",dV],["PRIVATE_PERCENTILE_REFS",mV],["PRIVATE_RANK",pV],["PRIVATE_SORT",RV],["PRIVATE_AVERAGE",fV],["PRIVATE_CUSTOM_FORMULA",DV],["PRIVATE_LIST_VALIDATION",JV],["PRIVATE_CHECKBOX",HV],["PRIVATE_FORMATTER_VALIDATION",$V],["PRIVATE_IS_INT",YV],["PRIVATE_PIVOT_TABLE",BM],["PROPER",$B],["PRICE",JZ],["PRICEDISC",YZ],["PEARSON",LW],["RANK",tD],["RANK.AVG",KB],["RANK.EQ",YB],["RECEIVED",MH],["ROW",sZ],["ROWS",lZ],["RRI",AH],["RSQ",BW],["SEC",wU],["SECH",kU],["SECOND",Qx],["SKEW",qD],["SKEW.P",GD],["SORT",eP],["SORTBY",Iz],["SORTN",Fz],["SPLIT",tP],["SUBTOTAL",yw],["SUMIF",Lx],["SUMIFS",Bx],["SUMPRODUCT",UO],["STEYX",PW],["SLOPE",DW],["T",sP],["TBILLEQ",oU],["TBILLPRICE",iU],["TBILLYIELD",uU],["TEXT",Hx],["TIME",Wx],["TIMEVALUE",jx],["TODAY",zx],["TRANSPOSE",XD],["TRUE",ED],["TYPE",iD],["TDIST",$U],["T.DIST",qU],["T.DIST.2T",YU],["T.DIST.RT",KU],["TINV",QU],["T.INV",eH],["T.INV.2T",XU],["TTEST",nH],["T.TEST",tH],["VLOOKUP",MO],["WEEKDAY",_D],["WEEKNUM",yD],["WORKDAY",ND],["WORKDAY.INTL",ZD],["WEIBULL",PU],["WEIBULL.DIST",DU],["YEARFRAC",VD],["YEAR",Xx],["YIELD",MU],["YIELDDISC",NU],["YIELDMAT",VU],["ABS",Mt.ABSFunc],["ACOS",Mt.ACOSFunc],["ACOSH",Mt.ACOSHFunc],["AND",Mt.ANDFunc],["ASC",Mt.ASCFunc],["ASIN",Mt.ASINFunc],["ASINH",Mt.ASINHFunc],["ATAN2",Mt.ATAN2Func],["ATAN",Mt.ATANFunc],["ATANH",Mt.ATANHFunc],["AVEDEV",Mt.AVEDEVFunc],["AVERAGE",Mt.AVERAGEFunc],["BETADIST",Mt.BETADISTCDFFunc],["BETA.DIST",Mt.BETADISTFunc],["BETA.INV",Mt.BETAINVFunc],["BIN2DEC",Mt.BIN2DECFunc],["BIN2HEX",Mt.BIN2HEXFunc],["BIN2OCT",Mt.BIN2OCTFunc],["BINOM.INV",AW],["DECIMAL",ZW],["CEILING",Mt.CEILINGFunc],["CEILING.MATH",Mt.CEILINGMATHFunc],["CEILING.PRECISE",Mt.CEILINGPRECISEFunc],["CHAR",Mt.CHARFunc],["CLEAN",Mt.CLEANFunc],["CODE",wO],["COMBIN",Mt.COMBINFunc],["COMPLEX",Mt.COMPLEXFunc],["CONCATENATE",Mt.CONCATENATEFunc],["CONCAT",Mt.CONCATFunc],["CONVERT",Mt.CONVERTFunc],["COS",Mt.COSFunc],["COSH",Mt.COSHFunc],["COUNTA",Mt.COUNTAFunc],["COUNTIF",PD],["COVAR",Mt.COVARFunc],["CUMIPMT",AZ],["CUMPRINC",Mt.CUMPRINCFunc],["CHIDIST",FZ],["CHISQ.DIST.RT",MZ],["CHISQ.INV.RT",NZ],["CHIINV",VZ],["CHISQ.DIST",OZ],["CHITEST",xZ],["CHISQ.INV",ZZ],["CHISQ.TEST",DZ],["CRITBINOM",TW],["COMBINA",xW],["DEC2BIN",Mt.DEC2BINFunc],["DEC2HEX",Mt.DEC2HEXFunc],["DEC2OCT",Mt.DEC2OCTFunc],["DEGREES",Mt.DEGREESFunc],["DELTA",Mt.DELTAFunc],["DOLLARDE",EU],["DOLLARFR",TU],["EFFECT",Mt.EFFECTFunc],["ERFC",Mt.ERFCFunc],["ERFC.PRECISE",Mt.ERFCFunc],["ERF",Mt.ERFFunc],["ERF.PRECISE",Mt.ERFPRECISEFunc],["ERROR.TYPE",Mt.ERRORTYPEFunc],["EVEN",Mt.EVENFunc],["EXACT",Mt.EXACTFunc],["EXP",Mt.EXPFunc],["FACTDOUBLE",Mt.FACTDOUBLEFunc],["FACT",Mt.FACTFunc],["FILTER",aP],["FIND",Mt.FINDFunc],["FINDB",wH],["FLOOR",Mt.FLOORFunc],["FLOOR.MATH",Mt.FLOORMATHFunc],["FLOOR.PRECISE",Mt.FLOORPRECISEFunc],["FV",Mt.FVFunc],["FVSCHEDULE",Mt.FVSCHEDULEFunc],["FISHER",GU],["FISHERINV",JU],["GAMMA.DIST",Mt.GAMMADISTFunc],["GAMMADIST",Mt.GAMMADISTFunc],["GAMMA.INV",Mt.GAMMAINVFunc],["GAMMAINV",Mt.GAMMAINVFunc],["GAMMALN",Mt.GAMMALNFunc],["GAMMALN.PRECISE",Mt.GAMMALNFunc],["GCD",Mt.GCDFunc],["GESTEP",Mt.GESTEPFunc],["GETPIVOTDATA",jH],["GROWTH",nU],["HEX2DEC",Mt.HEX2DECFunc],["HEX2BIN",Tj],["HEX2OCT",Aj],["IFERROR",Mt.IFERRORFunc],["IF",LD],["IFS",BD],["IMABS",Mt.IMABSFunc],["IMAGINARY",Mt.IMAGINARYFunc],["IMARGUMENT",Mt.IMARGUMENTFunc],["IMCONJUGATE",Mt.IMCONJUGATEFunc],["IMCOS",Mt.IMCOSFunc],["IMDIV",Mt.IMDIVFunc],["IMEXP",Mt.IMEXPFunc],["IMLN",Mt.IMLNFunc],["IMLOG10",Mt.IMLOG10Func],["IMLOG2",Mt.IMLOG2Func],["IMPOWER",Mt.IMPOWERFunc],["IMPRODUCT",Mt.IMPRODUCTFunc],["IMSUB",Mt.IMSUBFunc],["IMSUM",Mt.IMSUMFunc],["INTERCEPT",Mt.INTERCEPTFunc],["INT",Mt.INTFunc],["IPMT",Mt.IPMTFunc],["IRR",Mt.IRRFunc],["ISERR",Mt.ISERRFunc],["ISEVEN",Mt.ISEVENFunc],["ISLOGICAL",Mt.ISLOGICALFunc],["ISPMT",UD],["ISNA",Mt.ISNAFunc],["ISNONTEXT",Mt.ISNONTEXTFunc],["ISNUMBER",Mt.ISNUMBERFunc],["ISODD",Mt.ISODDFunc],["ISTEXT",Mt.ISTEXTFunc],["INTRATE",vD],["KURT",zD],["LARGE",Mt.LARGEFunc],["LCM",Mt.LCMFunc],["LEFT",Mt.LEFTFunc],["LEFTB",SH],["LEN",Mt.LENFunc],["LENB",Mt.LENBFunc],["LINEST",eU],["LN",Mt.LNFunc],["LOG",Mt.LOGFunc],["LOG10",Mt.LOG10Func],["LOGEST",rU],["LOWER",Mt.LOWERFunc],["MAX",Mt.MAXFunc],["MEDIAN",Mt.MEDIANFunc],["MID",Mt.MIDFunc],["MIDB",_H],["MIN",Mt.MINFunc],["MIRR",Mt.MIRRFunc],["MOD",Mt.MODFunc],["MROUND",Mt.MROUNDFunc],["MARGINOFERROR",nj],["N",Mt.NFunc],["NA",Mt.NAFunc],["NOMINAL",Mt.NOMINALFunc],["NORM.DIST",Mt.NORMDISTFunc],["NORMDIST",Mt.NORMDISTFunc],["NORMSDIST",Mt.NORMSDISTCDFFunc],["NORM.S.DIST",Mt.NORMSDISTFunc],["NORM.S.INV",Mt.NORMSINVFunc],["NORMSINV",Mt.NORMSINVFunc],["NOT",Mt.NOTFunc],["NPER",Mt.NPERFunc],["NPV",Mt.NPVFunc],["ODD",Mt.ODDFunc],["OR",Mt.ORFunc],["OCT2BIN",Ij],["OCT2DEC",bj],["OCT2HEX",Fj],["PERCENTILE",Mt.PERCENTILEFunc],["PERCENTILE.INC",VH],["PERCENTRANK",Mt.PERCENTRANKFunc],["PERCENTILE.EXC",Tw],["PERCENTRANK.EXC",xH],["PERCENTRANK.INC",ZH],["PI",Mt.PIFunc],["PMT",Mt.PMTFunc],["PPMT",Mt.PPMTFunc],["POW",wz],["POWER",Mt.POWERFunc],["PRODUCT",Mt.PRODUCTFunc],["PV",Mt.PVFunc],["POISSON",IH],["POISSON.DIST",bH],["PROB",tj],["PHI",rj],["STANDARDIZE",FH],["PERMUT",LU],["PERMUTATIONA",BU],["QUARTILE",Mt.QUARTILEFunc],["QUARTILE.INC",DH],["QUARTILE.EXC",Iw],["QUOTIENT",Mt.QUOTIENTFunc],["QUERY",LB],["RADIANS",Mt.RADIANSFunc],["RANDBETWEEN",Mt.RANDBETWEENFunc],["RAND",Mt.RANDFunc],["RANDARRAY",nz],["RATE",Mt.RATEFunc],["REGEXEXTRACT",WB],["REGEXMATCH",HB],["REGEXREPLACE",jB],["REPLACE",Mt.REPLACEFunc],["REPLACEB",kH],["REPT",nD],["RIGHT",Mt.RIGHTFunc],["RIGHTB",EH],["ROMAN",oD],["ROUNDDOWN",Mt.ROUNDDOWNFunc],["ROUND",Mt.ROUNDFunc],["ROUNDUP",Mt.ROUNDUPFunc],["SEARCH",Mt.SEARCHFunc],["SEARCHB",RH],["SEQUENCE",rz],["SIGN",Mt.SIGNFunc],["SIN",Mt.SINFunc],["SINH",Mt.SINHFunc],["SLN",Mt.SLNFunc],["SYD",xU],["SMALL",Mt.SMALLFunc],["SQRT",Mt.SQRTFunc],["SQRTPI",Mt.SQRTPIFunc],["STDEV",Mt.STDEVFunc],["STDEVP",Mt.STDEVPFunc],["SUBSTITUTE",Mt.SUBSTITUTEFunc],["SUM",Mt.SUMFunc],["SWITCH",rP],["TAN",Mt.TANFunc],["TANH",Mt.TANHFunc],["TEXTJOIN",sU],["TO_DATE",az],["TO_DOLLARS",uz],["TO_PERCENT",sz],["TO_PURE_NUMBER",iz],["TO_TEXT",oz],["TREND",tU],["TRIM",Mt.TRIMFunc],["TRIMMEAN",Mt.TRIMMEANFunc],["TRUNC",Mt.TRUNCFunc],["UNIQUE",iP],["UPPER",Mt.UPPERFunc],["UNICHAR",zH],["UNICODE",GH],["VALUE",Mt.VALUEFunc],["VAR",Mt.VARFunc],["VARP",Mt.VARPFunc],["VAR.P",oH],["VAR.S",aH],["VARA",uH],["VARPA",sH],["STDEV.P",lH],["STDEV.S",cH],["STDEVA",hH],["STDEVPA",fH],["DEVSQ",rH],["VDB",OU],["XIRR",Mt.XIRRFunc],["XLOOKUP",MD],["XMATCH",FD],["XNPV",Mt.XNPVFunc],["XOR",Mt.XORFunc],["IMSQRT",xj],["IMCOSH",Zj],["IMCOT",Dj],["IMCOTH",Pj],["IMCSC",Lj],["IMCSCH",Bj],["IMLOG",Uj],["IMREAL",Hj],["IMSEC",Wj],["IMSECH",jj],["IMSIN",zj],["IMSINH",Gj],["IMTAN",Jj],["IMTANH",qj],["MULTINOMIAL",$j],["ISO.CEILING",Yj],["MUNIT",Kj],["SERIESSUM",Xj],["SUMSQ",Qj],["COUNTUNIQUE",ez],["ADD",hz],["DIVIDE",fz],["EQ",dz],["GT",vz],["GTE",gz],["ISBETWEEN",mz],["LT",pz],["LTE",yz],["MINUS",Cz],["MULTIPLY",_z],["NE",Rz],["POW",wz],["UMINUS",kz],["UNARY_PERCENT",Sz],["UPLUS",Ez],["MDETERM",Nz],["MINVERSE",Oz],["SUMX2MY2",Dz],["SUMX2PY2",Pz],["SUMXMY2",Lz],["FLATTEN",Bz],["TOROW",jz],["TOCOL",Wz],["CHOOSEROWS",Jz],["CHOOSECOLS",Gz],["VSTACK",qz],["HSTACK",$z],["WRAPCOLS",Yz],["WRAPROWS",Kz],["BYCOL",eG],["BYROW",Qz],["MAKEARRAY",tG],["MAP",nG],["REDUCE",rG],["SCAN",aG],["ODDLPRICE",dG],["ODDLYIELD",vG],["ODDFPRICE",gG],["ODDFYIELD",mG],["ARRAYTOTEXT",pG],["BAHTTEXT",yG],["DBCS",_G],["JIS",RG],["NUMBERVALUE",wG],["TEXTAFTER",kG],["TEXTBEFORE",EG],["TEXTSPLIT",TG],["VALUETOTEXT",bG],["BESSELI",DG],["BESSELJ",PG],["BESSELK",LG],["BESSELY",BG],["BETAINV",UG],["SHEET",HG],["SHEETS",WG],["ISOMITTED",jG],["TAKE",GG],["DROP",zG],["EXPAND",JG],["AGGREGATE",Vw]]),iJ=function(){function e(t){(0,y.Z)(this,e),this.calcEngine=t,this.formulaMgr=new ff,this.refMapMgr=new df,this.formulaRefPool=new hf(this.formulaMgr,this.refMapMgr),this.rangeCache=new Map}return(0,C.Z)(e,[{key:"fromJSON",value:function(e,t,n){var r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{},a=r.enableCalculation,o=void 0===a||a,i=r.useCache,u=void 0===i||i,s=e.v,l=e.tokens,c=e.refs,h=e.params,f=e.tree,d=e.importRangeId,v=e.externalDataReference,g=Jw[s-1],m=null;try{var y;if(null==g)throw new Error("Failed to deserialize: not supported formula data version");if(m=this.cacheRefs(g.deserializeRefs(c,n,t,Object.assign({},r,{relativeRef:!0})),u),u){var C,_=this.formulaMgr.getByVal({tokens:l,params:h,importRangeId:null!==(C=d)&&void 0!==C?C:null==v?void 0:v.importRangeId});if(_)return[_,m]}var R=!1,w=!1,k=Object.assign({},Gy),S=null,E=!1;if(o){var T=g.deserializeParams(h),A=g.deserializeTree(e.tree,m,{calcEngine:this.calcEngine,visitFunctions:g.visitFunctions,params:T}),I=(0,p.Z)(A,5);S=I[0],k=I[1],R=I[2],w=I[3],E=I[4]}var b=null===S?f:null,F=Hw(n,d,v);return[this.cacheFormula(new lf({tokens:l,serialization:b,expression:S,params:h,importRangeId:null!==(y=d)&&void 0!==y?y:null==v?void 0:v.importRangeId,importRangeMeta:null==F?void 0:F.importRangeMeta,externalDataReferenceInfo:null==F?void 0:F.externalDataReferenceInfo},{hasSubtotal:R,hasAggregate:w,hasArrayFunction:E},k,o),u),m]}catch(t){return[new lf({tokens:e.tokens,expression:[Uw(t.message)]}),m]}}},{key:"fromMutation",value:function(e,t,n,r){var a=this,o=arguments.length>4&&void 0!==arguments[4]?arguments[4]:{},i=o.enableCalculation,u=void 0===i||i,s=o.useCache,l=void 0===s||s,c=e.v,h=e.tokens,f=e.refs,d=e.params,v=e.tree,g=e.importRangeId,m=e.externalDataReference,y=Jw[c-1],C=null;try{if(null==y)throw new Error("Failed to deserialize: not supported formula data version");var _=r.formulaDataId,R=r.formulaRefMapId,w=r.cellValueRefHelper;C=this.cacheRefsFromMutation(R,w,(function(){return y.deserializeRefs(f,n,t,Object.assign({},o,{relativeRef:!0}))}),l);var k=this.cacheFormulaFromMutation(_,w,(function(){var t,r=!1,o=!1,i=null,s=null,l=!1;if(u){var c=y.deserializeParams(d),f=y.deserializeTree(e.tree,C,{calcEngine:a.calcEngine,visitFunctions:y.visitFunctions,params:c}),_=(0,p.Z)(f,5);s=_[0],i=_[1],r=_[2],o=_[3],l=_[4]}var R=null===s?v:null,w=Hw(n,g,m);return new lf({tokens:h,serialization:R,expression:s,params:d,importRangeId:null!==(t=g)&&void 0!==t?t:null==m?void 0:m.importRangeId,importRangeMeta:null==w?void 0:w.importRangeMeta,externalDataReferenceInfo:null==w?void 0:w.externalDataReferenceInfo},{hasSubtotal:r,hasAggregate:o,hasArrayFunction:l},i,u)}),l);if(null==k)throw new Error("Failed to deserialize formula");return[k,C]}catch(t){return[new lf({tokens:e.tokens,expression:[Uw(t.message)]}),C]}}},{key:"fromBuilder",value:function(e,t){var n,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,a=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null,o=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null,i=arguments.length>5?arguments[5]:void 0,u=!(arguments.length>6&&void 0!==arguments[6])||arguments[6],s=e.getTokens(),l=e.getParams(),c=e.hasSubtotal,h=e.hasAggregate,f=e.hasArrayFunction,d=e.alwaysCalcInfo,v=e.hasAsyncFunction,g=e.getRefs(),m=this.cacheRefs(this.absolute2relativeRefs(g,t),u),p=new lf({tokens:s,serialization:r,expression:a,params:null!==(n=l)&&void 0!==n?n:void 0,externalDataReferenceInfo:o},{hasSubtotal:c,hasAggregate:h,hasArrayFunction:f,hasAsyncFunction:v},d,i);return[p=this.cacheFormula(p,u),m]}},{key:"flushRanges",value:function(e){var t=this;if(0!==this.rangeCache.size)return(void 0===e?Array.from(this.rangeCache.keys()):[e]).reduce((function(e,n){var r=t.rangeCache.get(n);return t.rangeCache.delete(n),e[n]=r?Array.from(r).map((function(e){var t=(0,p.Z)(e,2),n=t[0],r=t[1];return[n,Array.from(r.values())]})):[],e}),{})}},{key:"cacheFormula",value:function(e){var t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];return t?this.formulaMgr.add(e):e}},{key:"cacheRefs",value:function(e){var t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];return t&&e?this.refMapMgr.add(e):e}},{key:"cacheFormulaFromMutation",value:function(e,t,n){var r=this,a=!(arguments.length>3&&void 0!==arguments[3])||arguments[3];if(!a)return n();var o=null;return t.formulaDatas.checkValuesRefId(e,(function(e){var t;o=null!==(t=r.formulaMgr.get(e))&&void 0!==t?t:null}),(function(){var e=n();if(e){var t=r.formulaMgr.add(e);return o=t,r.formulaMgr.getHash(t)}})),o}},{key:"cacheRefsFromMutation",value:function(e,t,n){var r=this,a=!(arguments.length>3&&void 0!==arguments[3])||arguments[3];if(!a)return n();var o=null;return t.formulaRefMaps.checkValuesRefId(e,(function(e){var t;o=null!==(t=r.refMapMgr.get(e))&&void 0!==t?t:null}),(function(){var e=n();if(e){var t=r.refMapMgr.add(e);return o=t,r.refMapMgr.getHash(t)}})),o}},{key:"cacheRange",value:function(e,t){var n,r,a=t.hostId;if(a){var o=null!==(n=this.rangeCache.get(a))&&void 0!==n?n:new Map;this.rangeCache.set(a,o);var i=null!==(r=o.get(e))&&void 0!==r?r:new Map;o.set(e,i),i.set(t.hash(),t)}}},{key:"absolute2relativeRefs",value:function(e,t){return e?Object.entries(e).reduce((function(e,n){var r=(0,p.Z)(n,2),a=r[0],o=r[1];return e[a]=Si(o,t),e}),{}):null}},{key:"clear",value:function(){this.refMapMgr.clear(),this.formulaMgr.clear(),this.formulaRefPool.clear(),this.rangeCache.clear()}},{key:"destroy",value:function(){this.clear()}}]),e}(),uJ=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:9;(0,y.Z)(this,e),this.size=0,this.maxSize=Math.max(4,t),this.minSize=Math.max(2,Math.ceil(.4*this.maxSize)),this.clear()}return(0,C.Z)(e,[{key:"all",value:function(){var e=[];return mJ(this.root,e),e}},{key:"isEmpty",value:function(){return 0===this.root.children.length}},{key:"search",value:function(e,t){var n=this.root;if(void 0===t&&(t=[]),!co(e,n.ref))return t;for(var r=[];n;){for(var a=0;a<n.children.length;a++){var o=n.children[a];co(e,o.ref)&&(n.leaf?t.push(o):so(e,o.ref)?mJ(o,t):r.push(o))}n=r.pop()}return t}},{key:"insert",value:function(e){return this.add(e,this.root.height-1),this.size++,this}},{key:"insertItems",value:function(e){if(this.size+=e.length,e.length<this.minSize){for(var t=0,n=e.length;t<n;t++)this.add(e[t],this.root.height-1);return this}var r=CJ(e.slice(),0,e.length-1,0,this.maxSize);if(this.root.children.length)if(this.root.height===r.height)this.root=yJ(this.root,r);else{if(this.root.height<r.height){var a=this.root;this.root=r,r=a}this.add(r,this.root.height-r.height-1)}else this.root=r;return this}},{key:"remove",value:function(e){var t,n=this.root,r=[],a=[],o=0,i=!1;for(this.size--;n||r.length;){if(n||(n=r.pop(),t=r[r.length-1],o=a.pop(),i=!0),n.leaf){var u=n.children.indexOf(e);if(-1!==u)return n.children.splice(u,1),r.push(n),this.condense(r),this}i||n.leaf||!so(n.ref,e.ref)?t?(o++,n=t.children[o],i=!1):n=void 0:(r.push(n),a.push(o),o=0,t=n,n=n.children[0])}return this}},{key:"removeItems",value:function(e){for(var t=0,n=e.length;t<n;t++)this.remove(e[t]);return this}},{key:"update",value:function(){return RJ(this.root),this}},{key:"getSize",value:function(){return this.size}},{key:"clear",value:function(){return this.root=gJ([]),this.size=0,this}},{key:"add",value:function(e,t){var n=[],r=function(e,t,n,r){for(;r.push(t),!t.leaf&&r.length-1!==n;){for(var a=void 0,o=1/0,i=1/0,u=0;u<t.children.length;u++){var s=t.children[u],l=Ro(s.ref),c=dJ(e.ref,s.ref)-l;c<i?(i=c,o=l<o?l:o,a=s):c===i&&l<o&&(o=l,a=s)}t=a||t.children[0]}return t}(e,this.root,t,n);for(r.children.push(e),po(r.ref,e.ref);t>=0&&n[t].children.length>this.maxSize;)this.split(n,t),t--;for(var a=t;a>=0;a--)po(n[a].ref,e.ref)}},{key:"split",value:function(e,t){var n=e[t],r=n.children.length,a=this.minSize;!function(e,t,n){pJ(e,t,n,cJ)<pJ(e,t,n,hJ)&&e.children.sort(cJ)}(n,a,r);var o=function(e,t,n){for(var r,a=1/0,o=1/0,i=t;i<=n-t;i++){var u=lJ(e,0,i),s=lJ(e,i,n),l=vJ(u,s),c=Ro(u)+Ro(s);l<a?(a=l,r=i,o=c<o?c:o):l===a&&c<o&&(o=c,r=i)}return r||n-t}(n,a,r),i=gJ(n.children.splice(o,n.children.length-o));i.height=n.height,i.leaf=n.leaf,sJ(n),sJ(i),t?e[t-1].children.push(i):this.root=yJ(n,i)}},{key:"condense",value:function(e){for(var t,n=e.length-1;n>=0;n--)0===e[n].children.length?n>0?(t=e[n-1]).children.splice(t.children.indexOf(e[n]),1):this.clear():sJ(e[n])}}]),e}();function sJ(e){lJ(e,0,e.children.length,e.ref)}function lJ(e,t,n,r){r||(r={startRow:1/0,endRow:-1/0,startCol:1/0,endCol:-1/0});for(var a=t;a<n;a++)po(r,e.children[a].ref);return r}function cJ(e,t){return e.ref.startCol-t.ref.startCol}function hJ(e,t){return e.ref.startRow-t.ref.startRow}function fJ(e){return e.endCol-e.startCol+(e.endRow-e.startRow)}function dJ(e,t){return(Math.max(t.endCol,e.endCol)-Math.min(t.startCol,e.startCol))*(Math.max(t.endRow,e.endRow)-Math.min(t.startRow,e.startRow))}function vJ(e,t){var n=Math.max(e.startCol,t.startCol),r=Math.max(e.startRow,t.startRow),a=Math.min(e.endCol,t.endCol),o=Math.min(e.endRow,t.endRow);return Math.max(0,a-n)*Math.max(0,o-r)}function gJ(e){return{children:e,height:1,leaf:!0,ref:{startRow:1/0,endRow:-1/0,startCol:1/0,endCol:-1/0}}}function mJ(e,t){if(e.leaf)for(var n=0,r=e.children.length;n<r;n++)t.push(e.children[n]);else for(var a=0,o=e.children.length;a<o;a++)mJ(e.children[a],t)}function pJ(e,t,n,r){e.children.sort(r);for(var a=lJ(e,0,t),o=lJ(e,n-t,n),i=fJ(a)+fJ(o),u=t;u<n-t;u++)po(a,e.children[u].ref),i+=fJ(a);for(var s=n-t-1;s>=t;s--)po(o,e.children[s].ref),i+=fJ(o);return i}function yJ(e,t){var n=gJ([e,t]);return n.height=e.height+1,n.leaf=!1,sJ(n),n}function CJ(e,t,n,r,a){var o,i=n-t+1;if(i<=a)return sJ(o=gJ(e.slice(t,n+1))),o;var u=a;0===r&&(r=Math.ceil(Math.log(i)/Math.log(u)),u=Math.ceil(i/Math.pow(u,r-1))),(o=gJ([])).leaf=!1,o.height=r;var s=Math.ceil(i/u),l=s*Math.ceil(Math.sqrt(u));_J(e,t,n,l,cJ);for(var c=t;c<=n;c+=l){var h=Math.min(c+l-1,n);_J(e,c,h,s,hJ);for(var f=c;f<=h;f+=s){var d=Math.min(f+s-1,h);o.children.push(CJ(e,f,d,r-1,a))}}return sJ(o),o}function _J(e,t,n,r,a){for(var o=[t,n];o.length;)if(!((n=o.pop())-(t=o.pop())<=r)){var i=t+Math.ceil((n-t)/r/2)*r;(0,on.Z)(e,i,t,n,a),o.push(t,i,i,n)}}function RJ(e){if(e.leaf)sJ(e);else{for(var t=0,n=e.children.length;t<n;t++)RJ(e.children[t]);sJ(e)}}var wJ=function(){function e(){(0,y.Z)(this,e),this.leftTop2Range=new Map,this.rightBottom2Range=new Map}return(0,C.Z)(e,[{key:"batchAdd",value:function(e){for(var t=0;t<e.length;t++)this.add(e[t]);return Array.from(this.leftTop2Range.values())}},{key:"add",value:function(e){kJ(e,this.leftTop2Range,this.rightBottom2Range,!1)}},{key:"has",value:function(e){return this.leftTop2Range.get(av(e.startRow,e.startCol))===e}},{key:"delete",value:function(e){TJ(e,this.leftTop2Range,this.rightBottom2Range)}},{key:"forEach",value:function(e){this.leftTop2Range.forEach(e)}}]),e}();function kJ(e,t,n){var r,a,o,i,u=!(arguments.length>3&&void 0!==arguments[3])||arguments[3],s=av(e.startRow,e.endCol),l=n.get(s);(null==l?void 0:l.startCol)===e.startCol&&(TJ(l,t,n),po(i=null!==(r=i)&&void 0!==r?r:e.clone(),l));var c=av(e.endRow,e.startCol),h=t.get(c);(null==h?void 0:h.endCol)===e.endCol&&(TJ(h,t,n),po(i=null!==(a=i)&&void 0!==a?a:e.clone(),h));var f=!i&&u;i=null!==(o=i)&&void 0!==o?o:e,f?EJ(i,t,n):SJ(i,t,n)}function SJ(e,t,n){var r,a,o,i,u=av(e.endRow,e.startCol),s=n.get(u);(null==s?void 0:s.startRow)===e.startRow&&(TJ(s,t,n),po(i=null!==(r=i)&&void 0!==r?r:e.clone(),s));var l=av(e.startRow,e.endCol),c=t.get(l);(null==c?void 0:c.endRow)===e.endRow&&(TJ(c,t,n),po(i=null!==(a=i)&&void 0!==a?a:e.clone(),c));var h=!i;i=null!==(o=i)&&void 0!==o?o:e,h?EJ(i,t,n):kJ(i,t,n)}function EJ(e,t,n){var r=av(e.startRow,e.startCol);t.set(r,e);var a=av(e.endRow,e.endCol);n.set(a,e)}function TJ(e,t,n){var r=av(e.startRow,e.startCol);t.delete(r);var a=av(e.endRow,e.endCol);n.delete(a)}function AJ(e){var t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"A1",r=wi(e);return r.toString({isShowSheetName:t,refStyle:n,ref:r})}function IJ(e,t,n){if(!ho(e,t)||!co(e,t))return!1;if(so(t,e))return!0;var r=qo(e,t);return r.forEach((function(e){n.add(new ui(e.startRow,e.endRow,e.startCol,e.endCol,e.hostId,e.hostName,e.status))})),0!==r.length}function bJ(e,t){return Array.from(e.entries()).map((function(e,n,r){return{start:e[0],end:n<r.length-1?r[n+1][0]:t,data:e[1]}}))}function FJ(e,t,n,r,a,o,i){for(var u=o.sheetId,s=o.isAddOp,l=o.isRowOp,c=o.offsetRatio,h=o.boundaryKeys,f=!a||l&&a.isCol()||!l&&a.isRow(),d=!n,v=!!n&&n.hostId!==u,g=h.startKey,m=h.endKey,p=[],y=null,C=null,_=t||[null],R=r||[null],w=new Map,k=0,S=_.length;k<S;k++){var E=_[k],T=E?E.data[0]:0,A=E?E.data[1]:0,I=void 0;if(!E||E.start===e[g]&&E.end===e[m]?I=e:((y=y||e.clone())[g]=E.start,y[m]=E.end,I=y),e.hostId===u&&!s&&A){if(A>=I[m]-I[g])continue;I===e&&(I=I.clone()),I[g]+=A}if(f||d)p.push({start:I[g]+T*c,end:I[m]+T*c,data:[a,{mountMove:T,depMove:0,resize:0,effectLine:0,invalidDep:!1}]});else if(v)MJ(w,I[g],I[m],{mountMove:T,depMove:0,resize:0,effectLine:0,invalidDep:!1});else{if(!n||!a)continue;for(var b=I===e?n:Po(I,a),F=0,M=0,V=R.length;M<V;M++){var N=R[M],O=N?N.data[0]:0,x=N?N.data[1]:0,Z=void 0;if(!N||N.start===n[g]&&N.end===n[m]?Z=n:((C=C||n.clone())[g]=N.start,C[m]=N.end,Z=C),b===Z||co(b,Z)){var D=b===Z?Z:fo(Z,b);if(0!==x){var P=Z[g],L=P+x;if(s?P>b[g]&&P<b[m]:L>b[g]){var B=io(n[g],s?P-1:P),U=uo(n[m],s?P+1:L),H=Z.clone();H[g]=B,H[m]=U;var W=s?zo(H,a,I,l):Ho(H,a,I);if(Zo(W,h)&&co(W,I)){var j=fo(W,I);if(s){var z=Po(j,a)[g]<P?F:O;MJ(w,j[g],j[m],{mountMove:T,depMove:z,resize:x,effectLine:P,invalidDep:!1})}else{for(var G=vo(j),J=Yo(a,l),q=j[g];q<j[m];q++){G[g]=q,G[m]=J?j[m]:q+1;var $=J?a:Po(G,a),Y=$[g]<P?F:O-x+$[g]-P,K=Math.abs(uo($[m],L)-io($[g],P));if(MJ(w,G[g],G[m],{mountMove:T,depMove:Y,resize:K,effectLine:P,invalidDep:$[g]>=P&&$[m]<=L}),J)break}D===Z&&(D=Z.clone()),D[g]=io(L,D[g])}}}}var X=D===Z?I:fo(I,Wo(D,a,e,l));if(X[g]>=X[m])F=O;else{if(MJ(w,X[g],X[m],{mountMove:T,depMove:O,resize:0,effectLine:Z[g],invalidDep:!1}),X[g]===I[g]&&X[m]===I[m])break;F=O}}}}}return a&&!f&&w.forEach((function(e){var t,n=e.start,r=e.end,o=e.data,u=o.mountMove,s=o.depMove,h=o.resize,d=o.effectLine,v=o.invalidDep,y=u-s,C=0===y&&0===h&&(!function(e,t){var n=Fo(e.status),r=t?ko:So;return $o(n,r[0])||$o(n,r[1])}(a,l)||0===s);if(f||C)t=a;else{var _=function(e,t,n,r,a){var o=Fo(e.status),i=t?ko:So,u=t?To:Ao,s=e[u.startKey],l=e[u.endKey];return $o(o,i[1])?e[u.startKey]>=n&&(s+=a):s+=r,$o(o,i[0])?e[u.endKey]>=n&&(l+=a):l+=r,[s,l]}(a,l,d,-y*c,s*c),R=_[0],w=_[1];0!==h&&(function(e,t,n,r){var a=jo(e,r),o=a.startKey,i=a.endKey,u=a.startLock,s=a.endLock;return u&&!s&&n+e[i]<=e[o]||s&&!u&&t+e[o]>=e[i]?o:i}(a,n,n+1,l)===g?R+=h*c:w+=h*c),v&&(w=R);var k=mo(l?R:a.startRow,l?w:a.endRow,l?a.startCol:R,l?a.endCol:w,a.hostId,a.hostName,a.status,a.getHostIdentifier());(t=i[k])||((t=a.clone())[g]=R,t[m]=w,t.key=k)}p.push({start:n+u*c,end:r+u*c,data:[t,o]})})),p}function MJ(e,t,n,r){var a=iv(t,n),o=e.get(a);o?o.data.resize+=r.resize:e.set(a,{start:t,end:n,data:r})}var VJ,NJ,OJ,xJ,ZJ,DJ,PJ=function(){function e(t,n){(0,y.Z)(this,e),this.ref=t,this.data=n,this.relations=[]}return(0,C.Z)(e,[{key:"getRelation",value:function(e){return this.relations[e]||null}},{key:"addRelation",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]&&arguments[2];this.relations.push({node:e,rules:t}),e&&n&&e.addRelation(this,t)}},{key:"removeRelation",value:function(e){for(var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1],n=this.relations.length-1;n>=0;n--){var r=this.relations[n];if(r.node===e)return r.node=null,t&&e.removeRelation(this),!0}return!1}},{key:"removeRelationByIdx",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];if(e<0||e>=this.relations.length)return!1;var n=this.relations[e];return!!n.node&&(t&&n.node.removeRelation(this),n.node=null,!0)}},{key:"clearRelations",value:function(){var e=arguments.length>0&&void 0!==arguments[0]&&arguments[0],t=arguments.length>1?arguments[1]:void 0;if(e){for(var n=0;n<this.relations.length;n++){var r=this.relations[n];r.node&&(r.node.removeRelation(this),t&&r.node.hasNoConnectRelations()&&t(r.node))}this.relations=[]}else this.relations=[]}},{key:"iterRelations",value:function(e){if(this.relations.length)for(var t=0;t<this.relations.length;t++){var n=this.relations[t];e(n.node,n.rules,t)}}},{key:"mapRelationNodes",value:function(e,t){for(var n=[],r=0;r<this.relations.length;r++){var a=this.relations[r];a.node?n.push(e(a.node,a.rules,r)):t||n.push(e(a.node,a.rules,r))}return n}},{key:"isEmptyRelations",value:function(){return 0===this.relations.length}},{key:"hasNoConnectRelations",value:function(){return 0===this.relations.length||this.relations.every((function(e){return!e.node}))}}]),e}(),LJ=function(){function e(t){(0,y.Z)(this,e),this.loggerService=t,this.refTree=new Map,this.invalidSheetIdDepMap=new Map,this.invalidSheetNameDepMap=new Map,this.invalidMountNodesMap=new Map,this.resetGraphEffect(),this.resetTreeEffect(),this.resetInvalidEffect()}return(0,C.Z)(e,[{key:"getGraphSegmentGridRange",value:function(e,t,n){if(!e&&!t.hostId)return this.printLog("getDepRefsByMountRef sheetId and hostId is empty"),[];var r=this.searchRefNodesInTree(e,t,n);if(!r||!r.length)return[];var a=0===n;return r.map((function(e){var n=[],r=e.mapRelationNodes((function(r,o){var i=o[0].ref;return n.push(i),a?function(e,t){return ui.fromGridRange(Po(e,t))}(fo(t,e.ref),i):function(e,t,n){return ui.fromGridRange(Ho(e,t,n))}(fo(t,e.ref),i,r.ref)}),!0);return{node:e,refs:r,relatives:n}}))}},{key:"resetGraphEffect",value:function(){this.graphEffect={}}},{key:"resetTreeEffect",value:function(){this.treeEffect={}}},{key:"resetInvalidEffect",value:function(){this.invalidEffect?this.invalidEffect.clear():this.invalidEffect=new Map}},{key:"flushInvalidEffect",value:function(){var e=this;this.invalidEffect.forEach((function(t,n){var r=t.add,a=t.del,o=e.getInvalidMountNodeSet(n);r.forEach((function(e){o.add(e)})),a.forEach((function(e){o.delete(e)}))})),this.resetInvalidEffect()}},{key:"relationDisconnect",value:function(e,t,n,r){var a=this,o=e.all();if(o.length)for(var i=function(e,t){var i=o[e];i.iterRelations((function(e,t){if(e){var o=e.ref.hostId;o&&(null!=r&&r(i,e,t,n),i.removeRelation(e,!0),e.hasNoConnectRelations()&&1===n&&a.getTreeEffectBySheetId(o).dep.del.add(e))}}))},u=0,s=o.length;u<s;u++)i(u)}},{key:"flushTreeEffect",value:function(){var e=this,t=Object.keys(this.treeEffect);if(t.length){for(var n=0,r=t.length;n<r;n++){var a=t[n];this.treeEffect[a].mount.del.forEach((function(t){t.clearRelations(!0,(function(t){e.getTreeEffectBySheetId(t.ref.hostId).dep.del.add(t)}))}))}for(var o=function(n,r){var a=t[n],o=e.treeEffect[a],i=e.createRefTree(a);o.mount.del.forEach((function(e){i.mount.remove(e)})),o.dep.del.forEach((function(e){i.dep.remove(e)})),i.mount.insertItems(Array.from(o.mount.add)),i.dep.insertItems(Array.from(o.dep.add))},i=0,u=(t=Object.keys(this.treeEffect)).length;i<u;i++)o(i);this.resetTreeEffect()}}},{key:"handleUpdateEffect",value:function(e,t,n){if(0!==e.update){var r=2|e.update,a=1|e.update;r&&t.mount.update(),a&&t.dep.update()}}},{key:"handleMergeEffect",value:function(e,t,n){var r=this;e.merge.size&&!t.mount.isEmpty()&&e.merge.forEach((function(n){var a=e.add.get(n.data)||[],o=a.length;r.searchNodeSibling(n.ref,n.data,t.mount,e.del,(function(t){e.del.add(t),a.push(t.ref)})),a.length>o&&(e.del.add(n),e.add.set(n.data,a))}))}},{key:"searchNodeSibling",value:function(e,t,n,r,a){var o=n.search(function(e){return new ui(io(0,e.startRow-1),e.endRow+1,io(0,e.startCol-1),e.endCol+1,e.hostId,e.hostName,e.status)}(e));if(o.length)for(var i=0,u=o.length;i<u;i++){var s=o[i];r.has(s)||lo(s.ref,e)&&this.checkRefNodeLikely(s.data,t)&&a(s)}}},{key:"handleDeleteEffect",value:function(e,t,n){var r=this;if(e.del.size){var a=this.getInvalidMountNodeSet(n);e.del.forEach((function(e){var o=e.ref.hostId;(o===n?t:r.getTreeEffectBySheetId(o)).mount.del.add(e),(o===n?a:r.getInvalidMountNodeSet(o)).size&&r.getInvalidEffectBySheetId(o).del.add(e)}))}}},{key:"handleSplitEffect",value:function(e,t,n){var r=this,a=e.add,o=e.split,i=e.del;o.size&&o.forEach((function(e,n){if(!i.has(n)){var o,u=n.ref,s=new Set([u]),l=_n(e);try{var c=function(){var e=o.value;if(so(e,u))return s.clear(),"break";Array.from(s).forEach((function(t){IJ(t,e,s)&&s.delete(t)}))};for(l.s();!(o=l.n()).done;){if("break"===c())break}}catch(e){l.e(e)}finally{l.f()}if(1!==s.size||!s.has(u)){if(s.size>0){var h=a.get(n.data)||[];a.set(n.data,h.concat(Array.from(s)))}t.mount.del.add(n),r.getInvalidEffectBySheetId(n.ref.hostId).del.add(n)}}}))}},{key:"handleAddEffect",value:function(e,t,n){var r=this;if(e.add.size){var a=this.getTreeBySheetIdAndType(n,0);if(!a)throw new Error("add node but no mount tree ".concat(n));e.add.forEach((function(e,n){var o=[],i=new wJ,u=i.batchAdd(e);if(!a.isEmpty())for(var s=0;s<u.length;s++){var l=u[s];r.searchNodeSibling(l,n,a,t.mount.del,(function(e){o.push(e),i.add(e.ref)}));for(var c=0;c<o.length;c++){var h=o[c];i.has(h.ref)?i.delete(h.ref):(t.mount.del.add(h),t.mount.add.delete(h),r.getInvalidEffectBySheetId(h.ref.hostId).del.add(h))}o.length=0}i.forEach((function(e){var a=r.createRefNode(e,n);t.mount.add.add(a)}))}))}}},{key:"removeRefTree",value:function(e){this.refTree.delete(e)}},{key:"calcSplitAndMoveRefNode",value:function(e,t,n){var r=n.boundaryKeys,a=n.moveResizeCache,o=e.ref,i=o[r.startKey],u=o[r.endKey],s=iv(i,u),l=a.get(s);l||(l=function(e,t,n){var r=n.isAddOp,a=n.opIntervalList,o=n.maxOpIntervalStart,i=n.maxOpIntervalEnd,u=n.maxOpMoveResizePair,s=e,l=t,c=r&&o<s||!r&&i<=s,h=c?u:[0,0],f=new Map([[s,h]]);if(c)return f;var d=s<a[0].target?0:Di(a,s,Bi,!0),v=l>=i?a.length-1:Di(a,l,Bi,!0),g=io(0,d),m=uo(v,a.length-1),p=a[g],y=p.target<=s?p.total:p.total-p.count;y>0&&(h[0]=y);for(var C=h,_=g;_<=m;_++){var R=a[_],w=R.target,k=R.target+R.count;if(R.target>=l)break;if(w>s&&w<=l-1){var S=w,E=[R.total,R.count];if(f.set(S,E),!r&&k>l)break;s=S,C=E}else!r&&w<=s&&k>s&&(C[1]=uo(k,l)-s)}return f}(i,u,n),a.set(s,l)),t.set(e,l)}},{key:"getConnectedNodeAry",value:function(e){var t=this,n=[];return null!=e&&e.forEach((function(e){t.getInvalidMountNodeSet(e).forEach((function(e){n.push(e)}))})),n}},{key:"getInvalidNodesBySheetInfo",value:function(e,t){var n=this.getInvalidNodesBySheetId(e),r=this.getInvalidNodesBySheetName(t),a=n.length?n:r;if(0!==a.length)return new Set(a)}},{key:"getInvalidNodesBySheetName",value:function(e){var t=this.getInvalidSheetDepByName(e);return this.getConnectedNodeAry(t)}},{key:"getInvalidNodesBySheetId",value:function(e){var t=this.getInvalidSheetDepById(e);return this.getConnectedNodeAry(t)}},{key:"graphEffectAddNewItem",value:function(e,t,n){var r=e.add.get(t)||[];r.length||e.add.set(t,[n]),r.push(n)}},{key:"getInvalidSheetDepById",value:function(e){return this.invalidSheetIdDepMap.get(e)}},{key:"createInvalidSheetDepById",value:function(e){var t=new Set;return this.invalidSheetIdDepMap.set(e,t),t}},{key:"getInvalidSheetDepByName",value:function(e){return this.invalidSheetNameDepMap.get(e)}},{key:"createInvalidSheetDepByName",value:function(e){var t=new Set;return this.invalidSheetNameDepMap.set(e,t),t}},{key:"dropInvalidSheetDepIdMap",value:function(e,t){this.invalidSheetIdDepMap.delete(e),this.invalidSheetNameDepMap.delete(t)}},{key:"getInvalidMountNodeSet",value:function(e){var t=this.invalidMountNodesMap.get(e);if(!t){var n=new Set;return this.invalidMountNodesMap.set(e,n),n}return t}},{key:"createRefTree",value:function(e){var t=this.refTree.get(e);return t||(t={mount:new uJ,dep:new uJ},this.refTree.set(e,t),t)}},{key:"buildRefNodeRelations",value:function(e,t){var n=e.ref,r=this.getDepRangeAndReference(n,t);if(r.length)for(var a=0;a<r.length;a++){var o=r[a],i=o.depRange,u=o.references,s=null!=i&&i.hostId?new PJ(i,t):null;if(e.addRelation(s,u,!0),this.onRelationCreated(e,s),!s){var l=null==i?void 0:i.hostName,c=null==n?void 0:n.hostId;if(!l||!c)continue;(this.getInvalidSheetDepByName(l)||this.createInvalidSheetDepByName(l)).add(c)}}else this.onRelationCreated(e,null)}},{key:"updateMountRefNode",value:function(e,t,n,r){var a=this,o=r.boundaryKeys,i=o.startKey,u=o.endKey,s=r.offsetRatio;e.iterRelations((function(r,o,l){if(r&&r.ref.hostId&&0!==o.length){for(var c=o[0].idx,h=t[c],f=n[c],d=f.depMove,v=f.resize,g=f.invalidDep,m=0;m<o.length;m++)o[m].ref=h;if(g)return e.removeRelationByIdx(l,!0),void a.getTreeEffectBySheetId(r.ref.hostId).dep.del.add(r);0===d&&0===v||(r.ref[i]+=d*s,r.ref[u]+=d*s,r.ref[u]+=v*s,a.getGraphEffectBySheetId(r.ref.hostId).update|=1)}}))}},{key:"createRefNode",value:function(e,t){var n=new PJ(e,t);return this.buildRefNodeRelations(n,t),n}},{key:"onRelationCreated",value:function(e,t){if(e.ref.hostId){var n=e.ref.hostId,r=null==t?void 0:t.ref.hostId;r?(r&&!this.refTree.get(r)&&this.createRefTree(r),this.getTreeEffectBySheetId(r).dep.add.add(t)):n&&this.getInvalidEffectBySheetId(n).add.add(e)}}},{key:"getTreeBySheetIdAndType",value:function(e,t){var n=this.refTree.get(e);return n?n[0===t?"mount":"dep"]:null}},{key:"searchRefNodesInTree",value:function(e,t,n){var r=this.getTreeBySheetIdAndType(e,n);return r?r.search(t):null}},{key:"getDepRefsByMountRef",value:function(e){return this.getGraphSegmentGridRange(e.hostId,e,0)}},{key:"getMountRefsByDepRef",value:function(e){return this.getGraphSegmentGridRange(e.hostId,e,1)}},{key:"onRangeValueChanged",value:function(e,t,n){var r=this;if(!this.isEmptyGraphTree(e,0)||n&&0!==n.size){var a;if(t)for(var o=0;o<t.length;o++){var i=t[o],u=this.searchRefNodesInTree(e,i,0);if(u&&u.length){a||(a=this.getGraphEffectBySheetId(e));for(var s=function(e,t){var n,o=u[e];if(a.del.has(o))return"continue";if(so(i,o.ref))return a.del.add(o),r.invalidMountNodesMap.forEach((function(e){null==e||e.forEach((function(t){t===o&&e.delete(t)}))})),a.split.delete(o),"continue";var s=null!==(n=a.split.get(o))&&void 0!==n?n:new Set;a.split.set(o,s),s.add(i)},l=0,c=u.length;l<c;l++)s(l)}}n&&n.size>0&&(a||(a=this.getGraphEffectBySheetId(e)),n.forEach((function(t,n,o){r.graphEffectAddNewItem(a,t,new ui(n,n+1,o,o+1,e))}))),a&&this.flushGraphEffect()}}},{key:"isEmptyGraphTree",value:function(e,t){if(0===this.refTree.size)return!0;var n=this.refTree.get(e);return!n||(void 0===t?n.mount.isEmpty()&&n.dep.isEmpty():n[0===t?"mount":"dep"].isEmpty())}},{key:"onRowColAddOrDelete",value:function(e,t,n){var r=this,a=n||new Set;if(this.isEmptyGraphTree(e))return a;for(var o=new Map,i=new Map,u=t.effectedRef(),s=this.getRelativeCache(),l=t.ranges,c=t.isRowType(),h="add"===t.type(),f=c?To:Ao,d=f.startKey,v=f.endKey,g=l[l.length-1],m=g.target,y=g.target+g.count,C=[g.total,0],_=new Map,R=new Map,w={sheetId:e,isAddOp:h,isRowOp:c,offsetRatio:h?1:-1,boundaryKeys:f,opIntervalList:l,maxOpIntervalStart:m,maxOpIntervalEnd:y,maxOpIntervalTotal:g.total,maxOpMoveResizePair:C,moveResizeCache:_},k=0;k<u.length;k++){for(var S=u[k],E=this.searchRefNodesInTree(e,S,0)||[],T=0,A=E.length;T<A;T++){var I=E[T];this.calcSplitAndMoveRefNode(I,o,w)}for(var b=this.searchRefNodesInTree(e,S,1)||[],F=0,M=b.length;F<M;F++){var V=b[F],N=V.ref;c&&N.isCol()||!c&&N.isRow()?V.iterRelations((function(e){e&&a.add(e.ref)})):(this.calcSplitAndMoveRefNode(V,i,w),V.iterRelations((function(e){e&&(o.has(e)||o.set(e,null),a.add(e.ref))})))}}return o.forEach((function(e,t){var n=t.ref,o=[],u=r.getGraphEffectBySheetId(t.ref.hostId),l=null;if(e){var c=iv(n[d],n[v]),h=R.get(c);h?l=h:(l=bJ(e,n[v]),R.set(c,l))}t.isEmptyRelations()?o.push({channelId:"",channel:FJ(n,l,null,null,null,w,s)}):t.iterRelations((function(e,t){var r;if(e){var a=e.ref,u=i.get(e),c=null;if(u){var h=iv(a[d],a[v]),f=R.get(h);f?c=f:(c=bJ(u,a[v]),R.set(h,c))}r=FJ(n,l,a,c,t[0].ref,w,s)}else r=FJ(n,l,null,null,t[0].ref,w,s);r.length&&t.forEach((function(e){var t=e.idx;o.push({channelId:t,channel:r})}))}));var f=1!==o.length||o[0].channelId?function(e){if(1===e.length){var t=e[0],n=t.channel,r=t.channelId;return n.map((function(e){var t={};t[r]=e.data[0];var n={};return n[r]=e.data[1],{start:e.start,end:e.end,data:[t,n]}}))}for(var a=[],o=[],i=[],u=0,s=0,l=0;l<e.length;l++)0===l&&(u=e[l].channel[0].start,s=e[l].channel[e[l].channel.length-1].end),o[l]=0,i[l]=e[l].channel[0].end;for(var c=u,h=u+1;h<=s;){c=u,h=Math.min.apply(Math,i);for(var f={},d={},v=0;v<o.length;v++){var g=o[v],m=e[v],p=m.channelId,y=m.channel,C=y[g];f[p]=C.data[0],d[p]=C.data[1],C.end<=h&&g<y.length-1&&(o[v]++,i[v]=y[g+1].end),C.start>c&&(c=C.start)}if(a.push({start:io(c,u),end:h,data:[f,d]}),h===s)break;u=h-1}return a}(o):o[0].channel.map((function(e){return{start:e.start,end:e.end,data:[null,e.data[1]]}}));0===f.length&&u.del.add(t);for(var g=0;g<f.length;g++){var m=f[g],y=m.start,C=m.end,_=(0,p.Z)(m.data,2),k=_[0],S=_[1],E=k?r.getNewRelativeChangedNode(t.data,k):t.data;if(C-y==t.ref[v]-t.ref[d]&&1===f.length){t.ref[d]===y&&t.ref[v]===C||(t.ref[d]=y,t.ref[v]=C,u.update|=2,!w.isAddOp&&e&&e.has(t.ref[y])&&u.merge.add(t)),t.data=E,k&&r.updateMountRefNode(t,k,S,w),r.updateRefs(t,t.ref,E),a.add(t.ref);break}u.del.add(t);var T=u.add.get(E);T||(T=[],u.add.set(E,T));var A=t.ref.clone();A[d]=y,A[v]=C,T.push(A),a.add(A),r.updateRefs(t,A,E)}})),this.flushGraphEffect(),a}},{key:"toStringifyGraphSegment",value:function(e){var t=[];return this.refTree.forEach((function(n,r){e&&r!==e||n.mount.all().forEach((function(e){t.push("".concat(r,"!").concat(AJ(e.ref,!1)," -> ").concat(e.mapRelationNodes((function(t,n){if(t)return"".concat(t.ref.hostId,"!").concat(AJ(t.ref,!1));var r=n[0].ref;return"".concat(r.hostId||r.hostName,"!").concat(AJ(ui.fromGridRange(Po(e.ref,r)),!1))}),!1).join(",")))}))})),t.sort()}},{key:"destroy",value:function(){this.printLog("call destroy"),this.resetGraphEffect(),this.resetTreeEffect(),this.resetInvalidEffect(),this.invalidMountNodesMap.clear(),this.invalidSheetIdDepMap.clear(),this.invalidSheetNameDepMap.clear(),this.refTree.clear()}},{key:"getGraphEffectBySheetId",value:function(e){var t=this.graphEffect[e];return t||(t={add:new Map,del:new Set,split:new Map,merge:new Set,update:0},this.graphEffect[e]=t),t}},{key:"getTreeEffectBySheetId",value:function(e){var t=this.treeEffect[e];return t||(t={mount:{add:new Set,del:new Set},dep:{add:new Set,del:new Set}},this.treeEffect[e]=t),t}},{key:"getInvalidEffectBySheetId",value:function(e){var t=this.invalidEffect.get(e);return t||(t={add:new Set,del:new Set},this.invalidEffect.set(e,t)),t}},{key:"flushGraphEffect",value:function(){var e=Object.keys(this.graphEffect);if(e.length){for(var t=0;t<e.length;t++){var n=e[t],r=this.graphEffect[n];if(0!==r.add.size||0!==r.del.size||0!==r.split.size||0!==r.merge.size||0!==r.update){var a=this.getTreeEffectBySheetId(n),o=this.createRefTree(n);this.handleUpdateEffect(r,o,n),this.handleMergeEffect(r,o,n),this.handleDeleteEffect(r,a,n),this.handleSplitEffect(r,a,n),this.handleAddEffect(r,a,n)}}this.flushTreeEffect(),this.resetGraphEffect(),this.flushInvalidEffect()}}},{key:"printLog",value:function(e,t,n){var r;null===(r=this.loggerService)||void 0===r||r.info("[DependencyRefManager] ".concat(e),t,n)}}]),e}(),BJ=function(){function e(t,n){(0,y.Z)(this,e),this.formulaRefManager=t,this.formulaRefService=n}return(0,C.Z)(e,[{key:"moveRange",value:function(e){var t=this,n=e.srcRange(),r=e.targetRange(),a=n.sheet(),o=r.sheet();if(a&&o){var i=this.formulaRefManager.getGraphEffectBySheetId(o.id()),u=this.formulaRefManager.getGraphEffectBySheetId(a.id()),s=this.moveFormulaRange(e),l=(0,p.Z)(s,2),c=l[0],h=l[1],f=this.moveRefRange(e),d=this.formulaRefService.formulaRefPool,v={row:r.startRow-n.startRow,col:r.startCol-n.startCol};h.forEach((function(e,n){t.splitRefNode(i,n,e)})),c.forEach((function(n,r){t.splitRefNode(u,r,n),t.translateFormulaMountRef(o,n,e,v)})),c.forEach((function(e,n){var r=new Set([Ko(e,v.row,v.col,o.id(),o.name())]),u=f.get(n);u&&Array.from(u).forEach((function(s){var l=(0,p.Z)(s,2),c=l[0],h=l[1],f=ov(c),g=f.row,m=f.col,y=new ui(g,g+1,m,m+1,a.id(),a.name(),0);if(so(e,y)){var C=Ko(y,v.row,v.col,o.id(),o.name());t.addRefNode(o,i,d.add({formula:n.data.formula,refMap:t.translateRefs(n.data.refMap,h,v)}),C),u.delete(c),Array.from(r).forEach((function(e){IJ(e,C,r)&&r.delete(e)}))}})),r.forEach((function(e){t.addRefNode(o,i,d.add({formula:n.data.formula,refMap:t.translateRefs(n.data.refMap,void 0,v)}),e)}))})),f.forEach((function(e,n){var r=a.parent.getSheetFromId(n.ref.hostId),o=t.formulaRefManager.getGraphEffectBySheetId(n.ref.hostId),i=h.get(n);e.forEach((function(e,a){var u=ov(a),s=u.row,l=u.col,c=new ui(s,s+1,l,l+1,r.id(),r.name(),0);i&&so(i,c)||(t.addRefNode(r,o,d.add({formula:n.data.formula,refMap:t.translateRefs(n.data.refMap,e)}),c),t.splitRefNode(o,n,c))}))})),this.formulaRefManager.flushGraphEffect()}}},{key:"moveFormulaRange",value:function(e){var t=e.srcRange(),n=e.targetRange(),r=new Map,a=new Map,o=this.formulaRefManager.searchRefNodesInTree(t.sheet().id(),t,0),i=this.formulaRefManager.searchRefNodesInTree(n.sheet().id(),n,0);return null!=o&&o.forEach((function(e){co(e.ref,t)&&r.set(e,ui.fromGridRange(fo(e.ref,t)))})),null!=i&&i.forEach((function(e){co(e.ref,n)&&a.set(e,ui.fromGridRange(fo(e.ref,n)))})),[r,a]}},{key:"moveRefRange",value:function(e){var t,n,r=new Map,a=function(e,t,n,a,o){var i,u,s=av(e,t),l=null!==(i=r.get(n))&&void 0!==i?i:new Map;r.set(n,l);var c=null!==(u=l.get(s))&&void 0!==u?u:new Map;l.set(s,c),c.set(a,o)},o=e.srcRange(),i=e.targetRange(),u=e.toEdgeAdjust,s=null!==(t=this.formulaRefManager.searchRefNodesInTree(o.sheet().id(),o,1))&&void 0!==t?t:[],l=null!==(n=this.formulaRefManager.searchRefNodesInTree(i.sheet().id(),i,1))&&void 0!==n?n:[],c=new Set;return s.forEach((function(e){c.add(e)})),l.forEach((function(e){c.add(e)})),c.forEach((function(e){var t=co(e.ref,o)?fo(e.ref,o):co(e.ref,i)?fo(e.ref,i):null;t&&e.iterRelations((function(n,r,s){var l=e.getRelation(s);if(0!==r.length&&n&&l){var c=r[0].ref,h=c.clone(),f=Ho(t,c,n.ref,!0);if(Do(f))for(var d=new Oi(0,0,1,1,null),v=f.startRow;v<f.endRow;v++)for(var g=f.startCol;g<f.endCol;g++){d.setRowFrom(v),d.setColFrom(g),yo(h,Lo(d,c));var m=hi(h,o,i,u);if(m){var p=Si(m,d,Fo(c.status));a(v,g,n,l,p)}}}}))})),r}},{key:"translateRefs",value:function(e,t,n){if(!e)return null;var r=Object.assign({},e);return t&&t.forEach((function(e,t){return t.rules.forEach((function(t){var n=t.idx;return r[n]=e}))})),n&&Object.entries(r).forEach((function(e){var t=(0,p.Z)(e,2),a=t[0],o=t[1];r[a]=Xo(o,-n.row,-n.col)})),r}},{key:"splitRefNode",value:function(e,t,n){var r,a=null!==(r=e.split.get(t))&&void 0!==r?r:new Set;a.add(n),e.split.set(t,a)}},{key:"addRefNode",value:function(e,t,n,r){var a,o=null!==(a=t.add.get(n))&&void 0!==a?a:[];t.add.set(n,o),o.push(r),this.updateFormulaRefs(e,r,n.refMap)}},{key:"updateFormulaRefs",value:function(e,t,n){var r=this;n&&IM(e,t,(function(e,t,a){r.formulaRefManager.updateFormulaRefMap(a,n)}))}},{key:"translateFormulaMountRef",value:function(e,t,n,r){var a=this;t=Ko(t,r.row,r.col),IM(e,t,(function(t,r,o){a.formulaRefManager.moveFormulaLocation(e,o,n)}))}}]),e}();!function(e){e.FormulaRefChanged="FormulaRefChanged"}(VJ||(VJ={}));var UJ=function(e){function t(e){var n;return(0,y.Z)(this,t),(n=(0,d.Z)(this,(0,v.Z)(t).call(this))).formulaRefService=e,n.eventWatcher=new we.CPL,n.depRefChangeFormulas=new Set,n.moveRangeService=new BJ((0,c.Z)(n),e),n}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"setSpread",value:function(e){this.spread=e}},{key:"updateFormulaRefMap",value:function(e,t){this.onDepRefChanged(e,t),this.depRefChangeFormulas.add(e)}},{key:"moveFormulaLocation",value:function(e,t,n){var r,a=t.getRef(),o=a.hostId;a.onOp(n);var i=a.hostId;null===(r=a.sheet())||void 0===r||r.getCalcEngine().moveFormulaCrossSheet(t,o,i)}},{key:"flushGraphEffect",value:function(){(0,f.Z)((0,v.Z)(t.prototype),"flushGraphEffect",this).call(this),this.tigerFormulaRefChanged()}},{key:"collectRecoverFmlAndRef",value:function(e,t){var n=this,r=e.id(),a=e.name(),o=this.getInvalidNodesBySheetInfo(r,a);o&&(o.forEach((function(o){var i=!1,u=o.data.refMap,s=o.ref;if(n.formulaRefService.formulaRefPool.updateRefMap(o.data,(function(t){return t&&Object.values(t).forEach((function(t){t.hostName!==a&&t.hostId!==r||(i=!0,t.setSheet(e),t.hostId=r,t.hostName=void 0,n.formulaRefService.refMapMgr.onRangeChange(t),t.onDataChanged(),n.dropInvalidSheetDepIdMap(r,a))})),t})),s.hostId&&s.hostId!==r){var l=n.spread.getSheetFromId(s.hostId);if(i&&l){var c=s.hostId;if(c){var h=n.getGraphEffectBySheetId(c);h.del.add(o),n.graphEffectAddNewItem(h,o.data,s)}IM(l,s,(function(e,r,a){t.add(a),n.onDepHostChanged(l.id(),s,a,u),n.depRefChangeFormulas.add(a)}))}}})),this.flushGraphEffect())}},{key:"subscribeEvents",value:function(e,t){return this.eventWatcher.subscribe(e,t)}},{key:"tigerFormulaRefChanged",value:function(){this.depRefChangeFormulas.size&&(this.eventWatcher.dispatch(VJ.FormulaRefChanged,this.depRefChangeFormulas),this.depRefChangeFormulas.clear())}},{key:"getDepRangeAndReference",value:function(e,t){var n=t.refMap,r=[];if(!n)return r;var a=new Map;for(var o in n){var i=n[o],u=Jo(i)?ui.fromGridRange(Po(e,i)):null;u&&!Do(u)&&(u=null);var s=i.hash(),l={idx:o,ref:i},c=a.get(s);if(c)c.references.push(l);else{var h={depRange:u,references:[l]};r.push(h),a.set(s,h)}}return r}},{key:"checkRefNodeLikely",value:function(e,t){return this.formulaRefService.formulaRefPool.equals(e,t)}},{key:"getNewRelativeChangedNode",value:function(e,t){return this.formulaRefService.formulaRefPool.add({formula:e.formula,refMap:t})}},{key:"updateRefs",value:function(e,t,n){var r=this,a=e.ref.hostId,o=this.spread.getSheetFromId(a);if(!o)throw new Error("formula ref manager: updateRefs failed, no sheet ".concat(a," found"));IM(o,t,(function(e,t,a){r.updateFormulaRefMap(a,n.refMap);var o=a.getRef();o.startRow!==e&&o.setRowFrom(e),o.startCol!==t&&o.setColFrom(t)}))}},{key:"getRelativeCache",value:function(){return this.formulaRefService.refMapMgr.relativeCache}},{key:"disconnectRefNodeHostInfo",value:function(e,t,n,r){var a=this;this.formulaRefService.formulaRefPool.updateRefMap(t.data,(function(e){return e&&Object.values(e).forEach((function(e){var t;e.hostId===r&&(e.hostName=null==e||null===(t=e.sheet())||void 0===t?void 0:t.name(),e.hostId=void 0,a.formulaRefService.refMapMgr.onRangeChange(e),e.setSheet(null),e.onDataChanged())})),e})),n.add(t)}},{key:"handleSheetRename",value:function(e,t){this.getInvalidNodesBySheetName(e).forEach((function(e){t.push(e.ref)}))}},{key:"handleSheetRemovedRef",value:function(e,t,n){var r=this,a=this.getInvalidSheetDepByName(t),o=this.getTreeBySheetIdAndType(e,0),i=this.getTreeBySheetIdAndType(e,1);i&&this.relationDisconnect(i,e,0,(function(e,t,n){var a=e.ref.hostId,o=t.ref.hostId,i=r.getInvalidSheetDepById(a)||r.createInvalidSheetDepById(a),u=r.getInvalidMountNodeSet(o);i.add(o),r.disconnectRefNodeHostInfo(n,t,u,a);var s=r.spread.getSheetFromId(o);s&&IM(s,t.ref,(function(e,n,a){r.onDepHostChanged(o,t.ref,a,t.data.refMap),r.depRefChangeFormulas.add(a)}))})),o&&this.relationDisconnect(o,e,1),this.flushTreeEffect(),this.removeRefTree(e),this.getInvalidNodesBySheetId(e).forEach((function(e){n.push(e.ref);var o=e.ref.hostId;o&&(a||(a=r.createInvalidSheetDepByName(t)),a.add(o))})),this.tigerFormulaRefChanged()}},{key:"onDepHostChanged",value:function(e,t,n,r){n.setRefMap(r)}},{key:"onDepRefChanged",value:function(e,t){e.setRefMap(t)}},{key:"handleCoverSnapshot",value:function(){this.refTree.clear(),this.resetGraphEffect(),this.resetTreeEffect(),this.resetInvalidEffect()}},{key:"handleCoverSheet",value:function(e,t){var n=this.getTreeBySheetIdAndType(e,0),r=this.getTreeBySheetIdAndType(e,1);n&&this.relationDisconnect(n,e,1),r&&this.relationDisconnect(r,e,0,(function(e,n,r){t.push(n.ref)})),this.flushTreeEffect()}},{key:"handleLoadSheet",value:function(e,t){var n=this,r=this.getGraphEffectBySheetId(e);t.length&&(t.forEach((function(e){var t=(0,p.Z)(e,3),a=t[0],o=t[1],i=t[2],u=n.formulaRefService.formulaRefPool.add({formula:a,refMap:o});r.add.set(u,i)})),this.createRefTree(e),this.flushGraphEffect())}},{key:"getNodeCount",value:function(e,t){var n=0;if(void 0===t&&(t=0),void 0===e)this.refTree.forEach((function(e){n+=e[0===t?"mount":"dep"].getSize()}));else{var r=this.getTreeBySheetIdAndType(e,t);r&&(n=r.getSize())}return n}},{key:"checkRefNodePosition",value:function(){var e=this,t=[];return this.refTree.forEach((function(n,r){n.mount.all().forEach((function(n){var a=n.ref,o=e.spread.getSheetFromId(a.hostId||"");if(a.hostId&&o){var i={errorType:"position",sheetId:r,nodeRef:a.toGridRange(),errorFormula:[]};IM(o,a,(function(e,t,n){var r=n.getRef();r.startRow===e&&r.startCol===t||i.errorFormula.push({expected:{row:e,col:t},current:{row:r.startRow,col:r.startCol},id:n.getId(),hasRefMap:Boolean(n.getRefMap())})})),i.errorFormula.length&&t.push(i)}else t.push({errorType:"sheetId",sheetId:r,nodeRef:a.toGridRange(),errorFormula:[]})}))})),t}},{key:"excludeFormulaInTree",value:function(e,t,n){var r=this.getTreeBySheetIdAndType(e,0);if(r){var a=this.spread.getSheetFromId(e);a&&r.all().forEach((function(e){var r=e.ref;IM(a,r,(function(e,n,r){var a=r.getRef();a.startRow===e&&a.startCol===n&&t.delete(r)}),(function(e,t,r){n.push({row:e,col:t,type:r.type})}))}))}}},{key:"destroy",value:function(){this.depRefChangeFormulas.clear(),(0,f.Z)((0,v.Z)(t.prototype),"destroy",this).call(this),this.eventWatcher.destroy()}}]),t}(LJ),HJ=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"getDepends",value:function(e){for(var t=[],n=this.getDepRefsByMountRef(e),r=0;r<n.length;++r)t.push.apply(t,n[r].refs);return t}},{key:"updateDynamicRefs",value:function(e,t,n){var r=t.sheet();if(r){var a=new Set,o={},i=0;if(n){i=n.length;for(var u=0,s=0;u<i;++u){var l=Si(n[u],t),c=l.hash(!1,!0);a.has(c)||(o["R"+ ++s]=l,a.add(c))}}var h,f=r.id(),d=this.searchRefNodesInTree(f,t,0)||[];if(i||d.length)if(i>0&&(o=this.formulaRefService.refMapMgr.add(o)),!(d.length>0&&o===d[0].data.refMap))i>0&&(h=new lv).set(t.startRow,t.startCol,this.formulaRefService.formulaRefPool.add({formula:e.formula,refMap:o})),this.onRangeValueChanged(f,[t],h)}}},{key:"onDepHostChanged",value:function(e,t,n,r){this.updateCustomDeps(n,r)}},{key:"onDepRefChanged",value:function(e,t){this.updateCustomDeps(e,t)}},{key:"updateCustomDeps",value:function(e,t){e.registerCustomDepends(t?Object.keys(t).sort().map((function(n){return ki(t[n],e.getRef())})):null)}},{key:"moveFormulaLocation",value:function(e,t,n){}}]),t}(UJ);function WJ(e,t){Ei.prototype.onOp.call(e,t)}!function(e){e[e.Mount=0]="Mount",e[e.Dep=1]="Dep"}(NJ||(NJ={})),function(e){e.Mount="mount",e.Dep="dep"}(OJ||(OJ={})),function(e){e[e.Edit=0]="Edit",e[e.VisibleChanged=1]="VisibleChanged",e[e.Load=2]="Load",e[e.Recover=3]="Recover"}(xJ||(xJ={})),function(e){e[e.None=0]="None",e[e.Dep=1]="Dep",e[e.Mount=2]="Mount",e[e.ALL=3]="ALL"}(ZJ||(ZJ={}));var jJ=function(){function e(){(0,y.Z)(this,e),this.uuid=0,this.refTree=new Map,this.callbackMap=new Map,this.recoverMap=new Map}return(0,C.Z)(e,[{key:"watchRef",value:function(e,t,n,r,a){var o=this,i=this.getRTree(e),u={dirtyCallback:t,validateOp:n,afterRefOp:r,recoverSheet:a};this.callbackMap.set(this.uuid,u);var s={ref:e,id:this.uuid++};return i.insert(s),function(){o.callbackMap.delete(s.id),i.remove(s)}}},{key:"watchRefs",value:function(e,t,n,r){var a=this,o={dirtyCallback:t,validateOp:n,afterRefOp:r},i=this.uuid++;this.callbackMap.set(i,o);var u=e.map((function(e){var t=a.getRTree(e),n={ref:e,id:i};return t.insert(n),n}));return function(){a.callbackMap.delete(i),u.forEach((function(e){var t=a.refTree.get(e.ref.hostId);t&&t.remove(e)}))}}},{key:"getRTree",value:function(e){var t=this.refTree,n=e.hostId;void 0===n&&(t=this.recoverMap,n=e.hostName);var r=t.get(n);return r||(r=new uJ,t.set(n,r)),r}},{key:"search",value:function(e){var t=this.refTree.get(e.hostId);return t?t.search(e):[]}},{key:"onRefOp",value:function(e){var t=this;if("DelSheetOp"!==e.type()){var n=e.effectedRef();if("MoveRangeOp"===e.type()||n.length>1)this.moveRange(e,n);else{var r=[],a=new Set,o=n[0],i=this.refTree.get(o.hostId);if(i){i.search(o,r);for(var u=0;u<r.length;u++){var s,l,c=r[u],h=this.callbackMap.get(c.id);!1!==(null==h||null===(s=h.validateOp)||void 0===s?void 0:s.call(h,c.ref,e))?(i.remove(c),WJ(c.ref,e),null!=h&&null!==(l=h.afterRefOp)&&void 0!==l&&l.call(h,c.ref,e),(null==h?void 0:h.dirtyCallback)&&a.add(c.id)):r.splice(u--,1)}i.insertItems(r),a.forEach((function(n){var r,a;null===(r=t.callbackMap.get(n))||void 0===r||null===(a=r.dirtyCallback)||void 0===a||a.call(r,e)}))}}}else this.delSheet(e)}},{key:"moveRange",value:function(e,t){var n=this,r=new Map,a=new Set;t.forEach((function(e){n.search(e).forEach((function(e){if(e.ref.hostId){var t=r.get(e.ref.hostId);t||(t=new Set,r.set(e.ref.hostId,t)),t.add(e)}}))})),r.forEach((function(t,r){var o=n.refTree.get(r);o&&t.forEach((function(t){var r,i,u=n.callbackMap.get(t.id);if(!1!==(null==u||null===(r=u.validateOp)||void 0===r?void 0:r.call(u,t.ref,e))){o.remove(t);var s=t.ref.hostId;WJ(t.ref,e),null!=u&&null!==(i=u.afterRefOp)&&void 0!==i&&i.call(u,t.ref,e),null!=u&&u.dirtyCallback&&a.add(t.id),t.ref.hostId===s?o.insert(t):n.getRTree(t.ref).insert(t)}}))})),a.forEach((function(r){var a,o;null===(a=n.callbackMap.get(r))||void 0===a||null===(o=a.dirtyCallback)||void 0===o||o.call(a,e,void 0,t)}))}},{key:"delSheet",value:function(e){var t=this,n=e.getSheet().id(),r=this.refTree.get(n);if(r){var a=new Set,o=r.all();this.recoverMap.set(e.getSheet().name(),r),o.forEach((function(n){var o,i,u=t.callbackMap.get(n.id);!1!==(null==u||null===(o=u.validateOp)||void 0===o?void 0:o.call(u,n.ref,e))?(WJ(n.ref,e),null!=u&&null!==(i=u.afterRefOp)&&void 0!==i&&i.call(u,n.ref,e),(null==u?void 0:u.dirtyCallback)&&a.add(n.id)):r.remove(n)})),a.forEach((function(n){var r,a;null===(r=t.callbackMap.get(n))||void 0===r||null===(a=r.dirtyCallback)||void 0===a||a.call(r,e)})),this.refTree.delete(n)}}},{key:"recoverRef",value:function(e){var t=this,n=e.name(),r=this.recoverMap.get(n);if(r){var a=new Set,o=new Map;this.recoverMap.delete(n),this.refTree.set(e.id(),r),r.all().forEach((function(n){var r;n.ref instanceof Ei&&n.ref.setSheet(e),o.set(n.id,n.ref),(null===(r=t.callbackMap.get(n.id))||void 0===r?void 0:r.dirtyCallback)&&a.add(n.id)})),a.forEach((function(n){var r,a,i=t.callbackMap.get(n);null==i||null===(r=i.dirtyCallback)||void 0===r||r.call(i,void 0,{dirtySource:xJ.Recover});var u=o.get(n);u&&(null==i||null===(a=i.recoverSheet)||void 0===a||a.call(i,u,e))}))}}},{key:"markDirtyCompleted",value:function(e,t,n){var r=this,a=new Set;e.forEach((function(e){a.add(e.id)})),a.forEach((function(e){var a,o;null===(a=r.callbackMap.get(e))||void 0===a||null===(o=a.dirtyCallback)||void 0===o||o.call(a,void 0,n,t)}))}},{key:"destroy",value:function(){this.refTree.clear(),this.callbackMap.clear()}}]),e}();function zJ(e,t){return e-t}function GJ(e,t,n,r,a,o){var i=e.length-1;i>=0&&e[i].startRow===t&&e[i].endRow===n&&e[i].endCol===r?e[i].endCol=a:e.push(new ui(t,n,r,a,o))}var JJ=function(){function e(){(0,y.Z)(this,e),this.map=new Map}return(0,C.Z)(e,[{key:"splitAndAdd",value:function(e){var t=this.map.get(e.hostId);t||(t=[],this.map.set(e.hostId,t));for(var n=[],r=e.startRow,a=e.endRow,o=e.startCol;o<e.endCol;o++)if(t[o]){var i=t[o],u=Di(i,r,zJ,!0);u%2!=0&&u++;var s=Di(i,a,zJ,!0);s%2==0&&s++;for(var l=r,c=u;c<s;c+=2)i[c]>l&&GJ(n,l,i[c],o,o+1,e.hostId),l=io(l,i[c+1]);l<a&&GJ(n,l,a,o,o+1,e.hostId),-1===s||r>i[s]?i.splice(s+1,0,r,a):(u>s&&u>=2&&(u-=2),i[u]=uo(i[u],r),i[s]=io(i[s],a),s-u>1&&i.splice(u+1,s-u-1))}else t[o]=[r,a],GJ(n,r,a,o,o+1,e.hostId);return n}}]),e}();!function(e){e.RangeMarkDirtyFinish="RangeMarkDirtyFinish"}(DJ||(DJ={}));var qJ=Qc(Kc),$J=Qc(Bf),YJ=function(){function e(t,n){var r=this;(0,y.Z)(this,e),this.workbook=t,this.formulaRefService=new iJ(this),this.precisionOps={Add:null,Sub:null},this.parenOperator=null,this.InvokeFunctionOperator=null,this.statistics=new Yb,this.cfmStatistics=new Kb,this.pivotStatistics=new Xb,this.prefixes=null,this.subscriber=null,this.formulaIdCounter=new Map,this.formulaIdMap=new Map,this.formulaRefManager=new UJ(this.formulaRefService),this.dynamicRefManager=new HJ(this.formulaRefService),this.depRefManager=new jJ,this.loadSheetMarked=new Set,this.errors=null,this.conditionalDirtyFormulas=new Set,this.markDirtyCacheOptimize=!1,this.calcEventWatcher=new we.CPL,this.handleSheetRemoved=function(e){var t=e.sheet,n=[],a=t.id(),o=t.name();r.formulaRefManager.handleSheetRemovedRef(a,o,n),r.dynamicRefManager.handleSheetRemovedRef(a,o,n),r.markDirty(n)},this.handleSheetAdded=function(e){var t=e.sheet;r.buildSheetFormulaReferences(t.id()),r.markAlwaysCalcDirty()},this.handleCoverSheet=function(e,t){var n=[];r.formulaRefManager.handleCoverSheet(t.id(),n),r.dynamicRefManager.handleCoverSheet(t.id(),n),r.buildSheetFormulaReferences(t.id()),r.markDirty(n)},this.handleCoverSnapshot=function(){r.formulaRefManager.handleCoverSnapshot(),r.dynamicRefManager.handleCoverSnapshot(),r.buildSheetFormulaReferences()},this.handleFormulaCacheApplyed=function(e){r.statistics.isFirstApplyResult||r.statistics.onFirstApplyResult(e.size);var t=[];e.forEach((function(e){t.push(e.getRef())})),r.markDepRefDirty(t)},this.markAlwaysCalcDirty=function(){r.markDirty([])},this.dirtyArrayRefs=[],this.handleDataChanged=function(e){var t=e.range,n=e.type,a=e.changedRanges,o=e.formulaCellMap,i=t.sheet();if(i&&(a||o)){var u=i.id();r.formulaRefManager.onRangeValueChanged(u,a,o),r.dynamicRefManager.onRangeValueChanged(u,a)}0!==n&&r.markDirty([t])},this.handleMoveRange=function(e){var t=e.fromRange,n=e.toRange,a=e.toEdgeAdjust;r.markDirty([t,n]);var o=new ji(t,n.sheet(),n.rowFrom(),n.colFrom());a&&o.setShouldAdjustToEdge(!!a),r.formulaRefManager.moveRangeService.moveRange(o),r.dynamicRefManager.moveRangeService.moveRange(o),r.depRefManager.onRefOp(o)},this.handleOutlineStateChanged=function(e){var t=e.range,n=t.sheet();n&&t.colCount()===n.getColumnCount()&&r.markAlwaysCalcDirty()},this.handleFormulaRegistered=function(e){var t=e.getRef(),n=t.sheet();t.isValid()&&(r.addFormulaToSheet(e,n.id()),r.statistics.isModuleInit||"number"!=typeof e.getId()||r.statistics.initModule())},this.handleFormulaUnregistered=function(e){var t=e.getRef(),n=t.sheet();if(t.isValid()){var a=n.id();r.removeFormulaFromSheet(e,a)}if(null!=r.workbook){var o=r.workbook,i=o.importRangeManager,u=o.importRangeManagerV3;th(e)&&(e.getExternalDataReferenceInfo()?i.clearMetaAndData(e):u.V3Enable&&u.delFormula(e))}},this.compiler=new Yw(this),this.formulaService=new LM(this,t,n),t&&(this.pivotCalculateEngine=new YM(this,t)),this.initFuncCache(),this.bindEvents(),this.bindWorkbookEvents(),this.formulaService.getFormulaStack().setMaxStackSize(128),t&&(this.formulaRefManager.setSpread(t),this.dynamicRefManager.setSpread(t))}return(0,C.Z)(e,[{key:"isCalcDone",value:function(){if(void 0!==this.isDone)return this.isDone;var e=this.formulaSpace.dirtyFormulas.size,t=this.formulaService.getCalculatingAsyncFormulas().size;return 0===e&&0===t}},{key:"setCalcDone",value:function(e){this.isDone=e}},{key:"getFormulaFromId",value:function(e,t){var n;return null===(n=this.formulaIdMap.get(e))||void 0===n?void 0:n.get(t)}},{key:"getSheetFormulaCount",value:function(e){var t;return(null===(t=this.formulaIdMap.get(e))||void 0===t?void 0:t.size)||0}},{key:"getFuncStatistics",value:function(){return this.compiler.builder.getFuncStatistics()}},{key:"initFuncCache",value:function(){var e=this.formulaService.getFuncCacheManager();e.registerInnerCache("Common",new IO("Common")),e.registerInnerCache("InvertedIndex",new IO("InvertedIndex")),e.registerInnerCache("Sort",new IO("Sort")),e.registerInnerCache("Condition",new IO("Condition")),e.registerInnerCache("AI",new IO("AI"))}},{key:"createFormula",value:function(e,t){var n=t.refMap,r=void 0===n?null:n,a=t.enableCalculation,o=void 0===a||a,i=t.formula,u=t.isArrayFormula;void 0===u&&(null!=i.expression?u=ec(i.expression):null!=i.serialization&&(u=tc(i.serialization)));var s=new(u?o?Bf:$J:o?Kc:qJ)(this.formulaService,e,{formula:i});if(null!==r&&(s.setRefMap(r),this.workbook))for(var l in r){var c=r[l].sheet(),h=null==c?void 0:c.id();h&&!this.loadSheetMarked.has(h)&&(this.workbook.detectWorksheet(c),this.loadSheetMarked.add(h))}return s}},{key:"serializeFormula",value:function(e,t,n){return wf(e,t,n)}},{key:"deserializeFormula",value:function(e,t,n,r){var a,o=null===(a=null==n?void 0:n.enableCalculation)||void 0===a||a;return qw(e,t,this.formulaRefService,Object.assign({},n,{enableCalculation:o}),r)}},{key:"unregisterFormulas",value:function(e){var t=[];this.formulaSpace.formulas.forEach((function(n){n.getRef().sheet()===e&&t.push(n)}));for(var n=0;n<t.length;n++)this.formulaSpace.unRegisterFml(t[n])}},{key:"recoverInvalidRefs",value:function(e){var t=new Set;this.formulaRefManager.collectRecoverFmlAndRef(e,t),this.dynamicRefManager.collectRecoverFmlAndRef(e,t),this.depRefManager.recoverRef(e);var n,r=[],a=_n(t);try{for(a.s();!(n=a.n()).done;){var o=n.value.getRef();r.push(o)}}catch(e){a.e(e)}finally{a.f()}r.length&&this.markDirty(r)}},{key:"compile",value:function(e,t){return this.compiler.compile(e,t)}},{key:"compileTokens",value:function(e){return this.compiler.compileTokens(e)}},{key:"decompile",value:function(e,t){return Rf(e,t)}},{key:"dispose",value:function(){var e,t;this.unbindEvents(),this.calcEventWatcher.destroy(),null!==(e=this.subscriber)&&void 0!==e&&e.unsubscribe(),this.subscriber=null,this.loadSheetMarked.clear(),this.formulaService.getBinaryOpManager().clear(),this.formulaService.getFunctionOpManager().clear(),this.formulaService.getPrefixUnaryOpManager().clear(),this.formulaService.getSuffixUnaryOpManager().clear(),this.formulaService.getFuncCacheManager().dispose(),Xs.dispose(),Uy.dispose(),Cl.dispose(),El.dispose(),Tl=null,Al=null,Fl=null,Ml=null,Nl=null,Ol=null,this.formulaService.dispose(),fL=null,vL=null,LL=null,this.destroyRefCache(),null===(t=this.pivotCalculateEngine)||void 0===t||t.dispose()}},{key:"destroyRefCache",value:function(){this.formulaRefService.destroy(),this.formulaRefManager.destroy(),this.dynamicRefManager.destroy(),this.depRefManager.destroy(),this.formulaIdCounter.clear(),this.formulaIdMap.clear()}},{key:"bindWorkbookEvents",value:function(){var e;this.subscriber=(null===(e=this.workbook)||void 0===e?void 0:e.subscribe(this.getWorkbookEvents()))||null}},{key:"getWorkbookEvents",value:function(){return{FormatterChanged:this.handleDataChanged,RangeChanged:this.handleDataChanged,Sort:this.handleDataChanged,MoveRange:this.handleMoveRange,RowVisible:this.markAlwaysCalcDirty,RowAdded:this.handleRowColAddedOrDeleted.bind(this,"add",!0),RowDeleted:this.handleRowDeleted.bind(this),ColumnAdded:this.handleRowColAddedOrDeleted.bind(this,"add",!1),ColumnDeleted:this.handleRowColAddedOrDeleted.bind(this,"delete",!1),OutlineStateChanged:this.handleOutlineStateChanged,CoverSheet:this.handleCoverSheet,Renamed:this.handleSheetRenamed.bind(this),SheetMoved:this.markAlwaysCalcDirty,SheetRemoved:this.handleSheetRemoved,SheetAdded:this.handleSheetAdded,CoverSnapshot:this.handleCoverSnapshot,FormulaCacheApplied:this.handleFormulaCacheApplyed}}},{key:"handleSheetRenamed",value:function(e){var t=e.sheet,n=[];this.formulaRefManager.handleSheetRename(t.name(),n),this.dynamicRefManager.handleSheetRename(t.name(),n),this.markDirty(n)}},{key:"buildSheetFormulaReferences",value:function(e){if(this.workbook){var t=this.formulaRefService.flushRanges(e);if(t)for(var n=Object.entries(t),r=0;r<n.length;r++){var a=(0,p.Z)(n[r],2),o=a[0],i=a[1],u=this.workbook.getSheetFromId(o);if(u&&i.length){var s=this.groupSimilarFormulaTuples(i,u);this.formulaRefManager.handleLoadSheet(o,s)}}}}},{key:"groupSimilarFormulaTuples",value:function(e,t){var n,r=[],a=_n(e);try{var o=function(){var e,a=(0,p.Z)(n.value,2),o=a[0],i=a[1],u=new Map,s=_n(i);try{for(s.s();!(e=s.n()).done;){var l=e.value,c=t.getVar(l.startRow,l.startCol);if(c instanceof Kc){var h,f=c.getRefMap(),d=null!==(h=u.get(f))&&void 0!==h?h:[];u.set(f,d),d.push(ui.fromGridRange(l))}}}catch(e){s.e(e)}finally{s.f()}for(var v=Array.from(u).map((function(e){var t=(0,p.Z)(e,2),n=t[0],r=t[1];return[o,n,r]})),g=0;g<v.length;g++)r.push(v[g])};for(a.s();!(n=a.n()).done;)o()}catch(e){a.e(e)}finally{a.f()}return r}},{key:"markDirty",value:function(e,t){var n,r=this,a=Date.now(),o=new JJ,i=e.slice(),u=new Set,s=new Set,l=null==t||null===(n=t.validator)||void 0===n?void 0:n.validateFn;for((null===(c=null==t?void 0:t.isDirtyAlwaysCalc)||void 0===c||c)&&this.addAlwaysCalcRange(i);i.length;){var c,h,f=i.pop();if(f.hostId){var d=null===(h=this.workbook)||void 0===h?void 0:h.getSheetFromId(f.hostId);if(d){var v=ei(f,d);if(Do(v))for(var g=o.splitAndAdd(v),m=0,y=g.length;m<y;m++){var C=g[m];IM(d,C,(function(e,t,n){l&&!l(n)||n.markDirty()}));var _=this.formulaRefManager.getMountRefsByDepRef(C).concat(this.dynamicRefManager.getMountRefsByDepRef(C));if(this.depRefManager.search(C).forEach((function(e){u.add(e)})),_.length){for(var R=new Map,w=0;w<_.length;++w)for(var k=_[w],S=k.refs,E=k.relatives,T=k.node,A=0;A<S.length;++A){var I,b=S[A],F=T.ref,M=E[A],V=b.hostId,N=null===(I=this.workbook)||void 0===I?void 0:I.getSheetFromId(V);if(N){var O="";if(this.markDirtyCacheOptimize){var x=Oo(M),Z=xo(M);if(x||Z){var D=fo(F,C);O=x?"".concat(V,"_").concat(D.startRow,"_").concat(D.endRow,"_").concat(M.hash()):"".concat(V,"_").concat(D.startCol,"_").concat(D.endCol,"_").concat(M.hash())}if(O&&s.has(O))continue}var P=R.get(V);P||(P=new Map,R.set(V,P));var L=P.get(M);L||(L=[[],O],P.set(M,L)),L[0].push(wi(b,N))}}R.forEach((function(e,t){var n;if(null===(n=r.workbook)||void 0===n?void 0:n.getSheetFromId(t))if(r.markDirtyCacheOptimize){var a=[];e.forEach((function(e,t){for(var n=(0,p.Z)(e,2),r=n[0],o=n[1],i=tq(r),u=0;u<i.length;++u)a.push(i[u]);o&&s.add(o)}));for(var o=tq(a),u=0;u<o.length;++u)i.push(o[u])}else e.forEach((function(e,t){var n=(0,p.Z)(e,1)[0];n.sort((function(e,t){return e.startRow!==t.startRow?e.startRow-t.startRow:e.startCol-t.startCol}));var r=[];n.forEach((function(e){eq(r,e)}));for(var a=0;a<r.length;++a)i.push(r[a])}))}))}}}}}this.formulaService.getFuncCacheManager().clear(),this.depRefManager.markDirtyCompleted(u,e,t),this.calcEventWatcher.dispatch(DJ.RangeMarkDirtyFinish,e,{duration:Date.now()-a}),this.formulaSpace.dirtyFormulas.size&&this.formulaSpace.emit(ut.FormulaSpaceEvents.onBatchFormulasDirty,this.formulaSpace.dirtyFormulas)}},{key:"arrayFormulaExpand",value:function(e){var t=this;0===this.dirtyArrayRefs.length&&Promise.resolve().then((function(){t.markDirtyAfterCalc()})),this.dirtyArrayRefs.push(e)}},{key:"markDirtyAfterCalc",value:function(){var e=this;if(0!==this.dirtyArrayRefs.length){for(var t=[],n=new Set,r=function(r,a){for(var o=e.dirtyArrayRefs[r],i=e.formulaRefManager.getMountRefsByDepRef(o).concat(e.dynamicRefManager.getMountRefsByDepRef(o)),u=0;u<i.length;++u)for(var s=i[u].refs,l=0;l<s.length;++l){var c=s[l];t.push(c)}e.depRefManager.search(o).forEach((function(e){e.ref!==o&&n.add(e)}))},a=0,o=this.dirtyArrayRefs.length;a<o;a++)r(a);this.depRefManager.markDirtyCompleted(n,this.dirtyArrayRefs),this.markDirty(t,PM),this.dirtyArrayRefs.length=0}}},{key:"addAlwaysCalcRange",value:function(e){var t,n=new Map,r=_n(this.formulaSpace.getAlwaysCalcFormulas());try{for(r.s();!(t=r.n()).done;){var a,o=(0,p.Z)(t.value,2),i=o[0],u=_n(o[1]);try{for(u.s();!(a=u.n()).done;){var s=a.value;if(s.op().shouldMarkDirty(s)){var l=i.getRef(),c=l.hostId,h=n.get(c);h||(h=new wJ,n.set(c,h)),h.add(l);break}}}catch(e){u.e(e)}finally{u.f()}}}catch(e){r.e(e)}finally{r.f()}n.forEach((function(t){t.forEach((function(t){e.push(t)}))}))}},{key:"markDepRefDirty",value:function(e,t){for(var n=e.slice(),r=new Set;n.length;){var a,o=n.pop();(null===(a=this.workbook)||void 0===a?void 0:a.getSheetFromId(o.hostId))&&this.depRefManager.search(o).forEach((function(e){r.add(e)}))}this.depRefManager.markDirtyCompleted(r,e,t)}},{key:"handleRowColAddedOrDeleted",value:function(e,t,n,r){for(var a=new Set,o=r.id(),i=0,u=n.length;i<u;i++){var s=n[i],l=s.target,c=s.count,h=new Wi(t,e,l,c,r);this.formulaRefManager.onRowColAddOrDelete(o,h,a),this.dynamicRefManager.onRowColAddOrDelete(o,h,a),this.depRefManager.onRefOp(h)}this.markDirty(Array.from(a))}},{key:"handleRowDeleted",value:function(e,t){var n=this;if(0!==e.length){var r=function(e){return e.every((function(e,t,n){return 0===t||n[t-1].target>=e.target+e.count}))}(e),a=new Set,o=t.id();if(r){var i=new Ui(e.reverse(),t);this.formulaRefManager.onRowColAddOrDelete(o,i,a),this.dynamicRefManager.onRowColAddOrDelete(o,i,a),this.depRefManager.onRefOp(i)}else e.forEach((function(e){var r=new Wi(!0,"delete",e.target,e.count,t);n.formulaRefManager.onRowColAddOrDelete(o,r,a),n.dynamicRefManager.onRowColAddOrDelete(o,r,a)})),e.sort((function(e,t){return e.target-t.target})),this.depRefManager.onRefOp(new Ui(e,t));this.markDirty(Array.from(a))}}},{key:"iterFormulasDependOn",value:function(e,t,n){for(var r=this,a=this.formulaRefManager.getMountRefsByDepRef(e),o=0;o<a.length;o++)for(var i=a[o],u=i.refs,s=i.relatives,l=function(e){var t,a=u[e].hostId;if(!a)return"continue";var o=null===(t=r.workbook)||void 0===t?void 0:t.getSheetFromId(a);if(!o)return"continue";var i=s[e];return IM(o,u[e],(function(e,t,r){return n(r,ki(i,r.getRef()))}))?{v:void 0}:void 0},c=0;c<u.length;c++){var h=l(c);if("continue"!==h&&"object"===(0,_.Z)(h))return h.v}}},{key:"checkFormulaOutBox",value:function(e){var t=this,n=new Map,r=new Map;if(!this.workbook)return{output:n,miss:r};var a=new Map;return this.formulaSpace.formulas.forEach((function(t){var n,r=t.getRef(),o=null===(n=r.sheet())||void 0===n?void 0:n.id();if(o&&!(e&&o!==e||r.startRow<0&&r.startCol<0)){var i=a.get(o);i||(i=new Set,a.set(o,i)),i.add(t)}})),!a.size&&e&&a.set(e,new Set),a.forEach((function(e,a){var o;if(null===(o=t.workbook)||void 0===o?void 0:o.getSheetFromId(a)){var i=[],u=e.size;if(t.formulaRefManager.excludeFormulaInTree(a,e,i),e.size){var s=[];e.forEach((function(e){var t=e.getRef(),n=t.startRow,r=t.startCol;s.push({row:n,col:r,sheetId:a,fmlId:e.getId(),totalCount:u})})),n.set(a,s)}i.length&&r.set(a,i)}})),{output:n,miss:r}}},{key:"bindEvents",value:function(){this.formulaService.addListener(ut.FormulaEvents.onFormulaValueChanged,Bf.handleValueChanged),this.bindFormulaSpaceEvent()}},{key:"unbindEvents",value:function(){this.formulaService.removeListener(ut.FormulaEvents.onFormulaValueChanged,Bf.handleValueChanged),this.unbindFormulaSpaceEvent()}},{key:"bindFormulaSpaceEvent",value:function(){this.formulaSpace.addListener(ut.FormulaSpaceEvents.onFormulaRegistered,this.handleFormulaRegistered),this.formulaSpace.addListener(ut.FormulaSpaceEvents.onFormulaUnregistered,this.handleFormulaUnregistered)}},{key:"unbindFormulaSpaceEvent",value:function(){this.formulaSpace.removeListener(ut.FormulaSpaceEvents.onFormulaRegistered,this.handleFormulaRegistered),this.formulaSpace.removeListener(ut.FormulaSpaceEvents.onFormulaUnregistered,this.handleFormulaUnregistered)}},{key:"addFormulaToSheet",value:function(e,t){var n,r;rh(e)?r=e.getId():(r=(null!==(n=this.formulaIdCounter.get(t))&&void 0!==n?n:0)+1,this.formulaIdCounter.set(t,r)),e.setId(r);var a=this.formulaIdMap.get(t);void 0===a&&(a=new Map,this.formulaIdMap.set(t,a)),a.set(r,e),this.statistics.add(t,Jb.FormulaCount)}},{key:"removeFormulaFromSheet",value:function(e,t){var n;null!==(n=this.formulaIdMap.get(t))&&void 0!==n&&n.delete(e.getId()),this.statistics.sub(t,Jb.FormulaCount)}},{key:"moveFormulaCrossSheet",value:function(e,t,n){t!==n&&(this.removeFormulaFromSheet(e,t),this.addFormulaToSheet(e,n))}},{key:"getPrecisionAddOp",value:function(){return null==this.precisionOps.Add&&(this.precisionOps.Add=new jy),this.precisionOps.Add}},{key:"getPrecisionSubOp",value:function(){return null==this.precisionOps.Sub&&(this.precisionOps.Sub=new zy),this.precisionOps.Sub}},{key:"getBinaryOp",value:function(e){var t=this.formulaService.getBinaryOpManager(),n=t.find(e);if(null!=n)return n;var r=XJ(e),a=nJ.get(r);if(null==a)return null;var o=new a(r);return t.register(o),o}},{key:"getFunctionOp",value:function(e){var t=this.formulaService.getFunctionOpManager(),n=t.find(e);if(null!=n)return n;var r=XJ(e),a=oJ.get(r);if(null==a)return null;var o=new a(r);return t.register(o),o}},{key:"getSuffixUnaryOp",value:function(e){var t=this.formulaService.getSuffixUnaryOpManager(),n=t.find(e);if(null!=n)return n;var r=XJ(e),a=aJ.get(r);if(null==a)return null;var o=new a(r);return t.register(o),o}},{key:"getPrefixUnaryOp",value:function(e){var t=this.formulaService.getPrefixUnaryOpManager(),n=t.find(e);if(null!=n)return n;var r=XJ(e),a=rJ.get(r);if(null==a)return null;var o=new a(r);return t.register(o),o}},{key:"getPrefixFunction",value:function(e){if(""===e)return[];null==this.prefixes&&(this.prefixes=Array.from(oJ.keys()).sort());for(var t=[],n=(0,an.lowerBound)(this.prefixes,e,(function(e,t){return e<t}));n<this.prefixes.length;n++){var r=this.prefixes[n];if(!r.startsWith(e))break;t.push(r)}return t}},{key:"getParenOp",value:function(){return null===this.parenOperator&&(this.parenOperator=new ut.ParenOp),this.parenOperator}},{key:"subscribeEvents",value:function(e,t){return this.calcEventWatcher.subscribe(e,t)}},{key:"getInvokeFunctionOp",value:function(){return null===this.InvokeFunctionOperator&&(this.InvokeFunctionOperator=new yf),this.InvokeFunctionOperator}},{key:"watchFormulaRefMap",value:function(e,t,n,r){if(!this.formulaSpace.formulas.has(e)){var a=new Map,o=e.getRefMap(),i=e.getRef();for(var u in o){var s=ki(o[u],i);a.set(s,u)}return this.depRefManager.watchRefs(Array.from(a.keys()),t,n,(function(t,n){var o=a.get(t);if(o){var u=e.getRefMap(),s={};for(var l in u)s[l]=o!==l?u[l]:Si(t,i);e.setRefMap(s),null==r||r(t,n)}}))}}},{key:"reactivitySpace",get:function(){return this.formulaService.reactivitySpace}},{key:"formulaSpace",get:function(){return this.formulaService.getFormulaSpace()}}]),e}(),KJ=function(e){function t(e){var n;return(0,y.Z)(this,t),(n=(0,d.Z)(this,(0,v.Z)(t).call(this,e,OM))).workbook=e,n.statistics.disableApplyResultReport=!1,n.cfmStatistics.disableApplyResultReport=!1,n.pivotStatistics.disableApplyResultReport=!1,n}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"markDirty",value:function(e,t){this.markDepRefDirty(e,t)}},{key:"compile",value:function(e,t){var n;return t.enableCalculation=null!==(n=t.enableCalculation)&&void 0!==n&&n,this.compiler.compile(e,t)}},{key:"deserializeFormula",value:function(e,t,n,r){var a,o=null!==(a=null==n?void 0:n.enableCalculation)&&void 0!==a&&a;return qw(e,t,this.formulaRefService,Object.assign({},n,{enableCalculation:o}),r)}},{key:"createFormula",value:function(e,n){var r=n.refMap,a=void 0===r?null:r,o=n.enableCalculation,i=void 0!==o&&o,u=n.formula,s=n.isArrayFormula;return(0,f.Z)((0,v.Z)(t.prototype),"createFormula",this).call(this,e,{refMap:a,enableCalculation:i,formula:u,isArrayFormula:s})}}]),t}(YJ);function XJ(e){if(e.length<=1)return e;var t=e.trim();return 0===t.length?" ":t}function QJ(e){return"function"==typeof e.union&&"function"==typeof e.isUnionable}function eq(e,t){if(QJ(t)){for(var n=0;n<e.length;n++)if(t.isUnionable(e[n])){var r=t.union(e[n]);if(null!==r)return void(e[n]=r)}e.push(t)}else e.push(t)}function tq(e){if(e.length<=1)return e;e.sort((function(e,t){return e.startCol!==t.startCol?e.startCol-t.startCol:e.startRow-t.startRow}));var t=[];return e.forEach((function(e){if(0!==t.length){var n=function(e,t){if(!QJ(e)||!QJ(t))return t;if(!t.isUnionable(e))return t;var n=t.union(e);return null!==n?n:t}(t[t.length-1],e);n===e?t.push(e):t[t.length-1]=n}else t.push(e)})),t}var nq=function(){function e(t){var n=this,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:50;(0,y.Z)(this,e),this._idle=t,this._taskTime=r,this.taskFnMap=new Map,this.priorityList=[],this.start=!1,this.isTabVisible="visible"===document.visibilityState,this.taskCount={},this.activeSheetId=null,this.forceStopStatus=!1,this.tabChange=function(){n.isTabVisible="visible"===document.visibilityState},this.visibilityWatcher=new we.ze4,this.visibilityWatcher.watch(),this.bindEvent()}return(0,C.Z)(e,[{key:"getTaskCount",value:function(e){return this.taskCount[e]||0}},{key:"bindEvent",value:function(){this.visibilityWatcher.on(we.zOj,this.tabChange)}},{key:"unbindEvent",value:function(){this.visibilityWatcher.off(we.zOj,this.tabChange)}},{key:"add",value:function(e,t){var n=this.taskFnMap.get(e);n||(n=[],this.taskFnMap.set(e,n),this.priorityList.push(e)),n.push(t)}},{key:"updateSheet",value:function(e){this.activeSheetId=e,this.raisePriority(e)}},{key:"raisePriority",value:function(e){if(this.taskFnMap.get(e)){var t=this.priorityList.indexOf(e);-1!==t&&this.priorityList.splice(t,1),this.priorityList.unshift(e)}}},{key:"removePriority",value:function(e){if(!this.taskFnMap.has(e)){var t=this.priorityList.indexOf(e);t>-1&&this.priorityList.splice(t,1)}}},{key:"run",value:function(){var e=this;if(!this.start&&!this.forceStopStatus){this._idle.turnOnIdle(),this._idle.registerIdleCallback((function t(){if(!e.forceStopStatus){var n=e.isTabVisible?e._taskTime:5e3;null!==e.activeSheetId&&e.priorityList[0]!==e.activeSheetId&&e.raisePriority(e.activeSheetId);for(var r=Date.now();Date.now()-r<n&&e.taskFnMap.size;){var a=e.priorityList[0];e.runImmediately(a)}e.taskFnMap.size?e._idle.registerIdleCallback(t,99999):(e._idle.turnOffIdle(),e.start=!1)}}),99999),this.start=!0}}},{key:"runImmediately",value:function(e){var t=this.taskFnMap.get(e);if(t)return 0===t.length?(this.taskFnMap.delete(e),void this.removePriority(e)):void(null==t[0].next()&&t.shift());this.removePriority(e)}},{key:"addSheetAppliedRowCount",value:function(e){this.taskCount[e]=this.getTaskCount(e)+1}},{key:"suspend",value:function(){this.forceStopStatus=!0}},{key:"resume",value:function(){this.forceStopStatus=!1,this.start&&(this.start=!1),this.run()}},{key:"clear",value:function(){this.priorityList.length=0,this.taskCount={},this.taskFnMap.clear(),this.start=!1,this.visibilityWatcher.unwatch(),this.unbindEvent()}}]),e}();function rq(e,t){return e instanceof oq&&(!t||e.blockType===t)}var aq,oq=function(e){function t(e,n,r,a,o,i){var u,s=arguments.length>6&&void 0!==arguments[6]&&arguments[6],l=arguments.length>7&&void 0!==arguments[7]&&arguments[7];if((0,y.Z)(this,t),(u=(0,d.Z)(this,(0,v.Z)(t).call(this,e,n,l,r)))._blockId=o,u._isNew=s,u._blockType=a,i)u._blockToken=i,u.getBlockToken=function(){return Promise.resolve(i)};else{var c=new Promise((function(e){u._updateTokenResolve=e}));u.getBlockToken=function(){return c}}return(0,d.Z)(u)}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"setBlockToken",value:function(e){return!(this._blockToken||!this._updateTokenResolve||(this._blockToken=e,this._updateTokenResolve(e),delete this._updateTokenResolve,0))}},{key:"toJSON",value:function(e){var n=arguments.length>1&&void 0!==arguments[1]&&arguments[1],r=(0,f.Z)((0,v.Z)(t.prototype),"toJSON",this).call(this,e,n);return r.externalResource={blockType:this.blockType,blockToken:this.blockToken,blockId:this.blockId},r}},{key:"sheetType",get:function(){return"blockSheet"}},{key:"isNew",get:function(){return this._isNew}},{key:"blockId",get:function(){return this._blockId}},{key:"blockType",get:function(){return this._blockType}},{key:"blockToken",get:function(){return this._blockToken}}]),t}(gM),iq=function(){function e(){(0,y.Z)(this,e),this.ISVRelationshipMap=new Map}return(0,C.Z)(e,[{key:"initISVRelationshipMap",value:function(e){var t=this;e.forEach((function(e){t.setISVRelationshipData(e)}))}},{key:"setISVRelationshipData",value:function(e,t){var n=e.sheetId,r=e.version,a=e.status,o=this.ISVRelationshipMap.get(n);if(!(!t&&o&&o.version>=r)){var i={version:r,status:a};this.ISVRelationshipMap.set(n,i)}}},{key:"getIsISVRelatedBySheetId",value:function(e){if(!e)return!1;var t=this.ISVRelationshipMap.get(e);return!!t&&0===t.status}},{key:"getSpreadIsExistRelationship",value:function(){if(this.ISVRelationshipMap){var e,t=_n(this.ISVRelationshipMap);try{for(t.s();!(e=t.n()).done;){if(0===e.value[1].status)return!0}}catch(e){t.e(e)}finally{t.f()}return!1}return!1}},{key:"getISVRelationshipData",value:function(){return(0,re.Z)(this.ISVRelationshipMap)}}]),e}(),uq=function(){function e(){(0,y.Z)(this,e),this._arr=[]}return(0,C.Z)(e,[{key:"enqueue",value:function(e){for(var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,n=this._arr.length,r=n,a=n-1;a>=0&&t>this._arr[a][1];a--)r=a;this._arr.splice(r,0,[e,t])}},{key:"dequeue",value:function(){var e=this._arr.shift();return e?e[0]:null}},{key:"remove",value:function(e){var t=this._arr.findIndex((function(t){return t[0]===e}));return-1!==t&&(this._arr.splice(t,1),!0)}},{key:"peek",value:function(){return this.isEmpty()?null:this._arr[0][0]}},{key:"isEmpty",value:function(){return 0===this._arr.length}},{key:"clear",value:function(){this._arr.length=0}},{key:"getItemPriority",value:function(e){var t=this._arr.find((function(t){return t[0]===e}));return null==t?null:t[1]}}]),e}(),sq=function(){function e(){(0,y.Z)(this,e),this.queue=new uq,this.isSuspended=!1,this.isExecuting=!1}return(0,C.Z)(e,[{key:"addTask",value:function(e){this.queue.enqueue(e),this.runTask()}},{key:"removeTask",value:function(e){this.queue.remove(e)}},{key:"suspend",value:function(){this.isSuspended=!0}},{key:"resume",value:function(){this.isSuspended=!1,this.runTask()}},{key:"runTask",value:function(){for(var e=this;!this.queue.isEmpty();){if(this.isSuspended||this.isExecuting)return;var t=this.queue.dequeue();if(!t)return;var n=void 0;if(this.isExecuting=!0,(n="function"==typeof t?t():t.fn.apply(t.context,t.param))instanceof Promise){n.then((function(){e.isExecuting=!1,e.runTask()}));break}this.isExecuting=!1}}},{key:"destroy",value:function(){this.queue.clear()}},{key:"getTaskPriority",value:function(e){return this.queue.getItemPriority(e)}}]),e}();!function(e){e[e.LoadData=99999]="LoadData",e[e.CalculateFormulas=200]="CalculateFormulas",e[e.CalculateConditionalFormatStyle=199]="CalculateConditionalFormatStyle",e[e.ApplyCalculationResults=100]="ApplyCalculationResults",e[e.UpdateConditionalFormatStyle=99]="UpdateConditionalFormatStyle",e[e.Default=0]="Default"}(aq||(aq={}));var lq=function(e){function t(){var e;return(0,y.Z)(this,t),(e=(0,d.Z)(this,(0,v.Z)(t).call(this))).turnOnCount=0,e.isRegister=!1,e.queue=new uq,e.port=null,e.nextTickFn=null,e._isIdle=!1,e._forceIdle=!1,e._callback=function(){var n=e.queue.dequeue();n&&n(),e.isRegister=!1,e.queue.isEmpty()||(e.isRegister=!0,(0,f.Z)(((0,c.Z)(e),(0,v.Z)(t.prototype)),"registerIdleCallback",(0,c.Z)(e)).call((0,c.Z)(e),e._callback))},e.initChannel(),e}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"initChannel",value:function(){var e=this;try{var t=new MessageChannel,n=t.port1;this.port=t.port2,n.onmessage=function(){var t=e.nextTickFn;t&&(e.nextTickFn=null,t())}}catch(e){this.port=null}}},{key:"getCurrentTime",value:function(){return performance.now()}},{key:"setTimer",value:function(e){return setTimeout(e,20)}},{key:"cancelTimer",value:function(e){return clearTimeout(e)}},{key:"turnOnIdle",value:function(){this.turnOnCount++,this._forceIdle=!0,this.threshold=0}},{key:"turnOffIdle",value:function(){this.turnOnCount=this.turnOnCount<=0?0:this.turnOnCount-1,0===this.turnOnCount&&(this._forceIdle=!1,this.threshold=200)}},{key:"nextTick",value:function(e){this.port?(this.nextTickFn=e,this.port.postMessage(null)):window.setTimeout(e,0)}},{key:"registerIdleCallback",value:function(e){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;this.isRegister||(this.isRegister=!0,(0,f.Z)((0,v.Z)(t.prototype),"registerIdleCallback",this).call(this,this._callback)),this.queue.enqueue(e,n)}},{key:"unRegisterIdleCallback",value:function(e){this.queue.remove(e),this.queue.isEmpty()&&this.isRegister&&(this.isRegister=!1,(0,f.Z)((0,v.Z)(t.prototype),"unRegisterIdleCallback",this).call(this,this._callback))}},{key:"destroy",value:function(){this.queue.clear(),this.isRegister&&(this.isRegister=!1,(0,f.Z)((0,v.Z)(t.prototype),"unRegisterIdleCallback",this).call(this,this._callback))}},{key:"isIdle",get:function(){return this._isIdle||this._forceIdle},set:function(e){this._isIdle=e}}]),t}(Rt.Idle),cq=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"setTimer",value:function(e){return-1}},{key:"registerIdleCallback",value:function(e){}},{key:"unRegisterIdleCallback",value:function(e){}}]),t}(lq),hq=function(){function e(){(0,y.Z)(this,e),this._stashEditorSelection=null,this._stashActiveEditor=null}return(0,C.Z)(e,[{key:"getStashEditorSelection",value:function(){return this._stashEditorSelection}},{key:"stashEditorSelection",value:function(e){this._stashEditorSelection=e}},{key:"stashActiveEditor",value:function(e){this._stashActiveEditor=e}},{key:"getStashActiveEditor",value:function(){return this._stashActiveEditor}}]),e}(),fq=function(){function e(){(0,y.Z)(this,e),this.executors=new Map}return(0,C.Z)(e,[{key:"registerAction",value:function(e){if(this.executors.has(e.action))throw new Error("duplicated register, action: ".concat(e.action));this.executors.set(e.action,e)}},{key:"getActionExecutor",value:function(e){return this.executors.get(e)}}]),e}(),dq=new fq;function vq(e){return e&&"cell"!==e.type?(void 0!==e.row_count&&(e.rowCount=e.row_count,delete e.row_count),void 0!==e.col_count&&(e.colCount=e.col_count,delete e.col_count),e):e}function gq(e){var t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];if(t&&(e=ya(e)),e.target=vq(e.target),!(0,se.default)(e.value)&&"setSpans"===e.action){var n,r=_n(e.value);try{for(r.s();!(n=r.n()).done;){var a=n.value;a.target=vq(a.target)}}catch(e){r.e(e)}finally{r.f()}}return e}var mq=function(){function e(){(0,y.Z)(this,e),this.prepare=[],this.finish=[],this.proxy=null,this.options={logger:console,needClone:!0},this.strategy=new yq}return(0,C.Z)(e,[{key:"registerCsPreare",value:function(e){this.prepare.push(e)}},{key:"registerCsFinish",value:function(e){this.finish.push(e)}},{key:"registerProxy",value:function(e){this.proxy=e}},{key:"updateOptions",value:function(e){Object.assign(this.options,e)}},{key:"setStrategy",value:function(e){this.strategy=e}},{key:"batchExecBegin",value:function(){this.strategy.batchExecBegin()}},{key:"batchExecFinish",value:function(){this.strategy.batchExecFinish()}},{key:"destroy",value:function(){this.prepare.length=0,this.finish.length=0,this.proxy=null}},{key:"notifyPrepare",value:function(e,t,n,r){this.prepare.forEach((function(a){return a(e,t,n,r)}))}},{key:"notifyFinish",value:function(e,t,n,r){this.finish.forEach((function(a){return a(e,t,n,r)}))}},{key:"execBatchActions",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]&&arguments[2],r=arguments.length>3&&void 0!==arguments[3]&&arguments[3],a=arguments.length>4?arguments[4]:void 0;this.strategy.batchExecBegin();for(var o=0;o<t.length;o++){var i=t[o];if((0,se.default)(i))return;this.execAction(e,i,n,r,a,0==o)}this.strategy.batchExecFinish()}},{key:"execAction",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]&&arguments[2],r=arguments.length>3&&void 0!==arguments[3]&&arguments[3],a=arguments.length>4?arguments[4]:void 0,o=!(arguments.length>5&&void 0!==arguments[5])||arguments[5],i=e;(0,we.X_h)(t.action)||((i=e.getSheetFromId(t.sheet_id))||this.logger.trace(fn("sheet.spread.target_not_exit_tips"),t));var u=t,s=u.action,l=t.sheet_id;"copySheet"===s&&(l=t.value.sheet_id);var c=-1;t=gq(t,this.options.needClone),!n&&i&&i.suspendEvent();try{this.notifyPrepare(i,s,l,t),this.proxy&&this.proxy[s]?this.proxy[s](this,i,t,r,a):this.strategy.excuteActionImpl(i,t,a,r),this.notifyFinish(i,s,l,t),c=0}catch(e){o&&we.Ps3.moirae.teaLog({key:"client_sheet_changeset_exeAction_fail",sheetExist:!!i,action:s,stack:e.stack}),this.logger.error("execAction error: ".concat(s,"|").concat(e.stack)),c=e.code||-1}finally{!n&&i&&i.resumeEvent()}return c}},{key:"excuteActionImpl",value:function(e,t,n,r){return this.strategy.excuteActionImpl(e,t,n,r)}},{key:"logger",get:function(){return this.options.logger}}]),e}(),pq=function(){function e(){(0,y.Z)(this,e)}return(0,C.Z)(e,[{key:"batchExecBegin",value:function(){this.execContext={}}},{key:"excuteActionImpl",value:function(e,t){var n=dq.getActionExecutor(t.action);if(!n)throw new Error("Error: unknown changeset action ".concat(t.action));var r=n.execute(e,t,this.execContext);return n.batchDone&&n.batchDone(this.execContext),r}},{key:"batchExecFinish",value:function(){this.execContext={}}}]),e}(),yq=function(e){function t(){var e;return(0,y.Z)(this,t),(e=(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))).batchDoneSet=new Set,e}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"excuteActionImpl",value:function(e,t,n,r){var a=this,o=dq.getActionExecutor(t.action);if(!o)throw new Error("Error: unknown changeset action ".concat(t.action));this.batchDoneSet.forEach((function(e){e.needBatchDone&&e.needBatchDone(t,a.execContext)&&e.batchDone&&(e.batchDone(a.execContext),a.batchDoneSet.delete(e))}));var i=o.execute(e,t,this.execContext,n,r);return o.batchDone&&this.batchDoneSet.add(o),i}},{key:"batchExecFinish",value:function(){var e=this;this.batchDoneSet.size&&this.batchDoneSet.forEach((function(t){t.batchDone&&t.batchDone(e.execContext)})),this.batchDoneSet.clear(),(0,f.Z)((0,v.Z)(t.prototype),"batchExecFinish",this).call(this)}}]),t}(pq),Cq=function(){function e(){(0,y.Z)(this,e),this.action="addBlock"}return(0,C.Z)(e,[{key:"execute",value:function(e,t,n){n.book=e,function(e,t){var n=t.value,r=n.block_token?n.block_token:void 0,a=!0,o=e.creatBlockWorksheet(n.sheet_id,n.sheet_name,n.block_type,n.block_id,r,a);e.dispatch("SheetInit",o),e._addSheet(n.index,o)}(e,t)}}]),e}();dq.registerAction(new Cq);var _q=function(){function e(){(0,y.Z)(this,e),this.action="addCol"}return(0,C.Z)(e,[{key:"execute",value:function(e,t,n,r,a){n.book=e.getParent();var o=t.target;e.addColumns(o.col,o.colCount,r),e.dispatch("ColumnAdded",[{target:o.col,count:o.colCount}],DA(r,a))}}]),e}();dq.registerAction(new _q);var Rq=function(){function e(){(0,y.Z)(this,e),this.action="addComments"}return(0,C.Z)(e,[{key:"execute",value:function(e,t,n){n.book=e.getParent();var r=t.target,a=t.value,o=r.row,i=r.col;if(a.hasOwnProperty("comments")){var u=e.getComments(o,i)||[],s=(0,V.Z)(u,a.comments).reverse(),l=(0,M.Z)(s,"id").reverse();return e._setComments(o,i,l),s}return[]}}]),e}();dq.registerAction(new Rq);var wq=function(){function e(){(0,y.Z)(this,e),this.action="addConditionalFormat"}return(0,C.Z)(e,[{key:"execute",value:function(e,t,n){n.book=e.getParent();var r=t.value;e._addConditionalFormat(r.cfId,r)}}]),e}();dq.registerAction(new wq);var kq=function(){function e(){(0,y.Z)(this,e),this.action="addRow"}return(0,C.Z)(e,[{key:"execute",value:function(e,t,n,r,a){n.book=e.getParent();var o=t.target;e.addRows(o.row,o.rowCount,r),n.addRowWorksheet=e,n.addRowInfo||(n.addRowInfo=[]),n.addRowInfo.push({target:o.row,count:o.rowCount}),n.fromUndoRedo=r,n.local=a}},{key:"needBatchDone",value:function(e,t){return"addRow"!==e.action||!!t.addRowWorksheet&&t.addRowWorksheet.id()!==e.sheet_id}},{key:"batchDone",value:function(e){if(e.addRowInfo&&e.addRowWorksheet){var t=e.fromUndoRedo,n=e.local;e.addRowWorksheet.dispatch("RowAdded",e.addRowInfo,DA(t,n)),delete e.addRowInfo,delete e.addRowWorksheet,delete e.fromUndoRedo,delete e.local}}}]),e}();dq.registerAction(new kq);var Sq=function(){function e(){(0,y.Z)(this,e),this.action="addSheet"}return(0,C.Z)(e,[{key:"execute",value:function(e,t,n,r,a){n.book=e;var o=t.value,i=t.sheet_name,u=t.sheet_id,s=e.createWorksheet(u,i,!1);e._addSheet(o.index,s,DA(r,a))}}]),e}();dq.registerAction(new Sq);var Eq=function(){function e(){(0,y.Z)(this,e),this.action="addView"}return(0,C.Z)(e,[{key:"execute",value:function(e,t,n){var r=t.value,a=r.view_id,o=r.name,i=r.empty;e.viewsModel.addView(a,o,i)}}]),e}();dq.registerAction(new Eq);var Tq=function(){function e(){(0,y.Z)(this,e),this.action="copySheet"}return(0,C.Z)(e,[{key:"execute",value:function(e,t,n){n.book=e,e.logger.info(">>>copySheet|value:".concat(t.value.index)),function(e,t){var n=t.value,r=e.createWorksheet(n.sheet_id,n.sheet_name,!1);if(n.snapshot){if(n.snapshot.name=n.sheet_name,void 0===n.schemaVersion&&(n.schemaVersion=0),void 0===n.snapshot.comment&&void 0===n.snapshot.mention&&void 0===n.snapshot.image&&void 0===n.snapshot.entities||(n.schemaVersion=1),1!==n.schemaVersion){var a=(new TF).convertSheet(n.schemaVersion,1,n.snapshot).sheetSnapshot;n.snapshot=a}r.fromJSON(n.snapshot)}var o=e.getSheetFromId(r.id()),i=e.getSheetFromName(r.name());o&&o.name()!==r.name()?(e.logger.warn("SHEET_CHANGESET_COPYSHEET_ID_REPEAT"),we.Ps3.moirae&&we.Ps3.moirae.ravenCatch("SHEET_CHANGESET_COPYSHEET_ID_REPEAT",{tags:{scm:JSON.stringify(window.scm),key:"SHEET_CHANGESET_COPYSHEET_ID_REPEAT"}})):(i&&(e.logger.warn("SHEET_CHANGESET_COPYSHEET_NAME_REPEAT"),we.Ps3.moirae&&we.Ps3.moirae.ravenCatch("SHEET_CHANGESET_COPYSHEET_NAME_REPEAT",{tags:{scm:JSON.stringify(window.scm),key:"SHEET_CHANGESET_COPYSHEET_NAME_REPEAT"}}),e.removeSheetFromId(i.id())),e._addSheet(n.index,r))}(e,t)}}]),e}();dq.registerAction(new Tq);var Aq=function(){function e(){(0,y.Z)(this,e),this.action="coverSheet"}return(0,C.Z)(e,[{key:"execute",value:function(e,t,n){n.book=e.getParent();var r=t.value,a=r.sheet,o=r.blockData;a.blocks&&a.blocks.length&&a.blocks.forEach((function(e){var t=e.token,n=o[t];if(n){var r=(0,we.Bep)(n,e.startRowIndex);a.data?Object.assign(a.data.dataTable,r):a.data={dataTable:r}}})),a.name=e.name();var i=t.value.schemaVersion;if(void 0===i&&(i=0),1!==i){var u=(new TF).convertSheet(i,1,a).sheetSnapshot;a=u}e.fromJSON(a),e.dispatch("CoverSheet")}}]),e}();dq.registerAction(new Aq);var Iq=function(){function e(){(0,y.Z)(this,e),this.action="coverSnapshot"}return(0,C.Z)(e,[{key:"execute",value:function(e,t,n){n.book=e;var r=t.value,a=r.contentMeta,o=r.blockData,i=a.sheets,u=function(e){var t=i[e];t.blocks&&t.blocks.length&&t.blocks.forEach((function(e){var n=e.token,r=o[n];if(r){var a=(0,we.Bep)(r,e.startRowIndex);t.data?Object.assign(t.data.dataTable,a):t.data={dataTable:a}}}))};for(var s in i)u(s);void 0===a.schemaVersion&&(a.schemaVersion=0),1!==a.schemaVersion&&(a=(new TF).convert(a.schemaVersion,1,a).snapshot),a.lang=e.lang,a.locale=e.locale,e.fromJSON(a),e.setActiveSheetIndex(0,!0,!0),e.permissionManager.refreshPermission(),e.dispatch("CoverSnapshot",{contentMeta:a}),e.dispatch("ActiveSheetChanged",{newSheet:e.getSheetFromIndex(0)})}}]),e}();dq.registerAction(new Iq);var bq=function(){function e(){(0,y.Z)(this,e),this.action="delBlock"}return(0,C.Z)(e,[{key:"execute",value:function(e,t,n){n.book=e,e.removeSheetFromId(t.sheet_id)}}]),e}();dq.registerAction(new bq);var Fq=function(){function e(){(0,y.Z)(this,e),this.action="delChart"}return(0,C.Z)(e,[{key:"execute",value:function(e,t,n){n.book=e.getParent(),e._deleteChart(t.value.chartId)}}]),e}();dq.registerAction(new Fq);var Mq=function(){function e(){(0,y.Z)(this,e),this.action="delCol"}return(0,C.Z)(e,[{key:"execute",value:function(e,t,n,r,a){n.book=e.getParent();var o=t.target;e.deleteColumns(o.col,o.colCount,r),function(e){for(var t=e.getColumnCount(),n=e.getSelections(),r=!1,a=1,o=1,i=0,u=0,s=0;s<n.length;s++){var l=n[s];if(l.colFrom()+l.colCount()>t){r=!0,l.colFrom()>=t?(u=t,a=1):(u=l.colFrom(),a=t-l.colFrom()),i=l.rowFrom(),o=l.rowCount();break}}r&&e.setSelection(new Oi(i,u,o,a,e))}(e),e.dispatch("ColumnDeleted",[{target:o.col,count:o.colCount}],DA(r,a))}}]),e}();dq.registerAction(new Mq);var Vq=function(){function e(){(0,y.Z)(this,e),this.action="delConditionalFormat"}return(0,C.Z)(e,[{key:"execute",value:function(e,t,n){n.book=e.getParent();var r=t.value;e._deleteConditionalFormat(r.cfId)}}]),e}();function Nq(e,t){if(e.filterModel===t){var n=t.getAllFilteredOutRows();return function(){var t=e.filterModel.getAllFilteredOutRows();!function(e,t,n){var r=function(e,t){for(var n=[],r=Array.from(e),a=Array.from(t),o=0,i=r.length;o<i;o++){var u=r[o];t.has(u)||n.push({row:u,count:1,oldValue:!1,newValue:!0})}for(var s=0,l=a.length;s<l;s++){var c=a[s];e.has(c)||n.push({row:c,count:1,oldValue:!0,newValue:!1})}return n}(t,n);r.length&&e.dispatch("RowVisible",{changes:r,type:1})}(e,n,t)}}return P.default}dq.registerAction(new Vq);var Oq=function(){function e(){(0,y.Z)(this,e),this.action="delFilter"}return(0,C.Z)(e,[{key:"execute",value:function(e,t,n){var r=Nq(e,e.sheetFilterModel);e.sheetFilterModel.removeFilter(),r(),e.dispatch("FilterChanged")}}]),e}();dq.registerAction(new Oq);var xq=function(){function e(){(0,y.Z)(this,e),this.action="delFloatImage"}return(0,C.Z)(e,[{key:"execute",value:function(e,t,n){n.book=e.getParent(),e._deleteFloatImage(t.value.floatImageId)}}]),e}();dq.registerAction(new xq);var Zq=function(){function e(){(0,y.Z)(this,e),this.action="delRow"}return(0,C.Z)(e,[{key:"execute",value:function(e,t,n,r,a){n.book=e.getParent();var o=t.target;e.deleteRows(o.row,o.rowCount,r),function(e){for(var t=e.getRowCount(),n=e.getSelections(),r=!1,a=1,o=1,i=0,u=0,s=0;s<n.length;s++){var l=n[s];if(l.rowFrom()+l.rowCount()>t){r=!0,l.rowFrom()>=t?(i=t,o=1):(i=l.rowFrom(),o=t-l.rowFrom()),u=l.colFrom(),a=l.colCount();break}}r&&e.setSelection(new Oi(i,u,o,a,e))}(e),n.delRowWorksheet=e,n.delRowInfo||(n.delRowInfo=[]),n.delRowInfo.push({target:o.row,count:o.rowCount}),n.fromUndoRedo=r,n.local=a}},{key:"needBatchDone",value:function(e,t){return"delRow"!==e.action||!!t.delRowWorksheet&&t.delRowWorksheet.id()!==e.sheet_id}},{key:"batchDone",value:function(e){e.delRowInfo&&e.delRowWorksheet&&(e.delRowWorksheet.dispatch("RowDeleted",e.delRowInfo,DA(e.fromUndoRedo,e.local)),delete e.delRowInfo,delete e.delRowWorksheet,delete e.fromUndoRedo,delete e.local)}}]),e}();dq.registerAction(new Zq);var Dq=function(){function e(){(0,y.Z)(this,e),this.action="delSheet"}return(0,C.Z)(e,[{key:"execute",value:function(e,t,n,r,a){n.book=e.getParent();var o=e.parent,i=e.name();o.removeSheet(o.getSheetIndex(i),DA(r,a))}}]),e}();dq.registerAction(new Dq);var Pq=function(){function e(){(0,y.Z)(this,e),this.action="delView"}return(0,C.Z)(e,[{key:"execute",value:function(e,t,n){var r,a=t.value.view_id,o=Nq(e,null===(r=e.viewsModel.getViewById(a))||void 0===r?void 0:r.getFilterModel());e.viewsModel.deleteViewById(a),o()}}]),e}();dq.registerAction(new Pq);var Lq=function(){function e(){(0,y.Z)(this,e),this.action="freezeSheet"}return(0,C.Z)(e,[{key:"execute",value:function(e,t,n){n.book=e.getParent();var r=t.target,a=r.row,o=r.col;a>=0&&e.frozenRowCount(a),o>=0&&e.frozenColumnCount(o)}}]),e}();dq.registerAction(new Lq);var Bq=function(){function e(){(0,y.Z)(this,e)}return(0,C.Z)(e,[{key:"execute",value:function(e,t,n,r,a){n.rowVisibleSheet=e,n.book=e.getParent(),n.rowVisibleInfo||(n.rowVisibleInfo=[]);var o=t.target;return n.rowVisibleInfo.push(function(e,t,n,r){var a=Math.max(0,t);return e.setRowVisible(a,r,void 0,n),{row:t,count:n,newValue:r,oldValue:!r}}(e,o.row,o.rowCount,this.visible)),n.fromUndoRedo=r,n.local=a,!0}},{key:"needBatchDone",value:function(e,t){return!(!t.rowVisibleSheet||t.rowVisibleSheet.id()===e.sheet_id)}},{key:"batchDone",value:function(e){var t=e.rowVisibleSheet,n=e.rowVisibleInfo,r=e.fromUndoRedo,a=e.local;t&&n&&(t.dispatch("RowVisible",{changes:n,type:0},DA(r,a)),delete e.rowVisibleSheet,delete e.rowVisibleInfo,delete e.fromUndoRedo,delete e.local)}}]),e}(),Uq=function(){function e(){(0,y.Z)(this,e)}return(0,C.Z)(e,[{key:"execute",value:function(e,t,n,r,a){n.colVisibleSheet=e,n.book=e.getParent(),n.colVisibleInfo||(n.colVisibleInfo=[]);var o=t.target;return n.colVisibleInfo.push(function(e,t,n,r){var a=Math.max(0,t);return e.setColumnVisible(a,r,void 0,n),{col:t,count:n,newValue:r,oldValue:!r}}(e,o.col,o.colCount,this.visible)),n.fromUndoRedo=r,n.local=a,!0}},{key:"needBatchDone",value:function(e,t){return!(!t.colVisibleSheet||t.colVisibleSheet.id()===e.sheet_id)}},{key:"batchDone",value:function(e){var t=e.colVisibleSheet,n=e.colVisibleInfo,r=e.fromUndoRedo,a=e.local;t&&n&&(t.dispatch("ColumnVisibleChanged",n,DA(r,a)),delete e.colVisibleSheet,delete e.colVisibleInfo,delete e.fromUndoRedo,delete e.local)}}]),e}(),Hq=function(e){function t(){var e;return(0,y.Z)(this,t),(e=(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))).action="hideCol",e.visible=!1,e}return(0,g.Z)(t,e),t}(Uq);dq.registerAction(new Hq);var Wq=function(e){function t(){var e;return(0,y.Z)(this,t),(e=(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))).action="hideRow",e.visible=!1,e}return(0,g.Z)(t,e),t}(Bq);dq.registerAction(new Wq);var jq=function(){function e(){(0,y.Z)(this,e),this.action="localActiveView"}return(0,C.Z)(e,[{key:"execute",value:function(e,t,n){var r=Nq(e,e.filterModel);e.viewsModel.tryEntryViewById(t.value.view_id),r()}}]),e}();dq.registerAction(new jq);var zq=function(){function e(){(0,y.Z)(this,e),this.action="localDeactiveView"}return(0,C.Z)(e,[{key:"execute",value:function(e,t,n){var r=Nq(e,e.filterModel);e.viewsModel.tryExistView(),r()}}]),e}();dq.registerAction(new zq);var Gq=function(){function e(){(0,y.Z)(this,e),this.action="lockCol"}return(0,C.Z)(e,[{key:"execute",value:function(e,t,n){n.book=e.getParent();var r=t.target,a=t.value,o=r.col,i=r.colCount,u=a.perm_id,s=a.lock_info,l=a.creator_id;e.protectionModel.setProtection(u,{description:s,creatorId:l,ranges:[{col:o,colCount:i,type:we.xj7.COL}]})}}]),e}();dq.registerAction(new Gq);var Jq=function(){function e(){(0,y.Z)(this,e),this.action="lockRow"}return(0,C.Z)(e,[{key:"execute",value:function(e,t,n){n.book=e.getParent();var r=t.target,a=t.value,o=r.row,i=r.rowCount,u=a.perm_id,s=a.lock_info,l=a.creator_id;e.protectionModel.setProtection(u,{description:s,creatorId:l,ranges:[{row:o,rowCount:i,type:we.xj7.ROW}]})}}]),e}();dq.registerAction(new Jq);var qq,$q=function(){function e(){(0,y.Z)(this,e),this.action="lockSheet"}return(0,C.Z)(e,[{key:"execute",value:function(e,t,n){n.book=e;var r=e.permissionManager,a=t.value,o=t.sheet_id,i=a.perm_id,u=a.lock_info,s=a.creator_id,l=e.getSheetFromId(o);l&&r.setPerm(i,{permId:i,lockInfo:u,sheetId:l.id(),sheetName:l.name(),creatorId:s})}}]),e}();function Yq(e,t,n,r,a){if(!a){var o=t.toJSON(),i=o.row,u=o.col,s=o.rowCount,l=o.colCount,c=r.toJSON(),h=c.row,f=c.col,d=h-i,v=f-u,g=e!==n,m=t.intersect(r),y=e.getSparklineModel(),C=n.getSparklineModel();if(function(e,t,n,r,a,o){e.iterWithPos(t,n,r,a).forEach((function(t){var n=(0,p.Z)(t,2)[1];(null==o?void 0:o.containCell(n.row,n.col))||e.deleteSparklineByCell(n.row,n.col)}))}(C,h,f,s,l,m),m){var _=m.toJSON();Kq(y,C,n,_.row,_.col,_.rowCount,_.colCount,d,v,!1,null)}Kq(y,C,n,i,u,s,l,d,v,g,m)}}function Kq(e,t,n,r,a,o,i,u,s,l,c){e.iterWithPos(r,a,o,i).forEach((function(n){var r=(0,p.Z)(n,2),a=r[0],o=r[1];if(null==c||!c.containCell(o.row,o.col)){var i=a.getId(),l=a.getGroupId(),h=e.getSparklineGroupByGroupId(l),f=a.getPosition(),d={row:f.row+u,col:f.col+s};e.deleteSparklineById(i),t.get(d.row,d.col)&&t.deleteSparklineByCell(d.row,d.col),t.getSparklineGroupByGroupId(l)||t.addGroupById(l,null==h?void 0:h.getRawConfig()),a.updatePosition(d.row,d.col),t.addSparklineById(i,a)}}))}dq.registerAction(new $q),function(e){e[e.SingleValue=0]="SingleValue",e[e.MultipleValue=1]="MultipleValue"}(qq||(qq={}));var Xq,Qq=new Map;function e$(e){if(1&e&&4&e)throw new Error("不能同时对行进行两种冲突的操作。");if(2&e&&8&e)throw new Error("不能同时对列进行两种冲突的操作。")}!function(e){e[e.normal=0]="normal",e[e.ignoreRow=1]="ignoreRow",e[e.ignoreCol=2]="ignoreCol",e[e.skipRow=4]="skipRow",e[e.skipCol=8]="skipCol"}(Xq||(Xq={}));var t$=vr._Types._isNullOrUndefined;function n$(e){return e.getRowCount()}function r$(e){return e.getColumnCount()}function a$(e,t){return t._isRowFilterOut&&t._isRowFilterOut(e)}function o$(e){if(!e)return e;if("number"==typeof e||"string"==typeof e||"boolean"==typeof e||t$(e))return e;if(e.clone)return e.clone();if(e instanceof Date)return new Date(e);var t;for(var n in t=e instanceof Object?new e.constructor:new e.constructor(e.valueOf()),e)if(e.hasOwnProperty(n)){var r=e[n];e.hasOwnProperty(n)&&t[n]!==r&&(t[n]="object"==(0,_.Z)(r)?o$(r):r)}return t}function i$(e,t){if(e&&e.length>0){var n=e.toArray();return t?n.filter((function(t){return!e.isPivotSpan(t)})):n}return null}function u$(e,t,n,r,a,o,i,u,s,l,c){var h=new Set;l=l||i,c=c||u;for(var f=0;f<i;f++)for(var d=f%l,v=0;v<u;v++){var g=v%c,m=e.getVar(t+d,n+g,s);Wf(m)?h.add(m):e===r&&zf(m)&&m.getArrayRef().containCell(a+f,o+v)&&h.add(m.formula)}return h}function s$(e,t,n,r,a,o,i,u,s,l,c){var h=!(e===r&&e._name===r._name),f=e._getSpanModel(c),d=r._getSpanModel(c);h&&f&&d?(function(e,t,n,r,a,o,i,u,s,l){var c,h,f,d,v,g=arguments.length>10&&void 0!==arguments[10]?arguments[10]:{copyMoveMode:0},m=g.copyMoveMode,p=g.ignoredRows,y=i$(e,!0),C=i$(r),_=[],R=Boolean(4&m&&p),w=R?p.size:0,k=R?mh(p,s):[];function S(e){var t,n=_n(p);try{for(n.s();!(t=n.n()).done;){var r=t.value;if(r<=e)++e;else if(e<r&&r<=e+d-1);else if(e+d-1<r)break}}catch(e){n.e(e)}finally{n.f()}return e}if(y)for(var E=0;E<y.length;E++)if(c=y[E],h=c.rowFrom(),f=c.colFrom(),d=c.rowCount(),v=c.colCount(),!(d*v<=1||g$(l,h,f)))if(-1===t){if(n<=f&&f+v<=n+u){var T=h,A=o+f-n;R&&(T=S(T)),_.push(new Oi(T,A,d,v,s))}}else if(-1===n){if(t<=h&&h+d<=t+i){var I=a+h-t,b=f;R&&(I=S(I)),_.push(new Oi(I,b,d,v,s))}}else if(t<=h&&h<t+i&&n<=f&&f<n+u){var F=a+h-t,M=o+f-n;R&&(F=S(F)),_.push(new Oi(F,M,d,v,s))}if(C)for(var V=0;V<C.length;V++){c=C[V],h=c.rowFrom();var N=(f=c.colFrom())>=o&&f<o+u,O=h>=a&&h<a+i+w;if(-1===t?N:-1===n?O:O&&N)for(var x=function(e){var t=r[e];if(t.rowFrom()===h&&t.colFrom()===f&&k.every((function(e){return!e.contain(t)})))return r.removeSpan(e,1),"break"},Z=0;Z<r.length;Z++){if("break"===x(Z))break}}for(var D=0;r&&D<_.length;D++)r.addSpan(_[D])}(f,t,n,d,a,o,i,u,r,e,l),s&&f&&f.clear(t,n,i,u)):f&&(s?f.move(t,n,a,o,i,u,l):f.copy(t,n,a,o,i,u,l))}function l$(e,t,n,r,a,o,i,u,s,l){var c=t,h=n;c<0&&(c=0,i=Math.min(n$(e),n$(r))),a<0&&(a=0),h<0&&(h=0,u=Math.min(r$(e),r$(r))),o<0&&(o=0),t<0&&s$(e,-1,h,r,-1,o,-1,u,s,l,1),n<0&&s$(e,c,-1,r,a,-1,i,-1,s,l,2),s$(e,c,h,r,a,o,i,u,s,l)}function c$(e,t,n,r,a,o,i){t<0&&(t=0,a=Math.min(e.getColumnCount(),n.getColumnCount())),r<0&&(r=0);if((16&o)>0)for(var u=0;u<a;u++){var s=e._getActualColumnWidth(u+t);t$(s)||(i&&e.setColumnWidth(u+t,e.defaults.colWidth),n.setColumnWidth(u+r,s));var l=e.getColumnVisible(u+t);t$(l)||(i&&e.setColumnVisible(u+t,!0),n.setColumnVisible(u+r,l));var c=e.getActualStyle(-1,u+t);c?(n._setStyleWithoutLocked(-1,u+r,c.clone()),i&&e._setStyleWithoutLocked(-1,u+t,null)):n._setStyleWithoutLocked(-1,u+r,null),(c=e.getActualStyle(-1,u+t,1))?(n._setStyleWithoutLocked(-1,u+r,c.clone(),1),i&&e._setStyleWithoutLocked(-1,u+t,null,1)):n._setStyleWithoutLocked(-1,u+r,null,1);var h=e.getRowColProperty(u+t,"fId",!1);if(!t$(h)){var f={fId:h};i&&e.setRowColProperty(u+t,{fId:void 0},!1),n.setRowColProperty(u+r,f,!1)}}}function h$(e,t,n,r,a,o,i,u){var s=i.copyMoveMode,l=i.ignoredRows;t<0&&(t=0,a=Math.min(n$(e),n$(n))),r<0&&(r=0);for(var c=0,h=0;h<a;h++){var f=r+h+c;if(4&s)for(;l&&l.has(f);)f=r+h+ ++c;else if(1&s&&a$(f,n))continue;if((16&o)>0){var d=e._getActualRowHeight(h+t);t$(d)||(u&&e.setRowHeight(h+t,e.defaults.rowHeight),n.setRowHeight(f,d));var v=e.getRowVisible(h+t);t$(v)||(u&&e.setRowVisible(h+t,!0),v||n.setRowVisible(f,v));var g=e.getActualStyle(h+t,-1);g?(n._setStyleWithoutLocked(f,-1,g.clone()),u&&e._setStyleWithoutLocked(h+t,-1,null)):n._setStyleWithoutLocked(f,-1,null),(g=e.getActualStyle(h+t,-1,2))?(n._setStyleWithoutLocked(f,-1,g.clone(),2),u&&e._setStyleWithoutLocked(h+t,-1,null,2)):n._setStyleWithoutLocked(f,-1,null,2);var m=e.getRowColProperty(h+t,"fId",!0);if(!t$(m)){var p={fId:m};u&&e.setRowColProperty(h+t,{fId:void 0},!0),n.setRowColProperty(f,p,!0)}}}}function f$(e,t,n,r){if(e!==t||e._name!==t._name){if((16&n)>0){var a=e.getDefaultStyle();t.setDefaultStyle(r?a:a.clone()),a=e.getDefaultStyle(1),t.setDefaultStyle(r?a:a.clone(),1),a=e.getDefaultStyle(2),t.setDefaultStyle(r?a:a.clone(),2),r&&(e.setDefaultStyle(null),e.setDefaultStyle(null,1),e.setDefaultStyle(null,2))}var o=t.defaults,i=e.defaults;o.colWidth=i.colWidth,o.rowHeight=i.rowHeight,o.rowHeaderColWidth=i.rowHeaderColWidth}}function d$(e,t,n,r,a,o,i,u,s,l,c,h,f,d){var v,g,m,p=l.copyMoveMode,y=l.ignoredRows,C=Ck(e,t,n,i,u),_=!(e===r&&e._name===r._name),R=function(t,n){var r;return!d&&(g$(e,t,n)||C&&(null===(r=e.getPivotTableManager())||void 0===r?void 0:r.getPivotTableByCell(t,n)))};if(2==(2&s)&&t<0){var w=n,k=o;if(v=Math.min(n$(e),n$(r)),g=u,n<0&&(w=0,g=r$(e)),o<0&&(k=0),_)for(var S=0;S<v;S++)for(var E=0;E<g;E++)R(S,w+E)||h(r,S,k+E,o$(m=c(e,S,w+E,1)),1);else{Qq.clear();for(var T=0;T<v;T++)for(var A=0;A<g;A++)R(T,w+A)||(m=c(e,T,w+A,1),t$(m)||Qq.set("".concat(T,"_").concat(A),o$(m)));for(var I=0;I<v;I++)for(var b=0;b<g;b++)R(I,w+b)||h(r,I,k+b,Qq.get("".concat(I,"_").concat(b)),1)}}if(1==(1&s)&&n<0){var F=t,M=a;if(v=i,g=Math.min(r$(e),r$(r)),t<0&&(F=0,v=n$(e)),a<0&&(M=0),_)for(var V=0;V<v;V++)for(var N=0;N<g;N++)R(F+V,N)||h(r,M+V,N,o$(m=c(e,F+V,N,2)),2);else{Qq.clear();for(var O=0;O<v;O++)for(var x=0;x<g;x++)R(F+O,x)||(m=c(e,F+O,x,2),t$(m)||Qq.set("".concat(O,"_").concat(x),o$(m)));for(var Z=0;Z<v;Z++)for(var D=0;D<g;D++)h(r,M+Z,D,Qq.get("".concat(Z,"_").concat(D)),2)}}var P=t,L=n,B=a,U=o,H=i,W=u;if(t<0&&(P=0),n<0&&(L=0),a<0&&(B=0),o<0&&(U=0),_)for(var j=0,z=0;z<H;z++){var G=B+z+j;if(4&p)for(;y&&y.has(G);)G=B+z+ ++j;else if(1&p&&a$(G,r))continue;for(var J=0;J<W;J++)R(P+z,L+J)||h(r,G,U+J,o$(m=c(e,P+z,L+J,3,f)),3)}else{var q=0;Qq.clear();try{for(var $=0;$<H;$++)for(var Y=0;Y<W;Y++)R(P+$,L+Y)||(m=c(e,P+$,L+Y,3,f),t$(m)||Qq.set("".concat($,"_").concat(Y),o$(m)));for(var K=0;K<H;K++){var X=B+K+q;if(4&p)for(;y&&y.has(X);)X=B+K+ ++q;else if(1&p&&a$(X,r))continue;for(var Q=0;Q<W;Q++)R(P+K,L+Q)||h(r,X,U+Q,Qq.get("".concat(K,"_").concat(Q)),3)}}catch(e){we.Ps3.moirae.ravenCatch(e)}}}function v$(e,t,n,r,a,o,i,u,s){var l=arguments.length>9&&void 0!==arguments[9]&&arguments[9],c=arguments.length>10?arguments[10]:void 0,h=u$(e,t,n,r,a,o,i,u);function f(e,t,n,r,a){var o=e.getMultipleValues(t,n),i=e.getReminderJSON(t,n);if(o)return{type:1,multipleValues:o,reminderJSON:i};var u,c=e.getSegmentArray(t,n);16&s||!c||(c="string"==typeof(u=pp(c))?null:u);var f,d=(0,we.qdm)(c),v=null;if(l)v=c,!d&&v||(v=e.getValue(t,n,r,void 0,void 0,a));else if(e.hasFormula(t,n)){var g=e.getVar(t,n);f={ref:g.getRef()},v=wf(g,f,{refType:1})}else v=e.isProxyArrayFormula(t,n)&&h.has(e.getVar(t,n).formula)?null:c||e.getValue(t,n,r);return{type:0,value:v,ctx:f,reminderJSON:i}}function d(e,t,n,r){var a=_y(r.reminderJSON);switch(e._setReminder(t,n,a),r.type){case 0:var o=r.value,i=r.ctx;t$(o)?e.setValue(t,n,null):e.setValue(t,n,o,{ctx:i});break;case 1:e.setValue(t,n,r.multipleValues)}}d$(e,t,n,r,a,o,i,u,s,c,f,d)}function g$(e,t,n){var r,a=null===(r=e.getPivotTableManager())||void 0===r?void 0:r.getPivotTableNameByCell(t,n);return kS(e,a,"isCopy")}function m$(e,t,n,r,a,o,i,u,s,l,c){var h=new Oi(t,n,i,u,e),f=u$(e,t,n,r,a,o,i,u,!0);d$(e,t,n,r,a,o,i,u,s,c,(function(e,t,n,r,a){var o=e.getMultipleValues(t,n),i=e.getReminder(t,n),u=e._getModel(),s=g$(e,t,n),l={type:0,value:null,nodeVar:ut.NULL_VAR,reminder:null,clone:function(){return this}};if(o)l={type:1,multipleValues:o,reminder:i,clone:function(){return this}};else{var c=u.getVar(t,n,a),h=e.getSegmentArray(t,n,void 0,!0)||e.getValue(t,n,void 0,void 0,void 0,a);s||(l={type:0,value:h,nodeVar:c,reminder:i,clone:function(){return this}})}return s||(e.setValue(t,n,null),e._setReminder(t,n,null)),l}),(function(e,t,n,r){switch(e._setReminder(t,n,r.reminder),r.type){case 0:var a=r.value,o=r.nodeVar;if(o&&zf(o)&&f.has(o.formula)&&(a=null,o=ut.NULL_VAR),o&&o!==ut.NULL_VAR){var i=e._getModel(),u=Array.isArray(a)?a:null;u?i.setSegmentArray(t,n,u):i.setVar(t,n,o,{skipCompile:!0},null)}else e.setValue(t,n,a);break;case 1:e.setValue(t,n,r.multipleValues)}}),!0);var d=new ji(h,r,a,o);e.getParent().watchHubsOnRefOp(d)}function p$(e,t,n,r,a,o,i,u,s,l,c){d$(e,t,n,r,a,o,i,u,s,c,(function(e,t,n){var r,a=null;if(e.hasFormula(t,n)){var o=e.getVar(t,n);a="="+e.getCalcEngine().decompile(o,{refStyle:"R1C1",ref:o.getRef()}),r={refStyle:"R1C1"}}var i=e.getReminder(t,n);return l&&(e.setValue(t,n,null),e._setReminder(t,n,null)),{value:a,ctx:r,reminder:i}}),(function(e,t,n,r){var a=r.value,o=r.ctx,i=r.reminder;if(!t$(a)){if(l)e._setReminder(t,n,i);else{var u=_y(i?i.toJSON():null);e._setReminder(t,n,u)}e.setValue(t,n,a,{ctx:o})}}))}function y$(e,t,n,r,a,o,i,u,s,l,c){var h={};d$(e,t,n,r,a,o,i,u,s,c,(function(e,t,n,r){var a=(3===r||t$(r))&&h[t]&&h[t][n],o=e._getCompositeStyle(t,n,r,void 0,l,void 0,void 0,void 0,a);return l&&e._setStyleWithoutLocked(t,n,null,r),o}),(function(e,t,n,r,a){e._setStyleWithoutLocked(t,n,r,a)}),void 0,l)}function C$(e,t,n,r,a,o,i,u,s,l,c){d$(e,t,n,r,a,o,i,u,s,c,(function(e,t,n){var a=e.getDropdown(t,n),o={needDeepClone:!0};l&&(o.refSheet=r);var i=e.getDataValidationJSON(t,n,o);return l&&(e.setDataValidation(t,n,null),e.setDropdown(t,n,null)),{dataValidationJSON:i,dropdown:a}}),(function(e,t,n,r){var a=r.dropdown,o=r.dataValidationJSON,i=o?Ag(o,e):null;if(a&&e.setDropdown(t,n,a),i)e.setDataValidation(t,n,i);else{var u=e.getDataValidation(t,n);!u||!c.forceOverrideDataValidation&&bm(u)||e.setDataValidation(t,n,null)}}))}function _$(e,t,n,r){var a=R$(e,t);w$(e,t),w$(n,r),k$(n,r,a)}function R$(e,t){var n=t.toJSON(),r=n.row,a=n.col,o=n.rowCount,i=n.colCount,u=[];return e._getModel().iterNoteWithPos(r,a,o,i).forEach((function(e){if(e){var t=(0,p.Z)(e,2),n=t[0],o=t[1];n&&u.push([o.row-r,o.col-a,(0,Re.default)(n)])}})),u}function w$(e,t){var n=t.toJSON(),r=n.row,a=n.col,o=n.rowCount,i=n.colCount;e._getModel().clearCellNote(r,a,o,i)}function k$(e,t,n){var r=t.toJSON(),a=r.row,o=r.col;n.forEach((function(t){var n=(0,p.Z)(t,3),r=n[0],i=n[1],u=n[2];e._setCellNote(a+r,o+i,u)}))}var S$=function(){return{copyMoveMode:0}};function E$(e,t,n,r){var a=arguments.length>4&&void 0!==arguments[4]?arguments[4]:{copyMoveMode:0},o=arguments.length>5?arguments[5]:void 0,i=a.copyMoveMode,u=a.ignoredRows;e$(i);var s=e.sheet(),l=e.rowFrom(),c=e.colFrom(),h=t.sheet(),f=t.rowFrom(),d=t.colFrom(),v=e.rowCount(),g=e.colCount();if(!s||!h)return!1;if(T$(s,e,h,t),(16&n)>0&&y$(s,l,c,h,f,d,v,g,n,r,a),128&n&&C$(s,l,c,h,f,d,v,g,n,r,a),r){s.getCalcEngine().formulaSpace;m$(s,l,c,h,f,d,v,g,n,0,a)}else(1&n)>0?v$(s,l,c,h,f,d,v,g,n,!((2&n)>0),a):2&n&&p$(s,l,c,h,f,d,v,g,n,r,a);return(8&n)>0&&(r||1!==v||1!==g)&&l$(s,l,c,h,f,d,v,g,r,a),(64&n)>0&&(e instanceof xi?h$(s,l,h,f,v,n,a,r):e instanceof Vi&&c$(s,c,h,d,g,n,r)),l<0&&f<=0&&c<0&&d<=0&&f$(s,h,n,r),Rm(h,f,d,v+(Boolean(4&i)&&u?u.size:0),g),Yq(s,e,h,t,o),_$(s,e,h,t),!0}function T$(e,t,n,r){e.id()===n.id()&&function(e,t,n,r,a){var o=[];e.forEach((function(e){var t=function(e,t,n){console.log("--oldCommentItem--",e);var r=(0,Re.default)(e),a=t.toJSON(),o=a.row,i=a.col,u=n.toJSON(),s=u.row,l=u.col,c=s-o,h=l-i,f=e.col,d=e.row;return r.row=d+c,r.col=f+h,console.log("--newCommentItem--",r),r}(e,r,a);!function(e,t,n,r){var a=t.row,o=t.col,i=n.row,u=n.col,s=n.comments;r.find((function(e){return e.row===a&&e.col===o}))||e._setComments(a,o,null),e._setComments(i,u,s),r.push({row:i,col:u})}(n,e,t,o)})),t.forEach((function(e){!function(e,t,n){var r=t.row,a=t.col;n.find((function(e){return e.row===r&&e.col===a}))||e._setComments(r,a,null)}(n,e,o)}))}(A$(e,t),A$(e,r),e,t,r)}function A$(e,t){var n=t.toJSON(),r=n.row,a=n.col,o=n.rowCount,i=n.colCount,u=r+o,s=a+i;if(!e.getAllComments)return[];var l=e.getAllComments().filter((function(e){var t=e.row,n=e.col;return t>=r&&t<u&&n>=a&&n<s}));return(0,Re.default)(l)}var I$=Object.freeze({__proto__:null,get CopyMoveMode(){return Xq},getIgnoreArrayFmls:u$,copyProperty:d$,getNotesInRange:R$,setNotesInRange:k$,getDefaultCopyMoveOptions:S$,copyMoveRangeTo:E$});function b$(e,t){return e instanceof xi?function(e,t){var n=e.sheet();if(!n)return!1;for(var r=V$(e,t),a=r.srcRow,o=r.targetRow,i=r.rowCount,u=n._getModel(),s=n._getRowInfos(),l=0;l<i;l++)u.swapRow(a+l,o+l),s.swap(a+l,o+l);return n.onRowColChanged(o,2,o,a,"row"),F$(e,t,n),M$(e,t,n),!0}(e,t):e instanceof Vi&&function(e,t){var n=e.sheet();if(!n)return!1;for(var r=V$(e,t),a=r.srcColumn,o=r.targetColumn,i=r.columnCount,u=n._getModel(),s=n._getColInfos(),l=0;l<i;l++)u.swapCol(a+l,o+l),s.swap(a+l,o+l);return n.onRowColChanged(o,2,o,a,"col"),F$(e,t,n),M$(e,t,n),!0}(e,t)}function F$(e,t,n){var r=V$(e,t),a=r.srcRow,o=r.srcColumn,i=r.targetRow,u=r.targetColumn,s=r.rowCount,l=r.columnCount;n._getSpanModel().move(a,o,i,u,s,l)}function M$(e,t,n){var r=V$(e,t),a=r.srcRow,o=r.srcColumn,i=r.targetRow,u=r.targetColumn,s=r.rowCount,l=r.columnCount,c=new Oi(a,o,s,l,n),h=new ji(c,n,i,u);n.getParent().watchHubsOnRefOp(h)}function V$(e,t){return{srcRow:e.rowFrom(),srcColumn:e.colFrom(),targetRow:t.rowFrom(),targetColumn:t.colFrom(),rowCount:e.rowCount(),columnCount:e.colCount()}}var N$=function(){function e(){(0,y.Z)(this,e),this.action="moveRange"}return(0,C.Z)(e,[{key:"execute",value:function(e,t,n,r,a){var o;n.book=e;var i=t.value.source,u=t.value.target,s=t.value.type,l=e.getSheetFromId(i.sheetId),c=e.getSheetFromId(u.sheetId),h=Oi.fromJSON(i,t.value.type,l),f=Oi.fromJSON(u,t.value.type,c),d=null===(o=t.extra)||void 0===o?void 0:o.commandType,v="addCell"===d||"delCell"===d,g=v?Object.assign({},{copyMoveMode:0},{forceOverrideDataValidation:!0}):void 0,m=!1;try{m=function(e,t,n,r,a){if(e.rowCount()!==t.rowCount()||e.colCount()!==t.colCount())return!1;var o=e.sheet(),i=t.sheet();return o&&o===i&&i.inject(cE).actionEventBus$.next({type:"moveRange",sourceRange:e,targetRange:t}),n!==we.xj7.ROW&&n!==we.xj7.COL||!o||o!==i?E$(e,t,511,!0,r,a):b$(e,t)}(h,f,s,g,v)}catch(e){throw m=!0,e}finally{c&&m&&c.dispatch("MoveRange",{fromRange:h,toRange:f,toEdgeAdjust:v},DA(r,a))}}}]),e}();dq.registerAction(new N$);var O$=function(){function e(){(0,y.Z)(this,e),this.action="moveSheet"}return(0,C.Z)(e,[{key:"execute",value:function(e,t,n,r,a){n.book=e.getParent();var o=t.value,i=e.getParent();i._moveSheet(i.getSheetIndex(e.name()),Math.min(o.target,i.sheets.length-1),!1,DA(r,a))}}]),e}();dq.registerAction(new O$);var x$=function(){function e(){(0,y.Z)(this,e),this.action="restoreBlock"}return(0,C.Z)(e,[{key:"execute",value:function(e,t,n){n.book=e;var r=t.value;if(!r.block_token)throw new Error("block token is empty");var a=e.creatBlockWorksheet(r.sheet_id,r.sheet_name,r.block_type,r.block_id,r.block_token);e._addSheet(r.index,a)}}]),e}();dq.registerAction(new x$);var Z$=function(){function e(){(0,y.Z)(this,e),this.action="restoreSheet"}return(0,C.Z)(e,[{key:"execute",value:function(e,t,n){n.book=e;var r=e.getSheetFromId(t.sheet_id);r&&r.clearDelTime()}}]),e}();dq.registerAction(new Z$);var D$=new fA,P$=D$;function L$(e,t){for(var n=0;n<e.length;n++){var r=e[n];if(r.style){var a=D$.add(r.style),o=a.ref,i=a.id;t[i]=o,r.styleId=i,delete r.style}Array.isArray(r.texts)&&L$(r.texts,t)}return e}function B$(e){var t={};if(Array.isArray(e.value.value)&&L$(e.value.value,t),0!==Object.keys(t).length){var n=e.extra||{};n.styles=t,e.extra=n}return e}function U$(e,t){var n=e.extra;if(!n)return e;var r=n.styles;return r&&Object.keys(r).length&&e.value&&function(e,t,n){if(null!=t.styleId){var r=e[t.styleId];if(r)t.style=r;else{console.error("[Sheet Apply Error] Can not find styleJSON ref by styleId!!"),we.Ps3.collectSuiteEvent("sheet_action_style_ref_error_dev");var a=null==n?void 0:n.getParent();a&&a.logger.info("sheet_action_style_ref_error_dev")}delete t.styleId}Array.isArray(t.value)&&H$(e,t.value,n)}(r,e.value,t),e}function H$(e,t,n){for(var r=0;r<t.length;r++){var a=t[r],o=a.styleId;if(null!=o){var i=e[o];if(i)a.style=i;else{console.error("[Sheet Apply Error] Can not find styleJSON ref by styleId!!"),we.Ps3.collectSuiteEvent("sheet_action_style_ref_error_dev");var u=null==n?void 0:n.getParent();u&&u.logger.info("sheet_action_style_ref_error_dev")}}delete a.styleId,Array.isArray(a.texts)&&H$(e,a.texts,n)}return t}function W$(e,t,n,r){if(null!=r.multipleValues){var a=new dm(e.parent);return a.fromJSON(r.multipleValues),void e.setValue(t,n,a)}if(r.hasOwnProperty("value")){var o=r.value;Array.isArray(o)&&vp(o)&&(o=o.reduce((function(e,t){return e+t.text}),"")),r.formula||r.formulaData||e.setValue(t,n,o,{skipCompile:!0})}!function(e,t,n,r){r.formulaData?j$(e,t,n,r):r.formula&&("="!==r.formula[0]&&(r.formula="="+r.formula),e.setValue(t,n,r.formula))}(e,t,n,r)}function j$(e,t,n,r){if(r.hasOwnProperty("value")||!e.getMultipleValues(t,n)&&!e.getSegmentArray(t,n)){var a=e.parent.calcEngine.deserializeFormula(r.formulaData,new Oi(t,n,1,1,e)),o={formulaData:r.formulaData,skipCompile:!0};e.setValue(t,n,a,o)}}function z$(e,t,n,r){r.hasOwnProperty("note")&&e._setCellNote(t,n,r.note)}function G$(e,t,n,r){!function(e,t,n,r){if(r.hasOwnProperty("style")){if(r.style&&r.style.cellType&&"8"===r.style.cellType.typeName){var a=r.style.cellType.link,o=r.value;delete r.style.cellType,"string"==typeof o&&(r.value=[{type:"url",text:o||a,link:a}])}if(r.style){var i=Ad.fromJSON(e.parent.formatterService,r.style,e.getDefaultStyle());e.setStyle(t,n,i)}else e.setStyle(t,n,null),e.setDropdown(t,n,null)}}(e,t,n,r);var a=e.getSpan(t,n);return(!a||a.rowFrom()===t&&a.colFrom()===n)&&(W$(e,t,n,r),function(e,t,n,r){if(r.style&&r.style.dropdown&&!r.dataValidation){var a=Ag(mm(r.style.dropdown),e);e.setDataValidation(t,n,a)}else if(r.hasOwnProperty(ag)){var o=r.dataValidation;if(o){var i=Ag(o,e);e.setDataValidation(t,n,i)}else e.setDataValidation(t,n,null)}}(e,t,n,r),z$(e,t,n,r),J$(e,t,n,r),!0)}function J$(e,t,n,r){!function(e,t,n,r){if(r.hasOwnProperty("reminder")){var a=r.reminder;if(a){var o=new by(a.id);o.fromChangeset(a),e._setReminder(t,n,o)}else e._setReminder(t,n,null)}}(e,t,n,r)}function q$(e,t){var n,r,a=function(e,t){if(t.multipleValues){var n=new dm(e.parent);return n.fromJSON(t.multipleValues),n}if(t.hasOwnProperty("value")){var r=t.value;return Array.isArray(r)?vp(r)?r.reduce((function(e,t){return e+t.text}),""):new xv(e.parent,r):r}}(t,e);return!e.multipleValues&&e.formula&&(e.formula="="+e.formula),e.style&&(n=e.style.dropdown,delete e.style.dropdown),e.hasOwnProperty(ag)&&(r=e.dataValidation?Ag(e.dataValidation,t):null),{cellValue:a,dropdown:n,dataValidation:r}}var $$=function(){function e(){(0,y.Z)(this,e),this.action="setCell"}return(0,C.Z)(e,[{key:"execute",value:function(e,t,n){var r;if("dlpDeleteSensitiveFile"!==(null===(r=t.extra)||void 0===r?void 0:r.commandType)){U$(t,e);var a=t.target,o=t.value,i=a.row,u=a.col;n.setCellInfo||(n.setCellInfo={sheet:e,ranges:[],valueChangeCells:[]}),n.formulaCellMap||(n.formulaCellMap=new lv);var s,l=e.getParent(),c=0,h=G$(e,i,u,o);if(h&&(o.hasOwnProperty("value")||o.formulaData||o.multipleValues||o.formula)&&(c|=1,n.setCellInfo.valueChangeCells.push([i,u])),o.hasOwnProperty("style")&&(c|=2,s=e.getStyle(i,u).formatter),h&&o.hasOwnProperty("dataValidation")&&(c|=2),1&c&&n.formulaCellMap.delete(i,u),h&&(o.formulaData||o.formula)){var f=e.getVar(i,u);f!==ut.NULL_VAR&&ah(f)&&l&&n.formulaCellMap.set(i,u,l.calcEngine.formulaRefService.formulaRefPool.add({formula:f.formula,refMap:f.getRefMap()}))}if(2&c){var d=e.getStyle(i,u).formatter;d&&s&&d.equals(s)||!d&&!s||(c|=4)}for(var v=0;v<3;v++)if(1<<v&c){var g=n.setCellInfo.ranges[v];g?(g[0]=Math.min(g[0],i),g[1]=Math.min(g[1],u),g[2]=Math.max(g[2],i),g[3]=Math.max(g[3],u)):n.setCellInfo.ranges[v]=[i,u,i,u]}o.hasOwnProperty("note")&&e.dispatch("NoteChanged",{row:i,col:u,note:o.note})}}},{key:"needBatchDone",value:function(e,t){return"setCell"!==e.action||!!t.setCellInfo&&t.setCellInfo.sheet.id()!==e.sheet_id}},{key:"batchDone",value:function(e){if(e.setCellInfo){for(var t=e.setCellInfo.sheet,n=["RangeChanged","StyleChanged","FormatterChanged"],r=0,a=n.length;r<a;r++)if(e.setCellInfo.ranges[r]){var o=(0,p.Z)(e.setCellInfo.ranges[r],4),i=o[0],u=o[1],s=o[2],l=o[3],c={range:new Oi(i,u,s-i+1,l-u+1,t)};"RangeChanged"===n[r]&&(c.formulaCellMap=e.formulaCellMap,c.changedRanges=e.setCellInfo.valueChangeCells.map((function(e){return new ui(e[0],e[0]+1,e[1],e[1]+1,t.id())}))),t.dispatch(n[r],c)}delete e.setCellInfo,delete e.formulaCellMap}}}]),e}();dq.registerAction(new $$);var Y$=function(){function e(){(0,y.Z)(this,e),this.action="setChart"}return(0,C.Z)(e,[{key:"execute",value:function(e,t,n){n.book=e.getParent();var r=function(e){return{sheetId:e.sheet_id,chartId:e.value.chartId,blockSetting:Object.assign({},e.value.blockSetting,{row:e.target.row,col:e.target.col}),graphSetting:e.value.graphSetting}}(t);e._setChart(r.chartId,r,!0)}}]),e}();dq.registerAction(new Y$);var K$=function(){function e(){(0,y.Z)(this,e),this.action="setColProperty"}return(0,C.Z)(e,[{key:"execute",value:function(e,t,n){n.book=e.getParent();var r=t.target,a=t.value;return e.setRowColProperty(r.col,a,!1)}}]),e}();dq.registerAction(new K$);var X$=function(){function e(){(0,y.Z)(this,e),this.action="setColumnWidth"}return(0,C.Z)(e,[{key:"execute",value:function(e,t,n){var r=t.target,a=t.value,o=t.is_local,i=r.col,u=r.colCount;if("object"!=(0,_.Z)(a)){if(void 0===o&&e.localColumnWidthChanged(i,u))return!0;n.colSizeWorksheet=e,n.colSizeInfo||(n.colSizeInfo=[]);var s=e.setColumnWidth(i,a,3,o,u),l=s.oldValue,c=s.value;n.colSizeInfo.push({col:i,oldValue:l,newValue:c,count:r.colCount})}return!0}},{key:"needBatchDone",value:function(e,t){return!!t.colSizeWorksheet&&t.colSizeWorksheet.id()!==e.sheet_id}},{key:"batchDone",value:function(e){var t=e.colSizeWorksheet,n=e.colSizeInfo;t&&n&&(t.dispatch("ColumnSizeChanged",n),delete e.colSizeInfo,delete e.colSizeWorksheet)}}]),e}();dq.registerAction(new X$);var Q$=function(){function e(){(0,y.Z)(this,e),this.action="setConditionalFormat"}return(0,C.Z)(e,[{key:"execute",value:function(e,t,n){n.book=e.getParent();var r=t.value;e._setConditionalFormat(r.cfId,r)}}]),e}();dq.registerAction(new Q$);var eY=function(){function e(){(0,y.Z)(this,e),this.action="setFilter"}return(0,C.Z)(e,[{key:"execute",value:function(e,t,n){n.book=e.getParent();var r=t.target,a=t.value,o=t.recalc,i=kE(a),u=e.inject(SE);if(o)e.filterModel.recalc();else{var s=Nq(e,u);u.setRange(r),i&&u.setFilter(i.col,i,i.filteredRowsMap),s(),e.dispatch("FilterChanged")}}}]),e}();dq.registerAction(new eY);var tY=function(){function e(){(0,y.Z)(this,e),this.action="setFilterView"}return(0,C.Z)(e,[{key:"execute",value:function(e,t,n){n.book=e.getParent();var r=t.value,a=r.view_id,o=r.range,i=r.filter_value,u=e.viewsModel.getViewById(a);if(u){var s=u.getFilterModel(),l=Nq(e,s),c=r.calculate&&!(null!=i&&i.filteredRowsMap);if(o){if(s.setRange({row:o.row,col:o.col,rowCount:o.row_count,colCount:o.col_count},c),i){var h=kE(i);h&&s.setFilter(h.col,h,h.filteredRowsMap)}}else s.removeFilter();l()}else we.Ps3.moirae.ravenCatch("expected to get viewModel but get null")}}]),e}();dq.registerAction(new tY);var nY=function(){function e(){(0,y.Z)(this,e),this.action="setFloatBlock"}return(0,C.Z)(e,[{key:"execute",value:function(e,t,n){n.book=e.getParent();var r=function(e){return{sheetId:e.sheet_id,blockToken:e.value.blockToken,blockType:e.value.blockType,blockSetting:{x:e.value.x,y:e.value.y,row:e.value.row,col:e.value.col,width:e.value.width,height:e.value.height,zIndex:e.value.zIndex}}}(t);e._setFloatBlock(r.blockToken,r,!0)}}]),e}();dq.registerAction(new nY);var rY=function(){function e(){(0,y.Z)(this,e),this.action="delFloatBlock"}return(0,C.Z)(e,[{key:"execute",value:function(e,t,n){n.book=e.getParent(),e._delFloatBlock(t.value.blockToken)}}]),e}();dq.registerAction(new rY);var aY=function(){function e(){(0,y.Z)(this,e),this.action="setEmbeddedBlock"}return(0,C.Z)(e,[{key:"execute",value:function(e,t,n,r,a){n.book=e.getParent();var o=function(e){return{blockToken:e.value.blockToken,blockType:e.value.blockType,position:e.target,blockSetting:e.value.blockSetting}}(t);e._setEmbeddedBlock(o.blockToken,o,!0)&&e.dispatch("EmbeddedBlockChanged",{sheetId:e.id(),embeddedBlockChangeParams:{changeType:1,embeddedBlock:o,blockToken:o.blockToken}},DA(r,a))}}]),e}();dq.registerAction(new aY);var oY=function(){function e(){(0,y.Z)(this,e),this.action="delEmbeddedBlock"}return(0,C.Z)(e,[{key:"execute",value:function(e,t,n,r,a){n.book=e.getParent();var o=t.value.blockToken,i=e.embeddedBlocksModel.getBlock(o);e._delEmbeddedBlock(o),e.dispatch("EmbeddedBlockChanged",{sheetId:e.id(),embeddedBlockChangeParams:{changeType:2,embeddedBlock:i,blockToken:o}},DA(r,a))}}]),e}();dq.registerAction(new oY);var iY=function(){function e(){(0,y.Z)(this,e),this.action="setFloatImage"}return(0,C.Z)(e,[{key:"execute",value:function(e,t,n){n.book=e.getParent();var r=function(e){return{sheetId:e.sheet_id,floatImageId:e.value.floatImageId,floatImageSetting:Object.assign({},e.value.floatImageSetting,{row:e.target.row,col:e.target.col})}}(t);e._setFloatImage(r.floatImageId,r,!0)}}]),e}();dq.registerAction(new iY);var uY=function(){function e(){(0,y.Z)(this,e),this.action="setFormData"}return(0,C.Z)(e,[{key:"execute",value:function(e,t,n,r,a){n.book=e.getParent();for(var o=t.value,i=0,u=Object.keys(o);i<u.length;i++)for(var s=u[i],l=o[s],c=0,h=Object.keys(l);c<h.length;c++){var f=h[c],d=l[f],v=e.getRowByFId(s),g=e.getColByFId(f);null!=v&&null!=g&&(G$(e,v,g,d),e.dispatch("RangeChanged",{range:new Oi(v,g,1,1,e)},DA(r,a)))}}}]),e}();dq.registerAction(new uY);var sY=function(){function e(){(0,y.Z)(this,e),this.action="setFormula"}return(0,C.Z)(e,[{key:"execute",value:function(e,t,n){n.book=e.getParent();var r=t.target,a=t.value;if(r)return e.setValue(r.row,r.col,a)}}]),e}();dq.registerAction(new sY);var lY=function(){function e(){(0,y.Z)(this,e),this.action="setRange"}return(0,C.Z)(e,[{key:"execute",value:function(e,t,n,r,a){var o=e.getParent();n.book=o;var i=t.value,u=Oi.fromJSON(i.target,i.target.type,e),s=u.rowFrom(),l=u.rowCount(),c=u.colFrom(),h=u.colCount();delete i.target,n.setRangeInfo?(n.setRangeInfo.range=n.setRangeInfo.range.union(u),n.setRangeInfo.changedRanges.push(u)):n.setRangeInfo={range:u,changedRanges:[u],formulaCellMap:new lv,actionType:DA(r,a),sheet:e};var f,d,v=n.setRangeInfo.formulaCellMap,g=q$(i,e),m=g.cellValue,p=g.dropdown,y=g.dataValidation,C=y;if(i.style){p&&!y&&(C=Ag(mm(p),e));var _=i.style,R=Ad.fromJSON(e.parent.formatterService,_,e.getDefaultStyle());d=e._dataModel.getStyleDropdownModel().getStyleRefMgr().add(R).id}else null===i.style&&(d=null);if(void 0!==C){var w=e._dataModel.getDataValidationModel().getRefMgr();f=C?w.add(C).id:null}for(var k=s;k<s+l;k++)for(var S=c;S<c+h;S++){null===f?e.setDataValidation(k,S,null):"number"==typeof f&&e.setDataValidationById(k,S,f),void 0!==d&&(null===d?e.setStyle(k,S,null):e.setStyleById(k,S,d));var E=e.getSegmentArray(k,S);if(Array.isArray(E))if(i.hasOwnProperty("style")&&!i.hasOwnProperty("value")){var T=pp(E);e.setValue(k,S,T)}else if(i.hasOwnProperty("value")&&!i.hasOwnProperty("style")){var A=e.getStyle(k,S),I=e.getStyleWithoutPartialStyle(k,S);A.equals(I)||e.setStyle(k,S,A)}if((i.hasOwnProperty("value")||null!=i.multipleValues)&&(null==m?e.setValue(k,S,null,{skipCompile:!0}):m instanceof xv?e.setValue(k,S,m.getSegmentArray(),{skipCompile:!0}):e.setValue(k,S,m,{skipCompile:!0})),!i.multipleValues){i.formulaData?j$(e,k,S,i):i.formula&&e.setValue(k,S,i.formula);var b=e.getVar(k,S);v.delete(k,S),b!==ut.NULL_VAR&&ah(b)&&o&&v.set(k,S,o.calcEngine.formulaRefService.formulaRefPool.add({formula:b.formula,refMap:b.getRefMap()}))}z$(e,k,S,i),J$(e,k,S,i)}}},{key:"needBatchDone",value:function(e,t){return"setRange"!==e.action||!!t.setRangeInfo&&t.setRangeInfo.sheet.id()!==e.sheet_id}},{key:"batchDone",value:function(e){e.setRangeInfo&&(e.setRangeInfo.sheet.dispatch("RangeChanged",{range:e.setRangeInfo.range,changedRanges:e.setRangeInfo.changedRanges,formulaCellMap:e.setRangeInfo.formulaCellMap},e.setRangeInfo.actionType),delete e.setRangeInfo)}}]),e}();dq.registerAction(new lY);var cY=function(){function e(){(0,y.Z)(this,e),this.action="setRowHeight"}return(0,C.Z)(e,[{key:"execute",value:function(e,t,n){var r=t.target,a=t.value,o=t.is_local,i=r.row,u=r.rowCount;if("object"!=(0,_.Z)(a)){if(void 0===o&&e.localRowHeightChanged(i,u))return!0;n.rowSizeWorksheet=e,n.rowSizeInfo||(n.rowSizeInfo=[]);var s=e.setRowHeight(r.row,a,3,o,u),l=s.oldValue,c=s.value;n.rowSizeInfo.push({row:r.row,oldValue:l,newValue:c,count:r.rowCount})}return!0}},{key:"needBatchDone",value:function(e,t){return!!t.rowSizeWorksheet&&t.rowSizeWorksheet.id()!==e.sheet_id}},{key:"batchDone",value:function(e){var t=e.rowSizeWorksheet,n=e.rowSizeInfo;t&&n&&(t.dispatch("RowSizeChanged",n),delete e.rowSizeInfo,delete e.rowSizeWorksheet)}}]),e}();dq.registerAction(new cY);var hY=function(){function e(){(0,y.Z)(this,e),this.action="setRowProperty"}return(0,C.Z)(e,[{key:"execute",value:function(e,t,n){n.book=e.getParent();var r=t.target,a=t.value;return e.setRowColProperty(r.row,a,!0)}}]),e}();dq.registerAction(new hY);var fY=function(){function e(){(0,y.Z)(this,e),this.action="setSheet"}return(0,C.Z)(e,[{key:"execute",value:function(e,t,n){n.book=e.getParent();var r=t.value;if(e)switch(r.property_name){case"visibility":!function(e,t){var n=t.value;if(e&&(n.sheet_name&&e.name(n.sheet_name),"boolean"==typeof n.hidden)){var r=e.parent,a=e.name();e.setHidden(n.hidden),e.name(n.sheet_name),r._hideSheet&&r._hideSheet(r.getSheetIndex(a))}}(e,t);break;case"gridLine":!function(e,t){var n=t.value;if(e){var r=e.inject(AE);"boolean"==typeof n.grid_line_hidden&&r.setGridLine(n.grid_line_hidden)}}(e,t);break;case"tabColor":!function(e,t){var n=t.value;if(e){var r=e.inject(IE);"string"==typeof n.tab_color&&r.setTabColor(n.tab_color)}}(e,t);break;case"tabType":!function(e,t){var n=t.value;if(e){var r=e.inject(cA);"number"==typeof n.tab_type&&r.setTabType(n.tab_type)}}(e,t);break;default:!function(e,t){var n=t.value;e&&(n.sheet_name&&e.name(n.sheet_name),"boolean"==typeof n.hidden&&e.setHidden(n.hidden))}(e,t)}}}]),e}();dq.registerAction(new fY);var dY=function(){function e(){(0,y.Z)(this,e),this.action="setSpans"}return(0,C.Z)(e,[{key:"execute",value:function(e,t,n,r,a){n.book=e.getParent();var o=t.target,i=t.value,u=void 0===i?[]:i;if(Array.isArray(u)){var s,l=new Oi(o.row,o.col,o.rowCount,o.colCount,e),c=e.clearSpans(l),h=[],f=_n(u);try{for(f.s();!(s=f.n()).done;){var d=s.value.target,v=d.row,g=d.rowCount,m=d.col,p=d.colCount;e.addSpan(v,m,g,p);for(var y=e.getCellStyle(v,m),C=e.getReminder(v,m),_=v;_<v+g;_++)for(var R=m;R<m+p;R++)_===v&&R===m||(e.setStyle(_,R,y),e._getModel().removeDropdown(_,R),e.setDataValidation(_,R,null),e.setValue(_,R,null),e._setReminder(_,R,null),e._setCellNote(_,R,null));C&&e._setReminder(v,m,C),g>1&&h.push(new Oi(v+1,m,g-1,1,e)),p>1&&h.push(new Oi(v,m+1,g,p-1,e))}}catch(e){f.e(e)}finally{f.f()}return(c||u.length)&&e.dispatch("RangeChanged",{range:l,changedRanges:h},DA(r,a)),e.dispatch("SpanChanged",l),u}}}]),e}();dq.registerAction(new dY);var vY=function(){function e(){(0,y.Z)(this,e),this.action="setStyle"}return(0,C.Z)(e,[{key:"execute",value:function(e,t,n){n.book=e.getParent();var r=t.target,a=t.value;if(a&&a.dropdown){var o=a.dropdown;e.setDropdown(r.row,r.col,Ev.fromJSON(o)),delete a.dropdown}var i=e.getDefaultStyle().clone();return i.fromJSON(e.parent,a),e.setStyle(r.row,r.col,i)}}]),e}();dq.registerAction(new vY);var gY=function(){function e(){(0,y.Z)(this,e),this.action="setValue"}return(0,C.Z)(e,[{key:"execute",value:function(e,t,n,r,a){n.book=e.getParent();var o=t.target,i=t.value;e.setValue(o.row,o.col,i),e.dispatch("RangeChanged",{range:new Oi(o.row,o.col,1,1,e)},DA(r,a))}}]),e}();dq.registerAction(new gY);var mY=function(){function e(){(0,y.Z)(this,e),this.action="setView"}return(0,C.Z)(e,[{key:"execute",value:function(e,t,n){n.book=e.getParent();var r=t.value,a=r.view_id,o=r.name,i=e.viewsModel.getViewById(a);i&&i.setName(o)}}]),e}();dq.registerAction(new mY);var pY=function(){function e(){(0,y.Z)(this,e),this.action="softDelSheet"}return(0,C.Z)(e,[{key:"execute",value:function(e,t,n){n.book=e;var r=e.getSheetFromId(t.sheet_id);r&&r.setDelTime(t.value.del_time)}}]),e}();dq.registerAction(new pY);var yY=function(){function e(){(0,y.Z)(this,e),this.action="sort"}return(0,C.Z)(e,[{key:"execute",value:function(e,t,n,r,a){n.book=e.getParent();var o=t.target,i=t.value,u=o.row,s=o.col,l=o.rowCount,c=o.colCount;if(i&&o){var h,f,d;e.suspendEvent();try{e.iterSortedRangeToSwapNode(u,l,s,c,i,!0);var v=s+c,g=e.iterSortedRangeToUpdateFormula(s,v,u,i,!0,e.id()),m=(0,p.Z)(g,2);d=m[0],f=m[1]}catch(e){we.Ps3.moirae&&we.Ps3.moirae.ravenCatch(e),h=e}finally{e.resumeEvent();var y=new Oi(o.row,o.col,o.rowCount,o.colCount,e);e.dispatch("Sort",{changedRanges:d,formulaCellMap:f,range:y},DA(r,a))}if(h)throw h}}}]),e}();dq.registerAction(new yY);var CY=function(e){function t(){var e;return(0,y.Z)(this,t),(e=(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))).action="unhideCol",e.visible=!0,e}return(0,g.Z)(t,e),t}(Uq);dq.registerAction(new CY);var _Y=function(e){function t(){var e;return(0,y.Z)(this,t),(e=(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))).action="unhideRow",e.visible=!0,e}return(0,g.Z)(t,e),t}(Bq);dq.registerAction(new _Y);var RY=function(){function e(){(0,y.Z)(this,e),this.action="unlockCol"}return(0,C.Z)(e,[{key:"execute",value:function(e,t,n){n.book=e.getParent();var r=t.value.perm_id;e.protectionModel.delProtection(r)}}]),e}();dq.registerAction(new RY);var wY=function(){function e(){(0,y.Z)(this,e),this.action="unlockRow"}return(0,C.Z)(e,[{key:"execute",value:function(e,t,n){n.book=e.getParent();var r=t.value.perm_id;e.protectionModel.delProtection(r)}}]),e}();dq.registerAction(new wY);var kY=function(){function e(){(0,y.Z)(this,e),this.action="unlockSheet"}return(0,C.Z)(e,[{key:"execute",value:function(e,t,n){n.book=e;var r=e.permissionManager,a=t.value.perm_id;r.removePerm(a)}}]),e}();dq.registerAction(new kY);var SY=function(){function e(){(0,y.Z)(this,e),this.action="updateRange"}return(0,C.Z)(e,[{key:"execute",value:function(e,t,n,r,a){n.book=e.getParent();var o=t.value,i=Oi.fromJSON(o.target,o.target.type,e),u=i.rowFrom(),s=i.rowCount(),l=i.colFrom(),c=i.colCount();delete o.target;for(var h=q$(o,e),f=h.cellValue,d=h.dropdown,v=h.dataValidation,g=function(t,n,r){r?r instanceof xv?e.setValue(t,n,r.getSegmentArray(),{skipCompile:!0}):e.setValue(t,n,r,{skipCompile:!0}):e.setValue(t,n,null,{skipCompile:!0})},m=new Map,p=!1,y=!1,C=[],_=[],R=u;R<u+s;R++){for(var w=l;w<l+c;w++){var k=!1,S=!1,E=f,T=e.getCellStyle(R,w,void 0,!0),A=T,I=!0,b=o,F=e.getSegmentArray(R,w);if(b.style){if(d&&null==v){var M=Ag(mm(d),e);e.setDataValidation(R,w,M)}if(Array.isArray(F)&&F.length){var V=mp(F,A,e,b.style),N=V.value,O=V.style;V.hasChanged&&(S=!0,E=Array.isArray(N)?new xv(e.parent,N):N,A=O)}else{var x=m.get(A);if("number"!=typeof x){var Z=e._dataModel.getStyleDropdownModel().getStyleRefMgr(),D=e.getDefaultStyle(),P=Ad.withUpdateStyle(A||D.clone(),b.style,e.formatterService);x=P.equals(D)?-1:Z.add(P).id,m.set(A,x)}-1!==x?e.setStyleById(R,w,x):e.setStyle(R,w,null),I=!1}}else if(null===b.style){if(A=null,Array.isArray(F)&&F.length){S=!0;var L=pp(F);E=Array.isArray(L)?new xv(e.parent,L):L}e.setDropdown(R,w,null)}if((b.hasOwnProperty("value")||b.multipleValues)&&(g(R,w,f),S=!1,k=!0,y=!0),S&&(g(R,w,E),k=!0),!I||null!==A&&null!=T&&T.equals(A)||e.setStyle(R,w,A),(v||null===v&&!d)&&e.setDataValidation(R,w,v),z$(e,R,w,o),J$(e,R,w,o),null===b.style&&null!=T&&T.formatter&&(p=!0),k){var B=_[_.length-1];B&&w===B.endCol?B.endCol++:_.push(new ui(R,R+1,w,w+1,e.id()))}}for(var U=_.length-1,H=1;U>=0;U--,H++){var W=_[U],j=C[C.length-H];if(!j||j.startCol!==W.startCol||j.endCol!==W.endCol||j.endRow!==W.startRow){for(var z=0;z<=U;z++)C.push(_[z]);break}po(j,W)}_=[]}if((p||o.style&&o.style.hasOwnProperty("formatter"))&&e.dispatch("FormatterChanged",{range:i},DA(r,a)),e.dispatch("StyleChanged",{range:i},DA(r,a)),C.length){var G=y?void 0:1;e.dispatch("RangeChanged",{range:i,changedRanges:C,type:G},DA(r,a))}}}]),e}();dq.registerAction(new SY);var EY=function(){function e(){(0,y.Z)(this,e),this.action="updateReference"}return(0,C.Z)(e,[{key:"execute",value:function(e,t,n){n.book=e.getParent();var r=t.value,a=r.type,o=r.oldRef,i=r.newRef,u=e._getModel().updateReference(a,o,i);u&&e.dispatch("DataValidationRefChanged",u)}}]),e}();dq.registerAction(new EY);var TY=function(){function e(){(0,y.Z)(this,e),this.action="setDataRange"}return(0,C.Z)(e,[{key:"execute",value:function(e,t,n){n.book=e.getParent();var r=AY(t);e._setDataRange(r)}}]),e}(),AY=function(e){var t=e,n=t.sheet_id,r=t.value,a=r.range_id,o=r.usage_type,i=r.create_time;switch(e.target.type){case 3:return{sheetId:n,rangeId:a,type:we.xj7.ALL,usageType:o,createTime:i};case 1:return e=e,{sheetId:n,rangeId:a,type:we.xj7.ROW,row:e.target.row,rowCount:e.target.rowCount,usageType:o,createTime:i};case 2:return e=e,{sheetId:n,rangeId:a,type:we.xj7.COL,col:e.target.col,colCount:e.target.colCount,usageType:o,createTime:i};default:return e=e,{sheetId:n,rangeId:a,type:we.xj7.NORMAL,row:e.target.row,col:e.target.col,rowCount:e.target.rowCount,colCount:e.target.colCount,usageType:o,createTime:i}}};dq.registerAction(new TY);var IY=function(){function e(){(0,y.Z)(this,e),this.action="delDataRange"}return(0,C.Z)(e,[{key:"execute",value:function(e,t,n){n.book=e.getParent(),e._delDataRange(t.value.range_id)}}]),e}();dq.registerAction(new IY);var bY=function(){function e(){(0,y.Z)(this,e),this.action="moveConditionalFormat"}return(0,C.Z)(e,[{key:"execute",value:function(e,t,n){n.book=e.getParent();var r=t.value;e._moveConditionalFormat(r)}}]),e}();dq.registerAction(new bY);var FY=we.TcH,MY=function(){function e(){(0,y.Z)(this,e),this.action="setRangeValues"}return(0,C.Z)(e,[{key:"execute",value:function(e,t,n){n.book=e.getParent();var r=t.value,a=t.target,o=a.row+a.rowCount-1,i=a.col+a.colCount-1,u=e.getParent().calcEngine;n.setRangeValuesInfo||(n.setRangeValuesInfo={eventNotifyRanges:[],changedRanges:[],formulaCellMap:new lv,sheet:e});for(var s=n.setRangeValuesInfo.formulaCellMap,l=n.setRangeValuesInfo.eventNotifyRanges,c=n.setRangeValuesInfo.changedRanges,h=r.style?fA.deserialize(r.style):{},f={},d={},v=[],g=[],m=e._dataModel.getStyleDropdownModel().getStyleRefMgr(),p=e._dataModel.getDataValidationModel().getRefMgr(),y=r.value,C=0,_=[],R=a.row;R<=o;R++){for(var w=a.col;w<=i;w++,C++){var k=y[C];if(Array.isArray(k)){var S=void 0,E=!1,T=!1,A=!1,I=!1,b=k[FY.CHANGED_FLAG];if(OY(FY.STYLE_INDEX,b)){E=!0;var F=k[FY.STYLE_INDEX];if("number"==typeof F){var M;S=null===(M=e.getCellStyle(R,w))||void 0===M?void 0:M.formatter;var V=h[F];if(V){if(void 0===f[F]){var N=Ad.fromJSON(e.parent.formatterService,V,e.getDefaultStyle());f[F]=m.add(N).id}e.setStyleById(R,w,f[F])}else e.setStyle(R,w,null)}else e.setStyle(R,w,null)}var O=k[FY.MULTIPLE_VALUE_INDEX];if(OY(FY.MULTIPLE_VALUE_INDEX,b)&&Array.isArray(O)&&r.multipleValues){T=!0,s.delete(R,w);var x=O.map((function(e){return r.multipleValues[e]})),Z=new dm(e.parent);Z.fromJSON(x),e.setValue(R,w,Z)}else if(OY(FY.CELL_VALUE,b)){T=!0,s.delete(R,w);var D=k[FY.CELL_VALUE];Array.isArray(D)&&(D.forEach((function(e){return VY(h,e)})),vp(D)&&(D=D.reduce((function(e,t){return e+t.text}),"")));var P=k[FY.FORMULADATA_INDEX];if(OY(FY.FORMULADATA_INDEX,b)&&"number"==typeof P&&r.formulaData){var L=r.formulaData[P];if(L){var B=new Oi(R,w,1,1,e),U=void 0;if(void 0!==v[P]){var H=v[P],W={root:H.getRoot(),formula:H.formula,refMap:H.getRefMap(),isArrayFormula:Wf(H)};U=u.createFormula(B,W);var j=H.getAlwaysCalcInfo();j&&U.setAlwaysCalcInfo(j)}else U=u.deserializeFormula(L,B),v[P]=U,g[P]=u.formulaRefService.formulaRefPool.add({formula:U.formula,refMap:U.getRefMap()});e.setValue(R,w,U,{formulaData:L,skipCompile:!0}),ah(e.getVar(R,w))&&s.set(R,w,g[P])}}else e.setValue(R,w,D,{skipCompile:!0})}if(OY(FY.DATAVALIDATION_INDEX,b)){E=!0;var z=k[FY.DATAVALIDATION_INDEX];if("number"==typeof z&&r.dataValidation){var G=r.dataValidation[z];if(G&&void 0===d[z]){var J=Ag(G,e);d[z]=J?p.add(J).id:null}G&&null!==d[z]?e.setDataValidationById(R,w,d[z]):e.setDataValidation(R,w,null)}else e.setDataValidation(R,w,null)}var q=k[FY.REMINDER];if(OY(FY.REMINDER,b))if(q){var $=new by(q.id);$.fromChangeset(q),e._setReminder(R,w,$)}else e._setReminder(R,w,null);var Y=k[FY.NOTE];if(OY(FY.NOTE,b)&&(I=!0,e._setCellNote(R,w,Y)),E){var K,X=null===(K=e.getCellStyle(R,w))||void 0===K?void 0:K.formatter;X&&S&&X.equals(S)||!X&&!S||(A=!0)}if(ZY(l,{cellValueChanged:T,styleChanged:E,formatterChanged:A,noteChanged:I},R,w),!T)continue;var Q=_[_.length-1];Q&&w===Q.endCol?Q.endCol++:_.push(new ui(R,R+1,w,w+1,e.id()))}}for(var ee=_.length-1,te=1;ee>=0;ee--,te++){var ne=_[ee],re=c[c.length-te];if(!re||re.startCol!==ne.startCol||re.endCol!==ne.endCol||re.endRow!==ne.startRow){for(var ae=0;ae<=ee;ae++)c.push(_[ae]);break}po(re,ne)}_=[]}}},{key:"needBatchDone",value:function(e,t){return"setRangeValues"!==e.action||!!t.setRangeValuesInfo&&t.setRangeValuesInfo.sheet.id()!==e.sheet_id}},{key:"batchDone",value:function(e){if(e.setRangeValuesInfo){var t=e.setRangeValuesInfo.sheet;(function(e,t,n){for(var r=["RangeChanged","StyleChanged","FormatterChanged","NoteChanged"],a=0,o=r.length;a<o;a++)if(e[a]){var i=(0,p.Z)(e[a],4),u=i[0],s=i[1],l=i[2],c=i[3],h={range:new Oi(u,s,l-u+1,c-s+1,t)};n[r[a]]&&Object.assign(h,n[r[a]]),t.dispatch(r[a],h)}})(e.setRangeValuesInfo.eventNotifyRanges,t,{RangeChanged:{formulaCellMap:e.setRangeValuesInfo.formulaCellMap,changedRanges:e.setRangeValuesInfo.changedRanges}}),delete e.setRangeValuesInfo}}}]),e}();function VY(e,t){if("number"==typeof t.styleId){var n=e[t.styleId];n&&(t.style=n),delete t.styleId}Array.isArray(t.texts)&&t.texts.forEach((function(t){return VY(e,t)}))}dq.registerAction(new MY);var NY=(rt={},(0,l.Z)(rt,FY.CELL_VALUE,1),(0,l.Z)(rt,FY.STYLE_INDEX,2),(0,l.Z)(rt,FY.FORMULADATA_INDEX,4),(0,l.Z)(rt,FY.DATAVALIDATION_INDEX,8),(0,l.Z)(rt,FY.MULTIPLE_VALUE_INDEX,16),(0,l.Z)(rt,FY.REMINDER,32),(0,l.Z)(rt,FY.NOTE,512),rt);function OY(e,t){return Boolean((NY[e]||1<<e-1)&t)}function xY(e,t){var n=NY[e];return n&&n&t?n^t:t}function ZY(e,t,n,r){for(var a=[t.cellValueChanged,t.styleChanged,t.formatterChanged,t.noteChanged],o=0;o<a.length;o++)if(a[o]){var i=e[o];i?(i[0]=Math.min(i[0],n),i[1]=Math.min(i[1],r),i[2]=Math.max(i[2],n),i[3]=Math.max(i[3],r)):e[o]=[n,r,n,r]}}function DY(e){var t=ya(e);return!t||t.type!==we.xj7.ROW&&t.type!==we.xj7.COL?null:(void 0!==t.row_count&&(t.rowCount=t.row_count,delete t.row_count),void 0!==t.col_count&&(t.colCount=t.col_count,delete t.col_count),t)}var PY=function(){function e(){(0,y.Z)(this,e),this.action="addOutline"}return(0,C.Z)(e,[{key:"execute",value:function(e,t){var n=t.value.state,r=t.target,a=e.outlineGroupModel,o=DY(r);o&&a.addRange(o,n)}}]),e}();dq.registerAction(new PY);var LY=function(){function e(){(0,y.Z)(this,e),this.action="updateOutline"}return(0,C.Z)(e,[{key:"execute",value:function(e,t){var n=t.value.state,r=t.target,a=e.outlineGroupModel,o=DY(r);if(o){a.updateOutline(o,n);var i=o.type===we.xj7.ROW?new xi(o.row,o.rowCount,e):new Vi(o.col,o.colCount,e);e.dispatch("OutlineStateChanged",{range:i,state:n})}}}]),e}();dq.registerAction(new LY);var BY=function(){function e(){(0,y.Z)(this,e),this.action="delOutline"}return(0,C.Z)(e,[{key:"execute",value:function(e,t,n,r,a){var o=t.target,i=e.outlineGroupModel,u=DY(o);if(u){i.cancelRange(u);var s=u.type===we.xj7.ROW?new xi(u.row,u.rowCount,e):new Vi(u.col,u.colCount,e);e.dispatch("OutlineStateChanged",{range:s},DA(r,a))}}}]),e}();dq.registerAction(new BY);var UY=function(){function e(){(0,y.Z)(this,e),this.action="addSparklineGroup"}return(0,C.Z)(e,[{key:"execute",value:function(e,t,n){n.book=e.getParent(),function(e,t){var n=e.getSparklineModel();if(t)for(var r=0,a=Object.entries(t.value);r<a.length;r++){var o=(0,p.Z)(a[r],2),i=o[0],u=o[1],s=null==u?void 0:u.config;n.addGroupById(i,s);var l=(u||{}).sparklines;if(l)for(var c=0,h=Object.entries(l);c<h.length;c++){var f=(0,p.Z)(h[c],2),d=f[0],v=f[1];if(n.getSparklineById(d))n.setSparklineById(d,i);else{var g=v||{},m=g.source,y=g.position;if(!m||!y)continue;n.createSparkline(m,y,d,i)}}}}(e,t),e.dispatch("SparklineAddActionApply",{sheetId:e.id()})}}]),e}();dq.registerAction(new UY);var HY=function(){function e(){(0,y.Z)(this,e),this.action="updateSparklineGroup"}return(0,C.Z)(e,[{key:"execute",value:function(e,t,n){n.book=e.getParent(),function(e,t){var n=e.getSparklineModel();if(t)for(var r=0,a=Object.entries(t.value);r<a.length;r++){var o=(0,p.Z)(a[r],2),i=o[0],u=o[1];if(u){var s=u.config||{};if(i){n.getSparklineGroupByGroupId(i)?Object.keys(s).length&&n.updateGroupConfig(i,s):n.addGroupById(i,s);var l=u.sparklines;if(l)for(var c=0,h=Object.entries(l);c<h.length;c++){var f=(0,p.Z)(h[c],2),d=f[0],v=f[1];if(null===v)n.deleteSparklineById(d);else{var g=v||{},m=g.source,y=g.position;if(n.getSparklineById(d))n.setSparklineById(d,i,y,m);else{if(!m||!y)continue;n.createSparkline(m,y,d,i)}}}}}}}(e,t),e.dispatch("SparklineUpdateActionApply",{sheetId:e.id()})}}]),e}();dq.registerAction(new HY);var WY=function(){function e(){(0,y.Z)(this,e),this.action="delSparklineGroup"}return(0,C.Z)(e,[{key:"execute",value:function(e,t,n){n.book=e.getParent(),function(e,t){var n=e.getSparklineModel();(null==t?void 0:t.value)&&Array.isArray(t.value)&&t.value.forEach((function(e){n.deleteGroupById(e)}))}(e,t),e.dispatch("SparklineDeleteActionApply",{sheetId:e.id()})}}]),e}();dq.registerAction(new WY);var jY=function(){function e(){(0,y.Z)(this,e),this.action="setRangeProtection"}return(0,C.Z)(e,[{key:"execute",value:function(e,t,n){n.book=e.getParent();var r=t.value;e.protectionModel.setProtection(r.id,{creatorId:r.creator_id,description:r.description,ranges:r.ranges.map((function(e){switch(e.type){case we.xj7.COL:return{col:e.col,colCount:e.col_count,type:e.type};case we.xj7.ROW:return{row:e.row,rowCount:e.row_count,type:e.type};case we.xj7.NORMAL:return{row:e.row,rowCount:e.row_count,col:e.col,colCount:e.col_count,type:e.type};default:throw new Error("Unsupported protection range type ".concat(JSON.stringify(e)," in ").concat(r.id))}}))})}}]),e}();dq.registerAction(new jY);var zY=function(){function e(){(0,y.Z)(this,e),this.action="delRangeProtection"}return(0,C.Z)(e,[{key:"execute",value:function(e,t,n){n.book=e.getParent(),e.protectionModel.delProtection(t.value.id)}}]),e}();dq.registerAction(new zY);var GY=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"taskLength",value:function(){return this._tasks.length}}]),t}(Rt.FIdleScheduler),JY=function(){function e(t,n){(0,y.Z)(this,e),this._sheet=t,this._meta=n,this._cache=new Map,this._formula2id=new Map,this._id2formula=new Map,this._cachedFormula=new Set,this._dirtyFormula=new Set,this._maxFormulaId=0,this._hasDirtyFormula=!0,n&&this.setMeta(n)}return(0,C.Z)(e,[{key:"setMeta",value:function(e){this._maxFormulaId=e.maxFormulaId,this._hasDirtyFormula=e.hasDirtyFormula}},{key:"applyFormulaCache",value:function(e,t){for(var n=this,r=0;r<e.length;++r)e[r].forEach((function(e){var r=n._id2formula.get(e);r&&n.setFormulaCache(r,e,t)}));this._sheet.parent.dispatch("FormulaCacheApplied",this._dirtyFormula),this._dirtyFormula.clear()}},{key:"loadFormulaCacheBlock",value:function(e,t){var n=0,r=new Set;for(var a in e){var o,i=void 0,u=void 0,s=a.split("_");if(s.length>1){if(!t)continue;i=a,u=Number(s[0])}else u=i=Number(a),null==e[a].p&&n++;if(null===(o=this._id2formula.get(u))||void 0===o||!o.ignoreApplyCache){r.add(u);var l=e[a];if(!t){l={p:{s:this._sheet._id_,r:we.Dcv,c:we.Dcv}};var c=e[a].a;c&&(l.a={e:c.e});var h=e[a].ai;h&&(l.ai=h)}this._cache.set(i,l)}}return this._sheet.parent.calcEngine.statistics.add(this._sheet.id(),Jb.ServerSideCacheFormulaCount,n),r}},{key:"setFormulaCache",value:function(e,t,n){var r=this;this._maxFormulaId<t&&(this._maxFormulaId=t),this._formula2id.set(e,t),this._id2formula.set(t,e);var a=this._cache.get(t);if(null!=a){!function(e,t){var n=e.a;if(null!=n){var r=n.r,a=n.c;if(null!=r&&null!=a){for(var o=r*a,i=[],u=0;u<o;u++)i.push(t(u));n.m=i}}}(a,(function(e){var n="".concat(t,"_").concat(e),a=r._cache.get(n);return r._cache.delete(n),a}));var o=this._sheet.parent.calcEngine,i=!1;(function(e){return null==e.p})(a)&&(i=!e.ignoreApplyCache&&e.fromCache(a,{loadRuntimeError:n})),this._cache.delete(t);var u=this._sheet.parent.aiManager,s=a.ai;if(s){var l,c=s.u;c&&(null===(l=u.setFormulaCreator)||void 0===l||l.call(u,e,c))}i&&(o.statistics.add(this._sheet.id(),Jb.ServerSideCacheHitFormulaCount),this._cachedFormula.add(t),this._dirtyFormula.add(e))}}},{key:"isFormulaCached",value:function(e){var t=this._formula2id.get(e);return"number"==typeof t&&this._cachedFormula.has(t)&&!e.ignoreApplyCache}},{key:"getFormulaId",value:function(e){return this._formula2id.get(e)}},{key:"clearCache",value:function(){this._cache.clear()}},{key:"destroy",value:function(){this._cache.clear(),this._cachedFormula.clear(),this._dirtyFormula.clear(),this._formula2id.clear(),this._id2formula.clear()}}]),e}(),qY=function(){function e(t){(0,y.Z)(this,e),this.workbook=t,this._sheetManagers=new Map,this._formulaCacheVersionMatch=!0,this.isFormulaCacheDisabled=!1}return(0,C.Z)(e,[{key:"disableFormulaCache",value:function(){this.isFormulaCacheDisabled=!0,this._sheetManagers.forEach((function(e){e.clearCache()}))}},{key:"setSheetManager",value:function(e){if(!this._sheetManagers.get(e)){var t=this.workbook.getSheetFromId(e);if(!t)return;this._sheetManagers.set(e,new JY(t))}}},{key:"loadFormulaCacheMeta",value:function(e,t){var n=this._sheetManagers.get(e);if(n)n.setMeta(t);else{var r=this.workbook.getSheetFromId(e);if(!r)return;this._sheetManagers.set(e,new JY(r,t))}}},{key:"loadFormulaCacheBlock",value:function(e,t){if(this.isFormulaCacheDisabled)return null;var n=this._sheetManagers.get(e);return n?n.loadFormulaCacheBlock(t,this._formulaCacheVersionMatch):null}},{key:"applyFormulaCache",value:function(e,t){var n=this._sheetManagers.get(e);n&&n.applyFormulaCache(t,!1)}},{key:"setFormulaCache",value:function(e,t,n){var r=t._id_,a=this._sheetManagers.get(r);a||(a=new JY(t),this._sheetManagers.set(r,a)),a.setFormulaCache(e,n,!1)}},{key:"isFormulaCached",value:function(e){var t=e.getRef().sheet();if(!t)return!1;var n=this._sheetManagers.get(t.id());return!!n&&n.isFormulaCached(e)}},{key:"getFormulaId",value:function(e,t){var n=this._sheetManagers.get(t);if(n)return n.getFormulaId(e)}},{key:"destroy",value:function(){this._sheetManagers.forEach((function(e){return e.destroy()})),this._sheetManagers.clear()}}]),e}(),$Y=function(){function e(){(0,y.Z)(this,e),this.errSheetName2SheetId={}}return(0,C.Z)(e,[{key:"fromJSON",value:function(e){var t=this;e.errFml&&Object.keys(e.errFml).forEach((function(n){var r=n.split("_")[0];e.errFml[n].forEach((function(e){t.errSheetName2SheetId[e]?t.errSheetName2SheetId[e].add(r):t.errSheetName2SheetId[e]=new Set([r])}))}))}},{key:"getErrFmlSheetIdsBySheetName",value:function(e){var t=this.errSheetName2SheetId[e];return t?(delete this.errSheetName2SheetId[e],(0,m.Z)(t)):[]}},{key:"reset",value:function(){this.errSheetName2SheetId={}}}]),e}(),YY=la,KY=".gcSpread",XY=".gcSpreadInternal";function QY(e){return e.getActiveSheet()}var eK={left:0,center:1,right:2,nearest:3},tK={top:0,center:1,bottom:2,nearest:3},nK={allowUndo:!0,defaultDragFillType:5,embed:!1,template:!1,copyPasteHeaderOptions:0,font:null,isShowProtectedRange:!1,isProtected:!0,remainUserPerms:!1,enableIdle:!0,isWorker:!1,canUseWorker:!1,situation:""},rK={floor:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1;return(0,Mt.floor)(e,t)},ceil:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1;return(0,Mt.ceiling)(e,t)},round:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;return(0,Mt.round)(e,t)},toPrecision:function(e,t){return ar._toPrecision(e,t)}},aK=function(){function e(t,n){var r,a=this;(0,y.Z)(this,e),this._userLang=we.Ps3.getLanguage(),this.name="",this._availableSheetIndex=-1,this._activeSheetIndex=0,this.uiEvents=new(sn()),this.sheets=[],this.sheetIdToIndexMap=new Map,this.activeSheet$=new vt.X(void 0),this.importRangeManager=new N_(this),this.logger=console,this._copySheetId="",this._watchHub=new $t.WatchedRefHub,this._hasArrayFormula=!1,this._bitableBlockNum=0,this.taskQueue=new sq,this.apiHookManager=new pv,this._userEvents=[],this._userEventsElem=Nd("input"),this._eventSuspended=0,this._namedStyles={},this.validationHasRandom=!1,this.isvRelationshipManager=null,this.isSearching=!1,this.isRangeSelecting=!1,this.hyperlinkWithEditor=new hq,this.subscriber=new Map,this.changesetExec=new mq,this.formatterService=new Se.FormatterService,this.pivotService=new kt.bY,this._removeRangesInfluencedBySheet=function(e){a.sheets.forEach((function(t){t.rangeModel.delRangesBySheet(e)}))},this.nextControl=Od("nextControl",null),this.previousControl=Od("previousControl",null),t&&t.store&&(this.store=t.store),this.options=xd(nK,(function(e,t,n){a._onOptionChanged(e,t,n)})),this.options.IOCConfig=null==t?void 0:t.IOCConfig,Object.assign(this.options._ps,t),!1!==this.options.enableIdle?this._idle=new lq:this._idle=new cq,this.$watcher=new we.CPL,this.workbookIOC=yI({getCommandManager:this.commandManager.bind(this),getWorkbook:function(){return a},getWatchHub:this.watchHub.bind(this),isWorker:this.options.isWorker}),this.fIdleScheduler=new Rt.FIdleScheduler(this._idle,10),this.formulaIdleScheduler=new GY(this._idle,10,Rt.Direction.HEAD),null!=this.options&&!this.options.isWorker&&this.options.canUseWorker?this.calcEngine=new KJ(this):this.calcEngine=new YJ(this),this.importFormulaManager=new xx(this),this.calcEngine.formulaService.setScheduler(this.formulaIdleScheduler),this.fiberTaskScheduler=new nq(this._idle),t&&t.IOCConfig&&this.bindWorkbookIOCService(t.IOCConfig),this._init(),this._context=n||mM,this.graphDataGenerator=new SM(this),this.permissionManager=new AM(this,this._context.isEmbed()||"history"===this.options.situation),this.isvRelationshipManager=new iq,this._blockManager=new $Y,this.formatterService=new Se.FormatterService("en",(function(e,t){return new Se.I18NService(e,t,{currencies:Object.keys((0,we.w9Z)())})}),rK),this.importRangeManagerV3=new D_(this),this.importRangeManagerV3.V3Enable=we.Ps3.getImportRangeV3Enable()&&!we.Ps3.getImportRangeV2Enable(),this._pivotFormulaService=new zM(this),this.pivotService.setFormulaService(this._pivotFormulaService),this.pivotService.setI18n(fn),(0,kt.Hi)(we.$1K),this.aiManager=bx({maxTask:20,retryTime:50,fetch:(r=(0,u.Z)(i().mark((function e(t,n){var r,o,u,s,l,c;return i().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=a.userLanguage,o=a.getService(Ft.UU),u=o.token,s=o.memberId,l=Mx.prefetchAIActions(),e.t0=l instanceof Promise,!e.t0){e.next=5;break}return e.next=5,l;case 5:return c=t.map((function(e){var t=Mx.getActionIdByActionType(e.action_type||"",r);return Object.assign({},e,{action_id:t})})),e.abrupt("return",we.Ps3.serverApi.aiRequest.getAiResult(c,u||"",Number(s||0),r||"en",n,!!a._context.getHistoryType()));case 7:case"end":return e.stop()}}),e)}))),function(e,t){return r.apply(this,arguments)}),resetOperateId:mx,getOperateId:px})}return(0,C.Z)(e,[{key:"subscribe",value:function(e,t){return this.$watcher.subscribe(e,t)}},{key:"dispatch",value:function(e,t,n){this.$watcher.dispatch(e,t,n)}},{key:"resetPivotInWorker",value:function(){this._pivotDataSourceManagerV2||(this._pivotDataSourceManagerV2=this.workbookIOC.get(uI)),this.sheets.forEach((function(e){e.resetPivotTableManager()}))}},{key:"updateBlockReference",value:function(e){e&&(this._blockManager=new $Y,this._blockManager.fromJSON(e))}},{key:"getBlockManager",value:function(){return this._blockManager}},{key:"getPivotDataSourceManager",value:function(){return this.getPivotDataSourceManagerV2()}},{key:"getPivotDataSourceManagerV2",value:function(){return this._pivotDataSourceManagerV2||(this._pivotDataSourceManagerV2=this.workbookIOC.get(uI)),this._pivotDataSourceManagerV2}},{key:"getPivotSyncModelManager",value:function(){return this._pivotSyncModelManager||(this._pivotSyncModelManager=this.options.isWorker?this.workbookIOC.get(lI):this.workbookIOC.get(sI)),this._pivotSyncModelManager}},{key:"bindWorkbookIOCService",value:function(e){if(e){var t=e.configWorkbookIOCService;t&&t(this.workbookIOC)}}},{key:"bindWorksheetIOCService",value:function(e){var t;e.parent=this.workbookIOC;var n=null===(t=this.options.IOCConfig)||void 0===t?void 0:t.configWorksheetIOCService;n&&n(e)}},{key:"watchHub",value:function(){return this._watchHub}},{key:"watchHubsOnRefOp",value:function(e){this.watchHubs.forEach((function(t){t.onRefOp(e)}))}},{key:"setUserPermissionManager",value:function(e){this.userPermissionManager&&(this.userPermissionManager.destroy(),this.userPermissionManager=null),this.userPermissionManager=e}},{key:"getUserPermissionManager",value:function(){return this.userPermissionManager}},{key:"getUserLanguage",value:function(){return this._userLang}},{key:"detectWorksheet",value:function(e){this.dispatch("LoadSheet",e)}},{key:"injectServices",value:function(e){e(this.workbookIOC)}},{key:"getService",value:function(e){return this.workbookIOC.get(e)}},{key:"unbindService",value:function(e){return this.workbookIOC.unbind(e)}},{key:"initFormulaCacheManager",value:function(){this.formulaCacheManager=new qY(this),this.setFormulaCache=this.formulaCacheManager.setFormulaCache.bind(this.formulaCacheManager),this.getFormulaId=this.formulaCacheManager.getFormulaId.bind(this.formulaCacheManager)}},{key:"setEmbedPermissionManager",value:function(e){this.embedPermissionManager&&(this.embedPermissionManager.destroy(),this.embedPermissionManager=null),this.embedPermissionManager=e}},{key:"getEmbedPermissionManager",value:function(){return this.embedPermissionManager}},{key:"commandManager",value:function(){return this._commandManager}},{key:"hookManager",value:function(){return this._hookManager}},{key:"undoManager",value:function(){return this._undoManager}},{key:"_init",value:function(){var e=this;if(!this.options.embed){var t=this.createWorksheet("1",e._getDefaultSheetName(0),!1);e.sheets.push(t),t._onAttached(e),e.updateSheetArrayInternalState()}}},{key:"_getDefaultSheetName",value:function(e){var t=this,n=this.sheets.filter((function(e){return!e.blockId})).length;t._availableSheetIndex<n?t._availableSheetIndex=n:t._availableSheetIndex++,(Mn(e)||e<t._availableSheetIndex)&&(e=t._availableSheetIndex);var r,a=!1,o=t.sheets;do{r="Sheet"+(e+1);for(var i=o.length,u=0;u<i;u++)if(u in o){if(o[u]._name===r){e++,a=!0;break}a&&(a=!1)}}while(a);return r}},{key:"_dispose",value:function(){var e,t,n,r=this,a=r.sheets;for(r._disposeUserEvents(),n=0;n<a.length;n++)a[n]._dispose(!0);a.splice(0,a.length),r.sheetIdToIndexMap.clear(),r.fiberTaskScheduler.clear(),r._bitableBlockNum=0,r.isvRelationshipManager=null,r._userEventsElem=null,delete r._undoManager,delete r.graphDataGenerator,r.permissionManager&&!r.options.remainUserPerms&&(r.permissionManager.destroy(),delete r.permissionManager),delete r._commandManager,delete r._hookManager,wa._dispose(),r.uiEvents.removeAllListeners(),this.userPermissionManager&&!r.options.remainUserPerms&&this.userPermissionManager.destroy(),this.embedPermissionManager&&this.embedPermissionManager.destroy(),this.formatterService.dispose(),this.importRangeManager.dispose(),this.importRangeManagerV3.dispose(),this.importFormulaManager.dispose(),this.calcEngine.dispose(),this.pivotService.dispose(),null!==(e=this.getPivotDataSourceManager())&&void 0!==e&&e.dispose(),this._pivotDataSourceManagerV2=void 0,this.getPivotSyncModelManager().dispose(),this._idle.destroy(),this.$watcher.destroy(),this.taskQueue.destroy(),this.changesetExec.destroy(),r.calcEngine.dispose(),delete r.calcEngine,null===(t=this.formulaCacheManager)||void 0===t||t.destroy()}},{key:"_disposeUserEvents",value:function(){var e=this.sheets;YY(this._userEventsElem).unbind(KY);for(var t=0;t<e.length;t++)e[t]._disposeUserEvents()}},{key:"destroy",value:function(){this.clearSubscriber(),this._dispose(),this.activeSheet$.complete(),this.unbindAll(),this.workbookIOC.unbindAll(),this._watchHub.clear()}},{key:"clearSubscriber",value:function(){this.subscriber.forEach((function(e){e.unsubscribe()})),this.subscriber.clear()}},{key:"unSubscribe",value:function(e){var t=this.subscriber.get(e);t&&(t.unsubscribe(),this.subscriber.delete(e))}},{key:"getBitableBlockNum",value:function(){return this._bitableBlockNum}},{key:"updateSheetArrayInternalState",value:function(){this.updateBitableBlockNum(),this.updateIdToIndexMapping()}},{key:"updateBitableBlockNum",value:function(){this._bitableBlockNum=this.sheets.reduce((function(e,t){return rq(t)?e+1:e}),0)}},{key:"updateIdToIndexMapping",value:function(){var e=this;this.sheetIdToIndexMap.clear(),this.sheets.forEach((function(t,n){e.sheetIdToIndexMap.set(t.id(),n)}))}},{key:"getActiveSheet",value:function(){return this.sheets[this.getActiveSheetIndex()]}},{key:"setActiveSheet",value:function(e){for(var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1],n=this.sheets,r=0;r<n.length;r++)n[r].name()===e&&this._setActiveSheetIndexImp(r,{triggerEvent:t})}},{key:"setActiveSheetById",value:function(e){for(var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1],n=arguments.length>2?arguments[2]:void 0,r=this.sheets,a=0;a<r.length;a++)r[a].id()===e&&this._setActiveSheetIndexImp(a,{triggerEvent:t,source:n})}},{key:"getActiveSheetIndex",value:function(){return this._activeSheetIndex}},{key:"setActiveSheetIndexCore",value:function(e){e<0&&(e=0),this._activeSheetIndex=e}},{key:"_addSheet",value:function(e,t,n){this._addSheetImp(e,2,t,n)}},{key:"removeSheet",value:function(e,t){var n=this.sheets[e];arguments.length>0&&this._removeSheetImp(e,t),this.unSubscribe(n.id())}},{key:"_hideSheet",value:function(e){var t=1;arguments.length>0&&this._hideSheetImp(e,t)}},{key:"_moveSheet",value:function(e,t,n,r){this._moveSheetImpl(e,t,n,r)}},{key:"_setActiveSheetIndexImp",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{triggerEvent:!0};if(-1!==e&&"number"==typeof e){var n=this;if(null!=t&&t.forceUpdate||e!==n.getActiveSheetIndex()){var r=null==t?void 0:t.prevSheet,a=n.sheets[e];if(a&&a.visible())if(null!=t&&t.forceUpdate||!r||r!==a){var o=QY(n),i={oldSheet:o,newSheet:a,triggerEvent:t.triggerEvent};this.dispatch("BeforeActiveSheetChange",i),this.setActiveSheetIndexCore(e),a!==o&&(o&&o._dispose(!1),this._setActiveSheetImp(i)),t.triggerEvent&&window.dispatchEvent((0,we.t35)("sheet:mobile:activeSheetChanged",{detail:Object.assign(i,{source:null==t?void 0:t.source})}))}else this.setActiveSheetIndexCore(e)}}}},{key:"_setActiveSheetImp",value:function(e){var t=e.newSheet,n=e.oldSheet,r=e.triggerEvent;(void 0===r||r)&&this.dispatch("ActiveSheetChanged",{newSheet:t,oldSheet:n||void 0}),this.activeSheet$.next(t);var a=t.id();this.fiberTaskScheduler.updateSheet(a)}},{key:"setCopySheetId",value:function(e){this._copySheetId=e}},{key:"getCopySheetId",value:function(){return this._copySheetId}},{key:"clearCopySheetId",value:function(){this._copySheetId=""}},{key:"_addSheetImp",value:function(e,t,n,r){this.doAddSheet(e,n),n.getCalcEngine().recoverInvalidRefs(n),this.dispatch("SheetAdded",{sheet:n},r)}},{key:"checkNameValidity",value:function(e){for(var t=this.sheets,n=t.length,r=0;r<n;r++)if(t[r]._name===e._name)throw console.error("SheetName Repeat ".concat(r," ").concat(e._name)),new Error("NotSupportException SheetName Repeat")}},{key:"updateSheetsByInsertSheet",value:function(e,t){this.sheets.splice(e,0,t),this.updateSheetArrayInternalState()}},{key:"getActiveIndexByInsertSheet",value:function(e){var t=this.sheets.length,n=this.getActiveSheetIndex();return 1===t&&n>=0?0:(n<0?n=this._getNextVisibleIndex(n):n>=e&&n++,n)}},{key:"getRangeDatas",value:function(e,t){var n=this.getSheetFromId(e);return n?n.getRangeDatas(t):[]}},{key:"getColHeaderWidth",value:function(e){var t;return null===(t=this.getSheetFromId(e))||void 0===t?void 0:t.getColHeaderWidth()}},{key:"getRowHeaderHeight",value:function(e){var t;return null===(t=this.getSheetFromId(e))||void 0===t?void 0:t.getRowHeaderHeight()}},{key:"scrollTo",value:function(e,t,n){var r=this.getSheetFromId(e);return r&&r.scrollTo(t,n)}},{key:"scroll",value:function(e,t,n){var r=this.getSheetFromId(e);return r&&r.scroll({posX:t,posY:n})}},{key:"getCellRect",value:function(e,t,n){var r;return null===(r=this.getSheetFromId(e))||void 0===r?void 0:r.getCellRect(t,n)}},{key:"getHiddenCols",value:function(e){var t;return null===(t=this.getSheetFromId(e))||void 0===t?void 0:t.getHiddenCols()}},{key:"getHiddenRows",value:function(e){var t;return null===(t=this.getSheetFromId(e))||void 0===t?void 0:t.getHiddenRows()}},{key:"doAddSheet",value:function(e,t){var n=this;t._name?this.checkNameValidity(t):t._name=n._getDefaultSheetName(e);var r=this.getActiveSheet();n._copyUserEvents(t),t._onAttached(n),this.updateSheetsByInsertSheet(e,t);var a=this.getActiveIndexByInsertSheet(e);this._setActiveSheetIndexImp(a,{triggerEvent:!1,prevSheet:r})}},{key:"setWorkbookHasArrayFormula",value:function(e){this._hasArrayFormula=e}},{key:"hasArrayFormula",value:function(){return this._hasArrayFormula}},{key:"initAddSheet",value:function(e,t){this.doAddSheet(e,t)}},{key:"_getPreVisibleIndex",value:function(e){for(var t=this.sheets,n=e-1;n>=0;n--){var r=t[n];if(r&&r.visible())return n}return 0}},{key:"_getNextVisibleIndex",value:function(e){for(var t=this.sheets,n=t.length,r=e+1;r<n;r++){var a=t[r];if(a&&a.visible())return r}return 0}},{key:"_hideSheetImp",value:function(e,t){var n=this.sheets,r=n.length;if(isNaN(e)||e<0||e>=r)throw new Error("Index is out of range!");n[this.getActiveSheetIndex()].getHiddenStatus()&&this._setActiveSheetIndexImp(this.pickUnhiddenSheetIndex())}},{key:"pickUnhiddenSheet",value:function(e){var t=this.pickUnhiddenSheetIndex(e);return this.sheets[t]}},{key:"pickUnhiddenSheetIndex",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,t=this.sheets,n=t.length;e=e||0,arguments.length<=0&&(e=this.getActiveSheetIndex());var r,a=-1;for(r=e;r<n;r++){var o=t[r];if(o&&!o.getHiddenStatus()){a=r;break}}if(-1===a)for(r=e-1;r>=0;r--)if(!t[r].getHiddenStatus()){a=r;break}return(r>=n||r<0)&&(a=0),a}},{key:"_removeSheetImp",value:function(e,t){var n=this,r=n.sheets,a=r.length;if(isNaN(e)||e<0||e>=a)throw new Error("Index is out of range!");var o=e<=n.getActiveSheetIndex()||e===a-1,i=QY(n),u=n.getActiveSheetIndex();e<n.getActiveSheetIndex()&&n.setActiveSheetIndexCore(--u);var s=r[e],l=n.getCalcEngine();l.unregisterFormulas(s);var c=new Wi(!0,"delete",0,s.getRowCount(),s),h=new Wi(!1,"delete",0,s.getColumnCount(),s);if(this.watchHubsOnRefOp(c),this.watchHubsOnRefOp(h),l.depRefManager.onRefOp(new zi(s)),s._disposeUserEvents(),r.splice(e,1),this.updateSheetArrayInternalState(),this.setActiveSheetIndexCore(this.pickUnhiddenSheetIndex()),this._removeRangesInfluencedBySheet(s.id()),l.pivotCalculateEngine.destoryBySheetId(s.id()),o){var f=r[n.getActiveSheetIndex()];if(i!==f&&(i&&i._dispose(!1),f)){var d={oldSheet:i,newSheet:f};n._setActiveSheetImp(d)}}this.dispatch("SheetRemoved",{sheet:s},t)}},{key:"_clearSheetsImpl",value:function(){for(var e=this.sheets,t=0;t<e.length;t++)e[t]._disposeUserEvents(),e[t]._dispose(!1);e.splice(0,e.length),this._bitableBlockNum=0,this.setActiveSheetIndexCore(0)}},{key:"getSheetFromIndex",value:function(e){var t=this.sheets;return e>=0&&e<t.length?t[e]:null}},{key:"getSheetFromId",value:function(e){var t=null,n=this.sheetIdToIndexMap.get(e);if(!(0,Ce.default)(n)&&((t=this.getSheetFromIndex(n))&&t.id()===e))return t;var r=this.sheets;this.sheetIdToIndexMap.clear();for(var a=0;a<r.length;a++){var o=r[a].id();o===e&&(t=r[a]),this.sheetIdToIndexMap.set(o,a)}return t}},{key:"removeSheetFromId",value:function(e){for(var t=this.sheets,n=0,r=t.length;n<r;n++){var a=t[n];if(a&&a.id()===e){this.removeSheet(n);break}}}},{key:"getSheetFromName",value:function(e){for(var t=this.sheets,n=0;n<t.length;n++)if(t[n].name()===e)return t[n];return null}},{key:"getSheetIds",value:function(){for(var e=this.sheets,t=[],n=0;n<e.length;n++)t.push(e[n].id());return t}},{key:"getSheetIndex",value:function(e){for(var t=this.sheets,n=0;n<t.length;n++)if(t[n].name()===e)return n;return null}},{key:"getSheetIndexFromId",value:function(e){for(var t=this.sheets,n=0;n<t.length;n++)if(t[n].id()===e)return n;return null}},{key:"getSheetCount",value:function(){return this.sheets.length}},{key:"getVisiableSheetsLength",value:function(){var e=this.sheets,t=0;return e.forEach((function(e){e.getHiddenStatus()||t++})),t}},{key:"getISVRelationshipManager",value:function(){return this.isvRelationshipManager}},{key:"bind",value:function(e,t,n){var r=this,a=r.sheets;r._userEvents.push({type:e,data:t,fn:n}),YY(r._userEventsElem).bind(e+KY,t,n);for(var o=0;o<a.length;o++)a[o].bind(e,t,n)}},{key:"unbind",value:function(e,t){for(var n=this,r=n.sheets,a=n._userEvents,o=0;o<a.length;o++){var i=a[o];i.type!==e||t&&t!==i.data&&t!==i.fn||a.splice(o,1)}YY(n._userEventsElem).unbind(e+KY,t);for(var u=0;u<r.length;u++)r[u].unbind(e,t)}},{key:"unbindAll",value:function(){var e=this,t=e.sheets;e._userEvents.length=0,YY(e._userEventsElem).unbind(KY);for(var n=0;n<t.length;n++)t[n].unbindAll()}},{key:"_bind",value:function(e,t,n){var r=this,a=r.sheets;r._userEvents.push({type:e,data:t,fn:n}),YY(r._userEventsElem).bind(e+XY,t,n);for(var o=0;o<a.length;o++)a[o]._bind(e,t,n)}},{key:"_unbind",value:function(e,t){for(var n=this,r=n.sheets,a=n._userEvents,o=0;o<a.length;o++){var i=a[o];i.type!==e||t&&t!==i.data&&t!==i.fn||a.splice(o,1)}YY(n._userEventsElem).unbind(e+XY,t);for(var u=0;u<r.length;u++)r[u]._unbind(e,t)}},{key:"_unbindAll",value:function(){var e=this,t=e.sheets;e._userEvents.length=0,YY(e._userEventsElem).unbind(XY);for(var n=0;n<t.length;n++)t[n]._unbindAll()}},{key:"trigger",value:function(e,t){this._trigger(e,t)}},{key:"_trigger",value:function(e,t){0===this._eventSuspended&&YY(this._userEventsElem).trigger(e,t)}},{key:"_copyUserEvents",value:function(e){for(var t=this._userEvents,n=0;n<t.length;n++){var r=t[n];e.bind(r.type,r.data,r.fn)}}},{key:"suspendEvent",value:function(){var e=this.sheets;this._eventSuspended++;for(var t=0;t<e.length;t++){var n=e[t];n&&n.suspendEvent()}}},{key:"resumeEvent",value:function(){var e=this,t=e.sheets;e._eventSuspended--,e._eventSuspended<0&&(e._eventSuspended=0);for(var n=0;n<t.length;n++){var r=t[n];r&&r.resumeEvent()}}},{key:"forceResumeEvent",value:function(){for(;this._eventSuspended>0;)this.resumeEvent()}},{key:"_moveSheetImpl",value:function(e,t,n,r){var a=this.sheets,o=t,i=e,u=-1,s=this.getActiveSheet();if(-1!==o&&-1!==i&&i!==o){var l,c=this.sheets,h=c[i];if(i>o){for(l=i;l>o;l--)c[l]=c[l-1];c[o]=h,u=o}else if(i<o){for(l=i;l<o;l++)c[l]=c[l+1];c[o]=h,u=o}if(n)this.setActiveSheetIndexCore(u);else{for(l=0;l<a.length;l++)a[l]===s&&(u=l);this.setActiveSheetIndexCore(u)}}this.dispatch("SheetMoved",{sourceIndex:e,targetIndex:t},r)}},{key:"reorder",value:function(e){var t=this.sheets,n=t[this.getActiveSheetIndex()],r=0,a=t.reduce((function(e,t){return e[t.id()]=t,e}),{}),o=e.map((function(e,t){var o=a[e];return o===n&&(r=t),o})).filter((function(e){return void 0!==e}));this.sheets=o,this.updateSheetArrayInternalState(),this.setActiveSheetIndexCore(r)}},{key:"getCalcEngine",value:function(){return this.calcEngine}},{key:"applyAction",value:function(e,t,n,r){this.changesetExec.batchExecBegin();var a=this.changesetExec.execAction(this,e,t,n,void 0,r);return this.changesetExec.batchExecFinish(),a}},{key:"applyBatchAction",value:function(e,t,n,r){return this.changesetExec.execAction(this,e,t,n,void 0,r)}},{key:"batchExecBegin",value:function(){this.changesetExec.batchExecBegin()}},{key:"batchExecFinish",value:function(){this.changesetExec.batchExecFinish()}},{key:"applyActions",value:function(e,t,n,r){var a=this;this.dispatch("AnalyzeActionDeps",{actions:e,local:n,fromUndoRedo:r}),this.taskQueue.addTask((function(){a.dispatch("BeforeApply",{actions:e,local:n,fromUndoRedo:r}),t||a.suspendEvent(),a.changesetExec.execBatchActions(a,e,t,n,r),t||a.resumeEvent(),a.dispatch("AfterApply",{actions:e,local:n,fromUndoRedo:r})}))}},{key:"suspendActions",value:function(){this.taskQueue.suspend()}},{key:"resumeActions",value:function(){this.taskQueue.resume()}},{key:"throwError",value:function(e,t){this.dispatch("SpreadError",{type:e,context:t})}},{key:"notifySheetSoftDeleted",value:function(e){this.getSheetFromId(e)&&this.dispatch("SheetSoftDeleted",{sheetId:e})}},{key:"registerCsPreare",value:function(e){this.changesetExec.registerCsPreare(e)}},{key:"registerCsFinish",value:function(e){this.changesetExec.registerCsFinish(e)}},{key:"proxyChangeset",value:function(e){this.changesetExec.registerProxy(e)}},{key:"updateChangesetOpts",value:function(e){this.changesetExec.updateOptions(e)}},{key:"setChangesetExecStrategy",value:function(e){this.changesetExec.setStrategy(e)}},{key:"getCellFormulaValidation",value:function(e,t,n){return this.getCellFormulaErrorValidation(e,t,n)}},{key:"getCellFormulaErrorValidation",value:function(e,t,n){var r=e.getVar(t,n);return $f(e,r)}},{key:"hasFormula",value:function(e,t){return(0,F.Z)(this.sheets,(function(e){return e.hasFormula()}))}},{key:"setHook",value:function(e,t){this._hookManager&&this._hookManager.setHook(e,t)}},{key:"setHooks",value:function(e,t){this._hookManager&&this._hookManager.setHooks(e,t)}},{key:"removeHook",value:function(e,t){this._hookManager&&this._hookManager.removeHook(e,t)}},{key:"sheetIdle",get:function(){return this._idle}},{key:"watchHubs",get:function(){var e=[this.watchHub()];return this.sheets.forEach((function(t){return t.watchHubs.forEach((function(t){return e.push(t)}))})),e}},{key:"userLanguage",get:function(){return this._userLang},set:function(e){this._userLang=e}}]),e}();aK._defaultOptions=nK,aK._defaultSheetCount=1,aK._defaultActiveSheetIndex=0;var oK=function(){function e(){(0,y.Z)(this,e),this.executors=new Map}return(0,C.Z)(e,[{key:"registerMutation",value:function(e){if(this.executors.has(e.mutationType))throw new Error("duplicated register, Mutation: ".concat(e.mutationType));this.executors.set(e.mutationType,e)}},{key:"getMutationExecutor",value:function(e){return e?this.executors.get(e):void 0}}]),e}(),iK=new oK,uK=function(){function e(){(0,y.Z)(this,e)}return(0,C.Z)(e,[{key:"batchExecBegin",value:function(e){var t;this.execContext=null!==(t=e)&&void 0!==t?t:{}}},{key:"excuteMutationImpl",value:function(e,t,n){var r=iK.getMutationExecutor(t.type);if(r){var a=r.execute(e,t,this.execContext,n);return r.batchDone&&r.batchDone(e,this.execContext),a}console.error(new Error("Error: unknown Mutation ".concat(t.type)))}},{key:"batchExecFinish",value:function(e){this.execContext={}}}]),e}(),sK=function(e){function t(){var e;return(0,y.Z)(this,t),(e=(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))).batchDoneSet=new Set,e}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"excuteMutationImpl",value:function(e,t,n){var r=this,a=iK.getMutationExecutor(t.type);if(a){this.batchDoneSet.forEach((function(n){n.needBatchDone&&n.needBatchDone(t,r.execContext)&&n.batchDone&&(n.batchDone(e,r.execContext),r.batchDoneSet.delete(n))}));var o=a.execute(e,t,this.execContext,n);return a.batchDone&&this.batchDoneSet.add(a),o}console.error(new Error("Error: unknown Mutation ".concat(t.type)))}},{key:"batchExecFinish",value:function(e){var n=this;this.batchDoneSet.size&&this.batchDoneSet.forEach((function(t){t.batchDone&&t.batchDone(e,n.execContext)})),this.batchDoneSet.clear(),(0,f.Z)((0,v.Z)(t.prototype),"batchExecFinish",this).call(this,e)}}]),t}(uK),lK=function(){function e(){(0,y.Z)(this,e),this.strategy=new sK}return(0,C.Z)(e,[{key:"applyCommands",value:function(e,t,n){var r;if(null!=t&&null!==(r=t.commands)&&void 0!==r&&r.length){var a,o=_n(t.commands);try{for(o.s();!(a=o.n()).done;){var i=a.value,u=Object.assign({},n,{sheetId:i.sheetId});i.type===we.B2l.CommandType.CommandType_RESOURCE_SNAPSHOT&&(u.resourceRefs=i.resourceRefs),this.strategy.batchExecBegin(u),i.mutations&&this.applyMutations(e,i.mutations),this.strategy.batchExecFinish(e)}}catch(e){o.e(e)}finally{o.f()}}}},{key:"applyMutations",value:function(e,t){var n,r=_n(t);try{for(r.s();!(n=r.n()).done;){var a=n.value;this.strategy.excuteMutationImpl(e,a)}}catch(e){r.e(e)}finally{r.f()}}}]),e}(),cK=function(){function e(){(0,y.Z)(this,e),this.filterStrings=new Bk,this.dateGroupItems=new Pk}return(0,C.Z)(e,[{key:"getCommandResourceRefs",value:function(){return{filterStrings:Dk(this.filterStrings.toArray()),dateGroupItems:Dk(this.dateGroupItems.toArray())}}}]),e}(),hK=we.B2l.CommandType.CommandType_TOP_SNAPSHOT,fK=we.B2l.CommandType.CommandType_RESOURCE_SNAPSHOT,dK=we.B2l.CommandType.CommandType_TABLE_SNAPSHOT,vK=function(e){function t(){var e;return(0,y.Z)(this,t),(e=(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))).mutationExec=new lK,e}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"serialize",value:function(e,t,n){var r,a=new Set(null!==(r=e)&&void 0!==r?r:[hK,fK,dK]),o={};return a.forEach((function(e){e===hK&&(o[hK]={commands:[]}),e===fK&&(o[fK]={commands:[]}),e===dK&&(o[dK]={commands:[]})})),this.serializeTopSnapshot(o),this.serializeWorksheetMutations(o,t,n),o}},{key:"serializeTopSnapshot",value:function(e){var t,n=null===(t=e[hK])||void 0===t?void 0:t.commands;if(n){n.push({type:hK,mutations:[this.serializeWorkbookMutation()]});for(var r=this.getSheetCount(),a=0;a<r;a++){var o=this.getSheetFromIndex(a);o&&n.push({type:hK,mutations:o.serializeTopSnapshot(a),sheetId:o.id()})}}}},{key:"serializeWorkbookMutation",value:function(){var e,t=this.defaults;if(t){var n=Op(Ad.fromJSON(this.formatterService,t.style));e={styles:{numFmt:n.numFmt,font:n.font,fill:n.fill,border:n.border,alignment:n.alignment},format:{defaultColWidth:t.colWidth,defaultRowHeight:t.rowHeight,lineHeightFactor:t.lineHeightFactor,inlineAlign:t.inlineAlign,cellPadding:{top:t.cellPadding[0],right:t.cellPadding[1],bottom:t.cellPadding[2],left:t.cellPadding[3]}}}}var r={workbookPr:{lang:this.lang,locale:this.locale},defaults:e};return{type:we.B2l.MutationType.MutationType_SetWorkbookProperties,setWorkbookProperties:r}}},{key:"serializeWorksheetMutations",value:function(e,t,n){for(var r,a,o=this,i=null===(r=e[fK])||void 0===r?void 0:r.commands,u=null===(a=e[dK])||void 0===a?void 0:a.commands,s=this.getSheetCount(),l=function(e){var r,a=o.getSheetFromIndex(e);if(!a)return"continue";var s=[{}];if(null==t||!t.length||(s=t.filter((function(e){return e.sheetId===a.id()})),null!==(r=s)&&void 0!==r&&r.length)){if(i){var l=new cK,c=a.serializeResourceSnapshot(l,n);n&&t&&c.push.apply(c,(0,m.Z)(a.serializePTViewDataModel(t))),i.push({type:fK,mutations:c,sheetId:a.id(),resourceRefs:l.getCommandResourceRefs()})}if(u){var h=[];s.forEach((function(e){var t={gridRange:e,isForShortcut:n,gridOffset:n?{row:0,col:0}:void 0},r=a.serializeTableSnapshot(t).mutation;r.type===we.B2l.MutationType.MutationType_SetRangeValues&&h.push(r)})),h.length&&u.push({type:dK,mutations:h,sheetId:a.id()})}}},c=0;c<s;c++)l(c)}},{key:"encodeCommandsMap",value:function(e){for(var t={},n=0,r=Object.keys(e);n<r.length;n++){var a=r[n];t[a]=this.encodeCommands(e[a])}return t}},{key:"encodeCommands",value:function(e){return(0,we.J1c)(e)}},{key:"decodeCommandsMap",value:function(e){for(var t={},n=0,r=Object.keys(e);n<r.length;n++){var a=r[n];t[a]=this.decodeCommands(e[a])}return t}},{key:"decodeCommands",value:function(e){return(0,we.Z6r)(e)}},{key:"applyCommandsMap",value:function(e,t){for(var n=0,r=Object.keys(e);n<r.length;n++){var a=e[r[n]];this.mutationExec.applyCommands(this,a,t)}}},{key:"applyCommands",value:function(e,t){this.mutationExec.applyCommands(this,e,t)}},{key:"applyMutationSnapshot",value:function(e){var t=this,n=e.gzipTopSnapshot,r=e.gzipResource,a=e.blocks,o=e.cellBlockMetaMap;this.executeMutations(n,{isApplySnapshot:!0}),this.executeMutations(r,{isApplySnapshot:!0}),a&&Object.keys(a).forEach((function(e){var n;if(o&&o[e]){var r=o[e].range;n={row:r.rowStart,col:r.colStart}}t.executeMutations(a[e],{isApplySnapshot:!0,offsetRange:n})}))}},{key:"executeMutations",value:function(e,t){e&&this.applyCommands(this.decodeCommands(e),t)}}]),t}(aK),gK=new Set(["IOCConfig","_ps","enableIdle"]);function mK(e,t){return void 0!==t[e]||gK.has(e)}var pK=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"toJSON",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1],n={};(0,H.Z)(this.options,(function(e,t){gK.has(t)||aK._defaultOptions[t]===e||(n[t]=e)}));var r=this.getSheetCount();n.sheetCount=r;var a=this.getActiveSheetIndex();e&&e.isServerExport||a===aK._defaultActiveSheetIndex||(n.activeSheetIndex=a);for(var o={},i=0;i<r;i++){var u=this.getSheetFromIndex(i);u&&(o[u._name]=u.toJSON(e,t),o[u._name].index=i)}return(0,se.default)(o)||(n.sheets=o),n.lang=this.lang,n.locale=this.locale,n.schemaVersion=1,n.hasArrayFormula=this.hasArrayFormula(),n.defaults=this.defaults,n}},{key:"fromJSON",value:function(e){var t=this;if(e){this.lang=e.lang,this.locale=e.locale,this.initFormulaCacheManager(),this.setWorkbookHasArrayFormula(!0===e.hasArrayFormula),this.getUserLanguage(),this.formatterService.i18n.setLanguage(this.lang||this.getUserLanguage()),(0,we.sus)("zh-CN"),"object"==(0,_.Z)(e.defaults)?this.defaults=Object.assign(e.defaults,this.defaults||{}):void 0===e.defaults&&"object"==(0,_.Z)(this.defaults)&&(e.defaults=this.defaults),this.suspendEvent();try{this._availableSheetIndex=-1,this._clearSheetsImpl();var n=aK._defaultOptions;for(var r in n)if(!mK(r,this.options)){var a=e[r];this.options[r]=Vd(a)?a:n[r]}var o=e.sheetCount;Vd(o)||(o=aK._defaultSheetCount);var i=e.sheets;if(i){var u=(0,b.Z)(i).sort((function(e,t){return e.index=e.index||0,t.index=t.index||0,e.index-t.index})),s=[];u.forEach((function(e,n){e.index=n;var r=t.createWorksheetByData(e),a=r.constructor;t.initAddSheet(n,r);var o=e.rowCount||a._defaultRowCount,i=e.columnCount||a._defaultColCount;r.setRowCount(o),r.setColumnCount(i),s.push({sheet:r,data:e,schema:!1})})),s.forEach((function(t){t.sheet.fromJSON(t.data,!1,t.schema,e)}))}var l=e.activeSheetIndex;Vd(l)||(l=aK._defaultActiveSheetIndex)}finally{this.resumeEvent()}}}},{key:"createWorksheetByData",value:function(e){return this.createWorksheet(e.id,e.name,e.hidden)}}]),t}(vK),yK=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"addSheet",value:function(e,t){return this._executeCmdBase(we.rvF.ADD_SHEET,{sheetName:e,index:t})}},{key:"delSheet",value:function(e){return this._executeCmdBase(we.rvF.DELETE_SHEET,{sheetId:e})}},{key:"copySheet",value:function(e){return this._executeCmdBase(we.rvF.COPY_SHEET,{sheetId:e})}},{key:"moveSheet",value:function(e,t,n){return this._executeCmdBase(we.rvF.MOVE_SHEET,{sheetId:e,sourceIndex:t,targetIndex:n})}},{key:"renameSheet",value:function(e,t){var n=this.getSheetFromId(e);if(!n)return!1;if(t!==n.name()){var r=function(e,t,n){var r=[];if(!e)return[4];if(!e||!(0,he.Z)(e))return[1];if(e.length>100&&r.push(2),/[*:/?[\]\\]/.test(e)&&r.push(1),r.length>0)return r;if(!t)return[0];for(var a=0,o=t.length;a<o;a++){var i=t[a];if(n!==i&&e===i._name)return[3]}return[0]}(t,this.sheets,n);if(0===r[0])return this._executeCmdBase(we.rvF.SET_SHEET_PROPERTY,{sheetId:e,name:t,property_name:"name"});n.dispatch("InvalidOperation",{invalidSheetName:t,invalidType:5,subInvalidType:r})}return!1}},{key:"hideSheet",value:function(e){return this._executeCmdBase(we.rvF.SET_SHEET_PROPERTY,{sheetId:e,hidden:!0,property_name:"visibility"})}},{key:"unhideSheet",value:function(e){return this._executeCmdBase(we.rvF.SET_SHEET_PROPERTY,{sheetId:e,hidden:!1,property_name:"visibility"})}},{key:"hideGridLine",value:function(e,t){return this._executeCmdBase(we.rvF.SET_SHEET_PROPERTY,{sheetId:e,grid_line_hidden:t,property_name:"gridLine"})}},{key:"setTabColor",value:function(e,t){return this._executeCmdBase(we.rvF.SET_SHEET_PROPERTY,{sheetId:e,tab_color:t,property_name:"tabColor"})}},{key:"setTabType",value:function(e,t){return this._executeCmdBase(we.rvF.SET_SHEET_PROPERTY,{sheetId:e,tab_type:t,property_name:"tabType"})}},{key:"protectSheet",value:function(e,t,n,r){return this._executeCmdBase(we.rvF.LOCK_SHEET,{sheetId:e,lockInfo:t,permId:n,creatorId:r})}},{key:"unprotectSheet",value:function(e,t){return this._executeCmdBase(we.rvF.UNLOCK_SHEET,{sheetId:e,permId:t})}},{key:"setDataRange",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];if(e&&e.length)return this._executeCmdBase(we.rvF.SET_DATA_RANGE,{commandType:0,dontAddToCommandStack:t,data:e})}},{key:"delDataRange",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];return this._executeCmdBase(we.rvF.SET_DATA_RANGE,{commandType:1,dontAddToCommandStack:t,data:e})}},{key:"_executeCmdBase",value:function(e){var t,n,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return null!==(t=null===(n=this.commandManager())||void 0===n?void 0:n.execute(Object.assign({cmd:e,sheetId:this.getActiveSheet().id()},r)))&&void 0!==t&&t}}]),t}(pK),CK=function(){function e(){var t=this;(0,y.Z)(this,e),this._suspendCount=0,this.suspendKeyBoardEventCallback=function(e){t._suspendCount>0&&(e.preventDefault(),e.stopImmediatePropagation())},this.suspendEvent=function(){++t._suspendCount},this.resumeEvent=function(){t._suspendCount>0?--t._suspendCount:t._suspendCount=0},window.addEventListener("keydown",this.suspendKeyBoardEventCallback,!0),window.addEventListener("keypress",this.suspendKeyBoardEventCallback,!0),window.addEventListener("keyup",this.suspendKeyBoardEventCallback,!0)}return(0,C.Z)(e,[{key:"destory",value:function(){window.removeEventListener("keydown",this.suspendKeyBoardEventCallback,!0),window.removeEventListener("keypress",this.suspendKeyBoardEventCallback,!0),window.removeEventListener("keyup",this.suspendKeyBoardEventCallback,!0)}}]),e}(),_K=(0,l.Z)({},we.kHU.BITABLE_BLOCK,"Database"),RK=function(e){function t(){var e;return(0,y.Z)(this,t),(e=(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))).checkUseAnonymousLogin=null,e.permissionVersion=0,e.handleSheetPropagation=function(t){var n=t.type,r=t.props,a=t.$sheet,o=t.source;e.$watcher.dispatch(n,r,a,o)},e}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"setUndoManger",value:function(e){this._undoManager=e}},{key:"getSheetsChangeEvents",value:function(){return["SheetAdded","SheetRemoved","SheetMoved","ActiveSheetChanged","PermissionChanged","Renamed","SheetHidden","SheetVisible"]}},{key:"setActiveSheetId",value:function(e,t,n){for(var r=this.sheets,a=0;a<r.length;a++)if(r[a].id()===e){this._setActiveSheetIndexImp(a,{triggerEvent:t,source:n});break}}},{key:"_onOptionChanged",value:function(e,t,n){"allowUndo"===e&&this._undoManager&&(this._undoManager._allowUndo=t)}},{key:"toggleShowProtectedRange",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:!this.options.isShowProtectedRange;this.options.isShowProtectedRange=e;var t=this.getActiveSheet();return t&&t.notifyShell(47),t&&t.dispatch("ProtectedRangeChanged"),e}},{key:"setActiveSheetIndex",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1],n=arguments.length>2?arguments[2]:void 0;this._setActiveSheetIndexImp(e,{triggerEvent:t,forceUpdate:n})}},{key:"removeSheetFromId",value:function(e){for(var t=this.sheets,n=0,r=t.length;n<r;n++){var a=t[n];if(a&&a.id()===e){this.removeSheet(n);break}}}},{key:"getAllMentionsInSpread",value:function(){var e=this.sheets,t=[];return e.forEach((function(e){t.push.apply(t,(0,m.Z)(e.getAllMentionsInSheet()))})),t}},{key:"getAllUserMentionsInSpread",value:function(){var e=this.sheets,t=[];return e.forEach((function(e){var n=e.getAllMentionsInSheet();t.push.apply(t,(0,m.Z)(n.filter((function(e){return 0===e.other.mentionType}))))})),t}},{key:"onSetActiveBlock",value:function(e){var t=this;this.sheets.some((function(n){return n.blockToken===e&&(t.setActiveSheet(n.name(),!0),!0)}))}},{key:"_init",value:function(){var e=this;if((0,f.Z)((0,v.Z)(t.prototype),"_init",this).call(this),!0!==this.options.isWorker){this.keyboardEventSuspendHelper=new CK;var n=we.Ps3.imageHelper.ImageWorker;n&&(this._imageWorker=new n(this)),this._undoDispatcher=new Bn,this._undoManager=new Hn(this,-1,this.options.allowUndo,this._undoDispatcher);var r=this._commandManager=new Dn(this);r.addListener("workbookUndo",(function(t){var n=r[t.command.cmd];n&&n.canUndo()&&e.undoManager()._addCommand(t.command,t._actionType)})),this._hookManager=new dr(this)}}},{key:"_dispose",value:function(){(0,f.Z)((0,v.Z)(t.prototype),"_dispose",this).call(this),this.cacheSubscription&&(this.cacheSubscription.unsubscribe(),this.cacheSubscription=null),this._imageWorker&&(this._imageWorker.destroy(),this._imageWorker=null),this._undoDispatcher&&(this._undoDispatcher.clear(),delete this._undoDispatcher);var e=this._undoManager;e&&(e.dispose(),delete this._undoManager),this.blockManager=void 0,this.keyboardEventSuspendHelper&&(this.keyboardEventSuspendHelper.destory(),this.keyboardEventSuspendHelper=null)}},{key:"createWorksheet",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]&&arguments[2],r=new gM(e,t,n,this);return this.dispatch("SheetInit",r),this.subscribeSheetPropagation(r),r}},{key:"subscribeSheetPropagation",value:function(e){var t=e.subscribePropagation(this.handleSheetPropagation);this.subscriber.set(e.id(),t)}},{key:"creatBlockWorksheet",value:function(e,t,n,r,a){var o=arguments.length>5&&void 0!==arguments[5]&&arguments[5],i=arguments.length>6&&void 0!==arguments[6]&&arguments[6],u=new oq(e,t,this,n,r,a,o,i);return this.subscribeSheetPropagation(u),u}},{key:"createWorksheetByData",value:function(e){return e.externalResource?this.creatBlockWorksheet(e.id,e.name,e.externalResource.blockType,e.externalResource.blockId,e.externalResource.blockToken):(0,f.Z)((0,v.Z)(t.prototype),"createWorksheetByData",this).call(this,e)}},{key:"getDefaultBlockSheetName",value:function(e){if(e===we.kHU.BITABLE_BLOCK){var t=_K[e],n=this.sheets.reduce((function(e,n){var r=new RegExp("^".concat(t,"(\\d+)$")).exec(n.name());return r?Math.max(e,Number(r[1])):e}),0);return t+(n+1)}return this._getDefaultSheetName(this.sheets.length)}},{key:"updatePermissionVersion",value:function(){this.permissionVersion++}},{key:"getPermissionVersion",value:function(){return this.permissionVersion}},{key:"getProtectionTotalCount",value:function(){var e=this;return this.sheets.reduce((function(t,n){return t+e.permissionManager.findPermDetail(n.id()).length+n.protectionModel.getProtectionsCount()}),0)}},{key:"getBlockWorksheetIsNew",value:function(e){var t=this.sheets.find((function(t){return t.blockToken===e}));return!!(t&&t instanceof oq&&t.isNew)}},{key:"scrollTo",value:function(e,t,n){var r=this.getSheetFromId(e);return r&&r.scrollTo(t,n)}},{key:"scroll",value:function(e,t,n){var r=this.getSheetFromId(e);return r&&r.scroll({posX:t,posY:n})}},{key:"undoDispatcher",get:function(){return this._undoDispatcher}}]),t}(yK),wK=Math.max,kK=Math.min;function SK(e,t){return e.getColumnCount(t)}function EK(e,t){return e.getRowCount(t)}function TK(e){var t;return(t={},(0,l.Z)(t,we.VDZ.Left,"left"),(0,l.Z)(t,we.VDZ.Right,"right"),(0,l.Z)(t,we.VDZ.Up,"up"),(0,l.Z)(t,we.VDZ.Down,"down"),(0,l.Z)(t,we.VDZ.Home,"home"),(0,l.Z)(t,we.VDZ.End,"end"),(0,l.Z)(t,we.VDZ.PageDown,"page_down"),(0,l.Z)(t,we.VDZ.PageUp,"page_up"),t)[e]}function AK(e,t){var n=e.intersect(t),r=e.sheet();if(n){var a=[];return e.rowFrom()+e.rowCount()>n.rowFrom()+n.rowCount()&&a.push(new Oi(n.rowFrom()+n.rowCount(),e.colFrom(),e.rowFrom()+e.rowCount()-(n.rowFrom()+n.rowCount()),e.colCount(),r)),e.colFrom()+e.colCount()>n.colFrom()+n.colCount()&&a.push(new Oi(Math.max(e.rowFrom(),n.rowFrom()),n.colFrom()+n.colCount(),n.rowCount(),e.colFrom()+e.colCount()-(n.colFrom()+n.colCount()),r)),e.colFrom()<n.colFrom()&&a.push(new Oi(Math.max(e.rowFrom(),n.rowFrom()),e.colFrom(),n.rowCount(),n.colFrom()-e.colFrom(),r)),e.rowFrom()<n.rowFrom()&&a.push(new Oi(e.rowFrom(),e.colFrom(),n.rowFrom()-e.rowFrom(),e.colCount(),r)),a}return[e]}var IK,bK,FK,MK=function(){function e(){(0,y.Z)(this,e)}return(0,C.Z)(e,[{key:"addSelection",value:function(e,t,n){var r=!(arguments.length>3&&void 0!==arguments[3])||arguments[3],a=arguments.length>4?arguments[4]:void 0;if(this.parent.apiHookManager.getHooks(1).every((function(t){return t(e)}))){var o=this._selectionModel.toArray();e=this.extendSelectedRangeForMergeCell(e,t),this._selectionModel.add(e);var i=this._selectionModel.toArray();r&&this._raiseSelectionChanging(o,i)&&this._raiseSelectionChanged(o,n,a)}}},{key:"extendSelectedRangeForMergeCell",value:function(e,t){if(e instanceof Oi){var n=this._getSpanModel().getSpans();!t&&n&&n.length>0&&(e=this._cellRangeInflate(n,e.clone()))}return e}},{key:"setSelection",value:function(e,t,n){var r=this,a=!(arguments.length>3&&void 0!==arguments[3])||arguments[3],o=arguments.length>4?arguments[4]:void 0,i=arguments.length>5?arguments[5]:void 0,u=arguments.length>6?arguments[6]:void 0;if(this.parent.apiHookManager.getHooks(0).every((function(n){return n(e,{sheet:r,cell:t,endCell:i,editMode:u})}))){var s=this;s._clearSelectionImp();var l=e.rgType===we.xj7.ALL||e.rgType===we.xj7.ROW||e.rgType===we.xj7.COL;if(t){if(l){var c=s.getFirstVisibleCellIndex(),h=c.row,f=c.col;t.row=h>t.row?h:t.row,t.col=f>t.col?f:t.col}s._setActiveCellImp(t.row,t.col,1,1)}else if(l){var d=s.getFirstVisibleCellIndex(),v=d.row,g=d.col,m=v>e.rowFrom()?v:e.rowFrom(),p=g>e.colFrom()?g:e.colFrom();s._setActiveCellImp(m,p,1,1)}else s._setActiveCellImp(e.rowFrom(),e.colFrom(),1,1);this.addSelection(e,void 0,n,a,o)}}},{key:"setSelections",value:function(e,t,n){var r=this,a=!(arguments.length>3&&void 0!==arguments[3])||arguments[3],o=this._selectionModel.toArray();this._clearSelectionImp(),t&&this._setActiveCellImp(t.row,t.column,1,1),e.forEach((function(e){return r.addSelection(e,void 0,n,!1)}));var i=this._selectionModel.toArray();a&&this._raiseSelectionChanging(o,i)&&this._raiseSelectionChanged(o,n)}},{key:"getSelections",value:function(){return this._selectionModel.toArray()}},{key:"isSingleCellOrSpan",value:function(e){if(1===e.length){var t=e[0],n=this.getSpans(t);return this.isSingleCell(t)||this.isSingleSpan(t,n)}return!1}},{key:"isSingleCell",value:function(e){return 1===e.size()}},{key:"isSingleSpan",value:function(e,t){return 1===t.length&&e.equal(t[0])}},{key:"clearSelection",value:function(){if(this.parent.apiHookManager.getHooks(3).every((function(e){return e()}))){var e=this.getSelections();this._clearSelectionImp(),this._setActiveCellImp(0,0),this.dispatch("SelectionChanged",{oldSelections:e,newSelections:this.getSelections(),sheet:this,sheetName:this.name()})}}},{key:"_clearSelectionImp",value:function(){this._selectionModel.clear()}},{key:"_canSelect",value:function(e,t,n){var r=this,a=r.options,o=a.protectionOptions,i=!1!==o.allowSelectLockedCells,u=!1!==o.allowSelectUnlockedCells;if(!a.isProtected||i&&u)return!0;if(!i&&!u)return!1;var s=n?n.locked:r._getStyleProperty(e,t,"locked"),l=t<0,c=e<0;if(i===s&&(c||l)){var h=c?EK(r):1;e=c?0:e;var f=l?SK(r):1;t=l?0:t;for(var d,v,g=r._getModel(),m=e+h-1,p=t+f-1,y=g.iterStyle(e,t,m,p),C=y.next();null!==C;C=y.next())if(C&&i!==C.locked)return!1;if(c)for(d=e;d<=m;d++){var _=g.getStyle(d,-1);if(_&&i!==_.locked)return!1}if(l)for(v=t;v<=p;v++){var R=g.getStyle(-1,v);if(R&&i!==R.locked)return!1}}return i===s}},{key:"_saveAndClearSheetSelections",value:function(){var e=this,t=e._selectionModel;t&&t.length>0&&(e._selectionModelCache=t.toJSON(),e._clearSelectionImp())}},{key:"_loadAndSetSheetSelections",value:function(){var e=this._selectionModelCache;e&&this._selectionModel.fromJSON(e,this)}},{key:"_moveActiveCellUp",value:function(e,t,n){var r=this,a=r._getMoveUpCell(e,t,n,r._leadingCellCol||0);if(a){var o=a.row,i=a.col,u=a.leadingCellCol;r._canMoveCurrentTo(o,i)&&(r._leadingCellRow=o,r._leadingCellCol=u,r._setActiveCellCore(o,i))}}},{key:"_getMoveUpCell",value:function(e,t,n,r){var a=this,o=EK(a),i=SK(a),u=e,s=t;if(0===u&&!n||0===o||0===i)return null;var l=a._getPrevRow(u,r);return n||a._adjustCell(l),u=l.r,s=l.c,u<0&&n&&(((s=a._getPrevVisualColumn(s))<0||Mn(s))&&(s=a._getPrevVisualColumn(i)),r=s,u=(l=a._getPrevRow(o,s)).r,(s=l.c)===t&&u<=e)?null:{row:u,col:s,leadingCellCol:r}}},{key:"_moveActiveCellDown",value:function(e,t,n,r){var a=this,o=void 0!==r?r:a._leadingCellCol||0,i=a._getMoveDownCell(e,t,n,o);if(i&&(i.row!==e||i.col!==t)){var u=i.row,s=i.col,l=i.leadingCellCol;a._canMoveCurrentTo(u,s)&&(a._leadingCellRow=u,a._leadingCellCol=l,a._setActiveCellCore(u,s))}}},{key:"_getMoveDownCell",value:function(e,t,n,r){var a=this,o=EK(a),i=SK(a),u=e,s=t;if(u===o-1&&!n||0===o||0===i)return null;var l=a._getNextRow(u,r);return n||a._adjustCell(l),u=l.r,s=l.c,u===o&&n&&(((s=a._getNextVisualColumn(s))>=i||Mn(s))&&(s=a._getNextVisualColumn(-1)),r=s,u=(l=a._getNextRow(-1,s)).r,(s=l.c)===t&&u>=e)?null:{row:u,col:s,leadingCellCol:r}}},{key:"_moveActiveCellLast",value:function(){var e=this,t=e._getMoveLastCell();if(t){var n=t.row,r=t.col;e._leadingCellRow=n,e._leadingCellCol=r,e._setActiveCellCore(n,r)}}},{key:"_getMoveLastCell",value:function(){var e=this,t=e._getLastVisualRow(),n=e._getLastVisualColumn(),r=n;if(!t||!r)return null;var a=e.options,o=a.protectionOptions,i=!1!==o.allowSelectLockedCells,u=!1!==o.allowSelectUnlockedCells;if(!a.isProtected||i&&u)return{row:t,col:r};if(!i&&!u)return null;for(;null!==t&&t>=0;t=e._getPrevVisualRow(t))for(r=n;null!==r&&r>=0;r=e._getPrevVisualColumn(r))if(i===e._getStyleProperty(t,r,"locked"))return{row:t,col:r};return null}},{key:"_moveActiveCellFirst",value:function(){var e=this,t=e._getMoveFirstCell();if(t){var n=t.row,r=t.col;e._leadingCellRow=n,e._leadingCellCol=r,e._setActiveCellCore(n,r)}}},{key:"_getMoveFirstCell",value:function(){var e=this,t=e._getNextVisualRow(e.frozenRowCount()-1),n=e._getNextVisualColumn(e.frozenColumnCount()-1),r=n;if(null===t||null===r)return null;var a=e.options,o=a.protectionOptions,i=!1!==o.allowSelectLockedCells,u=!1!==o.allowSelectUnlockedCells;if(!a.isProtected||i&&u)return{row:t,col:r};if(!i&&!u)return null;for(var s=this._getLastVisualRow()||0,l=this._getLastVisualColumn()||0;null!==t&&t<=s;t=e._getNextVisualRow(t))for(r=n;null!==r&&r<=l;r=e._getNextVisualColumn(r))if(i===e._getStyleProperty(t,r,"locked"))return{row:t,col:r};return null}},{key:"_moveActiveCellLeft",value:function(e,t,n){var r=this,a=r._getMoveLeftCell(e,t,n,r._leadingCellRow||0);if(a){var o=a.row,i=a.col,u=a.leadingCellRow;r._canMoveCurrentTo(o,i)&&(r._leadingCellRow=u,r._leadingCellCol=i,r._setActiveCellCore(o,i))}}},{key:"_getMoveLeftCell",value:function(e,t,n,r){var a=this,o=EK(a),i=SK(a),u=e,s=t;if(0===s&&!n||0===o||0===i)return null;var l=a._getPrevColumn(r,s),c=r;for(n||a._adjustCell(l),u=l.r,s=l.c;s<0&&n;){if(((u=a._getPrevVisualRow(u,3,!0))<0||Mn(u))&&(u=a._getPrevVisualRow(o,3,!0)),r=u,u=(l=a._getPrevColumn(r,i)).r,s=l.c,u===e&&s<t)return null;if(u===e&&s===t){if(r===c)return null;u=(l=a._getPrevColumn(r,s)).r,s=l.c}}return{row:u,col:s,leadingCellRow:r}}},{key:"_adjustCell",value:function(e){var t=this,n=!1;if(e.r<0?e.r=t._getFirstVisualRow():e.r>=EK(t)&&(e.r=t._getLastVisualRow(),n=!0),e.c<0?e.c=t._getFirstVisualColumn():e.c>=SK(t)&&(e.c=t._getLastVisualColumn(),n=!0),n){var r=t._getSpanModel().get(e.r,e.c);r.rowFrom()!==e.r&&(e.r=r.rowFrom()),r.colFrom()!==e.c&&(e.c=r.colFrom())}}},{key:"_moveActiveCellLeftInSelection",value:function(e,t){for(var n,r=this,a=r._selectionModel,o=a.activeSelectedRangeIndex,i=-1,u=r._getActiveSelectedRange(),s=u.rowFrom(),l=u.colFrom(),c=u.colTo(),h=e,f=t;h=(n=r._getPrevColumnInSelection(h,f)).r,!((f=n.c)>=l);){if(i===o)return;if(--h>=s)f=c+1;else{var d=r._getActiveSelectedRange(3);i=a.activeSelectedRangeIndex,s=d.rowFrom(),l=d.colFrom(),c=d.colTo(),h=d.rowTo(),f=c+1}}h>=0&&(r._setActiveCellCore(h,f),r._leadingCellRow=h,r._leadingCellCol=f)}},{key:"_moveActiveCellRightInSelection",value:function(e,t){for(var n,r=this,a=r._selectionModel,o=a.activeSelectedRangeIndex,i=-1,u=r._getActiveSelectedRange(),s=u.colFrom(),l=u.rowTo(),c=u.colTo(),h=e,f=t;h=(n=r._getNextColumnInSelection(h,f)).r,!((f=n.c)<=c);){if(i===o)return;if(++h<=l)f=s-1;else{var d=r._getActiveSelectedRange(4);i=a.activeSelectedRangeIndex,s=d.colFrom(),l=d.rowTo(),c=d.colTo(),h=d.rowFrom(),f=d.colFrom()-1}}h>=0&&(r._setActiveCellCore(h,f),r._leadingCellRow=h,r._leadingCellCol=f)}},{key:"_baseMoveRightCell",value:function(e,t,n){var r=arguments.length>3&&void 0!==arguments[3]&&arguments[3],a=arguments.length>4?arguments[4]:void 0,o=this,i=o._getMoveRightCell(e,t,n,o._leadingCellRow||0);if(i&&(i.row!==e||i.col!==t)){var u=i.row,s=i.col,l=i.leadingCellRow;a&&a(u),o._canMoveCurrentTo(u,s)&&(o._leadingCellRow=l,o._leadingCellCol=s,o._setActiveCellCore(u,s,r))}}},{key:"_tabMoveCellRight",value:function(e,t,n){var r=this;r._baseMoveRightCell(e,t,n,!0,(function(n){void 0===r._firstTabCol&&(r._firstTabCol=t),n!==e&&(r._firstTabCol=r._getFirstVisualColumn())}))}},{key:"_moveActiveCellRight",value:function(e,t,n){this._baseMoveRightCell(e,t,n)}},{key:"_getMoveRightCell",value:function(e,t,n,r){var a=this,o=EK(a),i=SK(a),u=e,s=t;if(s===i-1&&!n||0===o||0===i)return null;var l=a._getNextColumn(r,s),c=r;for(n||a._adjustCell(l),u=l.r,s=l.c;s===i&&n;){if(((u=a._getNextVisualRow(u))>=o||Mn(u))&&(u=a._getNextVisualRow(-1)),r=u,u=(l=a._getNextColumn(r,-1)).r,s=l.c,u===e&&s>t)return null;if(u===e&&s===t){if(r===c)return null;u=(l=a._getNextColumn(r,s)).r,s=l.c}}return{row:u,col:s,leadingCellRow:r}}},{key:"_getPrevColumn",value:function(e,t){for(var n,r=this,a=t;a>=0&&(n=e,!(--a<0));){var o=r.getSpans(new Oi(n,a,1,1,r));if(o&&o.length>0){var i=o[0];a>=i.colFrom()&&(a=i.colFrom(),n=i.rowFrom())}if(r._canMoveCurrentTo(n,a))return{r:n,c:a}}return{r:n,c:a}}},{key:"_getPrevColumnInSelection",value:function(e,t){for(var n=this;t>=0&&!(--t<0);){var r=n._getSpanModel().find(e,t);if(r){var a=n._getActiveSelectedRange();if(!(a.rowFrom()<=r.rowFrom()&&r.rowFrom()+r.rowCount()<=a.rowFrom()+a.rowCount()&&a.colFrom()<=r.colFrom()&&r.colFrom()+r.colCount()<=a.colFrom()+a.colCount()))continue;if(r.rowFrom()!==e||r.colFrom()!==t)continue;t>=r.colFrom()&&(t=r.colFrom(),e=r.rowFrom())}if(n._canMoveCurrentTo(e,t))return{r:e,c:t}}return{r:e,c:t}}},{key:"_getNextColumn",value:function(e,t){for(var n,r=this,a=SK(r),o=t;o<a&&(n=e,!((o+=r._getSpanModel().get(n,o).colCount())>=a));){var i=r.getSpans(new Oi(n,o,1,1,r));if(i&&i.length>0){var u=i[0];o>u.colFrom()?o=wK(o,u.colFrom()+u.colCount()):n=u.rowFrom()}if(r._canMoveCurrentTo(n,o))return{r:n,c:o}}return{r:n,c:o}}},{key:"_getNextColumnInSelection",value:function(e,t){for(var n=this,r=n._getSpanModel(),a=SK(n);t<a;){var o=r.get(e,t);if((t=o.colFrom()+o.colCount())>=a)break;var i=r.find(e,t);if(i){var u=n._getActiveSelectedRange();if(!(u.rowFrom()<=i.rowFrom()&&i.rowFrom()+i.rowCount()<=u.rowFrom()+u.rowCount()&&u.colFrom()<=i.colFrom()&&i.colFrom()+i.colCount()<=u.colFrom()+u.colCount()))continue;if(i.rowFrom()!==e||i.colFrom()!==t)continue;t>i.colFrom()?t=wK(t,i.colFrom()+i.colCount()):e=i.rowFrom()}if(n._canMoveCurrentTo(e,t))return{r:e,c:t}}return{r:e,c:t}}},{key:"_canMoveCurrentTo",value:function(e,t){var n=this;if(!n._canSelect(e,t))return!1;var r=e>=0&&e<EK(n)&&t>=0&&t<SK(n)&&n.getRowVisible(e)&&n.getColumnVisible(t),a=!!n._isTabNavigation;return!0===r&&!0===a&&!1===n._getStyleProperty(e,t,"tabStop")&&(r=!1),r}},{key:"_getPrevRow",value:function(e,t){for(var n=this;e>=0&&!(--e<0);){var r=n.getSpans(new Oi(e,t,1,1,n));if(r&&r.length>0){var a=r[0];e>=a.rowFrom()&&(e=a.rowFrom(),t=a.colFrom())}if(n._canMoveCurrentTo(e,t))return{r:e,c:t}}return{r:e,c:t}}},{key:"_getNextRow",value:function(e,t){for(var n=this,r=EK(n);e<r&&!((e+=n._getSpanModel().get(e,t).rowCount())>=r);){var a=n.getSpans(new Oi(e,t,1,1,n));if(a&&a.length>0){var o=a[0];e>o.rowFrom()?e=wK(e,o.rowFrom()+o.rowCount()):t=o.colFrom()}if(n._canMoveCurrentTo(e,t))return{r:e,c:t}}return{r:e,c:t}}},{key:"_setSelectedRange",value:function(e){this._selectionModel.add(e)}},{key:"_expandSelectedRange",value:function(e){if(this.parent.apiHookManager.getHooks(4).every((function(t){return t(e)}))){var t=this,n=t._getExtendedRange(e.rowTo(),e.colTo(),e.rowFrom(),e.colFrom()),r=n.rowFrom(),a=n.colFrom(),o=n.rowCount(),i=n.colCount(),u=t._selectionModel,s=u.toArray(),l=u.length-1;if(u.length>0){var c;c=e instanceof Vi?new Vi(a,i,t):e instanceof xi?new xi(r,o,t):new Oi(r,a,o,i,t),u.splice(l,1,c);var h=t._selectionModel.toArray();t._raiseSelectionChanging(s,h)&&t._raiseSelectionChanged(s)}}}},{key:"_extractSelectedRange",value:function(e){if(this.parent.apiHookManager.getHooks(4).every((function(t){return t(e)}))){var t=this,n=t._getExtendedRange(e.rowTo(),e.colTo(),e.rowFrom(),e.colFrom()),r=t._selectionModel,a=r.toArray(),o=r.length-1;if(o>0){var i,u=t.getActiveCellIndex();r.splice(o,1);for(var s=Date.now(),l=0;l<o;l++){var c=r.shift();if(!c)return;var h=AK(c,n);r.push.apply(r,(0,m.Z)(h))}if(!r.length){var f=t.getSpan(u.row,u.column)||new Zi(u.row,u.column,t);r.push(f)}var d=r[r.length-1];t._setActiveCellImp(d.rowFrom(),d.colFrom()),r.activeSelectedRangeIndex=r.length-1;var v=r.toArray();t._raiseSelectionChanging(a,v)&&t._raiseSelectionChanged(a),null===(i=we.Ps3.collectSheetEvent)||void 0===i||i.call(we.Ps3,"ccm_sheet_content_page_click",{click:"invert_select",target:"none",count:o,duration:Date.now()-s})}}}},{key:"_extendSelectedRange",value:function(e,t){var n=this,r=n._getExtendedRange(e,t,n._activeRowIndex,n._activeColIndex);n._replaceActiveSelectedRange(r)}},{key:"_getExtendedRange",value:function(e,t,n,r,a){var o=this;Mn(n)&&(n=o._activeRowIndex),Mn(r)&&(r=o._activeColIndex);var i=o._getSpanModel(),u=i.get(n,r),s=i.get(e,t);if(a&&u.equal(s))return new Oi(u.rowFrom(),u.colFrom(),1,1,o);var l=u.union(s),c=o.getSpans();return c&&c.length>0&&(l=o._inflateRangeToCoverSpans(c,l)),l}},{key:"_replaceActiveSelectedRange",value:function(e){var t=this._selectionModel;t.length>0?t.splice(t.activeSelectedRangeIndex,1,e):t.add(e)}},{key:"_changeActiveSelectedRange",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1],n=this;if(!(n._selectionModel.length<=0)){var r=n._getActiveSelectedRange(),a=n._getKeyboardSelectedRange(r,e,t);if(a){var o=n._selectionModel.toArray();n._replaceActiveSelectedRange(a);var i=n._selectionModel.toArray();n._raiseSelectionChanging(o,i)&&n._raiseSelectionChanged(o)}}}},{key:"_getKeyboardSelectedRange",value:function(e,t,n,r,a){var o,i=this;return(0,we.vRF)(we.FHD.SELECTION_RANGE_CALC,0,{direction:TK(t),isCtrl:n?1:0}),t===we.VDZ.Left?o=n?i._searchSelectedRangebyLeftCtrl(e,!1,r,a):i._searchSelectedRangebyLeft(e,r,a):t===we.VDZ.Right?o=n?i._searchSelectedRangebyRightCtrl(e,!1,r,a):i._searchSelectedRangebyRight(e,r,a):t===we.VDZ.Up?o=n?i._searchSelectedRangebyUpCtrl(e,!1,r,a):i._searchSelectedRangebyUp(e,r,a):t===we.VDZ.Down?o=n?i._searchSelectedRangebyDownCtrl(e,!1,r,a):i._searchSelectedRangebyDown(e,r,a):t===we.VDZ.Home?o=n?i._searchSelectedRangebyHomeCtrl(e,r,a):i._searchSelectedRangebyHome(e,r,a):t===we.VDZ.End?o=n?i._searchSelectedRangebyEndCtrl(e,r,a):i._searchSelectedRangebyEnd(e,r,a):t===we.VDZ.PageUp?o=i._searchSelectedRangebyPageUp(e,r,a):t===we.VDZ.PageDown&&(o=i._searchSelectedRangebyPageDown(e,r,a)),o=function(e,t,n){return t?e instanceof Vi?new Vi(t.colFrom(),t.colCount(),n):e instanceof xi?new xi(t.rowFrom(),t.rowCount(),n):e instanceof Ni?new Ni(n):t:null}(e,o,i),(0,we.vRF)(we.FHD.SELECTION_RANGE_CALC,1),o}},{key:"_searchSelectedRangebyLeft",value:function(e,t,n){for(var r=this,a=e.rowFrom(),o=e.colFrom(),i=e.rowCount(),u=e.colCount(),s=o+u-1,l=a+i-1;s>0;)if(s--,r._canMoveCurrentTo(l,s)){var c=r._getExtendedRange(l,s,t,n),h=kK(a,c.rowFrom()),f=kK(o,c.colFrom()),d=wK(e.rowTo(),c.rowTo()),v=kK(e.colTo(),c.colTo()),g=d-h+1,m=v-f+1;if(h!==a||f!==o||g!==i||m!==u){var p=r._scrollLeftCol,y=r._activeColIndex;return o<y?f<=p&&r._scrollToCol(f):o===y&&v<=p&&r._scrollToCol(v),new Oi(h,f,g,m,r)}}return null}},{key:"_searchSelectedRangebyLeftCtrl",value:function(e,t,n,r){var a=this,o=e.rowFrom(),i=e.colFrom(),u=Mn(r)?a._activeColIndex:r,s=e.colTo(),l=a.frozenColumnCount(),c=l?a._getNextVisualColumn(l-1):a._getFirstVisualColumn(),h=t?c:a._getFirstVisualColumn();if(!Mn(h)){for(var f,d=!1,v=s>u?s:i,g=v;g>0;g--){var m,p=null!==(m=f)&&void 0!==m?m:a.hasContent(o,g),y=f=a.hasContent(o,g-1);if(g!==v||p&&(!p||y)){if(d){if(p){h=g;break}}else if(p&&!y){h=g;break}}else d=!0}a._scrollToCol(h);var C=a._getExtendedRange(o,h,n,r),_=kK(o,C.rowFrom()),R=kK(i,C.colFrom()),w=wK(e.rowTo(),C.rowTo()),k=kK(e.colTo(),C.colTo());return new Oi(_,R,w-_+1,k-R+1,a)}}},{key:"_searchSelectedRangebyRight",value:function(e,t,n){for(var r=this,a=e.rowFrom(),o=e.colFrom(),i=e.rowCount(),u=e.colCount(),s=o,l=SK(r)-1,c=e.rowTo();s<l;)if(s++,r._canMoveCurrentTo(c,s)){var h=r._getExtendedRange(c,s,t,n),f=kK(a,h.rowFrom()),d=wK(o,h.colFrom()),v=wK(e.rowTo(),h.rowTo()),g=wK(e.colTo(),h.colTo()),m=v-f+1,p=g-d+1;if(f!==a||d!==o||m!==i||p!==u){var y=r._activeColIndex;return o<y?r._scrollToCol(d):o===y&&r._scrollToCol(g),new Oi(f,d,m,p,r)}}return null}},{key:"_searchSelectedRangebyRightCtrl",value:function(e,t,n,r){for(var a,o=this,i=e.rowFrom(),u=e.colFrom(),s=Mn(r)?o._activeColIndex:r,l=e.colTo(),c=!1,h=o.getColumnCount(),f=o._getLastVisualColumn()||0,d=l>s?l:u,v=d;v<h;v++){var g,m=null!==(g=a)&&void 0!==g?g:o.hasContent(i,v),p=a=o.hasContent(i,v+1);if(v!==d||m&&(!m||p)){if(c){if(m){f=v;break}}else if(m&&!p){f=v;break}}else c=!0}o._scrollToCol(f);var y=o._getExtendedRange(i,f,n,r),C=kK(i,y.rowFrom()),_=wK(u,y.colFrom()),R=wK(e.rowTo(),y.rowTo()),w=wK(e.colTo(),y.colTo());return new Oi(C,_,R-C+1,w-_+1,o)}},{key:"_searchSelectedRangebyUp",value:function(e,t,n){for(var r=this,a=e.rowFrom(),o=e.colFrom(),i=e.rowCount(),u=e.colCount(),s=a+i-1,l=o+u-1;s>0;)if(s--,r._canMoveCurrentTo(s,l)){var c=r._getExtendedRange(s,l,t,n),h=kK(a,c.rowFrom()),f=kK(o,c.colFrom()),d=kK(e.rowTo(),c.rowTo()),v=d-h+1,g=wK(e.colTo(),c.colTo())-f+1;if(h!==a||f!==o||v!==i||g!==u){var m=r._scrollTopRow,p=r._activeRowIndex;return a<p?h<=m&&r._scrollToRow(h):a===p&&d<=m&&r._scrollToRow(d),new Oi(h,f,v,g,r)}}return null}},{key:"_searchSelectedRangebyUpCtrl",value:function(e,t,n,r){var a=this,o=e.rowFrom(),i=e.colFrom(),u=Mn(n)?a._activeRowIndex:n,s=e.rowTo(),l=a.frozenRowCount(),c=l?a._getNextVisualRow(l-1):a._getFirstVisualRow(),h=t?c:a._getFirstVisualRow();if(!Mn(h)){for(var f,d=!1,v=s>u?s:o,g=v;g>0;g--){var m,p=null!==(m=f)&&void 0!==m?m:a.hasContent(g,i),y=f=a.hasContent(g-1,i);if(g!==v||p&&(!p||y)){if(d){if(p){h=g;break}}else if(p&&!y){h=g;break}}else d=!0}a._scrollToRow(h);var C=a._getExtendedRange(h,i,n,r),_=kK(o,C.rowFrom()),R=kK(i,C.colFrom()),w=kK(e.rowTo(),C.rowTo()),k=wK(e.colTo(),C.colTo());return new Oi(_,R,w-_+1,k-R+1,a)}}},{key:"_searchSelectedRangebyDown",value:function(e,t,n){for(var r=this,a=e.rowFrom(),o=e.colFrom(),i=e.rowCount(),u=e.colCount(),s=a,l=EK(r)-1,c=o+u-1;s<l;)if(s++,r._canMoveCurrentTo(s,c)){var h=r._getExtendedRange(s,c,t,n),f=wK(a,h.rowFrom()),d=kK(o,h.colFrom()),v=wK(e.rowTo(),h.rowTo()),g=v-f+1,m=wK(e.colTo(),h.colTo())-d+1;if(f!==a||d!==o||g!==i||m!==u){var p=r._activeRowIndex;return a<p?r._scrollToRow(f):a===p&&r._scrollToRow(v),new Oi(f,d,g,m,r)}}return null}},{key:"_searchSelectedRangebyDownCtrl",value:function(e,t,n,r){for(var a,o=this,i=e.rowFrom(),u=e.colFrom(),s=Mn(n)?o._activeRowIndex:n,l=e.rowTo(),c=o.getRowCount(),h=!1,f=Number(o._getLastVisualRow()),d=l>s?l:i,v=d;v<c;v++){var g,m=null!==(g=a)&&void 0!==g?g:o.hasContent(v,u),p=a=o.hasContent(v+1,u);if(v!==d||m&&(!m||p)){if(h){if(m){f=v;break}}else if(m&&!p){f=v;break}}else h=!0}o._scrollToRow(f);var y=o._getExtendedRange(f,u,n,r),C=wK(i,y.rowFrom()),_=kK(u,y.colFrom()),R=wK(e.rowTo(),y.rowTo()),w=wK(e.colTo(),y.colTo());return new Oi(C,_,R-C+1,w-_+1,o)}},{key:"_searchSelectedRangebyHome",value:function(e,t,n){for(var r=this,a=e.rowFrom(),o=e.colFrom(),i=e.rowCount(),u=e.colCount(),s=r.frozenColumnCount()-1,l=r._activeColIndex,c=a+i-1;s<l;)if(s++,r._canMoveCurrentTo(c,s)){if(o<=s&&o+u-1===r._activeColIndex)break;var h=r._getExtendedRange(c,s,t,n),f=kK(a,h.rowFrom()),d=kK(o,h.colFrom()),v=wK(e.rowTo(),h.rowTo())-f+1,g=kK(e.colTo(),h.colTo())-d+1;return r._scrollToCol(Number(r._getFirstVisualColumn())),new Oi(f,d,v,g,r)}return null}},{key:"_searchSelectedRangebyHomeCtrl",value:function(e,t,n){var r=this._searchSelectedRangebyLeftCtrl(e,!0,t,n);if(r)return this._searchSelectedRangebyUpCtrl(r,!0,t,n)}},{key:"_searchSelectedRangebyEnd",value:function(e,t,n){for(var r=this,a=e.rowFrom(),o=e.colFrom(),i=e.rowCount(),u=e.colCount(),s=SK(r),l=r._activeColIndex,c=a+i-1;s>l;)if(s--,r._canMoveCurrentTo(c,s)){if(o+u-1>=s&&o===r._activeColIndex)break;var h=r._getExtendedRange(c,s,t,n),f=kK(a,h.rowFrom()),d=wK(o,h.colFrom()),v=wK(e.rowTo(),h.rowTo())-f+1,g=wK(e.colTo(),h.colTo())-d+1;return r._scrollToCol(r.getColumnCount()),new Oi(f,d,v,g,r)}return null}},{key:"_searchSelectedRangebyEndCtrl",value:function(e,t,n){return e=this._searchSelectedRangebyRightCtrl(e,!0,t,n),this._searchSelectedRangebyDownCtrl(e,!0,t,n)}},{key:"_searchSelectedRangebyPageUp",value:function(e,t,n){var r=this,a=e.rowFrom(),o=e.colFrom(),i=r._scrollTopRow,u=r.prePage(),s=-1;i!==r._scrollTopRow?s=Number(r._getNextVisualRow(a+r._scrollTopRow-i)):r.frozenRowCount()<=0&&(s=Number(r._getFirstVisualRow())),s<r._scrollTopRow?s=r._scrollTopRow:s>=u.row+u.rowCount&&(s=Number(r._getPrevVisualRow(u.row+u.rowCount)));var l=r._getExtendedRange(s,o,t,n),c=kK(a,l.rowFrom()),h=kK(o,l.colFrom()),f=kK(e.rowTo(),l.rowTo()),d=wK(e.colTo(),l.colTo());return new Oi(c,h,f-c+1,d-h+1,r)}},{key:"_searchSelectedRangebyPageDown",value:function(e,t,n){var r,a,o,i,u=this,s=e.rowFrom(),l=e.colFrom(),c=u.nextPage(),h=Number(u._getNextVisualRow(c.row));h<u._scrollTopRow?h=u._scrollTopRow:h>=c.row+c.rowCount&&(h=Number(u._getPrevVisualRow(c.row+c.rowCount)));var f=u._getExtendedRange(h,l,t,n);return r=wK(s,f.rowFrom()),a=kK(l,f.colFrom()),o=wK(e.rowTo(),f.rowTo()),i=wK(e.colTo(),f.colTo()),new Oi(r,a,o-r+1,i-a+1,u)}},{key:"_getLastVisualRow",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:3,t=EK(this,e);return 3!==e&&2!==e||(t=t),this._getPrevVisualRow(t,e)}},{key:"_getLastVisualColumn",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:3,t=SK(this,e);return 3!==e&&1!==e||(t=t),this._getPrevVisualColumn(t,e)}},{key:"_inflateRangeToCoverSpans",value:function(e,t){if(e)for(var n=0,r=e.length;n<r;n++){var a=e[n];if(t.intersect(a)){e.splice(n--,1);var o=t.union(a);if(t.contain(o)){r--;continue}return this._inflateRangeToCoverSpans(e,o)}}return t}},{key:"_getActiveSelectedRange",value:function(e){var t=this._selectionModel,n=t.length,r=new Ni(this);return n<=0||(3===e?(t.activeSelectedRangeIndex--,t.activeSelectedRangeIndex<0&&(t.activeSelectedRangeIndex=n-1)):4===e&&(t.activeSelectedRangeIndex++,t.activeSelectedRangeIndex>=n&&(t.activeSelectedRangeIndex=0)),t.activeSelectedRangeIndex>=0&&(r=t[t.activeSelectedRangeIndex])),r}},{key:"rangeStringToRange",value:function(e){return Xk(this,e)}},{key:"selectAll",value:function(){this.setSelection(new Ni(this))}},{key:"isTabNavigation",set:function(e){this._isTabNavigation=e}}]),e}(),VK=Xk,NK=function(){function e(){(0,y.Z)(this,e)}return(0,C.Z)(e,[{key:"getFormatCode",value:function(e,t){var n=this.getActualFormatter(e,t);return n&&n.getFormatCode()}}]),e}(),OK=function(e){return null==e},xK=function(){function e(){(0,y.Z)(this,e)}return(0,C.Z)(e,[{key:"_setComments",value:function(e,t,n,r){if(0!==(r=OK(r)?3:r)){this._getModel().setComment(e,t,n);var a=this.id();this.dispatch("CommentChanged",{row:e,col:t,comments:n,type:0,sheet_id:a})}return null}},{key:"getComments",value:function(e,t,n){var r=this._getModel();return r&&r.getComment(e,t)||null}},{key:"getAllComments",value:function(e){var t=this._getModel();if(!t)return[];var n=[];return t.iterCommentWithPos(0,0,this.getRowCount(),this.getColumnCount()).forEach((function(e){if(e){var t=(0,p.Z)(e,2),r=t[0],a=t[1];r&&n.push({row:a.row,col:a.col,comments:r})}})),n.sort((function(e,t){return e.row===t.row?e.col-t.col:e.row-t.row})),n}},{key:"findComment",value:function(e){return this.getAllComments().find((function(t){return t.comments.some((function(t){return t.id===e}))}))}},{key:"setHoverComment",value:function(e,t,n){this._commentHoverResult={row:e,col:t,rowCount:1,colCount:1},this.notifyShell(50,{row:e,col:t})}},{key:"getHoverComment",value:function(){return this._commentHoverResult?Object.assign({},this._commentHoverResult):null}},{key:"getHoverCellComment",value:function(e,t){return!!this._commentHoverResult&&this._commentHoverResult.row===e&&this._commentHoverResult.col===t}},{key:"clearHoverComment",value:function(){this._commentHoverResult=null,this.notifyShell(51)}},{key:"clearAllComments",value:function(){var e=this;this.getAllComments().forEach((function(t){e._setComments(t.row,t.col,null)})),this.notifyShell(51)}},{key:"addActiveComment",value:function(e,t,n){this._commentActiveResult||(this._commentActiveResult={}),this._commentActiveResult[e+"_"+t]={row:e,col:t,rowCount:1,colCount:1},this._activeCommentId=n;var r=this.id();this.dispatch("CommentChanged",{row:e,col:t,type:1,sheet_id:r,commentId:n})}},{key:"getActiveCommentId",value:function(){return this._activeCommentId}},{key:"addActiveCommentById",value:function(e){var t=this.findComment(e);t&&this.addActiveComment(t.row,t.col,e)}},{key:"getActiveComment",value:function(e,t){return this._commentActiveResult?this._commentActiveResult[e+"_"+t]:null}},{key:"getActiveComments",value:function(){var e=[],t=this._commentActiveResult;return t?(Object.keys(t).forEach((function(n){if(t.hasOwnProperty(n)){var r=t[n];e.push(r)}})),e):e}},{key:"removeActiveComment",value:function(e,t,n){this._commentActiveResult||(this._commentActiveResult={});var r=e+"_"+t,a=this._commentActiveResult;a[r]&&(delete a[r],this._activeCommentId=null);var o=this.id();this.dispatch("CommentChanged",{row:e,col:t,type:2,sheet_id:o})}},{key:"clearActiveComment",value:function(){this._commentActiveResult={},this._activeCommentId=null;var e=this.id();this.dispatch("CommentChanged",{type:3,sheet_id:e})}},{key:"shouldShowCommentPanel",value:function(e,t){var n,r=arguments.length>2&&void 0!==arguments[2]&&arguments[2],a=arguments.length>3&&void 0!==arguments[3]&&arguments[3],o=e.getActiveSheet();if(!o)return!1;var i=!!o.floatImageModel.activeFloatImageIds.length,u=!(null!=t&&t.eventTargetSource)||we.ned[null===(n=t.eventTargetSource)||void 0===n?void 0:n.type],s=t&&"MENTION_CLICK"===t.source;return!(r||a||t&&"range-selector"===t.source||s||i||e.isRangeSelecting||!u)}}]),e}(),ZK=vr._Types,DK=null,PK=ZK._isNullOrUndefined,LK=ZK._toDouble,BK="number",UK="date";function HK(e){return"string"!=typeof e&&ZK._isNumber(e)}function WK(e){var t=[e];return t.rowCount=1,t.colCount=e&&e.length,t}function jK(e){return e}function zK(e,t,n,r){var a=WK(t),o=WK(n),i=WK([r]),u=e?vr._trend(a,o,i,!0,jK,DK,DK,DK):vr._growth(a,o,i,!0,DK,DK,DK),s=u&&u[0][0];return(0,_.Z)(s)===BK&&s.toString().length>=13?+s.toPrecision(13):s}function GK(e){var t=this;t._indexes=[],t._innerValues=[],t._type=DK,t._startIndex=PK(e)?-1:e}!function(e){e[e.copyCells=0]="copyCells",e[e.fillSeries=1]="fillSeries",e[e.fillFormattingOnly=2]="fillFormattingOnly",e[e.fillWithoutFormatting=3]="fillWithoutFormatting",e[e.clearValues=4]="clearValues",e[e.auto=5]="auto"}(IK||(IK={})),function(e){e[e.Left=0]="Left",e[e.Right=1]="Right",e[e.Up=2]="Up",e[e.Down=3]="Down"}(bK||(bK={})),GK.prototype={_dataCount:function(){return this._innerValues&&this._innerValues.length},_values:function(){var e,t,n=this,r=[],a=n._innerValues;for(e=0;e<a.length;e++)t=a[e],r.push("object"===n._type?n._toDateTime(t):t);return r},_indexes2:function(){var e=this._indexes;if(e&&e.length>0){var t,n=this._startIndex,r=[];for(-1===n&&(n=e[0]),t=0;t<e.length;t++)r[t]=e[t]-n+1;return r}return DK},_values2:function(){var e=this._innerValues;return e&&e.length?e:DK},_add:function(e,t){var n=this;PK(n._type)&&(t instanceof Date?n._type=UK:n._type=BK),n._indexes.push(e),n._innerValues.push(LK(t))},_toActualValue:function(e){return this._type===UK?this._toDateTime(e):e},_toDateTime:function(e){var t=DK;return e instanceof Date&&(t=e),t}},function(e){e[e.vertical=0]="vertical",e[e.horizontal=1]="horizontal"}(FK||(FK={}));var JK=function(){function e(t,n){(0,y.Z)(this,e),this._sheet=t,this.fillCb=n}return(0,C.Z)(e,[{key:"fillAuto",value:function(e,t,n){var r=arguments.length>3&&void 0!==arguments[3]&&arguments[3],a=arguments.length>4&&void 0!==arguments[4]&&arguments[4],o=e.rowFrom(),i=e.colFrom(),u=e.rowCount(),s=e.colCount(),l=t.rowFrom(),c=t.colFrom(),h=!(o<l||i<c);return this._autoFillRange(t,u,s,n,r,h,a)}},{key:"_autoFillRange",value:function(e,t,n,r,a,o,i){var u=o?1:-1,s=e.rowFrom(),l=e.colFrom(),c=e.rowCount(),h=e.colCount();if(1===r){var f=Math.floor(n/h),d=n%h;if(!a)for(var v=1;v<f;v++){var g=new Oi(s,l+v*u*h,c,h,this._sheet);this._copyRange(e,g,r,4,a,!1,0,0,!1,i)}if(a&&f>1&&0===d&&(f-=1,d=h),f>0&&d>0){var m=new Oi(s,o?l+f*h:l-f*h+h-d,c,d,this._sheet);return this._copyRange(e,m,r,4,a,o,0,o?0:h-d,!1,i)}}else{var p=Math.floor(t/c),y=t%c;if(!a)for(var C=1;C<p;C++){var _=new Oi(s+C*u*c,l,c,h,this._sheet);this._copyRange(e,_,r,4,a,!1,0,0,!0,i)}if(a&&p>1&&0===y&&(p-=1,y=c),p>0&&y>0){var R=new Oi(o?s+p*c:s-p*c+c-y,l,y,h,this._sheet);return this._copyRange(e,R,r,4,a,o,o?0:c-y,0,!0,i)}}}},{key:"_copyRange",value:function(e,t,n,r,a,o,i,u,s,l){for(var c,h=1===n,f=h?e.rowFrom():e.colFrom(),d=h?e.colFrom():e.rowFrom(),v=h?t.rowFrom():t.colFrom(),g=h?t.colFrom():t.rowFrom(),m=h?e.rowCount():e.colCount(),p=h?e.colCount():e.rowCount(),y=h?t.colCount():t.rowCount(),C=this._sheet,_=null,R=0;R<m;R++){for(var w=DK,k=DK,S=0,E=f+R,T=v+R,A=E,I=T,b=(h?u:i)||0,F=h?0:b,M=!h&&s;S<p;){var V=d+S,N=g+S-b,O=DK,x=V,Z=N;h||(E=[V,V=A][0],T=[N,N=I][0]),_=C._getSpanModel().find(E,V);var D=!1;if(C.hasFormula(E,V))D=!0;else if(C.isProxyArrayFormula(E,V))O=null;else{var P=C.getMultipleValues(E,V);if(P)O=P;else O=C.getSegmentArray(E,V)||C.getValue(E,V)}if(4===r&&HK(O)){w||(w=new GK);var L=O instanceof Date?UK:BK;if(k||(k=L),k===L){w._add(x,O),_?S+=h?_.colCount():_.rowCount():S++;continue}}if(O&&w&&w._dataCount()){if(c=this._autoFillTrendValues(h,e,t,A,I,w,a,o,F,M,l),a&&c)return c;w=DK,k=DK}else{if(!_||_&&(h?_.rowFrom():_.colFrom())===A){var B=Z===g+y-1;if(a){if(_&&B||!_&&(B&&o||!o&&Z===g))return O instanceof dm?O:Array.isArray(O)?C.getValue(E,V):O}else Z<g+y&&Z>=g&&(h||!h&&!(s&&C._isRowFilterOut&&C._isRowFilterOut(Z)))&&this._executeFillCell(C,E,V,T,N,O,r,l,D)}_?S+=h?_.colCount():_.rowCount():S++}}if(w&&w._dataCount()&&(c=this._autoFillTrendValues(h,e,t,A,I,w,a,o,F,M,l),a&&c))return c}return DK}},{key:"_executeFillCell",value:function(e,t,n,r,a,o,i,u){var s=arguments.length>8&&void 0!==arguments[8]&&arguments[8];this.fillCb&&this.fillCb(e,t,n,r,a,o,i,u,s)}},{key:"_autoFillTrendValues",value:function(e,t,n,r,a,o,i,u,s,l,c){var h,f,d,v,g=this,m=g._sheet,p=e?n.colFrom():n.rowFrom(),y=e?t.colFrom():t.rowFrom(),C=e?n.colCount():n.rowCount(),_=e?t.colCount():t.rowCount();s=s||0;var R=o._dataCount(),w=(p-y-s)/_,k=g._isArithmeticProgression(o._indexes,o._innerValues);if(k){for(d=[],f=0;f<R;f++)d[f]=f+1;h=R}else v=o._indexes[0],h=o._indexes[R-1]-v+1,1===R&&o._add(o._indexes[0]+1,o._toActualValue(o._innerValues[0]+1)),d=o._indexes2();for(f=0;f<h;f++){var S=zK(!0,o._values2(),d,h*w+f+1),E=p+C-1,T=k?o._indexes[f]:v+f,A=T+w*_;if(i){if(k&&(u&&A===E||!u&&A===p)||!k&&A+s===E)return o._toActualValue(S)}else A<p+C&&A>=p&&(e?g._executeFillCell(m,r,T,a,A,o._toActualValue(S),4,c):l&&m._isRowFilterOut&&m._isRowFilterOut(A)||g._executeFillCell(m,T,r,A,a,o._toActualValue(S),4,c))}return DK}},{key:"_isArithmeticProgression",value:function(e,t){var n=t&&t.length;if(n<=1||(e&&e.length)!==n)return!1;var r,a=e[1]-e[0],o=t[1]-t[0];for(r=2;r<n;r++)if(e[r]-e[r-1]!==a||t[r]-t[r-1]!==o)return!1;return!0}}]),e}(),qK=vr._Types._isNullOrUndefined;var $K=function(){function e(){(0,y.Z)(this,e)}return(0,C.Z)(e,[{key:"fillAuto",value:function(e,t,n){if(!t)throw new Error("range is null");var r=n.series,a=n.direction,o=n.withTag,i=new JK(this);(function(e,t,n,r){return!!(e&&t&&t.contain(e))&&(!qK(n)&&(1===n&&e.rowFrom()===t.rowFrom()&&e.rowCount()===t.rowCount()||0===n&&e.colFrom()===t.colFrom()&&e.colCount()===t.colCount())||!(qK(r)||(2!==r&&3!==r||e.colFrom()!==t.colFrom()||e.colCount()!==t.colCount())&&(0!==r&&1!==r||e.rowFrom()!==t.rowFrom()||e.rowCount()!==t.rowCount())))})(e,t,a?null:r,a)&&i.fillAuto(t,e,r,!1,o)}}]),e}(),YK=function(){function e(){(0,y.Z)(this,e)}return(0,C.Z)(e,[{key:"getAllMentionsInSheet",value:function(){var e=this,t=this._getModel();if(!t)return[];var n=[];return t.iterContentWithPos(0,0,this.getRowCount(),this.getColumnCount()).forEach((function(t){var r=(0,p.Z)(t,2),a=r[0],o=r[1],i=null==a?void 0:a.segmentArray;i&&i.forEach((function(t){"mention"===t.type&&n.push({sheetId:e.id(),row:o.row,col:o.col,mentionId:t.mentionId,other:t})}))})),n.sort((function(e,t){return e.row===t.row?e.col-t.col:e.row-t.row})),n}},{key:"updateHighlightCellCfg",value:function(e,t,n){if(n&&this._highlightCells){var r=this.getHighlightCell(e,t);this._highlightCells.set(e,t,Object.assign({},"object"!=(0,_.Z)(r)?{}:r,{},n))}}},{key:"getHighlightCell",value:function(e,t){return!(!this._highlightCells||!this._highlightCells.size)&&this._highlightCells.get(e,t)}},{key:"hasHighLightCell",value:function(){return!!this._highlightCells&&this._highlightCells.size>0}}]),e}(),KK=vr._Types._isNullOrUndefined,XK=function(){function e(){(0,y.Z)(this,e)}return(0,C.Z)(e,[{key:"_tabMoveCell",value:function(e,t,n){var r=this;void 0===t&&(t=r._activeRowIndex),void 0===n&&(n=r._activeColIndex),2===e?(void 0!==r._firstTabCol&&we.Ps3.collectSuiteEvent("sheet_opration",{action:"tab_enter_next_row"}),r._moveActiveCellDown(t,n,!1,r._firstTabCol)):3===e?r._moveActiveCellLeft(t,n,!0):4===e&&r._tabMoveCellRight(t,n,!0),r._moveActiveCellEnd()}},{key:"_moveActiveCell",value:function(e,t,n,r){var a=this;KK(n)&&(n=a._activeRowIndex),KK(r)&&(r=a._activeColIndex),3===e?a._moveActiveCellLeft(n,r,t):4===e?a._moveActiveCellRight(n,r,t):1===e?a._moveActiveCellUp(n,r,t):2===e?a._moveActiveCellDown(n,r,t):5===e?a._moveActiveCellFirst():6===e&&a._moveActiveCellLast(),a._moveActiveCellEnd()}},{key:"_moveActiveCellEnd",value:function(){var e=this,t=e._selectionModel,n=t.toArray();e._isNavigateInSelection||e._clearSelectionImp();var r=e._activeRowIndex,a=e._activeColIndex,o=e._getSpanModel().get(r,a);if(e._activeRowCount=o.rowCount(),e._activeColCount=o.colCount(),!e._isNavigateInSelection){var i=e._getExtendedRange(r,a);e._replaceActiveSelectedRange(i);var u=t.toArray();e._raiseSelectionChanging(n,u)&&e._raiseSelectionChanged(n)}e._scrollByMoveCell(r,a);var s={sheet:e,sheetName:e._name,row:r,col:a};e._trigger(we.zW2.EnterCell,s)}}]),e}(),QK=function(){function e(){(0,y.Z)(this,e)}return(0,C.Z)(e,[{key:"getReminderPosById",value:function(e){var t=this._getModel();if(!t)return null;for(var n=t.iterReminderWithPos(0,0,this.getRowCount(),this.getColumnCount()),r=n.next();null!==r;r=n.next())if(r){var a=r,o=(0,p.Z)(a,2),i=o[0],u=o[1];if(i.id===e)return u}return null}}]),e}(),eX=function(){function e(){(0,y.Z)(this,e)}return(0,C.Z)(e,[{key:"hasApply2AllHighlightCell",value:function(){return!!this._dropdownApply2AllHighlightCell&&this._dropdownApply2AllHighlightCell.size>0}},{key:"getApply2AllHighlightCell",value:function(e,t){return this._dropdownApply2AllHighlightCell&&this._dropdownApply2AllHighlightCell.size&&this._dropdownApply2AllHighlightCell.get(e,t)||!1}}]),e}();function tX(e,t,n){var r=n.value;return n.value=function(){var e;return!(null!=this&&null!==(e=this.options)&&void 0!==e&&e.isProtected)&&r.apply(this,arguments)},n}var nX=function(){function e(){(0,y.Z)(this,e)}var t;return(0,C.Z)(e,[{key:"dataSplit",value:function(e,t,n,r,a,o,i,u,s,l,c){return this._executeCmdBase(we.rvF.DATA_SPLIT,{startRow:e,startCol:t,rowCount:n,colCount:r,spans:a,splitData:o,addColCount:i,extendFilterTargetRange:u,hideCount:s,format:l,realColCount:c})}},{key:"addChart",value:function(e,t){return this._executeCmdBase(we.rvF.SET_CHART,{commandType:0,chartId:e,data:t})}},{key:"addCheckbox",value:function(e){return this._executeCmdBase(we.rvF.SET_CHECKBOX_VALIDATION,{selections:e,dataValidationJSON:{type:"checkbox",formulas:[1,0],options:{handledWayOnInvalidData:1}}})}},{key:"setDataValidationAPI",value:function(e,t,n,r){return this._executeCmdBase(we.rvF.SET_DATA_VALIDATION,{activeCell:e,selections:t,dataValidationJSON:n,needApplyToAll:r})}},{key:"setDateTimeValidation",value:function(e,t,n,r){return this._executeCmdBase(we.rvF.SET_DATE_TIME_VALIDATION,{activeCell:e,selections:t,dataValidationJSON:n,needApplyToAll:r})}},{key:"addConditionalFormat",value:function(e){return this._executeCmdBase(we.rvF.SET_CONDITIONAL_FORMAT,{commandType:"add",data:e})}},{key:"moveConditionalFormat",value:function(e,t){return this._executeCmdBase(we.rvF.SET_CONDITIONAL_FORMAT,{commandType:"move",data:{oldIndex:e,newIndex:t}})}},{key:"addFilter",value:function(e){return this._executeCmdBase(we.rvF.SET_FILTER,{range:e,col:null,value:null})}},{key:"addFilterView",value:function(e,t){return this._executeCmdBase(we.rvF.ADD_VIEW,{isLocal:e,value:t})}},{key:"addFloatImage",value:function(e){return this._executeCmdBase(we.rvF.SET_FLOAT_IMAGE,{commandType:0,data:e})}},{key:"addReminder",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:this.getSelections(),n=arguments.length>2?arguments[2]:void 0;return!t||0===t.length||!e||this._executeCmdBase(we.rvF.ADD_REMINDER,{selections:t,data:e,source:n})}},{key:"setColumnsSize",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]&&arguments[2];return this._executeCmdBase(we.rvF.AUTO_FIT_COLUMN,{columns:e,size:t,isLocal:n})}},{key:"autoFitRow",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];return this._executeCmdBase(we.rvF.AUTO_FIT_ROW,{rows:e,isLocal:t})}},{key:"clearFormatting",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:this.getSelections();return this._executeCmdBase(we.rvF.DO_CLEAR,{ranges:e})}},{key:"clearRangeConditionalFormat",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"clear-duplicate-values";return this._executeCmdBase(we.rvF.SET_CONDITIONAL_FORMAT,{commandType:"clearRange",ranges:e,source:t})}},{key:"clearPivotTables",value:function(){var e,t=this,n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:this.getSelections(),r=arguments.length>1?arguments[1]:void 0,a=this.getPivotTableManager();if(!a.hasPivotTable())return!0;var o,i=[],u=_n(n);try{for(u.s();!(o=u.n()).done;){var s=o.value;if(r)(0,we.hTd)(i,wk(this,s));else{var l,c=_k(this,s.rowFrom(),s.colFrom(),s.rowCount(),s.colCount()),h=_n(c);try{for(h.s();!(l=h.n()).done;){var f=l.value,d=a.getPositionCell(f),v=d.row,g=d.col;if(!s.containCell(v,g))return we.Ps3.Toast.warning({key:"cannotDeletePivotTable",content:fn("CreationDoc_Sheets_PivotTable_Failed_CanNotEditPivot")}),!1;i.push(f)}}catch(e){h.e(e)}finally{h.f()}}}}catch(e){u.e(e)}finally{u.f()}return i.forEach((function(e){t.delEmbeddedBlock({blockType:xt.kH.PIVOT_TABLE,blockToken:e,reserveDepRanges:!1})})),i.length>0&&null!==(e=we.Ps3.collectSheetEvent)&&void 0!==e&&e.call(we.Ps3,"ccm_sheet_content_page_click",{click:"delete_data_pivotd",target:"none"}),!0}},{key:"clearValues",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:this.getSelections(),t=arguments.length>1?arguments[1]:void 0;if(!t&&!this.clearPivotTables(e))return!1;var n=e.filter((function(e){return e&&Ri(e)&&!e.isValidBoundaryInsideSheet()}));if(n.length>0){var r=this.getRowCount(),a=this.getColumnCount();we.Ps3.collectSuiteEvent("client_sheet_path_tracker_dev",{trace_code:19,info:"clearValues range invalid ".concat(n.map((function(e){return e.toGridJSON&&JSON.stringify(e.toGridJSON())})).join("|")," maxRowCount:").concat(r," maxColCount:").concat(a)})}return this._executeCmdBase(we.rvF.CLEAR_VALUES,{ranges:e})}},{key:"formatPivotTableRange",value:function(e,t,n,r,a,o,i){return this._executeCmdBase(we.rvF.FORMAT_PIVOT_TABLE_RANGE,{ranges:e,pivotTableName:t,shouldAutoFitCol:r,shouldClear:n,addRowCount:a,addColCount:o,dontAddToCommandStack:i})}},{key:"clearValuesAndFormatting",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:this.getSelections();return this._executeCmdBase(we.rvF.CLEAR_VALUES_STYLE,{ranges:e})}},{key:"clearNotes",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:this.getSelections();return this._executeCmdBase(we.rvF.CLEAR_NOTES,{ranges:e})}},{key:"clearDataValidation",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:this.getSelections(),t=this.getActiveCellIndex();return this._executeCmdBase(we.rvF.SET_DATA_VALIDATION,{selections:e,activeCell:{row:t.row,col:t.column},needApplyToAll:!1,dataValidationJSON:null})}},{key:"clearDateValidation",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:this.getSelections(),t=this.getActiveCellIndex();return this._executeCmdBase(we.rvF.SET_DATE_TIME_VALIDATION,{selections:e,activeCell:{row:t.row,col:t.column},needApplyToAll:!1,dataValidationJSON:null})}},{key:"delChart",value:function(e){return this._executeCmdBase(we.rvF.SET_CHART,{commandType:2,chartId:e})}},{key:"delConditionalFormat",value:function(e){return this._executeCmdBase(we.rvF.SET_CONDITIONAL_FORMAT,{commandType:"del",cfIds:e})}},{key:"delFilter",value:function(){return this._executeCmdBase(we.rvF.SET_FILTER,{range:null,col:null,value:null})}},{key:"delFilterView",value:function(e,t){return this._executeCmdBase(we.rvF.DEL_VIEW,{value:{viewName:t,viewId:e}})}},{key:"transFilterView",value:(t=(0,u.Z)(i().mark((function e(t,n,r){return i().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this._executeCmdBase(we.rvF.ADD_VIEW_NOT_UNDO,{isLocal:!1,value:r})&&this._executeCmdBase(we.rvF.DEL_VIEW_NOT_UNDO,{value:{viewName:n,viewId:t}}));case 1:case"end":return e.stop()}}),e,this)}))),function(e,n,r){return t.apply(this,arguments)})},{key:"delFloatImage",value:function(e){return this._executeCmdBase(we.rvF.SET_FLOAT_IMAGE,{commandType:2,floatImageIds:e})}},{key:"delReminder",value:function(e,t,n){return this._executeCmdBase(we.rvF.SET_REMINDER,{row:e,col:t,reminder:null,cellValue:n})}},{key:"formatPainter",value:function(e,t){return t.conditionFormat&&QE(t.conditionFormat,"format_painter"),this._executeCmdBase(we.rvF.FORMAT_PAINTER,Object.assign({},e,{},t))}},{key:"freeze",value:function(e,t){var n=this.inject(Ft.f3);return!(!n.protectionPermission.curSheetEditable||!n.sheetBusinessEditable)&&this._executeCmdBase(we.rvF.FREEZE_SHEET,{target:{row:e,col:t}})}},{key:"enterFilterView",value:function(e){return this._executeCmdBase(we.rvF.ENTER_VIEW,{value:{view_id:e}})}},{key:"exitFilterView",value:function(){return this._executeCmdBase(we.rvF.EXIT_VIEW)}},{key:"mergeCells",value:function(e){return this._executeCmdBase(we.rvF.MERGE_CELLS,{ranges:e,isMerge:!0})}},{key:"splitCells",value:function(e){return this._executeCmdBase(we.rvF.MERGE_CELLS,{ranges:e,isMerge:!1})}},{key:"moveRange",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};return this._executeCmdBase(we.rvF.MOVE_RANGE,{fromRow:e.row,fromCol:e.col,rowCount:e.rowCount,colCount:e.colCount,toRow:t.row,toCol:t.col,isRowMove:n.isRowMove,isColMove:n.isColMove})}},{key:"protectCol",value:function(e,t,n,r,a){return this._executeCmdBase(we.rvF.LOCK_COL,{col:e,colCount:t,lockInfo:n,permId:r,creatorId:a})}},{key:"protectRow",value:function(e,t,n,r,a){return this._executeCmdBase(we.rvF.LOCK_ROW,{row:e,rowCount:t,lockInfo:n,permId:r,creatorId:a})}},{key:"resizeCol",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]&&arguments[2];return this._executeCmdBase(we.rvF.RESIZE_COLUMN,{columns:e,size:t,isLocal:n})}},{key:"resizeRow",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]&&arguments[2];return this._executeCmdBase(we.rvF.RESIZE_ROW,{rows:e,size:t,isLocal:n})}},{key:"setCellSegmentArray",value:function(e,t,n){var r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{},a=r.autoFormat,o=void 0!==a&&a,i=r.from,u=r.dontAddToCommandStack,s=void 0!==u&&u;return this._executeCmdBase(we.rvF.EDIT_CELL,{row:e,col:t,newSegmentArray:n,autoFormat:o,from:i,dontAddToCommandStack:s})}},{key:"setCellValue",value:function(e,t,n,r,a){return this._executeCmdBase(we.rvF.EDIT_CELL,{row:e,col:t,newValue:n,autoFormat:r,newSegmentArray:a})}},{key:"setCellValueByDataValidation",value:function(e,t,n,r,a,o){return this._executeCmdBase(we.rvF.SET_VALUE_BY_DATA_VALIDATION,{sheetId:this.id(),sheetName:this.name(),row:e,col:t,text:n,isMultiple:r,formula:a,formulaVar:o})}},{key:"setCellNote",value:function(e,t,n){return this._executeCmdBase(we.rvF.SET_CELL_NOTE,{sheetId:this.id(),sheetName:this.name(),row:e,col:t,note:n})}},{key:"setChart",value:function(e,t){return this._executeCmdBase(we.rvF.SET_CHART,{commandType:1,chartId:e,data:t})}},{key:"setComments",value:function(e,t,n){return this._executeCmdBase(we.rvF.SET_COMMENTS,{target:{row:e,col:t},value:{comments:n}})}},{key:"setConditionalFormat",value:function(e,t){return this._executeCmdBase(we.rvF.SET_CONDITIONAL_FORMAT,{commandType:"set",cfId:e,data:t})}},{key:"setFilter",value:function(e,t,n){return this._executeCmdBase(we.rvF.SET_FILTER,{range:e,col:t,value:n})}},{key:"setFilterView",value:function(e,t,n){var r=n.range,a=n.col,o=n.value;return this._executeCmdBase(we.rvF.SET_FILTER_VIEW,{viewId:e,isLocal:t,range:r,col:a,value:o})}},{key:"setFloatImage",value:function(e){return this._executeCmdBase(we.rvF.SET_FLOAT_IMAGE,{commandType:1,data:e})}},{key:"setFontStyle",value:function(e,t,n,r){return this._executeCmdBase(we.rvF.SET_STYLE_FONT,{prop:t,value:n,selections:e,isIncrease:r})}},{key:"setFormatter",value:function(e,t){return this._executeCmdBase(we.rvF.SET_FORMATTER,{selections:e,value:t})}},{key:"setTextDecoration",value:function(e,t,n){return this._executeCmdBase(we.rvF.SET_TEXT_DECORATION,{selections:e,active:n,flag:t})}},{key:"setRangeStyle",value:function(e,t,n){return this._executeCmdBase(we.rvF.SET_RANGE_STYLE,{prop:t,value:n,selections:e})}},{key:"setRangeValue",value:function(e,t){return this._executeCmdBase(we.rvF.MODIFY_VALUES,{ranges:e,getValueFn:t})}},{key:"setReminder",value:function(e,t,n,r){return this._executeCmdBase(we.rvF.SET_REMINDER,{row:e,col:t,reminder:n,cellValue:r})}},{key:"sortRange",value:function(e,t,n){return this._executeCmdBase(we.rvF.SORT_RANGE,{target:e,sortConditions:t,sortType:n})}},{key:"moveRowCol",value:function(e,t){return this._executeCmdBase(we.rvF.MOVE_ROW_COL,{sourceRg:e,targetRg:t})}},{key:"unfreeze",value:function(e,t){return this._executeCmdBase(we.rvF.FREEZE_SHEET,{target:{row:0,col:0}})}},{key:"addFloatBlock",value:function(e){return this._executeCmdBase(we.rvF.SET_FLOAT_BLOCK,{commandType:0,data:e})}},{key:"setFloatBlock",value:function(e){return this._executeCmdBase(we.rvF.SET_FLOAT_BLOCK,{commandType:1,data:e})}},{key:"delFloatBlock",value:function(e){return this._executeCmdBase(we.rvF.SET_FLOAT_BLOCK,{commandType:2,data:e})}},{key:"addEmbeddedBlock",value:function(e){return this._executeCmdBase(we.rvF.SET_EMBEDDED_BLOCK,{commandType:0,data:e})}},{key:"setEmbeddedBlock",value:function(e){return this._executeCmdBase(we.rvF.SET_EMBEDDED_BLOCK,{commandType:1,data:e})}},{key:"delEmbeddedBlock",value:function(e){return this._executeCmdBase(we.rvF.SET_EMBEDDED_BLOCK,{commandType:2,data:e})}},{key:"fill",value:function(e,t,n,r){return this._executeCmdBase(we.rvF.FILL,{startRange:e,fillRange:t,autoFillType:n,fillDirection:r})}},{key:"fillRange",value:function(e,t){return this._executeCmdBase(we.rvF.FILL_RANGE,{startRange:e,fillRanges:t})}},{key:"horizontalFill",value:function(e,t){return this._executeCmdBase(we.rvF.HORIZONTAL_FILL,{startRange:e,fillRange:t})}},{key:"unprotectCol",value:function(e){return this._executeCmdBase(we.rvF.UNLOCK_COL,{permId:e})}},{key:"unprotectRow",value:function(e){return this._executeCmdBase(we.rvF.UNLOCK_ROW,{permId:e})}},{key:"verticalFill",value:function(e,t){return this._executeCmdBase(we.rvF.VERTICAL_FILL,{startRange:e,fillRange:t})}},{key:"hideRow",value:function(e){return this._executeCmdBase(we.rvF.SET_ROW_COL_VISIBLE,{ranges:e,action:"hideRow"})}},{key:"unhideRow",value:function(e){return this._executeCmdBase(we.rvF.SET_ROW_COL_VISIBLE,{ranges:e,action:"unhideRow"})}},{key:"hideCol",value:function(e){return this._executeCmdBase(we.rvF.SET_ROW_COL_VISIBLE,{ranges:e,action:"hideCol"})}},{key:"unhideCol",value:function(e){return this._executeCmdBase(we.rvF.SET_ROW_COL_VISIBLE,{ranges:e,action:"unhideCol"})}},{key:"delRow",value:function(e){var t=this,n=[],r=[],a=!1;return(e=Fh(e)).forEach((function(e){var o=e.target,i=e.count;!i||i<=0||o<0?a=!0:(n.push({type:"row",method:"del",target:o,count:i}),r.push(new xi(o,i,t)))})),!a&&this._executeCmdBase(we.rvF.SET_ROW_COL_CHANGE,{type:"row",method:"del",ranges:n})}},{key:"delCol",value:function(e){var t=this,n=[],r=[],a=!1;return(e=Fh(e)).forEach((function(e){var o=e.target,i=e.count;!i||i<=0||o<0?a=!0:(n.push({type:"col",method:"del",target:o,count:i}),r.push(new Vi(o,i,t)))})),!a&&this._executeCmdBase(we.rvF.SET_ROW_COL_CHANGE,{type:"col",method:"del",ranges:n})}},{key:"addRow",value:function(e,t,n){var r=[],a=!1;return n.forEach((function(n){var o,i,u=n.target,s=n.count;!t||t<=0||u<0?a=!0:("up"===e?(o=u,i=u):i=(o=u+s)-1,r.push({type:"row",method:"add",target:o,count:t,source:i,size:n.size}))})),!a&&this._executeCmdBase(we.rvF.SET_ROW_COL_CHANGE,{type:"row",method:"add",direction:e,ranges:r})}},{key:"addCol",value:function(e,t,n){var r=[],a=!1;return n.forEach((function(n){var o,i,u=n.target,s=n.count;!t||t<=0||u<0?a=!0:("left"===e?(o=u,i=u):i=(o=u+s)-1,r.push({type:"col",method:"add",target:o,count:t,source:i,size:n.size}))})),!a&&this._executeCmdBase(we.rvF.SET_ROW_COL_CHANGE,{type:"col",method:"add",direction:e,ranges:r})}},{key:"_executeCmdBase",value:function(e){var t,n,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},a=arguments.length>2?arguments[2]:void 0;return null!==(t=null===(n=this._commandManager())||void 0===n?void 0:n.execute(Object.assign({cmd:e,sheetId:this.id(),sheetName:this.name()},r),a))&&void 0!==t&&t}}]),e}();function rX(e,t){Object.getOwnPropertyNames(t.prototype).forEach((function(n){if("constructor"!==n){var r=Object.getOwnPropertyDescriptor(t.prototype,n);r&&Object.defineProperty(e.prototype,n,r)}}))}function aX(e,t){Object.getOwnPropertyNames(t.prototype).forEach((function(t){"constructor"!==t&&delete e.prototype[t]}))}Gi([tX],nX.prototype,"addCheckbox",null),Gi([tX],nX.prototype,"addFloatImage",null),Gi([tX],nX.prototype,"addReminder",null),Gi([tX],nX.prototype,"clearFormatting",null),Gi([tX],nX.prototype,"clearRangeConditionalFormat",null),Gi([tX],nX.prototype,"clearValues",null),Gi([tX],nX.prototype,"formatPivotTableRange",null),Gi([tX],nX.prototype,"clearValuesAndFormatting",null),Gi([tX],nX.prototype,"clearNotes",null),Gi([tX],nX.prototype,"delReminder",null),Gi([tX],nX.prototype,"formatPainter",null),Gi([tX],nX.prototype,"mergeCells",null),Gi([tX],nX.prototype,"splitCells",null),Gi([tX],nX.prototype,"moveRange",null),Gi([tX],nX.prototype,"setCellSegmentArray",null),Gi([tX],nX.prototype,"setCellValue",null),Gi([tX],nX.prototype,"setCellValueByDataValidation",null),Gi([tX],nX.prototype,"setCellNote",null),Gi([tX],nX.prototype,"setFontStyle",null),Gi([tX],nX.prototype,"setFormatter",null),Gi([tX],nX.prototype,"setTextDecoration",null),Gi([tX],nX.prototype,"setRangeStyle",null),Gi([tX],nX.prototype,"setRangeValue",null),Gi([tX],nX.prototype,"setReminder",null),Gi([tX],nX.prototype,"sortRange",null),Gi([tX],nX.prototype,"moveRowCol",null),Gi([tX],nX.prototype,"unfreeze",null),Gi([tX],nX.prototype,"fill",null),Gi([tX],nX.prototype,"fillRange",null),Gi([tX],nX.prototype,"horizontalFill",null),Gi([tX],nX.prototype,"verticalFill",null),Gi([tX],nX.prototype,"hideRow",null),Gi([tX],nX.prototype,"unhideRow",null),Gi([tX],nX.prototype,"hideCol",null),Gi([tX],nX.prototype,"delRow",null),Gi([tX],nX.prototype,"delCol",null),Gi([tX],nX.prototype,"addRow",null),Gi([tX],nX.prototype,"addCol",null),rX(gM,xK),rX(gM,MK),rX(gM,bB),rX(gM,$K),rX(gM,NK),rX(gM,YK),rX(gM,XK),rX(gM,QK),rX(gM,eX),rX(gM,nX);var oX=function(e,t,n){var r=e.conditionalFormatModel.getRulesByRange(t);return"clear-duplicate-values"===(null==n?void 0:n.source)?r.filter((function(e){return"duplicateValues"===e.ruleType})):r};function iX(e,t,n){var r=oX(e,t,n),a=[],o=[];return!!r.every((function(n){if(n.isIntersect(t)){var r=function(e,t,n){var r=t.subBaseRanges(n),a=sX(e,t.cfId);return!!a&&(r.length?cX(e,t.cfId,Object.assign({},a,{ranges:r.map((function(e){return li(e)}))})):uX(e,t.cfId))}(e,n,t);if(!r)return!1;a.push.apply(a,(0,m.Z)(r.actions)),o.push.apply(o,(0,m.Z)(r.oldActions))}return!0}))&&{actions:a,oldActions:o}}function uX(e,t){if(!t||!t.length)return!1;Array.isArray(t)||(t=[t]);var n=[],r=[];return!!t.every((function(t){var a=function(e,t){var n=e.id(),r=e.conditionalFormatModel.getRuleIndex(t);if(r<0)return!1;var a={action:"delConditionalFormat",sheet_id:n,value:{cfId:t,index:r}},o=lX(e,t);return!!o&&{action:a,oldAction:{action:"addConditionalFormat",sheet_id:n,value:Object.assign({},o,{index:r})}}}(e,t);return!!a&&(n.push(a.action),r.push(a.oldAction),!0)}))&&{actions:n,oldActions:r}}function sX(e,t){var n=lX(e,t);return!!n&&(delete n.cfId,Object.assign({},n))}function lX(e,t){var n=UE(e,t);return!!n&&Object.assign({},n.toJSON())}function cX(e,t,n){var r=e.id();if(!t)return!1;var a={action:"setConditionalFormat",sheet_id:r,value:Object.assign({},n,{cfId:t})},o=lX(e,t);return!!o&&{actions:[a],oldActions:[{action:"setConditionalFormat",sheet_id:r,value:o}]}}var hX=function(e,t,n,r){var a=oX(e,t,n).every((function(t){return!e.checkRangesProtected(t.getBaseRanges())}));return!a&&r&&e._raiseInvalidOperation(8,fn("sheet.protection.cannot_start_edit")),a};var fX=function(e,t){return new Oi(e.row,e.col,e.rowCount,e.colCount,t)};function dX(e){var t=null==e?void 0:e.sheet();if(!e||!t)return[];var n=t.conditionalFormatModel,r=t.cellModel;if(!n||!r)return[];var a=n.getAllRules();if(a.length<=0)return[];var o=bh(r.iterVisibleCell(e.rowFrom(),e.colFrom(),e.rowTo(),e.colTo()).reduce((function(e,n){var r=new Oi(e.row,e.col,1,1,t);return n.push(r),n}),[])),i=[],u=o[0];return u&&a.forEach((function(e,t){var n=e.getBaseRanges().map((function(e){return e.intersect(u)})).filter((function(e){return e}));n.length>0&&i.push({rule:e.toJSON(),relativeRanges:n.map((function(e){return Mc(e,{ref:u},1)}))})})),i}function vX(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,r=arguments.length>3?arguments[3]:void 0,a=we.Ps3.getSheetCfCopyEnabled(),o=r||{},i=o.toRanges,u=void 0===i?e.getSelections():i,s=o.isInside,l=void 0===s||s,c=[],h=[],f=e.conditionalFormatModel,d=u[0];if(!d||!f||!a)return{changeset:[],undoChangeset:[]};var v=[],g=f.getAllRules(),y=pX(g.length),C=g.filter((function(e){return e.getBaseRanges().some((function(e){return e.contain(d)}))})),_=function(e){return C.some((function(t){return t.cfId===e}))},R=t.filter((function(e){var t=e.rule;return!_(t.cfId)})),w=R.length===t.length,k=f.getLastIndex(),S=4===n;switch(n){case 0:case 4:if(u&&u[0]){var E=new Oi(d.rowFrom(),d.colFrom(),u[0].rowCount(),u[0].colCount(),e);v.push(E),v.push(d)}case 6:var T,A=_n(R);try{for(A.s();!(T=A.n()).done;){var I=T.value,b=I.relativeRanges.map((function(t){return S&&(t={col:t.row,row:t.col,colCount:t.rowCount,rowCount:t.colCount,type:t.type}),Oc(t,e,(function(){return e}),{ref:d})})).filter((function(e){return e}));6===n||v.push.apply(v,(0,m.Z)(b));var F=gX(I.rule,e,b,k,l),M=(0,p.Z)(F,2),V=M[0],N=M[1];"addConditionalFormat"===V.action&&(k++,y.counting(V)),c.push(V),h.unshift(N)}}catch(e){A.e(e)}finally{A.f()}}if(y.check()){var O=[],x=[];if(w){var Z=iX(e,v,{source:"clear-format"});Z&&(O=Z.actions,x=Z.oldActions)}return{changeset:[].concat((0,m.Z)(O),c),undoChangeset:[].concat(h,(0,m.Z)(x))}}return{changeset:[],undoChangeset:[],isOverLimit:!0}}function gX(e,t,n,r,a){var o,i,u=function(e){return!new Set(["uniqueValues","duplicateValues","aboveAverage","dataBar","iconSet","colorScale","expression"]).has(e)}(e.ruleType),s=t.conditionalFormatModel.getRuleById(e.cfId);if(a&&u&&s){var l=s.toJSON(),c=(0,Re.default)(l);o={action:"setConditionalFormat",sheet_id:t.id(),value:Object.assign({},c,{ranges:l.ranges.concat(n.map((function(e){return li(e,!0)})))})},i={action:"setConditionalFormat",sheet_id:t.id(),value:Object.assign({},c)}}else{var h=BE(t),f=Object.assign({},(0,Re.default)(e),{ranges:n.map((function(e){return li(e,!0)})),index:r,cfId:h});o={action:"addConditionalFormat",sheet_id:t.id(),value:Object.assign({},f)},i={action:"delConditionalFormat",sheet_id:t.id(),value:{cfId:h,index:r}}}return[o,i]}function mX(e,t,n,r){var a=we.Ps3.getSheetCfCopyEnabled(),o=[],i=[],u=function(e,t){var n=e.rowCount(!0),r=e.colCount(!0),a=t.rowCount(!0),o=t.colCount(!0);return{rows:Math.floor(a/n),cols:Math.floor(o/r),lastCopyRows:a%n,lastCopyCols:o%r,fromRangeRowCount:n,fromRangeColCount:r}}(n,r),s=r.rowFrom(),l=r.colFrom();if(!a)return{changeset:o,undoChangeset:i};var c,h=e.conditionalFormatModel,f=h.getLastIndex(),d=pX(h.getAllRules().length),v=[new Oi(s,l,u.lastCopyRows+u.rows*u.fromRangeRowCount,u.lastCopyCols+u.cols*u.fromRangeColCount,e)],g=iX(e,v,{source:"clear-format"})||{},y=g.actions,C=void 0===y?[]:y,_=g.oldActions,R=void 0===_?[]:_,w=function(t,n){return fX({row:t+s,col:n+l,rowCount:u.fromRangeRowCount,colCount:u.fromRangeColCount},e)},k=_n(t);try{for(k.s();!(c=k.n()).done;){var S=c.value,E=S.relativeRanges.map((function(t){for(var n=function(n,r){var a=Oc(t,e,(function(){return e}),{ref:n}),o=["col","all"].includes(r),i=["row","all"].includes(r);return fX({row:n.rowFrom(),rowCount:i?u.lastCopyRows:n.colCount(),col:n.colFrom(),colCount:o?u.lastCopyCols:n.rowCount()},e).intersect(a)},r=[],a=1;a<=u.rows;a++)for(var o=1;o<=u.cols;o++){var i=(a-1)*u.fromRangeRowCount,s=(o-1)*u.fromRangeColCount,l=w(i,s),c=Oc(t,e,(function(){return e}),{ref:l});if(r.push(c),o===u.cols&&u.lastCopyCols){var h=n(w(i,o*u.fromRangeColCount),"col");h&&r.push(h)}if(a===u.rows&&u.lastCopyRows){var f=n(w(a*u.fromRangeRowCount,s),"row");f&&r.push(f)}if(a===u.rows&&o===u.cols&&u.lastCopyRows&&u.lastCopyCols){var d=n(w(a*u.fromRangeRowCount,o*u.fromRangeColCount),"all");d&&r.push(d)}}return bh(r,void 0,!0)})).filter((function(e){return e.length})),T=gX(S.rule,e,(0,W.Z)(E),f,!0),A=(0,p.Z)(T,2),I=A[0],b=A[1];"addConditionalFormat"===I.action&&(f++,d.counting(I)),o.push(I),i.unshift(b),v.push.apply(v,(0,m.Z)((0,W.Z)(E)))}}catch(e){k.e(e)}finally{k.f()}if(d.check()){var F=iX(e,v,{source:"clear-format"});return F&&(C=F.actions,R=F.oldActions),{changeset:[].concat((0,m.Z)(C),o),undoChangeset:[].concat(i,(0,m.Z)(R))}}return{changeset:C,undoChangeset:R,isOverLimit:!0}}function pX(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:we.Ps3.sheetCfMaxCount,n=0,r=function(){return n++},a=function(){return n--};return{counting:function(e){switch(e.action){case"addConditionalFormat":r();break;case"delConditionalFormat":a()}return!0},check:function(){return!(n+e>t)}}}var yX=function(){function e(t){(0,y.Z)(this,e),this.sheet=t,this._spanCache={},this._textCache={},this._styleCache={},this._dropdownCache={},this._dataValidationCache={},this._fontStyleCache={},this._reminderCache={},this._formulaDataCache=new Map}return(0,C.Z)(e,[{key:"getKey",value:function(e,t,n){return"".concat(this.sheet.id(),"|").concat(e,"|").concat(t,"|").concat(n)}},{key:"initConditionalFormatCache",value:function(e){if(!this._conditionalFormatCache&&e){this._conditionalFormatCache=dX(e);var t=this.sheet.conditionalFormatModel;t&&(t.collectCFByCopy=this._conditionalFormatCache)}}},{key:"getSpan",value:function(e,t,n){return this.getProperty(e,t,n,this._spanCache,this.sheet.getSpan)}},{key:"getText",value:function(e,t,n){return this.getProperty(e,t,n,this._textCache,this.sheet.getText)}},{key:"getActualStyle",value:function(e,t,n){return this.getProperty(e,t,n,this._styleCache,this.sheet.getStyleWithConditionalFormat)}},{key:"getDropdown",value:function(e,t,n){return this.getProperty(e,t,n,this._dropdownCache,this.sheet.getDropdown)}},{key:"getDataValidation",value:function(e,t){var n=this.getKey(e,t),r=this._dataValidationCache[n];return void 0===r&&(this._dataValidationCache[n]=r=this.sheet.getDataValidation(e,t)),r}},{key:"getConditionalFormat",value:function(e){return!this._conditionalFormatCache&&e&&this.initConditionalFormatCache(e),this._conditionalFormatCache||[]}},{key:"getReminderJSON",value:function(e,t){return this.getProperty(e,t,3,this._reminderCache,this.sheet.getReminderJSON)}},{key:"getFontStyle",value:function(e){var t=this._fontStyleCache[e];return void 0===t&&(this._fontStyleCache[e]=t=ka(e)),t}},{key:"getProperty",value:function(e,t,n,r,a){var o=this.getKey(e,t,n),i=r[o];return void 0===i&&(r[o]=i=a.call(this.sheet,e,t,n)),i}},{key:"serializeFormula",value:function(e){var t=this._formulaDataCache.get(e);if(t)return t;var n={ref:e.getRef()},r=wf(e,n,{refType:1});return function(e,t){var n=t.refs;for(var r in n){var a=n[r];if(a.sheetId){var o=e.getSheetFromId(a.sheetId);o&&(delete a.sheetId,a.sheetName=o.name())}}}(this.sheet.getParent(),r),this._formulaDataCache.set(e,r),r}}]),e}(),CX=function(){function e(t,n){(0,y.Z)(this,e),this.rowsHasIgnoredCount=0,this.colsHasIgnoredCount=0,this.ignoredRows=new Set,this.ignoredCols=new Set,this.firstRowIndexInFilteredRange=-1,this.sheet=t,this.cache=n||new yX(this.sheet)}return(0,C.Z)(e,[{key:"getIgnoredRowCountInSpan",value:function(e){for(var t=e.rowFrom(),n=e.rowTo(),r=this.firstRowIndexInFilteredRange-t,a=this.firstRowIndexInFilteredRange+1;a<=n;a++)this.ignoredRows.has(a)&&r++;return r}},{key:"getCellInfoPos",value:function(e,t,n){var r=this.cache.getSpan(e,t,n);return{row:r&&e===this.firstRowIndexInFilteredRange?r.rowFrom():e,col:t}}},{key:"isHiddenInSpan",value:function(e,t,n){var r=this.cache.getSpan(e,t,n);return!(!r||this.firstRowIndexInFilteredRange===e&&r.colFrom()===t)}},{key:"serialize",value:function(){var e=this.sheet,t=this.range,n=t.rowFrom(),r=t.colFrom(),a=!1,o=!1,i=e.parent.options.copyPasteHeaderOptions;t instanceof Vi&&2==(2&i)&&(a=!0),t instanceof xi&&1==(1&i)&&(o=!0);var u=t.rowCount(),s=t.colCount(),l=this.getRangeImp({row:n,col:r,rowCount:u,colCount:s},3),c=[],h=[],f=[];if(o){var d=e.getColumnCount();c=this.getRangeImp({row:n,rowCount:u,col:0,colCount:d},2)}if(a){var v=e.getRowCount();h=this.getRangeImp({row:0,rowCount:v,col:r,colCount:s},1)}return o&&a&&(f=this.serializeCorner(this.getDefaultValue())),this.join(l,c,h,f)}},{key:"getRangeImp",value:function(e,t){var n=this.ignoredRows,r=this.ignoredCols,a=e.row,o=e.col,i=e.rowCount,u=e.colCount,s=[];this.rowsHasIgnoredCount=0;for(var l=0;l<i;l++){var c=a+l;if(n.has(c))++this.rowsHasIgnoredCount;else{var h=[];this.colsHasIgnoredCount=0;for(var f=0;f<u;f++){var d=o+f;if(r.has(d))++this.colsHasIgnoredCount;else{var v=this.cache.getSpan(c,d,t);v&&v.rowFrom()>this.firstRowIndexInFilteredRange&&(this.firstRowIndexInFilteredRange=c),h.push(this.serializeCell(c,d,t))}}s.push(h)}}return s}},{key:"join",value:function(e,t,n,r){var a=n.length;return a&&(e=n.concat(e)),t.length&&(a&&(t=this.serializeCorner(this.getDefaultValue()).concat(t)),e=t.map((function(t,n){return t.concat(e[n])}))),this.serializeTable(e)}},{key:"getColGroup",value:function(){for(var e=this.sheet,t=this.range,n=this.ignoredCols,r=t.colFrom(),a=t.colCount(),o=[],i=0;i<a;i++){var u=r+i;if(!n.has(u)){var s=e.getColumnWidth(u);o.push(s)}}return o}},{key:"serializeCorner",value:function(e){var t=this.sheet,n=t.getRowCount(),r=t.getColumnCount(),a=new Array(n),o=new Array(r);return o.fill(e),a.fill(o),a}}]),e}(),_X={cellDelimiter:'"',columnDelimiter:"\t",commaDelimiter:",",rowDelimiter:cn()&&cn().windows?"\r\n":"\n"};var RX,wX=function(e){function t(){var e;return(0,y.Z)(this,t),(e=(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))).rowDelimiter=_X.rowDelimiter,e.columnDelimiter=_X.columnDelimiter,e.cellDelimiter=_X.cellDelimiter,e.forceCellDelimiter=!1,e}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"getDefaultValue",value:function(){return""}},{key:"serializeCell",value:function(e,t,n){if(this.isHiddenInSpan(e,t,n))return"";var r=this.getCellInfoPos(e,t,n),a=r.row,o=r.col,i=this.forceCellDelimiter,u=this.columnDelimiter,s=this.cellDelimiter;return function(e,t){var n=t.columnDelimiter,r=t.cellDelimiter;if(arguments.length>2&&void 0!==arguments[2]&&arguments[2]||e.indexOf(n)>-1||/\r\n?|\n/.test(e)){var a=new RegExp(r,"g");e=r+e.replace(a,r+r)+r}return e}(this.cache.getText(a,o,n)||"",{columnDelimiter:u,cellDelimiter:s},i)}},{key:"serializeRow",value:function(e){return e.join(this.columnDelimiter)}},{key:"serializeTable",value:function(e){var t=this;return e.map((function(e){return t.serializeRow(e)})).join(this.rowDelimiter)}}]),t}(CX);function kX(e){if(null==e)return!0;for(var t in e)if(void 0!==e[t])return!1;return!0}function SX(e,t){if(!0===e.wordWrap&&(e.wordWrap=1),!1===e.wordWrap&&(e.wordWrap=0),t&&(e.wordWrap===t.wordWrap&&delete e.wordWrap,e.hAlign===t.hAlign&&delete e.hAlign,e.vAlign===t.vAlign&&delete e.vAlign,e.font&&-1!==t.fonts.indexOf(e.font.replace(/\s+/g,""))&&delete e.font),e.font&&!e.fontInfo){var n=Xf(e.font),r=n.fontSize,a=n.fontStyle,o=n.fontWeight;e.fontInfo={fontSize:r,fontStyle:a,fontWeight:o},delete e.font}["borderLeft","borderRight","borderTop","borderBottom"].forEach((function(t){e[t]&&e[t].style&&(e[t].width=e[t].style,delete e[t].style),e[t]&&""===e[t].color&&delete e[t]}));var i=function(e){if(null!=e){if("string"==typeof e)return""===e||!e.match(/;/gi)&&e.match(/general/gi)?void 0:{formatCached:e};if(e.formatCached&&"general"!==e.formatCached.toLowerCase())return e}};if(void 0!==e.formatter){var u=i(e.formatter);void 0===u?delete e.formatter:e.formatter=u}if(void 0!==e.autoFormatter){var s=i(e.autoFormatter);void 0===s?delete e.autoFormatter:e.autoFormatter=s}["parentName","hintWidth","hintHeight","watermark","name","validator","themeFont","locked","imeMode","backgroundImageLayout","labelOptions","textIndent","shrinkToFit","backgroundImage","tabStop","cellPadding","cellType"].forEach((function(t){return delete e[t]}))}function EX(e,t){if(e&&e.styles)for(var n in e.styles){var r=e.styles[n];if(null!=r){if(void 0!==r.dropdown){var a=e.dropdowns[r.dropdown];delete r.dropdown,kX(a)||(r.dropdown=a)}SX(r,t)}else e.styles[n]=void 0}return 0}function TX(e){for(var t in e)if("type"!==t&&"id"!==t)throw new Error("mention or image should be a refSegment")}function AX(e,t){return e.value&&Array.isArray(e.value)&&(e.value=e.value.map((function(e){if(e.type){if("mention"===e.type)return TX(e),t.mention[e.id];if("embed-image"===e.type)return TX(e),t.image[e.id];if("attachment"===e.type)return void 0!==e.id?t.attachment[e.id]:e}return delete e.style,void 0!==e.styleId&&t.entities&&t.entities.segmentStyles&&(kX(t.entities.segmentStyles[e.styleId])||(e.style=IX(t.entities.segmentStyles[e.styleId])),delete e.styleId),e.texts&&Array.isArray(e.texts)&&e.texts.forEach((function(e){void 0!==e.styleId&&t.entities&&t.entities.segmentStyles&&(kX(t.entities.segmentStyles[e.styleId])?delete e.style:e.style=IX(t.entities.segmentStyles[e.styleId]),delete e.styleId)})),e}))),void 0===e.styleId&&void 0!==e.style&&delete e.style,void 0!==e.styleId&&t.entities&&t.entities.styles&&(kX(t.entities.styles[e.styleId])?delete e.style:(e.style=IX(t.entities.styles[e.styleId]),e.style&&e.style.dropdown&&(e.dataValidation=mm(e.style.dropdown),delete e.style.dropdown)),delete e.styleId),t.dataValidations&&void 0!==e.dataValidationId&&(kX(t.dataValidations[e.dataValidationId])?delete e.dataValidation:e.dataValidation=IX(t.dataValidations[e.dataValidationId]),delete e.dataValidationId),0}function IX(e){return null==e?e:JSON.parse(JSON.stringify(e))}function bX(e,t){var n={mention:IX(e.mention),image:IX(e.image),entities:IX(e.entities),dataValidations:IX(e.dataValidations),attachment:IX(e.attachment)};delete e.mention,delete e.image,delete e.entities,delete e.dataValidations,delete e.attachment;var r=e.data&&e.data.dataTable;if(!r)return 0;if(n.entities&&n.entities.segmentStyles)for(var a in n.entities.segmentStyles){var o=n.entities.segmentStyles[a];if(delete o.vAlign,delete o.hAlign,delete o.wordWrap,delete o.borderTop,delete o.borderLeft,delete o.borderRight,delete o.borderBottom,delete o.backColor,delete o.autoFormatter,delete o.formatter,delete o.textRotation,o.font&&!o.fontInfo){var i=Xf(o.font),u=i.fontSize,s=i.fontStyle,l=i.fontWeight;o.fontInfo={fontSize:u,fontStyle:s,fontWeight:l},delete o.font}}if(EX(n.entities,t),n.mention)for(var c in n.mention){var h=n.mention[c];delete h.text,delete h.icon,delete h.mentionKeyId,void 0!==h.styleId&&n.entities&&n.entities.segmentStyles&&(kX(n.entities.segmentStyles[h.styleId])?delete h.style:h.style=IX(n.entities.segmentStyles[h.styleId]),delete h.styleId),0!==h.mentionType?(delete h.mentionNotify,delete h.block_notify,delete h.not_notify,delete h.is_external):h.category||(h.category="at-user-block"),"undefined"===h.category&&delete h.category}if(n.dataValidations)for(var f in n.dataValidations){var d=n.dataValidations[f];if(Ig(d)){if(d.options){var v={handledWayOnInvalidData:d.options.handledWayOnInvalidData,helpText:d.options.helpText};switch(d.type){case"number":v.validNumType=d.options.validNumType,d.options=v;break;case"date":v.isDatePickerVisibleInCell=d.options.isDatePickerVisibleInCell,d.options=v;break;case"textLength":case"checkbox":d.options=v}}}else"listFromRange"!==d.type?n.dataValidations[f]=null:d.invalid=!0}if(n.attachment)for(var g in n.attachment){var m=n.attachment[g];void 0!==m.styleId&&n.entities&&n.entities.segmentStyles&&(kX(n.entities.segmentStyles[m.styleId])?delete m.style:m.style=IX(n.entities.segmentStyles[m.styleId]),delete m.styleId)}if(n.image)for(var p in n.image){var y=n.image[p];y.mode&&delete y.mode}for(var C in r)if(r[C])for(var _ in r[C])r[C][_]&&AX(r[C][_],n);return 0}function FX(e){if(!e.sheets)return 0;var t=function(e){var t={fonts:['10pt/1.5"HelveticaNeue",PingFangSC-Regular,"MicrosoftYaHei","HelveticaNeue","MyriadPro","HiraginoSansGB","LucidaGrande",sans-serif','10pt/1.5-apple-system,BlinkMacSystemFont,"HelveticaNeue",Tahoma,"PingFangSC","MicrosoftYahei",Arial,"HiraginoSansGB",sans-serif','10pt/1.5LarkEmojiFont,-apple-system,BlinkMacSystemFont,"HelveticaNeue",Tahoma,"PingFangSC","MicrosoftYahei",Arial,"HiraginoSansGB",sans-serif,"AppleColorEmoji","SegoeUIEmoji","SegoeUISymbol","NotoColorEmoji"','10pt/1.5-apple-system,BlinkMacSystemFont,"HelveticaNeue",Tahoma,"PingFangSC","MicrosoftYahei",Arial,"HiraginoSansGB",sans-serif,"AppleColorEmoji","SegoeUIEmoji","SegoeUISymbol","NotoColorEmoji"'],vAlign:2,hAlign:3,wordWrap:0};if(e.defaults&&e.defaults.style){var n=e.defaults.style;n.font&&(t.fonts=[n.font.replace(/\s+/g,"")]),n.vAlign&&(t.vAlign=n.vAlign),n.hAlign&&(t.hAlign=n.hAlign),n.wordWrap&&(t.wordWrap=n.wordWrap)}return t}(e);for(var n in e.sheets){var r=bX(e.sheets[n],t);if(0!==r)return r}return 0}!function(e){e[e.LayoutChange=0]="LayoutChange",e[e.InvalidateRowHeight=1]="InvalidateRowHeight",e[e.CellMerged=2]="CellMerged",e[e.CellChanged=3]="CellChanged",e[e.ValueChanged=4]="ValueChanged",e[e.RangeChanged=5]="RangeChanged",e[e.SelectionChanged=6]="SelectionChanged",e[e.FormulatextboxRangeChanged=7]="FormulatextboxRangeChanged",e[e.RowHeightChanged=8]="RowHeightChanged",e[e.RowHeightChanging=9]="RowHeightChanging",e[e.ClipboardPasted=10]="ClipboardPasted",e[e.ClipboardPasting=11]="ClipboardPasting",e[e.ColumnWidthChanging=12]="ColumnWidthChanging",e[e.ColumnWidthChanged=13]="ColumnWidthChanged",e[e.UserFormulaEntered=14]="UserFormulaEntered",e[e.ClipboardChanging=15]="ClipboardChanging",e[e.ClipboardChanged=16]="ClipboardChanged",e[e.CancelCutCopyIndicator=17]="CancelCutCopyIndicator",e[e.CommentRemoving=18]="CommentRemoving",e[e.CommentRemoved=19]="CommentRemoved",e[e.CellClick=20]="CellClick",e[e.CellDoubleClick=21]="CellDoubleClick",e[e.BeforeDragDrop=22]="BeforeDragDrop",e[e.DragDropBlock=23]="DragDropBlock",e[e.EditorStatusChanged=24]="EditorStatusChanged",e[e.FrozenChanged=25]="FrozenChanged",e[e.EditEnd=26]="EditEnd",e[e.EditEnding=27]="EditEnding",e[e.EditEnded=28]="EditEnded",e[e.FormulaTextBoxCaretChanged=29]="FormulaTextBoxCaretChanged",e[e.CellRect=30]="CellRect",e[e.TableViewRect=31]="TableViewRect",e[e.SheetContentRect=32]="SheetContentRect",e[e.ScrollRowTo=33]="ScrollRowTo",e[e.ScrollColTo=34]="ScrollColTo",e[e.NextPage=35]="NextPage",e[e.PrePage=36]="PrePage",e[e.HistoryRangesChanged=37]="HistoryRangesChanged",e[e.HistoryTextChanged=38]="HistoryTextChanged",e[e.SearchChanged=39]="SearchChanged",e[e.SetFormatPainter=40]="SetFormatPainter",e[e.SetFilter=41]="SetFilter",e[e.GetResizerStatus=42]="GetResizerStatus",e[e.MobileEditing=43]="MobileEditing",e[e.CHANNEL_STATE_CHANGE=44]="CHANNEL_STATE_CHANGE",e[e.ScrollTo=45]="ScrollTo",e[e.SetScrollPos=46]="SetScrollPos",e[e.ProtectedRangeChange=47]="ProtectedRangeChange",e[e.ConditionalFormatChange=48]="ConditionalFormatChange",e[e.UserPermissionChange=49]="UserPermissionChange",e[e.MoveInCommentCard=50]="MoveInCommentCard",e[e.MoveOutCommentCard=51]="MoveOutCommentCard",e[e.Sorted=83]="Sorted",e[e.EmbedPermissionChange=84]="EmbedPermissionChange",e[e.OrientationChanged=85]="OrientationChanged",e[e.RecordFPSLog=86]="RecordFPSLog",e[e.AddCfSelectionHighlight=87]="AddCfSelectionHighlight",e[e.RemoveCfSelectionHighlight=88]="RemoveCfSelectionHighlight",e[e.AddProtectionSelectionHighlight=89]="AddProtectionSelectionHighlight",e[e.RemoveProtectionSelectionHIghlight=90]="RemoveProtectionSelectionHIghlight",e[e.ConditionalFormatSelectionChange=91]="ConditionalFormatSelectionChange",e[e.BlockSelectionStateChanged=92]="BlockSelectionStateChanged",e[e.PlayReminderNotifyAnimation=93]="PlayReminderNotifyAnimation",e[e.MarkDirty=94]="MarkDirty",e[e.FloatImageMoveEnd=95]="FloatImageMoveEnd",e[e.GridLineHidden=96]="GridLineHidden",e[e.getCanvasBoundingClientRect=97]="getCanvasBoundingClientRect",e[e.NotExpendCellRect=98]="NotExpendCellRect",e[e.ExportablePermissionChanged=99]="ExportablePermissionChanged",e[e.LogicCellRect=100]="LogicCellRect",e[e.ThemeChanged=101]="ThemeChanged",e[e.PivotTableRangeChange=102]="PivotTableRangeChange",e[e.UpdatePivotTableHighlightRanges=103]="UpdatePivotTableHighlightRanges",e[e.RemovePivotTableHighlightRanges=104]="RemovePivotTableHighlightRanges",e[e.CanvasOutsideMouseUp=105]="CanvasOutsideMouseUp",e[e.CellWidthHint=106]="CellWidthHint",e[e.AiHighlightAreaChange=107]="AiHighlightAreaChange",e[e.UpdateSparklineHighlightRanges=108]="UpdateSparklineHighlightRanges",e[e.RemoveSparklineHighlightRanges=109]="RemoveSparklineHighlightRanges",e[e.ScrollRangeTo=110]="ScrollRangeTo",e[e.HideInvisibleSheet=111]="HideInvisibleSheet",e[e.ShowVisibleSheet=112]="ShowVisibleSheet"}(RX||(RX={}));var MX,VX,NX=function(){function e(t,n,r){var a=this,o=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{};(0,y.Z)(this,e),this.subscriber=null,this._isDeleted=!1,this.handleDeleteRow=function(e,t){e.forEach((function(e){var n=e.target,r=e.count;a.row>=n&&a.row<n+r&&(a._isDeleted=!0,a.onDeleted&&a.onDeleted("RowDeleted",{sheetId:t.id(),rowFrom:n,rowCount:r}))}))},this.handleDeleteCol=function(e,t){e.forEach((function(e){var n=e.target,r=e.count;a.col>=n&&a.col<n+r&&(a._isDeleted=!0,a.onDeleted&&a.onDeleted("ColumnDeleted",{sheetId:t.id(),colFrom:n,colCount:r}))}))},this.handleDeleteSheet=function(e){var t=e.sheetId;t===a.sheet.id()&&(a._isDeleted=!0,a.onDeleted&&a.onDeleted("SheetSoftDeleted",{sheetId:t}))},this.sheet=r,this.range=new Zi(t,n,r),this.onDeleted=o.onDeleted,r.parent.watchHub().watchRef(this.range,null),this.subscriber=this.sheet.parent.subscribe(this.getDepends())}return(0,C.Z)(e,[{key:"getDepends",value:function(){return{SheetSoftDeleted:this.handleDeleteSheet,RowDeleted:this.handleDeleteRow,ColumnDeleted:this.handleDeleteCol}}},{key:"destroy",value:function(){this.sheet.parent.watchHub().unWatchRef(this.range),this.subscriber&&(this.subscriber.unsubscribe(),this.subscriber=null)}},{key:"getValue",value:function(){return this.sheet.getValue(this.row,this.col)}},{key:"getSegmentArray",value:function(){return this.sheet.getSegmentArray(this.row,this.col)}},{key:"getChangesetValue",value:function(){return this.sheet.getChangesetValue(this.row,this.col)}},{key:"getText",value:function(){return this.sheet.getText(this.row,this.col)}},{key:"row",get:function(){return this.range.rowFrom()}},{key:"col",get:function(){return this.range.colFrom()}},{key:"isDeleted",get:function(){return this._isDeleted}}]),e}();!function(e){e.Sheet="sheet",e.BlockSheet="blockSheet"}(MX||(MX={})),function(e){e.Sheet="spreadsheet",e.Grid="grid",e.Kanban="kanban",e.Gantt="gantt",e.Gallery="gallery",e.Form="form",e.Template="Template",e.Calendar="calendar"}(VX||(VX={}));var OX,xX,ZX,DX={},PX={_util:Sv,_ThemeContext:Zd,_SpanModel:IS,_SheetDataModel:mS,_SelectionModel:FS,AxisModel:GS,CellModel:XS,Range:Oi,util:Sv,GC$:la,findControl:function(e){return"string"==typeof e&&(e=document.getElementById(e)),_v(e).data("workbook")},getTypeFromString:function(e){var t=!1,n=window;if("string"==typeof e){for(var r=e.split("."),a=0,o=r.length;a<o&&n;a++)n=n[r[a]];n&&o>0&&a===o&&(t=!0)}return t?n:void 0},CursorResource:{ResizeCol:"col-Resize",ResizeRow:"row-resize",ResizeHiddenCol:"w-resize",ResizeHiddenRow:"n-resize"},VisualState:{normal:0,highlight:1,selected:2,active:3,hover:4},SortState:{none:0,ascending:1,descending:2},Point:Ua,Rect:Ba,Style:Ad,LineBorder:hd,Workbook:RK,HorizontalPosition:eK,VerticalPosition:tK,ShowResizeTip:{none:0,column:1,row:2,both:3},ResizeZeroIndicator:{default:0,enhanced:1},Worksheet:gM,HeaderAutoText:{blank:0,numbers:1,letters:2},CommandKeys:we.rvF,staticMembers:I$,SelectionPolicy:{single:0,range:1,multiRange:2},SelectionUnit:{cell:0,row:1,column:2},Fill:DX,Dropdown:Ev,Touch:{},FloatingObjects:{},Filter:{},Tables:{},Slicers:{}};function LX(e,t){if(t){var n=t.value,r=t.range,a=t.col;e.setFilter(r,a,n)}else e.delFilter()}function BX(e){return{type:we.xj7.ROW,row:e.row,rowCount:e.row_count}}function UX(e,t){return{type:we.xj7.ROW,sheetId:t,row:e.row,rowCount:e.row_count}}function HX(e){return{row:e.row,row_count:e.rowCount}}function WX(e){return{type:we.xj7.COL,col:e.col,colCount:e.col_count}}function jX(e,t){return{type:we.xj7.COL,sheetId:t,col:e.col,colCount:e.col_count}}function zX(e){return{col:e.col,col_count:e.colCount}}function GX(e,t){return{type:we.xj7.CELL,row:e,col:t,rowCount:1,colCount:1}}function JX(e){return{type:we.xj7.NORMAL,row:e.row,col:e.col,rowCount:e.row_count,colCount:e.col_count}}function qX(e,t){return{type:we.xj7.NORMAL,sheetId:t,row:e.row,col:e.col,rowCount:e.row_count,colCount:e.col_count}}function $X(e){return{row:e.row,col:e.col,row_count:e.rowCount,col_count:e.colCount}}function YX(e,t){return{type:we.xj7.NORMAL,sheetId:t,row:e.row,col:e.col,rowCount:1,colCount:1}}function KX(e){return{type:we.xj7.NORMAL,row:e.row,col:e.col,rowCount:1,colCount:1}}function XX(e){return{row:e.row,col:e.col}}function QX(e){return{type:we.xj7.NORMAL,row:e.row,col:e.col,rowCount:e.rowCount,colCount:e.colCount}}function eQ(e,t){return t.row>=e.row&&t.rowEnd<=e.rowEnd&&t.col>=e.col&&t.colEnd<=e.colEnd}function tQ(e,t){return t.row===e.row&&t.rowEnd===e.rowEnd&&t.col===e.col&&t.colEnd===e.colEnd}function nQ(e,t){var n=oQ(e),r=oQ(t);return r.row<=n.rowEnd&&r.rowEnd>=n.row&&r.col<=n.colEnd&&r.colEnd>=n.col}function rQ(e,t){return e.row<=t.row+t.row_count-1&&e.row+e.row_count-1>=t.row&&e.col<=t.col+t.col_count-1&&e.col+e.col_count-1>=t.col}function aQ(e,t){if(!nQ(e,t))return null;var n=oQ(e),r=oQ(t);return{row:Math.max(n.row,r.row),rowEnd:Math.min(n.rowEnd,r.rowEnd),col:Math.max(n.col,r.col),colEnd:Math.min(n.colEnd,r.colEnd)}}function oQ(e){switch(e.type){case we.xj7.ALL:return{row:0,col:0,rowEnd:1/0,colEnd:1/0};case we.xj7.CELL:return{row:e.row,col:e.col,rowEnd:e.row,colEnd:e.col};case we.xj7.ROW:return{row:e.row,rowEnd:e.row+e.rowCount-1,col:0,colEnd:1/0};case we.xj7.COL:return{row:0,rowEnd:1/0,col:e.col,colEnd:e.col+e.colCount-1};default:return{row:e.row,rowEnd:e.row+e.rowCount-1,col:e.col,colEnd:e.col+e.colCount-1}}}function iQ(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"Merge",r=e.index,a=e.count,o=t.index,i=t.count;if(o>r+a-1)return e;if(o>r)switch(n){case"Merge":return{index:r,count:a+i};case"Split":return[{index:o+i,count:a-(o-r)},{index:r,count:o-r}]}return{index:r+i,count:a}}function uQ(e,t){var n=e.index,r=e.count,a=t.index,o=t.count,i=a+o-1;if(i<n)return{index:n-o,count:r};var u=n+r-1;return a>u?e:a<=n?i>=u?null:{index:a,count:u-i}:i>=u?{index:n,count:a-n}:{index:n,count:r-o}}function sQ(e,t){return t.index<e?e+t.count:e}function lQ(e,t){var n=t.index,r=t.count,a=n+r-1;return n<e&&e<=a?n:e>a?e-r:e}function cQ(e,t){return t.index<=e?e+t.count:e}function hQ(e,t){var n=t.index,r=t.count,a=n+r-1;return n<=e&&e<=a?Math.max(0,n-1):e>a?e-r:e}function fQ(e,t){for(var n=[],r=0;r<t.length;r++){var a=dQ(e,t[r]);null!=a&&n.push(a)}return n}function dQ(e,t){if(t.type===we.xj7.ALL)return t;switch(e.type){case 0:if(t.type===we.xj7.COL)break;return vQ(e,t);case 1:if(t.type===we.xj7.ROW)break;return mQ(e,t);case 2:if(t.type===we.xj7.COL)break;return gQ(e,t);case 3:if(t.type===we.xj7.ROW)break;return pQ(e,t)}return t}function vQ(e,t,n){var r={index:t.row,count:t.rowCount},a=iQ(r,e,n);if(a===r)return t;if(Array.isArray(a))return a.map((function(e){var n=e.index,r=e.count;return Object.assign({},t,{row:n,rowCount:r})}));var o=a.index,i=a.count;return Object.assign({},t,{row:o,rowCount:i})}function gQ(e,t){var n={index:t.row,count:t.rowCount},r=uQ(n,e);if(!r)return null;if(n===r)return t;var a=r.index,o=r.count;return t.type===we.xj7.CELL?Object.assign({},t,{row:a,rowCount:1}):Object.assign({},t,{row:a,rowCount:o})}function mQ(e,t,n){var r={index:t.col,count:t.colCount},a=iQ(r,e,n);if(a===r)return t;if(Array.isArray(a))return a.map((function(e){var n=e.index,r=e.count;return Object.assign({},t,{col:n,colCount:r})}));var o=a.index,i=a.count;return Object.assign({},t,{col:o,colCount:i})}function pQ(e,t){var n={index:t.col,count:t.colCount},r=uQ(n,e);if(!r)return null;if(r===n)return t;var a=r.index,o=r.count;return t.type===we.xj7.CELL?Object.assign({},t,{col:a,colCount:1}):Object.assign({},t,{col:a,colCount:o})}function yQ(e,t,n){for(var r=[],a=0;a<n.dataRanges.length;a++){var o=n.dataRanges[a];if(o.sheetId===t){var i=dQ(e,n.dataRanges[a]);null!=i&&r.push(i)}else r.push(o)}n.dataRanges=r}function CQ(e){var t=Array.isArray(e)?e:[e];return function(e,n){return e.sheet_id!==n.sheet_id?n:"value"in e&&"value"in n&&e.value&&n.value&&t.every((function(t){return e.value&&n.value&&e.value[t]===n.value[t]}))?null:n}}!function(e){e[e.SUCC=0]="SUCC",e[e.FAIL_PERM_ID_REPERT=1]="FAIL_PERM_ID_REPERT",e[e.FAIL_PERM_ID_EMPTY=2]="FAIL_PERM_ID_EMPTY",e[e.FAIL_PERM_ID_INVALID=3]="FAIL_PERM_ID_INVALID"}(OX||(OX={})),function(e){e[e.AddRow=0]="AddRow",e[e.AddCol=1]="AddCol",e[e.DelRow=2]="DelRow",e[e.DelCol=3]="DelCol"}(xX||(xX={})),function(e){e.Merge="Merge",e.Split="Split"}(ZX||(ZX={}));var _Q=function(){function e(t){(0,y.Z)(this,e),this.op=t,this.isDirty=!1}return(0,C.Z)(e,[{key:"setOp",value:function(e){return this.isDirty||(this.isDirty=!0,this.op=ya(this.op)),e(this.op),this.op}},{key:"getOp",value:function(){return this.op}}]),e}();function RQ(e,t){var n=ya(e);return t(n),n}var wQ=function(e,t){var n=[e.value.block_type,t.value.block_type].every((function(e){return e===we.kHU.DOCX_BLOCK})),r=[e.action,t.action].every((function(e){return["addBlock","restoreBlock"].includes(e)}));return!n||!r};function kQ(e){console.error("Unexpected object",e)}function SQ(e,t,n){return vQ({type:1,index:t.row,count:t.rowCount},e,n)}function EQ(e,t,n){return mQ({type:1,index:t.col,count:t.colCount},e,n)}function TQ(e,t){return gQ({type:2,index:t.row,count:t.rowCount},e)}function AQ(e,t){return pQ({type:3,index:t.col,count:t.colCount},e)}function IQ(e,t){if("delConditionalFormat"===t.action||"moveConditionalFormat"===t.action)return t;if(t.value.hasRef)return!1;var n=[];switch(e.action){case"addRow":n=fQ({type:0,index:e.target.row,count:e.target.row_count},t.value.ranges);break;case"addCol":n=fQ({type:1,index:e.target.col,count:e.target.col_count},t.value.ranges);break;case"delRow":n=fQ({type:2,index:e.target.row,count:e.target.row_count},t.value.ranges);break;case"delCol":n=fQ({type:3,index:e.target.col,count:e.target.col_count},t.value.ranges)}return RQ(t,(function(e){e.value.ranges=n}))}function bQ(e){return"addConditionalFormat"===e.action||"setConditionalFormat"===e.action||"delConditionalFormat"===e.action}function FQ(e){for(var t=0;t<e.length;)Ky(e[t])?e.splice(t,1):t++}function MQ(e){return!(!(0,we.i55)(e)||!(e.value.target.col<0||e.value.target.row<0||e.value.target.colCount<1||e.value.target.rowCount<1)||(we.Ps3.moirae.teaLog(Object.assign({key:"client_sheet_action_range_invalid",from:"follow"},e.value.target)),0))}function VQ(e){for(var t=0;t<e.length;)MQ(e[t])?e.splice(t,1):t++;return e}function NQ(e,t){if("delFloatBlock"===t.action)return t;if(e.sheet_id!==t.sheet_id)return t;switch(e.action){case"addRow":var n=dQ({type:0,index:e.target.row,count:e.target.row_count},GX(t.value.row,t.value.col));if(n)return RQ(t,(function(e){e.value.row=n.row}));break;case"addCol":var r=dQ({type:1,index:e.target.col,count:e.target.col_count},GX(t.value.row,t.value.col));if(r)return RQ(t,(function(e){e.value.col=r.col}));break;case"delRow":return RQ(t,(function(n){n.value.row=hQ(t.value.row,{index:e.target.row,count:e.target.row_count})}));case"delCol":return RQ(t,(function(n){n.value.col=hQ(t.value.col,{index:e.target.col,count:e.target.col_count})}))}return t}function OQ(e){return["setFloatBlock","delFloatBlock"].includes(e.action)}function xQ(e,t){if("delEmbeddedBlock"===t.action)return t;if(e.sheet_id!==t.sheet_id)return t;switch(e.action){case"addRow":var n=dQ({type:0,index:e.target.row,count:e.target.row_count},GX(t.target.row,t.target.col));if(n)return RQ(t,(function(e){e.target.row=n.row}));break;case"addCol":var r=dQ({type:1,index:e.target.col,count:e.target.col_count},GX(t.target.row,t.target.col));if(r)return RQ(t,(function(e){e.target.col=r.col}));break;case"delRow":return RQ(t,(function(n){n.target.row=hQ(t.target.row,{index:e.target.row,count:e.target.row_count})}));case"delCol":return RQ(t,(function(n){n.target.col=hQ(t.target.col,{index:e.target.col,count:e.target.col_count})}))}return t}function ZQ(e){return["setEmbeddedBlock","delEmbeddedBlock"].includes(e.action)}var DQ=function(){function e(){(0,y.Z)(this,e),this.sheets=new Map}return(0,C.Z)(e,[{key:"getSheetFromId",value:function(e){return this.sheets.get(e)||null}},{key:"createSheetFromId",value:function(e,t){var n;return this.sheets.has(e)?(n=this.sheets.get(e)).name(t):(n=new PQ(this,e,t),this.sheets.set(e,n)),n}}]),e}(),PQ=function(){function e(t,n){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;(0,y.Z)(this,e),this.parent=t,this._id=n,this._name=r}return(0,C.Z)(e,[{key:"id",value:function(){return this._id}},{key:"name",value:function(e){return e&&(this._name=e),this._name}},{key:"getRowCount",value:function(){return Ya}},{key:"getColumnCount",value:function(){return Ka}},{key:"getParent",value:function(){return this.parent}}]),e}(),LQ=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"equals",value:function(e,t){return(0,pe.default)(e,t)}},{key:"getHash",value:function(e){return xa(e)}}]),t}(Vg),BQ=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"equals",value:function(e,t){return e.tokens.length===t.tokens.length&&e.tokens.join("")===t.tokens.join("")&&JSON.stringify(e.refs)===JSON.stringify(t.refs)&&JSON.stringify(e.params)===JSON.stringify(t.params)&&e.importRangeId===t.importRangeId&&JSON.stringify(e.externalDataReference)===JSON.stringify(t.externalDataReference)}},{key:"getHash",value:function(e){return xa({tokens:e.tokens,refs:e.refs,externalDataReference:e.externalDataReference,importRangeId:e.importRangeId})}},{key:"serializeRef",value:function(e){return e}}]),t}(Vg),UQ=we.TcH,HQ=function(e,t,n,r,a){n.ignoreValue=null===a.getSegmentArray(e,t);var o=a.getCellStyle(e,t),i=o?r.styleRefMgr.getStyleId(o):null;n.styleId=i,zQ(e,t,a,r,n)},WQ=function(e,t,n,r,a){if(!n.ignoreStyle){var o=a.getCellStyle(e,t,void 0,!0),i=o?r.styleRefMgr.getStyleId(o):null;n.styleId=i}if(!n.ignoreDataValidation){var u=a.getDataValidation(e,t),s=u?r.dvJSONRefMgr.getValidationId(u):null;n.dataValidationId=s}zQ(e,t,a,r,n)};function jQ(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{ignoreValue:!1,ignoreStyle:!1,ignoreDataValidation:!1,ignoreFilterRow:!1,ignorePivotTable:!1},r=arguments.length>3?arguments[3]:void 0,a=arguments.length>4?arguments[4]:void 0,o=JQ(e.id(),t);null==a||a(n,o);for(var i=t.row+t.rowCount-1,u=t.col+t.colCount-1,s=t.row;s<=i;s++)if(!n.ignoreFilterRow||e.filterModel.isVisible(s))for(var l=t.col;l<=u;l++)r?r(s,l,n,o,e):zQ(s,l,e,o,n);return GQ(o),o}function zQ(e,t,n,r){var a=arguments.length>4&&void 0!==arguments[4]?arguments[4]:{},o=a.cellValue,i=a.ignoreDataValidation,u=a.ignoreValue,s=a.ignoreStyle,l=a.ignoreFormulaData,c=a.ignoreMultipleValues,h=a.ignoreReminder,f=a.needNote,d=a.ignorePivotTable,v=a.styleId,g=a.dataValidationId,m=r.target,p=m.row,y=m.col,C=m.col_count,_=[0,null,null,null,null,null,null,null,null,null,null],R=0;if(!u){var w=o?o.value:n.getChangesetValue(e,t,d);R=YQ(UQ.CELL_VALUE),Array.isArray(w)&&($Q(w,r.styleRefMgr),w.some(we.S3_)&&(R=YQ(8,R)),w.some(we.MgP)&&(R=YQ(9,R))),_[UQ.CELL_VALUE]=w}if(!s)if(R=YQ(UQ.STYLE_INDEX,R),null===v||"number"==typeof v)_[UQ.STYLE_INDEX]=v;else{var k,S=o?o.style:(null===(k=n._getStyleImp(e,t,void 0,d))||void 0===k?void 0:k.toJSON())||null;_[UQ.STYLE_INDEX]=S?r.styleRefMgr.add(S).id:null}if(!l){R=YQ(UQ.FORMULADATA_INDEX,R);var E=o?o.formulaData:n.getFormulaData(e,t,void 0,d,!0);E&&(E.externalDataReference&&(R=YQ(7,R)),_[UQ.FORMULADATA_INDEX]=E?r.formulaDataRefMgr.add(E).id:null)}if(!i)if(R=YQ(UQ.DATAVALIDATION_INDEX,R),null===g||"number"==typeof g)_[UQ.DATAVALIDATION_INDEX]=g;else{var T=o?o.dataValidation:n.dataValidationService.getDataValidationJSON(e,t,{needDeepClone:!0},d);T&&(_[UQ.DATAVALIDATION_INDEX]=r.dvJSONRefMgr.add(T).id)}if(!c){R=YQ(UQ.MULTIPLE_VALUE_INDEX,R);var A=o?o.multipleValues:n.getMultipleValuesJSON(e,t);A&&(_[UQ.MULTIPLE_VALUE_INDEX]=A.map((function(e){return r.multipleValuesJSONRefMgr.add(e).id})))}if(!h){R=YQ(UQ.REMINDER,R);var I=o?o.reminder:n.getReminderChangeset(e,t);I&&(_[UQ.REMINDER]=I)}if(f){R=YQ(UQ.NOTE,R);var b=o?o.note:n.getCellNoteJSON(e,t);b&&(_[UQ.NOTE]=b)}return _[UQ.CHANGED_FLAG]=R,0!==R&&(qQ(_,_.length-1),r.value.value[(e-p)*C+(t-y)]=_),r}function GQ(e){e.styleRefMgr.isEmpty()||(e.value.style=e.styleRefMgr.toArray()),e.formulaDataRefMgr.isEmpty()||(e.value.formulaData=e.formulaDataRefMgr.toArray()),e.dvJSONRefMgr&&!e.dvJSONRefMgr.isEmpty()&&(e.value.dataValidation=e.dvJSONRefMgr.toArray()),e.multipleValuesJSONRefMgr&&!e.multipleValuesJSONRefMgr.isEmpty()&&(e.value.multipleValues=e.multipleValuesJSONRefMgr.toArray()),delete e.styleRefMgr,delete e.formulaDataRefMgr,delete e.dvJSONRefMgr,delete e.multipleValuesJSONRefMgr}function JQ(e,t){var n=t.row,r=t.col,a=t.rowCount,o=t.colCount;if(n<0||r<0||a<=0||o<=0)throw new Error("invalid target row: ".concat(n,", col: ").concat(r,", rowCount: ").concat(a,", colCount: ").concat(o));var i={action:"setRangeValues",sheet_id:e,target:{row:t.row,col:t.col,row_count:t.rowCount,col_count:t.colCount},value:{value:new Array(t.colCount*t.rowCount).fill(null)}};return function(e){e.styleRefMgr=new fA(-1),e.formulaDataRefMgr=new BQ(-1),e.dvJSONRefMgr=new Km(-1),e.multipleValuesJSONRefMgr=new LQ(-1)}(i),i}function qQ(e,t){for(var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,r=1,a=e[UQ.CHANGED_FLAG],o=Math.min(t,e.length-1);o>n;o--)if(OY(o,a)&&!(0,ae.Z)(e[o])){r=o+1;break}e.length=r}function $Q(e,t){return e.forEach((function(e){e.style&&(e.styleId=t.add(e.style).id,delete e.style),e.texts&&(e.texts.length>0?e.texts.forEach((function(e){e.style&&(e.styleId=t.add(e.style).id,delete e.style)})):delete e.texts)}))}function YQ(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;switch(e){case UQ.CELL_VALUE:return 1|t;case UQ.STYLE_INDEX:return 2|t;case UQ.FORMULADATA_INDEX:return 4|t;case UQ.DATAVALIDATION_INDEX:return 8|t;case UQ.MULTIPLE_VALUE_INDEX:return 16|t;case UQ.REMINDER:return 32|t;case 7:return 64|t;case 8:return 128|t;case 9:return 256|t;case UQ.NOTE:return 512|t;default:return 1<<e-1|t}}function KQ(e,t,n){switch(e){case"addRow":return[new Wi(!0,"add",n.row,n.row_count,t)];case"addCol":return[new Wi(!1,"add",n.col,n.col_count,t)];case"delRow":return[new Wi(!0,"delete",n.row,n.row_count,t)];case"delCol":return[new Wi(!1,"delete",n.col,n.col_count,t)];case"delSheet":return[new zi(t)];default:return[]}}var XQ=new Set(["addRow","addCol","delRow","delCol","delSheet","setSheet","copySheet"]);var QQ=function(){function e(){(0,y.Z)(this,e),this.fmlRefWatch=new $t.WatchedRefHub,this.invalidRef=new Map,this.dirtyTree=new Set,this.workbook=new DQ,this.actionRefFollowHandlerMap={setCell:new e0,setRangeValues:new t0}}return(0,C.Z)(e,[{key:"classifyAndRegisterRef",value:function(e,t){for(var n in t){var r=t[n];r.isValid()?this.fmlRefWatch.watchRef(r,e):this.invalidRef.has(e)?this.invalidRef.get(e).add(r):this.invalidRef.set(e,new Set([r]))}}},{key:"isActionChangeSheetName",value:function(e){return"setSheet"===e.action&&"name"===e.value.property_name||"copySheet"===e.action&&void 0===e.value.snapshot}},{key:"changeSheetNameHandler",value:function(e){var t=this,n=new Map;this.invalidRef.forEach((function(r,a){r.forEach((function(r){if(r.sheetName===e.value.sheet_name){var o=t.workbook.createSheetFromId(e.sheet_id,e.value.sheet_name);r.setSheet(o),t.fmlRefWatch.watchRef(r,a),n.set(a,r),t.dirtyTree.add(a)}}))})),n.forEach((function(e,n){var r=t.invalidRef.get(n);r&&(r.delete(e),0===r.size&&t.invalidRef.delete(n))}))}},{key:"applyActionsToRefs",value:function(e){var t,n=this,r=_n(e);try{for(r.s();!(t=r.n()).done;){var a=(0,p.Z)(t.value,1)[0];if(this.isActionChangeSheetName(a))this.changeSheetNameHandler(a);else{var o=this.workbook.createSheetFromId(a.sheet_id);"delSheet"===a.action&&o.name(a.value.sheet_name);var i=a.target,u=KQ(a.action,o,i);this.fmlRefWatch.onRefOp(u,(function(e,t){n.dirtyTree.add(t)}))}}}catch(e){r.e(e)}finally{r.f()}}},{key:"exportDirtyFormulaData",value:function(e){var t=this;this.dirtyTree.forEach((function(n){Object.values(t.actionRefFollowHandlerMap).forEach((function(r){r.exportDirtyFormulaData(n,t.workbook,e)}))}))}},{key:"follows",value:function(e,t){var n=this,r=function(e,t){for(var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,r=new Map,a=n;a<e.length;a++)t(e[a])&&r.set(e[a],a);return r}(e,(function(e){return XQ.has(e.action)}));if(0===r.size)return t.Ops;var a=t.filter((function(e){return!!n.actionRefFollowHandlerMap[e.action]&&n.actionRefFollowHandlerMap[e.action].filter(e)}));if(0===a.size)return t.Ops;var o,i=_n(a);try{for(i.s();!(o=i.n()).done;){var u=o.value,s=t.getAction(u);this.actionRefFollowHandlerMap[s.action].getRefRangesAndFormulaTreeInAction(s,this.workbook,u).forEach((function(e){var t=e.fmlTree,r=e.refRanges;r&&n.classifyAndRegisterRef(t,r)}))}}catch(e){i.e(e)}finally{i.f()}return this.applyActionsToRefs(r),this.exportDirtyFormulaData(t),t.toJSON()}}]),e}(),e0=function(){function e(){(0,y.Z)(this,e),this.tree2ActionIdx=new Map}return(0,C.Z)(e,[{key:"filter",value:function(e){return"string"==typeof e.value?function(e){return e.includes('"formulaData"')}(e.value):function(e){return void 0!==e.formulaData}(e.value)}},{key:"getRefRangesAndFormulaTreeInAction",value:function(e,t,n){var r=e.sheet_id,a=e.value,o=new Kw(a.formulaData,t.createSheetFromId(r),(function(e){return t.createSheetFromId(e)})),i=o.getRefs();return null!==i&&this.tree2ActionIdx.set(o,n),[{fmlTree:o,refRanges:i}]}},{key:"exportDirtyFormulaData",value:function(e,t,n){var r=this.tree2ActionIdx.get(e);if("number"==typeof r){var a=n.getActionMut(r);if(a){var o=a.target,i=o.col,u=o.row,s=new Oi(u,i,1,1,t.getSheetFromId(a.sheet_id));a.value.formulaData.refs=e.exportRefs(s)}}}}]),e}(),t0=function(){function e(){(0,y.Z)(this,e),this.fmlData2ActionAndIndexArrMap=new Map}return(0,C.Z)(e,[{key:"filter",value:function(e){return void 0!==e.value.formulaData}},{key:"exportDirtyFormulaData",value:function(e,t,n){var r=this.fmlData2ActionAndIndexArrMap.get(e.formulaData);if(r){var a=n.getActionMut(r.idxInOpWrapper),o=a.sheet_id,i=a.target,u=i.row,s=i.col,l=i.col_count,c=a.value,h=c.value,f=c.formulaData;r.indexInValue.forEach((function(n){var r=Math.floor(n/l),a=new Oi(r+u,n-r*l+s,1,1,t.getSheetFromId(o));h[n][we.TcH.FORMULADATA_INDEX]=f.length;var i=ya(e.formulaData);i.refs=e.exportRefs(a),f.push(i)}))}}},{key:"getRefRangesAndFormulaTreeInAction",value:function(e,t,n){for(var r=[],a=e.sheet_id,o=0;o<e.value.value.length;o++){var i=e.value.value[o];if(i&&"number"==typeof i[we.TcH.FORMULADATA_INDEX]){var u=i[we.TcH.FORMULADATA_INDEX],s=e.value.formulaData[u];if(s){var l=this.fmlData2ActionAndIndexArrMap.get(s);if(l)l.indexInValue.push(o);else{this.fmlData2ActionAndIndexArrMap.set(s,{idxInOpWrapper:n,indexInValue:[o]});var c=new Kw(s,t.createSheetFromId(a),(function(e){return t.createSheetFromId(e)})),h=c.getRefs();r.push({fmlTree:c,refRanges:h})}}}}return r}}]),e}(),n0=function(){function e(t){(0,y.Z)(this,e),this.ops=t,this.opsLen=t.length}return(0,C.Z)(e,[{key:"filter",value:function(e){for(var t=new Set,n=0;n<this.opsLen;n++)e(this.ops[n])&&t.add(n);return t}},{key:"Ops",get:function(){return this.ops}}]),e}(),r0=function(e){function t(e){var n;return(0,y.Z)(this,t),(n=(0,d.Z)(this,(0,v.Z)(t).call(this,e))).ops=e,n.mutActionMap=new Map,n}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"getAction",value:function(e){return this.ops[e]}},{key:"getActionMut",value:function(e){if(this.mutActionMap.has(e))return this.mutActionMap.get(e);var t=ya(this.ops[e]);return this.mutActionMap.set(e,t),t}},{key:"toJSON",value:function(){if(0===this.mutActionMap.size)return this.ops;var e,t=Array.from(this.ops),n=_n(this.mutActionMap);try{for(n.s();!(e=n.n()).done;){var r=(0,p.Z)(e.value,2),a=r[0],o=r[1];t[a]=o}}catch(e){n.e(e)}finally{n.f()}return t}}]),t}(n0);function a0(e,t,n){switch(e.action){case"setCell":if(n&&c0(e.target,t.target)){e.extra&&(e=U$(ya(e)));var r=JQ(t.sheet_id,KX(e.target));return zQ(e.target.row,e.target.col,d0(t.sheet_id),r,{cellValue:e.value,ignoreValue:void 0===e.value.value,ignoreStyle:void 0===e.value.style,ignoreDataValidation:void 0===e.value.dataValidation,ignoreReminder:void 0===e.value.reminder,ignoreFormulaData:void 0===e.value.formulaData,ignoreMultipleValues:void 0===e.value.multipleValues,needNote:void 0!==e.value.note}),GQ(r),i0(r,t,!0)}return t;case"setRange":if(n){var a=QX(e.value.target),o=JX(t.target);if(nQ(a,o)){var i=(new DQ).createSheetFromId(t.sheet_id),u=new Oi(a.row,a.col,a.rowCount,a.colCount,i),s=new Oi(o.row,o.col,o.rowCount,o.colCount,i);return i0(h0(e,u.intersect(s).toJSON()),t,!0)}}return t;case"updateRange":if(n){var l=QX(e.value.target),c=JX(t.target);if(nQ(l,c)){for(var h=(new DQ).createSheetFromId(t.sheet_id),f=new Oi(l.row,l.col,l.rowCount,l.colCount,h),d=new Oi(c.row,c.col,c.rowCount,c.colCount,h),v=f.intersect(d),g=new Map,m=e.value.style,p=ya(t),y=v.rowFrom();y<=v.rowTo();y++)for(var C=v.colFrom();C<=v.colTo();C++){var R=p.value.value[u0(y,C,c.row,c.col,c.rowCount,c.colCount)];if(Array.isArray(R)){var w=R[we.TcH.CHANGED_FLAG];for(var k in e.value)if("style"===k)if(m){var S;if(!OY(we.TcH.STYLE_INDEX,w))continue;var E=null!==(S=R[we.TcH.STYLE_INDEX])&&void 0!==S?S:null;if(null===E){w=xY(we.TcH.STYLE_INDEX,w);continue}if(!g.has(E)&&p.value.style){var T=p.value.style.length;g.set(E,T);var A=ya(p.value.style[E]);if(m.fontInfo){var I=A[0];if("object"==(0,_.Z)(I)){var b=fd.withUpdate(I,m.fontInfo);A[0]=b.toJSON()}else if(ld())A[0]=wa._updateFont(I||"",m.fontInfo).font;else{var F=I?fd.valueOf(I):fd.EMPTY;F=fd.withUpdate(F,m.fontInfo),A[0]=F.toJSON()}}for(var M in m.textDecoration&&("number"!=typeof m.textDecoration?A[3]=wa._updateTextDecoration(A[3],m.textDecoration):A[3]=m.textDecoration),m)"fontInfo"!==M&&"textDecoration"!==M&&(A[we.Wa0[M]]=m[M]);R[we.TcH.STYLE_INDEX]=T,p.value.style.push(A)}else R[we.TcH.STYLE_INDEX]=g.get(E)||null}else e.value.hasOwnProperty("style")&&(w=xY(we.TcH.STYLE_INDEX,w));else o0[k]&&(w=xY(o0[k],w));R[we.TcH.CHANGED_FLAG]=w}}return s0([p])}}return t;case"sort":var V=JX(e.target),N=JX(t.target);if(nQ(V,N)){var O=(new DQ).createSheetFromId(t.sheet_id),x=new Oi(V.row,V.col,V.rowCount,V.colCount,O),Z=new Oi(N.row,N.col,N.rowCount,N.colCount,O).intersect(x);if(null!==Z){for(var D=[],P={},L=0;L<e.value.length;L++)P[e.value[L]]=L+V.row;var B=new Oi(Z.rowFrom(),Z.colFrom(),Z.rowCount(),Z.colCount(),O),U=ya(t);return B.splitByRow().forEach((function(e){var n=e.rowFrom(),r=l0(t);r.target={row:P[n],col:e.colFrom(),row_count:1,col_count:e.colCount()};for(var a=u0(n,r.target.col,N.row,N.col,N.rowCount,N.colCount),o=a;o<a+r.target.col_count;o++)r.value.value.push(U.value.value[o]),U.value.value[o]=null;D.push(r,U)})),s0(D)}}return t;case"setSpans":var H=JX(e.target),W=JX(t.target);if((0,se.default)(e.value)||!nQ(H,W))return t;var j=(new DQ).createSheetFromId(t.sheet_id),z=new Oi(W.row,W.col,W.rowCount,W.colCount,j),G=ya(t),J=[G];return e.value.forEach((function(e){var t=e.target;if(nQ(JX(t),W)){var n=new Oi(t.row,t.col,1,1,j),r=new Oi(t.row,t.col,t.row_count,t.col_count,j);if(z.contain(n)){var a=r.intersect(z),o=G.value.value[u0(t.row,t.col,W.row,W.col,W.rowCount,W.colCount)],i=null;if(o){var u=o[we.TcH.CHANGED_FLAG],s=o[we.TcH.STYLE_INDEX];OY(we.TcH.STYLE_INDEX,u)&&"number"==typeof s&&(i=[YQ(we.TcH.STYLE_INDEX),null,s])}for(var l=a.rowFrom();l<=a.rowTo();l++)for(var c=a.colFrom();c<=a.colTo();c++){var h;l===t.row&&c===t.col||(G.value.value[u0(l,c,W.row,W.col,W.rowCount,W.colCount)]=(null===(h=i)||void 0===h?void 0:h.slice())||null)}if(i){var f,d=r.sub(a),v=i[we.TcH.STYLE_INDEX],g=null,m=i.slice();m[we.TcH.STYLE_INDEX]=0,null!==(f=G.value.style)&&void 0!==f&&f[v]&&(g=[G.value.style[v]]),d.forEach((function(e){J.push({action:"setRangeValues",sheet_id:G.sheet_id,target:e.toNormalRange(),value:{value:new Array(e.size()).fill(m.slice()),style:ya(g)}})}))}}else{var p=r.intersect(z);if(p)for(var y=p.rowFrom();y<=p.rowTo();y++)for(var C=p.colFrom();C<=p.colTo();C++)G.value.value[u0(y,C,W.row,W.col,W.rowCount,W.colCount)]=null}}})),s0(J);case"addRow":var q=e.target.row,$=e.target.row_count,Y=t.target,K=Y.row,X=Y.row_count,Q=Y.col_count,ee=K+X-1;return q<=K?RQ(t,(function(e){e.target.row+=$})):K<q&&q<=ee?RQ(t,(function(e){e.target.row_count+=$,(0,we.b$t)(e.value.value,(q-K)*Q,0,new Array($*Q).fill(null))})):t;case"addCol":var te=e.target.col,ne=e.target.col_count,re=t.target,ae=re.col,oe=re.col_count,ie=re.row_count,ue=ae+oe-1;if(te<=ae)return RQ(t,(function(e){e.target.col+=ne}));if(ae<te&&te<=ue){var le=l0(t);le.target.col_count+=ne;for(var ce=0;ce<ie;ce++)for(var he=0;he<le.target.col_count;he++){var fe=null;he+ae<te?fe=t.value.value[ce*oe+he]:he+ae>=te+ne&&(fe=t.value.value[ce*oe+he-ne]),le.value.value.push(fe)}return le}return t;case"delRow":var de=BX(e.target),ve=JX(t.target),ge=TQ(ve,de);return null===ge?null:ge!==ve?ge.rowCount===ve.rowCount?RQ(t,(function(e){e.target=$X(ge)})):RQ(t,(function(e){e.target=$X(ge);var t=ve.colCount;e.value.value.splice((de.row-ve.row)*t,de.rowCount*t)})):t;case"delCol":var me=WX(e.target),pe=me.col,ye=pe+me.colCount-1,Ce=JX(t.target),_e=Ce.col,Re=Ce.rowCount,ke=Ce.colCount,Se=AQ(Ce,me);if(null===Se)return null;if(Se!==Ce){if(Se.colCount===Ce.colCount)return RQ(t,(function(e){e.target=$X(Se)}));var Ee=l0(t);Ee.target=$X(Se);for(var Te=0;Te<Re;Te++)for(var Ae=0;Ae<ke;Ae++)(Ae+_e<pe||Ae+_e>ye)&&Ee.value.value.push(t.value.value[Te*ke+Ae]);return Ee}return t;case"moveRange":var Ie=e.value,be=Ie.target,Fe=Ie.source,Me=JX(t.target),Ve=t.target,Ne=Ve.row,Oe=Ve.col,xe=Ve.row_count,Ze=Ve.col_count,De=Object.assign({sheetId:t.sheet_id},Me),Pe=P0(Fe,De),Le=P0(be,De);if(!Pe&&!Le)return t;var Be=(new DQ).createSheetFromId(e.value.source.sheetId),Ue=(new DQ).createSheetFromId(e.value.target.sheetId),He=[];if(Pe){var We=new Oi(Fe.row,Fe.col,Fe.rowCount,Fe.colCount,Be),je=new Oi(Ne,Oe,xe,Ze,Be).intersect(We).toJSON(),ze=je.row,Ge=je.col,Je=je.rowCount,qe=je.colCount,$e=ze+Je-1,Ye=Ge+qe-1;He.push(RQ(t,(function(e){for(var t=ze;t<=$e;t++)for(var n=Ge;n<=Ye;n++)e.value.value[u0(t,n,Ne,Oe,xe,Ze)]=null})));var Ke=l0(t);Ke.sheet_id=e.value.target.sheetId,Ke.target={row:ze-We.rowFrom()+be.row,col:Ge-We.colFrom()+be.col,row_count:Je,col_count:qe};for(var Xe=0;Xe<Je;Xe++)for(var Qe=0;Qe<qe;Qe++)Ke.value.value.push(ya(t.value.value[u0(ze+Xe,Ge+Qe,Ne,Oe,xe,Ze)]));He.push(Ke)}if(Le){var et,tt=new Oi(be.row,be.col,be.rowCount,be.colCount,Ue),nt=new Oi(Ne,Oe,xe,Ze,Ue).intersect(tt),rt=nt.rowFrom(),at=nt.colFrom();et=He[0]?He[0]:ya(t);for(var ot=0;ot<nt.rowCount();ot++)for(var it=0;it<nt.colCount();it++)et.value.value[u0(ot+rt,it+at,Ne,Oe,xe,Ze)]=null;He[0]||He.push(et)}return s0(He)}return t}var o0={value:we.TcH.CELL_VALUE,style:we.TcH.STYLE_INDEX,formulaData:we.TcH.FORMULADATA_INDEX,dataValidation:we.TcH.DATAVALIDATION_INDEX,multipleValues:we.TcH.MULTIPLE_VALUE_INDEX,reminder:we.TcH.REMINDER,note:we.TcH.NOTE};function i0(e,t){var n=arguments.length>2&&void 0!==arguments[2]&&arguments[2];if(!n)return t;switch(t.action){case"setCell":if(c0(t.target,e.target)){t.extra&&(t=U$(ya(t)));var r=e.value.value[u0(t.target.row,t.target.col,e.target.row,e.target.col,e.target.row_count,e.target.col_count)];if(!Array.isArray(r))break;return i0(e,h0(t,KX(t.target)),!0)}break;case"setRangeValues":var a=JX(e.target),o=JX(t.target);if(nQ(a,o)){var i=(new DQ).createSheetFromId(e.sheet_id),u=new Oi(a.row,a.col,a.rowCount,a.colCount,i),s=new Oi(o.row,o.col,o.rowCount,o.colCount,i),l=u.intersect(s);t=ya(t);for(var c=l.rowFrom();c<=l.rowTo();c++)for(var h=l.colFrom();h<=l.colTo();h++){var f=u0(c,h,a.row,a.col,a.rowCount,a.colCount),d=u0(c,h,o.row,o.col,o.rowCount,o.colCount);t.value.value[d]=f0(e.value.value[f],t.value.value[d])}return s0([t])}break;case"updateRange":var v=JX(e.target),g=QX(t.value.target);if(nQ(v,g)){var m=(new DQ).createSheetFromId(e.sheet_id),p=new Oi(v.row,v.col,v.rowCount,v.colCount,m),y=new Oi(g.row,g.col,g.rowCount,g.colCount,m),C=p.intersect(y),_=l0(e);_.target=C.toNormalRange();for(var R=C.rowFrom();R<=C.rowTo();R++)for(var w=C.colFrom();w<=C.colTo();w++)_.value.value.push(e.value.value[u0(R,w,v.row,v.col,v.rowCount,v.colCount)]);return[t,_]}break;case"setRange":var k=JX(e.target),S=QX(t.value.target);if(nQ(k,S))return i0(e,h0(t,S),!0)}return t}function u0(e,t,n,r,a,o){return(e-n)*o+t-r}function s0(e){return e.filter((function(e){if("setRangeValues"===e.action){if(0===e.value.value.length)return!1;for(var t=0;t<e.value.value.length;t++)if(Array.isArray(e.value.value[t])&&0!==e.value.value[t][we.TcH.CHANGED_FLAG])return!0;return!1}return!0}))}function l0(e){var t={action:"setRangeValues",sheet_id:e.sheet_id,target:{row:e.target.row,col:e.target.col,row_count:e.target.row_count,col_count:e.target.col_count},value:{value:[]}};return e.value.style&&(t.value.style=ya(e.value.style)),e.value.formulaData&&(t.value.formulaData=ya(e.value.formulaData)),e.value.dataValidation&&(t.value.dataValidation=ya(e.value.dataValidation)),e.value.multipleValues&&(t.value.multipleValues=ya(e.value.multipleValues)),t}function c0(e,t){return e.row>=t.row&&e.row<t.row+t.row_count&&e.col>=t.col&&e.col<t.col+t.col_count}function h0(e,t){var n={};for(var r in e.value){var a=e.value[r];"target"!==r&&void 0!==a&&(n[r]=a)}return jQ(d0(e.sheet_id),t,{cellValue:n,ignoreValue:void 0===e.value.value,ignoreStyle:void 0===e.value.style,ignoreDataValidation:void 0===e.value.dataValidation,ignoreReminder:void 0===e.value.reminder,ignoreFormulaData:void 0===e.value.formulaData,ignoreMultipleValues:void 0===e.value.multipleValues,needNote:void 0!==e.value.note})}function f0(e,t){if(!Array.isArray(e)||!Array.isArray(t))return t||null;function n(e,t,n){return!OY(n,r)&&OY(n,a)}var r=e[we.TcH.CHANGED_FLAG],a=t[we.TcH.CHANGED_FLAG],o=Boolean(53&r);for(var i in we.TcH)switch(i){case"CHANGED_FLAG":break;case"CELL_VALUE":!o&&n(0,0,we.TcH.CELL_VALUE)||(t[we.TcH.CELL_VALUE]=null,a=xY(we.TcH.CELL_VALUE,a));break;case"STYLE_INDEX":n(0,0,we.TcH.STYLE_INDEX)||(t[we.TcH.STYLE_INDEX]=null,a=xY(we.TcH.STYLE_INDEX,a));break;case"FORMULADATA_INDEX":!o&&n(0,0,we.TcH.FORMULADATA_INDEX)||(t[we.TcH.FORMULADATA_INDEX]=null,a=xY(we.TcH.FORMULADATA_INDEX,a));break;case"DATAVALIDATION_INDEX":n(0,0,we.TcH.DATAVALIDATION_INDEX)||(t[we.TcH.DATAVALIDATION_INDEX]=null,a=xY(we.TcH.DATAVALIDATION_INDEX,a));break;case"MULTIPLE_VALUE_INDEX":!o&&n(0,0,we.TcH.MULTIPLE_VALUE_INDEX)||(t[we.TcH.MULTIPLE_VALUE_INDEX]=null,a=xY(we.TcH.MULTIPLE_VALUE_INDEX,a));break;case"REMINDER":!o&&n(0,0,we.TcH.REMINDER)||(t[we.TcH.REMINDER]=null,a=xY(we.TcH.REMINDER,a));break;case"NOTE":n(0,0,we.TcH.NOTE)||(t[we.TcH.NOTE]=null,a=xY(we.TcH.NOTE,a))}return 0===a?null:(t[we.TcH.CHANGED_FLAG]=a,qQ(t,t.length-1),t)}function d0(e){return{id:function(){return e}}}function v0(e,t){return e.row===t.row&&e.col===t.col}function g0(e,t){return v0(e.target,t.target)?null:t}var m0,p0=["value","multipleValues","formula","formulaData","reminder","note"];function y0(e){for(var t=!1,n=0;n<p0.length;n++)if(e.hasOwnProperty(p0[n])){t=!0;break}return t}function C0(e,t){var n={},r=y0(e);for(var a in t)p0.includes(a)&&r||(n[a]=t[a]);return ya(n)}function _0(e){if(e.style&&e.style.dropdown&&!e.dataValidation){var t=mm(e.style.dropdown);return Object.assign({},e,{style:Object.assign({},e.style,{dropdown:null}),dataValidation:t})}return e}function R0(e,t){t.value.dataValidation&&e.style&&e.style.dropdown&&(e.hasOwnProperty(ag)?t.value.dataValidation=e.dataValidation:delete t.value.dataValidation)}function w0(e){return e.dataValidation&&e.style&&(e.style=Object.assign({},e.style,{dropdown:null})),e}function k0(e){return e.style&&e.style.dropdown&&!e.dataValidation&&(e.dataValidation=null),e}function S0(e,t,n){var r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:1;if(!e.value.hasOwnProperty("style")&&null===e.value.dataValidation&&!t.value.hasOwnProperty("style")&&t.value.dataValidation)return[t,e];var a=0===r?e:t,o=C0(e.value,t.value);return RQ(a,(function(t){o=_0(o);var n=_0(e.value);o=k0(o=w0(o)),t.value=Object.assign({},o,n),R0(n,t)}))}!function(e){e[e.OP1=0]="OP1",e[e.OP2=1]="OP2"}(m0||(m0={}));var E0={updateRange:{updateRange:function(e,t,n){if(!n)return t;var r=ya(e.value),a=C0(e.value,t.value),o=ya(t.value);if(r=_0(r),a=_0(a),o=_0(o),a=w0(a),o=k0(o),r.style){var i,u=_n(["dropdown"]);try{for(u.s();!(i=u.n()).done;){var s=i.value;void 0!==r.style[s]&&a.style&&delete a.style[s]}}catch(e){u.e(e)}finally{u.f()}}var l={},c="updateRange";if(null===r.style)l=null;else if(null===a.style)if(void 0===r.style)l=null;else{c="setRange";var h=Md().clone().toJSON(!0);b0(r.style,h),l=h}else l=(0,ie.Z)({},a.style,r.style),r.style&&void 0!==r.style.dropdown||!l||!(null===a.style||void 0===a.style&&a.dataValidation)||(l.dropdown=null);var f=Object.assign({},o,r);return f.style=l,RQ(e,(function(e){e.action=c,e.value=f,R0(r,e)}))},setRange:function(e,t,n){return S0(t,e,n,!t.value.style&&e.value.style?1:0)}},setRange:{setRange:function(e,t,n){return n?S0(e,t):t},updateRange:function(e,t,n){return S0(e,t,n,!e.value.style&&t.value.style?1:0)}}};function T0(e,t){var n=arguments.length>2&&void 0!==arguments[2]&&arguments[2];switch(t.action){case"setCell":var r=oQ(QX(e.value.target)),a=oQ(KX(t.target));if(!n||!eQ(r,a))return t;if("setRange"===e.action)return RQ(t,(function(t){return I0(e,t),t}));if("updateRange"===e.action)return RQ(t,(function(t){return F0(e,t),t}));break;case"setRangeValues":return a0(e,t,n);case"delSheet":return(!n||e.sheet_id!==t.sheet_id)&&t;case"setRange":case"updateRange":var o=QX(e.value.target),i=QX(t.value.target);if(!nQ(o,i))return t;var u=(new DQ).createSheetFromId(t.sheet_id),s=new Oi(o.row,o.col,o.rowCount,o.colCount,u),l=new Oi(i.row,i.col,i.rowCount,i.colCount,u);if(s.equal(l))return E0[e.action][t.action](e,t,n);if(!n)return t;var c=l.intersect(s),h=[t];if(null!==c){var f=RQ(e,(function(e){e.value.target={type:we.xj7.NORMAL,row:c.rowFrom(),col:c.colFrom(),rowCount:c.rowCount(),colCount:c.colCount()}}));h.push(f)}return VQ(h)}return t}function A0(e,t){var n=arguments.length>2&&void 0!==arguments[2]&&arguments[2];switch(e.action){case"setCell":var r=oQ(KX(e.target)),a=oQ(QX(t.value.target));return n&&eQ(a,r)?[t,e]:t;case"addRow":var o=e.target.row,i=e.target.row_count,u=t.value.target,s=u.row,l=u.rowCount,c=s+l-1;if(o<=s)return RQ(t,(function(e){e.value.target.row+=i}));if(s<o&&o<=c){var h=RQ(t,(function(e){e.value.target.rowCount=o-s})),f=RQ(t,(function(e){e.value.target.row=o+i,e.value.target.rowCount=l-h.value.target.rowCount}));return VQ([h,f])}return t;case"addCol":var d=e.target.col,v=e.target.col_count,g=t.value.target,m=g.col,p=g.colCount,y=m+p-1;if(d<=m)return RQ(t,(function(e){e.value.target.col+=v}));if(m<d&&d<=y){var C=RQ(t,(function(e){e.value.target.colCount=d-m})),R=RQ(t,(function(e){e.value.target.col=d+v,e.value.target.colCount=p-C.value.target.colCount}));return VQ([C,R])}return t;case"delRow":var w=BX(e.target),k=QX(t.value.target),S=TQ(k,w);if(null===S)return null;if(S!==k)return VQ([RQ(t,(function(e){e.value.target=Object.assign({},S,{type:we.xj7.NORMAL})}))]);break;case"delCol":var E=WX(e.target),T=QX(t.value.target),A=AQ(T,E);if(null===A)return null;if(A!==T)return VQ([RQ(t,(function(e){e.value.target=Object.assign({},A,{type:we.xj7.NORMAL})}))]);break;case"setSpans":var I=JX(e.target),b=QX(t.value.target);if((0,se.default)(e.value)||!nQ(I,b))return t;var F,M=(new DQ).createSheetFromId(t.sheet_id),V=[t],N=_n(e.value);try{var O=function(){var e,n=F.value.target,r=new Oi(n.row,n.col,1,1,M),a=[],o=_n(V);try{var i=function(){var o=e.value,i=QX(o.value.target),u=new Oi(n.row,n.col,n.row_count,n.col_count,M),s=new Oi(i.row,i.col,i.rowCount,i.colCount,M),l=s.sub(u);if(s.contain(r)){var c=u.sub(r);if(o.value.style){var h=ya(o.value.style);delete h.dropdown,(0,se.default)(h)||c.forEach((function(e){var t=e.toJSON();a.push({action:o.action,sheet_id:o.sheet_id,value:{target:{type:we.xj7.NORMAL,row:t.row,col:t.col,rowCount:t.rowCount,colCount:t.colCount},style:h}})}))}l.push(r)}for(var f=function(e){var n=l[e].toJSON(),r=RQ(t,(function(e){e.value.target={type:e.value.target.type,row:n.row,col:n.col,rowCount:n.rowCount,colCount:n.colCount}}));a.push(r)},d=0;d<l.length;d++)f(d)};for(o.s();!(e=o.n()).done;)i()}catch(e){o.e(e)}finally{o.f()}V=[].concat(a)};for(N.s();!(F=N.n()).done;)O()}catch(e){N.e(e)}finally{N.f()}return VQ(V);case"sort":var x=JX(e.target),Z=QX(t.value.target);if(nQ(x,Z)){var D=function(){for(var n=(new DQ).createSheetFromId(t.sheet_id),r=new Oi(x.row,x.col,x.rowCount,x.colCount,n),a=new Oi(Z.row,Z.col,Z.rowCount,Z.colCount,n),o=a.intersect(r),i=[],u={},s=0;s<e.value.length;s++)u[e.value[s]]=s;if(null!==o){var l,c=new Oi(o.rowFrom(),o.colFrom(),o.rowCount(),o.colCount(),n),h=_n(c.splitByRow());try{var f=function(){var n=l.value,r=n.rowFrom(),a=RQ(t,(function(t){t.value.target={type:we.xj7.NORMAL,row:u[r]+e.target.row,col:n.colFrom(),rowCount:n.rowCount(),colCount:n.colCount()}}));i.push(a)};for(h.s();!(l=h.n()).done;)f()}catch(e){h.e(e)}finally{h.f()}for(var d=a.sub(c),v=function(e){var n=d[e].toJSON(),r=RQ(t,(function(e){e.value.target={type:we.xj7.NORMAL,row:n.row,col:n.col,rowCount:n.rowCount,colCount:n.colCount}}));i.push(r)},g=0;g<d.length;g++)v(g)}return{v:VQ(i)}}();if("object"===(0,_.Z)(D))return D.v}return t;case"moveRange":var P=e.value,L=P.target,B=P.source,U=QX(t.value.target),H=Object.assign({sheetId:t.sheet_id},U),W=P0(B,H),j=P0(L,H);if(!W&&!j)return t;var z,G=(new DQ).createSheetFromId(e.value.source.sheetId),J=(new DQ).createSheetFromId(e.value.target.sheetId),q=[ya(t)];if(W){var $=q.shift(),Y=new Oi(B.row,B.col,B.rowCount,B.colCount,G),K=new Oi(U.row,U.col,U.rowCount,U.colCount,G),X=K.intersect(Y),Q=new _Q($);Q.setOp((function(e){e.sheet_id=L.sheetId})),Q.setOp((function(e){e.value.target.row=L.row+(X.rowFrom()-B.row),e.value.target.col=L.col+(X.colFrom()-B.col),e.value.target.rowCount=X.rowCount(),e.value.target.colCount=X.colCount()})),z=Q.getOp();var ee,te=K.sub(X),ne=_n(te);try{var re=function(){var e=ee.value,t=RQ($,(function(t){t.value.target.row=e.rowFrom(),t.value.target.col=e.colFrom(),t.value.target.rowCount=e.rowCount(),t.value.target.colCount=e.colCount()}));q.push(t)};for(ne.s();!(ee=ne.n()).done;)re()}catch(e){ne.e(e)}finally{ne.f()}}if(j){var ae,oe=new Oi(L.row,L.col,L.rowCount,L.colCount,J),ie=[],ue=_n(q);try{for(ue.s();!(ae=ue.n()).done;){var le,ce=ae.value,he=new Oi(ce.value.target.row,ce.value.target.col,ce.value.target.rowCount,ce.value.target.colCount,J).sub(oe),fe=_n(he);try{var de=function(){var e=le.value,n=RQ(t,(function(t){t.value.target.row=e.rowFrom(),t.value.target.col=e.colFrom(),t.value.target.rowCount=e.rowCount(),t.value.target.colCount=e.colCount()}));ie.push(n)};for(fe.s();!(le=fe.n()).done;)de()}catch(e){fe.e(e)}finally{fe.f()}}}catch(e){ue.e(e)}finally{ue.f()}q=ie}return z&&q.push(z),VQ(q)}return t}function I0(e,t){var n=!1;for(var r in"string"==typeof t.value&&(n=!0,t.value=JSON.parse(t.value)),e.value)t.value[r]=e.value[r];n&&(t.value=JSON.stringify(t.value))}function b0(e,t){if(e.fontInfo)if(t.fontInfo){var n=fd.withUpdate(t.fontInfo,e.fontInfo);t.fontInfo=n.toJSON(),delete t.font}else if(ld())t.font=wa._updateFont(t.font||"",e.fontInfo).font;else{var r=fd.valueOf(t.font);r=fd.withUpdate(r,e.fontInfo),t.fontInfo=r.toJSON(),delete t.font}for(var a in e.textDecoration&&((0,ge.default)(e.textDecoration)?t.textDecoration=e.textDecoration:t.textDecoration=wa._updateTextDecoration(t.textDecoration,e.textDecoration)),e)"fontInfo"!==a&&"textDecoration"!==a&&(t[a]=e[a])}function F0(e,t){var n=!1;for(var r in"string"==typeof t.value&&(n=!0,t.value=JSON.parse(t.value)),e.value)"style"!==r&&(t.value[r]=e.value[r]);e.value.style?(t.value.style=t.value.style?t.value.style:{},b0(e.value.style,t.value.style)):e.value.hasOwnProperty("style")&&(t.value.style=null),n&&(t.value=JSON.stringify(t.value))}function M0(e){return Xk((new DQ).createSheetFromId("mock"),e)}function V0(e,t){return e.setRowFrom(t.row),e.setColFrom(t.col),e.setRowCount(t.rowCount),e.setColCount(t.colCount),e.toString({ref:e})}function N0(e,t){if(e.sheet_id!==t.sheet_id)return t;if("delSparklineGroup"===t.action)return t;var n=ya(t);switch(e.action){case"addRow":n=RQ(n,(function(n){for(var r=0,a=Object.entries(t.value);r<a.length;r++){var o=(0,p.Z)(a[r],2),i=o[0],u=o[1];if(null!=u&&u.sparklines)for(var s=0,l=Object.entries(u.sparklines);s<l.length;s++){var c=(0,p.Z)(l[s],2),h=c[0],f=c[1];if(f){if(f.position){var d=O0(e.target,0,f.position,!0);d&&(n.value[i].sparklines[h].position.row=d.row)}var v=M0(f.source);if(v){var g=x0(e.target,0,v.toJSON(),!0);g&&(n.value[i].sparklines[h].source=V0(v,g))}}}}}));break;case"addCol":n=RQ(n,(function(n){for(var r=0,a=Object.entries(t.value);r<a.length;r++){var o=(0,p.Z)(a[r],2),i=o[0],u=o[1];if(null!=u&&u.sparklines)for(var s=0,l=Object.entries(u.sparklines);s<l.length;s++){var c=(0,p.Z)(l[s],2),h=c[0],f=c[1];if(f){if(f.position){var d=O0(e.target,1,f.position,!1);d&&(n.value[i].sparklines[h].position.col=d.col)}var v=M0(f.source);if(v){var g=x0(e.target,1,v.toJSON(),!1);g&&(n.value[i].sparklines[h].source=V0(v,g))}}}}}));break;case"delRow":n=RQ(n,(function(n){for(var r=0,a=Object.entries(t.value);r<a.length;r++){var o=(0,p.Z)(a[r],2),i=o[0],u=o[1];if(null!=u&&u.sparklines)for(var s=0,l=Object.entries(u.sparklines);s<l.length;s++){var c=(0,p.Z)(l[s],2),h=c[0],f=c[1];if(null!=f&&f.position){var d=O0(e.target,2,f.position,!0);if(!d){var v;null===(v=n.value[i])||void 0===v||delete v.sparklines[h];break}n.value[i].sparklines[h].position.row=d.row}if(null!=f&&f.source){var g=M0(f.source);if(!g)break;var m=x0(e.target,2,g.toJSON(),!0);m&&(n.value[i].sparklines[h].source=V0(g,m))}}}}));break;case"delCol":n=RQ(n,(function(n){for(var r=0,a=Object.entries(t.value);r<a.length;r++){var o=(0,p.Z)(a[r],2),i=o[0],u=o[1];if(u.sparklines)for(var s=0,l=Object.entries(u.sparklines);s<l.length;s++){var c=(0,p.Z)(l[s],2),h=c[0],f=c[1];if(null!=f&&f.position){var d=O0(e.target,3,f.position,!1);if(!d){delete n.value[i].sparklines[h];break}n.value[i].sparklines[h].position.col=d.col}if(null!=f&&f.source){var v=M0(f.source);if(!v)break;var g=x0(e.target,3,v.toJSON(),!1);g&&(n.value[i].sparklines[h].source=V0(v,g))}}}}));break;case"moveRange":n=RQ(n,(function(n){var r=e.value,a=r.source,o=r.target;if(a.sheetId===t.sheet_id||o.sheetId===t.sheet_id)for(var i=a.sheetId!==o.sheetId,u=Object.assign({},e.value.source,{type:e.value.type}),s=Object.assign({},e.value.target,{type:e.value.type}),l=0,c=Object.entries(t.value);l<c.length;l++){var h=(0,p.Z)(c[l],2),f=h[0],d=h[1];if(d.sparklines)for(var v=0,g=Object.entries(d.sparklines);v<g.length;v++){var m=(0,p.Z)(g[v],2),y=m[0],C=m[1];if(null!=C&&C.position){var _=YX(C.position,t.sheet_id);if(a.sheetId===t.sheet_id&&P0(u,_)){if(i){delete n.value[f].sparklines[y];break}n.value[f].sparklines[y].position={row:e.value.target.row+C.position.row-e.value.source.row,col:e.value.target.col+C.position.col-e.value.source.col}}else if(o.sheetId===t.sheet_id&&P0(s,_)){delete n.value[f].sparklines[y];break}}var R=M0(null==C?void 0:C.source);if(R&&!i){var w=Object.assign({},R.toJSON(),{type:we.xj7.NORMAL});L0(u,w)&&(R.setRowFrom(e.value.target.row+w.row-e.value.source.row),R.setColFrom(e.value.target.col+w.col-e.value.source.col),R.setRowCount(w.rowCount),R.setColCount(w.colCount),n.value[f].sparklines[y].source=R.toString({ref:R}))}}}}))}return n}function O0(e,t,n,r){return dQ({type:t,index:r?e.row:e.col,count:r?e.row_count:e.col_count},GX(n.row,n.col))}function x0(e,t,n,r){return dQ({type:t,index:r?e.row:e.col,count:r?e.row_count:e.col_count},JX({row:n.row,col:n.col,row_count:n.rowCount,col_count:n.colCount}))}function Z0(e){return["addSparklineGroup","updateSparklineGroup","delSparklineGroup"].includes(e.action)}function D0(e,t){var n=Object.assign({},t.value.source,{type:t.value.type}),r=Object.assign({},t.value.target,{type:t.value.type});switch(e.action){case"sort":case"setSpans":var a=qX(e.target,e.sheet_id);return!P0(a,n)&&!P0(a,r)&&t;case"delSheet":var o=e.sheet_id===t.value.source.sheetId,i=e.sheet_id===t.value.target.sheetId;return o&&i?null:!o&&!i&&t;case"addRow":var u=t.value.source.row,s=u+t.value.source.rowCount-1,l=t.value.target.row,c=l+t.value.target.rowCount-1,h=e.target.row,f=e.sheet_id===t.value.source.sheetId,d=e.sheet_id===t.value.target.sheetId;if(f&&h>u&&h<s)return!1;if(d&&h>l&&h<c)return!1;var v=new _Q(t);return f&&h<=u&&v.setOp((function(t){return t.value.source.row+=e.target.row_count})),d&&h<=l&&v.setOp((function(t){return t.value.target.row+=e.target.row_count})),v.getOp();case"addCol":var g=t.value.source.col,m=g+t.value.source.colCount-1,p=t.value.target.col,y=p+t.value.target.colCount-1,C=e.target.col,_=e.sheet_id===t.value.source.sheetId,R=e.sheet_id===t.value.target.sheetId;if(_&&C>g&&C<m)return!1;if(R&&C>p&&C<y)return!1;var w=new _Q(t);return _&&C<=g&&w.setOp((function(t){return t.value.source.col+=e.target.col_count})),R&&C<=p&&w.setOp((function(t){return t.value.target.col+=e.target.col_count})),w.getOp();case"delRow":var k=t.value.source.row,S=t.value.target.row,E=UX(e.target,e.sheet_id),T=e.target.row,A=e.sheet_id===t.value.source.sheetId,I=e.sheet_id===t.value.target.sheetId;if(P0(E,n))return!1;if(P0(E,r))return!1;var b=new _Q(t);return A&&T<=k&&b.setOp((function(t){return t.value.source.row-=e.target.row_count})),I&&T<=S&&b.setOp((function(t){return t.value.target.row-=e.target.row_count})),b.getOp();case"delCol":var F=t.value.source.col,M=t.value.target.col,V=jX(e.target,e.sheet_id),N=e.target.col,O=e.sheet_id===t.value.source.sheetId,x=e.sheet_id===t.value.target.sheetId;if(P0(V,n))return!1;if(P0(V,r))return!1;var Z=new _Q(t);return O&&N<=F&&Z.setOp((function(t){return t.value.source.col-=e.target.col_count})),x&&N<=M&&Z.setOp((function(t){return t.value.target.col-=e.target.col_count})),Z.getOp()}return t}function P0(e,t){return e.sheetId===t.sheetId&&nQ(e,t)}function L0(e,t){return e.type===we.xj7.ALL||(e.type===we.xj7.ROW?e.row<=t.row&&e.row+e.rowCount>=t.row+t.rowCount:e.type===we.xj7.COL?e.col<=t.col&&e.col+e.colCount>=t.col+t.colCount:e.type===we.xj7.CELL?e.row===t.row&&e.rowCount===t.rowCount&&e.col===t.col&&e.colCount===t.colCount:e.type===we.xj7.NORMAL&&e.row<=t.row&&e.row+e.rowCount>=t.row+t.rowCount&&e.col<=t.col&&e.col+e.colCount>=t.col+t.colCount)}function B0(e){return"moveRange"===e.action}var U0=function(e,t){if("delSheet"===e.action)return null;switch(e.action){case"addRow":return W0(t,"row","row_count",e.target.row,e.target.row_count);case"addCol":return W0(t,"col","col_count",e.target.col,e.target.col_count);case"delRow":return j0(t,"row","row_count",e.target.row,e.target.row_count);case"delCol":return j0(t,"col","col_count",e.target.col,e.target.col_count)}return t},H0=function(e,t){return"delSheet"===e.action?null:t},W0=function(e,t,n,r,a){var o=e.target[t],i=e.target[t]+e.target[n]-1,u=r-1;return u>=o&&u<i?RQ(e,(function(e){e.target[n]+=a})):u<o?RQ(e,(function(e){e.target[t]+=a})):e},j0=function(e,t,n,r,a){var o=e.target[t],i=e.target[t]+e.target[n]-1,u=r+a-1;return u<o?RQ(e,(function(e){e.target[t]-=a})):r<=o&&u>=o&&u<i?RQ(e,(function(e){e.target[t]=r,e.target[n]-=u-o+1})):r>o&&r<i&&u<i?RQ(e,(function(e){e.target[n]-=a})):r<=o&&u>=i?null:r>o&&r<=i&&u>=i?RQ(e,(function(e){e.target[n]=r-o})):e},z0=function(e,t){var n=arguments.length>2&&void 0!==arguments[2]&&arguments[2];switch(t.action){case"setRangeProtection":case"delRangeProtection":return e.value.perm_id!==t.value.id?t:n||"unlockRow"===e.action||"unlockCol"===e.action?null:t}return t},G0=function(e){var t=e.type;return t===we.xj7.NORMAL?JX(e):t===we.xj7.ROW?BX(e):WX(e)},J0=function(e){var t=e.type;return t&&t!==we.xj7.NORMAL?t===we.xj7.ROW?Object.assign({},HX(e),{type:t}):Object.assign({},zX(e),{type:t}):Object.assign({},$X(e),{type:we.xj7.NORMAL})},q0=function(e,t){if("delRangeProtection"===t.action)return t;switch(e.action){case"addRow":var n=BX(e.target),r=t.value.ranges.map((function(e){if(e.type===we.xj7.COL)return e;var t=G0(e);return J0(SQ(t,n))}));return RQ(t,(function(e){e.value.ranges=r}));case"delRow":var a=BX(e.target),o=[];return t.value.ranges.forEach((function(e){if(e.type!==we.xj7.COL){var t=TQ(G0(e),a);t&&o.push(J0(t))}else o.push(e)})),o.length<1?null:RQ(t,(function(e){e.value.ranges=o}));case"addCol":var i=WX(e.target),u=t.value.ranges.map((function(e){if(e.type===we.xj7.ROW)return e;var t=G0(e);return J0(EQ(t,i))}));return RQ(t,(function(e){e.value.ranges=u}));case"delCol":var s=WX(e.target),l=[];return t.value.ranges.forEach((function(e){if(e.type!==we.xj7.ROW){var t=AQ(G0(e),s);t&&l.push(J0(t))}else l.push(e)})),l.length<1?null:RQ(t,(function(e){e.value.ranges=l}))}return t};function $0(e){return["setRangeProtection","delRangeProtection"].includes(e.action)}function Y0(e,t){if(t.value.range){var n=WX(e.target),r=JX(t.value.range),a=EQ(r,n);return r===a?t:RQ(t,(function(e){e.value.range=$X(a),e.value.filter_value&&(e.value.filter_value.col=cQ(e.value.filter_value.col,{index:n.col,count:n.colCount}))}))}return t}function K0(e,t){var n=new _Q(t);if(t.value.range){var r=WX(e.target),a=JX(t.value.range),o=AQ(a,r);null!==o&&o!==a&&n.setOp((function(e){e.value.range=$X(o)}))}if(t.value.filter_value){var i=t.value.filter_value.col;if(e.target.col<=i)if(e.target.col+e.target.col_count-1<i)n.setOp((function(t){t.value.filter_value.col=t.value.filter_value.col-e.target.col_count}));else{if(!t.value.range)return null;n.setOp((function(e){e.value.filter_value=null}))}}return n.getOp()}function X0(e,t){if((0,se.default)(e.value)||(0,se.default)(e.value.filteredRowsMap))return e;var n=JX(e.target),r=JX(t.target);if(nQ(n,r)){var a=e.value,o=a.filteredRowsMap,i=a.col;return RQ(e,(function(e){e.value.filteredRowsMap=o.map((function(e,a){if(i!==a+n.col||i<r.col||i>=r.col+r.colCount)return e;var o=[];return e.forEach((function(e){var a=t.value.findIndex((function(t){return t===e}));if(-1!==a){var i=a+r.row;n.row<i&&i<n.row+n.rowCount&&o.push(i)}else o.push(e)})),o}))}))}return e}function Q0(e){if(e.value&&e.value.filteredRowsMap)for(var t=e.value.filteredRowsMap,n=0;n<e.target.col_count;n++)t[n]||(t[n]=[])}function e1(e,t){var n=BX(e.target);return("sort"!==t.action||!nQ(n,JX(t.target)))&&t}function t1(e,t){return!nQ(JX(e.target),KX(t.target))&&t}function n1(e,t,n,r,a){if(r&&a)for(var o=0;o<a.length;o++){var i=a[o].toJSON();i.colCount>0&&i.rowCount>0&&e.push({action:"setRange",sheet_id:t,value:{target:Object.assign({type:we.xj7.NORMAL},i),value:null}})}e.push({action:"setRange",sheet_id:t,value:{target:Object.assign({type:we.xj7.NORMAL},n),style:null}})}var r1=function(e){return function(t,n,r){var a=e[n.action];return a?a(t,n,r):n}}({moveRange:D0,setRange:A0,updateRange:A0,sort:function(e,t){var n=JX(t.target);return!nQ(JX(e.target),n)&&t},setValue:t1,setFormula:t1,setStyle:t1,setCell:function(e,t){var n=KX(t.target);return nQ(JX(e.target),n)?function(e,t){var n,r={row:t.target.row,col:t.target.col,row_count:1,col_count:1},a=_n(e.value);try{for(a.s();!(n=a.n()).done;){var o=n.value;if(rQ(o.target,r)){if(!function(e,t){return e.row===t.row&&e.col===t.col}(o.target,r))return null;var i=[];if(t.value.hasOwnProperty("style"))for(var u=t.value.style,s=o.target,l=s.row,c=s.col,h=s.row_count,f=s.col_count,d=l;d<l+h;d++)for(var v=c;v<c+f;v++)if(d!==l||v!==c){var g={action:"setCell",sheet_id:t.sheet_id,target:{row:d,col:v},value:{style:Object.assign({},u,{dropdown:null})}};t.hasOwnProperty("type")&&(g.type=t.type),t.hasOwnProperty("extra")&&(g.extra=t.extra),i.push(g)}if(i.length>0)return i.unshift(t),i}}}catch(e){a.e(e)}finally{a.f()}return t}(e,t):t},setSpans:function(e,t,n){var r=JX(e.target),a=JX(t.target);if(!nQ(r,a))return t;var o=[],i=(new DQ).createSheetFromId(e.sheet_id);if(n)for(var u=new Oi(r.row,r.col,r.rowCount,r.colCount,i),s=new Oi(a.row,a.col,a.rowCount,a.colCount,i).sub(u),l=0;l<s.length;l++){var c=s[l].toJSON();o.push({action:"setSpans",sheet_id:e.sheet_id,target:{row:c.row,col:c.col,row_count:c.rowCount,col_count:c.colCount},value:[]})}var h,f=_n(e.value);try{for(f.s();!(h=f.n()).done;){var d,v=h.value.target,g=_n(t.value);try{for(g.s();!(d=g.n()).done;){var m=d.value.target,p=JX(v),y=JX(m);if(nQ(p,y)){var C=new Oi(y.row,y.col,1,1,i),_=new Oi(y.row,y.col,y.rowCount,y.colCount,i).sub(C);n1(o,t.sheet_id,p,!1),n1(o,t.sheet_id,y,n,_)}}}catch(e){g.e(e)}finally{g.f()}}}catch(e){f.e(e)}finally{f.f()}return n||o.push(t),o},setRangeValues:a0});function a1(e,t){var n=arguments.length>2&&void 0!==arguments[2]&&arguments[2];if(!(0,we.It9)(t))return t;switch(t.action){case"addSheet":return(0,E.Z)(i1,(function(t){return a1(e,t,n)}),(function(e){return!1!==e&&(Array.isArray(e)?e.map((function(e){return"copySheet"===e.action?u1(e):e})):"copySheet"===e.action?u1(e):e)}))(t);case"setSheet":if(e.value.sheet_id===t.sheet_id||e.value.sheet_name===t.value.sheet_name)return!1;break;case"copySheet":case"addBlock":case"restoreBlock":if(!wQ(e,t))return!1;if(e.value.sheet_id===t.value.sheet_id)return!1;if(e.sheet_id===t.value.sheet_id)return!1;if("copySheet"===t.action&&null==t.value.snapshot&&(e.sheet_id===t.sheet_id||e.value.sheet_id===t.sheet_id))return!1;var r=new _Q(t),a=(0,hn.addFollowAdd)(e.value.index,t.value.index,n);if(a!==t.value.index&&r.setOp((function(e){e.value.index=a})),e.value.sheet_name===t.value.sheet_name){if(n){var o=o1(t);return r.setOp((function(e){e.value.sheet_name=o,"copySheet"===e.action&&null!=e.value.snapshot&&(e.value.snapshot.name=o)})),r.getOp()}return[{action:"setSheet",sheet_id:e.value.sheet_id,value:{origin_name:e.value.sheet_name,sheet_name:o1(e)}},r.getOp()]}return r.getOp();case"moveSheet":var i=(0,hn.addFollowMove)(e.value.index,t.value.source,t.value.target,n);if(null!=i&&(t.value.source!==i.source||t.value.target!==i.target))return RQ(t,(function(e){e.value.source=i.source,e.value.target=i.target}));break;case"delSheet":case"delBlock":if(e.value.sheet_id===t.sheet_id)return!1;var u=(0,hn.addFollowDelete)(e.value.index,t.value.index,n);if(u!==t.value.index)return RQ(t,(function(e){e.value.index=u}));break;case"softDelSheet":case"restoreSheet":case"lockSheet":case"unlockSheet":break;default:kQ(t)}return t}function o1(e){return"".concat(e.value.sheet_name,"_conflict_").concat(e.value.sheet_id)}function i1(e){return{action:"copySheet",sheet_id:e.sheet_id,value:{sheet_id:e.sheet_id,sheet_name:e.sheet_name,index:e.value.index}}}function u1(e){return{action:"addSheet",sheet_id:e.sheet_id,sheet_name:e.value.sheet_name,value:{index:e.value.index}}}function s1(e,t){var n=arguments.length>2&&void 0!==arguments[2]&&arguments[2];switch(t.action){case"addBlock":case"restoreBlock":if(e.value.block_id===t.value.block_id)return!1}return a1(e,t,n)}var l1=new Set(["addView","delView","setFilterView","setView"]);function c1(e,t){var n=arguments.length>2&&void 0!==arguments[2]&&arguments[2];if(B0(t))return D0(e,t,n);if(n&&((0,we.i55)(t)||"setRangeValues"===t.action)&&t.sheet_id===e.sheet_id)return null;if("setDataRange"===t.action)return U0(e,t);if("delDataRange"===t.action)return H0(e,t);if(!(0,we.It9)(t))return e.sheet_id===t.sheet_id?!!l1.has(t.action)&&null:t;switch(t.action){case"addSheet":case"copySheet":case"addBlock":case"restoreBlock":if(e.sheet_id===t.sheet_id)return!1;var r=(0,hn.deleteFollowAdd)(e.value.index,t.value.index,n);if(r!==t.value.index)return RQ(t,(function(e){return e.value.index=r}));break;case"moveSheet":if(e.sheet_id===t.sheet_id)return null;var a=(0,hn.deleteFollowMove)(e.value.index,t.value.source,t.value.target,n);if(null==a)return null;if(t.value.source!==a.source||t.value.target!==a.target)return RQ(t,(function(e){e.value.source=a.source,e.value.target=a.target}));break;case"delSheet":case"delBlock":case"setSheet":if(e.sheet_id===t.sheet_id)return null}return e.sheet_id!==t.sheet_id&&t}function h1(e,t,n,r){if(!nQ(e,t))return r;var a=function(e,t){var n=t.value.indexOf(e);return-1===n?e:t.target.row+n}(r.target.row,n);return a!==r.target.row?RQ(r,(function(e){e.target.row=a})):r}var f1=function(e,t){var n=(0,p.Z)(e,2),r=n[0],a=n[1],o=(0,p.Z)(t,2),i=o[0];return r<=o[1]&&a>=i},d1=function(e,t){return f1([e.row,e.row+e.row_count],[t.row,t.row+t.row_count])&&f1([e.col,e.col+e.col_count],[t.col,t.col+t.col_count])};function v1(e,t){var n=arguments.length>2&&void 0!==arguments[2]&&arguments[2];if(e.value.view_id!==t.value.view_id)return t;var r=e.value.range,a=t.value.range;if(r&&a&&d1(r,a)){var o=Math.min(r.row,a.row),i=Math.max(r.row+r.row_count,a.row+a.row_count),u=Math.min(r.col,a.col),s=Math.max(r.col+r.col_count,a.col+a.col_count);t=RQ(t,(function(e){e.value.range={row:o,row_count:i-o,col:u,col_count:s-u}}))}var l=e.value.filter_value,c=t.value.filter_value;return l&&c?g1(e,t,n):t}function g1(e,t){var n=arguments.length>2&&void 0!==arguments[2]&&arguments[2],r=e.value.filter_value,a=t.value.filter_value;if(r.col!==a.col)return t;var o=null===r.type&&!r.contents,i=null===a.type&&!a.contents;return o&&!i?null:!o&&i||n?t:null}function m1(e,t){return e+"_conflict_"+t}function p1(e){return e.value.name=e.value.name+"_conflict_"+e.value.view_id,e}var y1={sort:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]&&arguments[2];if(!("target"in t))return B0(t)?D0(e,t,n):(0,we.i55)(t)?A0(e,t,n):("setFilterView"!==t.action||!t.value.range||!nQ(JX(e.target),JX(t.value.range)))&&t;var r=JX(e.target);switch(t.action){case"sort":case"setSpans":if(nQ(r,JX(t.target)))return!1;break;case"setEmbeddedBlock":case"delEmbeddedBlock":if(nQ(r,JX(Object.assign({},t.target,{row_count:1,col_count:1}))))return!1;break;case"delRow":case"hideRow":if(nQ(r,BX(t.target)))return!1;break;case"addRow":case"addCol":case"delCol":case"setRowHeight":case"setColumnWidth":case"freezeSheet":case"hideCol":case"unhideCol":case"unhideRow":case"lockCol":case"unlockCol":case"lockRow":case"unlockRow":case"setChart":case"setFloatImage":case"setColProperty":case"setDataRange":case"setRowProperty":case"addOutline":case"delOutline":case"updateOutline":return t;case"setFilter":return X0(t,e);case"setValue":case"setStyle":case"setFormula":case"setCell":case"addComments":return h1(r,KX(t.target),e,t);case"setRangeValues":return a0(e,t,n);default:kQ(t)}return t},setSpans:r1,addRow:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]&&arguments[2];if(!("target"in t)){if(bQ(t))return IQ(e,t);if(OQ(t))return NQ(e,t);if(B0(t))return D0(e,t,n);if((0,we.i55)(t))return A0(e,t,n);if("setFilterView"===t.action&&t.value.range){var r=JX(t.value.range),a=SQ(r,BX(e.target));return r===a?t:RQ(t,(function(e){e.value.range=$X(a)}))}return $0(t)?q0(e,t):t}if(ZQ(t))return xQ(e,t);if(Z0(t))return N0(e,t);var o=BX(e.target);switch(t.action){case"setRangeValues":return a0(e,t,n);case"setSpans":var i=JX(t.target),u=SQ(i,o);return i===u?t:RQ(t,(function(e){e.target=$X(u),e.value=e.value.map((function(e){var t=JX(e.target),n=SQ(t,o);return n!==t&&(e.target=$X(n)),e}))}));case"setDataRange":return U0(e,t);case"sort":var s=JX(t.target),l=SQ(s,o);return s===l?t:RQ(t,(function(t){t.target=$X(l);for(var n=0;n<t.value.length;n++)t.value[n]>=e.target.row&&(t.value[n]+=o.rowCount);var r=o.row-s.row;if(r>0){var a,i=(0,T.Z)(o.row,o.row+o.rowCount);(a=t.value).splice.apply(a,[r,0].concat((0,m.Z)(i)))}}));case"addCol":case"delCol":case"setColumnWidth":case"setColProperty":case"hideCol":case"unhideCol":case"lockCol":case"unlockCol":break;case"freezeSheet":var c=sQ(t.target.row,{index:o.row,count:o.rowCount});if(c!==t.target.row)return RQ(t,(function(e){e.target.row=c}));break;case"setValue":case"setStyle":case"setFormula":case"setCell":case"setFloatImage":case"addComments":var h=KX(t.target),f=SQ(h,o);return h===f?t:RQ(t,(function(e){e.target=XX(f)}));case"lockRow":case"unlockRow":var d=BX(t.target),v=SQ(d,o);return d===v?t:RQ(t,(function(e){e.target=HX(v)}));case"addRow":if(t.target.row>o.row||!n&&t.target.row===o.row)return RQ(t,(function(e){e.target.row+=o.rowCount}));break;case"delRow":case"hideRow":case"unhideRow":case"setRowProperty":case"setRowHeight":var g=BX(t.target),p=SQ(g,o,"Split");return g===p?t:Array.isArray(p)?p.map((function(e){return RQ(t,(function(t){return t.target=HX(e)}))})):RQ(t,(function(e){return e.target=HX(p)}));case"setFilter":var y=JX(t.target),C=SQ(y,o);return y===C?t:RQ(t,(function(t){t.target=$X(C),null!=t.value&&null!=t.value.filteredRowsMap&&(t.value.filteredRowsMap=t.value.filteredRowsMap.map((function(t){return t.map((function(t){return t>=o.row?t+e.target.row_count:t}))})))}));case"setChart":var _=new _Q(t);if(e.sheet_id===t.sheet_id){var R=KX(t.target),w=SQ(R,o);w!==R&&_.setOp((function(e){e.target=XX(w)}))}return _.setOp((function(t){yQ({type:0,index:e.target.row,count:e.target.row_count},e.sheet_id,t.value.graphSetting)})),_.getOp();case"addOutline":case"delOutline":case"updateOutline":return t;default:return kQ(t),!1}return t},delRow:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]&&arguments[2];if(!("target"in t)){if(bQ(t))return IQ(e,t);if(OQ(t))return NQ(e,t);if(B0(t))return D0(e,t,n);if((0,we.i55)(t))return A0(e,t,n);if("setFilterView"===t.action&&t.value.range){var r=BX(e.target),a=JX(t.value.range);if(r.row<=a.row&&a.row<r.row+r.rowCount)return null;var o=TQ(a,r);return null==o?null:o===a?t:RQ(t,(function(e){e.value.range=$X(o),e.value}))}return $0(t)?q0(e,t):t}if(ZQ(t))return xQ(e,t);if(Z0(t))return N0(e,t);var i=BX(e.target);switch(t.action){case"setRangeValues":return a0(e,t,n);case"setSpans":var u=JX(t.target),s=TQ(u,i);if(s===u)return t;if(null==s)return null;var l=ya(t);l.target=$X(s);for(var c=[],h=[],f=0;f<t.value.length;f++){var d=JX(t.value[f].target),v=TQ(d,i);v!==d?null!=v&&((v.rowCount>1||v.colCount>1)&&c.push(Object.assign({},t.value[f],{target:$X(v)})),n&&d.row>=e.target.row&&d.row<=e.target.row+e.target.row_count-1&&h.push({action:"setCell",sheet_id:t.sheet_id,target:{row:v.row,col:v.col},value:{value:null,style:null,formula:null}})):c.push(t.value[f])}return l.value=c,n?c.length>0&&h.length>0?[l].concat(h):c.length>0?l:h.length>0?h:null:l;case"setDataRange":return U0(e,t);case"sort":var g=JX(t.target);if(nQ(i,g))return!1;var m=TQ(g,i);if(null==m)return null;if(m!==g)return RQ(t,(function(e){e.target=$X(m),e.value.length>0&&(e.value=e.value.map((function(e){return e-i.rowCount})))}));break;case"addRow":var p=lQ(t.target.row,{index:i.row,count:i.rowCount});if(p!==t.target.row)return RQ(t,(function(e){return e.target.row=p}));break;case"delRow":case"hideRow":case"unhideRow":case"lockRow":case"unlockRow":case"setRowProperty":case"setRowHeight":var y=BX(t.target),C=TQ(y,i);if(null==C)return null;if(C!==y)return RQ(t,(function(e){e.target=HX(C)}));break;case"setValue":case"setStyle":case"setFormula":case"setCell":case"setFloatImage":case"addComments":var _=KX(t.target),R=TQ(_,i);if(null==R)return null;if(R!==_)return RQ(t,(function(e){return e.target=XX(R)}));break;case"freezeSheet":var w=lQ(t.target.row,{index:i.row,count:i.rowCount});if(w!==t.target.row)return RQ(t,(function(e){return e.target.row=w}));break;case"addCol":case"delCol":case"setColumnWidth":case"setColProperty":case"hideCol":case"unhideCol":case"lockCol":case"unlockCol":break;case"setFilter":var k=JX(t.target);if(i.row<=k.row&&k.row<i.row+i.rowCount)return null;var S=TQ(k,i);return null==S?null:S===k?t:RQ(t,(function(e){if(e.target=$X(S),null!=e.value&&null!=e.value.filteredRowsMap){var t=e.value.filteredRowsMap;e.value.filteredRowsMap=t.map((function(e){for(var t=[],n=0;n<e.length;n++){var r=e[n],a=TQ({type:we.xj7.ROW,row:r,rowCount:1},i);null!=a&&t.push(a.row)}return t}))}}));case"setChart":var E=new _Q(t);if(e.sheet_id===t.sheet_id){var T=hQ(t.target.row,{index:e.target.row,count:e.target.row_count});T!==t.target.row&&E.setOp((function(e){e.target.row=T}))}return E.setOp((function(t){var n=t.value.graphSetting;yQ({type:2,index:e.target.row,count:e.target.row_count},e.sheet_id,n)})),E.getOp();case"addOutline":case"delOutline":case"updateOutline":return t;default:return kQ(t),!1}return t},addCol:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]&&arguments[2];if(!("target"in t))return bQ(t)?IQ(e,t):OQ(t)?NQ(e,t):B0(t)?D0(e,t,n):(0,we.i55)(t)?A0(e,t,n):"setFilterView"===t.action?Y0(e,t):$0(t)?q0(e,t):t;if(ZQ(t))return xQ(e,t);if(Z0(t))return N0(e,t);var r=WX(e.target);switch(t.action){case"setSpans":var a=JX(t.target),o=EQ(a,r);return a===o?t:RQ(t,(function(e){e.target=$X(o),e.value=e.value.map((function(e){var t=JX(e.target),n=EQ(t,r);return n!==t&&(e.target=$X(n)),e}))}));case"setDataRange":return U0(e,t);case"sort":var i=JX(t.target),u=EQ(i,r);return i===u?t:RQ(t,(function(e){e.target=$X(u)}));case"setValue":case"setStyle":case"setFormula":case"setCell":case"setFloatImage":case"addComments":var s=KX(t.target),l=EQ(s,r);return s===l?t:RQ(t,(function(e){e.target=XX(l)}));case"setRangeValues":return a0(e,t,n);case"freezeSheet":var c=sQ(t.target.col,{index:r.col,count:r.colCount});if(c!==t.target.col)return RQ(t,(function(e){e.target.col=c}));break;case"addCol":if(t.target.col>r.col||!n&&t.target.col===r.col)return RQ(t,(function(e){e.target.col+=r.colCount}));break;case"delCol":case"hideCol":case"unhideCol":case"setColProperty":case"setColumnWidth":var h=WX(t.target),f=EQ(h,r,"Split");return h===f?t:Array.isArray(f)?f.map((function(e){return RQ(t,(function(t){return t.target=zX(e)}))})):RQ(t,(function(e){return e.target=zX(f)}));case"lockCol":case"unlockCol":var d=WX(t.target),v=EQ(d,r);return d===v?t:RQ(t,(function(e){e.target=zX(v)}));case"addRow":case"delRow":case"setRowHeight":case"setRowProperty":case"hideRow":case"unhideRow":case"lockRow":case"unlockRow":break;case"setFilter":if(r.col>t.target.col&&r.col<t.target.col+t.target.col_count){var g=new _Q(t);if(g.setOp((function(t){return t.target.col_count+=e.target.col_count})),null!=t.value&&(g.setOp((function(t){t.value.col>=e.target.col&&(t.value.col+=e.target.col_count)})),!(0,se.default)(t.value.filteredRowsMap))){var m=e.target.col-t.target.col,p=t.value.col-t.target.col;if(m<=p){for(var y=[],C=0;C<e.target.col_count;++C)y.push([]);g.setOp((function(e){var t;(t=e.value.filteredRowsMap).splice.apply(t,[m,0].concat(y))}))}}return g.getOp()}var _=JX(t.target),R=EQ(_,r);return _===R?t:RQ(t,(function(e){e.target=$X(R),e.value&&(e.value.col=cQ(e.value.col,{index:r.col,count:r.colCount}))}));case"setChart":var w=new _Q(t);if(e.sheet_id===t.sheet_id){var k=KX(t.target),S=EQ(k,r);S!==k&&w.setOp((function(e){e.target=XX(S)}))}return w.setOp((function(t){yQ({type:1,index:e.target.col,count:e.target.col_count},e.sheet_id,t.value.graphSetting)})),w.getOp();case"addOutline":case"delOutline":case"updateOutline":return t;default:return kQ(t),!1}return t},delCol:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]&&arguments[2];if(!("target"in t))return bQ(t)?IQ(e,t):OQ(t)?NQ(e,t):B0(t)?D0(e,t,n):(0,we.i55)(t)?A0(e,t,n):"setFilterView"===t.action?K0(e,t):$0(t)?q0(e,t):t;if(ZQ(t))return xQ(e,t);if(Z0(t))return N0(e,t);var r=WX(e.target);switch(t.action){case"setRangeValues":return a0(e,t,n);case"setSpans":var a=JX(t.target),o=AQ(a,r);if(o===a)return t;if(null==o)return null;var i=ya(t);i.target=$X(o);for(var u=[],s=[],l=0;l<t.value.length;l++){var c=JX(t.value[l].target),h=AQ(c,r);h!==c?null!=h&&((h.rowCount>1||h.colCount>1)&&u.push(Object.assign({},t.value[l],{target:$X(h)})),n&&c.col>=r.col&&c.col<r.col+r.colCount&&s.push({action:"setCell",sheet_id:t.sheet_id,target:{row:h.row,col:h.col},value:{value:null,style:null,formula:null}})):u.push(t.value[l])}return i.value=u,n?u.length>0&&s.length>0?[i].concat(s):u.length>0?i:s.length>0?s:null:i;case"setDataRange":return U0(e,t);case"sort":var f=JX(t.target),d=AQ(f,r);if(null==d)return null;if(d!==f)return RQ(t,(function(e){e.target=$X(d)}));break;case"addCol":var v=lQ(t.target.col,{index:r.col,count:r.colCount});if(v!==t.target.col)return RQ(t,(function(e){return e.target.col=v}));break;case"delCol":case"hideCol":case"unhideCol":case"lockCol":case"unlockCol":case"setColProperty":case"setColumnWidth":var g=WX(t.target),m=AQ(g,r);if(null==m)return null;if(m!==g)return RQ(t,(function(e){e.target=zX(m)}));break;case"setFormula":case"setValue":case"setStyle":case"setCell":case"setFloatImage":case"addComments":var p=KX(t.target),y=AQ(p,r);if(null==y)return null;if(y!==p)return RQ(t,(function(e){e.target=XX(y)}));break;case"addRow":case"delRow":case"setRowHeight":case"setRowProperty":case"hideRow":case"unhideRow":case"lockRow":case"unlockRow":break;case"setFilter":var C=JX(t.target),_=AQ(C,r);if(null==_)return null;var R=new _Q(t);if(_!==C&&R.setOp((function(e){e.target=$X(_)})),null==t.value)return R.getOp();var w=AQ({type:we.xj7.COL,col:t.value.col,colCount:1},r);if(null==w)return null;if(w.col!==t.value.col&&R.setOp((function(e){e.value&&(e.value.col=w.col)})),t.value.filteredRowsMap&&r.col>=C.col){var k=r.col-C.col,S=r.colCount;R.setOp((function(e){e.value&&e.value.filteredRowsMap&&e.value.filteredRowsMap.splice(k,S)}))}return R.getOp();case"freezeSheet":var E=lQ(t.target.col,{index:r.col,count:r.colCount});if(E!==t.target.col)return RQ(t,(function(e){e.target.col=E}));break;case"setChart":var T=new _Q(t);if(e.sheet_id===t.sheet_id){var A=hQ(t.target.col,{index:r.col,count:r.colCount});A!==t.target.col&&T.setOp((function(e){e.target.col=A}))}return T.setOp((function(t){var n=t.value.graphSetting;yQ({type:3,index:r.col,count:r.colCount},e.sheet_id,n)})),T.getOp();case"addOutline":case"delOutline":case"updateOutline":return t;default:return kQ(t),!1}return t},hideRow:e1,unhideRow:e1,addSheet:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]&&arguments[2];return(0,E.Z)(i1,(function(e){return a1(e,t,n)}))(e)},setSheet:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]&&arguments[2];if(!(0,we.It9)(t))return t;switch(t.action){case"addSheet":if(e.sheet_id===t.sheet_id||e.value.sheet_name===t.sheet_name)return!1;break;case"copySheet":case"addBlock":case"restoreBlock":if(e.sheet_id===t.value.sheet_id||e.value.sheet_name===t.value.sheet_name)return!1;break;case"delSheet":case"delBlock":case"moveSheet":e.sheet_id===t.sheet_id&&(t.value.sheet_name=e.value.sheet_name);break;case"setSheet":if(e.sheet_id!==t.sheet_id&&e.value.sheet_name===t.value.sheet_name)return!1;if(e.sheet_id===t.sheet_id){var r=e.value.property_name||"name",a=t.value.property_name||"name";if(n&&r===a)return null;var o=new _Q(t);return"name"===r&&(o.setOp((function(t){t.value.origin_name=e.value.sheet_name})),"name"!==a&&o.setOp((function(t){t.value.sheet_name=e.value.sheet_name}))),o.getOp()}break;case"softDelSheet":case"restoreSheet":case"lockSheet":case"unlockSheet":break;default:kQ(t)}return t},copySheet:a1,delSheet:c1,moveSheet:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]&&arguments[2];if(!(0,we.It9)(t))return t;switch(t.action){case"addSheet":case"copySheet":case"addBlock":case"restoreBlock":var r=(0,hn.moveFollowAdd)(e.value.source,e.value.target,t.value.index,n);if(r!==t.value.index)return RQ(t,(function(e){return e.value.index=r}));break;case"delSheet":case"delBlock":var a=(0,hn.moveFollowDelete)(e.value.source,e.value.target,t.value.index,n);if(a!==t.value.index)return RQ(t,(function(e){return e.value.index=a}));break;case"setSheet":case"lockSheet":case"unlockSheet":case"restoreSheet":case"softDelSheet":break;case"moveSheet":var o=(0,hn.moveFollowMove)(e.value.source,e.value.target,t.value.source,t.value.target,n);if(null==o)return null;if(t.value.source!==o.source||t.value.target!==o.target)return RQ(t,(function(e){e.value.source=o.source,e.value.target=o.target}));break;default:kQ(t)}return t},coverSheet:function(e,t){switch(t.action){case"copySheet":case"moveSheet":return t}return e.sheet_id!==t.sheet_id&&t},softDelSheet:function(e,t){switch(t.action){case"restoreSheet":case"softDelSheet":if(e.sheet_id===t.sheet_id)return!1}return t},restoreSheet:function(e,t){switch(t.action){case"restoreSheet":case"softDelSheet":if(e.sheet_id===t.sheet_id)return!1}return t},setFilter:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]&&arguments[2];if(!("target"in t))return t;var r=JX(e.target);switch(t.action){case"setValue":case"setFormula":case"setStyle":case"setCell":case"addComments":case"setColumnWidth":case"setRowHeight":case"hideRow":case"unhideRow":case"hideCol":case"unhideCol":case"addCol":case"delCol":case"addRow":case"delRow":case"freezeSheet":case"lockCol":case"unlockCol":case"lockRow":case"unlockRow":case"setChart":case"setFloatImage":case"setColProperty":case"setDataRange":case"setRowProperty":case"setEmbeddedBlock":case"delEmbeddedBlock":case"addOutline":case"delOutline":case"updateOutline":break;case"setSpans":return t;case"sort":if((0,se.default)(e.value)||(0,se.default)(e.value.filteredRowsMap))break;if(nQ(r,JX(t.target)))return[t,X0(e,t)];break;case"setFilter":var a=JX(t.target);if(!nQ(r,a))return n?null:[{action:"delFilter",sheet_id:e.sheet_id},t];var o=new _Q(t);if(tQ(oQ(r),oQ(a))||o.setOp((function(t){var n=Math.min(e.target.col,t.target.col),r=Math.max(e.target.col+e.target.col_count-1,t.target.col+t.target.col_count-1);t.target.col=n,t.target.col_count=r-n+1,t.target.row_count=Math.max(e.target.row_count,t.target.row_count),Q0(t)})),!e.value||!t.value)return o.getOp();if(e.value.col===t.value.col)return n?null:o.getOp();var i=e.value.col-e.target.col,u=e.value.col-t.target.col;return i>=0&&u>=0&&u<t.target.col_count&&i<e.target.col_count&&e.value.filteredRowsMap&&t.value.filteredRowsMap&&e.value.filteredRowsMap[i]?o.setOp((function(t){t.value.filteredRowsMap[u]=Array.from(e.value.filteredRowsMap[i])})):o.getOp();case"setRangeValues":return a0(e,t,n);default:kQ(t)}return t},delFilter:function(e,t){switch(t.action){case"delFilter":case"setFilter":return null}return t},delChart:function(e,t){switch(t.action){case"setChart":case"delChart":if(e.sheet_id===t.sheet_id&&e.value.chartId===t.value.chartId)return null}return t},setFloatImage:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]&&arguments[2];return"setFloatImage"===t.action&&e.value.floatImageId===t.value.floatImageId&&e.value.floatImageSetting.imageToken===t.value.floatImageSetting.imageToken&&n?null:t},delFloatImage:function(e,t){switch(t.action){case"setFloatImage":case"delFloatImage":if(e.value.floatImageId===t.value.floatImageId)return null}return t},setFloatBlock:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]&&arguments[2];return"setFloatBlock"===t.action&&e.value.blockToken===t.value.blockToken&&e.value.blockType===t.value.blockType&&n?null:t},delFloatBlock:function(e,t){switch(t.action){case"setFloatBlock":case"delFloatBlock":if(e.value.blockToken===t.value.blockToken&&e.value.blockType===t.value.blockType)return null}return t},setEmbeddedBlock:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]&&arguments[2];return"setEmbeddedBlock"===t.action?e.value.blockToken===t.value.blockToken&&e.value.blockType===t.value.blockType?n?null:t:e.target.row===t.target.row&&e.target.col===t.target.col?null:t:t},delEmbeddedBlock:function(e,t){switch(t.action){case"setEmbeddedBlock":case"delEmbeddedBlock":if(e.value.blockToken===t.value.blockToken&&e.value.blockType===t.value.blockType)return null}return t},updateSparklineGroup:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]&&arguments[2],r=ya(t);return"updateSparklineGroup"===t.action&&(r=RQ(r,(function(r){for(var a=0,o=Object.keys(t.value);a<o.length;a++){var i=o[a];if(Object.prototype.hasOwnProperty.call(e.value,i)){if(e.value[i].config&&t.value[i].config&&n){var u=(0,I.Z)(Object.keys(e.value[i].config||{}),Object.keys(t.value[i].config||{}));r.value[i].config=(0,A.default)(r.value[i].config,u)}if(t.value[i].sparklines)for(var s=0,l=Object.keys(t.value[i].sparklines);s<l.length;s++){var c,h,f,d=l[s];if(null===(null===(c=e.value[i].sparklines)||void 0===c?void 0:c[d]))delete r.value[i].sparklines[d];else if(null!==(h=e.value[i].sparklines)&&void 0!==h&&h[d]&&null!==(f=t.value[i].sparklines)&&void 0!==f&&f[d]&&n){var v,g=(0,I.Z)(Object.keys((null===(v=e.value[i].sparklines)||void 0===v?void 0:v[d])||{}),Object.keys(t.value[i].sparklines[d]||{}));r.value[i].sparklines[d]=(0,A.default)(r.value[i].sparklines[d],g)}}}}}))),r},delSparklineGroup:function(e,t){var n=ya(t);switch(t.action){case"addSparklineGroup":case"updateSparklineGroup":var r=function(e){t.value[e]&&(n=RQ(n,(function(t){delete t.value[e]})))};for(var a in e.value)r(a);if(0===Object.keys(n.value).length)return null}return n},setDataRange:function(e,t){return t},delDataRange:function(e,t){return t},freezeSheet:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]&&arguments[2];switch(t.action){case"setChart":if(e.sheet_id===t.sheet_id){var r=Math.max(e.target.row,t.target.row),a=Math.max(e.target.col,t.target.col);if(r!==t.target.row||a!==t.target.col)return RQ(t,(function(e){e.target.row=r,e.target.col=a}))}break;case"setFloatBlock":if(e.sheet_id===t.sheet_id){var o=Math.max(e.target.row,t.value.row),i=Math.max(e.target.col,t.value.col);if(o!==t.value.row||i!==t.value.col)return RQ(t,(function(e){e.value.row=o,e.value.col=i}))}break;case"freezeSheet":if(!n)return t;if(e.sheet_id!==t.sheet_id)return t;var u=e.target,s=t.target,l=u.row>=0?u.row:s.row,c=u.col>=0?u.col:s.col;if(l!==s.row||c!==s.col)return RQ(t,(function(e){e.target.row=l,e.target.col=c}))}return t},addConditionalFormat:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]&&arguments[2];switch(t.action){case"addConditionalFormat":if(e.value.cfId===t.value.cfId)return!1;var r=(0,hn.addFollowAdd)(e.value.index,t.value.index,n);if(r!==t.value.index)return RQ(t,(function(e){return e.value.index=r}));break;case"delConditionalFormat":if(e.value.cfId===t.value.cfId)return!1;var a=(0,hn.addFollowDelete)(e.value.index,t.value.index,n);if(a!==t.value.index)return RQ(t,(function(e){return e.value.index=a}));break;case"moveConditionalFormat":var o=(0,hn.addFollowMove)(e.value.index,t.value.source,t.value.target,n);if(null!=o&&(t.value.source!==o.source||t.value.target!==o.target))return RQ(t,(function(e){e.value.source=o.source,e.value.target=o.target}))}return t},delConditionalFormat:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]&&arguments[2];switch(t.action){case"addConditionalFormat":if(e.value.cfId===t.value.cfId)return!1;var r=(0,hn.deleteFollowAdd)(e.value.index,t.value.index,n);if(r!==t.value.index)return RQ(t,(function(e){e.value.index=r}));break;case"delConditionalFormat":if(e.value.cfId===t.value.cfId)return null;var a=(0,hn.deleteFollowDelete)(e.value.index,t.value.index,n);if(null==a)return null;if(a!==t.value.index)return RQ(t,(function(e){e.value.index=a}));break;case"setConditionalFormat":if(e.value.cfId===t.value.cfId)return null;break;case"moveConditionalFormat":if(e.value.index===t.value.source)return null;var o=(0,hn.deleteFollowMove)(e.value.index,t.value.source,t.value.target,n);if(null==o)return null;if(t.value.source!==o.source||t.value.target!==o.target)return RQ(t,(function(e){e.value.source=o.source,e.value.target=o.target}))}return t},moveConditionalFormat:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]&&arguments[2];switch(t.action){case"addConditionalFormat":if(e.value.target===t.value.index)return!1;var r=(0,hn.moveFollowAdd)(e.value.target,e.value.target,t.value.index,n);if(r!==t.value.index)return RQ(t,(function(e){return e.value.index=r}));break;case"moveConditionalFormat":var a=(0,hn.moveFollowMove)(e.value.source,e.value.target,t.value.source,t.value.target,n);if(null==a)return null;if(t.value.source!==a.source||t.value.target!==a.target)return RQ(t,(function(e){e.value.source=a.source,e.value.target=a.target}));break;case"delConditionalFormat":var o=(0,hn.moveFollowDelete)(e.value.source,e.value.target,t.value.index,n);if(o!==t.value.index)return RQ(t,(function(e){return e.value.index=o}))}return t},moveRange:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]&&arguments[2];if(t.sheet_id!==e.value.source.sheetId&&t.sheet_id!==e.value.target.sheetId)return t;if(Z0(t))return N0(e,t);var r=Object.assign({},e.value.source,{type:e.value.type}),a=Object.assign({},e.value.target,{type:e.value.type}),o=e.value.type;switch(t.action){case"setCell":case"setValue":case"setStyle":case"setFormula":var i=YX(t.target,t.sheet_id);return P0(r,i)?RQ(t,(function(t){t.sheet_id=a.sheetId,t.target={row:e.value.target.row+t.target.row-e.value.source.row,col:e.value.target.col+t.target.col-e.value.source.col}})):P0(a,i)?null:t;case"setRangeValues":return a0(e,t,n);case"unhideCol":case"hideCol":case"setColumnWidth":case"setColProperty":if(o!==we.xj7.COL)return t;var u=jX(t.target,t.sheet_id),s=aQ(r,u);if(r.sheetId===u.sheetId&&s){var l=s.colEnd-s.col+1,c=[],h=RQ(t,(function(t){t.sheet_id=a.sheetId,t.target={col:s.col+e.value.target.col-e.value.source.col,col_count:l}}));if(t.target.col_count<=l)return h;if(c.push(h),e.value.source.col-t.target.col>0){var f=RQ(t,(function(e){e.sheet_id=a.sheetId,e.target={col:e.target.col,col_count:s.col-e.target.col}}));c.push(f)}if(t.target.col+t.target.col_count-(e.value.source.col+e.value.source.colCount)>0){var d=t.target.col_count-(s.colEnd-t.target.col)-1;if(d>0){var v=RQ(t,(function(e){e.sheet_id=a.sheetId,e.target={col:s.col+l,col_count:d}}));c.push(v)}}return c}return P0(a,u)?null:t;case"unhideRow":case"hideRow":case"setRowHeight":case"setRowProperty":if(o!==we.xj7.ROW)return t;var g=UX(t.target,t.sheet_id),m=aQ(r,g);if(r.sheetId===g.sheetId&&m){var p=m.rowEnd-m.row+1,y=[],C=RQ(t,(function(t){t.sheet_id=a.sheetId,t.target={row:m.row+e.value.target.row-e.value.source.row,row_count:p}}));if(t.target.row_count<=p)return C;if(y.push(C),e.value.source.row-t.target.row>0){var _=RQ(t,(function(e){e.sheet_id=a.sheetId,e.target={row:e.target.row,row_count:m.row-e.target.row}}));y.push(_)}if(t.target.row+t.target.row_count-(e.value.source.row+e.value.source.rowCount)>0){var R=t.target.row_count-(m.rowEnd-t.target.row)-1;if(R>0){var w=RQ(t,(function(e){e.sheet_id=a.sheetId,e.target={row:m.row+p,row_count:R}}));y.push(w)}}return y}return P0(a,g)?null:t;case"delRow":var k=UX(t.target,t.sheet_id);return!P0(r,k)&&!P0(a,k)&&t;case"delCol":var S=jX(t.target,t.sheet_id);return!P0(r,S)&&!P0(a,S)&&t;case"sort":case"setSpans":var E=qX(t.target,t.sheet_id);return!P0(r,E)&&!P0(a,E)&&t;case"moveRange":var T=Object.assign({},t.value.source,{type:t.value.type}),A=Object.assign({},t.value.target,{type:t.value.type});return!P0(r,T)&&!P0(r,A)&&!P0(a,T)&&!P0(a,A)&&t;case"delSheet":if(!n)return t;var I=t.sheet_id===e.value.source.sheetId,b=t.sheet_id===e.value.target.sheetId;return(I&&b||!I&&!b)&&t;case"setRange":case"updateRange":return A0(e,t,n)}return t},addBlock:s1,delBlock:c1,restoreBlock:s1,recover:function(e,t){return!1},setRange:T0,setRangeValues:i0,updateRange:T0,updateReference:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]&&arguments[2];switch(t.action){case"setCell":case"setRange":case"updateRange":var r=t.value.dataValidation;if(r&&"dataValidation"===e.value.type&&pm.isSameDataValidationJSON(e.value.oldRef,r))return RQ(t,(function(t){return t.value.dataValidation=ya(e.value.newRef)}));break;case"setRangeValues":if(t.value.dataValidation&&"dataValidation"===e.value.type)for(var a=function(n){if(pm.isSameDataValidationJSON(e.value.oldRef,t.value.dataValidation[n]))return{v:RQ(t,(function(t){t.value.dataValidation[n]=ya(e.value.newRef)}))}},o=0;o<t.value.dataValidation.length;o++){var i=a(o);if("object"===(0,_.Z)(i))return i.v}break;case"updateReference":if(n&&"dataValidation"===e.value.type){var u=e.value.oldRef,s=e.value.newRef,l=t.value.oldRef,c=t.value.newRef;if(pm.isSameDataValidationJSON(u,l)&&!pm.isSameDataValidationJSON(s,c))return!1;if(pm.isSameDataValidationJSON(u,c))return pm.isSameDataValidationJSON(s,l)?null:RQ(t,(function(t){return t.value.newRef=ya(e.value.newRef)}));if(pm.isSameDataValidationJSON(s,l))return!1;if(pm.isSameDataValidationJSON(s,c))return t}}return t},setFilterView:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]&&arguments[2];return"setFilterView"===t.action?v1(e,t,n):t},addView:function(e,t,n){if("addView"===t.action){if(t.value.view_id===e.value.view_id)return!1;if(t.value.name===e.value.name)return n?[(0,we.OU8)(e.sheet_id,{type:0,origin_name:e.value.name,view_id:e.value.view_id,name:m1(e.value.name,e.value.view_id)}),t]:RQ(t,(function(e){e.value.name=m1(e.value.name,e.value.view_id)}))}if("setView"===t.action){if(t.value.view_id===e.value.view_id)return!1;if(t.value.name===e.value.name)return n?[(0,we.OU8)(e.sheet_id,{type:0,origin_name:e.value.name,view_id:e.value.view_id,name:m1(e.value.name,e.value.view_id)}),t]:(0,we.OU8)(t.sheet_id,{type:0,origin_name:t.value.origin_name,view_id:t.value.view_id,name:m1(t.value.name,t.value.view_id)})}return t},delView:function(e,t){switch(t.action){case"setView":case"delView":case"setFilterView":if(e.sheet_id===t.sheet_id&&e.value.view_id===t.value.view_id)return null}return t},setView:function(e,t,n){return"setView"===t.action?function(e,t,n){return e.value.view_id===t.value.view_id?n?null:t:t.value.name===e.value.name?n?p1(ya(t)):[p1(ya(e)),t]:t}(e,t,n):"delView"===t.action?function(e,t,n){return e.value.view_id===t.value.view_id?RQ(t,(function(t){t.value.name=e.value.name})):t}(e,t):"addView"===t.action?function(e,t,n){if(t.value.name===e.value.name)return n?[p1(ya(e)),t]:p1(ya(t));return t}(e,t,n):t},setRangeProtection:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]&&arguments[2];switch(t.action){case"setRangeProtection":return e.value.id!==t.value.id?t:n?null:t;case"delRangeProtection":return e.value.id,t.value.id,t;case"lockRow":case"unlockRow":case"lockCol":case"unlockCol":return e.value.id!==t.value.perm_id||!n||"lockRow"!==t.action&&"lockCol"!==t.action?t:null}return t},delRangeProtection:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]&&arguments[2];switch(t.action){case"setRangeProtection":case"delRangeProtection":return e.value.id!==t.value.id?t:null;case"lockRow":case"unlockRow":case"lockCol":case"unlockCol":return e.value.id!==t.value.perm_id||!n||"unlockRow"!==t.action&&"unlockCol"!==t.action?t:null}return t},lockRow:z0,unlockRow:z0,lockCol:z0,unlockCol:z0},C1={setValue:{setValue:g0,updateRange:A0,setRange:A0},setStyle:{setStyle:g0,updateRange:A0,setRange:A0},setFormula:{setFormula:g0,updateRange:A0,setRange:A0},setCell:{setCell:function(e,t){if(v0(e.target,t.target)){if(!e.value.hasOwnProperty("style")&&e.value.hasOwnProperty(ag)&&!e.value.dataValidation&&!t.value.hasOwnProperty("style")&&t.value.dataValidation)return[t,e];var n=_0(e.value),r=_0(t.value);r=function(e){if(e.dataValidation){if(e.style)return Object.assign({},e,{style:Object.assign({},e.style,{dropdown:null})})}else if(e.style&&e.style.dropdown)return Object.assign({},e,{dataValidation:null});return e}(r);var a=!1,o=!0,i={},u=y0(n);for(var s in r)n.hasOwnProperty(s)||p0.includes(s)&&u?(a=!0,void 0!==n[s]&&(i[s]=n[s])):(o=!1,i[s]=r[s]);if(o)return null;var l=function(e,t){var n=!1;return t.dataValidation&&e.style&&e.style.dropdown?(delete t.dataValidation,n=!0):t.style&&t.style.dropdown&&e.dataValidation&&(t.style=Object.assign({},t.style,{dropdown:null}),n=!0),{needClone:n,newValue:t}}(n,i);if(!0===l.needClone&&(a=!0),i=l.newValue,a){var c={action:"setCell",sheet_id:t.sheet_id,target:{row:t.target.row,col:t.target.col},value:i};return u?(e.hasOwnProperty("type")&&(c.type=e.type),e.hasOwnProperty("extra")&&(c.extra=e.extra)):(t.hasOwnProperty("type")&&(c.type=t.type),t.hasOwnProperty("extra")&&(c.extra=t.extra)),c}}return t},updateRange:A0,setRange:A0,setRangeValues:a0},setRangeValues:{setRangeValues:i0},setRowHeight:{setRowHeight:function(e,t){return function(e,t){return e.row===t.row&&e.row_count===t.row_count}(e.target,t.target)?null:t}},setColumnWidth:{setColumnWidth:function(e,t){return function(e,t){return e.col===t.col&&e.col_count===t.col_count}(e.target,t.target)?null:t}},addComments:{addComments:function(e,t){if((0,pe.default)(e.target,t.target)){var n=e.value.comments,r=t.value.comments;return Object.assign({},t,{value:{comments:(0,M.Z)(r,n,"id")}})}return t}},setChart:{setChart:CQ("chartId")},setFloatImage:{setFloatImage:CQ("floatImageId")},setFloatBlock:{setFloatBlock:CQ(["blockToken","blockType"])},setConditionalFormat:{setConditionalFormat:CQ("cfId")}};function _1(e,t){var n=arguments.length>2&&void 0!==arguments[2]&&arguments[2];if(k1(e)||k1(t))return!1;if(!R1(e,t))return t;if("tidSplit"===e.action||"tidSplit"===t.action)return t;if(!n&&w1(e))return t;var r=null;return n&&C1[e.action]&&(r=C1[e.action][t.action]),null==r&&(r=y1[e.action]),null!=r?r(e,t,n):t}function R1(e,t){return!(!(0,we.FqT)(e)&&!(0,we.FqT)(t)&&e.sheet_id!==t.sheet_id)}function w1(e){return A1.has(e.action)}function k1(e){return I1.has(e.action)}var S1,E1,T1,A1=new Set(["setRowHeight","setColumnWidth","setValue","setStyle","setFormula","setCell","hideCol","unhideCol","localDeactiveView","localActiveView","tidSplit"]),I1=new Set(["coverSnapshot","recover"]);function b1(e,t){FQ(e),FQ(t)}function F1(e,t){var n=arguments.length>2&&void 0!==arguments[2]&&arguments[2];if(b1(e,t),0===e.length||0===t.length)return t;var r=e.length,a=t.length;try{var o=Date.now(),i=(0,hn.follow)(e,t,n,_1),u=Date.now();return we.Ps3.moirae.teaLog({key:"client_sheet_follow",isCover:n,time_cost:u-o,op1_length:r,op2_length:a,complexity:r*a}),i}catch(e){if(e instanceof hn.FollowException){var s=JSON.parse(e.info.op1),l=JSON.parse(e.info.op2);"action"in s&&"action"in l&&we.Ps3.moirae.teaLog({key:"client_sheet_follow_conflict",op1:s.action,op2:l.action,isCover:n})}throw e}}function M1(e,t){var n=arguments.length>2&&void 0!==arguments[2]&&arguments[2],r=F1(e,t,n),a=new QQ,o=new r0(r);return a.follows(e,o)}function V1(e,t,n,r){var a;if(e){var o=e.type,i=e.checkCellValid(t,n).getValue();bm(e)&&(o=e.options.supportMultipleValues?"list_multiple":"list_single"),Im(e)&&(o="text_length");var u=[],s=null===(a=e.options)||void 0===a?void 0:a.handledWayOnInvalidData;s?(1==(1&s)&&u.push("show_warning"),2==(2&s)&&u.push("reject_input")):u=["show_warning","reject_input"],we.Ps3.ccmEventTracking("ccm_sheet_content_page_click",Object.assign({},(0,we.dK5)(),{click:"edit_data_valid_value",target:"none",valid_type:o,alarm_type:u.join("-"),is_pass:i,action_type:r}))}}function N1(e,t){var n,r;if((0,Se.isBigNumber)(t))n=ar._parseFloat(t),r=(0,Se.createFormatter)(e.formatterService);else{var a=(0,Se.getPreferredFormatter)(e.formatterService,t);n=a.value,r=a.formatter,n instanceof ke.SheetDate&&(n=n.toNumber())}return{value:n,formatter:r}}function O1(e){var t=e.sheet();return"".concat(t?t.id():"","_").concat(e.rowFrom(),"_").concat(e.colFrom(),"_").concat(e.rowTo(),"_").concat(e.colTo())}function x1(e,t,n,r,a){var o=t.getSegmentArray(n,r);if(o){var i=Z1(o,t.getStyle(n,r),a),u=i.hasChanged,s=i.value;u&&(e.value=s)}}function Z1(e,t,n){var r=(0,m.Z)(e),a=sd(t,n,e),o=!1;return a.forEach((function(e,t){if(e){var n=r[t];r[t]=Object.assign({},n,{style:e}),o=!0}})),o?{hasChanged:o,value:xv.getSegmentArray4Changeset(r)}:{hasChanged:o,value:void 0}}function D1(e,t,n){if(e.getDropdown(t,n))return!0;var r=e.getDataValidation(t,n);return r&&bm(r)}function P1(e,t,n,r){var a=e.getText(t,n),o=e.getValue(t,n);if((0,S.Z)(o)){var i=e.getActualStyle(t,n);return r.list.some((function(t){var n=Sv._parseText2Value(e.formatterService,i,t,!0);return o+""==(n&&n.value)+""}))}return""===a||-1!==r.list.indexOf(a)}function L1(e){return function(e){var t=e.split("-");return{zh:"zh-CN",en:"en-US",ja:"ja-JP"}[(0,p.Z)(t,1)[0]]||"en-US"}(e)}function B1(e,t){return Object.prototype.hasOwnProperty.call(e,t)}!function(e){e.ADD="add",e.DEL="del"}(S1||(S1={})),function(e){e.ROW="row",e.COL="col"}(E1||(E1={})),function(e){e.zh="zh",e.en="en",e.ja="ja"}(T1||(T1={}));var U1=Array.isArray||function(e){return"[object Array]"===Object.prototype.toString.call(e)};function H1(e){switch((0,_.Z)(e)){case"string":return e;case"boolean":return e?"true":"false";case"number":return isFinite(e)?e:"";default:return""}}function W1(e,t){if(e.map)return e.map(t);for(var n=[],r=0;r<e.length;r++)n.push(t(e[r],r));return n}var j1=Object.keys||function(e){var t=[];for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&t.push(n);return t};var z1=["columns","data","frozenColCount","frozenRowCount","id","index","name","rowFilter","rows","spans","rowCount","columnCount","chartMap","floatImageMap","floatBlocks","embeddedBlocks","dataRanges","conditionalFormats","entities","mention","image","attachment","views","reminders","users","dataValidations","importRangeIDs","gridLineHidden","group","sparklineGroup","tabColor"],G1=z1.concat(["externalResource"]);function J1(e,t){for(var n=e.getRowCount(),r=e.getColumnCount(),a=0;a<t.length;a++){var o=t[a];if(("addRow"===o.action||"addCol"===o.action)&&n*r>(0,we.$$w)())return!0}return!1}function q1(e,t){Array.isArray(e)||(e=[e]),e.forEach((function(e,n){for(var r=e.rowFrom(),a=e.colFrom(),o=e.rowCount(),i=e.colCount(),u=r;u<r+o;u++)for(var s=a;s<a+i;s++)t&&t(u,s,n)}))}function $1(e,t,n){Array.isArray(e)||(e=[e]),e.forEach((function(e,r){for(var a=e.rowFrom(),o=e.colFrom(),i=e.rowCount(),u=e.colCount(),s=a;s<a+i;s++)if(!n(s))for(var l=o;l<o+u;l++)t(s,l,r)}))}function Y1(e,t){var n=t.rowFrom(),r=t.colFrom(),a=e.getSpan(n,r);return!!a&&a.equal(t)}function K1(e,t,n){var r=e.getSpan(t,n);if(r){var a=r.rowFrom(),o=r.colFrom();return a!==t||o!==n}return!1}function X1(e,t,n){var r;e.getSheetFromId(t)&&(null===(r=e.formulaCacheManager)||void 0===r||r.loadFormulaCacheMeta(t,n))}function Q1(e,t,n){var r,a=arguments.length>3&&void 0!==arguments[3]&&arguments[3];if(e.getSheetFromId(t)){a&&(e.calcEngine.statistics.set(Jb.ReceiveCompleteServerSideCacheTime,Date.now()),e.calcEngine.statistics.tryReportCalculationCacheTimeDifference());for(var o=[],i=0;i<n.length;++i){var u,s=n[i],l=null===(u=e.formulaCacheManager)||void 0===u?void 0:u.loadFormulaCacheBlock(t,s);null!=l&&o.push(l)}null===(r=e.formulaCacheManager)||void 0===r||r.applyFormulaCache(t,o)}}function e2(e,t,n){var r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{},a=e.getSheetFromId(t);a&&CS(n,a._getModel(),a,r)}function t2(e){return(0,B.Z)(e,z1)}function n2(e){return(0,B.Z)(e,G1)}function r2(e){return o2(e,t2)}function a2(e){return o2(e,n2)}function o2(e,t){var n=e.sheets,r={};for(var a in n){var o=n[a];r[a]=t(o)}return{sheetCount:Object.keys(r).length,sheets:r,lang:e.lang,locale:e.locale,schemaVersion:e.schemaVersion,hasArrayFormula:e.hasArrayFormula,defaults:e.defaults}}function i2(e){var t=e.data.dataTable;if(!t)return e;for(var n=Object.keys(t),r=0;r<n.length;r++)for(var a=t[n[r]],o=Object.keys(a||{}),i=0;i<o.length;i++){var u=a[o[i]];u&&u.comments&&delete u.comments}return e}function u2(e){return Object.keys(e.sheets).forEach((function(t){return i2(e.sheets[t])})),e}function s2(e){var t=window.location,n=t.origin,r=t.search,a=t.hash,o=function(e,t,n,r){t=t||"&",n=n||"=";var a={};if("string"!=typeof e||0===e.length)return a;var o=/\+/g;e=e.split(t);var i=1e3;r&&"number"==typeof r.maxKeys&&(i=r.maxKeys);var u=e.length;i>0&&u>i&&(u=i);for(var s=0;s<u;++s){var l,c,h,f,d=e[s].replace(o,"%20"),v=d.indexOf(n);v>=0?(l=d.substr(0,v),c=d.substr(v+1)):(l=d,c=""),h=decodeURIComponent(l),f=decodeURIComponent(c),B1(a,h)?U1(a[h])?a[h].push(f):a[h]=[a[h],f]:a[h]=f}return a}(r.slice(1)),i={from:"copy"};return o.v&&(i.v=o.v),o.sheet?i.sheet=o.sheet:a&&(i.sheet=a.slice(1)),"".concat(n).concat(we.Ps3.prependSpace("/sheet/".concat(e,"?").concat(function(e,t,n,r){return t=t||"&",n=n||"=",null===e&&(e=void 0),"object"==(0,_.Z)(e)?W1(j1(e),(function(r){var a=encodeURIComponent(H1(r))+n;return U1(e[r])?W1(e[r],(function(e){return a+encodeURIComponent(H1(e))})).join(t):a+encodeURIComponent(H1(e[r]))})).join(t):r?encodeURIComponent(H1(r))+n+encodeURIComponent(H1(e)):""}(i))))}function l2(e,t,n,r){if(!r||"string"!=typeof r||r.length<=1||!["=","+"].includes(r[0]))return{isFormula:!1,text:r,formulaVar:null,compileContext:{}};var a="="===r[0],o=a?r.substr(1):r;o=o.replace(/[\u000d\u000a]/g,"");var i=n.parent,u=i.getCalcEngine(),s=new Oi(e,t,1,1,n),l={ref:s,spread:i},c=u.compiler;c.startCollectPerformance();var h=u.compile(o,l);if(null!=c){var f=c.getPerformanceData();null!=f&&we.Ps3.moirae.teaLog({key:"client_sheet_formula_compile",time_cost:f.timeCost,formula_count:f.formulaCount,lexical_analysis:f.LexicalAnalysis,syntax_analysis:f.SyntaxAnalysis,semantic_analysis:f.SemanticAnalysis}),c.stopCollectPerformance()}var d=u.compileTokens(o).tokens;if(null!=h.errors&&(h=function(e,t,n,r,a){for(var o=[],i=0;i<a.length;i++){var u=a[i];if(u.tokenType===$s.CloseParen&&o.length>0){var s=o[o.length-1];s.tokenType!==$s.OpenParen&&s.tokenType!==$s.FunctionName||o.pop()}else u.tokenType!==$s.OpenParen&&u.tokenType!==$s.FunctionName||o.push(u)}return o.length>0?(e+=")".repeat(o.length),t.compile(e,n)):r}(o,u,l,h,d),null!=h.errors))return{isFormula:!1,text:"'"+r,formulaVar:null,compileContext:l};var v=h.formulaVar;if(null==v)return{isFormula:!1,text:"'"+r,formulaVar:null,compileContext:l};var g,m=_n(d);try{for(m.s();!(g=m.n()).done;){var p=g.value;if(p.tokenType===$s.FunctionName&&"string"==typeof p.image){var y=p.image.slice(0,p.image.length-1).toUpperCase();we.Ps3.collectSuiteEvent("click_insert_formula",{op_item:y,object_id:n&&n.id(),source:"body"})}}}catch(e){m.e(e)}finally{m.f()}try{we.Ps3.collectSuiteEvent("client_sheet_confuse_formula",{formula:d2(d)})}catch(e){console.error("[SHEET LOG]: confuse formula error",e)}if(l.error){var C=l.error;we.Ps3.collectSuiteEvent("sheet_error_mark",{error_type:"formula_error",op_item:C,object_id:n&&n.id()}),C.getValue()===ut.ErrorConstant.NAME&&we.Ps3.collectSuiteEvent("sheet_opration_for_AI",{action:"collect_#name_error",error_keyword:o,object_id:n&&n.id()})}return!a&&v.isFormula()&&v.getRoot().isNumber()?{isFormula:!1,text:r,formulaVar:null,compileContext:l}:{isFormula:!0,text:"="+u.decompile(v,{ref:s}),formulaVar:v,compileContext:l}}function c2(e,t){var n=e.getActiveCellIndex(),r=l2(n.row,n.column,e,t),a=r.isFormula,o=r.compileContext;return a&&!(null!=o&&o.error)}function h2(e,t){return"col"===e?(0,we.hdC)(t):(t+1).toString()}function f2(e,t,n){return e?bv(e,t,n)?fn("comment.quote.picture"):e.getText(t,n,void 0,void 0,void 0,!0)||"":""}function d2(e){for(var t={count:0,map:{}},n={strMap:{}},r="",a=0;a<e.length;a++){var o=e[a];switch(o.tokenType){case $s.StringConstant:r+="string";break;case $s.NumericalConstant:r+="number";break;case $s.LogicalTrue:case $s.LogicalFalse:r+="boolean";break;case $s.ErrorConstant:case $s.RefConstant:var i=o.image.toUpperCase().trim(),u=t.map[i];u||(u="error"+t.count++,t.map[o.image]=u),r+=u;break;case $s.FunctionName:r+=o.image.toUpperCase().trim();break;case $s.LocalReferenceA1:case $s.ExternalReferenceA1:case $s.LocalReferenceR1C1:case $s.ExternalReferenceR1C1:var s=v2(o.image.toUpperCase().trim(),n,o.tokenType===$s.ExternalReferenceA1||o.tokenType===$s.ExternalReferenceR1C1);if(!s)return"";r+=s;break;default:r+=o.image.trim()}}return r}function v2(e,t,n){var r=t.strMap[e];if(r)return r;if(r="",n){var a=e.split(/!|\uFF01/);if(2!==a.length)return r;var o=a[0];if(e=a[1],o){var i=t.sheet;i||(i={count:0,map:{}},t.sheet=i);var u=i.map[o];u||(u="表"+i.count++,i.map[o]=u),r+=u+"!"}}var s=/(\$)?([A-Za-z]+)?(\$)?(\d+)?/;return r+=e.split(/:|\uFF1A/).map((function(e){return e.replace(s,(function(e,n,r,a,o){var i="";if(void 0!==n&&(i+="$"),void 0!==r){var u=t.col;u||(u={count:0,map:{}},t.col=u);var s=u.map[r];s||(s="C"+u.count++,u.map[r]=s),i+=s}if(void 0!==a&&(i+="$"),void 0!==o){var l=t.row;l||(l={count:0,map:{}},t.row=l);var c=l.map[o];c||(c="R"+l.count++,l.map[o]=c),i+=c}return i}))})).join(":"),t.strMap[e]=r,r}function g2(e,t,n,r,a,o){var i=o||e.getActiveSheet();if(!i)return!1;for(var u="row"===r?i._getRowInfos():i._getColInfos(),s=0;s<n;s++){var l=u.getFId(t+s);if(a){if(l===a)return!0}else if(void 0!==l)return!0}return!1}function m2(e,t,n,r){var a=e.rowFrom(),o=e.rowCount(),i=e.colFrom(),u=e.colCount();return g2(t,a,o,"row",n,r)&&g2(t,i,u,"col",n,r)}function p2(e,t){var n=arguments.length>2&&void 0!==arguments[2]&&arguments[2],r=e.importRangeManager;if(!r)return!1;for(var a=n?t._oldChangesets:t._changesets,o=0,i=function(t){var n=a[t];if("setCell"===n.action&&n.type&&1&n.type||"setRangeValues"===n.action&&Array.isArray(n.value.formulaData)){if(r.isImportRangeNumExceedLimit(o))return{v:(we.Ps3.Toast.error({key:"crossTableError_num",closable:!0,content:fn("CreationDoc_Sheets_ImportrangeToLimit",we.Ps3.getSheetImportRangeCountLimit())}),!1)};"setCell"===n.action?i(n.value.formulaData):"setRangeValues"===n.action&&n.value.formulaData.forEach((function(e){return i(e)}))}function i(t){if(t){var n=t.externalDataReference;n&&(y2(n,e),o++)}}},u=0;u<a.length;++u){var s=i(u);if("object"===(0,_.Z)(s))return s.v}return!0}function y2(e,t,n,r){var a=e.spreadToken,o=Yl(e.ref);if(o){var i=t.importRangeManager;if(i){var u=i.generateImportRangeId(o,a);void 0!==n&&void 0!==r&&i.setImportRangeAutoExpand("".concat(u,"_").concat(n,"_").concat(r)),e.importRangeId=u}}}function C2(e){var t=e.getActiveSheet(),n=t.getSelections(),r=!1,a=!1;if(1===n.length){var o=n[0];t.getSpans(o).length?r=!0:(o.rowCount()>1||o.colCount()>1)&&(a=!0)}return{mergable:a,splitable:r}}function _2(e){var t=e.getActiveSheet(),n=t.getSelections()[0];if(!n)return!1;for(var r=n.rowFrom(),a=n.colFrom(),o=n.rowCount(),i=n.colCount(),u=0,s=r;s<r+o;s++)for(var l=a;l<a+i;l++)(null!==t.getValue(s,l)||t.getSegmentArray(s,l))&&u++;return u<=1}function R2(e,t){var n=C2(e),r=n.mergable,a=n.splitable,o=e.getActiveSheet(),i=o.getSelections();if(t){if(r)return o.mergeCells(i)}else if(a)return o.splitCells(i);return!1}function w2(e){var t=!1;return e&&(t=!e.getParent().permissionManager.hasPermission(e.id())),t}function k2(e){if(e){var t=e.filterModel&&e.filterModel.filterRange;return 0!==e.getPermissionDeniedRangeList(t).length}return!1}function S2(e,t){var n,r,a;if(null===(n=e.getService(Ft.f3))||void 0===n||!n.suiteEditable)return!1;var o=t.sheetId,i=t.row,u=t.col,s=e.getSheetFromId(o);return!!s&&((null===(r=e.permissionManager)||void 0===r?void 0:r.hasPermission(o))&&(null===(a=s.protectionModel)||void 0===a?void 0:a.getRangePermissions([new Zi(i,u,s)]).hasPermission))}var E2,T2,A2=function(e){return e.getSelections()[0]},I2=function(e){var t=A2(e);return t?t.rowCount():0},b2=function(e){var t=A2(e);return t?t.colCount():0},F2=function(e,t){return function(e){var t=e.getColumnCount();return I2(e)>=1&&b2(e)===t}(e)?"row":function(e){var t=e.getRowCount();return b2(e)>=1&&I2(e)===t}(e)?"col":function(e){var t;return 1===(null===(t=A2(e))||void 0===t?void 0:t.size())}(e)?"cell":t};function M2(e){var t=e.expected,n=e.contents;return 0===t.length&&null===n}function V2(e,t,n){if(1===n){var r=[];t.forEach((function(e){var t=e.target,n=t+e.count-1;r.push([t,n])}));var a=e.getColumnCount(),o=e.getVisibleColCount(0,a),i=N2(r),u=0;return i.forEach((function(t){var n=t[0],r=t[1];u+=e.getVisibleColCount(n,r)})),o===u}var s=[];t.forEach((function(e){var t=e.target,n=t+e.count-1;s.push([t,n])}));var l=e.getRowCount(),c=e.getVisibleRowCount(0,l),h=N2(s),f=0;return h.forEach((function(t){var n=t[0],r=t[1];f+=e.getVisibleRowCount(n,r)})),c===f}function N2(e){var t=[];e.sort((function(e,t){return e[0]-t[0]}));for(var n=e[0],r=1;r<e.length;r++){var a=e[r];n[1]>=a[0]?n[1]=Math.max(a[1],n[1]):(t.push(n),n=a)}return t.push(n),t}function O2(e,t,n){return"公式:".concat(e.getFormula(t,n),"\n结果:").concat(e.getText(t,n))}function x2(e,t,n){return e.getValue(t,n)?"true":"false"}!function(e){e[e.Row=0]="Row",e[e.Col=1]="Col"}(E2||(E2={})),function(e){e[e["星期日"]=0]="星期日",e[e["星期一"]=1]="星期一",e[e["星期二"]=2]="星期二",e[e["星期三"]=3]="星期三",e[e["星期四"]=4]="星期四",e[e["星期五"]=5]="星期五",e[e["星期六"]=6]="星期六"}(T2||(T2={}));var Z2=function(e){for(var t=/\`\`\`([^```]*)?```/g,n=[],r=t.exec(e);r;){var a=r[1].replace(/\n/g,"");n.push(a),r=t.exec(e)}var o=/[^/s]/;return(0,m.Z)(new Set(n.filter((function(e){var t=o.exec(e);return!!t&&"="===t[0]}))))},D2=function(e){var t=e.row,n=e.col,r=e.colCount,a=e.rowCount;return[{area:a*r,positionList:{start:[t,n],end:[t+a,n+r]}}]};function P2(e,t,n){if(U2(n,e,t)){var r,a=null===(r=n._spanModel.find(e,t))||void 0===r?void 0:r.toJSON();a&&(e=a.row,t=a.col)}return n.dataValidationService.hasCheckbox(e,t)?x2(n,e,t):n.getValue(e,t)}var L2,B2=function(e,t){for(var n={},r={},a=[],o=function(e,t,n){var r=e,a=e+Math.min(t,40),o=Math.max((40-t)/2,0);r-=Math.ceil(o),a+=Math.floor(o);var i=0-r;i>0&&(a+=i);var u=a-n;return u>0&&(r-=u),[Math.max(0,r),Math.min(a,n)]}(t.col,t.colCount,e.getColumnCount()),i=(0,p.Z)(o,2),u=i[0],s=i[1],l=u;l<s;l++){var c=P2(0,l,e);if(c){var h=(0,we.hdC)(l);if(void 0===r[h]){r[h]=c,n[0]||(n[0]={}),n[0][l]=c;var f={name:c,index:l,column:h};a.push(f)}}}return{colMap:r,positionMap:n,colList:a}},U2=function(e,t,n){return e&&e._spanModel.find(t,n)},H2=function(e){return e},W2=function(e){var t=e.sheet();if(!t)return[];var n=e.toJSON();if(1===n.rowCount&&1===n.colCount){var r=n.row,a=n.col;if(t.getVar(r,a).isFormula())return[[O2(t,r,a)]]}for(var o=[],i=0;i<n.rowCount;i++){for(var u=[],s=0;s<n.colCount;s++){var l=i+n.row,c=s+n.col,h=t.dataValidationService.hasCheckbox(l,c)?x2(t,l,c):t.getText(l,c);u.push(h)}o.push(u)}return o},j2=function(e){var t;!function(e){e.ArrayStart="ArrayStart",e.ArrayEnd="ArrayEnd",e.ObjectStart="ObjectStart",e.ObjectEnd="ObjectEnd",e.SingleQuotation="SingleQuotation",e.DoubleQuotation="DoubleQuotation",e.Text="text"}(t||(t={}));for(var n=/^\[$/,r=/^]$/,a=/^\{$/,o=/^\}$/,i=/^'$/,u=/^"$/,s=function(e){return n.test(e)?t.ArrayStart:r.test(e)?t.ArrayEnd:a.test(e)?t.ObjectStart:o.test(e)?t.ObjectEnd:i.test(e)?t.SingleQuotation:u.test(e)?t.DoubleQuotation:t.Text},l=[],c=[],h=function(e){var n=c[c.length-1];n.type===t.Text?n.text+=e:c.push({type:t.Text,text:e})},f=function(e){return!!e.find((function(e){return[t.SingleQuotation,t.DoubleQuotation].includes(e.type)}))},d=function(e,t){var n=new Array(t.length).fill(0);return e.forEach((function(e){t.find((function(t,r){var a=t===e.type;return a&&n[r]++,a}))})),n},v=0;v<=e.length;v++){var g=e[v];switch(s(g)){case t.ArrayStart:c.push({type:t.ArrayStart,text:g});break;case t.ArrayEnd:if(!c.length)continue;if(f(c)){h(g);break}c.push({type:t.ArrayEnd,text:g});var m=d(c,[t.ObjectStart,t.ObjectEnd,t.ArrayStart,t.ArrayEnd]),y=(0,p.Z)(m,4),C=y[0],_=y[1];C+y[2]===_+y[3]&&l.push(c.splice(0));break;case t.ObjectStart:c.push({type:t.ObjectStart,text:g});break;case t.ObjectEnd:if(!c.length)continue;if(f(c)){h(g);break}c.push({type:t.ObjectEnd,text:g});var R=d(c,[t.ObjectStart,t.ObjectEnd,t.ArrayStart,t.ArrayEnd]),w=(0,p.Z)(R,4),k=w[0],S=w[1];k+w[2]===S+w[3]&&l.push(c.splice(0));break;case t.SingleQuotation:if(!c.length)continue;var E=c.findIndex((function(e){return e.type===t.SingleQuotation}));if(-1!==E){var T=c.splice(E).map((function(e){return e.text})).join("");c.push({type:t.Text,text:T+"'"})}else c.push({type:t.SingleQuotation,text:g});break;case t.DoubleQuotation:if(!c.length)continue;var A=c.findIndex((function(e){return e.type===t.DoubleQuotation}));if(-1!==A){var I=c.splice(A).map((function(e){return e.text})).join("");c.push({type:t.Text,text:I+'"'})}else c.push({type:t.DoubleQuotation,text:g});break;case t.Text:if(!c.length)continue;h(g)}}return l.map((function(e){return e.map((function(e){return e.text})).join("")})).map((function(e){try{return JSON.parse(e)}catch(e){return null}})).filter((function(e){return!!e}))},z2=function(e){return j2(e).map((function(e){return Array.isArray(e)?e.filter((function(e){return!!e.action})):e.action?[e]:null})).reduce((function(e,t){return e&&e.push.apply(e,(0,m.Z)(t||[])),e}),[])},G2=function(e){try{return j2(e)[0]||{}}catch(e){return{}}};!function(e){e.AI_WRITE="AI_WRITE",e.AI_DEEPSEEK_WRITE="AI_DEEPSEEK_WRITE",e.AI_ASK="AI_ASK",e.AI_CLASSIFY="AI_CLASSIFY",e.AI_EXTRACT="AI_EXTRACT",e.AI_IMPORTDATA="AI_IMPORTDATA",e.AI_INFER="AI_INFER",e.AI_POLISH="AI_POLISH",e.AI_SENTIMENT="AI_SENTIMENT",e.AI_SUMMARY="AI_SUMMARY",e.AI_TRANSLATE="AI_TRANSLATE"}(L2||(L2={}));var J2=new Set(["AI_WRITE","AI_DEEPSEEK_WRITE","AI_ASK","AI_CLASSIFY","AI_EXTRACT","AI_IMPORTDATA","AI_INFER","AI_POLISH","AI_SENTIMENT","AI_SUMMARY","AI_TRANSLATE"]),q2=function(e){return J2.has(e)},$2=function(e){return e.startsWith("F:")},Y2=function(e){return function(e){var t,n=[],r=_n(e);try{for(r.s();!(t=r.n()).done;){var a=t.value;if($2(a)){var o=a.split(":")[1];o&&n.push(o)}}}catch(e){r.e(e)}finally{r.f()}return n}(e).some((function(e){return q2(e)}))},K2=[we.O6N.SHEET_AI_NO_PERMISSION_ADMIN,we.O6N.SHEET_AI_NO_PERMISSION_FG,we.O6N.REQUEST_FAIL],X2=function(e,t){return Y2(e)&&K2.includes(t)},Q2=function(e){if(e){for(var t=e.parent,n=[],r=e.iterContentWithPos(0,0,e.getRowCount(),e.getColumnCount()),a=r.next();null!==a;a=r.next()){var o=a,i=(0,p.Z)(o,2),u=i[0],s=i[1],l=u.formulaVar;if(l&&l.isFormula()){var c=l.getRawVar();if(c.isError()){var h=e.getFormulaData(s.row,s.col);(null==h?void 0:h.tree)&&X2(h.tree,c.errorCode)&&(yx(l),n.push(l.getRef()))}}}n.length>0&&t.calcEngine.markDirty(n)}},e3=function(){function e(){(0,y.Z)(this,e),this.mutationType=we.B2l.MutationType.MutationType_AddComment}return(0,C.Z)(e,[{key:"execute",value:function(e,t,n,r){var a,o=t.addComment;if(o){var i=n.sheetId,u=o.value.cell,s=e.getSheetFromId(i);if(s){var l=u.startRow,c=u.startCol,h=s.getComments(l,c)||[],f=(0,V.Z)(h,[{id:o.value.id,isResolved:null===(a=o.value.isResolved)||void 0===a||a}]).reverse(),d=(0,M.Z)(f,"id").reverse();s._setComments(l,c,d)}}}}]),e}(),t3=function(){function e(){(0,y.Z)(this,e),this.mutationType=we.B2l.MutationType.MutationType_AddConditionalFormatting}return(0,C.Z)(e,[{key:"execute",value:function(e,t,n,r){var a,o=t.addConditionalFormatting;if(o){var i=n.sheetId;null===(a=e.getSheetFromId(i))||void 0===a||a._addConditionalFormatV2(o)}}}]),e}(),n3=function(){function e(){(0,y.Z)(this,e),this.mutationType=we.B2l.MutationType.MutationType_AddCustomView}return(0,C.Z)(e,[{key:"execute",value:function(e,t,n,r){var a=t.addCustomView;if(a){var o=n.sheetId,i=e.getSheetFromId(o);if(i){var u=a.value;i.viewsModel.addView(u.id,u.name,!0).getFilterModel().deserialize(u.autoFilter,n.resourceRefs)}}}}]),e}(),r3=function(){function e(){(0,y.Z)(this,e),this.mutationType=we.B2l.MutationType.MutationType_AddEmbeddedBlock}return(0,C.Z)(e,[{key:"execute",value:function(e,t,n,r){var a=t.addEmbeddedBlock;if(a){var o=n.sheetId,i=e.getSheetFromId(o);if(i){var u=a.value;i._setEmbeddedBlock(u.id,{blockToken:u.id,blockType:a3(u.blockType),position:{row:u.cell.startRow,col:u.cell.startCol},blockSetting:{}},!0)}}}}]),e}();function a3(e){return e===we.B2l.EmbeddedBlockType.EmbeddedBlockType_PIVOT_TABLE?xt.kH.PIVOT_TABLE:xt.kH.FALLBACK}var o3=function(){function e(){(0,y.Z)(this,e),this.mutationType=we.B2l.MutationType.MutationType_AddFloatBlock}return(0,C.Z)(e,[{key:"execute",value:function(e,t,n,r){var a=t.addFloatBlock;if(a){var o=n.sheetId,i=e.getSheetFromId(o);if(i){var u=a.value,s=u.anchor;i._setFloatBlock(u.id,{sheetId:o,blockToken:u.id,blockType:i3(u.type),blockSetting:{row:s.cell.startRow,col:s.cell.startCol,x:s.cellOff.x,y:s.cellOff.y,width:s.size.w,height:s.size.h,zIndex:s.zIndex}},!0)}}}}]),e}();function i3(e){return e===we.B2l.FloatBlockType.FloatBlockType_CHART?xt.kH.CHART:xt.kH.FALLBACK}var u3,s3=function(){function e(){(0,y.Z)(this,e),this.mutationType=we.B2l.MutationType.MutationType_AddFloatImage}return(0,C.Z)(e,[{key:"execute",value:function(e,t,n,r){var a=t.addFloatImage;if(a){var o=n.sheetId,i=e.getSheetFromId(o);if(i){var u=a.value,s=u.anchor;i._setFloatImage(u.id,{sheetId:o,floatImageId:u.id,floatImageSetting:{row:s.cell.startRow,col:s.cell.startCol,x:s.cellOff.x,y:s.cellOff.y,width:s.size.w,height:s.size.h,imageToken:u.token,zIndex:s.zIndex}},!0)}}}}]),e}(),l3=function(){function e(){(0,y.Z)(this,e),this.mutationType=we.B2l.MutationType.MutationType_AddRangeProtection}return(0,C.Z)(e,[{key:"execute",value:function(e,t,n,r){var a,o=t.addRangeProtection;if(o){var i=n.sheetId,u=e.getSheetFromId(i);if(u){var s=o.value,l=[];null!==(a=s.ranges)&&void 0!==a&&a.forEach((function(e){var t=li(Zc(e,u));l.push(t)})),u.protectionModel.setProtection(s.id,{creatorId:s.creatorId,description:s.description,ranges:l})}}}}]),e}(),c3=function(){function e(){(0,y.Z)(this,e),this.mutationType=we.B2l.MutationType.MutationType_SetSheetProtection}return(0,C.Z)(e,[{key:"execute",value:function(e,t,n,r){var a=t.setSheetProtection;if(a){var o=a.sheetId,i=e.getSheetFromId(o);if(i){var u=a.value;e.permissionManager.setPerm(u.id,{permId:u.id,lockInfo:u.description,sheetId:o,creatorId:u.creatorId,sheetName:i.name()})}}}}]),e}(),h3=function(){function e(){(0,y.Z)(this,e),this.mutationType=we.B2l.MutationType.MutationType_AddReminder}return(0,C.Z)(e,[{key:"execute",value:function(e,t,n,r){var a=t.addReminder;if(a){var o=n.sheetId,i=e.getSheetFromId(o);if(i){var u=new by(a.value.id);u.deserialize(a.value),i._dataModel.setReminderById(a.value.id,u)}}}}]),e}(),f3=function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[];if(t.length<1)return[];var n=[];return t.forEach((function(t){if(t){var r=t.split("_")[0];if(r){var a=e.getSheetFromId(r);if(a){var o=a.rangeModel.getRangesFromId([t])[0];!o||void 0!==o.type&&o.type!==we.xj7.NORMAL||n.push(o)}}}})),n},d3=function(){function e(){(0,y.Z)(this,e),this.mutationType=we.B2l.MutationType.MutationType_AddWorkbookRange}return(0,C.Z)(e,[{key:"execute",value:function(e,t,n,r){var a=t.addWorkbookRange;if(a){var o=n.sheetId,i=e.getSheetFromId(o),u=a.value,s=u.range,l=u.id,c=u.type;if(i&&s&&l){var h=function(e,t,n,r,a){var o;return Object.assign({},li(Zc(e,t)),{sheetId:null!==(o=e.sheetId)&&void 0!==o?o:n,rangeId:r,usageType:a})}(s,i,o,l,c);h&&(n.isApplySnapshot?(n.rangeMap||(n.rangeMap={}),n.rangeMap[l]=h):i.rangeModel.setRange(h))}}}},{key:"batchDone",value:function(e,t){if(t.isApplySnapshot){var n=t.sheetId,r=e.getSheetFromId(n);r&&(r.rangeModel=mb.fromJSON(r,t.rangeMap))}}}]),e}(),v3=function(){function e(){(0,y.Z)(this,e),this.mutationType=we.B2l.MutationType.MutationType_InsertSheet}return(0,C.Z)(e,[{key:"execute",value:function(e,t,n,r){var a,o,i,u,s,l,c,h,f,d,v=t.insertSheet;if(v){var g,m=v.worksheetProperties,p=null!==(a=null==m?void 0:m.id)&&void 0!==a?a:"",y=null==m?void 0:m.externalBlock,C=(null==m?void 0:m.sheetState)===we.B2l.SheetState.SheetState_HIDDEN;if((g=y&&y.blockId&&y.blockType?e.creatBlockWorksheet(p,null!==(o=m.name)&&void 0!==o?o:"",WF[y.blockType],y.blockId,y.blockToken,!0,C):e.createWorksheet(p,null!==(i=null==m?void 0:m.name)&&void 0!==i?i:"",C)).setRowCount(null!==(u=null==m?void 0:m.rowCount)&&void 0!==u?u:0),g._getRowInfos().deserialize([]),g.setColumnCount(null!==(s=null==m?void 0:m.colCount)&&void 0!==s?s:0),g._getColInfos().deserialize([]),null!=m&&m.sheetView){var _=m.sheetView,R=_.frozenRowCount,w=_.frozenColCount,k=_.hideGridLines;Number.isInteger(R)&&R>=0&&g.frozenRowCount(R),Number.isInteger(w)&&w>=0&&g.frozenColumnCount(w),"boolean"==typeof k&&g.inject(AE).setGridLine(k)}if(null!=m&&m.softDelTime&&g.setDelTime(m.softDelTime),g.tabColor.setTabColor(null==m||null===(l=m.sheetPr)||void 0===l||null===(c=l.tabColor)||void 0===c?void 0:c.rgb),g.tabType.setTabType(null==m||null===(h=m.sheetPr)||void 0===h?void 0:h.tabType),n.isApplySnapshot?e.initAddSheet(null!==(f=null==m?void 0:m.index)&&void 0!==f?f:0,g):e._addSheet(null!==(d=null==m?void 0:m.index)&&void 0!==d?d:0,g),null!=m&&m.importRanges){var S=m.importRanges,E=e.importRangeManager;E.collectImportRangeCount(S.length,0,0),S.forEach((function(e){var t=e.ref;t.sheetId=p;var n=Object.assign({},li(Zc(t,g),!0),{sheetName:t.sheetName}),r=p;E.setFromJsonImportRangeMeta(Object.assign({},e,{ref:n,sheetId:r}))}))}}}}]),e}(),g3=function(){function e(){(0,y.Z)(this,e),this.mutationType=we.B2l.MutationType.MutationType_MergeCells}return(0,C.Z)(e,[{key:"execute",value:function(e,t,n,r){var a=t.mergeCells;if(a){var o=n.sheetId,i=a.ranges;if(o&&i){var u=e.getSheetFromId(o);if(u)if(n.isApplySnapshot)u.spansFromJSON(i.map((function(e){return{row:e.startRow||0,col:e.startCol||0,rowCount:(e.endRow||0)-(e.startRow||0),colCount:(e.endCol||0)-(e.startCol||0)}})));else{var s,l=_n(i);try{for(l.s();!(s=l.n()).done;){var c=s.value,h=c.startRow,f=c.startCol,d=c.endRow,v=c.endCol;u.addSpan(h||0,f||0,(d||0)-(h||0),(v||0)-(f||0))}}catch(e){l.e(e)}finally{l.f()}}}}}}]),e}(),m3=function(){function e(){(0,y.Z)(this,e),this.mutationType=we.B2l.MutationType.MutationType_SetAutoFilter}return(0,C.Z)(e,[{key:"execute",value:function(e,t,n,r){var a=t.setAutoFilter;if(a){var o=n.sheetId,i=a.value,u=e.getSheetFromId(o);u&&u.inject(SE).deserialize(i,n.resourceRefs)}}}]),e}(),p3=function(){function e(){(0,y.Z)(this,e),this.mutationType=we.B2l.MutationType.MutationType_SetRangeValues}return(0,C.Z)(e,[{key:"execute",value:function(e,t,n,r){var a,o,i,u,s=t.setRangeValues;if(s){var l=null!==(a=null===(o=n.offsetRange)||void 0===o?void 0:o.row)&&void 0!==a?a:0,c=null!==(i=null===(u=n.offsetRange)||void 0===u?void 0:u.col)&&void 0!==i?i:0,h=s.range,f=s.valueRefDelta,d=s.resourceRefDelta,v=s.formatDelta,g=s.cellsDelta,m=s.cells,p=h.sheetId,y=e.getSheetFromId(p),C=new Hk(f,d,v,n.isApplySnapshot);if(null!=m&&m.cellIds&&m.cells&&h)for(var _=h.endCol-h.startCol,R=h.startRow+l,w=h.startCol+c,k=m.cellIds.length,S=0;S<k;S++){var E=Math.floor(S/_)+R,T=Math.floor(S%_)+w,A=m.cellIds[S],I=m.cells[A];y._dataModel.deserializeCell(E,T,I,C)}if(null!=g&&g.denseCells&&h)for(var b=h.endCol-h.startCol,F=h.startRow+l,M=h.startCol+c,V=g.denseCells.length,N=0;N<V;N++){var O=Math.floor(N/b)+F,x=Math.floor(N%b)+M,Z=g.denseCells[N];y._dataModel.deserializeCellV1(O,x,Z,C)}else if(null!=g&&g.sparseCells)for(var D=g.sparseCells.length,P=0;P<D;P++){var L=g.sparseCells[P];y._dataModel.deserializeCellV1(L.row+l,L.col+c,L.cell,C)}}}}]),e}(),y3=function(){function e(){(0,y.Z)(this,e),this.mutationType=we.B2l.MutationType.MutationType_SetDimensionProperties}return(0,C.Z)(e,[{key:"execute",value:function(e,t,n,r){var a=t.setDimensionProperties;if(a){var o=n.sheetId,i=e.getSheetFromId(o);if(i){var u=a.rowDimensions,s=a.colDimensions,l=a.rowOutlineGroups,c=a.colOutlineGroups;i._getRowInfos().deserialize(u||[]),i.outlineGroupModel.deserialize(l||[],!0),i._getColInfos().deserialize(s||[]),i.outlineGroupModel.deserialize(c||[],!1)}}}}]),e}(),C3=function(){function e(){(0,y.Z)(this,e),this.mutationType=we.B2l.MutationType.MutationType_SetWorkbookProperties}return(0,C.Z)(e,[{key:"execute",value:function(e,t,n,r){var a,o,i=t.setWorkbookProperties;if(i){var u=i.workbookPr,s=i.defaults;e.lang=null!==(a=null==u?void 0:u.lang)&&void 0!==a?a:void 0,e.locale=null!==(o=null==u?void 0:u.locale)&&void 0!==o?o:void 0,e.formatterService.i18n.setLanguage(e.lang||e.getUserLanguage());var l=aK._defaultOptions;for(var c in l)if(!mK(c,e.options)){var h=null==u?void 0:u[c];e.options[c]=Vd(h)?h:l[c]}if(e.initFormulaCacheManager(),null!=s&&s.format){var f,d,v,g,m,p,y,C,_=s.format,R=s.styles,w=_.defaultColWidth,k=_.defaultRowHeight,S=_.lineHeightFactor,E=_.inlineAlign,T=_.cellPadding;e.defaults=Object.assign({},e.defaults||{},{colWidth:null!==(f=w)&&void 0!==f?f:0,rowHeight:null!==(d=k)&&void 0!==d?d:0,lineHeightFactor:null!==(v=S)&&void 0!==v?v:0,inlineAlign:null!==(g=E)&&void 0!==g&&g,cellPadding:[null!==(m=null==T?void 0:T.top)&&void 0!==m?m:0,null!==(p=null==T?void 0:T.right)&&void 0!==p?p:0,null!==(y=null==T?void 0:T.bottom)&&void 0!==y?y:0,null!==(C=null==T?void 0:T.left)&&void 0!==C?C:0],style:R?xp(R):{}})}}}}]),e}(),_3=function(){function e(){(0,y.Z)(this,e),this.mutationType=we.B2l.MutationType.MutationType_AddSparklineGroup}return(0,C.Z)(e,[{key:"execute",value:function(e,t,n,r){var a=t.addSparklineGroup;if(a){var o=n.sheetId,i=e.getSheetFromId(o);if(i){var u=a.value;if(u){var s=i.getSparklineModel(),l=u.id,c=u.config,h=u.sparklines;if(l&&null!==c&&(5===(null==c?void 0:c.themeType)&&(c.themeType=we.fW_.pro),s.addGroupById(l,c),h))for(var f=0,d=Object.entries(h);f<d.length;f++){var v=(0,p.Z)(d[f],2),g=v[0],m=v[1];if(s.getSparklineById(g))s.setSparklineById(g,l);else{var y=m||{},C=y.source,_=y.position;if(!C||!_)continue;s.createSparkline(C,{row:_.startRow,col:_.startCol},g,l)}}}}}}}]),e}(),R3=function(){function e(){(0,y.Z)(this,e),this.mutationType=we.B2l.MutationType.MutationType_SetChartMap}return(0,C.Z)(e,[{key:"execute",value:function(e,t,n,r){var a=t.setChartMap;if(a){var o=n.sheetId,i=e.getSheetFromId(o);if(i)try{var u=JSON.parse(a.chartMap);i.chartModel=tE.fromJSON(i,u)}catch(e){console.error("SetChartMapExecutor parse chartMap error!",e)}}}}]),e}(),w3=function(){function e(){(0,y.Z)(this,e),this.mutationType=we.B2l.MutationType.MutationType_AddCalcResult}return(0,C.Z)(e,[{key:"execute",value:function(e,t,n,r){var a=t.addCalcResult;if(a){var o=n.sheetId,i=e.getSheetFromId(o),u=a.pivotTableViewModels;if(i&&u)try{u.forEach((function(e){var t=e.id,n=e.viewModel?JSON.parse(e.viewModel):void 0,r=e.errorState,a=i.embeddedBlocksModel.getBlock(t).position,o=a.row,u=a.col;"function"==typeof we.Ps3.pivotTableHelper.renderPivotTableWithPosition&&we.Ps3.pivotTableHelper.renderPivotTableWithPosition(i,t,o,u,n,{errorState:r})}))}catch(e){console.error(e)}}}}]),e}();iK.registerMutation(new C3),iK.registerMutation(new v3),iK.registerMutation(new y3),iK.registerMutation(new g3),iK.registerMutation(new p3),iK.registerMutation(new d3),iK.registerMutation(new e3),iK.registerMutation(new h3),iK.registerMutation(new l3),iK.registerMutation(new c3),iK.registerMutation(new t3),iK.registerMutation(new m3),iK.registerMutation(new n3),iK.registerMutation(new s3),iK.registerMutation(new o3),iK.registerMutation(new r3),iK.registerMutation(new _3),iK.registerMutation(new R3),iK.registerMutation(new w3),function(e){e[e.NO_VALIDATOR=0]="NO_VALIDATOR",e[e.VALIDATE_FAILED=1]="VALIDATE_FAILED"}(u3||(u3={}));var k3=function(){function e(t){(0,y.Z)(this,e),this.sheetContexts={},this.spreadContext=null,this.spread=t}return(0,C.Z)(e,[{key:"validate",value:function(t){var n=this,r=[];return{status:t.every((function(t,a){var o=e.validators[t.action];if(!o)return r.push({type:0,action:t,index:a}),!0;var i=o.call(n,t,n.getSheetContext(t.sheet_id));return i||r.push({type:1,action:t,index:a}),i})),errors:r}}},{key:"getSpread",value:function(){return this.spread}},{key:"getSheetContext",value:function(e){if(!(e in this.sheetContexts)){var t=this.spread.getSheetFromId(e);if(!t)return{targetSheet:null,rowCount:-1/0,colCount:-1/0};var n=t.getRowCount(),r=t.getColumnCount();this.sheetContexts[e]={targetSheet:t,rowCount:n,colCount:r}}return this.sheetContexts[e]}},{key:"getSpreadContext",value:function(){if(!this.spreadContext){var e=this.spread,t=e.importRangeManager,n=e.importRangeManagerV3;this.spreadContext={importRangeCount:t.countImportRange(),isImportRangeExceedLimit:n.V3Enable?function(){return!1}:t.isImportRangeNumExceedLimitWithRangeCache.bind(t)}}return this.spreadContext}},{key:"getActionInfo",value:function(e,t){return this.getActionInfoBySheetId(t.sheet_id)}},{key:"getActionInfoBySheetId",value:function(e){return this.getSheetContext(e)}}]),e}();k3.validators={},k3.add=function(e,t){k3.validators[e]=t},k3.remove=function(e){delete k3.validators[e]};var S3=function(e,t){var n=!(arguments.length>2&&void 0!==arguments[2])||arguments[2],r=e.getSheetFromId(t.sheet_id);return!(!n||!r)||!n&&!r},E3=function(e,t,n){return!(null==e.row||e.row<0||e.row>=t||null==e.col||e.col<0||e.col>=n)},T3=function(e){if(e){if(e.value&&e.value instanceof Array&&e.value.some((function(e){return void 0===e.text||null===e.text})))return!1;if(e.formulaData&&!e.hasOwnProperty("value"))return!1}return!0},A3=function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;return!(null==e.row||null==e.row_count||e.row_count<=0||e.row+e.row_count>t+n)},I3=function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;return!(null==e.col||null==e.col_count||e.col_count<=0||e.col+e.col_count>t+n)},b3=function(e,t,n,r){return!(!e.getSheetFromId(t.sheetId)||t.row+t.rowCount>n||t.col+t.colCount>r)};function F3(e){return!(e.style&&e.style.dropdown&&e.dataValidation)}function M3(e){return function(e){if(e.hasOwnProperty(ag)&&(null===e.dataValidation||void 0===e.dataValidation))return e.hasOwnProperty("style");var t=e.hasOwnProperty("style")&&!e.style,n=Boolean(e.style&&!e.style.dropdown);return!t&&!n||e.hasOwnProperty(ag)}(e)}function V3(e,t){return!t.isImportRangeExceedLimit(e)||(we.Ps3.Toast.error({key:"crossTableError_num",closable:!0,content:fn("CreationDoc_Sheets_ImportrangeToLimit",we.Ps3.getSheetImportRangeCountLimit())}),!1)}function N3(e,t,n){switch(e.type){case we.xj7.ROW:var r=e.row,a=e.row_count;return!(void 0===r||void 0===a||a<=0)&&A3({row:r,row_count:a},t);case we.xj7.COL:var o=e.col,i=e.col_count;return!(void 0===o||void 0===i||i<=0)&&I3({col:o,col_count:i},n);default:return!1}}function O3(e){return!(!e.value||!e.value.range_id)}function x3(e,t,n){if(1===e.type){var r=e.row,a=e.row_count;return!(void 0===r||void 0===a||a<=0)&&A3({row:r,row_count:a},t)}if(2===e.type){var o=e.col,i=e.col_count;return!(void 0===o||void 0===i||i<=0)&&I3({col:o,col_count:i},n)}return 0!==e.type||function(e,t,n){var r=e.row,a=e.col,o=e.row_count,i=e.col_count;return!(void 0===r||void 0===a||void 0===o||void 0===i||o<=0||i<=0)&&A3({row:r,row_count:o},t)&&I3({col:a,col_count:i},n)}(e,t,n)}function Z3(e){return function(e){if(e.hasOwnProperty(ag)&&(null===e.dataValidation||void 0===e.dataValidation))return e.hasOwnProperty("style");var t=e.hasOwnProperty("style")&&null===e.style,n=Boolean(e.style&&!e.style.dropdown);return!t&&!n||e.hasOwnProperty(ag)}(e)}var D3={sort:function(e,t){var n=this.getActionInfo(e,t),r=n.rowCount,a=n.colCount;return E3(t.target,r,a)&&A3(t.target,r)&&I3(t.target,a)},setCell:function(e,t){var n=this.getActionInfo(e,t),r=n.rowCount,a=n.colCount,o=t.value.dataValidation;if(o&&!Ig(o))return!1;var i=this.getSpreadContext();return T3(t.value)&&E3(t.target,r,a)&&F3(t.value)&&M3(t.value)&&function(e,t){return null==e.formulaData||null==e.formulaData.externalDataReference||V3([e.formulaData.externalDataReference],t)}(t.value,i)},setRange:function(e,t){var n=t.value.dataValidation;return!(n&&!Ig(n))&&T3(t.value)&&F3(t.value)&&Z3(t.value)},updateRange:function(e,t){var n=t.value.dataValidation;return!(n&&!Ig(n))&&F3(t.value)},setSpans:function(e,t){var n=this.getActionInfo(e,t),r=n.rowCount,a=n.colCount,o=function(e){return E3(e,r,a)&&A3(e,r)&&I3(e,a)&&e.row_count*e.col_count>1},i=o(t.target);return Array.isArray(t.value)&&(i=i&&t.value.every((function(e){return o(e.target)}))),i},setColumnWidth:function(e,t){var n=this.getActionInfo(e,t).colCount;return I3(t.target,n)&&null!=t.value},setRowHeight:function(e,t){var n=this.getActionInfo(e,t).rowCount;return A3(t.target,n)&&null!=t.value},addRow:function(e,t){var n=this.getActionInfo(e,t),r=A3(t.target,n.rowCount,t.target.row_count);return n.rowCount+=t.target.row_count,r},addCol:function(e,t){var n=this.getActionInfo(e,t),r=I3(t.target,n.colCount,t.target.col_count);return n.colCount+=t.target.col_count,r},delRow:function(e,t){var n=this.getActionInfo(e,t);if(!A3(t.target,n.rowCount))return n.rowCount-=t.target.row_count,!1;var r=new Set(Object.keys(n.targetSheet.getHiddenRows())),a=new Array(t.target.row_count).fill(0).map((function(e,n){return n+t.target.row})),o=a.filter((function(e){return r.has("".concat(e))})).length;return!(t.target.row_count-o>=n.rowCount-r.size||(n.rowCount-=t.target.row_count,0))},delCol:function(e,t){var n=this.getActionInfo(e,t);if(!I3(t.target,n.colCount))return n.colCount-=t.target.col_count,!1;var r=new Set(Object.keys(n.targetSheet.getHiddenCols())),a=new Array(t.target.col_count).fill(0).map((function(e,n){return n+t.target.col})),o=a.filter((function(e){return r.has("".concat(e))})).length;return!(t.target.col_count-o>=n.colCount-r.size||(n.colCount-=t.target.col_count,0))},hideRow:function(e,t){var n=this.getActionInfo(e,t).rowCount;return A3(t.target,n)},unhideRow:function(e,t){var n=this.getActionInfo(e,t).rowCount;return A3(t.target,n)},hideCol:function(e,t){var n=this.getActionInfo(e,t).colCount;return I3(t.target,n)},unhideCol:function(e,t){var n=this.getActionInfo(e,t).colCount;return I3(t.target,n)},delFilter:function(e,t){var n=this.getActionInfo(e,t).targetSheet;return!(!n||!n.filterModel.info)},setFilter:function(e,t){var n=this.getActionInfo(e,t),r=n.rowCount,a=n.colCount;return A3(t.target,r)&&I3(t.target,a)},freezeSheet:function(e,t){var n=this.getActionInfo(e,t),r=n.rowCount,a=n.colCount;return!(t.target.row<-1||t.target.col<-1||t.target.row>=r||t.target.col>=a)},addComments:function(e,t){var n=this.getActionInfo(e,t),r=n.rowCount,a=n.colCount;return E3(t.target,r,a)&&t.value.comments.length>0},recover:function(e,t){return!0},setChart:function(e,t){return!0},delChart:function(e,t){return!0},addSheet:function(e,t){return!!S3(e,t,!1)},setSheet:function(e,t){return!!S3(e,t)},copySheet:function(e,t){if(t.value.snapshot){var n=t.value.snapshot,r=n.rowCount,a=void 0===r?0:r,o=n.columnCount;if(0===a||0===(void 0===o?0:o))return!1}if(t.sheet_id===t.value.sheet_id){if(!S3(e,t,!1))return!1}else if(!S3(e,t,!0))return!1;return!0},delSheet:function(e,t){return!!S3(e,t)},softDelSheet:function(e,t){return!0},restoreSheet:function(e,t){return!0},moveSheet:function(e,t){return!!S3(e,t)},moveRange:function(e,t){var n=this.getActionInfoBySheetId(t.value.source.sheetId),r=n.rowCount,a=n.colCount,o=this.getActionInfoBySheetId(t.value.target.sheetId),i=o.rowCount,u=o.colCount,s=t.value.source,l=t.value.target;return!(!b3(e,s,r,a)||!b3(e,l,i,u))},addConditionalFormat:function(e,t){return!0},setConditionalFormat:function(e,t){return!0},delConditionalFormat:function(e,t){return!0},moveConditionalFormat:function(e,t){return!0},setFloatBlock:function(e,t){return!!t.value},delFloatBlock:function(e,t){if(!t.value)return!1;var n=t.value,r=n.blockToken,a=n.blockType;return!(!r||!a)},setEmbeddedBlock:function(e,t){return!(!t.value||!t.target)},delEmbeddedBlock:function(e,t){if(!t.value)return!1;var n=t.value,r=n.blockToken,a=n.blockType;return!(!r||!a)},addView:function(e,t){return Boolean(t.value)},delView:function(e,t){return Boolean(t.value)},setView:function(e,t){return Boolean(t.value)},setFilterView:function(e,t){if(!t.value)return!1;if(t.value.range){var n=t.value.range,r=n.col_count,a=n.row_count;if(r<=0||a<=0)return!1}return!0},setRangeValues:function(e,t){return t.value.value.length===t.target.row_count*t.target.col_count&&function(e,t){if(!e.value.formulaData||0===e.value.formulaData.length)return!0;for(var n=[],r=new Set,a=0;a<e.value.formulaData.length;a++){var o=e.value.formulaData[a].externalDataReference;o&&(r.add(a),n.push(o))}return V3(n,t)}(t,this.getSpreadContext())},setDataRange:function(e,t){var n=this.getActionInfo(e,t);return function(e,t,n){return!!O3(e)&&!!x3(e.target,t,n)}(t,n.rowCount,n.colCount)},delDataRange:function(e,t){return!!O3(t)},addOutline:function(e,t){var n=this.getActionInfo(e,t),r=n.rowCount,a=n.colCount;return N3(t.target,r,a)},updateOutline:function(e,t){var n=this.getActionInfo(e,t),r=n.rowCount,a=n.colCount;return N3(t.target,r,a)},delOutline:function(e,t){var n=this.getActionInfo(e,t),r=n.rowCount,a=n.colCount;return N3(t.target,r,a)},setRangeProtection:function(e,t){var n=this.getActionInfo(e,t);return function(e,t,n){for(var r=e.value.ranges,a=0,o=r.length;a<o;a++){var i=r[a];switch(i.type){case we.xj7.NORMAL:if(!(E3(i,t,n)&&A3(i,t)&&I3(i,n)))return!1;break;case we.xj7.ROW:if(!A3(i,t))return!1;break;case we.xj7.COL:if(!I3(i,n))return!1}}return!0}(t,n.rowCount,n.colCount)}},P3=function(e){k3.add(e,(function(t){return D3[e].call(this,this.getSpread(),t)}))};for(var L3 in D3)P3(L3);function B3(e,t,n){for(var r=e.sheets.map((function(e){return e.name()})),a=2,o=U3(t,n);-1!==r.indexOf(o);)o=U3(t,n,a),a+=1;return o}function U3(e,t,n){return"".concat(e,"（").concat(t).concat(n||"","）")}var H3=[{pred:function(e){return Array.isArray(e.value)&&e.value.some(we.MgP)},type:4},{pred:function(e){return Array.isArray(e.value)&&e.value.some(we.S3_)},type:2},{pred:function(e){return null!=e.formulaData&&null!=e.formulaData.externalDataReference},type:1},{pred:function(e){return null!=e.note},type:8}];function W3(e){return e.map((function(e){var t=e.type,n=(0,s.Z)(e,yn);return Object.assign({type:t},(0,we.W43)(n))}))}var j3=function(){function e(t,n){(0,y.Z)(this,e),this._changesets=[],this.style2Json=new Map,this._sheet=t,this._sheetId=t&&t.id(),this._command=n,n.isFirstExecution=!n._changesets,n._changesets=n._changesets||[],n._oldChangesets=n._oldChangesets||[]}return(0,C.Z)(e,[{key:"execute",value:function(e){return!1}},{key:"canExecute",value:function(){return!0}},{key:"canUndo",value:function(e){return!!this.checkRangeValid(this._sheet.parent,this._command._oldChangesets)}},{key:"undo",value:function(e){return!0}},{key:"_collRangeInfo",value:function(e,t){this._beforeAction(e);var n=this.collectRangeActions(e,t);return this._afterAction(e),this.collectColumnWidthActions(e,t).forEach((function(e){return n.push(e)})),n}},{key:"saveChangesets",value:function(e,t){var n=t?this._command._oldChangesets:this._command._changesets;e.forEach((function(e){n.push(e)}))}},{key:"saveNewSetColumnWidthAction",value:function(e,t){var n=this._sheet,r=n.defaults.colWidth,a=n._getColInfos().getSize(e);return(a===r&&t!==r||a<t)&&(this.command._changesets.push(this._colWidthAction(e,t||r)),!0)}},{key:"_beforeAction",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];t||e.suspendEvent()}},{key:"_afterAction",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];t||e.resumeEvent()}},{key:"_styleToChangeset",value:function(e,t,n,r){var a=r?this._command._oldChangesets:this._command._changesets,o=this._styleAction(e,t,n);a.push(o)}},{key:"_rangeStyleToChangeset",value:function(e,t,n,r){var a=r?this._command._oldChangesets:this._command._changesets,o=this._rangeStyleAction(e,t,n);a.push(o)}},{key:"_cellValueToChangeset",value:function(e,t,n,r){var a=r?this._command._oldChangesets:this._command._changesets,o=this._cellValueAction(e,t,n);a.push(o)}},{key:"_rangeOpToChangeset",value:function(e,t,n){if(e.colCount()<1||e.rowCount()<1)we.Ps3.moirae.teaLog({key:"client_sheet_action_range_invalid",from:this.commandName,row:e.rowFrom(),col:e.colFrom(),rowCount:e.rowCount(),colCount:e.colCount()});else{var r=n?this._command._oldChangesets:this._command._changesets,a=this._updateRangeAction(e,t);r.push(a)}}},{key:"_setRangeToChangeset",value:function(e,t,n){if(e.colCount()<1||e.rowCount()<1)we.Ps3.moirae.teaLog({key:"client_sheet_action_range_invalid",from:this.commandName,row:e.rowFrom(),col:e.colFrom(),rowCount:e.rowCount(),colCount:e.colCount()});else{var r=n?this._command._oldChangesets:this._command._changesets,a=this._setRangeAction(e,t);r.push(a)}}},{key:"_setRangeValuesActionToChangeset",value:function(e,t,n){var r=t?this._command._oldChangesets:this._command._changesets;n?r.unshift(e):r.push(e)}},{key:"_cellStyleAndValueToCS",value:function(e,t,n,r,a,o){var i=a?this._command._oldChangesets:this._command._changesets,u=this._styleAction(e,t,r,o);if(n){var s=this._cellValueAction(e,t,n);if(null!=u.value.styleId){var l=u.value.styleId;s.value.styleId=l;var c=s.extra||{},h=c.styles||{};h[l]=P$.getById(l),c.styles=h,s.extra=c}return s.value.style=u.value.style,s.value.dataValidation=u.value.dataValidation,void i.push(s)}i.push(u)}},{key:"_cellCommentsToChangeset",value:function(e,t,n,r){var a=r?this._command._oldChangesets:this._command._changesets,o=this._cellCommentsAction(e,t,n);a.push(o)}},{key:"_styleCloneToJson",value:function(e){if(null==e)return null;var t=e.clone();return"function"==typeof t.toJSON?t.toJSON():null}},{key:"_spanToChangeset",value:function(e,t,n){var r=n?this._command._oldChangesets:this._command._changesets;1===e.rowCount()&&1===e.colCount()||r.push(this._setSpansAction(e,t))}},{key:"_rowHeightToChangeset",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]&&arguments[2],r=arguments.length>3&&void 0!==arguments[3]&&arguments[3],a=n?this._command._oldChangesets:this._command._changesets,o=this._rowHeightAction(e,t,r);a.push(o)}},{key:"batchRowHeightToChangeset",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]&&arguments[2],r=arguments.length>3&&void 0!==arguments[3]&&arguments[3],a=n?this._command._oldChangesets:this._command._changesets,o=e.target,i=e.count,u={action:"setRowHeight",sheet_id:this._sheetId,is_local:r,target:{row:o,row_count:i},value:t};a.push(u)}},{key:"_columnWidthToChangeset",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]&&arguments[2],r=arguments.length>3&&void 0!==arguments[3]&&arguments[3],a=n?this._command._oldChangesets:this._command._changesets,o=this._colWidthAction(e,t,r);a.push(o)}},{key:"batchColumnWidthToChangeset",value:function(e,t,n,r){var a=n?this._command._oldChangesets:this._command._changesets,o=e.target,i=e.count,u={action:"setColumnWidth",sheet_id:this._sheetId,is_local:r,target:{col:o,col_count:i},value:t};a.push(u)}},{key:"_rowFIdToChangeset",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]&&arguments[2],r=n?this._command._oldChangesets:this._command._changesets,a=this._rowfIdAction(e,t);r.push(a)}},{key:"_columnFIdToChangeset",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]&&arguments[2],r=n?this._command._oldChangesets:this._command._changesets,a=this._columnfIdAction(e,t);r.push(a)}},{key:"_sortToChangeset",value:function(e,t,n,r,a,o){var i=o?this._command._oldChangesets:this._command._changesets,u={action:"sort",sheet_id:this._sheetId,target:{row:e,row_count:n,col:t,col_count:r},value:a};i.push(u)}},{key:"_applyChangsetWithEvent",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1],n=arguments.length>2?arguments[2]:void 0,r=this._sheet;try{return r.getParent().applyActions(e,t,!0,n),!0}catch(e){return we.Ps3.moirae.ravenCatch(e),!1}}},{key:"_applySpreadChangsetWithEvent",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]&&arguments[2],r=arguments.length>3?arguments[3]:void 0;try{return e.applyActions(t,n,!0,r),!0}catch(e){return we.Ps3.moirae.ravenCatch(e),!1}}},{key:"collectRangeActions",value:function(e,t){var n=this,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},a=e.id(),o=e.getSpans(t,void 0,!0),i=[],u=t.rowFrom(),s=t.colFrom(),l=t.rowCount(),c=t.colCount();l*c>1&&i.push({action:"setSpans",sheet_id:a,target:this._transformRange(t),value:o?o.map((function(e){return{target:n._transformRange(e)}})):[]});var h=jQ(e,{row:u,col:s,rowCount:l,colCount:c},r,WQ);return i.push(h),i}},{key:"getAddCommentsAction",value:function(e,t,n){var r=[],a=e.getComments(t,n),o=e.id();return Array.isArray(a)&&a.length>0&&r.push({action:"addComments",sheet_id:o,target:{row:t,col:n},value:{comments:a}}),r}},{key:"getSetCellAction",value:function(e,t,n){var r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{},a=r.ignorePivotTable,o=r.handleStyleRef,i=void 0===o||o,u=e.getStyleWithDropdown(t,n,!0),s=u&&u.toJSON()||null,l=e.getFormula(t,n,void 0,a),c=e.getMultipleValuesJSON(t,n),h=e.getReminderChangeset(t,n),f=e.getDataValidationJSON(t,n,{needDeepClone:!0}),d={style:s,formula:l,value:l?null:e.getChangesetValue(t,n,a),reminder:h,dataValidation:f,multipleValues:c};if(r&&!0!==r.ignoreFormulaData){var v=e.getFormulaData(t,n,void 0,a);v&&(d.formulaData=v)}if(r&&r.needNote){var g=e.getCellNoteJSON(t,n);g&&(d.note=g)}var m={action:"setCell",sheet_id:e.id(),target:{row:t,col:n},value:d};i&&(m=B$(m));var p=z3(m.value);return null!==p&&(m.type=p),m}},{key:"collectColumnWidthActions",value:function(e,t){for(var n=e.id(),r=t.colCount(),a=t.colFrom(),o=[],i=0;i<r;i++){var u=i+a;o.push({action:"setColumnWidth",sheet_id:n,target:{col:u,col_count:1},value:e.getColumnWidth(u)})}return o}},{key:"collectRowHeightActions",value:function(e,t){for(var n=e.id(),r=t.rowCount(),a=t.rowFrom(),o=[],i=0;i<r;i++){var u=i+a;o.push({action:"setRowHeight",sheet_id:n,target:{row:u,row_count:1},value:e._getActualRowHeight(u)})}return o}},{key:"_rangeActionsCollect",value:function(e,t,n,r,a,o,i){var u,s=this,l=i||this._sheet,c=l.getRowCount(),h=l.getColumnCount(),f=l.getSpans(new Oi(t,n,r,a,l))||[],d=[];r*a>1&&(d=[{action:"setSpans",sheet_id:l.id(),target:{row:t,row_count:r,col:n,col_count:a},value:f.map((function(e){return{target:s._transformRange(e)}}))}]),this._beforeAction(l);try{u=e.reduce((function(e,t){var n=Object.assign({},t);if(void 0!==n.column&&(n.col=n.column),n.row>=c||n.col>=h)return e;var r=l.getStyleWithDropdown(n.row,n.col),a=l.getChangesetValue(n.row,n.col),o=l.getFormula(n.row,n.col),i=l.getMultipleValuesJSON(n.row,n.col),u=l.getReminderChangeset(n.row,n.col),s=l.getDataValidationJSON(n.row,n.col,{needDeepClone:!0}),f=r?r.toJSON():r;f&&f.dropdown&&(f.dropdown.isValid=function(e,t,n){var r=e.getDropdown(t,n);return!r||P1(e,t,n,r)}(l,n.row,n.col));var d={style:f,formula:o,value:a,reminder:u,dataValidation:s,multipleValues:i},v=l.getFormulaData(n.row,n.col);v&&(d.formulaData=v);var g=B$({action:"setCell",sheet_id:l.id(),target:{row:n.row,col:n.col},value:d}),m=z3(g.value);return null!==m&&(g.type=m),e.push(g),e}),[])}catch(e){throw e}finally{this._afterAction(l)}return d.concat(u)}},{key:"_addRowsAction",value:function(e,t){return{action:"addRow",sheet_id:this._sheetId,target:{row:e,row_count:t}}}},{key:"_delRowsAction",value:function(e,t){return{action:"delRow",sheet_id:this._sheetId,target:{row:e,row_count:t}}}},{key:"_addColsAction",value:function(e,t){return{action:"addCol",sheet_id:this._sheetId,target:{col:e,col_count:t}}}},{key:"_delColsAction",value:function(e,t){return{action:"delCol",sheet_id:this._sheetId,target:{col:e,col_count:t}}}},{key:"_rowHeightAction",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]&&arguments[2],r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:1;return{action:"setRowHeight",sheet_id:this._sheetId,is_local:n,target:{row:e,row_count:r},value:t}}},{key:"_colWidthAction",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]&&arguments[2],r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:1;return{action:"setColumnWidth",sheet_id:this._sheetId,is_local:n,target:{col:e,col_count:r},value:t}}},{key:"_rowfIdAction",value:function(e,t){return{action:"setRowProperty",sheet_id:this._sheetId,target:{row:e,row_count:1},value:{fId:t}}}},{key:"_columnfIdAction",value:function(e,t){return{action:"setColProperty",sheet_id:this._sheetId,target:{col:e,col_count:1},value:{fId:t}}}},{key:"_setSpansAction",value:function(e,t,n){var r=this;return{action:"setSpans",sheet_id:this._sheetId,target:this._transformRange(e,n),value:t?t.map((function(e){return{target:r._transformRange(e,n)}})):[]}}},{key:"_cellValueAction",value:function(e,t,n,r){return this.sheetCellValueAction(this._sheetId,e,t,n,r)}},{key:"sheetCellValueAction",value:function(e,t,n,r,a){var o=Object.assign({},r),i=r.style;i&&(i.toJSON?o.style=i.toJSON():(i.formatter&&null==i.formatter.formatCached||i.autoFormatter&&null==i.autoFormatter.formatCached)&&console.error('The value for property "formatter" or "autoFormatter" in style is invalid'));var u=r.hasOwnProperty("style")&&!i,s=i&&!i.dropdown,l=this._sheet.parent.getSheetFromId(e);if(!l)throw new Error("Can not find sheet by id. ".concat(e));if(!u&&!s||r.hasOwnProperty(ag)||(o.dataValidation=l.getDataValidationJSON(t,n,{needDeepClone:!0})),r.hasOwnProperty(ag)&&!r.dataValidation&&!r.hasOwnProperty("style")){var c=l.getStyleWithDropdown(t,n,a);o.style=c&&c.toJSON()}Array.isArray(r.value)&&r.value.length&&(o.value=xv.getSegmentArray4Changeset(r.value));var h={action:"setCell",sheet_id:e,target:{row:t,col:n},value:o};this._command.dontNeedStyleRef||(h=B$(h));var f=z3(h.value);return null!==f&&(h.type=f),h}},{key:"_cellCommentsAction",value:function(e,t,n){return{action:"addComments",sheet_id:this._sheetId,target:{row:e,col:t},value:{comments:n}}}},{key:"_styleAction",value:function(e,t,n,r){var a=null;if(n){var o=this.style2Json.get(n);o?a=o:(a=n.toJSON()||null,this.style2Json.set(n,a))}var i={style:a};return n&&!n.dropdown&&(i.dataValidation=this._sheet.getDataValidationJSON(e,t,{needDeepClone:!0},r)),B$({action:"setCell",sheet_id:this._sheetId,target:{row:e,col:t},value:i})}},{key:"_rangeStyleAction",value:function(e,t,n){return{action:"updateRange",sheet_id:this._sheetId,value:{target:{row:e,col:t,rowCount:1,colCount:1,type:we.xj7.CELL},style:n||null}}}},{key:"_moveRangeAction",value:function(e,t,n,r,a){return{action:"moveRange",sheet_id:t,value:{source:{sheetId:e,row:n.rowFrom(),col:n.colFrom(),rowCount:n.rowCount(!0),colCount:n.colCount(!0)},target:{sheetId:t,row:r.rowFrom(),col:r.colFrom(),rowCount:n.rowCount(!0),colCount:n.colCount(!0)},type:a}}}},{key:"_updateRangeAction",value:function(e,t){return{action:"updateRange",sheet_id:this._sheetId,value:Object.assign({},t,{target:{type:e.rgType,row:e.rowFrom(),col:e.colFrom(),rowCount:e.rowCount(),colCount:e.colCount()}})}}},{key:"_updateReference",value:function(e){return{action:"updateReference",sheet_id:this._sheetId,value:e}}},{key:"_setRangeAction",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]&&arguments[2];return this._setRangeActionCore(this._sheetId,e,t,n)}},{key:"_setRangeActionCore",value:function(e,t,n){var r=arguments.length>3&&void 0!==arguments[3]&&arguments[3];return{action:"setRange",sheet_id:e,value:Object.assign({},n,{target:{type:t.rgType,row:t.rowFrom(),col:t.colFrom(),rowCount:t.rowCount(r),colCount:t.colCount(r)}})}}},{key:"getSheetNoConflictName",value:function(e,t,n){return B3(e,t,n)}},{key:"_transformRange",value:function(e,t){return{row:e.rowFrom(),col:e.colFrom(),row_count:e.rowCount(t),col_count:e.colCount(t)}}},{key:"_colStyleAction",value:function(e,t,n){var r=this._sheet,a=r.getStyle(e,t,void 0,n),o=r.getDefaultStyle();if(!a||a.equals(o))return null;var i={style:a&&a.toJSON()||null,dataValidation:null};return B$({action:"setCell",sheet_id:this._sheetId,target:{row:e,col:t},value:i})}},{key:"_getCSWithoutFilterRow",value:function(e){if(!Array.isArray(e))return e;for(var t=[],n=0;n<e.length;n++){var r=e[n];"setCell"===r.action&&null!=r.target&&this._isFilterRow(r.target.row)||t.push(r)}return t}},{key:"_isFilterRow",value:function(e){return!this._sheet.filterModel.isVisible(e)}},{key:"splitSelectionByFilterRow",value:function(e){var t=e.rowFrom(),n=e.rowTo();if(1===e.rowCount())return this._isFilterRow(t)?[]:[e];for(var r,a,o=this._sheet.filterModel.getAllFilteredOutRowsArray(),i=0,u=o.length-1;i<o.length;i++,u--)void 0===r&&o[i]>=t&&(r=i),void 0===a&&o[u]<=n&&(a=u);if(void 0===r||void 0===a)return[e];var s=o.slice(r,a+1);return this._splitRangeByRows(e,s)}},{key:"_splitRangeByRows",value:function(e,t){var n=this,r=e.rowFrom(),a=e.rowTo(),o=e.colFrom(),i=e.colCount(),u=[];return t.forEach((function(e){e-1>=r&&u.push(new Oi(r,o,e-r,i,n._sheet)),r=e+1})),r<=a&&u.push(new Oi(r,o,a-r+1,i,this._sheet)),u}},{key:"_getCellValue",value:function(e,t){var n=this._sheet.getStyleWithDropdown(e,t),r=n&&n.toJSON()||null,a=this._sheet.getChangesetValue(e,t),o=this._sheet.getFormula(e,t),i=this._sheet.getFormulaData(e,t),u=this._sheet.getReminderChangeset(e,t),s=this._sheet.getDataValidationJSON(e,t,{needDeepClone:!0}),l=this._sheet.getMultipleValues(e,t);return{value:a,style:r,formula:o,formulaData:i,reminder:u,dataValidation:s,multipleValues:l?l.toJSON():null,note:this._sheet.getCellNoteJSON(e,t)}}},{key:"clearRangeInChartBlock",value:function(e){var t={chartId:e.chartId,blockSetting:Object.assign({},e.blockSetting),graphSetting:(0,Re.default)(e.graphSetting)};return delete t.blockSetting.row,delete t.blockSetting.col,t}},{key:"appendOldChartChangeset",value:function(e){var t=this,n=this._command._oldChangesets;e.forEach((function(e,r){n.push({action:"setChart",sheet_id:t._sheetId,target:{row:e.blockSetting.row,col:e.blockSetting.col},value:t.clearRangeInChartBlock(e)})}))}},{key:"getSetDataRangeAction",value:function(e){var t;switch(e.type){case we.xj7.ROW:t={action:"setDataRange",sheet_id:e.sheetId,value:{range_id:e.rangeId,usage_type:e.usageType,create_time:e.createTime},target:{type:1,row:e.row,row_count:e.rowCount}};break;case we.xj7.COL:t={action:"setDataRange",sheet_id:e.sheetId,value:{range_id:e.rangeId,usage_type:e.usageType,create_time:e.createTime},target:{type:2,col:e.col,col_count:e.colCount}};break;case we.xj7.ALL:t={action:"setDataRange",sheet_id:e.sheetId,value:{range_id:e.rangeId,usage_type:e.usageType,create_time:e.createTime},target:{type:3}};break;case we.xj7.NORMAL:default:t={action:"setDataRange",sheet_id:e.sheetId,value:{range_id:e.rangeId,usage_type:e.usageType,create_time:e.createTime},target:{type:0,row:e.row,row_count:e.rowCount,col:e.col,col_count:e.colCount}}}return t}},{key:"getDelDataRangeAction",value:function(e){return{action:"delDataRange",sheet_id:e.sheetId,value:{range_id:e.rangeId}}}},{key:"appendOldRangeChangeset",value:function(e,t){var n=this,r=this._command._oldChangesets;t.forEach((function(t){t.sheetId===e&&r.push(n.getSetDataRangeAction(t))}))}},{key:"clearRangeInFloatImageBlock",value:function(e){return{floatImageId:e.floatImageId,floatImageSetting:(0,A.default)(e.floatImageSetting,["row","col"])}}},{key:"appendOldFloatImageChangeset",value:function(e){var t=this,n=this._command._oldChangesets;e.forEach((function(e,r){n.push({action:"setFloatImage",sheet_id:t._sheetId,target:{row:e.floatImageSetting.row,col:e.floatImageSetting.col},value:t.clearRangeInFloatImageBlock(e)})}))}},{key:"tryApplyActions",value:function(e,t,n,r,a){return!!this.checkRangeValid(e,t,r)&&this._applyChangsetWithEvent(t,n,a)}},{key:"checkRangeValid",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]&&arguments[2],r=new k3(e).validate(t),a=r.status;if(!a){var o=e.commandManager().getExecutingType(),i=JSON.stringify((0,we.W43)(t)).substr(0,2048);if(console.error("RangeInvalid: ".concat(this.commandName," ").concat(i," from ").concat(o)),we.Ps3.moirae.teaLog({key:"client_sheet_action_validator_fail",command:this.commandName,detail:i,from:o,errors:JSON.stringify(W3(r.errors)).substr(0,2048),raiseException:n}),n){var u=JSON.stringify(W3(r.errors)).substr(0,2048);throw console.error("errors: ".concat(u)),new Error("CheckRangeValid Fail")}throw new Error(Vn)}return a}},{key:"checkCellValid",value:function(e,t,n){var r=arguments.length>3&&void 0!==arguments[3]&&arguments[3],a=e.getRowCount(),o=e.getColumnCount(),i=E3({row:t,col:n},a,o);if(!i){var u=e.parent.commandManager().getExecutingType(),s=JSON.stringify({row:t,col:n,rowCount:a,colCount:o});if(console.error("CellInValid: ".concat(this.commandName," ").concat(s," from ").concat(u)),we.Ps3.moirae.teaLog({key:"client_sheet_action_validator_fail",command:this.commandName,detail:s,from:u,raiseException:r}),r)throw new Error("CheckCellValid Fail")}return i}},{key:"checkRangeDuplicate",value:function(e,t,n,r){for(var a=this._sheet,o=0;o<e.length;o++){var i=e[o],u=O1(i);t.has(u)?we.Ps3.moirae.teaLog({key:"client_sheet_command_range_duplicate",callStack:(new Error).stack||"",selections:JSON.stringify(r)||"",splitRanges:JSON.stringify(e)||"",filterRows:JSON.stringify(a.filterModel.getAllFilteredOutRowsArray())}):(t.add(u),n.push(i))}}},{key:"filterDuplicateRange",value:function(e,t){var n=new Set,r=[];if(t){var a,o=_n(e);try{for(o.s();!(a=o.n()).done;){var i=a.value,u=this.splitSelectionByFilterRow(i);this.checkRangeDuplicate(u,n,r,e)}}catch(e){o.e(e)}finally{o.f()}}else this.checkRangeDuplicate(e,n,r,e);return r}},{key:"getPerformanceInfo",value:function(){}},{key:"getSparklineInitialDoAndUndoAction",value:function(e){return{doActions:[{action:"addSparklineGroup",sheet_id:e,value:{}},{action:"updateSparklineGroup",sheet_id:e,value:{}}],undoActions:[{action:"updateSparklineGroup",sheet_id:e,value:{}},{action:"delSparklineGroup",sheet_id:e,value:[]}]}}},{key:"command",get:function(){return this._command}},{key:"commandName",get:function(){return"unknown"}}]),e}();function z3(e){var t=H3.reduce((function(t,n){var r=n.pred,a=n.type;return r(e)?t|a:t}),0);return t||null}function G3(e,t,n){var r=t._changesets[0],a=e.getSheetFromId(r.sheet_id);if(!a)throw new Error("Sheet not found by id: ".concat(r.sheet_id));var o=Object.assign({},r.value);return delete o.block_token,t._changesets=[{action:"restoreBlock",sheet_id:r.sheet_id,value:Object.assign({},o,{block_token:a.blockToken})}],t._oldChangesets[0].value.block_token=a.blockToken,n(e,t._oldChangesets,!0)}function J3(e,t,n,r,a,o){var i=!1;n(t);try{i=e.isFirstExecution?r(t,e):a(e)}catch(e){return we.Ps3.moirae.ravenCatch(e),o(t),!1}return o(t),i}var q3=function(e,t){var n=t.ranges,r=t.id,a=t.creatorId,o=t.description;return{action:"setRangeProtection",sheet_id:e,value:{id:r,creator_id:a,description:o,ranges:n.map((function(e){switch(e.type){case we.xj7.NORMAL:return{type:we.xj7.NORMAL,row:e.row,row_count:e.rowCount,col:e.col,col_count:e.colCount};case we.xj7.COL:return{type:we.xj7.COL,col:e.col,col_count:e.colCount};case we.xj7.ROW:return{type:we.xj7.ROW,row:e.row,row_count:e.rowCount};default:throw new Error("Unsupported protection range: ".concat(JSON.stringify(e)," in ").concat(r))}}))}}};function $3(e,t){return{action:"delRangeProtection",sheet_id:e,value:{id:t.id}}}var Y3=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"execute",value:function(e){if(this._command.isFirstExecution){var t=e.getSheetIds(),n=(0,we.lYS)(t),r=this._command.index,a=this._command.blockType,o=this._command.blockId,i=this._command.blockToken||"",u=this._command.blockData||"",s=this._command.sheetName;if(!o)return!1;if(e.getSheetFromName(s)&&(s=this.getSheetNoConflictName(e,s,fn("sheet.copy_item"))),r<0||r>e.sheets.length)return!1;if(a===we.kHU.BITABLE_BLOCK){if(!this._command.blockData)return we.Ps3.moirae.teaLog({key:"client_sheet_block_data_undefined",command_name:we.rvF.ADD_BLOCK,value:""+this._command.blockData}),!1;if(""!==i){var l="AddBlock 添加 Bitable Block 应传入空字符串 blockToken 或不传入 blockToken。当前获得值 ".concat(i);return console.error(l),we.Ps3.moirae.ravenCatch(new Error(l)),!1}}if(a===we.kHU.DOCX_BLOCK){if(""===i){var c="AddBlock 添加 Docx Block 应传入有效 blockToken。当前获得值 ".concat(i);return console.error(c),we.Ps3.moirae.ravenCatch(new Error(c)),!1}if(""!==u){var h="AddBlock 添加 Docx Block 应不传入 blockData 或传入空字符串。当前获得值 ".concat(u);return console.error(h),we.Ps3.moirae.ravenCatch(new Error(h)),!1}if(e.sheets.find((function(e){return e.blockType===we.kHU.DOCX_BLOCK})))return!1}this._command._oldChangesets=[{action:"delBlock",sheet_id:n,value:{sheet_name:s,index:r,block_type:a,block_id:o,block_token:i}}],this._command._changesets=[{action:"addBlock",sheet_id:n,value:{sheet_id:n,sheet_name:s,index:r,block_type:a,block_id:o,block_token:i,block_data:u}}]}var f=this._applySpreadChangsetWithEvent(e,this._command._changesets,!0);return f&&e.setActiveSheetIndex(this._command._changesets[0].value.index,!0),f}},{key:"undo",value:function(e){return G3(e,this._command,this._applySpreadChangsetWithEvent)}},{key:"canUndo",value:function(e){var t=this._command._changesets[0].sheet_id,n=e.getSheetFromId(t);return Boolean(n&&n.blockToken)}},{key:"commandName",get:function(){return we.rvF.ADD_BLOCK}}]),t}(j3);function K3(e,t,n,r){return t===we.xj7.ROW?{action:"addOutline",sheet_id:e,value:{state:r},target:{type:t,row:n[0],row_count:n[1]}}:{action:"addOutline",sheet_id:e,value:{state:r},target:{type:t,col:n[0],col_count:n[1]}}}function X3(e,t,n){return{action:"addOutline",sheet_id:e,value:{state:n},target:t4(t)}}function Q3(e,t){return{action:"delOutline",sheet_id:e,target:t4(t)}}function e4(e,t,n){return{action:"updateOutline",sheet_id:e,value:{state:n},target:t4(t)}}function t4(e){return e.type===we.xj7.ROW?{type:e.type,row:e.row,row_count:e.rowCount}:{type:e.type,col:e.col,col_count:e.colCount}}var n4,r4=function(e,t){return t?e.rowInterval():e.colInterval()},a4=function(e,t,n,r){var a=[],o=[],i=e.outlineGroupModel,u=t.outlineGroupModel,s=t.inject(Ft.tb).resolve("outlineGroupMaxCount",we.VVE);if(i.rowOutlineTree.length+i.colOutlineTree.length>=s)return we.Ps3.Toast.show({type:"error",content:fn("LarkCCM_Sheets_Group_NewFailed_Toast",{num:s}),duration:2e3}),{newChangesets:a,oldChangesets:o};var l=n[0],c=l.fromRange,h=l.toRange;return[!0,!1].forEach((function(n){if(function(e,t,n){var r=t?n.getColumnCount():n.getRowCount();return(t?e.colCount():e.rowCount())===r}(c,n,t)){var s=r4(c,n),l=(0,p.Z)(s,2),f=l[0],d=l[1],v=eu(f,d,n),g=u.getInfluencedOutlines(v),m=r4(h,n),y=(0,p.Z)(m,2),C=y[0],_=y[1],R=eu(C,_,n),w=i.getInfluencedOutlines(R),k=[];(g.length||w.length)&&(w.sort((function(e,t){return t.level-e.level})),o4(w,{newChangesets:a,oldChangesets:o},C,_,e.id(),n),g.sort((function(e,t){return e.level-t.level})),g.forEach((function(e){for(var t=e.start,n=e.count,a=e.state,o=Ki([f,d],[t,n]),i=(0,p.Z)(o,2),u=i[0],s=i[1],l=u4(_,d,r),c=C-f,h=0,v=0;v<l;v++)k.push([u+c+h,s,a]),h+=d})),i4(k).forEach((function(t){var r=eu(t[0],t[1],n);a.push(X3(e.id(),r,t[2])),o.push(Q3(e.id(),r))})),r&&o4(g,{newChangesets:a,oldChangesets:o},f,d,t.id(),n))}})),{newChangesets:a,oldChangesets:o}},o4=function(e,t,n,r,a,o){var i=t.newChangesets,u=t.oldChangesets;e.forEach((function(e){var t=e.start,s=e.count,l=e.state,c=Ki([n,r],[t,s]),h=(0,p.Z)(c,2),f=h[0],d=h[1],v=eu(f,d,o);i.push(Q3(a,v)),u.push(X3(a,v,l))}))},i4=function(e){e.sort((function(e,t){return e[0]!==t[0]?e[0]-t[0]:t[1]-e[1]}));for(var t=e.length-1,n=e.length-2;t>=0;){var r=e[t],a=e[n];a&&r[0]===a[0]&&r[1]===a[1]&&r[2]!==a[2]&&(a[2]=r[2]),t--,n--}return e},u4=function(e,t,n){return n||e<=t||e/t%1!=0?1:e/t},s4=function(e){var t=e.map((function(e){return e.fromRange})),n=t[0].sheet(),r=(0,ye.Z)(t.map((function(e){return e.colInterval().toString()}))),a=t.map((function(e){return e.rowInterval()})).sort((function(e,t){return e[0]!==t[0]?e[0]-t[0]:t[1]-e[1]})),o=e.map((function(e){return Array.from(e.ignoredRows||[])})).sort((function(e,t){return e[0]-t[0]})),i=0;if(1===r.length)for(var u=0;u<a.length;u++){var s=a[u],l=a[1+u];if(i+=s[1],l&&s[0]+s[1]!==l[0]-o[u].length)return}if(i+o.flat().length===n.getRowCount()){var c=r[0].split(",").map(Number);return e.map((function(e){return e.fromRange=new Oi(0,c[0],n.getRowCount(),c[1],n),e}))}},l4=function(e,t){return"del"===t.method?function(e,t){var n=[],r=[],a=e.outlineGroupModel,o=t.type,i=t.target,u=t.count,s=[i,u],l="row"===o,c=eu(i,u,l),h=a.getInfluencedOutlines(c),f=eu(i-1,1,l),d=eu(i+u,1,l),v=a.getInfluencedOutlines(f).filter((function(e){return e.start+e.count===i})),g=a.getInfluencedOutlines(d).filter((function(e){return e.start===i+u}));return h.length||v.length&&g.length?(v.length&&g.length&&(0,ye.Z)(v.concat(g)).forEach((function(t){t.state===Fi.Fold&&r.push(e4(e.id(),eu(t.start,t.count,t.type===we.xj7.ROW),t.state))})),h.forEach((function(t){var a=t.start,o=t.count,i=t.state,u=Ki([a,o],s),c=eu(u[0],u[1],l);n.push(Q3(e.id(),c)),r.push(X3(e.id(),c,i))})),{newChangesets:n,oldChangesets:r}):{newChangesets:n,oldChangesets:r}}(e,t):function(e,t){var n=[],r=[],a=e.outlineGroupModel,o=t.type,i=t.source,u=t.target,s=t.count,l=i-u==0,c="row"===o,h=Xi(c?we.xj7.ROW:we.xj7.COL,[u,s]),f=eu(l?u:u-1,1,c),d=a.getInfluencedOutlines(f);return d.length?(d.forEach((function(t){var a=t.state;n.push(X3(e.id(),h,a)),r.push(Q3(e.id(),h))})),{newChangesets:n,oldChangesets:r}):{newChangesets:n,oldChangesets:r}}(e,t)},c4=function(e){function t(e,n){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).call(this,e,n))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"execute",value:function(){return this._command.isFirstExecution?this.doAction():this.redoAction()}},{key:"undo",value:function(){return this._applyChangsetWithEvent(this._command._oldChangesets)}},{key:"redoAction",value:function(){return!0===this.checkRangeValid(this._sheet.parent,this._command._changesets)&&this._applyChangsetWithEvent(this._command._changesets)}},{key:"doAction",value:function(){return!!this._saveChangeSets()&&this._applyChangsetWithEvent(this._command._changesets,!0)}},{key:"_saveChangeSets",value:function(){var e=this._sheet,t=this.command,n=t.target,r=t.state,a=e.outlineGroupModel;if(n.type!==we.xj7.ROW&&n.type!==we.xj7.COL)return!1;var o=e.inject(Ft.tb).resolve("outlineGroupMaxCount",we.VVE);if(a.rowOutlineTree.length+a.colOutlineTree.length>=o)return we.Ps3.Toast.show({type:"error",content:fn("LarkCCM_Sheets_Group_NewFailed_Toast",{num:o}),duration:2e3}),!1;var i=a.getInfluencedOutlines(n).sort((function(e,t){return e.level-t.level})),u=i.length,s=Qi(n);if(0!==u&&i[u-1].level===bi.Seven&&$i([i[u-1].start,i[u-1].count],s)!==Mi.Empty&&$i([i[u-1].start,i[u-1].count],s)!==Mi.EmptyButPoint)return we.Ps3.Toast.show({type:"error",content:fn("LarkCCM_Sheets_Group_ReachMaxLevels_Toast",{num:7}),duration:2e3}),!1;var l=X3(e.id(),n,r),c=Q3(e.id(),n);return this._command._changesets.push(l),this._command._oldChangesets.push(c),!0}},{key:"commandName",get:function(){return we.rvF.ADD_OUTLINE}}]),t}(j3),h4=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"execute",value:function(){return this._command.isFirstExecution?this._doAction():this._redoAction()}},{key:"_setCellValue",value:function(e,t,n,r,a,o,i,u,s){if(void 0===n&&void 0===o&&void 0===r&&void 0===i&&void 0===u)return!1;var l=this._sheet;if(!this.checkCellValid(l,e,t,!0))return!1;var c=null===o,h=o&&!o.dropdown;(c||h)&&n&&!n.hasOwnProperty(ag)&&(u=l.getDataValidation(e,t)),null===u&&void 0===o&&(o=this._sheet.getStyleWithDropdown(e,t));var f=this.saveOldState(e,t,n,o,i,u),d=this.saveNewState(e,t,n,r,a,o,i,u);return this._command.dontExtendFilter||s&&this.saveExtendFilterRangeChangesets(e,t,f,d),!0}},{key:"saveOldState",value:function(e,t,n,r,a,o){var i=this._sheet,u={};if(void 0!==n){u.value=i.getChangesetValue(e,t);var s=i.getMultipleValues(e,t);s&&(u.multipleValues=s.toJSON())}if(void 0!==r){var l=i.getStyleWithDropdown(e,t);u.style=l&&l.toJSON()||null}return void 0!==a&&(u.reminder=i.getReminderChangeset(e,t)),i.getVar(e,t).isFormula()&&(u.formula=i.getFormula(e,t),u.formulaData=i.getFormulaData(e,t)),void 0!==o&&(u.dataValidation=i.getDataValidationJSON(e,t,{needDeepClone:!0})),this._cellValueToChangeset(e,t,u,!0),u}},{key:"saveNewState",value:function(e,t,n,r,a,o,i,u,s){var l={};return this.setStyle(l,o),this.setValue(l,e,t,n,r,a,i),void 0!==u&&(l.dataValidation=(null==u?void 0:u.toJSON({needDeepClone:!1}))||null),this.setMultipleValue(l,o,s),this._cellValueToChangeset(e,t,l,!1),l}},{key:"setStyle",value:function(e,t){if(t){var n=t.toJSON();e.style=n||null}}},{key:"setValue",value:function(e,t,n,r,a,o,i){var u,s=this._sheet;if(!a)return void 0!==r&&(e.value=r),void(void 0!==i&&(e.reminder=(null==i?void 0:i.toChangeset())||null));e.formula=a;var l=wf(u=o||Pg(s,t,n,a),{ref:u.getRef()});if(th(u)){var c=s.getParent(),h=c.importRangeManager,f=c.importRangeManagerV3;if(f.V3Enable)f.compileImportRange(u,!0,!0);else{var d=u.getExternalDataReferenceInfo();if(d){var v=h.generateAndCacheId(u,{sheetID:s.id(),url:d.url,range:d.range});if(v){var g=v.spreadToken,m=v.ref,p=v.isSyncStyle,y=v.importRangeId,C=v.spreadSource;l.externalDataReference={spreadToken:g,ref:m,isSyncStyle:p,importRangeId:y,spreadSource:C}}}}}e.formulaData=l,e.value=null,e.reminder=null}},{key:"setMultipleValue",value:function(e,t,n){if(void 0!==n)if(n){if(e.formulaData)return void(e.value=null);e.multipleValues=n.toJSON();var r=(null==t?void 0:t.formatter)||null,a=n.mergeToSingleValue({formatter:r});a.segmentArray?e.value=a.segmentArray:a.variant?e.value=a.variant.getValue():e.value=null}else e.multipleValues=null}},{key:"saveExtendFilterRangeChangesets",value:function(e,t,n,r){if(function(e){var t=e.value,n=e.formula,r=e.multipleValues;return null!=t&&""!==t||null!=n&&""!==n||null!=r&&r.length>0}(r)){var a=this._sheet,o=this.command._changesets,i=this.command._oldChangesets,u=[a.getSpan(e,t)||new Oi(e,t,1,1,a)],s=Kh(a,u),l=s.actions,c=s.oldActions;o.push.apply(o,(0,m.Z)(l)),i.push.apply(i,(0,m.Z)(c))}}},{key:"commandName",get:function(){return"setCell"}}]),t}(j3),f4=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"undo",value:function(){var e=!1,t=this._command._oldChangesets;if(!this.checkCellValidBeforeUndoRedo(t))return!1;this._beforeAction(this._sheet,!0);try{e=this._applyChangsetWithEvent(t,!0)}finally{this._afterAction(this._sheet,!0)}return e}},{key:"_redoAction",value:function(){var e=!1,t=this._sheet,n=this._command._changesets;if(!this.checkCellValidBeforeUndoRedo(n))return!1;this._beforeAction(t,!0);try{e=this._applyChangsetWithEvent(n,!0)}finally{this._afterAction(t,!0)}return e}},{key:"checkCellValidBeforeUndoRedo",value:function(e){var t=this._sheet;if(!this.checkRangeValid(t.parent,e))return!1;for(var n=e.length-1;n>=0;n--)if("setCell"===e[n].action){var r=e[n].target;K1(t,r.row,r.col)&&e.splice(n,1)}return e.length>0}}]),t}(h4),d4=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"_doAction",value:function(){var e=!1,t=this._sheet;this._beforeAction(t,!0);try{if(!this.generateActions())return!1;e=!!this.checkRangeValid(t.getParent(),this._command._changesets)&&this._applyChangsetWithEvent(this._command._changesets,!0)}finally{this._afterAction(t,!0)}return e}},{key:"generateActions",value:function(){var e=this,t=this._sheet,n=this._command,r=n.selections,a=n.data,o=!0;if(q1(r,(function(n,r){e.checkCellValid(t,n,r)||(o=!1)})),!o)return!1;var i=N1(t,Tt()(a.expireTime).format("YYYY/MM/DD HH:mm:ss")),u=i.value,s=i.formatter;if("number"!=typeof u||!(0,Se.isDateTimeFormatter)(s))return!1;var l=new Set;function c(e,n){var r="".concat(e,"_").concat(n);if(l.has(r))return null;if(l.add(r),K1(t,e,n)||t.getReminder(e,n))return null;var o=u,i=t.getValue(e,n),s=t.getCellFormatter(e,n);hr(i)&&s&&(0,Se.isDateTimeFormatter)(s)&&(o=i);var c=new by((0,At.v4)());if(c.fromChangeset(a),o!==u){var h=wy(o);c.setExpireTime(h),fr(h,s)||c.setNotifyStrategy(6)}return{newCellValue:o,reminder:c}}var h={ignoreStyle:!0,ignoreDataValidation:!0},f=Object.assign({cellValue:{value:null,reminder:null}},h);return r.forEach((function(n){var r=JQ(t.id(),n.toJSON()),a=JQ(t.id(),n.toJSON());q1(n,(function(e,n){var o=c(e,n);if(null!==o){var i=o.newCellValue,u=o.reminder;f.cellValue.value=i,f.cellValue.reminder=u.toChangeset(),zQ(e,n,t,r,f),zQ(e,n,t,a,h)}})),GQ(r),GQ(a),e._setRangeValuesActionToChangeset(r),e._setRangeValuesActionToChangeset(a,!0)})),this.saveExtendFilterRange(),!0}},{key:"saveExtendFilterRange",value:function(){var e=this._sheet,t=this._command,n=t.selections,r=t._changesets,a=t._oldChangesets,o=Kh(e,n),i=o.actions,u=o.oldActions;(0,we.hTd)(r,i),(0,we.hTd)(a,u)}},{key:"commandName",get:function(){return we.rvF.ADD_REMINDER}}]),t}(f4),v4=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"execute",value:function(){return this._command.isFirstExecution?this._doAction():this._redoAction()}},{key:"_addRows",value:function(e,t,n,r,a){return this._command._changesets.push(this._addRowsAction(t,n)),(void 0===a||a)&&this.copyRowStyleActionsWithSetRange(e,t,n),this.copyRowHeightActions(t,n,r),[this._delRowsAction(t,n)]}},{key:"copyRowStyleActionsWithSetRange",value:function(e,t,n){var r=!(arguments.length>3&&void 0!==arguments[3])||arguments[3];return this._copyPropertyActionsWithSetRange(e,t,n,!1,{style:!0,dataValidation:!0},r)}},{key:"_copyPropertyActionsWithSetRange",value:function(e,t,n){var r,a,o=!(arguments.length>3&&void 0!==arguments[3])||arguments[3],i=arguments.length>4&&void 0!==arguments[4]?arguments[4]:{style:!0,dataValidation:!1},u=i.style,s=i.dataValidation,l=!(arguments.length>5&&void 0!==arguments[5])||arguments[5],c=this._sheet,h={ignoreValue:!0,ignoreFormulaData:!0,ignoreDataValidation:!1,ignoreReminder:!0,ignoreMultipleValues:!0,ignorePivotTable:!0,ignoreStyle:!1,ignoreFilterRow:!0},f=new Wi(!0,"add",t,n,this._sheet),d=o?{row:0,col:t,rowCount:c.getRowCount(),colCount:n}:{row:t,col:0,rowCount:n,colCount:c.getColumnCount()},v=JQ(c.id(),d),g=d.row+d.rowCount-1,m=d.col+d.colCount-1,p=d.row,y=d.col;o||(g=(r=[m,g])[0],m=r[1],p=(a=[y,p])[0],y=a[1]);for(var C=!1,_=p;_<=g;_++){var R=o?_:e,w=o?e:_,k=void 0,S=void 0,E=void 0,T=!0;if(u){var A=c.getCellStyle(R,w,void 0,!0);A&&(S=v.styleRefMgr.getStyleId(A))}if(s){var I=c.getDataValidation(R,w);if(I){var b=I.clone();b.initFormulaForCheckCell({preventRegisterFml:!0}),b.onOp(f),E=v.dvJSONRefMgr.getValidationId(b),"checkbox"===b.type&&(k={value:0},T=!1)}}if(h.styleId=S,h.ignoreStyle=void 0===S,h.dataValidationId=E,h.ignoreDataValidation=void 0===E,h.cellValue=k,h.ignoreValue=T,!(T&&h.ignoreDataValidation&&h.ignoreStyle)){C=!0;for(var F=y;F<=m;F++)zQ(o?_:F,o?F:_,c,v,h)}}return GQ(v),l&&C&&this._setRangeValuesActionToChangeset(v),v}},{key:"copyColStyleActionsWithSetRange",value:function(e,t,n){var r=!(arguments.length>3&&void 0!==arguments[3])||arguments[3];return this._copyPropertyActionsWithSetRange(e,t,n,!0,{style:!0,dataValidation:!1},r)}},{key:"_addCols",value:function(e,t,n,r,a){return this._command._changesets.push(this._addColsAction(t,n)),(void 0===a||a)&&this.copyColStyleActionsWithSetRange(e,t,n),this.copyColumnWidthActions(t,n,r),[this._delColsAction(t,n)]}},{key:"copyRowHeightActions",value:function(e,t,n){n&&this._command._changesets.push(this._rowHeightAction(e,n,void 0,t))}},{key:"copyColumnWidthActions",value:function(e,t,n){n&&this._command._changesets.push(this._colWidthAction(e,n,void 0,t))}},{key:"commandName",get:function(){return we.rvF.SET_ROW_COL_CHANGE}}]),t}(j3),g4=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"execute",value:function(){var e=!1,t=this._sheet;this._beforeAction(t,!0);try{e=this._command.isFirstExecution?this._doAction():this._redoAction()}catch(e){return this._afterAction(t,!0),we.Ps3.moirae.ravenCatch(e),!1}return this._afterAction(t,!0),e}},{key:"undo",value:function(){return this._applyChangsetWithEvent(this._command._oldChangesets,!0)}},{key:"_doAction",value:function(){return!!this.generateActions()&&(this.tryApplyActions(this._sheet.parent,this._command._changesets,!0),!0)}},{key:"generateActions",value:function(){var e=this._sheet,t=this.command,n=t.addRowCount,r=t.addColCount,a=e.getRowCount()-1,o=e.getColumnCount()-1,i=[];n>0&&(i=this._addRows(a,a+1,n,void 0,this._command.isCopyStyle)),r>0&&(i=[].concat((0,m.Z)(this._addCols(o,o+1,r,void 0,this._command.isCopyStyle)),(0,m.Z)(i)));var u=this._sheet.getRowCount()-1,s=this._sheet.getColumnCount()-1;if(this._command.addRowCount>0&&this._command.addColCount>0){var l=this._colStyleAction(u,s);if(null!=l){var c=this._setRangeAction(new Oi(u+1,o+1,this._command.addRowCount,r,this._sheet),l.value,!0);this._command._changesets.push(c)}}return!!this.checkRangeValid(e.parent,this._command._changesets,!0)&&(this._command._oldChangesets=i,!0)}},{key:"_redoAction",value:function(){return!0===this.checkRangeValid(this._sheet.parent,this._command._changesets)&&this._applyChangsetWithEvent(this._command._changesets,!0)}},{key:"commandName",get:function(){return"addRowAndCol"}}]),t}(v4),m4=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"execute",value:function(e){return!(this._command.isFirstExecution&&!this.generateActions(e))&&this._doAction(e)}},{key:"undo",value:function(e){var t=this._command._changesets,n=e.getSheetFromId(this._command.sheetId);if(!n)return this._command._oldChangesets=[],!1;if(t.length>0){var r=Object.assign({},t[0]);r.value=Object.assign({},r.value);var a=i2(t2(n.toJSON()));r.value.snapshot=a,this._command._changesets=[r]}return this._applySpreadChangsetWithEvent(e,this._command._oldChangesets,!0)}},{key:"generateActions",value:function(e){var t=e.getSheetIds();this._command.sheetId=(0,we.lYS)(t),void 0===this._command.index&&(this._command.index=e.sheets.length),this._command.sheetName&&!this._isConflict(e,this._command.sheetName)||(this._command.sheetName=e._getDefaultSheetName(e.sheets.length));var n=this._command,r=n.sheetId,a=n.sheetName,o=n.index;return this._command._oldChangesets=[{action:"delSheet",sheet_id:r,value:{sheet_name:a,index:o}}],this._command._changesets=[{action:"copySheet",sheet_id:r,value:{sheet_id:r,sheet_name:a,index:o}}],!0===this.checkRangeValid(e,this._command._changesets)}},{key:"_isConflict",value:function(e,t){for(var n=e.sheets,r=0;r<n.length;r++)if(n[r].name()===t)return!0;return!1}},{key:"_doAction",value:function(e){var t=this._applySpreadChangsetWithEvent(e,this._command._changesets,!0);return t&&e.setActiveSheetIndex(this._command.index,!0),t}},{key:"canUndo",value:function(){return!0===this.checkRangeValid(this._sheet.parent,this._command._oldChangesets)}},{key:"commandName",get:function(){return we.rvF.ADD_SHEET}}]),t}(j3),p4=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"execute",value:function(){return!(this._command.isFirstExecution&&!this._saveChangesets())&&!0===this.checkRangeValid(this._sheet.parent,this._command._changesets)&&this._applyChangsetWithEvent(this._command._changesets,!0)}},{key:"_saveChangesets",value:function(){var e=this,t=this._command.value,n=t.viewId,r=t.range,a=t.filterItemList,o=t.viewName,i=(0,we.US_)(n),u=o||this._sheet.viewsModel.assignViewName(i),s=r?gh(r):void 0,l=this._sheet.viewsModel.activeView;return this._command._oldChangesets=[(0,we.h_E)(this._sheetId,{view_id:n,name:u}),l?(0,we.fdi)(this._sheetId,l.getId()):(0,we.YY8)(this._sheetId)],this._command._changesets=[(0,we.VCn)(this._sheetId,{view_id:n,name:u,empty:!r||void 0})],a&&a.forEach((function(t){e._command._changesets.push((0,we.eRv)(e._sheetId,{filter_value:t,range:s,view_id:n}))})),this._command._changesets.push((0,we.eRv)(this._sheetId,{view_id:n,range:s,calculate:!0})),this._command._changesets.push((0,we.fdi)(this._sheetId,n)),!0}},{key:"undo",value:function(){return this._applyChangsetWithEvent(this._command._oldChangesets,!0)}},{key:"commandName",get:function(){return we.rvF.ADD_VIEW}}]),t}(j3),y4=function(e){function t(){var e;return(0,y.Z)(this,t),(e=(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))).styleFormatter2StyleId=new Map,e}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"execute",value:function(){return this._command.isFirstExecution?this._doAction():this._redoAction()}},{key:"undo",value:function(){return this._applyChangsetWithEvent(this._command._oldChangesets,!0)}},{key:"_doAction",value:function(){return this._saveChangeSets(),!!this.checkRangeValid(this._sheet.parent,this._command._changesets)&&this._applyChangsetWithEvent(this._command._changesets,!0)}},{key:"_redoAction",value:function(){return!0===this.checkRangeValid(this._sheet.parent,this._command._changesets)&&this._applyChangsetWithEvent(this._command._changesets,!0)}},{key:"getSpanChangeSet",value:function(e){var t=this._sheetId,n=[],r=[];if(e&&e.length>0){var a=this.applySpans(e,t);n=a.oldSpanChangeSet,r=a.newSpanChangeSet}return{oldSpanChangeSet:n,newSpanChangeSet:r}}},{key:"addColumnCount",value:function(){var e=this._command.addColCount,t=this._sheet,n=[],r=[];if(e>0){var a=t.getColumnCount();n.push(this._addColsAction(a,e));for(var o=0;o<e;o++)n.push(this._colWidthAction(a+o,t.defaults.colWidth));var i=this.copyLastColumnStyleForAddCols();n.push(i),r.push(this._delColsAction(a,e))}return{newColumnActions:n,oldColumnActions:r}}},{key:"copyLastColumnStyleForAddCols",value:function(){var e=this._command.addColCount,t=this._sheet.getColumnCount()-1;return this.copyColStyleActionsWithSetRange(t,t+1,e,!1)}},{key:"_saveChangeSets",value:function(){var e=this._command,t=e.startRow,n=e.startCol,r=e.rowCount,a=e.colCount,o=e.spans,i=e.splitData,u=e.format,s=e.extendFilterTargetRange,l=e.realColCount;if(0===a)return this.command._changesets=[],void(this.command._oldChangesets=[]);for(var c=this._sheetId,h=this._sheet,f=h.getColumnCount()-1,d=[],v=this.getSpanChangeSet(o),g=v.oldSpanChangeSet,m=v.newSpanChangeSet,p=this.addColumnCount(),y=p.newColumnActions,C=p.oldColumnActions,_=Kh(h,[s]),R=_.actions,w=_.oldActions,k=h.formatterService,S={row:t,col:n,rowCount:r,colCount:a},E=JQ(c,S),T=jQ(h,S,{},WQ),A={ignoreDataValidation:!0,styleId:void 0,ignoreStyle:void 0,cellValue:void 0},I=l,b=r,F=0,M=n,V=0;F<I;F++){var N=u[M-n+V];if(N&&"hide"===N)V++;else{for(var O=!N,x=(0,Se.createFormatter)(k,N),Z=Math.min(f,M),D=0,P=t;D<b;D++,P++){A.styleId=void 0,A.ignoreStyle=!0;var L=i[D][F],B={value:L,multipleValues:null,reminder:null},U=h.getCellStyle(P,Z),H=L;if(L&&"string"==typeof L){var W=(0,Se.getPreferredFormatter)(k,L,null!=U&&U.formatter?U.formatter:x),j=W.value,z=W.formatter;H=j instanceof ke.SheetDate?j.toNumber():j,O&&(null==U?void 0:U.formatter)||(null==U?void 0:U.formatter)===z||(A.ignoreStyle=!1,A.styleId=this.getAndSaveStyleId(U,z,E))}B.value=H,A.cellValue=B,zQ(P,M,h,E,A)}M++}}GQ(E),d.push(E),this._command._changesets=[].concat(y,m,d,R),this._command._oldChangesets=[].concat(T,g,C,w)}},{key:"getAndSaveStyleId",value:function(e,t,n){var r=this.styleFormatter2StyleId,a=r.get(e);a||(a=new Map,r.set(e,a));var o=a.get(t);if(void 0===o){var i=Ad.withFormatter(e||this._sheet.getDefaultStyle(),t);o=n.styleRefMgr.getStyleId(i),a.set(t,o)}return o}},{key:"applySpans",value:function(e,t){var n,r=[],a=[],o=_n(e);try{for(o.s();!(n=o.n()).done;){var i=n.value.toSimpleObj(),u=i.row,s=i.col,l=i.rowCount,c=i.colCount;a.push({action:"setSpans",sheet_id:t,target:{row:u,col:s,row_count:l,col_count:c},value:[]}),r.push({action:"setSpans",sheet_id:t,target:{row:u,col:s,row_count:l,col_count:c},value:[{target:{row:u,col:s,row_count:l,col_count:c}}]})}}catch(e){o.e(e)}finally{o.f()}return{oldSpanChangeSet:r,newSpanChangeSet:a}}},{key:"commandName",get:function(){return we.rvF.DATA_SPLIT}}]),t}(v4),C4=function(e){function t(e,n){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).call(this,e,n))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"canExecute",value:function(){var e=this._command;return this._sheet&&e.columns&&e.size&&e.columns.length===e.size.length}},{key:"_doAction",value:function(){var e=!1;if(!this.canExecute())return e;var t=this._sheet,n=this._command,r=n.isLocal,a=void 0!==r&&r;n._canUndo=!0;var o=t.getColumnCount();this._beforeAction(t);try{for(var i=0,u=n.columns.length;i<u;i++){var s=n.columns[i];if(s>=0&&s<o){var l=t._getActualColumnWidth(s),c=n.size[i];c!==l&&(this._columnWidthToChangeset(s,l,!0,a),this._columnWidthToChangeset(s,c,!1,a))}}if(!this.checkRangeValid(t.parent,this._command._changesets))return!1;e=this._applyChangsetWithEvent(this._command._changesets,!0)}finally{this._afterAction(t,!1)}return e}},{key:"_redoAction",value:function(){return!!this.checkRangeValid(this._sheet.parent,this._command._changesets)&&this._applyChangsetWithEvent(this._command._changesets,!0)}},{key:"execute",value:function(){return this._command.isFirstExecution?this._doAction():this._redoAction()}},{key:"undo",value:function(){return this._applyChangsetWithEvent(this._command._oldChangesets,!0)}},{key:"canUndo",value:function(){return(0,f.Z)((0,v.Z)(t.prototype),"canUndo",this).call(this)&&this._command._canUndo}},{key:"commandName",get:function(){return we.rvF.AUTO_FIT_COLUMN}}]),t}(j3),_4=function(e){function t(e,n){var r;return(0,y.Z)(this,t),r=(0,d.Z)(this,(0,v.Z)(t).call(this,e,n)),n._oldSizes=n._oldSizes||[],r}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"canExecute",value:function(){var e=this._command;return this._sheet&&e.rows&&e.rows.length>0}},{key:"_doAction",value:function(){var e=this,t=!1;if(!this.canExecute())return t;var n=this._sheet,r=this._command,a=r.isLocal;r._canUndo=!0,this._beforeAction(n);try{if(this.convertToRanges(r.rows).forEach((function(t){e.batchSetRowHeight(t,0,!!a)})),!this.checkRangeValid(n.parent,this._command._changesets))return!1;t=this._applyChangsetWithEvent(this._command._changesets,!0)}finally{this._afterAction(n)}return t}},{key:"_redoAction",value:function(){return!!this.checkRangeValid(this._sheet.parent,this._command._changesets)&&this._applyChangsetWithEvent(this._command._changesets,!0)}},{key:"execute",value:function(){return this._command.isFirstExecution?this._doAction():this._redoAction()}},{key:"undo",value:function(){return this._applyChangsetWithEvent(this._command._oldChangesets,!0)}},{key:"canUndo",value:function(){return(0,f.Z)((0,v.Z)(t.prototype),"canUndo",this).call(this,this._sheet.parent)&&this._command._canUndo}},{key:"batchSetRowHeight",value:function(e,t,n){this.batchUndoChangeset(e,n),this.batchRowHeightToChangeset(e,t,!1,n)}},{key:"batchUndoChangeset",value:function(e,t){for(var n,r=this._sheet,a=r.getRowCount(),o=e.target,i=e.count,u=0,s=o,l=o;l<o+i;l++)if(0<=l&&l<a){var c=r._getActualRowHeight(l);void 0===n&&(n=c),c===n?u++:(this.batchRowHeightToChangeset({target:s,count:u},n,!0,t),s=l,u=1,n=c)}u>0&&this.batchRowHeightToChangeset({target:s,count:u},n,!0,t)}},{key:"convertToRanges",value:function(e){for(var t=[],n=0;n<e.length;){for(var r=1,a=n+1;a<e.length&&e[a]===e[a-1]+1;)r++,a++;t.push({target:e[n],count:r}),n=a}return t}},{key:"commandName",get:function(){return we.rvF.AUTO_FIT_ROW}}]),t}(j3),R4=function(e){function t(e,n,r){var a;return(0,y.Z)(this,t),(a=(0,d.Z)(this,(0,v.Z)(t).call(this,e,n))).formulaCountBeforeExecute=0,a}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"execute",value:function(){return this._command.isFirstExecution?this._doAction():this._redoAction()}},{key:"clearDataValidation",value:function(e,t,n,r){var a=this;this._sheet._getModel().iterDataValidationWithPos(e,t,n,r).forEach((function(e){var t=(0,p.Z)(e,2),n=t[0],r=t[1],o=r.row,i=r.col;n.shouldDelWhileClearValue&&(a._cellValueToChangeset(o,i,{dataValidation:n.toJSON({needDeepClone:!0})},!0),a._cellValueToChangeset(o,i,{dataValidation:null},!1))}))}},{key:"_clearRangeValues",value:function(){var e=this,t=this._sheet,n=this._command.ranges;this.filterDuplicateRange(n,!0).forEach((function(n){e._setRangeToChangeset(n,{value:null,multipleValues:null,formula:null,reminder:null});var r=n.rowFrom(),a=n.rowCount(),o=n.colFrom(),i=n.colCount();e.clearDataValidation(r,o,a,i),e._setRangeValuesActionToChangeset(jQ(t,{row:r,col:o,rowCount:a,colCount:i},{ignoreStyle:!0,ignoreDataValidation:!0}),!0)}))}},{key:"_doAction",value:function(){if(!this.generateActions())return!1;var e=this._applyChangsetWithEvent(this._command._changesets,!0);return this._sheet.dispatch("CellRemoved",{ranges:this._command.ranges,sheetId:this._sheet.id()}),e}},{key:"generateActions",value:function(){var e=this._sheet.getParent();return this._clearRangeValues(),!0===this.checkRangeValid(e,this._command._changesets)}},{key:"_redoAction",value:function(){return!0===this.checkRangeValid(this._sheet.parent,this._command._changesets)&&this._applyChangsetWithEvent(this._command._changesets,!0,"redo")}},{key:"undo",value:function(){return this._applyChangsetWithEvent(this._command._oldChangesets,!0,"undo")}},{key:"getPerformanceInfo",value:function(){return{formulaCountBeforeExecute:this.formulaCountBeforeExecute}}},{key:"commandName",get:function(){return we.rvF.CLEAR_VALUES}}]),t}(h4),w4=function(e){function t(e,n,r){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).call(this,e,n))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"execute",value:function(){return this._command.isFirstExecution?this._doAction():this._redoAction()}},{key:"_conditionalFormatToChangeset",value:function(e){var t=iX(this._sheet,e);t&&t.actions&&t.oldActions&&((0,we.hTd)(this._command._changesets,t.actions),(0,we.hTd)(this._command._oldChangesets,t.oldActions))}},{key:"_sparklineToChangeset",value:function(e){var t,n=new Map,r=this._sheet,a=r.getSparklineModel(),o=_n(e);try{for(o.s();!(t=o.n()).done;){var i=t.value.toJSON(),u=i.row,s=i.col,l=i.rowCount,c=i.colCount;a.iterWithPos(u,s,l,c).forEach((function(e){var t=(0,p.Z)(e,1)[0],r=t.getGroupId(),a=n.get(r)||[];a.push(t.getId()),n.set(r,a)}))}}catch(e){o.e(e)}finally{o.f()}var h,f=r.id(),d=!0,v=!0,g=!0,m=!0,y={action:"updateSparklineGroup",sheet_id:f,value:{}},C={action:"delSparklineGroup",sheet_id:f,value:[]},_={action:"updateSparklineGroup",sheet_id:f,value:{}},R={action:"addSparklineGroup",sheet_id:f,value:{}},w=_n(n);try{for(w.s();!(h=w.n()).done;){var k=(0,p.Z)(h.value,2),S=k[0],E=k[1];E.length===a.getSparklinesByGroupId(S).length?(v=!1,C.value.push(S),m=!1,R.value[S]={sparklines:E.reduce((function(e,t){var n=a.getSparklineById(t);return e[t]={source:n.getSource(),position:n.getPosition()},e}),{})}):(d=!1,y.value[S]={sparklines:E.reduce((function(e,t){return e[t]=null,e}),{})},g=!1,_.value[S]={sparklines:E.reduce((function(e,t){var n=a.getSparklineById(t);return e[t]={source:n.getSource(),position:n.getPosition()},e}),{})})}}catch(e){w.e(e)}finally{w.f()}d||this._command._changesets.push(y),v||this._command._changesets.push(C),g||this._command._oldChangesets.push(_),m||this._command._oldChangesets.push(R)}},{key:"_clearRangeStyleAndValue",value:function(){var e=this,t=this._sheet;if(!hX(t,this._command.ranges,void 0,!0))return!1;for(var n=this._command.ranges,r=new Set,a=function(a){var o=n[a],i=t.getSpans(o);i.length>0&&(e._spanToChangeset(o,i,!0),e._spanToChangeset(o,null));var u={style:null,formula:null,value:null,multipleValues:null,reminder:null,dataValidation:null,note:null},s=e.splitSelectionByFilterRow(o),l=[];e.checkRangeDuplicate(s,r,l,n),l.forEach((function(t){e._setRangeToChangeset(t,u)}))},o=0;o<n.length;o++)a(o);return n.forEach((function(n){e._setRangeValuesActionToChangeset(jQ(t,n.toJSON(),{ignoreFilterRow:!0,needNote:!0},WQ),!0)})),this._conditionalFormatToChangeset(n),this._sparklineToChangeset(n),!0}},{key:"_doAction",value:function(){if(!this._clearRangeStyleAndValue())return!1;if(!0!==this.checkRangeValid(this._sheet.parent,this._command._changesets))return!1;var e=this._applyChangsetWithEvent(this._command._changesets,!0);return this._sheet.dispatch("CellRemoved",{ranges:this._command.ranges,sheetId:this._sheet.id()}),e}},{key:"_redoAction",value:function(){return!0===this.checkRangeValid(this._sheet.parent,this._command._changesets)&&this._applyChangsetWithEvent(this._command._changesets,!0)}},{key:"undo",value:function(){return this._applyChangsetWithEvent(this._command._oldChangesets,!0)}},{key:"commandName",get:function(){return we.rvF.CLEAR_VALUES_STYLE}}]),t}(j3);function k4(e){var t=window.BearWebSlardarWeb;t&&t("addBreadcrumb",{type:"console",message:e.message,category:"sheet-custom",data:Object.assign({},e.arguments,{logger:"console"})})}function S4(e,t){var n=e.cmd,r=e.isFirstExecution;return t?"undo"+n:"[command]: ".concat(r?"execute":"redo"," ").concat(n)}function E4(e){return{sheetId:e.sheetId}}function T4(e,t,n,r,a){var o=(0,we.D5c)(),i=e.getSheetFromId(n.sheetId);if(!i)return!1;if(i instanceof oq&&n.cmd!==we.rvF.SET_SHEET_PROPERTY)return!1;var u=new t(i,n,r),s=n.cmd;if(k4({message:S4(n,r),arguments:E4(n)}),e.dispatch("CommandExecuting",{sheet:i,commandName:s,isUndo:r}),!p2(e,u.command,r))return!1;var l=u&&u.command&&u.command.isFirstExecution;e.commandManager().setExecutingType(r?"undo":l?"do":"redo");var c=r?u.canUndo()&&u.undo(i.parent):u.execute(i.parent);e.commandManager().clearExecutingType(),c||(u.command._oldChangesets=[],u.command._changesets=[]);var h=r?u.command._oldChangesets:u.command._changesets;I4(e,n),b4(s,e,n,h),e.dispatch("CommandExecuted",{sheet:i,sheetName:i.name(),commandName:s,excutedResult:c,changesets:h,transId:a,isFirstExecution:l});var f=(0,we.egz)(o),d=(0,we.UFo)(r,l);return(0,we.RHc)({rangeTime:f,sheet:i,commandName:s,changesets:h,executeType:d},u.getPerformanceInfo()),i.notifyShell(86,s),c}function A4(e,t,n,r,a){var o=(0,we.D5c)(),i=e.getSheetFromId(n.sheetId),u=i?i.name():void 0,s=new t(i,n,r),l=n.cmd;if(k4({message:S4(n,r),arguments:E4(n)}),e.dispatch("CommandExecuting",{sheet:i,sheetName:u,commandName:l,isUndo:r}),!p2(e,s.command,r))return!1;var c=r?s.canUndo(e)&&s.undo(e):s.execute(e);c||(s.command._oldChangesets=[],s.command._changesets=[]);var h=r?s.command._oldChangesets:s.command._changesets;I4(e,n),b4(l,e,n,h),e.dispatch("CommandExecuted",{sheet:i,sheetName:u,commandName:l,excutedResult:c,changesets:h,transId:a});var f=(0,we.egz)(o),d=s&&s.command&&s.command.isFirstExecution,v=(0,we.UFo)(r,d);return(0,we.RHc)({rangeTime:f,sheet:i,commandName:l,changesets:h,executeType:v},s.getPerformanceInfo()),i&&i.notifyShell(86,l),c}function I4(e,t){var n=t.sheetId?e.getSheetFromId(t.sheetId):null,r=e.getActiveSheet();!t.isFirstExecution&&n&&n!==r&&(n.getHiddenStatus()||e.setActiveSheet(n.name(),!0))}function b4(e,t,n,r,a){var o=n.sheetId,i=o?t.getSheetFromId(o):null;if(!n.isFirstExecution&&i){var u=null,s=[],l=["delRow","delCol","setRowHeight","setColumnWidth","setChart","setFloatImage","setFloatBlock","setDataRange"];switch(s.push((function(e){return!l.includes(e.action)})),e){case"clipboardPaste":case"formatPainter":case"addRowAndCol":l.push("addRow","addCol");break;case"dragDropRowCol":case"removeDuplication":case"fill":case"horizontalFill":case"verticalFill":case"fillRange":case"moveRowCol":case"addOutline":case"delOutline":case"updateOutline":return;case"moveRange":for(var c,h=r.length-1;h>=0;h--)if("setSpans"===r[h].action){c=h;break}s.push((function(e,t){return t===c}));break;case"replace":if("currentRanges"===n.scope)return}for(var f=0;f<r.length;f++){for(var d=r[f],v=!0,g=0;g<s.length;g++)if(!(0,s[g])(d,f)){v=!1;break}if(!0===v){var m=d.target;m&&(u=Kd(u,Xd(m)))}}if(u){var p=u,y=p.row,C=p.col,_=u,R=_.row_end,w=_.col_end;R=-1===R?i.getRowCount()-1:R,w=-1===w?i.getColumnCount()-1:w;var k=(R=$d(R,i.getRowCount()-1))-y+1,S=(w=$d(w,i.getColumnCount()-1))-C+1;S>0&&k>0&&(i.clearSelection(),i.setSelection(new Oi(y,C,k,S,i)))}}}!function(e){e[e.EmbedToFloat=0]="EmbedToFloat",e[e.FloatToEmbed=1]="FloatToEmbed"}(n4||(n4={}));var F4=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"execute",value:function(){return!(this.command.isFirstExecution&&!this.produceChangesets())&&this._applyChangsetWithEvent(this.command._changesets,!0)}},{key:"undo",value:function(){return this._applyChangsetWithEvent(this.command._oldChangesets,!0)}},{key:"produceChangesets",value:function(){var e=this.command.commandType;return![0,1].every((function(t){return t!==e}))&&({0:this.createEmbedToFloatActions,1:this.createFloatToEmbedActions}[e].bind(this)(),!0)}},{key:"createEmbedToFloatActions",value:function(){var e=this;this.command.data.forEach((function(t){var n=t.row,r=t.col,a=t.seg,o=t.isFormulaImage,i=a.width,u=a.height,s=a.link,l=a.fileToken;if(!s||l){var c=l,h=e._sheet.getCellHeight(n,r,!1),f=e.createFloatImageBlock({row:n,col:r,width:i||100,height:u||100,imageToken:c}),d=e.getCellValueAction(n,r).oldStyle;e.command._oldChangesets.push(o?e.getSetCellAction(e._sheet,n,r):e.getSetEmbedImageAction(n,r,a,d),e.getDelFloatImageAction(f.floatImageId)),e.command._changesets.push(e.getEmptyCellAction(n,r),e.getSetRowHeightAction(n,h),e.getSetFloatImageAction(n,r,f))}}))}},{key:"createFloatToEmbedActions",value:function(){var e=this,t=this.command.data,n=this._sheet.getFloatImageMap();t.forEach((function(t){var r,a,o=n[t],i=o.floatImageSetting,u=i.height,s=i.width,l=i.imageToken,c=o.floatImageSetting,h=c.row,f=c.col,d=e._sheet.getSpan(h,f);h=null!==(r=null==d?void 0:d.rowFrom())&&void 0!==r?r:h,f=null!==(a=null==d?void 0:d.colFrom())&&void 0!==a?a:f,delete o.floatImageSetting.zIndex;var v=e.getCellValueAction(h,f),g=v.oldValue,m=v.oldStyle;e._cellStyleAndValueToCS(h,f,g,m,!0),e.command._oldChangesets.push(e.getSetFloatImageAction(h,f,o)),e.command._changesets.push(e.getDelFloatImageAction(t),e.getSetEmbedImageAction(h,f,{height:u,width:s,text:"",link:we.Ps3.imageHelper.getDriveImageUrl(l,e._sheet.parent._context.getToken()),type:we.K6s.EMBED_IMAGE,fileToken:l},m))}))}},{key:"createFloatImageBlock",value:function(e){var t=e.row,n=e.col,r=e.width,a=e.height,o=e.imageToken,i=this._sheet.getCellWidth(t,n,!0),u=this._sheet.getCellHeight(t,n,!0),s=i,l=u;i/r*a>u?(l=u,s=u/a*r):(l=i/r*a,s=i),(0,k.Z)([l,s])<22&&(l<s?s=(l=22)*(r/a):l=(s=22)*(a/r));var c=gb.createDefault({sheet:this._sheet,imageToken:o,row:t,col:n,width:s,height:l});return delete c.sheetId,c}},{key:"getSetEmbedImageAction",value:function(e,t,n,r){return{action:"setCell",sheet_id:this._sheetId,target:{row:e,col:t},value:{formula:null,multipleValues:null,dataValidation:null,reminder:null,style:r.toJSON(),value:[n]}}}},{key:"getDelFloatImageAction",value:function(e){return{action:"delFloatImage",sheet_id:this._sheetId,value:{floatImageId:e}}}},{key:"getEmptyCellAction",value:function(e,t){return{action:"setRange",sheet_id:this._sheetId,value:{value:null,target:{row:e,col:t,rowCount:1,colCount:1,type:0}}}}},{key:"getCellValueAction",value:function(e,t){var n=this._sheet,r={},a=n.getMultipleValues(e,t),o=n.getStyleWithDropdown(e,t)||n.getDefaultStyle();return r.value=n.getSafeValue(e,t),r.formula=n.getFormula(e,t),r.reminder=n.getReminderChangeset(e,t),r.multipleValues=a?a.toJSON():null,r.dataValidation=n.getDataValidationJSON(e,t,{needDeepClone:!0}),{oldValue:r,oldStyle:o}}},{key:"getSetRowHeightAction",value:function(e,t){return{action:"setRowHeight",sheet_id:this._sheetId,target:{row:e,row_count:1},value:t}}},{key:"getSetFloatImageAction",value:function(e,t,n){return{action:"setFloatImage",sheet_id:this._sheetId,target:{row:e,col:t},value:n}}},{key:"commandName",get:function(){return we.rvF.CONVERT_IMAGE}}]),t}(j3),M4=function(e){function t(e,n,r){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).call(this,e,n))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"_doAction",value:function(){var e=this,t=this._sheet,n=this._command.data,r=!0;return n.forEach((function(n){var a=n.row,o=n.col;!0!==e.checkCellValid(t,a,o)&&(r=!1)})),r&&n.forEach((function(n){var a=n.row,o=n.col,i=n.newSegmentArray,u=t.getStyleWithDropdown(a,o);u=u?u.clone():t.getDefaultStyle().clone(),!0!==e._setCellValue(a,o,i,null,null,u)&&(r=!1)})),r&&this._applyChangsetWithEvent(this._command._changesets,!0)}},{key:"_redoAction",value:function(){return!0===this.checkRangeValid(this._sheet.parent,this._command._changesets)&&this._applyChangsetWithEvent(this._command._changesets,!0)}},{key:"undo",value:function(){return this._applyChangsetWithEvent(this._command._oldChangesets,!0)}},{key:"commandName",get:function(){return"convertLink"}}]),t}(h4),V4=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"execute",value:function(e){if(this._command.isFirstExecution){var t=e.getSheetFromId(this._command.copySheetId);if(!(e.blockManager&&t instanceof oq))return!1;if(!this._command.copyBlockData)return we.Ps3.moirae.teaLog({key:"client_sheet_block_data_undefined",command_name:we.rvF.COPY_BLOCK,value:""+this._command.copyBlockData}),!1;var n=e.getSheetIds(),r=(0,we.lYS)(n),a=Number(e.getSheetIndexFromId(this._command.copySheetId))+1,o=t.blockType,i=e.blockManager.createBlockId(),u=this._command.sheetName;u||(u=t.name()),null!==e.getSheetFromName(u)&&(u=this.getSheetNoConflictName(e,u,fn("sheet.copy_item"))),this._command._oldChangesets=[{action:"delBlock",sheet_id:r,value:{sheet_name:u,index:a,block_type:o,block_id:i,block_token:""}}],this._command._changesets=[{action:"addBlock",sheet_id:r,value:{sheet_id:r,sheet_name:u,index:a,block_type:o,block_id:i,block_token:"",block_data:this._command.copyBlockData}}]}var s=this._applySpreadChangsetWithEvent(e,this._command._changesets,!0);return s&&e.setActiveSheetIndex(this._command._changesets[0].value.index,!0),s}},{key:"undo",value:function(e){return G3(e,this._command,this._applySpreadChangsetWithEvent)}},{key:"canUndo",value:function(e){var t=this._command._changesets[0].sheet_id,n=e.getSheetFromId(t);return Boolean(n&&n.blockToken)}},{key:"commandName",get:function(){return we.rvF.COPY_BLOCK}}]),t}(j3),N4=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"execute",value:function(e){return!(this._command.isFirstExecution&&!this.generateActions(e))&&this._doAction(e)}},{key:"undo",value:function(e){var t=this._command._changesets,n=e.getSheetFromId(this._command.copySheetId);if(n&&t.length>0){var r=t[0],a=this._getSnapshot(n);r.value.snapshot=a}return this._changesetsToAction(e,this._command._oldChangesets,"undo"),!0}},{key:"generateActions",value:function(e){var t=e.getSheetFromId(this._command.sheetId);if(!t)throw new Error("sheet not found");var n=t.name(),r=e.getSheetIndex(n);if((0,w.Z)(r))throw new Error("sheetIndex is null");var a=e.getCopySheetId(),o=e.getSheetIds();return a&&!o.includes(a)||(a=(0,we.lYS)(o)),this._command.copySheetId=a,void 0===this._command.copySheetName&&(this._command.copySheetName=this._getDefaultCopySheetName(e,n)),this._command.copySheetIndex=r+1,!!this._saveChangesets(e)&&!0===this.checkRangeValid(e,this._command._changesets)}},{key:"_doAction",value:function(e){return this._changesetsToAction(e,this._command._changesets),e.setActiveSheetIndex(this._command.copySheetIndex,!0),!0}},{key:"_saveChangesets",value:function(e){return this._actionToChangesets(e)}},{key:"_actionToChangesets",value:function(e){var t=this._command,n=t.sheetId,r=t.copySheetId,a=t.copySheetName,o=t.copySheetIndex,i=e.getSheetFromId(n);if(!i)return!1;var u={action:"copySheet",sheet_id:n,value:{sheet_id:r,sheet_name:a,snapshot:this._getSnapshot(i),schemaVersion:1,index:o}};return this._command._changesets.push(u),this._command._oldChangesets.push({action:"delSheet",sheet_id:r,value:{sheet_name:a,index:o}}),!0}},{key:"_changesetsToAction",value:function(e,t,n){return this._applySpreadChangsetWithEvent(e,t,!0,n)}},{key:"_getSnapshot",value:function(e){var n=this._command,r=n.copySheetId,a=n.copySheetName,o=t2(e.toJSON(void 0,!1));o.id=r,o.name=a;var i=o.chartMap;i&&Object.keys(i).forEach((function(e){var t=(0,we.zsn)(10),n=i[e];n.sheetId=r,n.chartId=t,i[t]=n,n.graphSetting.dataRanges.forEach((function(e){e.sheetId=r})),delete i[e]}));var u=o.floatImageMap;u&&t.transformFloatImageMap(u,r);var s=o.dataRanges;if(s){var l={};Object.keys(s).forEach((function(e){var t=s[e],n=e.split("_"),a=(0,p.Z)(n,2)[1];l["".concat(r,"_").concat(a)]=t})),o.dataRanges=l}var c=e.getCopySheetFloatBlocks();c&&(Object.keys(c).forEach((function(e){c[e].sheetId=r})),o.floatBlocks=c);var h=e.getCopySheetEmbeddedBlocks();h&&(o.embeddedBlocks=h);var f=o.conditionalFormats;return f&&f.forEach((function(e){e.cfId=(0,we.zsn)(we.w8i)})),o}},{key:"_getDefaultCopySheetName",value:function(e,t){return this.getSheetNoConflictName(e,t,fn("sheet.copy_item"))}},{key:"commandName",get:function(){return we.rvF.COPY_SHEET}}],[{key:"getSnapshot",value:function(e,t,n){var r=t2(e.toJSON(void 0,!1));r.id=t,r.name=n;var a=r.chartMap;a&&Object.keys(a).forEach((function(e){var n=(0,we.zsn)(10),r=a[e];r.sheetId=t,r.chartId=n,a[n]=r,r.graphSetting.dataRanges.forEach((function(e){e.sheetId=t})),delete a[e]}));var o=r.floatImageMap;o&&this.transformFloatImageMap(o,t);var i=r.conditionalFormats;return i&&i.forEach((function(e){e.cfId=(0,we.zsn)(we.w8i)})),r}},{key:"transformFloatImageMap",value:function(e,t){return Object.keys(e).forEach((function(n){var r=(0,we.zsn)(10),a=e[n];a.sheetId=t,a.floatImageId=r,e[r]=a,delete e[n]})),e}}]),t}(j3);function O4(e,t,n,r){var a=null;if(t&&bm(t))n&&Mm(n)&&Nm(t)&&(a=e.getFirstItem());else{var o=(null==r?void 0:r.formatter)||null;a=e.mergeToSingleValue({formatter:o})}return a}var x4,Z4=function(e){function t(e,n){var r;return(0,y.Z)(this,t),(r=(0,d.Z)(this,(0,v.Z)(t).call(this,e,n))).updateSetRangeValueOptionsWithMultipleValues=function(e,t){var n,a=r._sheet,o=a.getMultipleValues(e,t);if(o){var i=r.dataValidation,u=a.getDataValidation(e,t),s=a.getCellStyle(e,t),l=O4(o,i,u,s);n={},r.updateCellValueWithSingleValue(n,l,s)}return n},r}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"execute",value:function(){this._beforeAction(this._sheet);var e=this.command.isFirstExecution?this._doActions():this._redoActions();return this._afterAction(this._sheet),e}},{key:"_doActions",value:function(){var e=this.command,t=e.activeCell,n=e.needApplyToAll,r=e._changesets,a=e.dataValidationJSON,o=e.allowUserApplyAll,i=e.selections,u=e.source;this.dataValidation=a?Ag(a,this._sheet):null;var s=this.filterDuplicateRange(i,!1),l=s;if(n){var c=this._sheet.getDataValidation(t.row,t.col);if(this.shouldApplyToAll(c)){var h=Om(this._sheet,c,s);l=s.concat(h)}a&&o&&u&&we.Ps3.collectSuiteEvent("sheet_opration",{action:"valid_apply_all",source:u,valid_type:Vm(a)?"list_single":"list_multiple",op_item:s.length!==l.length?"true":"false",attr_op_status:n?"effective":"cancel"})}return this.setDataValidationRangeValues(l),this.saveExtendFilterRangeActions(s),this.tryApplyActions(this._sheet.parent,r,!0,!0)}},{key:"_redoActions",value:function(){return this.tryApplyActions(this._sheet.parent,this.command._changesets,!0,!0)}},{key:"undo",value:function(){return this._applyChangsetWithEvent(this.command._oldChangesets,!0)}},{key:"shouldApplyToAll",value:function(e){return null!==e}},{key:"setDataValidationRangeValues",value:function(e){var t=this,n=this._sheet,r={ignoreValue:!0,ignoreFormulaData:!0,ignoreDataValidation:!1,ignoreReminder:!0,ignoreMultipleValues:!0,ignorePivotTable:!0,ignoreStyle:!0};e.forEach((function(e){var a=e.toJSON(),o=jQ(n,a,{},WQ);t._setRangeValuesActionToChangeset(o,!0);var i=jQ(n,a,r,t.processCellSetRangeValue.bind(t),(function(e,n){e.dataValidationId=t.dataValidation?n.dvJSONRefMgr.getValidationId(t.dataValidation):null}));t._setRangeValuesActionToChangeset(i)}))}},{key:"updateCellValueWithSingleValue",value:function(e,t,n){if(t){var r=t.segmentArray,a=t.variant,o=t.autoFormatter;if(e.value=r||(a?a.getValue():null),o&&!(0,Se.isDefaultFormatter)(o)){var i=this._sheet,u=Ad.withAutoFormatter(n||i.getDefaultStyle(),o);e.style=u.toJSON()||null}}}},{key:"processCellSetRangeValue",value:function(e,t,n,r){var a,o,i=this._sheet,u=this.updateSetRangeValueOptionsWithMultipleValues(e,t);n.ignoreValue=void 0===(null===(a=u)||void 0===a?void 0:a.value),n.ignoreStyle=void 0===(null===(o=u)||void 0===o?void 0:o.style),n.ignoreReminder=n.ignoreValue,n.ignoreReminder||((u=u||{}).reminder=null),n.cellValue=u,zQ(e,t,i,r,n)}},{key:"saveExtendFilterRangeActions",value:function(e){}},{key:"commandName",get:function(){return we.rvF.SET_DATA_VALIDATION}}]),t}(j3),D4=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"processCellSetRangeValue",value:function(e,n,r,a){if(null===this.dataValidation){var o=this._sheet,i=this._sheet.getDataValidation(e,n);return i&&Tm(i)?(r.ignoreDataValidation=!1,r.dataValidationId=null):(r.ignoreDataValidation=!0,r.dataValidationId=void 0),void zQ(e,n,o,a,r)}(0,f.Z)((0,v.Z)(t.prototype),"processCellSetRangeValue",this).call(this,e,n,r,a)}},{key:"commandName",get:function(){return we.rvF.SET_DATE_TIME_VALIDATION}}]),t}(Z4),P4=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"saveExtendFilterRangeActions",value:function(e){if(0!==e.length){var t=this._sheet,n=Kh(t,e),r=n.actions,a=n.oldActions;(0,we.hTd)(this._command._changesets,r),(0,we.hTd)(this._command._oldChangesets,a)}}},{key:"processCellSetRangeValue",value:function(e,t,n,r){var a=this._sheet,o=this.command.dataValidationJSON,i=!1,u=(0,p.Z)(o.formulas,2),s=u[0],l=u[1],c=a.getImmutableContent(e,t);if(null!=c&&c.multipleValues)i=!0;else if(null!=c&&c.segmentArray)i=!0;else{var h=null==c?void 0:c.variant,f=h?h.getValue():null;f!==s&&f!==l&&(i=!0)}if(n.ignoreStyle=!0,n.cellValue=void 0,n.ignoreValue=!i,n.ignoreReminder=!i,i){var d={value:l,reminder:null},v=a.getCellStyle(e,t);if(null!=v&&v.autoFormatter){n.ignoreStyle=!1;var g=Ad.withAutoFormatter(v,void 0);d.style=g.toJSON()||null}n.cellValue=d}zQ(e,t,a,r,n)}},{key:"commandName",get:function(){return we.rvF.SET_CHECKBOX_VALIDATION}}]),t}(Z4),L4=function(){function e(t,n){(0,y.Z)(this,e),this.sheet=n;var r=t.content;this._multipleValues=r?r.multipleValues:null,this._segmentArray=r?r.segmentArray:null,this._variant=r?r.variant:null,this._style=t.style,this._reminder=t.reminder}return(0,C.Z)(e,[{key:"setValue",value:function(e){Array.isArray(e)?this.setSegmentArray(e):"number"==typeof e?this.setVariant(new ut.NumberVar(e)):"string"==typeof e?this.setVariant(new ut.StringVar(e)):this.clearContent()}},{key:"getValue",value:function(){return null!==this._segmentArray?this._segmentArray:null!==this._variant?this._variant.getValue():null}},{key:"getMultipleValues",value:function(){return this._multipleValues}},{key:"setMultipleValues",value:function(e){var t;this._multipleValues=e;var n=(null===(t=this._style)||void 0===t?void 0:t.formatter)||null,r=this.sheet.parent.userLanguage,a=this._multipleValues.mergeToSingleValue({formatter:n}),o=a.segmentArray,i=a.variant;o?(this._segmentArray=o,this._variant=new xv(this.sheet.parent,o).getVar(r)):(this._segmentArray=null,this._variant=i||null)}},{key:"getSegmentArray",value:function(){return this._segmentArray}},{key:"setSegmentArray",value:function(e){this._multipleValues=null,this._segmentArray=e,this._variant=new xv(this.sheet.parent,e).getVar(this.sheet.parent.userLanguage)}},{key:"getVariant",value:function(){return this._variant}},{key:"setVariant",value:function(e){this._multipleValues=null,this._segmentArray=null,this._variant=e}},{key:"getStyle",value:function(){return this._style}},{key:"setStyle",value:function(e){this._style=e}},{key:"getReminder",value:function(){return this._reminder}},{key:"setReminder",value:function(e){this._reminder=e}},{key:"getImmutableContent",value:function(){return null===this._multipleValues&&null===this._segmentArray&&null===this._variant?null:new ay(this._segmentArray,this._variant,this._multipleValues)}},{key:"clearContent",value:function(){this._multipleValues=null,this._segmentArray=null,this._variant=null}}]),e}(),B4=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"shouldApplyToAll",value:function(e){return Boolean(e&&bm(e))}},{key:"processCellSetRangeValue",value:function(e,t,n,r){var a,o,i,u=this._sheet;n.cellValue=void 0,n.ignoreStyle=!0,n.ignoreValue=!0,n.ignoreMultipleValues=!0;var s=u.getDataValidation(e,t);if(!(this.command.dataValidationJSON||s&&bm(s)))return n.ignoreDataValidation=!0,void zQ(e,t,u,r,n);n.ignoreDataValidation=!1;var l=new L4({content:u.getImmutableContent(e,t),style:u.getCellStyle(e,t),reminder:u.getReminder(e,t)},u),c=this.updateCurCellText(l),h=!0,f=!0,d=!0;c&&(h=(a=c).ignoreMultipleValues,f=a.ignoreStyle,d=a.ignoreValue);var v,g=!!c,m=l.getMultipleValues();if(m){var p=this.dataValidation,y=l.getStyle(),C=O4(m,p,s,y);if(C){g=!0;var _=C.segmentArray,R=C.variant,w=C.autoFormatter;if(_?l.setSegmentArray(_):R?l.setVariant(R):l.clearContent(),d=!1,w&&!(0,Se.isDefaultFormatter)(w)){var k=Ad.withAutoFormatter(y||u.getDefaultStyle(),w);l.setStyle(k),f=!1}}}g&&(v={},d||(v.value=l.getValue(),n.ignoreValue=!1),h||(v.multipleValues=(null===(o=l.getMultipleValues())||void 0===o?void 0:o.toJSON())||null,n.ignoreMultipleValues=!1),f||(v.style=(null===(i=l.getStyle())||void 0===i?void 0:i.toJSON())||null,n.ignoreStyle=!1)),n.ignoreReminder=n.ignoreValue,n.ignoreReminder||((v=v||{}).reminder=null),n.cellValue=v,zQ(e,t,u,r,n)}},{key:"updateCurCellText",value:function(e){var t=this.command.cellTextUpdateMap;if(t&&0!==Object.keys(t).length){var n=e.getMultipleValues();return n?this.updateTextOfMultipleValues(e,t,n):this.updateTextOfSingleValue(e,t)}}},{key:"updateTextOfMultipleValues",value:function(e,t,n){for(var r,a=this._sheet,o=null===(r=e.getStyle())||void 0===r?void 0:r.formatter,i=n.clone(),u=!1,s=0;s<n.length;++s){var l=n.get(s),c=l.segmentArray,h=l.variant,f=l.autoFormatter,d=t[Yg(a.parent,{segmentArray:c,variant:h},{formatter:o||f||null})];null!=d&&(i.set(s,i.stringToMultipleValue(d,o)),u=!0)}return u&&e.setMultipleValues(i),{ignoreMultipleValues:!u,ignoreValue:!0,ignoreStyle:!0}}},{key:"updateTextOfSingleValue",value:function(e,t){var n,r=this._sheet,a=r.parent,o=e.getReminder(),i=e.getStyle(),u=AF(o,i,e.getImmutableContent(),r,!1),s=t[Yg(a,{segmentArray:e.getSegmentArray(),variant:e.getVariant()},{formatter:u})],l=null;if(null!=s){var c=null==i?void 0:i.formatter;if(l=ha(a.formatterService,{formatter:c},s,!1)){var h=l.autoFormatter;if(h){var f=Ad.withAutoFormatter(i||r.getDefaultStyle(),h);e.setStyle(f)}e.setValue(l.value)}}return{ignoreValue:!l,ignoreStyle:!(null!==(n=l)&&void 0!==n&&n.autoFormatter),ignoreMultipleValues:!0}}},{key:"commandName",get:function(){return we.rvF.SET_LIST_DATA_VALIDATION}}]),t}(Z4),U4=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"execute",value:function(e){var t=this._command.sheetId,n=e.getSheetFromId(t);return!!(n&&n.blockId&&n.blockToken)&&(this._command._oldChangesets=[{action:"restoreBlock",sheet_id:t,value:{sheet_id:t,sheet_name:n.name(),index:Number(e.getSheetIndex(n.name())),block_type:n.blockType,block_id:n.blockId,block_token:n.blockToken}}],this._command._changesets=[{action:"delBlock",sheet_id:t,value:{sheet_name:n.name(),index:Number(e.getSheetIndex(n.name())),block_type:n.blockType,block_id:n.blockId,block_token:n.blockToken}}],this._applySpreadChangsetWithEvent(e,this._command._changesets,!0))}},{key:"undo",value:function(e){return this._applySpreadChangsetWithEvent(e,this._command._oldChangesets,!0)}},{key:"canUndo",value:function(e){var t=this._command._changesets[0].sheet_id;if(e.getSheetFromId(t))return!1;if(e.sheets.filter((function(e){return e.blockType===we.kHU.DOCX_BLOCK})).length){var n=this._command._oldChangesets.some((function(e){return e.value.block_type===we.kHU.DOCX_BLOCK}));return n&&e.dispatch("LimitDocx"),!n}return!0}},{key:"commandName",get:function(){return we.rvF.DEL_BLOCK}}]),t}(j3),H4=function(e){function t(e,n,r){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).call(this,e,n))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"execute",value:function(e){return!(this._command.isFirstExecution&&!this.generateActions(e))&&this._doAction(e)}},{key:"undo",value:function(e){var t=this,n=this._command,r=e.sheets.map((function(e){return e.name()}));return n._oldChangesets=n._oldChangesets.map((function(n){if("copySheet"!==n.action)return n;var a=n.value.sheet_name;return-1!==r.indexOf(a)&&(n.value.sheet_name=t.getSheetNoConflictName(e,a,fn("sheet.conflict"))),n})),this._changesetsToAction(e,this._command._oldChangesets,"undo"),!0}},{key:"generateActions",value:function(e){return this._saveChangesets(e),this.checkRangeValid(e,this._command._changesets)}},{key:"_doAction",value:function(e){return this._changesetsToAction(e,this._command._changesets),!0}},{key:"_saveChangesets",value:function(e){return this._actionToChangesets(e)}},{key:"_actionToChangesets",value:function(e){var t=this._command.sheetId,n=e.getSheetFromId(t);if(!n)throw new Error("sheet not found");var r=n.name(),a=e.getSheetIndex(r);if((0,w.Z)(a))throw new Error("sheetIndex is null");this._command._changesets.push({action:"delSheet",sheet_id:t,value:{sheet_name:r,index:a}});var o=n.toJSON(void 0,!1),i={action:"copySheet",sheet_id:o.id,value:{sheet_id:o.id,sheet_name:o.name,index:a,snapshot:o,schemaVersion:1}};return this._command._oldChangesets.push(i),this.saveConditionalFormatActions(e,n),!0}},{key:"_changesetsToAction",value:function(e,t,n){return this._applySpreadChangsetWithEvent(e,t,!0,n)}},{key:"canUndo",value:function(e){return!0===this.checkRangeValid(e,this._command._oldChangesets)}},{key:"saveConditionalFormatActions",value:function(e,t){if(e&&t){var n=t.id(),r=t.conditionalFormatModel.getAdjustedRulesByDelSheet(n,e);this.setConditionalFormatChangeSet(r,e)}}},{key:"setConditionalFormatChangeSet",value:function(e,t){var n=this;e.size<=0||e.forEach((function(e,r){e.forEach((function(e){var a=t.getSheetFromId(r),o=e.cfId,i=void 0===o?null:o,u=e.attrs,s=void 0===u?null:u;if(a&&i){var l=sX(a,i);if(l){var c=Object.assign({},l);null!==s&&(c.attrs=s);var h=cX(a,i,c);h&&((0,we.hTd)(n._command._changesets,h.actions),(0,we.hTd)(n._command._oldChangesets,h.oldActions))}}}))}))}},{key:"commandName",get:function(){return we.rvF.DELETE_SHEET}}]),t}(j3),W4=function(e){function t(e,n){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).call(this,e,n))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"execute",value:function(){return this._command.isFirstExecution?this.doAction():this.redoAction()}},{key:"undo",value:function(){return this._applyChangsetWithEvent(this._command._oldChangesets)}},{key:"redoAction",value:function(){return!0===this.checkRangeValid(this._sheet.parent,this._command._changesets)&&this._applyChangsetWithEvent(this._command._changesets)}},{key:"doAction",value:function(){return this._saveChangeSets(),this._applyChangsetWithEvent(this._command._changesets,!0)}},{key:"_saveChangeSets",value:function(){var e=this._sheet,t=this.command.target;if(t.type===we.xj7.ROW||t.type===we.xj7.COL){var n=Q3(e.id(),t),r=this.generateDelOutlineOldCs();this._command._changesets.push(n),(0,we.hTd)(this._command._oldChangesets,r)}}},{key:"generateDelOutlineOldCs",value:function(){for(var e=this._sheet,t=this.command.target,n=t.type,r=[],a=e.outlineGroupModel,o=tu(a.getInfluencedOutlines(t),t),i=[],u=0;u<o.length;u++){var s=o[u];0!==a.getInfluencedOutlines(Xi(t.type,s)).length&&i.push(s)}for(var l=0;l<i.length;l++)for(var c=i[l],h=l+1;h<i.length;h++){var f=i[h];1!==f[2]&&1!==c[2]&&c[0]+c[1]===f[0]&&(c[1]+=f[1],f[2]=1)}for(var d=0;d<i.length;d++){var v=[i[d][0],i[d][1]];if(1!==i[d][2]){var g=a.getBeInludedOutlines(Xi(n,v)).sort((function(e,t){return t.count-e.count}));if(0===g.length)continue;var m=g[0],p=m.state,y=[m.start,m.count];r.push(K3(e.id(),n,y,p)),i[d][2]=2;var C=Yi(v,y);qi(C[0])&&i.push(C[0]),C[1]&&qi(C[1])&&i.push(C[1])}}return i.filter((function(e){return!e[2]})).forEach((function(t){r.push(K3(e.id(),n,t,we.w2y.Expand))})),r}},{key:"commandName",get:function(){return we.rvF.DEL_OUTLINE}}]),t}(j3),j4=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"execute",value:function(){var e=this._sheet;if(this._command.isFirstExecution&&!this._saveChangesets())return!1;if(!this.checkRangeValid(e.parent,this._command._changesets))return!1;var t=this._applyChangsetWithEvent(this._command._changesets,!0);return this._afterAction(e),t}},{key:"_saveChangesets",value:function(){var e=this._command.value,t=e.viewName,n=e.viewId;this._command._changesets=[(0,we.h_E)(this._sheetId,{view_id:n,name:t}),(0,we.YY8)(this._sheetId)];var r=function(e,t){var n=function(e,t){var n=e.viewsModel.getViewById(t);return n&&n.getFilterModel()}(e,t),r=n&&n.getInfo();if(!r)return null;var a=r.range.toJSON(),o=[];return o.push((0,we.eRv)(e.id(),{view_id:t,range:gh(a),calculate:!0})),(0,m.Z)(n.getValidFilterRules()).forEach((function(n){var r=(0,p.Z)(n,1)[0],i=e.filterModel.getFilterInfo(r);i&&o.push((0,we.eRv)(e.id(),{view_id:t,range:gh(a),filter_value:Object.assign({},i),calculate:!0}))})),o}(this._sheet,n)||[];return this._command._oldChangesets=[(0,we.VCn)(this._sheetId,{view_id:n,name:t})].concat((0,m.Z)(r),[(0,we.fdi)(this._sheetId,n)]),!0}},{key:"undo",value:function(){return this._applyChangsetWithEvent(this._command._oldChangesets,!0)}},{key:"_afterAction",value:function(e){(0,f.Z)((0,v.Z)(t.prototype),"_afterAction",this).call(this,e),e.dispatch("FilterChanged")}},{key:"commandName",get:function(){return we.rvF.DEL_VIEW}}]),t}(j3),z4=function(e){function t(e,n,r){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).call(this,e,n))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"execute",value:function(){return this._command.isFirstExecution?this._doAction():this._redoAction()}},{key:"_conditionalFormatToChangeset",value:function(e){var t=iX(this._sheet,e);t&&t.actions&&t.oldActions&&((0,we.hTd)(this._command._changesets,t.actions),(0,we.hTd)(this._command._oldChangesets,t.oldActions))}},{key:"_doClearRange",value:function(e){var t=this,n=this._sheet;if(!hX(n,this._command.ranges,void 0,!0))return!1;for(var r=new Set,a={ignoreValue:!1,ignoreFormulaData:!0,ignoreDataValidation:!0,ignoreReminder:!0,ignoreMultipleValues:!0,ignorePivotTable:!0,styleId:null},o=0;o<e.length;o++){var i=e[o],u=n.getSpans(i);u.length>0&&(this._spanToChangeset(i,u,!0),this._spanToChangeset(i,null));var s=this.splitSelectionByFilterRow(i),l=[];this.checkRangeDuplicate(s,r,l,e),l.forEach((function(e){t._rangeOpToChangeset(e,{style:null});var r=jQ(n,e.toJSON(),a,HQ);t._setRangeValuesActionToChangeset(r,!0)}))}return this._conditionalFormatToChangeset(e),!0}},{key:"_doAction",value:function(){var e=this._command.ranges||this._sheet.getSelections();return!!this._doClearRange(e)&&!0===this.checkRangeValid(this._sheet.parent,this._command._changesets)&&this._applyChangsetWithEvent(this._command._changesets,!0)}},{key:"_redoAction",value:function(){return!0===this.checkRangeValid(this._sheet.parent,this._command._changesets)&&this._applyChangsetWithEvent(this._command._changesets,!0)}},{key:"undo",value:function(){var e=this._command._oldChangesets;return this._applyChangsetWithEvent(e)}},{key:"commandName",get:function(){return we.rvF.DO_CLEAR}}]),t}(j3),G4=function(e){if(!(e instanceof Object))return e;var t=e;if(t.hasOwnProperty("refCount")){var n=t;n.refCount;t=(0,s.Z)(n,Cn)}return"mention"===e.type&&(t=function(e){var t={};return Object.keys(e).forEach((function(n){var r=e[n];void 0!==r&&(t[n]=r)})),t}(t)),t},J4=function(e){if(!(e instanceof Object))return e;var t={};return Object.keys(e).forEach((function(n){var r=e[n];void 0!==r&&(t[n]=G4(r))})),t},q4=function(e){function t(e,n){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).call(this,e,n))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"canExecute",value:function(){var e=this._sheet,t=this._command,n=t.row,r=t.col;return!!e._canChange(n,r,1,1)}},{key:"undo",value:function(){var e=this._sheet,t=this._command,n=!1;this._beforeAction(e,!0);try{if(n=this._applyChangsetWithEvent(this._command._oldChangesets,!0,"undo"),this._command._changesets.length<1)return!0;var r=this._command._changesets[0].value.value,a=this._command._oldChangesets[0].value.value;e._raiseValueChanged(t.row,t.col,r,a,t.from,"UNDO")}finally{this._afterAction(e,!0)}return n}},{key:"_doAction",value:function(){var e=!1,t=this._command;if(t._canExecute=this.canExecute(),t._canExecute){var n=this._sheet;this._beforeAction(n,!0);try{var r=this.generateActions();if(!this._command._oldChangesets.length||!this._command._changesets)return!1;var a=this._command._oldChangesets[0].value,o=this._command._changesets[0],i=o.value;if(!this.isValueChanged(i,a))return!1;if("NO_VERSION"===this._command.from&&(o.no_history=!0,o.extra={commandType:"dataConnectorSetMention"}),this._command._canUndo=r,r){var u=i.value,s=a.value;e=this._applyChangsetWithEvent(this._command._changesets,!0),n._raiseValueChanged(t.row,t.col,s,u,t.from,"DO")}}finally{this._afterAction(n,!0)}}return e}},{key:"generateActions",value:function(){var e=this._applyEditing();return!1!==e&&e}},{key:"_redoAction",value:function(){var e=this._sheet,t=this._command,n=!1;if(t._canExecute){if(!0!==this.checkRangeValid(this._sheet.parent,this._command._changesets))return!1;this._beforeAction(e,!0);try{if(this._command._changesets.length<1)return!0;var r=this._command._changesets[0].value.value,a=this._command._oldChangesets[0].value.value;n=this._applyChangsetWithEvent(this._command._changesets,!0,"redo"),e._raiseValueChanged(t.row,t.col,a,r,t.from,"REDO")}finally{this._afterAction(e,!0)}}return n}},{key:"_applyEditing",value:function(){var e=this._sheet,t=this._command,n=t.newSegmentArray,r=t.newValue;r=(0,we.ATv)(r);var a=t.row,o=t.col,i=e.getSpan(a,o);if(i&&(i.rowFrom()!==a||i.colFrom()!==o))return!1;var u=void 0===t.autoFormat||t.autoFormat,s=Sv._getValueAndStyleFromEditing(e,a,o,r,u),l=s.value,c=s.styleWithDropdown;if(r&&"string"==typeof r&&["=","+"].includes(r[0])&&c.formatter&&(0,Se.isTextFormatter)(c.formatter))return this._setCellValue(a,o,l,null,null,c,null,void 0,!0),!0;var h=l2(a,o,e,r);if(h.isFormula){var f=h.formulaVar;if(!f)return!1;if(th(f)&&e.getParent().importRangeManager.isImportRangeNumExceedLimit())return we.Ps3.Toast.error({key:"crossTableError_num",closable:!0,content:fn("CreationDoc_Sheets_ImportrangeToLimit",we.Ps3.getSheetImportRangeCountLimit())}),!1;(function(e){return eh(e,"QUERY")})(f)&&we.Ps3.ccmEventTracking("ccm_sheet_content_page_click",{click:"change_formula_data_range",target:"none",formula_name:"QUERY",query_key:JSON.stringify({select:xL(r,"SELECT"),where:xL(r,"WHERE"),pivot:xL(r,"PIVOT"),"group by":xL(r,"GROUP BY"),"order by":xL(r,"ORDER BY")}),formula_type:"lookup",change_method:"move"});var d=h.text,v=e.getStyleWithDropdown(a,o)||Md();if(!v.formatter){var g=(0,Se.createFormatter)(e.parent.formatterService);v=Ad.withAutoFormatter(v,g)}return this._setCellValue(a,o,null,d,f,v,null,void 0,!th(f)),!0}if(r!==h.text){r=h.text;var m=Sv._getValueAndStyleFromEditing(e,a,o,r,u);l=m.value,c=m.styleWithDropdown}if(!h.isFormula&&Array.isArray(n)&&n.length){var p=!0,y="number"==typeof l;if(y){for(var C=null,_=0;_<n.length;_++){var R=n[_];R.type!==we.K6s.TEXT&&R.type!==we.K6s.URL&&(p=!1),C||R.type!==we.K6s.URL||(C=R)}p&&C&&n.length>1&&(l=[{type:we.K6s.URL,text:String(l),link:C.link,cellPosition:C.cellPosition,visited:C.visited}])}if(!y||!p){var w=mp(n,c,e);c=w.style,l=w.value}if(y&&1===n.length){var k=mp(n,c,e);n[0].type===we.K6s.TEXT&&(c=k.style),n[0].type===we.K6s.URL&&(c=k.style,l=k.value)}}var S=this.getReminderWithCellValue(l,a,o);return this._setCellValue(a,o,l,null,null,c,S,void 0,!0),!0}},{key:"getReminderWithCellValue",value:function(e,t,n){var r=this._sheet.getReminder(t,n);if(!r||!hr(e))return null;var a=by.fromReminder(r);return a.setExpireTime(wy(e)),a}},{key:"canUndo",value:function(){return(0,f.Z)((0,v.Z)(t.prototype),"canUndo",this).call(this)&&this._command._canUndo}},{key:"isValueChanged",value:function(e,t){var n=this.command,r=n.row,a=n.col;return!(!e.formulaData&&this._sheet.isProxyArrayFormula(r,a)&&null===t.value&&this._sheet.getValue(r,a)===e.value||(0,pe.default)(J4(e.value),J4(t.value))&&this.isEqualStyle(e.style||null,t.style||null)&&e.formula===t.formula&&(0,pe.default)(e.formulaData,t.formulaData))}},{key:"isEqualStyle",value:function(e,t){if(e===t)return!0;var n,r,a=this._sheet,o=a.getParent();return n=null===e?a.getDefaultStyle():Ad.fromJSON(o.formatterService,e),r=null===t?a.getDefaultStyle():Ad.fromJSON(o.formatterService,t),n.equals(r,!1)}},{key:"commandName",get:function(){return"editCell"}}]),t}(h4),$4=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"execute",value:function(){var e=this._sheet;if(this._command.isFirstExecution&&!this._saveChangesets())return!1;var t=this._applyChangsetWithEvent(this._command._changesets,!0);return this._afterAction(e),t}},{key:"_saveChangesets",value:function(){var e=this._command,t=e.sheetId,n=e.value.view_id,r=this._sheet.viewsModel.activeView;return this._command._oldChangesets=[r?(0,we.fdi)(t,r.getId()):(0,we.YY8)(t)],this._command._changesets=[(0,we.fdi)(t,n)],!0}},{key:"undo",value:function(){return this._applyChangsetWithEvent(this._command._oldChangesets,!0)}},{key:"_afterAction",value:function(e){(0,f.Z)((0,v.Z)(t.prototype),"_afterAction",this).call(this,e),e.dispatch("FilterChanged")}},{key:"commandName",get:function(){return we.rvF.ENTER_VIEW}}]),t}(j3),Y4=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"execute",value:function(){var e=this._sheet;if(this._command.isFirstExecution&&!this._saveChangesets())return!1;if(!0!==this.checkRangeValid(e.parent,this._command._changesets))return!1;var t=this._applyChangsetWithEvent(this._command._changesets,!0);return this._afterAction(e),t}},{key:"_saveChangesets",value:function(){var e=this._command.sheetId,t=this._sheet.viewsModel.activeView;return t&&(this._command._oldChangesets=[(0,we.fdi)(e,t.getId())]),this._command._changesets=[(0,we.YY8)(e)],!0}},{key:"undo",value:function(){return this._applyChangsetWithEvent(this._command._oldChangesets,!0)}},{key:"_afterAction",value:function(e){(0,f.Z)((0,v.Z)(t.prototype),"_afterAction",this).call(this,e),e.dispatch("FilterChanged")}},{key:"commandName",get:function(){return we.rvF.EXIT_VIEW}}]),t}(j3);!function(e){e[e.Normal=1]="Normal",e[e.InoperativeSpanCell=2]="InoperativeSpanCell",e[e.OperativeSpanCell=3]="OperativeSpanCell"}(x4||(x4={}));var K4=function(e){function t(e,n){var r;(0,y.Z)(this,t),r=(0,d.Z)(this,(0,v.Z)(t).call(this,e,n));var a=n.startRange,o=n.fillRange;return r._wholeFillRange=a,o&&(r._wholeFillRange=a.union(o)),r}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"execute",value:function(){return this._command.isFirstExecution?this.doAction():this.redoAction()}},{key:"canExecute",value:function(){var e=this._command,t=e.startRange,n=e.fillRange;if(!this._sheet._canChange(n.rowFrom(),n.colFrom(),n.rowCount(),n.colCount()))return!1;if(this.isHorizontalFill){if(t.rowFrom()!==n.rowFrom()||t.rowCount()!==n.rowCount())return!1}else if(t.colFrom()!==n.colFrom()||t.colCount()!==n.colCount())return!1;return!n.isIntersect(t)}},{key:"redoAction",value:function(){return!0===this.checkRangeValid(this._sheet.parent,this._command._changesets)&&this._applyChangsetWithEvent(this._command._changesets)}},{key:"undo",value:function(){return this._applyChangsetWithEvent(this._command._oldChangesets)}},{key:"doAction",value:function(){if(!this.canExecute())return!1;var e=this._sheet,t=this._command.fillRange,n=this._collRangeInfo(e,t);return this.saveChangesets(n,!0),this._beforeAction(e,!0),this._executeFill(),this._afterAction(this._sheet,!0),this.extendFilterRange([t]),!!this.checkRangeValid(e.parent,this.command._changesets,!0)&&(this._applyChangsetWithEvent(this.command._changesets),!0)}},{key:"collectEvent",value:function(){var e=this._sheet,t=this.command.startRange;(function(e,t){null!==e.iterReminder(t.rowFrom(),t.colFrom(),t.rowCount(),t.colCount()).next()&&we.Ps3.collectSuiteEvent("sheet_opration",{action:"add_reminder",source:"fill"})})(e,t),function(e,t){var n=t.rowFrom(),r=t.colFrom(),a=t.rowCount(),o=t.colCount(),i=!1,u=!1,s=!1,l=!1,c=!1,h=!1,f=!1,d=!1,v=0,g=[];e.iterDropdown(n,r,a,o).forEach((function(e){u=!0,e.isEnableOptionColor?f=!0:d=!0})),e.iterDataValidation(n,r,a,o).forEach((function(e){switch(e.type){case"list":case"listFromRange":e.options.supportMultipleValues?s=!0:u=!0,e.options.shouldHighlightValidData?f=!0:d=!0;break;case"checkbox":i=!0;break;case"date":c=!0;break;case"textLength":h=!0;break;case"number":l=!0}v++})),l&&g.push("number"),c&&g.push("date"),h&&g.push("text_length"),i&&g.push("checkbox"),u&&g.push("list_single"),s&&g.push("list_multiple"),_m(i,u,s,f,d,"fill",v,g.join("-"))}(e,t),function(e,t){var n=t.rowFrom(),r=t.colFrom(),a=t.rowCount(),o=t.colCount();e._getModel().iterContent(n,r,a,o).forEach((function(e){if(e&&e.segmentArray){var t=!1;e.segmentArray.forEach((function(e){(0,we.S3_)(e)&&(t=!0)})),t&&we.Ps3.collectSuiteEvent("sheet_opration",{action:"upload_attachment",source:"fill"}),t&&we.Ps3.ccmEventTracking&&we.Ps3.ccmEventTracking("ccm_sheet_content_page_click",Object.assign({},(0,we.dK5)(),{click:"upload_attachment",target:"none",action_method:"fill"}))}}))}(e,t)}},{key:"_executeFill",value:function(){var e=this.command.autoFillType;this.collectEvent(),1===e?this.fillSeries():0===e&&this.copyCells(),this.updateSelectionAfterExecute()}},{key:"updateSelectionAfterExecute",value:function(){var e=this._sheet,t=this._wholeFillRange;e._setActiveCellImp(t.rowFrom(),t.colFrom(),e._activeRowViewportIndex,e._activeColViewportIndex),e._selectionModel&&e._clearSelectionImp(),e.addSelection(t)}},{key:"copyCells",value:function(){var e=this,t=this._sheet,n=this.command,r=n.startRange,a=n.fillRange,o=n.fillDirection,i=r.rowFrom(),u=r.colFrom(),s=r.rowCount(),l=r.colCount(),c=a.rowFrom(),h=a.colFrom(),f=a.rowCount(),d=a.colCount(),v=Math.floor(f/s),g=f%s,m=Math.floor(d/l),p=d%l,y=t._getSpanModel(),C={},_={},R=[],w=[],k={},S={},E=JQ(t.id(),{row:c,col:h,rowCount:f,colCount:d}),T=u$(t,i,u,t,c,h,s,l);if($1(r,(function(n,r){var a=y.find(n,r);if(a){if(a.rowFrom()!==n||a.colFrom()!==r)return;var o=e._transformRange(a);w.push(o);var i=k[n]||[];i.push(o),k[n]=i;var u=S[r]||[];u.push(o),S[r]=u}var s=e.getSetCellAction(t,n,r,{ignoreFormulaData:!0,handleStyleRef:!1});e.preProcessFormulaInSetCellAction(s,T),R.push(s);var l=C[n]||[];l.push(s),C[n]=l;var c=_[r]||[];c.push(s),_[r]=c}),this.skipRow.bind(this)),this.isHorizontalFill)!function(){for(var n=0===o,r=new Set,a=function(a){var o=a*l;n&&(o=d-(a+1)*l),R.forEach((function(n){var a=h+(n.target.col-u)+o;e.saveNewAction(n,E,{col:a}),r.has(a)||(r.add(a),e.saveNewSetColumnWidthAction(a,t.getColumnWidth(n.target.col)))})),w.forEach((function(t){var n=h+(t.col-u)+o;e.saveNewSetSpansAction(t.row,n,t.row_count,t.col_count)}))},i=0;i<m;i++)a(i);0!==p&&function(){var r=h+d-p;n&&(r=h);for(var a=function(a){var o=n?u+l-p+a:u+a,i=_[o]||[],s=r+a;i.forEach((function(t){e.saveNewAction(t,E,{col:s})})),e.saveNewSetColumnWidthAction(s,t.getColumnWidth(o)),(S[o]||[]).forEach((function(t){var n=t.row,o=t.row_count,i=t.col_count;e.saveNewSetSpansAction(n,r+a,o,i)}))},o=0;o<p;o++)a(o)}()}();else{for(var A=2===o,I=function(t){var n=t*s;A&&(n=f-(t+1)*s),R.forEach((function(t){var r=c+(t.target.row-i)+n;e.skipRow(r)||e.saveNewAction(t,E,{row:r})})),w.forEach((function(t){var r=c+(t.row-i)+n;e.saveNewSetSpansAction(r,t.col,t.row_count,t.col_count)}))},b=0;b<v;b++)I(b);0!==g&&function(){var t=c+f-g;A&&(t=c);for(var n=function(n){var r=A?i+s-g+n:i+n;(C[r]||[]).forEach((function(r){var a=t+n;e.skipRow(a)||e.saveNewAction(r,E,{row:a})})),(k[r]||[]).forEach((function(t){var n=t.row,r=t.col,a=t.row_count,o=t.col_count;e.saveNewSetSpansAction(n,r,a,o)}))},r=0;r<g;r++)n(r)}()}E&&(GQ(E),this.command._changesets.unshift(E))}},{key:"fillSeries",value:function(){var e=this,t=this.command,n=t.startRange,r=t.fillRange,a=new lv,o=u$(this._sheet,n.rowFrom(),n.colFrom(),this._sheet,r.rowFrom(),r.colFrom(),n.rowCount(),n.colCount()),i=this._sheet,u=new lv,s=new lv,l=new Set,c=i._getSpanModel(),h=JQ(i.id(),r.toJSON()),f=new JK(this._sheet,(function(t,n,r,i,f,d){var v=u.get(n,r);if(void 0===v){var g=c.find(n,r);g?g.rowFrom()===n||g.colFrom()===r?(u.set(n,r,3),s.set(n,r,{rowCount:g.rowCount(),colCount:g.colCount()})):u.set(n,r,2):u.set(n,r,1),v=u.get(n,r)}if(3===v){var m=s.get(n,r);e.saveNewSetSpansAction(i,f,m.rowCount,m.colCount)}var p=a.get(n,r);p||(p=e.getSetCellAction(t,n,r,{ignoreFormulaData:!0,handleStyleRef:!1}),e.preProcessFormulaInSetCellAction(p,o),a.set(n,r,p));var y={row:i,col:f};"number"==typeof d&&(y.value=d),e.saveNewAction(p,h,y),f===r||l.has(f)||(l.add(f),e.saveNewSetColumnWidthAction(f,t.getColumnWidth(r)))}));f.fillAuto(this._wholeFillRange,n,this.isHorizontalFill?1:0),h&&(GQ(h),this.command._changesets.unshift(h))}},{key:"saveNewAction",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};e=ya(e),void 0!==n.col&&(e.target.col=n.col),void 0!==n.row&&(e.target.row=n.row),void 0!==n.value&&(e.value.value=n.value);var r=this._sheet,a=e.value,o=e.target,i=o.row,u=o.col;if((0,we.Nsj)(a.value,!0),a.formulaData&&a.formulaData.tokens&&a.formulaData.tree){var s=new Oi(i,u,1,1,r);a.formulaData=jw(r,a.formulaData,s)}if(null!=a.reminder){var l=void 0===n.value?a.value:n.value,c=_y(a.reminder,l),h=c&&c.toChangeset();e.value.reminder=h}zQ(e.target.row,e.target.col,r,t,{cellValue:e.value})}},{key:"saveNewSetSpansAction",value:function(e,t,n,r){var a,o=this._sheet,i=o.getColumnCount(),u=o.getRowCount();e=(a=this.fixSpan({row:e,col:t,rowCount:n,colCount:r},u,i)).row,t=a.col,(n=a.rowCount)*(r=a.colCount)!=1&&this.command._changesets.push({action:"setSpans",sheet_id:o.id(),target:{row:e,col:t,row_count:n,col_count:r},value:[{target:{row:e,col:t,row_count:n,col_count:r}}]})}},{key:"preProcessFormulaInSetCellAction",value:function(e,t){var n=e.target,r=n.row,a=n.col,o=this._sheet;if(o.hasFormula(r,a)){var i=o.getVar(r,a),u={ref:i.getRef()};e.value.formulaData=wf(i,u,{refType:1})}else o.isProxyArrayFormula(r,a)&&t.has(o.getVar(r,a).formula)&&(e.value.value=null)}},{key:"fixSpan",value:function(e,t,n){var r=e.row,a=e.col,o=e.rowCount,i=e.colCount;return a+i>n&&(i=n-a),r+o>t&&(o=t-r),{row:r,col:a,rowCount:o,colCount:i}}},{key:"skipRow",value:function(e){return this._isFilterRow(e)}},{key:"extendFilterRange",value:function(e){var t=this._sheet,n=this._command,r=n._changesets,a=n._oldChangesets,o=Kh(t,e),i=o.actions,u=o.oldActions;r.push.apply(r,(0,m.Z)(i)),a.push.apply(a,(0,m.Z)(u))}},{key:"isHorizontalFill",get:function(){return[0,1].includes(this._command.fillDirection)}},{key:"commandName",get:function(){return we.rvF.FILL}}]),t}(j3),X4=function(e){function t(e,n){var r;return(0,y.Z)(this,t),(r=(0,d.Z)(this,(0,v.Z)(t).call(this,e,n)))._command.autoFillType=0,r}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"execute",value:function(){return this._command.isFirstExecution?this.doAction():this.redoAction()}},{key:"_canExecute",value:function(e){return!!this._sheet._canChange(e.rowFrom(),e.colFrom(),e.rowCount(),e.colCount())}},{key:"redoAction",value:function(){return!0===this.checkRangeValid(this._sheet.parent,this._command._changesets)&&this._applyChangsetWithEvent(this._command._changesets)}},{key:"undo",value:function(){return this._applyChangsetWithEvent(this._command._oldChangesets)}},{key:"doAction",value:function(){var e=this,t=this._sheet,n=this._command,r=n.startRange,a=n.fillRanges;this.collectEvent(),this._beforeAction(t,!0);var o=r.rowFrom(),i=r.colFrom(),u=this.getSetCellAction(t,o,i,{ignoreFormulaData:!0,handleStyleRef:!1});this.preProcessFormulaInSetCellAction(u);var s=t.getColumnWidth(i),l=new Set;return l.add(i),a.forEach((function(n){var r=e._collRangeInfo(t,n);e.saveChangesets(r,!0);var a=JQ(t.id(),{row:n.rowFrom(),col:n.colFrom(),rowCount:n.rowCount(),colCount:n.colCount()});$1(n,(function(t,n){e.saveNewAction(u,a,{row:t,col:n}),l.has(n)||(l.add(n),e.saveNewSetColumnWidthAction(n,s))}),e.skipRow.bind(e)),GQ(a),e.command._changesets.unshift(a)})),this.updateSelectionAfterExecute(),this._afterAction(t,!0),this.extendFilterRange(a),!!this.checkRangeValid(t.parent,this.command._changesets,!0)&&(this._applyChangsetWithEvent(this.command._changesets),!0)}},{key:"preProcessFormulaInSetCellAction",value:function(e){var t=e.target,n=t.row,r=t.col,a=this._sheet;if(a.hasFormula(n,r)){var o=a.getVar(n,r),i={ref:o.getRef()};e.value.formulaData=wf(o,i,{refType:1})}else a.isProxyArrayFormula(n,r)&&(e.value.value=null)}},{key:"updateSelectionAfterExecute",value:function(){var e=this._sheet;e.clearSelection(),this.command.fillRanges.forEach((function(t){return e.addSelection(t)}))}},{key:"commandName",get:function(){return"fillRange"}}]),t}(K4),Q4=function(e){function t(){var e;return(0,y.Z)(this,t),(e=(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments)))._addRows=0,e._addCols=0,e.handleConditionFormat=function(t){if(t){var n=e._command,r=n.toRange,a=n.fromRange,o=mX(e._sheet,t,a,r),i=o.changeset,u=o.undoChangeset,s=o.isOverLimit;(0,we.hTd)(e._command._changesets,i),(0,we.VB2)(e._command._oldChangesets,u),s&&e._sheet.parent.trigger(we.zW2.conditionalFormatOverLimit)}},e}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"execute",value:function(){return this._command.isFirstExecution?this._doAction():this._redoAction()}},{key:"undo",value:function(){return this._applyChangsetWithEvent(this._command._oldChangesets,!0)}},{key:"_doAction",value:function(){return this._saveChangesets(),!(!this.checkRangeValid(this._sheet.parent,this._command._changesets)||!this._command._changesets.length)&&this._applyChangsetWithEvent(this._command._changesets,!0)}},{key:"_redoAction",value:function(){return!0===this.checkRangeValid(this._sheet.parent,this._command._changesets)&&this._applyChangsetWithEvent(this._command._changesets,!0)}},{key:"checkExpandTargetRangeProtected",value:function(e,t){return!!t.protectionModel.getRangePermissions(e).hasPermission||(t._raiseInvalidOperation(8,fn("sheet.protection.cannot_start_edit")),!1)}},{key:"_saveChangesets",value:function(){var e=this._sheet,t=this._command,n=t.fromRange,r=t.toRange,a=t.conditionFormat,o=t.isFromSpanToSpan,i=t.styles;if(this.checkExpandTargetRangeProtected([r],e)){if(o&&(this.handleLackOfRowCol(),!this.handleSetSpans()))return;this.handleSetRangeStyle(e,n,r,i),this.handleSetWidthAndHeight(r),this.handleConditionFormat(a),this.extendFilterRange(),this._command._changesets=this._getCSWithoutFilterRow(this._command._changesets)}}},{key:"handleLackOfRowCol",value:function(){var e=this._sheet,t=this._command,n=t.fromRange,r=t.toRange,a=r.rowFrom(),o=r.colFrom(),i=n.rowCount(),u=n.colCount(),s=e.getRowCount(),l=e.getColumnCount(),c=a+i-s,h=o+u-l;(c>0||h>0)&&Math.max(a+i,s)*Math.max(o+u,l)>(0,we.$$w)()?e._raiseInvalidOperation(6,fn("sheet.cell_limit_exceed")):(c>0&&(this._addRows=c,this._command._changesets.push(this._addRowsAction(s,c)),this._command._oldChangesets.unshift(this._delRowsAction(s,c))),h>0&&(this._addCols=h,this._command._changesets.push(this._addColsAction(l,h)),this._command._oldChangesets.unshift(this._delColsAction(l,h))))}},{key:"handleSetSpans",value:function(){for(var e=this._sheet,t=this._command,n=t.fromRange,r=t.spans,a=t.toRange,o=a.rowFrom(),i=a.colFrom(),u=a.rowCount(),s=a.colCount(),l=n.rowCount(),c=n.colCount(),h=this.getRepeatConfig,f=h.rows,d=h.cols,v=h.lastCopyRows,g=h.lastCopyCols,m=[],p=e.getSpans(a),y=!1,C=0;C<r.length;C++)for(var _=r[C],R=_.rowFrom(),w=_.colFrom(),k=_.rowCount(),S=_.colCount(),E=0;E<f||E===f&&R<v;E++){var T=o+l*E+R;if(T+k-1>o+u-1)break;for(var A=0;A<d||A===d&&w<g;A++){var I=i+c*A+w;if(I+S-1>i+s-1)break;if(pk(e,T,I,k,S))y=!0;else{var b=new Oi(T,I,k,S,e);m.push(b)}}}if(!this.checkExpandTargetRangeProtected(m,e))return!1;for(var F=0;F<m.length;F++)for(var M=m[F],V=M.rowFrom(),N=M.colFrom(),O=M.rowCount(),x=M.colCount(),Z=V;Z<V+O;Z++)for(var D=N;D<N+x;D++)if(Z!==V||D!==N){var P=e.getValue(Z,D),L=e.getFormula(Z,D),B=e.getMultipleValuesJSON(Z,D);this._command._oldChangesets.unshift(this._cellValueAction(Z,D,{value:P,formula:L,multipleValues:B},!0))}return m.length&&(this._command._changesets.push(this._setSpansAction(a,m)),this._command._oldChangesets.unshift(this._setSpansAction(a,p))),y&&we.Ps3.Toast.warning({key:"pivot_table_area_cannot_merge",content:fn("CreationDoc_Sheets_PivotTable_Failed_CanNotMergeCells")}),!0}},{key:"handleSetRangeStyle",value:function(e,t,n,r){var a=e.getDefaultStyle(),o=jQ(e,n.toJSON(),{ignoreStyle:!1,ignoreValue:!0,ignoreFormulaData:!0,ignoreDataValidation:!0,ignoreReminder:!0,ignoreMultipleValues:!0,ignorePivotTable:!0,ignoreFilterRow:!0},HQ);this._setRangeValuesActionToChangeset(o,!0);var i=t.rowCount(),u=t.colCount(),s=n.rowCount(),l=n.colCount(),c=n.rowFrom(),h=n.colFrom(),f=n.toJSON();this._addRows>0&&(f.rowCount=s+this._addRows),this._addCols>0&&(f.colCount=l+this._addCols);var d=jQ(e,f,{ignoreStyle:!1,ignoreValue:!0,ignoreFormulaData:!0,ignoreDataValidation:!0,ignoreReminder:!0,ignoreMultipleValues:!0,ignorePivotTable:!0,ignoreFilterRow:!0},(function(e,t,n,o,s){var l;n.ignoreValue=!0;var f=(t-h)%u,d=(null===(l=r[(e-c)%i])||void 0===l?void 0:l[f])||a,v=o.styleRefMgr.getStyleId(d);n.styleId=v;var g=s.getSegmentArray(e,t);if(Array.isArray(g)&&g.length){var m=Z1(g,s.getCellStyle(e,t)||s.getDefaultStyle(),d),p=m.hasChanged,y=m.value;p&&(n.cellValue||(n.cellValue={}),n.ignoreValue=!1,n.cellValue.value=y)}zQ(e,t,s,o,n)}));this._setRangeValuesActionToChangeset(d)}},{key:"handleSetWidthAndHeight",value:function(e){var t=this._sheet,n=this._command,r=n.rowHeight,a=n.fromRange,o=n.colWidth,i=e.rowFrom(),u=e.colFrom(),s=e.rowCount(),l=e.colCount(),c=a.rowCount(),h=a.colCount();if(o.length>0)for(var f=0;f<l;f++){var d=u+f,v=t.getColumnWidth(d),g=o[f%h];g!==v&&(this._command._oldChangesets.unshift(this._colWidthAction(d,v)),this._command._changesets.push(this._colWidthAction(d,g)))}if(r.length>0)for(var m=0;m<s;m++){var p=i+m,y=t.getRowHeight(p),C=r[m%c];y!==C&&(this._command._oldChangesets.unshift(this._rowHeightAction(p,y)),this._command._changesets.push(this._rowHeightAction(p,C)))}}},{key:"extendFilterRange",value:function(){var e=this._sheet,t=this._command,n=t.toRange,r=t._changesets,a=t._oldChangesets,o=Kh(e,[n]),i=o.actions,u=o.oldActions;(0,we.hTd)(r,i),(0,we.hTd)(a,u)}},{key:"commandName",get:function(){return we.rvF.FORMAT_PAINTER}},{key:"getRepeatConfig",get:function(){var e=this._command,t=e.toRange,n=e.fromRange,r=n.rowCount(),a=n.colCount(),o=t.rowCount(),i=t.colCount();return{rows:Math.floor(o/r),cols:Math.floor(i/a),lastCopyRows:o%r,lastCopyCols:i%a,fromRangeRowCount:r,fromRangeColCount:a}}}]),t}(j3),e5=function(e){function t(e,n,r){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).call(this,e,n))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"execute",value:function(){return this._command.isFirstExecution?this._doAction():this._redoAction()}},{key:"checkPropsValid",value:function(){var e=this._command,t=e.shouldAutoFitCol,n=e.addRowCount,r=e.addColCount,a=e.shouldClear;return t||n||r||a}},{key:"_clearRangeValueAndStyle",value:function(){var e=this;if(this.command.shouldClear){for(var t=this._sheet,n=this._command.ranges.filter(Boolean),r=new Set,a=function(a){var o=n[a],i=t.getSpans(o,void 0,!0);if(i.length){var u=1===o.size()?i[0]:o;e._spanToChangeset(u,i,!0),e._spanToChangeset(u,null)}var s={formula:null,value:null,multipleValues:null,reminder:null},l=e.splitSelectionByFilterRow(o),c=[];e.checkRangeDuplicate(l,r,c,n),c.forEach((function(t){e._setRangeToChangeset(t,s),q1(t,(function(t,n){var r={dataValidation:null};(function(e,t,n){var r=e.hasOwnProperty("style")&&!e.style,a=e.style&&!e.style.dropdown;e.hasOwnProperty(ag)||!r&&!a||(e.dataValidation=t());var o=e.hasOwnProperty(ag)&&!e.dataValidation;if(!e.hasOwnProperty("style")&&o){var i=n();e.style=i?i.toJSON():null}})(r,(function(){return null}),e._sheet.getStyle.bind(e._sheet,t,n,void 0,!0)),e.command._changesets.push(e._cellValueAction(t,n,r))}))}))},o=0;o<n.length;o++)a(o);q1(n,(function(n,r){if(!e._isFilterRow(n)){var a={},o=t.getMultipleValues(n,r),i=t.getStyleWithDropdown(n,r,!0)||t.getDefaultStyle().clone();a.formula=t.getFormula(n,r,void 0,!0),a.formulaData=t.getFormulaData(n,r,void 0,!0),a.value=a.formula?null:t.getChangesetValue(n,r,!0),a.reminder=t.getReminderChangeset(n,r),a.multipleValues=o?o.toJSON():null,a.dataValidation=t.getDataValidationJSON(n,r,{needDeepClone:!0},!0),e._cellStyleAndValueToCS(n,r,a,i,!0,!0),i.dropdown&&!i.dropdown.isValid&&(i.dropdown.isValid=!0,e._styleToChangeset(n,r,i,!1))}}))}}},{key:"_format",value:function(){this._command.shouldAutoFitCol&&this._autoFitCols()}},{key:"_autoFitCols",value:function(){var e=this._command,t=e.pivotTableName,n=e.ranges,r=this._sheet.getPivotTableManager(),a=r.getPivotTableByName(t),o=r.getViewDataModelByName(t);if(a&&o){var i=(0,p.Z)(n,1)[0];if(i){var u=o.row.range.colCount,s=o.col.range.rowCount;u<0&&(u=0),s<0&&(s=0);var l=a.getFieldByArea(4).length,c=i.toJSON(),h=c.row,f=c.col,d=c.rowCount,v=f+u,g=c.colCount-u-l,m=a._fieldsModel.colFields.length+1;this._autoFitRangeCol(new Oi(h,v,s,g,this._sheet),m);for(var y=0;y<u;y++)this._autoFitRangeCol(new Oi(h,f+y,d,1,this._sheet));for(var C=0;C<l;C++)this._autoFitRangeCol(new Oi(h,v+g+C,d,1,this._sheet))}}else console.error("FormatPivotTableRange Error","No Pivot Table")}},{key:"_autoFitRangeCol",value:function(e,t){var n=105,r=200,a=this._sheet;if(e.isValid()){var o=function(e,t){var r=0;a.getRowVisible(e)&&(a._getSpanModel().find(e,t)||(a.getRowHeight(e)>0&&(r=a.cellWidthHint(e,t)),n<r&&(n=r)))};if(t){var i=e.toJSON(),u=i.row,s=i.col,l=i.rowCount;e.setRowFrom(u+1),e.setRowCount(l-1),q1(new Oi(u,s,1,t,this._sheet),o)}e.rowCount()>r&&e.setRowCount(r),e.colCount()>r&&e.setColCount(r),q1(e,o);for(var c=e.colFrom();c<=e.colTo();c++){var h=this._sheet._getActualColumnWidth(c);h!==n&&(this._columnWidthToChangeset(c,h,!0),this._columnWidthToChangeset(c,n,!1))}}}},{key:"_addRowCol",value:function(){var e=this._command,t=e.addRowCount,n=void 0===t?0:t,r=e.addColCount,a=void 0===r?0:r;if(n||a){var o=this._sheet,i=o.getRowCount()-1,u=o.getColumnCount()-1,s=[];n>0&&(s=this._addRows(i,i+1,n)),a>0&&(s=[].concat((0,m.Z)(this._addCols(u,u+1,a)),(0,m.Z)(s)));var l=this._sheet.getRowCount()-1,c=this._sheet.getColumnCount()-1;if(n>0&&a>0){var h=this._colStyleAction(l,c,!0);if(null!=h){var f=this._setRangeAction(new Oi(l+1,u+1,n,a,this._sheet),h.value,!0);this._command._changesets.push(f)}}(0,we.hTd)(this._command._oldChangesets,s)}}},{key:"_doAction",value:function(){if(!this.checkPropsValid())return!1;if(this._clearRangeValueAndStyle(),this._addRowCol(),this._format(),!0!==this.checkRangeValid(this._sheet.parent,this._command._changesets)||!this._command._changesets.length)return!1;var e=this._applyChangsetWithEvent(this._command._changesets,!0),t=this._command.ranges.filter(Boolean);return this._sheet.dispatch("CellRemoved",{ranges:t,sheetId:this._sheet.id()}),e}},{key:"_redoAction",value:function(){return!0===this.checkRangeValid(this._sheet.parent,this._command._changesets)&&this._applyChangsetWithEvent(this._command._changesets,!0)}},{key:"undo",value:function(){var e=this._sheet.getPivotTableManager(),t=this._command._oldChangesets.some((function(e){return"setCell"===e.action})),n=(e.getPivotInfoByName(this.command.pivotTableName)||{}).spanRange;return t&&n&&this._sheet.removeEmptyPivotTableSpan(n),this._applyChangsetWithEvent(this._command._oldChangesets,!0)}}]),t}(v4),t5=function(e){function t(e,n){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).call(this,e,n))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"execute",value:function(){if(this._command.isFirstExecution){if(this._genOldChangesets(),!this.generateActions())return!1;this.chartAdjust()}return this._command._changesets.length>0&&this._applyChangsetWithEvent(this._command._changesets,!0)}},{key:"undo",value:function(){return this._applyChangsetWithEvent(this._command._oldChangesets,!0)}},{key:"generateActions",value:function(){return this._saveChangesets()}},{key:"_saveChangesets",value:function(){var e=this._command,t={action:"freezeSheet",sheet_id:this._sheet.id(),target:{row:e.target.row,col:e.target.col}};return!!this.checkRangeValid(this._sheet.parent,[t])&&(e._changesets.push(t),!0)}},{key:"_genOldChangesets",value:function(){var e=this._sheet,t={action:"freezeSheet",sheet_id:this._sheet.id(),target:{row:e.getViewportTopRow(1),col:e.getViewportLeftColumn(1)}};this._command._oldChangesets.push(t)}},{key:"chartAdjust",value:function(){var e=this._command.target,t=e.row,n=e.col,r=this._sheet.chartModel.checkFreezeInfluence(t,n);this.appendOldChartChangeset(r)}},{key:"commandName",get:function(){return we.rvF.FREEZE_SHEET}}]),t}(j3),n5=function(e){function t(e,n){var r;return(0,y.Z)(this,t),(r=(0,d.Z)(this,(0,v.Z)(t).call(this,e,n)))._command.autoFillType=0,r._command.fillDirection=1,r}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"execute",value:function(){return this._command.isFirstExecution?this.doAction():this.redoAction()}},{key:"canExecute",value:function(){var e=this._sheet,t=this._command,n=t.startRange,r=t.fillRange;return 0!==r.colCount()&&!!e._canChange(r.rowFrom(),r.colFrom(),r.rowCount(),r.colCount())&&!r.isIntersect(n)}},{key:"redoAction",value:function(){return!0===this.checkRangeValid(this._sheet.parent,this._command._changesets)&&this._applyChangsetWithEvent(this._command._changesets)}},{key:"undo",value:function(){return this._applyChangsetWithEvent(this._command._oldChangesets)}},{key:"doAction",value:function(){if(!this.canExecute())return!1;var e=this._sheet,t=this._command.fillRange,n=this._collRangeInfo(e,t);return this.saveChangesets(n,!0),this._beforeAction(e,!0),this._executeFill(),this._afterAction(this._sheet,!0),this.extendFilterRange([t]),!!this.checkRangeValid(e.parent,this.command._changesets,!0)&&(this._applyChangsetWithEvent(this.command._changesets),!0)}},{key:"commandName",get:function(){return"horizontalFill"}}]),t}(K4),r5=function(e){function t(e,n){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).call(this,e,n))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"execute",value:function(){return this._command.isFirstExecution?this.doAction():this.redoAction()}},{key:"redoAction",value:function(){return this._applyChangsetWithEvent(this._command._changesets,!0)}},{key:"undo",value:function(){return this._applyChangsetWithEvent(this._command._oldChangesets,!0)}},{key:"doAction",value:function(){return this.generateAction(),this._applyChangsetWithEvent(this._command._changesets,!0)}},{key:"generateAction",value:function(){var e=this._command,t=e._changesets,n=e._oldChangesets,r=e.col,a=e.colCount,o=e.lockInfo,i=e.permId,u=e.creatorId;t.push(this.lockColChangeset(this._sheetId,r,a,o,i,u)),n.push(this.unLockColChangeset(this._sheetId,r,a,i))}},{key:"lockColChangeset",value:function(e,t,n,r,a,o){return{action:"lockCol",sheet_id:e,target:{col:t,col_count:n},value:{lock_info:r,perm_id:a,creator_id:o}}}},{key:"unLockColChangeset",value:function(e,t,n,r){return{action:"unlockCol",sheet_id:e,value:{perm_id:r},target:{col:t,col_count:n}}}},{key:"commandName",get:function(){return we.rvF.LOCK_COL}}]),t}(j3),a5=function(e){function t(e,n){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).call(this,e,n))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"execute",value:function(){return this._command.isFirstExecution?this.doAction():this.redoAction()}},{key:"undo",value:function(){return this._applyChangsetWithEvent(this._command._oldChangesets,!0)}},{key:"redoAction",value:function(){return this._applyChangsetWithEvent(this._command._changesets,!0)}},{key:"doAction",value:function(){return this.generateAction(),this._applyChangsetWithEvent(this._command._changesets,!0)}},{key:"generateAction",value:function(){var e=this._command,t=e._changesets,n=e._oldChangesets,r=e.row,a=e.rowCount,o=e.lockInfo,i=e.permId,u=e.creatorId;t.push(this.lockRowChangeset(this._sheetId,r,a,o,i,u)),n.push(this.unLockRowChangeset(this._sheetId,r,a,i))}},{key:"lockRowChangeset",value:function(e,t,n,r,a,o){return{action:"lockRow",sheet_id:e,target:{row:t,row_count:n},value:{lock_info:r,perm_id:a,creator_id:o}}}},{key:"unLockRowChangeset",value:function(e,t,n,r){return{action:"unlockRow",sheet_id:e,value:{perm_id:r},target:{row:t,row_count:n}}}},{key:"commandName",get:function(){return we.rvF.LOCK_ROW}}]),t}(j3),o5=function(e){function t(e,n){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).call(this,e,n))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"execute",value:function(e){return this._command.isFirstExecution?this.doAction(e):this.redoAction()}},{key:"redoAction",value:function(){return this._applyChangsetWithEvent(this._command._changesets,!0)}},{key:"undo",value:function(){return this._applyChangsetWithEvent(this._command._oldChangesets,!0)}},{key:"doAction",value:function(e){return this.generateAction(),this._applyChangsetWithEvent(this._command._changesets,!0)}},{key:"generateAction",value:function(){var e=this._command,t=e._changesets,n=e._oldChangesets,r=e.lockInfo,a=e.permId,o=e.creatorId;t.push(this.lockSheetChangeset(this._sheetId,r,a,this._sheet.name(),o)),n.push(this.unLockSheetChangeset(this._sheetId,a,this._sheet.name()))}},{key:"lockSheetChangeset",value:function(e,t,n,r,a){return{action:"lockSheet",sheet_id:e,value:{lock_info:t,perm_id:n,sheet_name:r,creator_id:a}}}},{key:"unLockSheetChangeset",value:function(e,t,n){return{action:"unlockSheet",sheet_id:e,value:{perm_id:t,sheet_name:n}}}},{key:"commandName",get:function(){return we.rvF.LOCK_SHEET}}]),t}(j3),i5=function(e){function t(){var e;return(0,y.Z)(this,t),(e=(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))).sparklineChangeInfo=new Map,e}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"beforeMergeAction",value:function(e,t){var n=t.rowFrom(),r=t.colFrom(),a=t.rowCount(),o=t.colCount(),i=this._sheet,u=i._getModel().orderedIterCellWithPos(n,r,a,o).next();if(null!=u){var s=(0,p.Z)(u,2)[1],l=s.row,c=s.col,h=i.getStyleWithDropdown(l,c)||i.getDefaultStyle();if(h=Ad.withUpdateStyle(h,{}),l===n&&c===r)e.push(this._styleAction(l,c,h));else{var f=this._getCellValue(l,c);f.style=h.toJSON(),e.push(this._cellValueAction(n,r,f)),p2(this._sheet.parent,this._command)}}}},{key:"collectAddSpanChangeset",value:function(){var e=this,t=this._command,n=t.ranges,r=t._changesets;n.forEach((function(t){e.beforeMergeAction(r,t),e.collectSparklineAction(t),r.push(e._setSpansAction(t,[t]))}))}},{key:"collectAddSpanOldChangeset",value:function(){var e=this,t=this._sheet,n=this._command,r=n.ranges,a=n._oldChangesets;r.forEach((function(n){var r=t.getSpans(n);a.push(e._setSpansAction(n,r)),e._setRangeValuesActionToChangeset(jQ(t,n.toJSON(),{needNote:!0},WQ),!0)}))}},{key:"collectSparklineAction",value:function(e){var t=this,n=e.toJSON(),r=n.row,a=n.col,o=n.rowCount,i=n.colCount;this._sheet.iterSparklineWithPos(r,a,o,i).forEach((function(e){var n=(0,p.Z)(e,2),o=n[0],i=n[1];if(i.row!==r||i.col!==a){var u=o.getGroupId();t.sparklineChangeInfo.has(u)||t.sparklineChangeInfo.set(u,[]),t.sparklineChangeInfo.get(u).push(o)}}))}},{key:"saveSparklineActions",value:function(){if(this.sparklineChangeInfo.size){var e,t=this._sheet,n=[],r={},a={},o={},i=_n(this.sparklineChangeInfo);try{for(i.s();!(e=i.n()).done;){var u=(0,p.Z)(e.value,2),s=u[0],l=u[1];l.length===t.getSparklinesByGroupId(s).length?function(){n.push(s);var e=t.getSparklineGroupByGroupId(s),r={};l.forEach((function(e){r[e.getId()]={source:e.getSource(),position:e.getPosition()}})),a[s]={sparklines:r},e&&(a[s].config=e)}():function(){var e={},t={};l.forEach((function(n){e[n.getId()]=null,t[n.getId()]={source:n.getSource(),position:n.getPosition()}})),r[s]={sparklines:e},o[s]={sparklines:t}}()}}catch(e){i.e(e)}finally{i.f()}n.length&&(this._command._changesets.push({action:"delSparklineGroup",sheet_id:this._sheetId,value:n}),this._command._oldChangesets.push({action:"addSparklineGroup",sheet_id:this._sheetId,value:a})),this._command._changesets.push({action:"updateSparklineGroup",sheet_id:this._sheetId,value:r}),this._command._oldChangesets.push({action:"updateSparklineGroup",sheet_id:this._sheetId,value:o})}}},{key:"collectRemoveSpanChangeset",value:function(){var e=this,t=this._command,n=t.ranges,r=t._changesets;n.forEach((function(t){r.push(e._setSpansAction(t))}))}},{key:"collectRemoveSpanOldChangeset",value:function(){var e=this,t=this._command,n=t.ranges,r=t._oldChangesets,a=this._sheet;n.forEach((function(t){var n=a.getSpans(t),o=n.reduce((function(e,t){return e.union(t)}),t.clone());r.push(e._setSpansAction(o,n))}))}},{key:"getProtectionInfosToAddSpanRange",value:function(){if(!this._protectionInfosToAddSpanRange){var e=this._sheet.protectionModel,t=[],n=new Oi(0,0,0,0,null);this._command.ranges.forEach((function(r){var a=e.getProtectionsByRange(r);a.length<1||a.forEach((function(e){var a,o=0,i=null,u=_n(e.ranges);try{for(u.s();!(a=u.n()).done;){var s=a.value;if(s.type===we.xj7.NORMAL){var l=s;if(n.setRowFrom(l.row),n.setRowCount(l.rowCount),n.setColFrom(l.col),n.setColCount(l.colCount),n.equal(r)||n.contain(r))return;if(r.contain(n)){i=l;break}n.isIntersect(r)&&o++}}}catch(e){u.e(e)}finally{u.f()}o<1||!i||t.push({protection:e,cellRangeToReplace:i,spanRange:r.toJSON()})}))})),this._protectionInfosToAddSpanRange=t}return this._protectionInfosToAddSpanRange}},{key:"collectSpanRangeToProtectionChangeset",value:function(){var e=this,t=this.getProtectionInfosToAddSpanRange();if(t.length){var n=this._command._changesets;t.forEach((function(t){var r=t.protection,a=t.cellRangeToReplace,o=t.spanRange,i=UI(r),u=i[we.xj7.NORMAL],s=i[we.xj7.ROW],l=i[we.xj7.COL],c=a?u.filter((function(e){return e!==a})):u,h=Object.assign({},r,{ranges:[].concat((0,m.Z)(c),[o],(0,m.Z)(s),(0,m.Z)(l))});n.push(q3(e._sheet.id(),h))}))}}},{key:"collectSpanRangeToProtectionOldChangeset",value:function(){var e=this,t=this.getProtectionInfosToAddSpanRange();if(t.length){var n=this._command._oldChangesets;t.forEach((function(t){var r=t.protection;n.push(q3(e._sheet.id(),r))}))}}},{key:"execute",value:function(){var e=this._command,t=this._sheet,n=!0;this._beforeAction(t);try{if(e.isFirstExecution&&(this.generateOldActions(),!this.generateActions()))return!1;n=this._applyChangsetWithEvent(this._command._changesets),this.command.isMerge&&this.setNewSelection(t,this._command.ranges),t.notifyShell(2)}catch(e){we.Ps3.moirae.ravenCatch(e),n=!1}finally{this._afterAction(t)}return n}},{key:"generateActions",value:function(){return this.command.isMerge?(this.collectAddSpanChangeset(),this.saveExtendFilterRangeActions(),this.saveSparklineActions()):(this.collectRemoveSpanChangeset(),this.collectSpanRangeToProtectionChangeset()),!0===this.checkRangeValid(this._sheet.parent,this._command._changesets)}},{key:"generateOldActions",value:function(){this.command.isMerge?this.collectAddSpanOldChangeset():(this.collectRemoveSpanOldChangeset(),this.collectSpanRangeToProtectionOldChangeset())}},{key:"undo",value:function(){var e=this._sheet;this._beforeAction(e);var t=!0;try{this._applyChangsetWithEvent(this._command._oldChangesets)}catch(e){we.Ps3.moirae.ravenCatch(e),t=!1}finally{this._afterAction(e)}return t}},{key:"saveExtendFilterRangeActions",value:function(){var e=this._sheet,t=this._command,n=t.ranges,r=t._changesets,a=t._oldChangesets,o=n.filter((function(t){return function(e,t){return!!t.isValid()&&null!==e.iterContent(t.rowFrom(),t.colFrom(),t.rowCount(),t.colCount()).first_if((function(e){return!(!e.variant||e.variant===ut.NULL_VAR)||!!(e.segmentArray&&e.segmentArray.length>0)||!!(e.multipleValues&&e.multipleValues.length>0)}))}(e,t)})),i=Kh(e,o),u=i.actions,s=i.oldActions;r.push.apply(r,(0,m.Z)(u)),a.push.apply(a,(0,m.Z)(s))}},{key:"setNewSelection",value:function(e,t){var n=e.getActiveRowIndex(),r=e.getActiveColumnIndex();t.forEach((function(t){t.contain(new Oi(n,r,1,1,e))&&e.setSelection(new Oi(t.rowFrom(),t.colFrom(),1,1,e))}))}},{key:"commandName",get:function(){return we.rvF.MERGE_CELLS}}]),t}(j3),u5=function(e){function t(e,n,r){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).call(this,e,n))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"_doAction",value:function(){return this.saveState(),this.extendFilterRange(),!!this.checkRangeValid(this._sheet.parent,this._command._changesets)&&this._applyChangsetWithEvent(this._command._changesets,!0)}},{key:"_redoAction",value:function(){return!0===this.checkRangeValid(this._sheet.parent,this._command._changesets)&&this._applyChangsetWithEvent(this._command._changesets,!0)}},{key:"undo",value:function(){return this._applyChangsetWithEvent(this._command._oldChangesets,!0)}},{key:"saveState",value:function(){for(var e=this,t=this._sheet,n=this._command,r=n.ranges,a=n.getValueFn,o=r.length,i={},u=0;u<o;u++){for(var s=r[u],l=s.rowFrom(),c=s.colFrom(),h=s.rowCount(),f=s.colCount(),d=JQ(t.id(),{row:l,col:c,rowCount:h,colCount:f}),v=JQ(t.id(),{row:l,col:c,rowCount:h,colCount:f}),g=function(n){if(t.filterModel.isVisible(n))for(var r=function(r){var o=e.getModifyInfo(t,n,r,a);if(o){var u=function(e,a){i.cellValue=e,i.ignoreValue=void 0===e.value&&void 0===e.formulaData,i.ignoreFormulaData=void 0===e.formulaData,i.ignoreMultipleValues=void 0===e.multipleValues,i.ignoreStyle=void 0===e.style,i.ignoreDataValidation=void 0===e.dataValidation,i.needNote=void 0!==e.note,zQ(n,r,t,a,i)};u(o.oldValue,v),u(o.newValue,d)}},o=c;o<c+f;o++)r(o)},m=l;m<l+h;m++)g(m);GQ(d),GQ(v),this._setRangeValuesActionToChangeset(d,!1,!0),this._setRangeValuesActionToChangeset(v,!0)}}},{key:"getModifyInfo",value:function(e,t,n,r){var a=r(t,n);if(a){var o={},i={};if(void 0===a.value&&void 0===a.multipleValues&&void 0===a.formula&&void 0===a.formulaData||(i.value=e.getChangesetValue(t,n),o.value=a.value,i.multipleValues=e.getMultipleValuesJSON(t,n),o.multipleValues=a.multipleValues,(e.getFormula(t,n)||e.getFormulaData(t,n))&&(i.formula=e.getFormula(t,n),i.formulaData=e.getFormulaData(t,n)),(a.formula||a.formulaData)&&(o.formula=a.formula,o.formulaData=a.formulaData)),a.style){var u=e.getStyle(t,n,void 0,!0);i.style=u.toJSON()||{},o.style=u.toJSON()||{},Object.assign(o.style,a.style)}a.dataValidation&&(i.dataValidation=e.getDataValidationJSON(t,n,{needDeepClone:!0}),o.dataValidation=a.dataValidation);var s=o.hasOwnProperty("style")&&!o.style,l=o.style&&!o.style.dropdown;return!s&&!l||o.hasOwnProperty(ag)||(i.dataValidation=e.getDataValidationJSON(t,n,{needDeepClone:!0}),o.dataValidation=e.getDataValidationJSON(t,n,{needDeepClone:!0})),i.reminder=e.getReminderChangeset(t,n),o.reminder=null,{oldValue:i,newValue:o}}}},{key:"extendFilterRange",value:function(){var e=this._sheet,t=this._command,n=t.ranges,r=t._changesets,a=t._oldChangesets,o=Kh(e,n),i=o.actions,u=o.oldActions;r.push.apply(r,(0,m.Z)(i)),a.push.apply(a,(0,m.Z)(u))}}]),t}(h4);function s5(e,t){return!(!e||!t)&&(e instanceof xi||e instanceof Ni)&&0===t.colFrom()}function l5(e,t){return!(!e||!t)&&(e instanceof Vi||e instanceof Ni)&&0===t.rowFrom()}function c5(e,t){var n=t(),r=n.do,a=n.undo,o=n.add,i=n.delete,u=null,s=null;return r&&i?u={action:"updateSparklineGroup",sheet_id:e.id(),value:(0,ie.Z)(r,i)}:r?u={action:"updateSparklineGroup",sheet_id:e.id(),value:r}:i&&(u={action:"updateSparklineGroup",sheet_id:e.id(),value:i}),a&&o?s={action:"updateSparklineGroup",sheet_id:e.id(),value:(0,ie.Z)(a,o)}:a?s={action:"updateSparklineGroup",sheet_id:e.id(),value:a}:o&&(s={action:"updateSparklineGroup",sheet_id:e.id(),value:o}),{do:u&&Object.keys(u.value).length?u:null,undo:s&&Object.keys(s.value).length?s:null}}function h5(e,t,n,r){var a,o=new gM("sparkline_fake","sparkline_fake",!0,e);o.setRowCount(Hv),o.setColumnCount(Hv);var i=o.rangeStringToRange(t);if(!i)return ut.ErrorConstant.REF;if(15===(null==i?void 0:i.refStatus()))return t||ut.ErrorConstant.REF;var u=xc(Mc(i,{ref:new Oi(n.row,n.col,1,1,o)},1),{ref:new Oi(r.row,r.col,1,1,o)}),s=Oc((0,A.default)(u,["refStatus"]),o,(function(){return o}));return kh(e,s.toString({ref:s}),null!==(a=null==u?void 0:u.refStatus)&&void 0!==a?a:0,void 0,o)||ut.ErrorConstant.REF}function f5(e,t,n,r){e[t]?e[t].sparklines?e[t].sparklines[n]=r:e[t].sparklines=(0,l.Z)({},n,r):e[t]={sparklines:(0,l.Z)({},n,r)}}function d5(e,t,n,r){e[t]?e[t][n]=r:e[t]=(0,l.Z)({},n,r)}var v5=function(e){function t(e,n){var r;(0,y.Z)(this,t),(r=(0,d.Z)(this,(0,v.Z)(t).call(this,e,n))).undoSetCellActionCells=new Map,r.isColMove=!1,r.isRowMove=!1;var a=n.fromRow,o=n.fromCol,i=n.toRow,u=n.toCol,s=n.rowCount,l=n.colCount;return r.fromSheet=r.command.fromSheet||e,r.toRange=new Oi(i,u,s,l,e),r.fromRange=new Oi(a,o,s,l,r.fromSheet),n.isColMove&&(r.isColMove=!0),n.isRowMove&&(r.isRowMove=!0),r}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"execute",value:function(){return this.command.isFirstExecution?this._doAction():this._redoAction()}},{key:"_doAction",value:function(){var e=this._sheet;if(this._beforeAction(e,!0),this.generateActions(),this._afterAction(this._sheet,!0),!0!==this.checkRangeValid(this._sheet.parent,this.command._changesets))return!1;var t=this._applyChangsetWithEvent(this.command._changesets);return t&&this.updateSelectionAfterExecute(),t}},{key:"updateSelectionAfterExecute",value:function(){this._sheet.setSelection(this.toRange)}},{key:"undo",value:function(){return this._applyChangsetWithEvent(this.command._oldChangesets,!0,"undo")}},{key:"_redoAction",value:function(){return!0===this.checkRangeValid(this._sheet.parent,this.command._changesets)&&this._applyChangsetWithEvent(this.command._changesets,void 0,"redo")}},{key:"generateActions",value:function(){var e=this,t=this._sheet;this.command._changesets.push(this._moveRangeAction(this.fromSheet.id(),t.id(),this.fromRange,this.toRange,we.xj7.NORMAL)),this.command._oldChangesets.push(this._moveRangeAction(t.id(),this.fromSheet.id(),this.toRange,this.fromRange,we.xj7.NORMAL)),this.collectRangeActions(t,this.toRange,{ignorePivotTable:!0,needNote:!0}).forEach((function(n){e.command._oldChangesets.push(n);var r=n.target,a=r.row,o=r.col;e.saveUndoCell(t,a,o)})),this.collectRangeActions(this.fromSheet,this.fromRange,{ignorePivotTable:!0}).forEach((function(n){e.command._oldChangesets.push(n);var r=n.target,a=r.row,o=r.col;e.saveUndoCell(t,a,o)})),this.saveOtherActions()}},{key:"saveOtherActions",value:function(){this.saveColWidthAndRowHeightAction(),this.saveFormulaActions(),this.saveExtendFilterRangeActions(),this.saveConditionalFormatActions(),this.saveCommentActions(),this.saveSparklineActions(),this.saveFloatImgsActions()}},{key:"saveColWidthAndRowHeightAction",value:function(){for(var e=this._sheet,t=this.fromRange.colFrom(),n=this.fromRange.colCount(),r=this.toRange.colFrom(),a=0;a<n;a++){var o=r+a,i=this.fromSheet.getColumnWidth(t+a);if(this.saveNewSetColumnWidthAction(o,i)){var u=e.getColumnWidth(o);this.command._oldChangesets.push(this._colWidthAction(o,u))}}if(this.isRowMove)for(var s=0;s<this.fromRange.rowCount();s++){var l=this.fromRange.rowFrom()+s,c=this.toRange.rowFrom()+s,h=e._getActualRowHeight(l),f=e._getActualRowHeight(c);this.command._changesets.push(this._rowHeightAction(c,h),this._rowHeightAction(l,0)),this.command._oldChangesets.push(this._rowHeightAction(c,f),this._rowHeightAction(l,h))}if(this.isColMove)for(var d=e.defaults.colWidth,v=0;v<this.fromRange.colCount();v++){var g=this.fromRange.colFrom()+v,m=this.toRange.colFrom()+v,p=e._getActualColumnWidth(g),y=e._getActualColumnWidth(m);this.command._changesets.push(this._colWidthAction(m,p),this._colWidthAction(g,d)),this.command._oldChangesets.push(this._colWidthAction(m,y),this._colWidthAction(g,p))}}},{key:"saveFormulaActions",value:function(){var e=this,t=this.fromRange.rowFrom(),n=this.fromRange.colFrom(),r=this.fromRange.rowCount(),a=this.fromRange.colCount(),o=this.toRange.rowFrom(),i=this.toRange.colFrom(),u=this.fromSheet._getModel(),s=new Map;this.fromSheet.iterContentWithPos(t,n,r,a,!0).forEach((function(r){var a=(0,p.Z)(r,2),l=a[0],c=a[1],h=c.row,f=c.col,d=h-t,v=f-n;if(e.fromSheet.isProxyArrayFormula(h,f)){var g=u.getVarByContent(l,h,f).formula;if(!s.has(g)){var m=g.getRef();e.fromRange.contain(m)?s.set(g,!0):s.set(g,!1)}s.get(g)||e.command._changesets.push({action:"setCell",sheet_id:e._sheet.id(),target:{row:o+d,col:i+v},value:{value:e.fromSheet.getValue(h,f)}})}else if(th(e.fromSheet.getVar(h,f))){var y=e.getSetCellAction(e.fromSheet,h,f),C=e._sheet.parent.importRangeManager;y.sheet_id=e._sheet.id(),y.target.row=o+d,y.target.col=i+v;var _=y.value.formulaData.externalDataReference;_&&C.setImportRangeAutoExpand("".concat(_.importRangeId,"_").concat(o+d,"_").concat(i+v)),e.command._changesets.push(y)}})),function(e,t){var n=[],r=new Set,a=e.getCalcEngine();return a.iterFormulasDependOn(t[0],!1,(function(e){return e instanceof Kc&&!r.has(e)&&(e.getRef().isValid()&&n.push(e.getRef()),!1)})),a.iterFormulasDependOn(t[1],!1,(function(e){return e instanceof Kc&&!r.has(e)&&(e.getRef().isValid()&&n.push(e.getRef()),!1)})),n}(this._sheet.parent,[this.fromRange,this.toRange]).forEach((function(t){var n=t.sheet(),r=t.rowFrom(),a=t.colFrom();if(!e.hasGenerateSetCellAction4Undo(n,r,a)&&(e.command._oldChangesets.push(e.getSetCellAction(n,r,a)),e.saveUndoCell(n,r,a),e.fromSheet.isArrayFormula(r,a))){var o=e.fromSheet.getVar(r,a);if(o.canArrayExpand()){var i=o.getArrayRef(),u=i.rowFrom(),s=i.colFrom(),l=i.rowCount(),c=i.colCount();c>1&&e.command._oldChangesets.push(e._setRangeActionCore(e.fromSheet.id(),new Oi(u,s+1,l,c-1,e.fromSheet),{value:null})),l>1&&e.command._oldChangesets.push(e._setRangeActionCore(e.fromSheet.id(),new Oi(u+1,s,l-1,1,e.fromSheet),{value:null}))}}}))}},{key:"saveExtendFilterRangeActions",value:function(){var e=this._sheet,t=this._command,n=t._changesets,r=t._oldChangesets,a=function(e,t,n){var r={actions:[],oldActions:[]};try{if(Nh(e,t.rowFrom(),t.colFrom(),t.rowCount(),t.colCount()))return r;var a=e.sheetFilterModel.filterRange;if(null!=a&&a.isValid()&&!t.contain(a)){var o=Uh(e,a,{targetRangeArr:[n],ignoreRanges:[t]});if(o>a.rowTo(!0)||n.contain(a)){var i=Wh(e,a,o,!1,!1),u=i.actions,s=i.oldActions;(0,we.hTd)(r.actions,u),(0,we.hTd)(r.oldActions,s)}}var l,c=_n(Lh(e));try{for(c.s();!(l=c.n()).done;){var h=l.value,f=h.name,d=h.id,v=h.range;if(!t.contain(v)){var g=Uh(e,v,{targetRangeArr:[n],ignoreRanges:[t]});if(g>v.rowTo(!0)||n.contain(v)){var m=Wh(e,v,g,!1,!1,f,d),p=m.actions,y=m.oldActions;(0,we.hTd)(r.actions,p),(0,we.hTd)(r.oldActions,y)}}}}catch(e){c.e(e)}finally{c.f()}}catch(e){console.error("extendFilterHelper.ts: getFilterExtendChangeSetsByMoveRange error")}return r}(e,this.fromRange,this.toRange),o=a.actions,i=a.oldActions;(0,we.hTd)(n,o),(0,we.hTd)(r,i)}},{key:"saveUndoCell",value:function(e,t,n){var r=this.undoSetCellActionCells.get(e)||new sv;r.add(t,n),this.undoSetCellActionCells.set(e,r)}},{key:"hasGenerateSetCellAction4Undo",value:function(e,t,n){var r=this.undoSetCellActionCells.get(e);return null!=r&&r.has(t,n)}},{key:"saveConditionalFormatActions",value:function(){var e=this._sheet,t=this.fromSheet,n=t.conditionalFormatModel.getAdjustedRulesByMoveRange(this.toRange,this.fromRange,e);this.setConditionalFormatChangeSet(n,t)}},{key:"setConditionalFormatChangeSet",value:function(e,t){var n=this;e.size<=0||e.forEach((function(e,r){var a=sX(t,r);if(a){var o=e.attrs,i=void 0===o?null:o,u=e.newBaseRanges,s=void 0===u?null:u,l=Object.assign({},a);null!==i&&(l.attrs=i),null!==s&&(l.ranges=s.map((function(e){return li(e,!0)})));var c=cX(t,r,l);c&&((0,we.hTd)(n._command._changesets,c.actions),(0,we.hTd)(n._command._oldChangesets,c.oldActions))}}))}},{key:"saveCommentActions",value:function(){var e=this;this.getCommentsInRange(this.toRange).forEach((function(t){var n=t.row,r=t.col,a=t.comments;e.command._oldChangesets.push(e._cellCommentsAction(n,r,a))}))}},{key:"saveSparklineActions",value:function(){var e=this,t=this._sheet.getSparklineModel(),n=this.toRange.toJSON(),r=n.row,a=n.col,o=n.rowCount,i=n.colCount,u=this.fromRange.toJSON(),s=u.row,l=u.col,c=u.rowCount,h=u.colCount,f=c5(this._sheet,(function(){var n,u=[],f=function(t){var n=t.getPosition(),r=n.row,a=n.col,o=t.getId();e.toRange.containCell(r,a)&&!e.fromRange.containCell(r,a)&&u.push(o)};return t.iter(r,a,o,i).forEach(f),t.iter(s,l,c,h).forEach(f),u.length&&u.forEach((function(e){var r=t.getSparklineById(e);if(r){var a=null==r?void 0:r.getGroupId();n||(n={}),f5(n,a,e,{source:r.getSource(),position:r.getPosition()});var o=t.getSparklineRawConfig(a);o&&(n[a].config=o)}})),{add:n}}));if(null!=f&&f.undo&&this.command._oldChangesets.push(f.undo),!this.isColMove&&!this.isRowMove){var d=c5(this._sheet,(function(){var n;return t.iter(0,0,e._sheet.getRowCount(),e._sheet.getColumnCount()).forEach((function(t){var r=t.getSourceRange();if(r){var a=t.getGroupId(),o=t.getId(),i=t.getSource();e.fromRange.isIntersect(r)&&(n||(n={}),f5(n,a,o,{source:i}))}})),{undo:n}}));(null==d?void 0:d.undo)&&this.command._oldChangesets.push(d.undo)}}},{key:"saveFloatImgsActions",value:function(){var e=this.command,t=e.hasFloatImages,n=e.isCutting;if(t||!n){var r=fk(this.fromRange,this.fromSheet);(null==r?void 0:r.length)>0&&this.seFloatImgsChangeSet(r)}}},{key:"getCommentsInRange",value:function(e){var t=e.toJSON(),n=t.row,r=t.col,a=t.rowCount,o=t.colCount,i=n+a,u=r+o,s=this._sheet.getAllComments().filter((function(e){var t=e.row,a=e.col;return t>=n&&t<i&&a>=r&&a<u}));return(0,Re.default)(s)}},{key:"seFloatImgsChangeSet",value:function(e){var t=this,n=this.fromSheet.id(),r=this._sheet.id(),a=this.fromRange.toJSON(),o=a.row,i=a.col,u=this.toRange.toJSON(),s=u.row,l=u.col,c=s-o,h=l-i;e.forEach((function(e){var a=e.floatImageId,o=e.floatImageSetting,i=o.row,u=o.col,s=dk(e,i+c,u+h,t._sheet);t._command._changesets.push(ck(a,n),lk(r,s)),t._command._oldChangesets.push(ck(s.floatImageId,r),lk(n,e))}))}},{key:"commandName",get:function(){return we.rvF.MOVE_RANGE}}]),t}(j3);var g5,m5,p5,y5,C5,_5,R5,w5,k5=function(e,t){return e.rowFrom()<=t.row&&e.rowTo()>=t.row&&e.rowTo()<t.row+t.rowCount},S5=function(e){function t(e,n){var r;return(0,y.Z)(this,t),(r=(0,d.Z)(this,(0,v.Z)(t).call(this,e,n))).rangeAdjust=function(e,t,n){var a=r._sheet.rangeModel.checkDelInfluence(e,t,n);r.appendOldRangeChangeset(r._sheet.id(),a)},r}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"canExecute",value:function(){var e,t=this._command,n=t.sourceRg,r=t.targetRg,a=this._sheet,o=!0;return function(e,t){var n=e.getSpans();if(!Array.isArray(n))return!1;var r,a=_n(n);try{for(a.s();!(r=a.n()).done;){var o=r.value;if(t.isIntersect(o)&&!t.contain(o))return!0}}catch(e){a.e(e)}finally{a.f()}return!1}(a,n)?(e=fn("sheet.error.drag_from_part_spans"),o=!1):function(e,t){var n=e.getSpans();if(!Array.isArray(n))return!1;var r,a=_n(n);try{for(a.s();!(r=a.n()).done;){var o=r.value;if(t instanceof xi){if(t.rowFrom()>o.rowFrom()&&t.rowFrom()<=o.rowTo())return!0}else if(t.colFrom()>o.colFrom()&&t.colFrom()<=o.colTo())return!0}}catch(e){a.e(e)}finally{a.f()}return!1}(a,r)?(e=fn("sheet.error.drag_to_part_spans"),o=!1):function(e,t){var n=function(e){var n=e.getFilterRange();return Boolean(k5(t,n))};return t instanceof xi&&(!!n(e.sheetFilterModel)||e.viewsModel.getViewList().some((function(e){return n(e.getFilterModel())})))}(a,n)?(e=fn("sheet.error.drag_with_filter"),o=!1):function(e,t){return t instanceof xi?e.checkRangesProtected(new xi(t.rowFrom(),1,e))&&e.checkRangesProtected(new xi(t.rowFrom()-1,1,e)):e.checkRangesProtected(new Vi(t.colFrom(),1,e))&&e.checkRangesProtected(new Vi(t.colFrom()-1,1,e))}(a,r)?(o=!1,e=fn("sheet.error.drag_to_protected")):function(e,t){for(var n=e.protectionModel.getProtectionRangesByRange(t),r=0;r<n.length;r++){var a=n[r];if(t instanceof xi&&!(a instanceof Vi))return!0;if(t instanceof Vi&&!(a instanceof xi))return!0}return!1}(a,n)&&(o=!1,e=fn("sheet.error.drag_contain_protected")),!o&&e&&we.Ps3.Toast.show({type:"error",content:e,duration:2e3}),o}},{key:"execute",value:function(){return this._command.isFirstExecution?this._doAction():this._redoAction()}},{key:"_doAction",value:function(){var e=this._command,t=e.sourceRg,n=e.targetRg;if(!this.canExecute())return this.collectEvent(t,n,"cancel"),!1;this._command.highLightRg=t;var r=this._getFinalHightRange(),a=this._sheet,o=a.getParent();return this._saveChangesets(),this._undoCsSaveOtherChangesets(),this.saveConditionalFormatActions(this._sheet,t,n),this.saveExtendFilterChangeSets(t,n),this._appendFreezeOldChangeset(),this.saveOutlineAdjustChangeSets(t,n),o.applyActions(this._command._changesets,!1,!0),r&&a.setSelection(r),this.collectEvent(t,n,"effective"),!0}},{key:"collectEvent",value:function(e,t,n){var r="drag_row";e instanceof Vi&&(r="drag_column");var a=e.sheet();we.Ps3.collectSuiteEvent("sheet_opration",{op_item:r,attr_op_status:n,source:"body",eventType:"click",object_count:e instanceof xi?e.rowCount():e.colCount(),object_id:a?a.id():"unknown"})}},{key:"_undoCsSaveOtherChangesets",value:function(){var e,t,n,r=this._sheet,a=this._command.sourceRg,o=r.chartModel,i=r.floatImageModel;a instanceof xi?(e=o.checkDelInfluence("row",a.rowFrom(),a.rowCount()),t=i.checkDelInfluence("row",a.rowFrom(),a.rowCount()),n=r.floatBlocksModel.checkDelInfluence("row",a.rowFrom(),a.rowCount()),this.rangeAdjust("row",a.rowFrom(),a.rowCount())):(e=o.checkDelInfluence("col",a.colFrom(),a.colCount()),t=i.checkDelInfluence("col",a.colFrom(),a.colCount()),n=r.floatBlocksModel.checkDelInfluence("col",a.colFrom(),a.colCount()),this.rangeAdjust("col",a.rowFrom(),a.rowCount())),this.appendOldChartChangeset(e),this.appendOldFloatImageChangeset(t),this.appendOldFloatBlockChangeset(n)}},{key:"appendOldFloatBlockChangeset",value:function(e){var t=this,n=this._command._oldChangesets;e.forEach((function(e,r){var a=e.blockType,o=e.blockSetting;n.push({action:"setFloatBlock",sheet_id:t._sheetId,value:Object.assign({},o,{blockToken:r,blockType:a})})}))}},{key:"_appendFreezeOldChangeset",value:function(){var e=this._command,t=e.sourceRg,n=e.targetRg,r=e._oldChangesets,a=this._sheet,o=a.getFrozenColumnCount(),i=a.getFrozenRowCount();o+i&&(t instanceof xi?n.rowFrom()>t.rowFrom()&&t.rowFrom()+t.rowCount()>=i&&r.push(this._freezeAction(i,o)):t instanceof Vi&&n.colFrom()>t.colFrom()&&t.colFrom()+t.colCount()>=o&&r.push(this._freezeAction(i,o)))}},{key:"_freezeAction",value:function(e,t){return{action:"freezeSheet",sheet_id:this._sheet.id(),target:{row:e,col:t}}}},{key:"_saveChangesets",value:function(){var e=this._command,t=e.sourceRg,n=e.targetRg,r=e._changesets,a=e._oldChangesets,o=this._sheet,i=t;if(t instanceof xi){n.rowFrom()<t.rowFrom()&&(i=new xi(t.rowFrom()+t.rowCount(),t.rowCount(),o)),r.push(this._addRowsAction(n.rowFrom(),t.rowCount())),r.push(this._moveRangeAction(this._sheetId,this._sheetId,i,n,we.xj7.ROW)),r.push(this._delRowsAction(i.rowFrom(),t.rowCount())),a.push(this._addRowsAction(i.rowFrom(),t.rowCount())),a.push(this._moveRangeAction(this._sheetId,this._sheetId,n,i,we.xj7.ROW)),a.push(this._delRowsAction(n.rowFrom(),t.rowCount()));var u=n;u.setRowCount(t.rowCount());var s=u.rowFrom()-t.rowFrom();this._addUndoProxyTargetChangesets(u,s,"row",a),this._addArrayFormulaChangesets(t,s,"row",r,a)}else if(t instanceof Vi){n.colFrom()<t.colFrom()&&(i=new Vi(t.colFrom()+t.colCount(),t.colCount(),o)),r.push(this._addColsAction(n.colFrom(),t.colCount())),r.push(this._moveRangeAction(this._sheetId,this._sheetId,i,n,we.xj7.COL)),r.push(this._delColsAction(i.colFrom(),t.colCount())),a.push(this._addColsAction(i.colFrom(),t.colCount())),a.push(this._moveRangeAction(this._sheetId,this._sheetId,n,i,we.xj7.COL)),a.push(this._delColsAction(n.colFrom(),t.colCount()));var l=n;l.setColCount(t.colCount());var c=l.colFrom()-t.colFrom();this._addUndoProxyTargetChangesets(l,c,"col",a),this._addArrayFormulaChangesets(t,c,"col",r,a)}return!0}},{key:"undo",value:function(){var e=this._command.highLightRg,t=this._sheet.getParent();return!!this.checkRangeValid(t,this._command._oldChangesets)&&(t.applyActions(this._command._oldChangesets,!1,!0,"undo"),e&&this._sheet.setSelection(e),!0)}},{key:"_addUndoProxyTargetChangesets",value:function(e,t,n,r){var a=e.sheet(),o=e.rowFrom(),i=e.colFrom(),u=e.rowCount(),s=e.colCount(),l=a&&a._getModel();a&&l&&l.iterContentWithPos(o,i,u,s).forEach((function(e){var o=(0,p.Z)(e,2)[1],i=o.row,u=o.col;if(a.isProxyArrayFormula(i,u)){var s=a.getVar(i,u),l="row"===n?i-t:i,c="col"===n?u-t:u,h=a.getVar(l,c);s.isSameFormula(h)||r.push({action:"setCell",sheet_id:a.id(),target:{row:l,col:c},value:{formula:a.getFormula(l,c),value:a.getValue(l,c),multipleValues:a.getMultipleValuesJSON(l,c)}})}}))}},{key:"_getSetCellChangeset",value:function(e,t,n){var r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null,a=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null;return{action:"setCell",sheet_id:n.id(),target:{row:e,col:t},value:{formula:a,value:r}}}},{key:"_addArrayFormulaChangesets",value:function(e,t,n,r,a){var o=this,i=e.sheet(),u=e.rowFrom(),s=e.colFrom(),l=e.rowCount(),c=e.colCount(),h=i&&i._getModel();h&&i&&h.iterContentWithPos(u,s,l,c).forEach((function(u){var s=(0,p.Z)(u,2)[1],h=s.row,f=s.col;if(i.isProxyArrayFormula(h,f)){var d=i.getVar(h,f),v=d.formula,g=d.getArrayRef(),m=g.rowFrom(),y=g.colFrom(),C=g.rowTo(),_=g.colTo(),R="row"===n?h+t:h,w="col"===n?f+t:f,k=e.contain(v.getRef());if(!k&&t<0&&("row"===n&&m+l>R||"col"===n&&y+c>w))r.push(o._getSetCellChangeset(R,w,i,i.getValue(h,f)));else if(!k&&t>0&&("row"===n&&C<R||"col"===n&&_<w)){var S="row"===n?R-1:R,E="col"===n?w-1:w;r.push(o._getSetCellChangeset(S,E,i,i.getValue(h,f)))}a.push(o._getSetCellChangeset(h,f,i))}}))}},{key:"_redoAction",value:function(){if(!this.canExecute())return!1;this._command.highLightRg=this._command.sourceRg;var e=this._getFinalHightRange(),t=this._sheet.getParent();return!!this.checkRangeValid(t,this._command._changesets)&&(t.applyActions(this._command._changesets,!1,!0,"redo"),e&&this._sheet.setSelection(e),!0)}},{key:"_getFinalHightRange",value:function(){var e=this._command,t=e.sourceRg,n=e.targetRg;return t instanceof xi?n.rowFrom()>=t.rowFrom()?new xi(n.rowFrom()-t.rowCount(),t.rowCount(),this._sheet):new xi(n.rowFrom(),t.rowCount(),this._sheet):t instanceof Vi?n.colFrom()>=t.colFrom()?new Vi(n.colFrom()-t.colCount(),t.colCount(),this._sheet):new Vi(n.colFrom(),t.colCount(),this._sheet):null}},{key:"saveConditionalFormatActions",value:function(e,t,n){var r=t instanceof Vi?"col":"row",a=e.conditionalFormatModel.getAdjustedRulesByMoveRowCol(e,r,t,n);this.setConditionalFormatChangeSet(a,e)}},{key:"setConditionalFormatChangeSet",value:function(e,t){var n=this;e.size<=0||e.forEach((function(e,r){var a=sX(t,r);if(a){var o=e.attrs,i=void 0===o?null:o,u=e.newBaseRanges,s=void 0===u?null:u,l=Object.assign({},a);null!==i&&(l.attrs=i),null!==s&&(l.ranges=s.map((function(e){return li(e,!0)})));var c=cX(t,r,l);c&&((0,we.hTd)(n._command._changesets,c.actions),(0,we.hTd)(n._command._oldChangesets,c.oldActions))}}))}},{key:"saveExtendFilterChangeSets",value:function(e,t){var n=this._sheet,r=this._command,a=r._changesets,o=r._oldChangesets;if(e instanceof xi){var i=function(e,t,n){var r={actions:[],oldActions:[]};try{if(Nh(e,t.rowFrom(),t.colFrom(),t.rowCount(),t.colCount()))return r;var a=e.sheetFilterModel.filterRange;if(null!=a&&a.isValid()&&!t.contain(a)){var o=Hh(e,a,{sourceRange:t,targetRange:n}),i=o.targetRow;if(o.shouldExtend){var u=qh(a,{sourceRange:t,targetRange:n}),s=u.adjustRange,l=u.offset,c=Wh(e,s,i+l,!1).actions;(0,we.hTd)(r.actions,c)}var h=Wh(e,a,i,!1).oldActions;(0,we.hTd)(r.oldActions,h)}var f,d=_n(Lh(e));try{for(d.s();!(f=d.n()).done;){var v=f.value,g=v.name,m=v.id,p=v.range;if(!t.contain(p)){var y=Hh(e,p,{sourceRange:t,targetRange:n}),C=y.targetRow;if(y.shouldExtend){var _=qh(p,{sourceRange:t,targetRange:n}),R=_.adjustRange,w=_.offset,k=Wh(e,R,C+w,!1,!1,g,m).actions;(0,we.hTd)(r.actions,k)}var S=Wh(e,p,C,!1,!1,g,m).oldActions;(0,we.hTd)(r.oldActions,S)}}}catch(e){d.e(e)}finally{d.f()}}catch(e){console.error("extendFilterHelper.ts: getFilterExtendChangeSetsByDragRow error")}return r}(n,e,t),u=i.actions,s=i.oldActions;(0,we.hTd)(a,u),(0,we.hTd)(o,s)}else(0,we.hTd)(o,function(e,t,n){var r=[];try{var a=e.id(),o=e.sheetFilterModel.filterRange;(null==o?void 0:o.isValid())&&(o.intersect(t)||o.intersect(n))&&!t.contain(o)&&r.push({action:"setFilter",sheet_id:a,target:vh(o,!0),value:null});var i,u=_n(Lh(e));try{for(u.s();!(i=u.n()).done;){var s=i.value,l=s.id,c=s.range;(null==c?void 0:c.isValid())&&(c.intersect(t)||c.intersect(n))&&!t.contain(c)&&r.push((0,we.eRv)(a,{range:vh(c),view_id:l}))}}catch(e){u.e(e)}finally{u.f()}}catch(e){console.error("extendFilterHelper.ts: getFilterExtendChangeSetsByDragRow error")}return r}(n,e,t))}},{key:"saveOutlineAdjustChangeSets",value:function(e,t){var n,r,a,o,i=function(e,t,n){var r=t.rgType,a=r===we.xj7.ROW||r===we.xj7.COL,o=[],i=[],u=[],s=[],l=[];if(!a)return{newCsAddOutline:o,newCsDelOutline:i,oldCsAddOutline:u,oldCsDelOutline:s};var c=r===we.xj7.ROW,h=e.outlineGroupModel,f=r4(t,c),d=(0,p.Z)(f,2),v=d[0],g=d[1],y=eu(v,g,c),C=eu(v-1,1,c),_=eu(v+g,1,c),R=h.getInfluencedOutlines(C).filter((function(e){return e.start+e.count===v})),w=h.getInfluencedOutlines(_).filter((function(e){return e.start===v+g})),k=r4(n,c),S=(0,p.Z)(k,2),E=S[0],T=S[1],A=E-v,I=h.getInfluencedOutlines(y),b=eu(E,1,c),F=h.getInfluencedOutlines(b).filter((function(e){return e.start!==E}));if(w.length&&R.length&&(0,ye.Z)(w.concat(R)).forEach((function(t){if(t.state===Fi.Fold){var n=eu(A>0?t.start:t.start+g,t.count,t.type===we.xj7.ROW);s.push(e4(e.id(),n,t.state))}})),I.length)I.forEach((function(t){var n=t.start,r=t.count,a=t.state,o=Ki([n,r],[v,g]);l.push([].concat((0,m.Z)(o),[a]));var s=eu(o[0],o[1],c),h=eu(o[0]+g,o[1],c);A>0?(i.push(Q3(e.id(),s)),u.push(X3(e.id(),s,a))):(i.push(Q3(e.id(),h)),u.push(X3(e.id(),h,a)))})),l.forEach((function(t){var n=eu(t[0]+A,t[1],c);o.push(X3(e.id(),n,t[2])),s.push(Q3(e.id(),n))}));else{for(var M=0;M<F.length;M++)l.push([E,T,Fi.Expand]);l.forEach((function(t){var n=eu(t[0],t[1],c);o.push(X3(e.id(),n,t[2])),s.push(Q3(e.id(),n))}))}return{newCsAddOutline:o,newCsDelOutline:i,oldCsAddOutline:u,oldCsDelOutline:s}}(this._sheet,e,t),u=i.newCsAddOutline,s=i.newCsDelOutline,l=i.oldCsAddOutline,c=i.oldCsDelOutline,h=function(e,t){return{newCsIndex:{add:e.findIndex((function(e){return"addRow"===e.action||"addCol"===e.action})),del:e.findIndex((function(e){return"delRow"===e.action||"delCol"===e.action}))},oldCsIndex:{add:t.findIndex((function(e){return"addRow"===e.action||"addCol"===e.action})),del:t.findIndex((function(e){return"delRow"===e.action||"delCol"===e.action}))}}}(this._command._changesets,this._command._oldChangesets),f=h.newCsIndex,d=h.oldCsIndex;(n=this._command._changesets).splice.apply(n,[f.add+1,0].concat((0,m.Z)(u))),(r=this._command._changesets).splice.apply(r,[f.del,0].concat((0,m.Z)(s))),(a=this._command._oldChangesets).splice.apply(a,[d.add+1,0].concat((0,m.Z)(l))),(o=this._command._oldChangesets).splice.apply(o,[d.del,0].concat((0,m.Z)(c)))}},{key:"commandName",get:function(){return we.rvF.MOVE_ROW_COL}}]),t}(j3),E5=function(e){function t(e,n,r){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).call(this,e,n))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"execute",value:function(e){return this._command.isFirstExecution?this._doAction():this._redoAction()}},{key:"undo",value:function(){return this._changesetsToAction(this._command._oldChangesets),!0}},{key:"generateActions",value:function(){return this._saveChangesets(),!!this.checkRangeValid(this._sheet.parent,this._command._changesets)}},{key:"_doAction",value:function(){return!!this.generateActions()&&this._changesetsToAction(this._command._changesets)}},{key:"_redoAction",value:function(){return!0===this.checkRangeValid(this._sheet.parent,this._command._changesets)&&this._changesetsToAction(this._command._changesets)}},{key:"_saveChangesets",value:function(){var e=this._command,t=e.sourceIndex,n=e.targetIndex;this._actionToChangesets(t,n,!1),this._actionToChangesets(n,t,!0)}},{key:"_actionToChangesets",value:function(e,t,n){var r=n?this._command._oldChangesets:this._command._changesets,a=this._sheet;r.push({action:"moveSheet",sheet_id:a.id(),value:{source:e,target:t,sheet_name:a.name()}})}},{key:"_changesetsToAction",value:function(e){return this._applySpreadChangsetWithEvent(this._sheet.parent,e,!0)}},{key:"canUndo",value:function(){return!0===this.checkRangeValid(this._sheet.parent,this._command._oldChangesets)}},{key:"commandName",get:function(){return we.rvF.MOVE_SHEET}}]),t}(j3),T5=function(e){function t(e,n,r){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).call(this,e,n))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"execute",value:function(){return!(this._command.isFirstExecution&&!this.generateActions())&&this._doAction()}},{key:"generateActions",value:function(){return this._saveChangesets(),!0===this.checkRangeValid(this._sheet.parent,this._command._changesets)}},{key:"undo",value:function(){return this._changesetsToAction(this._command._oldChangesets),!0}},{key:"_doAction",value:function(){return this._changesetsToAction(this._command._changesets),!0}},{key:"_saveChangesets",value:function(){switch(this._command.property_name||"name"){case"visibility":this.handleSetHiddenChangeSet();break;case"gridLine":this.handleSetGridLineChangeSet();break;case"tabColor":this.handleSetTabColorChangeSet();break;case"tabType":this.handleSetTabTypeChangeSet();break;default:this.handleSetNameChangeSet()}}},{key:"handleSetNameChangeSet",value:function(){var e=this._sheet.name(),t=this._command.name;this._actionToChangesets({originName:e,newName:t,isUndo:!1,property_name:"name"}),this._actionToChangesets({originName:t,newName:e,isUndo:!0,property_name:"name"})}},{key:"handleSetTabTypeChangeSet",value:function(){var e=this._sheet.name(),t=this._command.tab_type;this._actionToChangesets({originName:e,isUndo:!1,property_name:"tabType",tab_type:t,no_history:!0}),this._actionToChangesets({originName:e,isUndo:!0,property_name:"tabType",tab_type:t,no_history:!0})}},{key:"handleSetTabColorChangeSet",value:function(){var e=this._sheet.name(),t=this._sheet.tabColor.getTabColor(),n=this._command.tab_color;this._actionToChangesets({originName:e,isUndo:!1,property_name:"tabColor",tab_color:n}),this._actionToChangesets({originName:e,isUndo:!0,property_name:"tabColor",tab_color:t})}},{key:"handleSetHiddenChangeSet",value:function(){var e=this._sheet.name(),t=this._command.hidden;this._actionToChangesets({originName:e,isUndo:!1,property_name:"visibility",hidden:t}),this._actionToChangesets({originName:e,isUndo:!0,property_name:"visibility",hidden:!t})}},{key:"handleSetGridLineChangeSet",value:function(){var e=this._sheet.name(),t=this._command.grid_line_hidden;this._actionToChangesets({originName:e,isUndo:!1,property_name:"gridLine",grid_line_hidden:t}),this._actionToChangesets({originName:e,isUndo:!0,property_name:"gridLine",grid_line_hidden:!t})}},{key:"_actionToChangesets",value:function(e){var t=e.isUndo?this._command._oldChangesets:this._command._changesets,n=e.originName,r=e.newName,a=e.property_name,o=e.hidden,i=e.grid_line_hidden,u=e.tab_color,s=e.tab_type,l=e.no_history;t.push({action:"setSheet",sheet_id:this._sheet.id(),no_history:l,value:{origin_name:n,sheet_name:r||n,property_name:a,hidden:o,grid_line_hidden:i,tab_color:u,tab_type:s}})}},{key:"_changesetsToAction",value:function(e){return this._applySpreadChangsetWithEvent(this._sheet.parent,e,!0)}},{key:"commandName",get:function(){return"setSheetProperty"}}]),t}(j3);!function(e){e.DO="DO",e.UNDO="UNDO",e.REDO="REDO"}(g5||(g5={})),function(e){e[e.SUCC=0]="SUCC",e[e.FORMULA_CALC_ERR=1]="FORMULA_CALC_ERR",e[e.DIFF_FROM_OLD=2]="DIFF_FROM_OLD",e[e.DIFF_FROM_OLD_RANDOM=3]="DIFF_FROM_OLD_RANDOM"}(m5||(m5={})),function(e){e.CURRENT_WORKSHEET="currentWorksheet",e.ALL_WORKSHEET="allWorksheet",e.CURRENT_RANGES="currentRanges"}(p5||(p5={})),function(e){e.CommandError="CommandError"}(y5||(y5={})),function(e){e[e.Visible=0]="Visible",e[e.Filter=1]="Filter"}(C5||(C5={})),function(e){e[e.ArrayFormulaExpanded=0]="ArrayFormulaExpanded",e[e.StyleChanged=1]="StyleChanged"}(_5||(_5={})),function(e){e[e.SetComment=0]="SetComment",e[e.AddActiveComment=1]="AddActiveComment",e[e.RemoveActiveComment=2]="RemoveActiveComment",e[e.ClearActiveComment=3]="ClearActiveComment"}(R5||(R5={})),function(e){e[e.Add=0]="Add",e[e.Del=1]="Del",e[e.Drop=2]="Drop"}(w5||(w5={}));var A5=function(e){function t(e,n){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).call(this,e,n))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"execute",value:function(){return this._command.isFirstExecution?this.doAction():this.redoAction()}},{key:"redoAction",value:function(){return!0===this.checkRangeValid(this._sheet.parent,this._command._changesets)&&this._applyChangsetWithEvent(this._command._changesets)}},{key:"undo",value:function(){return this._applyChangsetWithEvent(this._command._oldChangesets)}},{key:"doAction",value:function(){var e=this,t=this._sheet,n=t.getParent(),r=this._command,a=r.items,o=r.find,i=r.replace,u=r.scope,s=r.condition;if(a&&1===a.length){var l=a[0];this._beforeAction(t),l&&this.replace(l,o,i,t,s)}else if(u===p5.ALL_WORKSHEET){var c,h=new Set(a.map((function(e){return e.sheetId}))),f=_n(h);try{var d=function(){var t=c.value,r=n.getSheetFromId(t),u=a.filter((function(e){return e.sheetId===t}));if(!e._replaceItem(r,o,i,u,s))return{v:!1}};for(f.s();!(c=f.n()).done;){var v=d();if("object"===(0,_.Z)(v))return v.v}}catch(e){f.e(e)}finally{f.f()}}else if(!this._replaceItem(t,o,i,a,s))return!1;return!0===this.checkRangeValid(this._sheet.parent,this._command._changesets)&&(this._applyChangsetWithEvent(this._command._changesets),1!==a.length&&u&&u!==p5.CURRENT_WORKSHEET&&u!==p5.CURRENT_RANGES?n.sheets.forEach((function(t){return e._afterAction(t)})):this._afterAction(t),!0)}},{key:"rangeIsValid",value:function(e,t,n){var r=!1;for(var a in n){var o=n[a];if(e>=o.row&&e<o.row+o.rowCount&&t>=o.col&&t<o.col+o.colCount){r=!0;break}}return r}},{key:"replaceImpl",value:function(e,t,n,r,a){var o=e.row,i=e.col;if(!this.checkCellValid(r,o,i))return{IsMatch:!1,cellValue:null};if(void 0!==a&&void 0!==a.ranges&&!this.rangeIsValid(o,i,a.ranges))return{IsMatch:!1,cellValue:null};var u="ig";void 0!==a&&"boolean"==typeof a.matchCase&&(u=a.matchCase?"igm":"gm");var s=new RegExp((0,R.Z)(t),u);void 0!==a&&a.searchRegex&&(s=new RegExp(t,u));var l=(0,we.ATv)(e.text),c=l.replace(s,n);if(void 0!==a&&a.includeFormulas&&e.hasFormula){var h="="+r.getFormula(e.row,e.col);a.matchEntireCell?h.replace(s,n)===n&&(c=n):c=h.replace(s,n)}if(c===l)return{IsMatch:!0,cellValue:null};var f=r.getChangesetValue(o,i),d=r.getStyleWithDropdown(o,i),v=r.getReminderChangeset(o,i),g=r.getMultipleValues(o,i),m=r.getFormula(o,i),p=r.getFormulaData(o,i),y={value:f,style:d,reminder:v,multipleValues:g&&g.toJSON(),formula:m,formulaData:p},C={reminder:null};if(r.getMultipleValues(o,i)&&!c.includes(",")){var _=new dm(r.parent);C.multipleValues=_.fromString(c).toJSON()}else{c=Sv._getValueAndStyleFromEditing(r,o,i,c,!0).value,C.value=c;var w=l2(o,i,r,c);if(w.isFormula){var k=w.formulaVar,S=w.text;if(!k)return{IsMatch:!1,cellValue:null};var E=wf(k,{ref:k.getRef()});if(th(k)){var T=r.getParent(),A=T.importRangeManager,I=T.importRangeManagerV3;if(I.V3Enable)I.compileImportRange(k,!0,!0);else{if(A.isImportRangeNumExceedLimit())return we.Ps3.Toast.error({key:"crossTableError_num",closable:!0,content:fn("sheet.cross_table_reference_num_limit_error")}),{IsMatch:!1,cellValue:null};var b=k.getExternalDataReferenceInfo();if(b){var F=A.generateAndCacheId(k,{sheetID:r.id(),url:b.url,range:b.range});if(F){var M=F.spreadToken,V=F.ref,N=F.isSyncStyle,O=F.importRangeId,x=F.spreadSource;E.externalDataReference={spreadToken:M,ref:V,isSyncStyle:N,importRangeId:O,spreadSource:x}}}}}return C.formula=S,C.formulaData=E,C.value=null,y.formula!==C.formula&&(this.sheetCellValueToChangeset(r.id(),o,i,y,!0),this.sheetCellValueToChangeset(r.id(),o,i,C,!1)),{IsMatch:!0,cellValue:C}}}return y.value!==C.value&&(this.sheetCellValueToChangeset(r.id(),o,i,y,!0),this.sheetCellValueToChangeset(r.id(),o,i,C,!1)),{IsMatch:!0,cellValue:C}}},{key:"replace",value:function(e,t,n,r,a){return this.replaceImpl(e,t,n,r,a).IsMatch}},{key:"_replaceItem",value:function(e,t,n,r,a){this._beforeAction(e);for(var o=0;o<r.length;o++){var i=r[o],u=i.hasFormula,s=i.hasPivotTable;if((null!=a&&a.includeFormulas||!u)&&!s&&!this.replace(r[o],t,n,e,a))return!1}return!0}},{key:"sheetCellValueToChangeset",value:function(e,t,n,r,a){(a?this._command._oldChangesets:this._command._changesets).push(this.sheetCellValueAction(e,t,n,r))}},{key:"commandName",get:function(){return we.rvF.REPLACE}},{key:"isSearchCurrentRanges",get:function(){return this._command.scope===p5.CURRENT_RANGES}}]),t}(j3),I5=function(e){function t(e,n){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).call(this,e,n))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"execute",value:function(){return this._command.isFirstExecution?this._doAction():this._redoAction()}},{key:"canUndo",value:function(){return(0,f.Z)((0,v.Z)(t.prototype),"canUndo",this).call(this)&&this._command._canUndo}},{key:"undo",value:function(){var e=this._applyChangsetWithEvent(this._command._oldChangesets);return this._raiseColumnWidthChanged(this._command._colList),e}},{key:"_doAction",value:function(){var e=!1;if(this.canExecute())try{if(!this.generateActions())return e;e=this._applyChangsetWithEvent(this._command._changesets,!0)}finally{this._afterAction(this._sheet)}return e}},{key:"generateActions",value:function(){var e=!1,t=this._command,n=t.isLocal,r=void 0!==n&&n,a=this._sheet,o=t.columns,i=o&&o.length,u=Number.MAX_VALUE;if(a&&i>0){var s=t._colList=this._getColList(o),l={sheet:a,sheetName:a.name(),colList:s,cancel:!1};if(l&&!0===l.cancel)return!1;t._canUndo=!0,this._beforeAction(a);for(var c=a._scrollLeftCol,h=c,f=a.frozenColumnCount(),d=c-1;d>=f&&!a.getColumnVisible(d);d--)h=d;for(var v=u,g=t.size,m=0;m<i;m++){var p=o[m],y=p.target;if(!this.batchSetColumnWidth(p,g,3,r))return!1;e=!0,v=Math.min(y,v)}v!==u&&v<=c&&h!==c&&(a._scrollLeftCol=h)}return e}},{key:"batchSetColumnWidth",value:function(e,t,n,r){this.batchUndoChangeset(e,n,r);var a=Math.max(1,t);return this.batchColumnWidthToChangeset(e,a,!1,r),this.checkRangeValid(this._sheet.parent,this._command._changesets)}},{key:"batchUndoChangeset",value:function(e,t,n){for(var r,a=this._sheet,o=a.getColumnCount(),i=e.target,u=e.count,s=0,l=i,c=i;c<i+u;c++)if(0<=c&&c<o){var h=a._getActualColumnWidth(c,t);void 0===r&&(r=h),h===r?s++:(this.batchColumnWidthToChangeset({target:l,count:s},r,!0,n),l=c,s=1,r=h)}s>0&&this.batchColumnWidthToChangeset({target:l,count:s},r,!0,n)}},{key:"_redoAction",value:function(){if(!0!==this.checkRangeValid(this._sheet.parent,this._command._changesets))return!1;var e=this._applyChangsetWithEvent(this._command._changesets);return this._raiseColumnWidthChanged(this._command._colList),e}},{key:"_getColList",value:function(e){for(var t=[],n=0,r=e.length;n<r;n++)for(var a=e[n],o=a.target,i=a.count,u=o;u<o+i;u++)t.push(u);return t}},{key:"_raiseColumnWidthChanged",value:function(e){var t=this._sheet,n={sheet:t,sheetName:t.name(),colList:e};t.notifyShell(13,n)}},{key:"commandName",get:function(){return we.rvF.RESIZE_COLUMN}}]),t}(j3),b5=function(e){function t(e,n){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).call(this,e,n))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"execute",value:function(){return this._command.isFirstExecution?this._doAction():this._redoAction()}},{key:"canUndo",value:function(){return(0,f.Z)((0,v.Z)(t.prototype),"canUndo",this).call(this)&&this._command._canUndo}},{key:"undo",value:function(){var e=this._applyChangsetWithEvent(this._command._oldChangesets);return this._raiseRowHeightChanged(this._command._rowList),e}},{key:"_doAction",value:function(){var e=!1;if(this.canExecute()){var t=this._command,n=t.rows,r=t._rowList=this._getRowList(n);try{if(!this.generateActions())return e;e=this._applyChangsetWithEvent(this._command._changesets,!0)}finally{this._afterAction(this._sheet)}this._raiseRowHeightChanged(r)}return e}},{key:"generateActions",value:function(){var e=!1,t=this._sheet,n=this._command,r=n.isLocal,a=void 0!==r&&r,o=n.rows,i=o&&o.length,u=Number.MAX_VALUE;if(t&&i>0){var s=n._rowList=this._getRowList(o),l={sheet:t,sheetName:t.name(),rowList:s,cancel:!1};if(l&&!0===l.cancel)return e;n._canUndo=!0,this._beforeAction(t);for(var c=t._scrollTopRow,h=c,f=t.frozenRowCount(),d=c-1;d>=f&&!t.getRowVisible(d);d--)h=d;for(var v=u,g=n.size,m=0;m<i;m++){var p=o[m],y=p.target;if(!this.batchSetRowHeight(p,g,3,a))return!1;e=!0,v=Math.min(y,v)}v!==u&&v<=c&&h!==c&&(t._scrollTopRow=h)}return e}},{key:"batchSetRowHeight",value:function(e,t,n,r){this.batchUndoChangeset(e,n,r);var a=Math.max(1,t);return this.batchRowHeightToChangeset(e,a,!1,r),this.checkRangeValid(this._sheet.parent,this._command._changesets)}},{key:"batchUndoChangeset",value:function(e,t,n){for(var r,a=this._sheet,o=a.getRowCount(),i=e.target,u=e.count,s=0,l=i,c=i;c<i+u;c++)if(0<=c&&c<o){var h=a._getActualRowHeight(c,t);void 0===r&&(r=h),h===r?s++:(this.batchRowHeightToChangeset({target:l,count:s},r,!0,n),l=c,s=1,r=h)}s>0&&this.batchRowHeightToChangeset({target:l,count:s},r,!0,n)}},{key:"_redoAction",value:function(){if(!0!==this.checkRangeValid(this._sheet.parent,this._command._changesets))return!1;var e=this._applyChangsetWithEvent(this._command._changesets);return this._raiseRowHeightChanged(this._command._rowList),e}},{key:"_getRowList",value:function(e){for(var t=[],n=0,r=e.length;n<r;n++)for(var a=e[n],o=a.target,i=a.count,u=o;u<o+i;u++)t.push(u);return t}},{key:"_raiseRowHeightChanged",value:function(e){var t=this._sheet,n={sheet:t,sheetName:t.name(),rowList:e};t.notifyShell(8,n)}},{key:"commandName",get:function(){return we.rvF.RESIZE_ROW}}]),t}(j3),F5=function(e){function t(e,n){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).call(this,e,n))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"execute",value:function(){return!(this._command.isFirstExecution&&!this._saveChangesets())&&this._applyChangsetWithEvent(this._command._changesets,!0)}},{key:"undo",value:function(){return this._applyChangsetWithEvent(this._command._oldChangesets,!0)}},{key:"creatAddChartAction",value:function(e){var t=this._sheet.id(),n={action:"setChart",sheet_id:t,target:{row:e.data.blockSetting.row,col:e.data.blockSetting.col},value:this.clearRangeInChartBlock(e.data)};return this._sheet.getChartById(e.chartId)?(console.error("chartId ".concat(e.chartId," 已经存在，不能重复 add")),!1):{cs:n,oldCs:{action:"delChart",sheet_id:t,value:{chartId:e.chartId}}}}},{key:"creatSetChartAction",value:function(e){var t=this._sheet.id(),n={action:"setChart",sheet_id:t,target:{row:e.data.blockSetting.row,col:e.data.blockSetting.col},value:this.clearRangeInChartBlock(e.data)},r=this._sheet.getChartById(e.chartId);return r?{cs:n,oldCs:{action:"setChart",sheet_id:t,target:{row:r.blockSetting.row,col:r.blockSetting.col},value:this.clearRangeInChartBlock(r)}}:(console.error("chartId ".concat(e.chartId," 不存在")),!1)}},{key:"creatDelChartAction",value:function(e){var t=this._sheet.id(),n={action:"delChart",sheet_id:t,value:{chartId:e.chartId}},r=this._sheet.getChartById(e.chartId);return r?{cs:n,oldCs:{action:"setChart",sheet_id:t,target:{row:r.blockSetting.row,col:r.blockSetting.col},value:this.clearRangeInChartBlock(r)}}:(console.error("chartId ".concat(e.chartId," 不存在")),!1)}},{key:"_saveChangesets",value:function(){var e,t=this._command;switch(t.commandType){case 1:e=this.creatSetChartAction(t);break;case 0:e=this.creatAddChartAction(t);break;case 2:e=this.creatDelChartAction(t);break;default:throw new Error("非法的 command Type")}return!!e&&(t._changesets.push(e.cs),t._oldChangesets.push(e.oldCs),!0)}},{key:"commandName",get:function(){return we.rvF.SET_CHART}}]),t}(j3),M5=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"execute",value:function(e){var t=this._sheet,n=this._command.target,r=n.row,a=n.col,o=this._command.value.comments,i=t.getComments(r,a)||[],u=(0,V.Z)(i,o).reverse();return this._command._changesets.push({sheet_id:t.id(),action:"addComments",target:this._command.target,value:this._command.value}),!0===this.checkRangeValid(t.parent,this._command._changesets)&&(t._setComments(r,a,(0,M.Z)(u,"id").reverse()),!0)}},{key:"commandName",get:function(){return we.rvF.SET_COMMENTS}}]),t}(j3),V5=function(e){function t(e,n){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).call(this,e,n))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"execute",value:function(){if(this._command.isFirstExecution){if(!this._saveChangesets())return!1}else this._sheet.dispatch("ConditionalFormatChanged",{type:"Redo"});return this._applyChangsetWithEvent(this._command._changesets,!0)}},{key:"undo",value:function(){return this._sheet.dispatch("ConditionalFormatChanged",{type:"Undo"}),this._applyChangsetWithEvent(this._command._oldChangesets,!0)}},{key:"_saveChangesets",value:function(){var e=this._sheet,t=!1,n=this._command;switch(n.commandType){case"add":t=function(e,t){var n=e.id(),r=t.cfId||BE(e),a=e.conditionalFormatModel.getLastIndex();return{actions:[{action:"addConditionalFormat",sheet_id:n,value:Object.assign({},t,{cfId:r,index:a})}],oldActions:[{action:"delConditionalFormat",sheet_id:n,value:{cfId:r,index:a}}]}}(e,n.data);break;case"set":n.cfId&&(t=cX(e,n.cfId,n.data));break;case"del":t=uX(e,n.cfIds);break;case"clearRange":t=iX(e,n.ranges,{source:n.source});break;case"move":t=function(e,t){return!(!t||void 0===t.oldIndex||void 0===t.newIndex)&&{actions:[{action:"moveConditionalFormat",sheet_id:e.id(),value:{source:t.oldIndex,target:t.newIndex}}],oldActions:[{action:"moveConditionalFormat",sheet_id:e.id(),value:{source:t.newIndex,target:t.oldIndex}}]}}(e,n.data);break;default:throw new Error("非法的 command Type")}return!!t&&((0,we.hTd)(n._changesets,t.actions),(0,we.hTd)(n._oldChangesets,t.oldActions),!0)}},{key:"commandName",get:function(){return we.rvF.SET_CONDITIONAL_FORMAT}}]),t}(j3),N5=function(e){function t(e,n){var r;return(0,y.Z)(this,t),(r=(0,d.Z)(this,(0,v.Z)(t).call(this,e,n))).execute=function(){return!(r.command.isFirstExecution&&!r.saveDataToChangesets())&&!!r.checkRangeValid(r._sheet.parent,r._command._changesets)&&r._applyChangsetWithEvent(r.command._changesets,!0)},r.undo=function(){return r._applyChangsetWithEvent(r.command._oldChangesets,!0,"undo")},r.saveSetRangeAction=function(){var e=r.command.data;return!!e&&(e.forEach((function(e){e?(r.command._changesets.push(r.getSetDataRangeAction(e)),r.command._oldChangesets.push(r.getDelDataRangeAction(e))):console.warn("Chart dataRange is null")})),!0)},r.saveDelRangeAction=function(){var e=r.command.data;return!!e&&(e.forEach((function(e){e?(r.command._changesets.push(r.getDelDataRangeAction(e)),r.command._oldChangesets.push(r.getSetDataRangeAction(e))):console.warn("Chart dataRange is null")})),!0)},r.saveDataToChangesets=function(){switch(r.command.commandType){case 0:return r.saveSetRangeAction();case 1:return r.saveDelRangeAction();default:return!1}},r}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"commandName",get:function(){return we.rvF.SET_DATA_RANGE}}]),t}(j3),O5=PX._util,x5=function(e){function t(e,n){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).call(this,e,n))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"execute",value:function(){var e=this._sheet,t=this._command,n=t.row,r=t.col,a=t._changesets,o=t.text,i=!1,u=e.getSpan(n,r);if(u&&(u.rowFrom()!==n||u.colFrom()!==r))return i;this._beforeAction(e);try{if(this._command.isFirstExecution){var s=e.getStyleWithDropdown(n,r)||e.getDefaultStyle(),l=e.getChangesetValue(n,r),c=e.getFormula(n,r),h=e.getReminderChangeset(n,r);this._cellValueToChangeset(n,r,{style:s&&s.toJSON()||null,value:l,formula:c,reminder:h},!0);var f=O5._getValueAndStyleFromEditing(e,n,r,o,!1,!0),d=f.value,v=f.styleWithDropdown;if(e.setStyle(n,r,v.clone()),(0,he.Z)(d)?e.setValue(n,r,(0,we.Tcw)(d)):e.setValue(n,r,d),v&&v.dropdown&&v.dropdown.list){var g=P1(e,n,r,v.dropdown);g!==v.dropdown.isValid&&(v.dropdown.isValid=g,e.setDropdown(n,r,v.dropdown))}if(this._cellValueToChangeset(n,r,{style:v&&v.toJSON()||null,value:e.getChangesetValue(n,r),reminder:null,formula:e.getFormula(n,r)}),!this.checkRangeValid(e.parent,a))return!1;i=this._applyChangsetWithEvent(a)}else{var m=this._sheet.getParent();if(!0!==this.checkRangeValid(m,this._command._changesets))return!1;i=this._applyChangsetWithEvent(a)}}catch(n){return we.Ps3.moirae.ravenCatch(n),this._afterAction(e),!1}return this._afterAction(e),i}},{key:"undo",value:function(){return this._applyChangsetWithEvent(this._command._oldChangesets)}},{key:"commandName",get:function(){return we.rvF.SET_DROPDOWN_VALID}}]),t}(j3),Z5=function(e){function t(e,n){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).call(this,e,n))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"execute",value:function(){return!(this._command.isFirstExecution&&!this._saveChangesets())&&this._applyChangsetWithEvent(this._command._changesets,!0)}},{key:"undo",value:function(){return this._applyChangsetWithEvent(this._command._oldChangesets,!0)}},{key:"_saveChangesets",value:function(){var e,t=this._command;switch(t.commandType){case 1:e=this.createSetAction(t);break;case 0:e=this.createAddAction(t);break;case 2:e=this.createDelAction(t);break;default:throw new Error("非法的 command Type")}return!!e&&((0,we.hTd)(t._changesets,e.cs),(0,we.hTd)(t._oldChangesets,e.oldCs),!0)}},{key:"createAddAction",value:function(e){var t=e.data,n=this._sheet.id(),r=[],a=[],o=t.blockSetting,i=t.position,u=t.blockToken,s=t.blockType,l={action:"setEmbeddedBlock",sheet_id:n,target:i,value:{blockSetting:o,blockToken:u,blockType:s}},c={action:"delEmbeddedBlock",sheet_id:n,target:i,value:{blockToken:u,blockType:s}};return r.push(l),a.push(c),{cs:r,oldCs:a}}},{key:"createSetAction",value:function(e){var t=e.data,n=this._sheet.id(),r=[],a=[],o=t.blockSetting,i=t.position,u=t.blockToken,s={action:"setEmbeddedBlock",sheet_id:n,target:i,value:{blockSetting:o,blockToken:u,blockType:t.blockType}},l=this._sheet.getEmbeddedBlockByToken(u);if(!l)throw new Error("can not find embedded block by token = ".concat(u));var c={action:"setEmbeddedBlock",sheet_id:n,target:l.position,value:{blockSetting:l.blockSetting,blockToken:l.blockToken,blockType:l.blockType}};return r.push(s),a.push(c),{cs:r,oldCs:a}}},{key:"createDelAction",value:function(e){var t=this,n=e.data,r=this._sheet.id(),a=[],o=[],i=n.blockToken,u=n.blockType,s=!n.reserveDepRanges,l=this._sheet.getEmbeddedBlockByToken(i);if(!l)throw new Error("can not find embedded block by token = ".concat(i));var c={action:"delEmbeddedBlock",sheet_id:r,target:l.position,value:{blockToken:i,blockType:u}},h={action:"setEmbeddedBlock",sheet_id:r,target:l.position,value:{blockSetting:l.blockSetting,blockToken:l.blockToken,blockType:l.blockType}};return a.push(c),o.push(h),s&&function(e,t,n){var r,a,o=null==e||null===(r=e.sheetBlocksManager)||void 0===r||null===(a=r.modelManager)||void 0===a?void 0:a.getBlockModel(n);if(!o)return[];try{if("PIVOT_TABLE"===t){var i=o.getSnapshot().rangeId,u=IA(e,i);return u?[u]:[]}return[]}catch(e){return console.error("delete embeddedBlock dep dataRange error",e),[]}}(this._sheet.parent,u,i).forEach((function(e){a.push(t.getDelDataRangeAction(e)),o.push(t.getSetDataRangeAction(e))})),{cs:a,oldCs:o}}},{key:"commandName",get:function(){return we.rvF.SET_EMBEDDED_BLOCK}}]),t}(j3),D5=function(e){function t(e,n){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).call(this,e,n))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"execute",value:function(){return J3(this._command,this._sheet,this._beforeAction.bind(this),this._doAction.bind(this),this._redoAction.bind(this),this._afterAction.bind(this))}},{key:"_doAction",value:function(e,n){var r,a=performance.now(),o=n.range,i=n.col,u=n.value,s=this._command,l=s._oldChangesets,c=s._changesets,h=e.getParent();if(o)if(null==i){var f=vh(o);r=t.getFirstSetFilterActions(e,f)}else{var d=vh(o);r=t.getSetFilterActions(e,i,u,d)}else r=t.getDeleteFilterActions(e);r&&r.actions&&c.push.apply(c,(0,m.Z)(r.actions)),r&&r.oldActions&&l.push.apply(l,(0,m.Z)(r.oldActions));var v=performance.now();return!!this.tryApplyActions(h,c)&&(this.createCsTime=v-a,this.applyCsTime=performance.now()-v,!0)}},{key:"_redoAction",value:function(e){var t=this._sheet.getParent();return!!this.checkRangeValid(t,this._command._changesets)&&this._applyChangsetWithEvent(e._changesets)}},{key:"undo",value:function(){return this._afterAction(this._sheet),this._applyChangsetWithEvent(this._command._oldChangesets)}},{key:"getPerformanceInfo",value:function(){if(void 0!==this.createCsTime&&void 0!==this.applyCsTime)return{createCsTime:this.createCsTime,applyCsTime:this.applyCsTime}}},{key:"commandName",get:function(){return we.rvF.SET_FILTER}}],[{key:"getOldSetFilterActions",value:function(e){var t=e.sheetFilterModel,n=t.getInfo();if(!n)return null;var r=vh(n.range),a=[];return a.push({action:"setFilter",sheet_id:e.id(),target:r,value:null}),(0,m.Z)(t.getValidFilterRules()).forEach((function(t){var n=(0,p.Z)(t,1)[0],o=e.sheetFilterModel.getFilterInfo(n);o&&a.push({action:"setFilter",sheet_id:e.id(),target:r,value:o})})),a}},{key:"getDeleteFilterActions",value:function(e){return e.sheetFilterModel.getInfo()?{actions:[{action:"delFilter",sheet_id:e.id()}],oldActions:t.getOldSetFilterActions(e)||[]}:null}},{key:"getFirstSetFilterActions",value:function(e,t){return{actions:[{action:"setFilter",sheet_id:e.id(),target:t,value:null}],oldActions:[{action:"delFilter",sheet_id:e.id()}]}}},{key:"getSetFilterActions",value:function(e,t,n,r){null===n&&(n={type:null,compare:0,contents:null,expected:""});var a=n,o=a.type,i=a.compare,u=a.expected,s=a.contents,l=a.dateGroups,c=e.sheetFilterModel.getFilterInfo(t),h={col:t,type:null,compare:0,expected:"",contents:null};return{actions:[{action:"setFilter",sheet_id:e.id(),target:r,value:{col:t,type:0===o?null:o,compare:i,expected:u,contents:s,filteredRowsMap:e.sheetFilterModel.filterWithNewRule(o,t,i,u,s,l),dateGroups:l}}],oldActions:[{action:"setFilter",sheet_id:e.id(),target:r,value:c?Object.assign({},c):h}]}}}]),t}(j3);function P5(e,t){var n=e.viewsModel.getViewById(t);return n&&n.getFilterModel()}var L5=function(e){function t(e,n){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).call(this,e,n))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"generateActionsForRange",value:function(e,t){var n=this._sheet,r=P5(n,t);if(r){var a=r.getFilterRange(),o=this.command,i=o._oldChangesets;o._changesets.push((0,we.eRv)(n.id(),{view_id:t,range:e?gh(e):void 0,calculate:!0})),i.push((0,we.eRv)(n.id(),{view_id:t,range:a?gh(a):void 0,calculate:!0}))}}},{key:"generateActions",value:function(e){var t=this._sheet,n=e.col,r=e.range,a=e.viewId,o=this._command,i=o.isLocal,u=o._oldChangesets,s=o._changesets,l=t.id(),c=e.value;null===c&&(c={type:null,compare:0,contents:null,expected:""});var h=P5(t,a),f={col:n,type:null,compare:0,expected:"",contents:null},d=c,v=d.type,g=d.compare,m=d.expected,p=d.dateGroups,y=d.contents;if(s.push((0,we.eRv)(l,{view_id:a,range:r?gh(r):void 0,filter_value:{col:n,type:0===v?null:v,compare:g,expected:m,contents:y,dateGroups:p,filteredRowsMap:i||null==h?void 0:h.filterWithNewRule(v,n,g,m,y,p)},calculate:!0})),h){var C=h.getFilterInfo(n);u.push((0,we.eRv)(l,{filter_value:C?Object.assign({},(0,A.default)(C,"filteredRowsMap")):f,view_id:a,range:r?gh(r):void 0,calculate:!0}))}}},{key:"execute",value:function(){return J3(this._command,this._sheet,this._beforeAction.bind(this),this._doAction.bind(this),this._redoAction.bind(this),this._afterAction.bind(this))}},{key:"_doAction",value:function(e,t){var n=t.range,r=t.col,a=t.value,o=t.viewId,i=this._command._changesets,u=e.getParent();return null==r?this.generateActionsForRange(n,o):this.generateActions({col:r,value:a,range:n,viewId:o}),!!this.tryApplyActions(u,i)}},{key:"_redoAction",value:function(e){var t=this._sheet.getParent();return!!this.checkRangeValid(t,this._command._changesets)&&this._applyChangsetWithEvent(e._changesets)}},{key:"undo",value:function(){return this._afterAction(this._sheet),this._applyChangsetWithEvent(this._command._oldChangesets)}},{key:"_afterAction",value:function(e){var n=arguments.length>1&&void 0!==arguments[1]&&arguments[1];(0,f.Z)((0,v.Z)(t.prototype),"_afterAction",this).call(this,e,n),e.dispatch("FilterChanged")}},{key:"commandName",get:function(){return we.rvF.SET_FILTER_VIEW}}]),t}(j3),B5=function(e){function t(e,n){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).call(this,e,n))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"execute",value:function(){return!(this._command.isFirstExecution&&!this._saveChangesets())&&this._applyChangsetWithEvent(this._command._changesets,!0)}},{key:"undo",value:function(){return this._applyChangsetWithEvent(this._command._oldChangesets,!0)}},{key:"_saveChangesets",value:function(){var e,t=this._command;switch(t.commandType){case 1:e=this.creatSetAction(t);break;case 0:e=this.creatAddAction(t);break;case 2:e=this.creatDelAction(t);break;default:throw new Error("非法的 command Type")}return!!e&&((0,we.hTd)(t._changesets,e.cs),(0,we.hTd)(t._oldChangesets,e.oldCs),!0)}},{key:"creatAddAction",value:function(e){var t=e.data,n=this._sheet.id(),r=[],a=[],o=t.blockSetting,i=t.blockToken,u=t.blockType,s={action:"setFloatBlock",sheet_id:n,value:Object.assign({},o,{blockToken:i,blockType:u})},l={action:"delFloatBlock",sheet_id:n,value:{blockToken:i,blockType:u}};return r.push(s),a.push(l),{cs:r,oldCs:a}}},{key:"creatSetAction",value:function(e){var t=e.data,n=this._sheet.id(),r=[],a=[],o=t.blockSetting,i=t.blockToken,u=t.blockType,s={action:"setFloatBlock",sheet_id:n,value:Object.assign({},o,{blockToken:i,blockType:u})},l=this._sheet.getFloatBlockByToken(i);if(!l)throw new Error("can not find float block by token = ".concat(i));var c={action:"setFloatBlock",sheet_id:n,value:Object.assign({},l.blockSetting,{blockToken:l.blockToken,blockType:l.blockType})};return r.push(s),a.push(c),{cs:r,oldCs:a}}},{key:"creatDelAction",value:function(e){var t=this,n=e.data,r=this._sheet.id(),a=[],o=[],i=n.blockToken,u=n.blockType;n.skipDelDepsRanges||function(e,t){if(!e||!e.sheetBlocksManager||!e.sheetBlocksManager.modelManager)return[];var n=e.sheetBlocksManager.modelManager.getBlockModel(t);if(!n||"CHART"!==n.type||!n.dimensionManager)return[];var r=n.dimensionManager,a=r.getAllDimensionRefIds()||[],o=r.getAllBaseDimensionRefIds()||[],i=(0,ye.Z)([].concat((0,m.Z)(a),(0,m.Z)(o)));return f3(e,i)}(this._sheet.parent,i).forEach((function(e){e&&(a.push(t.getDelDataRangeAction(e)),o.push(t.getSetDataRangeAction(e)))}));var s={action:"delFloatBlock",sheet_id:r,value:{blockToken:i,blockType:u}},l=this._sheet.getFloatBlockByToken(i);if(!l)throw new Error("can not find float block by token = ".concat(i));var c={action:"setFloatBlock",sheet_id:r,value:Object.assign({},l.blockSetting,{blockToken:l.blockToken,blockType:l.blockType})};return a.push(s),o.push(c),{cs:a,oldCs:o}}},{key:"commandName",get:function(){return we.rvF.SET_FLOAT_BLOCK}}]),t}(j3);var U5=function(e){function t(e,n){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).call(this,e,n))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"execute",value:function(){return!(this._command.isFirstExecution&&!this._saveChangesets())&&this._applyChangsetWithEvent(this._command._changesets,!0)}},{key:"undo",value:function(){return this._applyChangsetWithEvent(this._command._oldChangesets,!0)}},{key:"creatAddAction",value:function(e){var t=this,n=e.data,r=this._sheet.id(),a=[],o=[];return n.forEach((function(e){var n={action:"setFloatImage",sheet_id:r,target:{row:e.floatImageSetting.row,col:e.floatImageSetting.col},value:t.clearRangeInFloatImageBlock(e)},i={action:"delFloatImage",sheet_id:r,value:{floatImageId:e.floatImageId}};a.push(n),o.push(i)})),{cs:a,oldCs:o}}},{key:"creatSetAction",value:function(e){var t=this,n=e.data,r=this._sheet.id(),a=[],o=[];return n.forEach((function(e){var n={action:"setFloatImage",sheet_id:r,target:{row:e.floatImageSetting.row,col:e.floatImageSetting.col},value:t.clearRangeInFloatImageBlock(e)},i=t._sheet.getFloatImageById(e.floatImageId);if(i){var u={action:"setFloatImage",sheet_id:r,target:{row:i.floatImageSetting.row,col:i.floatImageSetting.col},value:t.clearRangeInFloatImageBlock(i)};a.push(n),o.push(u)}})),!!o.length&&{cs:a,oldCs:o}}},{key:"creatDelAction",value:function(e){var t=this,n=this._sheet.id(),r=e.floatImageIds,a=[],o=[];return r.forEach((function(e){var r={action:"delFloatImage",sheet_id:n,value:{floatImageId:e}},i=t._sheet.getFloatImageById(e);if(i){var u={action:"setFloatImage",sheet_id:n,target:{row:i.floatImageSetting.row,col:i.floatImageSetting.col},value:t.clearRangeInFloatImageBlock(i)};a.push(r),o.push(u)}})),!!o.length&&{cs:a,oldCs:o}}},{key:"_saveChangesets",value:function(){var e,t=this._command;switch(t.commandType){case 1:e=this.creatSetAction(t);break;case 0:e=this.creatAddAction(t);break;case 2:e=this.creatDelAction(t);break;default:throw new Error("非法的 command Type")}return!!e&&((0,we.hTd)(t._changesets,e.cs),(0,we.hTd)(t._oldChangesets,e.oldCs),!0)}},{key:"commandName",get:function(){return we.rvF.SET_FLOAT_IMAGE}}]),t}(j3),H5=function(e){function t(e,n){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).call(this,e,n))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"_setRangeFormat",value:function(){var e=this,t=this._command,n=t.selections,r=t.value,a=this._sheet,o=this._sheet.getParent(),i={},u={ignoreValue:!0,ignoreFormulaData:!0,ignoreMultipleValues:!0,ignoreReminder:!0,ignoreDataValidation:!0,ignorePivotTable:!0};return i[dd]=(0,Se.createFormatter)(a.formatterService,r).toJSON()||"",void 0===r&&(i[gd]=(0,Se.createFormatter)(a.formatterService).toJSON()||""),this.filterDuplicateRange(n,!0).forEach((function(t){e._rangeOpToChangeset(t,{style:i})})),!0===this.checkRangeValid(o,this._command._changesets)&&(n.forEach((function(t){e._setRangeValuesActionToChangeset(jQ(a,t.toJSON(),u,WQ),!0)})),this._applyChangsetWithEvent(this._command._changesets))}},{key:"_doAction",value:function(){return this._setRangeFormat()}},{key:"_redoAction",value:function(){return!0===this.checkRangeValid(this._sheet.parent,this._command._changesets)&&this._applyChangsetWithEvent(this._command._changesets)}},{key:"execute",value:function(){var e=!1,t=this._sheet;this._beforeAction(t);try{if(!(e=this._command.isFirstExecution?this._doAction():this._redoAction()))return!1}catch(e){return this._afterAction(t),we.Ps3.moirae.ravenCatch(e),!1}return this._afterAction(t),e}},{key:"undo",value:function(){return this._applyChangsetWithEvent(this._command._oldChangesets,!0)}},{key:"commandName",get:function(){return we.rvF.SET_FORMATTER}}]),t}(j3),W5=function(e){function t(e,n){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).call(this,e,n))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"execute",value:function(){var e=this._sheet,t=this._command._changesets,n=!1;this._beforeAction(e);try{if(this._command.isFirstExecution){if(this.doAction(),!this.checkRangeValid(e.parent,t))return!1;n=this._applyChangsetWithEvent(t)}else{var r=this._sheet.getParent();if(!0!==this.checkRangeValid(r,this._command._changesets))return!1;n=this._applyChangsetWithEvent(t)}}catch(t){return we.Ps3.moirae.ravenCatch(t),this._afterAction(e),!1}return this._afterAction(e),n}},{key:"undo",value:function(){return this._applyChangsetWithEvent(this._command._oldChangesets)}},{key:"doAction",value:function(){var e=this,t=this._sheet;q1(this._command.selections,(function(n,r){ym(t,n,r)&&e._cellValueToMultipleValuesChangeset(n,r)}))}},{key:"_cellValueToMultipleValuesChangeset",value:function(e,t){var n=this._sheet;if(null==n.getMultipleValues(e,t)){var r=n.getChangesetValue(e,t);this._cellValueToChangeset(e,t,{value:r},!0);var a=Cm(n,e,t);n.setValue(e,t,a),this._cellValueToChangeset(e,t,{multipleValues:a.toJSON()})}}},{key:"commandName",get:function(){return we.rvF.SET_MULTIPLE_VALUES_BY_RANGE}}]),t}(j3);function j5(e,t,n,r,a){var o=new Map,i=new Map,u=jQ(e,t.toJSON(),n,(function(e,t,n,u,s){var l,c=(null==a?void 0:a.get(e,t))||s.getCellStyle(e,t)||s.getDefaultStyle();if(void 0===(l=o.get(c))){var h=r(c,e,t);l=u.styleRefMgr.getStyleId(h),o.set(c,l),i.set(l,h),null==a||a.set(e,t,h)}else null==a||a.set(e,t,i.get(l));n.styleId=l,zQ(e,t,s,u,n)}));return o.clear(),u}var z5,G5,J5=void 0,q5=function(e,t){return e.rowFrom()===t.rowFrom()?e.colFrom()-t.colFrom():e.rowFrom()-t.rowFrom()},$5=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"setRangeBorder",value:function(e){var t,n,r,a,o=e.selection,i=e.row,u=e.col,s=e.style,l=e.border,c=e.color,h=o.rowFrom()>-1?o.rowFrom():0,f=h+o.rowCount()-1,d=o.colFrom()>-1?o.colFrom():0,v=d+o.colCount()-1;if("noborder"===l)return Ad.withBorders(s,{borderLeft:J5,borderTop:J5,borderRight:J5,borderBottom:J5,diagonal:J5,diagonalUp:J5,diagonalDown:J5},!0,"noborder");if(!c)throw new Error("no color");var g=new hd(c,1),m=new hd(c,1,Qf.thin);switch(l){case"fullborder":return Ad.withBorders(s,{borderLeft:g,borderTop:g,borderRight:g,borderBottom:g},!0);case"outerborder":i===h&&(r=g),i===f&&(a=g),u===d&&(t=g),u===v&&(n=g);break;case"innerborder":i!==h&&(r=g),i!==f&&(a=g),u!==d&&(t=g),u!==v&&(n=g);break;case"leftborder":u===d&&(t=g);break;case"rightborder":u===v&&(n=g);break;case"topborder":i===h&&(r=g);break;case"bottomborder":i===f&&(a=g);break;case"diagonalup":return Ad.withBorders(s,{diagonal:m,diagonalUp:!0},!1,"diagonalup");case"diagonaldown":return Ad.withBorders(s,{diagonal:m,diagonalDown:!0},!1,"diagonaldown")}return Ad.withBorders(s,{borderLeft:t,borderRight:n,borderBottom:a,borderTop:r},!1)}},{key:"_setRangeStyle",value:function(){var e=this,t=this._sheet,n=this._command,r=n.prop,a=n.selections,o=n.value,i=new lv,u=!0;if(q1(a,(function(n,r){e.checkCellValid(t,n,r)||(u=!1)})),!u)return!1;var s={ignoreStyle:!1,ignoreValue:!0,ignoreFormulaData:!0,ignoreDataValidation:!0,ignoreReminder:!0,ignoreMultipleValues:!0,ignorePivotTable:!0,ignoreFilterRow:!0},c={styleId:void 0,ignoreStyle:!1,ignoreValue:!0,ignoreFormulaData:!0,ignoreDataValidation:!0,ignoreReminder:!0,ignoreMultipleValues:!0,ignorePivotTable:!0,ignoreFilterRow:!0},h=a.length>1;h&&a.sort(q5);var f=h?i:void 0;return a.forEach((function(n){var a=jQ(t,n.toJSON(),s,HQ);if(e._setRangeValuesActionToChangeset(a,!0),"frame"===r){var i=o.border,u=o.color,h=function(e,t){var n=e.sheet(),r=Math.max(e.rowFrom(),0),a=r+e.rowCount()-1,o=Math.max(e.colFrom(),0),i=o+e.colCount()-1,u=e.rowCount(),s=e.colCount(),l=null==n?void 0:n.getRowCount(),c=null==n?void 0:n.getColumnCount(),h={};switch(t){case"noborder":case"outerborder":case"fullborder":r-1>=0&&(h.borderBottom=new Oi(r-1,o,1,s,n)),l&&a+1<l&&(h.borderTop=new Oi(a+1,o,1,s,n)),o-1>=0&&(h.borderRight=new Oi(r,o-1,u,1,n)),c&&i+1<c&&(h.borderLeft=new Oi(r,i+1,u,1,n));break;case"diagonaldown":case"diagonalup":case"innerborder":break;case"leftborder":o-1>=0&&(h.borderRight=new Oi(r,o-1,u,1,n));break;case"rightborder":c&&i+1<c&&(h.borderLeft=new Oi(r,i+1,u,1,n));break;case"topborder":r-1>=0&&(h.borderBottom=new Oi(r-1,o,1,s,n));break;case"bottomborder":l&&a+1<l&&(h.borderTop=new Oi(a+1,o,1,s,n))}return h}(n,i),d=function(n){var r=h[n],a=j5(t,r,c,(function(e){return Ad.delBorder(e,n)}),f);e._setRangeValuesActionToChangeset(a)};for(var v in h)d(v);(function(e,t){var n=e.sheet(),r=Math.max(e.rowFrom(),0),a=r+e.rowCount()-1,o=Math.max(e.colFrom(),0),i=o+e.colCount()-1,u=e.rowCount(),s=e.colCount(),l=[];switch(t){case"diagonalup":case"diagonaldown":case"fullborder":case"noborder":return[e];case"innerborder":case"outerborder":if(u*s==1)return[e];if(1===u)return l.push(new Oi(r,o,1,1,n),new Oi(r,i,1,1,n)),s>=3&&l.push(new Oi(r,o+1,1,s-2,n)),l;if(1===s)return l.push(new Oi(r,o,1,1,n),new Oi(a,o,1,1,n)),u>=3&&l.push(new Oi(r+1,o,u-2,1,n)),l;var c=new Oi(r,o,1,1,n),h=new Oi(a,o,1,1,n),f=new Oi(r,i,1,1,n),d=new Oi(a,i,1,1,n);if(l.push(c,f,h,d),u>=3){var v=new Oi(r+1,o,u-2,1,n),g=new Oi(r+1,i,u-2,1,n);l.push(v,g)}if(s>=3){var m=new Oi(r,o+1,1,s-2,n),p=new Oi(a,o+1,1,s-2,n);l.push(m,p)}if(s>=3&&u>=3){var y=new Oi(r+1,o+1,u-2,s-2,n);l.push(y)}break;case"leftborder":l.push(new Oi(r,o,u,1,n));break;case"rightborder":l.push(new Oi(r,i,u,1,n));break;case"topborder":l.push(new Oi(r,o,1,s,n));break;case"bottomborder":l.push(new Oi(a,o,1,s,n))}return l})(n,i).forEach((function(r){var a=j5(t,r,c,(function(t,r,a){return e.setRangeBorder({selection:n,row:r,col:a,style:t,border:i,color:u})}),f);e._setRangeValuesActionToChangeset(a)}))}else{var g=j5(t,n,c,(function(e){return e[r]!==o?Ad.withUpdateStyle(e,(0,l.Z)({},r,o)):e}));e._setRangeValuesActionToChangeset(g)}})),i.clear(),this._applyChangsetWithEvent(this._command._changesets,!0)}},{key:"_updateRangeStyle",value:function(){var e=this,t=this._sheet,n=this._sheet.getParent(),r=this._command,a=r.prop,o=r.selections,i=r.value,u={};u[a]=i;var s=this.filterDuplicateRange(o,!0);if(s.forEach((function(t){e._rangeOpToChangeset(t,{style:u})})),!0!==this.checkRangeValid(n,this._command._changesets))return!1;var l={ignoreStyle:!1,ignoreValue:!0,ignoreFormulaData:!0,ignoreDataValidation:!0,ignoreReminder:!0,ignoreMultipleValues:!0,ignorePivotTable:!0,ignoreFilterRow:!0};return s.forEach((function(n){var r=jQ(t,n.toJSON(),l,HQ);e._setRangeValuesActionToChangeset(r,!0)})),this._applyChangsetWithEvent(this._command._changesets,!0)}},{key:"execute",value:function(){var e=!1,t=this._sheet,n=this._command;this._beforeAction(t);try{e=n.isFirstExecution?this.doAction():this.redoAction()}catch(e){return we.Ps3.moirae.ravenCatch(e),!1}finally{this._afterAction(t)}return e}},{key:"doAction",value:function(){var e=this._command.prop;return["fontSize","frame"].includes(e)?this._setRangeStyle():this._updateRangeStyle()}},{key:"redoAction",value:function(){return this._applyChangsetWithEvent(this._command._changesets,!0)}},{key:"undo",value:function(){return this._applyChangsetWithEvent(this._command._oldChangesets,!0)}},{key:"commandName",get:function(){return we.rvF.SET_RANGE_STYLE}}]),t}(j3),Y5=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"_doAction",value:function(){var e=!1,t=this._sheet;this._beforeAction(t,!0);try{if(!this.generateActions())return!1;e=this._applyChangsetWithEvent(this._command._changesets,!0),t._raiseCellChanged()}finally{this._afterAction(t,!0)}return e}},{key:"generateActions",value:function(){var e=this._sheet,t=this._command,n=t.row,r=t.col,a=t.reminder,o=t.cellValue,i=e.getSpan(n,r);return(!i||i.rowFrom()===n&&i.colFrom()===r)&&!!this.checkCellValid(e,n,r)&&(this._setCellValue(n,r,o,null,null,void 0,a),!0)}},{key:"commandName",get:function(){return we.rvF.SET_REMINDER}}]),t}(f4);!function(e){e.ADD="add",e.DEL="del",e.ADD_AND_DEL="add_and_del"}(z5||(z5={})),function(e){e.ROW="row",e.COL="col"}(G5||(G5={}));var K5=function(e){function t(e,n){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).call(this,e,n))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"generateActions",value:function(){var e=this,t=this._command,n=t.type,r=t.method,a=t.source,o=t.target,i=t.count,u=this.sortRanges(this._command.ranges)||[{type:n,method:r,source:a,target:o,count:i}],s=(0,m.Z)(this._command._oldChangesets),l=[],c=[];return u.forEach((function(t){var n=[];"add"===r?n=e.genAddAction(t,c,t.isCopyStyle):"del"===r&&(n=e.genDelAction(t,c)),(0,we.hTd)(l,n)})),this._command._oldChangesets=c.reverse().reduce((function(e,t){for(var n=0;n<t.length;n++)e.push(t[n]);return e}),s),!!l.length&&(l.forEach((function(t){e.chartAdjust(t),e.rangeAdjust(t),e.floatImageAdjust(t),e.conditionalFormatAdjust(t),e.floatBlockAdjust(t),e.pivotTablePositionAdjust(t),e.outlinePositionAdjust(t),e.pushAddsparklineAction(t),e.protectionAdjust(t)})),this.filterRangeAdjust(),!0)}},{key:"_doAction",value:function(){return!!this.generateActions()&&this.applyActions()}},{key:"appendToChangeset",value:function(e){if(e){var t=e.actions,n=e.oldActions;t&&(0,we.hTd)(this._command._changesets,t),n&&(0,we.hTd)(this._command._oldChangesets,n)}}},{key:"applyActions",value:function(){return 0!==this._command._changesets.length&&this.tryApplyActions(this._sheet.parent,this._command._changesets,!0)}},{key:"genAddAction",value:function(e,t,n){var r=e.type,a=e.method,o=e.target,i=e.count,u=e.source,s=e.size,l={type:r,method:a,target:o,count:i,source:u,size:s};return"row"===r?t.push(this._addRows(u,o,i,s,n)):t.push(this._addCols(u,o,i,s,n)),[l]}},{key:"genDelAction",value:function(e,t){var n=e.type,r=e.method,a=e.target,o=e.count,i={type:n,method:r,target:a,count:o,source:e.source};return"row"===n?t.push(this._delRows(a,o)):t.push(this._delCols(a,o)),[i]}},{key:"sortRanges",value:function(e){return e&&1!==e.length?e.sort((function(e,t){return t.target-e.target})):e}},{key:"_delRows",value:function(e,t){var n="row",r=sh(new xi(e,t,this._sheet)).map((function(e){return{target:e.rowFrom(),count:e.rowCount()}})),a=this._command._oldChangesets;this._command._oldChangesets=[];for(var o=r.length-1;o>=0;o--){var i=r[o];this._command._changesets.push(this._delRowsAction(i.target,i.count))}for(var u=0;u<r.length;u++){var s=r[u];this._command._oldChangesets.push(this._addRowsAction(s.target,s.count))}for(var l=0;l<r.length;l++){var c=r[l];this._saveUndoRange(n,c.target,c.count),this._sizeToChangeset(n,c.target,c.count),this._fIdToChangeset(n,c.target,c.count),this.hiddenRowsToChangeset(c.target,c.count)}this._delRowSpansToChangeset(e,t,r);var h=this._command._oldChangesets;return this._command._oldChangesets=a,h}},{key:"hiddenRowsToChangeset",value:function(e,t){for(var n,r=this._sheet,a=this._sheetId,o=0;o<t;o++)r.getRowVisible(e+o,!0)?n&&(this._command._oldChangesets.push(n),n=void 0):n?n.target.row_count=n.target.row_count+1:n={action:"hideRow",sheet_id:a,target:{row:e+o,row_count:1}};n&&this._command._oldChangesets.push(n)}},{key:"_delCols",value:function(e,t){var n="col",r=this._command._oldChangesets;this._command._oldChangesets=[],this._command._changesets.push(this._delColsAction(e,t)),this._command._oldChangesets.push(this._addColsAction(e,t)),this._saveUndoRange(n,e,t),this._delColSpansToChangeset(e,t),this._sizeToChangeset(n,e,t),this._fIdToChangeset(n,e,t),this.hiddenColToChangeset(e,t);var a=this._command._oldChangesets;return this._command._oldChangesets=r,a}},{key:"hiddenColToChangeset",value:function(e,t){var n=this,r=this._sheet,a=this._sheetId;r._getColInfos().iterVisible(e,e+t).filter((function(e){return!1===e.value})).forEach((function(e){var t=e.index,r=e.count;n._command._oldChangesets.push({action:"hideCol",sheet_id:a,target:{col:t,col_count:r}})}))}},{key:"_saveUndoRange",value:function(e,t,n){var r=this,a=this._sheet,o="row"===e?t:0,i="col"===e?t:0,u="row"===e?n:a.getRowCount(),s="col"===e?n:a.getColumnCount(),l=jQ(a,{row:o,col:i,rowCount:u,colCount:s},{needNote:!0},(function(e,t,n,a,o){var i=o.getComments(e,t);i&&r._cellCommentsToChangeset(e,t,i,!0),WQ(e,t,n,a,o)}));this._setRangeValuesActionToChangeset(l,!0)}},{key:"_sizeToChangeset",value:function(e,t,n){for(var r=this._sheet,a=t;a<t+n;a++)if("row"===e){var o=r._getActualRowHeight(a);this._rowHeightToChangeset(a,o,!0)}else{var i=r.getColumnWidth(a);this._columnWidthToChangeset(a,i,!0)}}},{key:"_fIdToChangeset",value:function(e,t,n){for(var r=this._sheet,a=t;a<t+n;a++)if("row"===e){var o=r.getRowColProperty(a,"fId",!0);o&&this._rowFIdToChangeset(a,o,!0)}else{var i=r.getRowColProperty(a,"fId",!1);i&&this._columnFIdToChangeset(a,i,!0)}}},{key:"_delRowSpansToChangeset",value:function(e,t,n){var r=this,a=this._sheet,o=a.getSpans(new xi(e,t,a),void 0,!0);o=o.filter((function(e){for(var t=e.rowFrom(),r=e.rowTo(!0),a=0;a<n.length;a++){var o=n[a];if(o.target>r)return!1;if(!(o.target+o.count-1<t)&&(o.target<=t||o.target+o.count-1>=r))return!0}return!1})),o.forEach((function(e){r._spanToChangeset(e,[e],!0)}))}},{key:"_delColSpansToChangeset",value:function(e,t){var n=this,r=this._sheet,a=r.getSpans(new Vi(e,t,r),void 0,!0);a=a.filter((function(n){var r=n.colFrom(),a=n.colTo(!0);return!(e>a||e+t-1<r||!(e<=r||e+t-1>=a))})),a.forEach((function(e){n._spanToChangeset(e,[e],!0)}))}},{key:"_redoAction",value:function(){return!0===this.checkRangeValid(this._sheet.parent,this._command._changesets)&&this._applyChangsetWithEvent(this._command._changesets,!0,"redo")}},{key:"execute",value:function(){var e=!1,t=this._sheet;this._beforeAction(t,!0);try{e=this._command.isFirstExecution?this._doAction():this._redoAction()}catch(e){return this._afterAction(t,!0),we.Ps3.moirae.ravenCatch(e),!1}return this._afterAction(t,!0),e}},{key:"undo",value:function(){var e=this._sheet;this._beforeAction(e,!0);try{this._applyChangsetWithEvent(this._command._oldChangesets,!0,"undo")}catch(t){return we.Ps3.moirae.ravenCatch(t),this._afterAction(e,!0),!1}return this._afterAction(e,!0),!0}},{key:"chartAdjust",value:function(e){var t=this._sheet,n=e.type,r=e.method,a=e.target,o=e.count;if("del"===r){var i=t.chartModel.checkDelInfluence(n,a,o);this.appendOldChartChangeset(i)}}},{key:"rangeAdjust",value:function(e){var t=e.type,n=e.method,r=e.target,a=e.count;if("del"===n){var o=this._sheet.rangeModel.checkDelInfluence(t,r,a);this.appendOldRangeChangeset(this._sheet.id(),o)}}},{key:"floatImageAdjust",value:function(e){var t=this._sheet,n=e.type,r=e.method,a=e.target,o=e.count;if("del"===r){var i=t.floatImageModel.checkDelInfluence(n,a,o);this.appendOldFloatImageChangeset(i)}}},{key:"floatBlockAdjust",value:function(e){var t=this._sheet,n=e.type,r=e.method,a=e.target,o=e.count;if("del"===r){var i=t.floatBlocksModel.checkDelInfluence(n,a,o);this.appendOldFloatBlockChangeset(i)}}},{key:"appendOldFloatBlockChangeset",value:function(e){var t=this,n=this._command._oldChangesets;e.forEach((function(e,r){var a=e.blockType,o=e.blockSetting;n.push({action:"setFloatBlock",sheet_id:t._sheetId,value:Object.assign({},o,{blockToken:r,blockType:a})})}))}},{key:"conditionalFormatAdjust",value:function(e){var t=this._sheet,n=e.type,r=e.source,a=e.method,o=e.target,i=e.count;if("add"===a){var u=t.conditionalFormatModel.getRulesByAddRowCol(n,r,o,i);u.size>0&&this.pushSetConditionalFormatActions(u)}if("del"===a){var s=t.conditionalFormatModel.getRulesByDelRowCol(n,o,i),l=[],c=new Map;s.forEach((function(e,t){var n=e.subRange,r=void 0===n?null:n;0===(null==r?void 0:r.length)?l.push(t):c.set(t,e)})),l.length&&this.pushDeleteConditionalFormatActions(l),c.size&&this.pushModifiedConditionalFormatActionsToChangeset(c)}}},{key:"pushSetConditionalFormatActions",value:function(e){var t=this,n=this._sheet;e.forEach((function(e,r){var a=sX(n,r);if(a){var o=Object.assign({},a),i=e.attrs,u=void 0===i?null:i,s=e.ranges,l=void 0===s?null:s;null!==u&&(o.attrs=u),null!==l&&(o.ranges=function(e){return e.getRanges().map((function(e){return li(e,!0)}))}(l));var c=cX(n,r,o);c&&((0,we.hTd)(t._command._changesets,c.actions),(0,we.hTd)(t._command._oldChangesets,c.oldActions))}}))}},{key:"pushDeleteConditionalFormatActions",value:function(e){var t=uX(this._sheet,e);t&&((0,we.hTd)(this._command._changesets,t.actions),(0,we.hTd)(this._command._oldChangesets,t.oldActions))}},{key:"pushModifiedConditionalFormatActionsToChangeset",value:function(e){var t=this,n=this._sheet,r=n.id();e.forEach((function(e,a){var o=e.subRange,i=void 0===o?null:o,u=e.attrs,s=void 0===u?null:u,l=e.newBaseRanges,c=void 0===l?null:l;if(i&&!s){var h=lX(t._sheet,a);if(h){var f={action:"setConditionalFormat",sheet_id:r,value:h};t._command._oldChangesets.push(f)}}else{var d=sX(n,a);if(!d)return;var v=Object.assign({},d);null!==s&&(v.attrs=s),null!==c&&(v.ranges=c.map((function(e){return li(e,!0)})));var g=cX(n,a,v);g&&((0,we.hTd)(t._command._changesets,g.actions),(0,we.hTd)(t._command._oldChangesets,g.oldActions))}}))}},{key:"pushAddsparklineAction",value:function(e){var t=e.type,n=e.method,r=e.target,a=e.count;if("del"===n){var o,i,u,s,l=this._sheet.getSparklineModel();"row"===t?(o=r,i=0,u=this._sheet.getRowCount()-r,s=this._sheet.getColumnCount()):(o=0,i=r,u=this._sheet.getRowCount(),s=this._sheet.getColumnCount()-r);var c=c5(this._sheet,(function(){var e={},n=[];return l.iter(o,i,u,s).forEach((function(e){var o=e.getPosition(),i=e.getId();("row"===t?o.row>=r&&o.row<r+a:o.col>=r&&o.col<r+a)&&n.push(i)})),n.length&&n.forEach((function(t){var n=l.getSparklineById(t);if(n){var r=n.getGroupId();f5(e,r,t,{source:n.getSource(),position:n.getPosition()}),e[r].config=l.getSparklineRawConfig(r)}})),{add:e}}));(null==c?void 0:c.undo)&&this.command._oldChangesets.push(c.undo)}}},{key:"pivotTablePositionAdjust",value:function(e){var t=this,n=e.type,r=e.method,a=e.target,o=this._sheet.embeddedBlocksModel;"del"===r&&o.getBlockTokensToAdjust(a,n,"del").forEach((function(e){var n=o.getBlock(e),r=n.position,a=n.blockSetting,i=n.blockToken,u=n.blockType,s={action:"setEmbeddedBlock",sheet_id:t._sheet.id(),target:{row:r.row,col:r.col},value:{blockSetting:a,blockToken:i,blockType:u}};t._command._oldChangesets.push(s)}))}},{key:"outlinePositionAdjust",value:function(e){var t=this._sheet,n=e.method,r=l4(t,e),a=r.newChangesets,o=r.oldChangesets;"del"===n?((0,we.VB2)(this._command._changesets,a),(0,we.hTd)(this._command._oldChangesets,o)):((0,we.hTd)(this._command._changesets,a),(0,we.VB2)(this._command._oldChangesets,o))}},{key:"protectionAdjust",value:function(e){var t=this;"del"===e.method&&function(e,t,n,r){var a=[],o=n+r,i="row"===t?"rowCount":"colCount",u=function(e){var r=e[t],a=r+e[i];return n<=r?r<o:n<a&&a<=o};return e.getAllProtections().forEach((function(e){for(var n=0,r=e.ranges.length;n<r;n++){var o=e.ranges[n];if((o.type===we.xj7.NORMAL||o.type===we.xj7.ROW&&"row"===t||o.type===we.xj7.COL&&"col"===t)&&u(o)){a.push(e);break}}})),a}(this._sheet.protectionModel,e.type,e.target,e.count).forEach((function(e){var n=q3(t._sheetId,e);t._command._oldChangesets.push(n)}))}},{key:"filterRangeAdjust",value:function(){try{var e,t=this._command,n=t.method,r=t.ranges;if(0===r.length)return;if("del"!==n)return;var a=this._sheet,o=null==a||null===(e=a.sheetFilterModel)||void 0===e?void 0:e.filterRange,i=Lh(a);switch(this._command.type){case"row":var u,s=[],l=_n(r);try{for(l.s();!(u=l.n()).done;){var c=u.value,h=c.target,f=c.count;(0,we.hTd)(s,sh(new xi(h,f,a)))}}catch(e){l.e(e)}finally{l.f()}(null==o?void 0:o.isValid())&&this.appendToChangeset($h(a,o,s));var d,v=_n(i);try{for(v.s();!(d=v.n()).done;){var g=d.value,m=g.name,p=g.id,y=g.range;this.appendToChangeset($h(a,y,s,m,p))}}catch(e){v.e(e)}finally{v.f()}break;case"col":var C,_=[],R=_n(r);try{for(R.s();!(C=R.n()).done;){var w=C.value,k=w.target,S=w.count;_.push(new Vi(k,S,a))}}catch(e){R.e(e)}finally{R.f()}(null==o?void 0:o.isValid())&&this.appendToChangeset(Yh(a,o,_));var E,T=_n(i);try{for(T.s();!(E=T.n()).done;){var A=E.value,I=A.name,b=A.id,F=A.range;this.appendToChangeset(Yh(a,F,_,I,b))}}catch(e){T.e(e)}finally{T.f()}}}catch(e){console.error("SetRowColChange command - filterRangeAdjust error")}}},{key:"getPerformanceInfo",value:function(){return{sub_command:"".concat(this._command.method,"-").concat(this._command.type)}}}]),t}(v4),X5=function(e){function t(e,n){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).call(this,e,n))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"execute",value:function(){return this._command.isFirstExecution?this.doAction():this.redoAction()}},{key:"redoAction",value:function(){return!0===this.checkRangeValid(this._sheet.parent,this._command._changesets)&&this._applyChangsetWithEvent(this._command._changesets,!0)}},{key:"undo",value:function(){return this._applyChangsetWithEvent(this._command._oldChangesets,!0)}},{key:"doAction",value:function(){var e=this.generateActions();return e?this._applyChangsetWithEvent(this.command._changesets,!0):e}},{key:"generateActions",value:function(){var e=this,t=this._command,n=t._changesets,r=t._oldChangesets,a=t.action,o=t.ranges,i=this._sheet,u=[],s=-1,l=1;return o.forEach((function(t){switch(a){case"unhideRow":var o=Object.keys(i.getHiddenRows()).map(Number);if(0===o.length)break;l=1;for(var c=t.target;c<=t.target+t.count;c++)o.includes(c)&&(-1===s?s=c:s+l===c?l++:(u.push({target:s,count:l}),s=c,l=1));s>-1&&u.push({target:s,count:l});break;case"unhideCol":var h=Object.keys(i.getHiddenCols()).map(Number);if(0===h.length)break;l=1;for(var f=t.target;f<=t.target+t.count;f++)h.includes(f)&&(-1===s?s=f:s+l===f?l++:(u.push({target:s,count:l}),s=f,l=1));s>-1&&u.push({target:s,count:l});break;case"hideCol":n.push(e.hideColChangeset(t)),r.push(e.unhideColChangeset(t));break;case"hideRow":n.push(e.hideRowChangeset(t)),r.push(e.unhideRowChangeset(t))}})),u.length>0&&("unhideRow"===a?u.forEach((function(t){n.push(e.unhideRowChangeset(t)),r.push(e.hideRowChangeset(t))})):"unhideCol"===a&&u.forEach((function(t){n.push(e.unhideColChangeset(t)),r.push(e.hideColChangeset(t))}))),!0===this.checkRangeValid(this._sheet.parent,this._command._changesets)&&(this.saveExtendFilterRangeActions(),!0)}},{key:"hideRowChangeset",value:function(e){return{action:"hideRow",sheet_id:this._sheetId,target:{row:e.target,row_count:e.count}}}},{key:"unhideRowChangeset",value:function(e){return{action:"unhideRow",sheet_id:this._sheetId,target:{row:e.target,row_count:e.count}}}},{key:"hideColChangeset",value:function(e){return{action:"hideCol",sheet_id:this._sheetId,target:{col:e.target,col_count:e.count}}}},{key:"unhideColChangeset",value:function(e){return{action:"unhideCol",sheet_id:this._sheetId,target:{col:e.target,col_count:e.count}}}},{key:"saveExtendFilterRangeActions",value:function(){var e=this._command,t=e.action,n=e.ranges;if("hideRow"===t){var r,a=this._sheet,o=[],i=_n(n);try{for(i.s();!(r=i.n()).done;){var u=r.value,s=u.target,l=u.count;o.push(new xi(s,l,a))}}catch(e){i.e(e)}finally{i.f()}this.appendToChangeset(Kh(a,o))}}},{key:"appendToChangeset",value:function(e){if(e){var t=e.actions,n=e.oldActions;t&&(0,we.hTd)(this._command._changesets,t),n&&(0,we.hTd)(this._command._oldChangesets,n)}}},{key:"commandName",get:function(){return we.rvF.SET_ROW_COL_VISIBLE}}]),t}(j3);var Q5=function(e){function t(e,n){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).call(this,e,n))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"_setRangeFontStyle",value:function(){var e=this,t=this._command,n=t.selections,r=t.prop,a=t.value,o=t.isIncrease,i=this._sheet,u=this._sheet.getParent(),s=this.filterDuplicateRange(n,!0),l={ignoreValue:!1,ignoreFormulaData:!0,ignoreDataValidation:!0,ignoreReminder:!0,ignoreMultipleValues:!0,ignorePivotTable:!0,ignoreStyle:!1,ignoreFilterRow:!0};if(s.forEach((function(t){var n=jQ(i,t.toJSON(),l,HQ);e._setRangeValuesActionToChangeset(n,!0)})),void 0!==o){var c={styleId:void 0,ignoreStyle:!1,ignoreValue:!1,ignoreFormulaData:!0,ignoreDataValidation:!0,ignoreReminder:!0,ignoreMultipleValues:!0,ignorePivotTable:!0,ignoreFilterRow:!0},h=new Map,f=function(t,n,r,a,i){var u,s=i.getSegmentArray(t,n),l=i.getCellStyle(t,n)||i.getDefaultStyle(),c={fontInfo:{fontSize:e.changeFontSize(l.fontSizePx,o)}};if(Array.isArray(s)&&s.length){r.ignoreValue=!1;var f=function(e,t,n,r){var a=mp(e,t,n,r),o=a.value,i=a.style,u=a.hasChanged;return Array.isArray(o)?{value:o.map((function(e){return e.style&&(e.style=e.style.toJSON()),e})),style:i,hasChanged:u}:{value:o,style:i,hasChanged:u}}(s,l,i,c),d=f.value,v=f.style;f.hasChanged&&(r.cellValue||(r.cellValue={}),r.cellValue.value=d,u=a.styleRefMgr.getStyleId(v))}else if(r.ignoreValue=!0,void 0===(u=h.get(l))){var g=Ad.withUpdateStyle(l,c);u=a.styleRefMgr.getStyleId(g),h.set(l,u)}r.styleId=u,zQ(t,n,i,a,r)};return n.forEach((function(t){var n=jQ(i,t.toJSON(),c,f);e._setRangeValuesActionToChangeset(n)})),!0}if(void 0!==a){var d={};return d[r]=a,function(e){var t=e["font-weight"]||e.fontWeight;t&&(e.fontWeight=ad(t),delete e["font-weight"])}(d),s.forEach((function(t){e._rangeOpToChangeset(t,{style:{fontInfo:d}})})),!0===this.checkRangeValid(u,this._command._changesets)}return!1}},{key:"execute",value:function(){var e=this._command,t=e._changesets,n=this._sheet,r=this._sheet.getParent(),a=!1;this._beforeAction(n);try{if(e.isFirstExecution)this._setRangeFontStyle(),a=this._applyChangsetWithEvent(t);else{if(!0!==this.checkRangeValid(r,this._command._changesets))return!1;a=this.tryApplyActions(r,t)}}catch(e){return we.Ps3.moirae.ravenCatch(e),this._afterAction(n),!1}return this._afterAction(n),a}},{key:"undo",value:function(){return this._applyChangsetWithEvent(this._command._oldChangesets,!0)}},{key:"changeFontSize",value:function(e,t){var n=we.xOW.indexOf(e+"px");return t?n===we.xOW.length-1?e:parseInt(we.xOW[n+1],10):0===n?e:parseInt(we.xOW[n-1],10)}},{key:"commandName",get:function(){return we.rvF.SET_STYLE_FONT}}]),t}(j3),e6=function(e){function t(e,n){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).call(this,e,n))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"_updateRangeTextDecoration",value:function(){var e=this,t=this._command,n=t.selections,r=t.active,a=t.flag,o=this._sheet,i=this._sheet.getParent(),u={textDecoration:{active:r,flag:a}},s=this.filterDuplicateRange(n,!0);if(s.forEach((function(t){e._rangeOpToChangeset(t,{style:u})})),!0!==this.checkRangeValid(i,this._command._changesets))return!1;var l={ignoreValue:!0,ignoreFormulaData:!0,ignoreDataValidation:!0,ignoreReminder:!0,ignoreMultipleValues:!0,ignorePivotTable:!0,ignoreStyle:!1,ignoreFilterRow:!0};return s.forEach((function(t){var n=jQ(o,t.toJSON(),l,HQ);e._setRangeValuesActionToChangeset(n,!0)})),!0}},{key:"execute",value:function(){var e=this._command,t=e._changesets,n=this._sheet,r=this._sheet.getParent(),a=!1;this._beforeAction(n);try{if(e.isFirstExecution){if(this._updateRangeTextDecoration(),!(a=this._applyChangsetWithEvent(t)))return!1}else{if(!0!==this.checkRangeValid(r,this._command._changesets))return!1;a=this._applyChangsetWithEvent(t)}}catch(e){return we.Ps3.moirae.ravenCatch(e),this._afterAction(n),!1}return this._afterAction(n),a}},{key:"undo",value:function(){return this._applyChangsetWithEvent(this._command._oldChangesets,!0)}},{key:"commandName",get:function(){return we.rvF.SET_TEXT_DECORATION}}]),t}(j3),t6=PX._util,n6=function(e){function t(e,n){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).call(this,e,n))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"commandName",get:function(){return"setValueByDataValidation"}}]),(0,C.Z)(t,[{key:"_doAction",value:function(){return this._doSetValue()}},{key:"_redoAction",value:function(){return!0===this.checkRangeValid(this._sheet.parent,this._command._changesets)&&this._applyChangsetWithEvent(this._command._changesets,!0)}},{key:"_doSetValue",value:function(){var e=this._sheet,t=this._command,n=t.row,r=t.col,a=t._changesets,o=t.text,i=t.isMultiple,u=t.multipleValues,s=this._command,l=s.formula,c=s.formulaVar,h=!1,f=e.getSpan(n,r);if(f&&(f.rowFrom()!==n||f.colFrom()!==r))return h;this._beforeAction(e);try{var d=e.getChangesetValue(n,r),v=e.getFormula(n,r),g=e.getFormulaData(n,r),m=e.getReminderChangeset(n,r),p=e.getMultipleValues(n,r),y=e.getStyleWithDropdown(n,r)||e.getDefaultStyle(),C={value:d,formula:v,reminder:m,multipleValues:p?p.toJSON():null,style:y.toJSON()};void 0!==g&&(C.formulaData=g);var _={};this._cellValueToChangeset(n,r,C,!0);var R=t6._getValueAndStyleFromEditing(e,n,r,o,!1,!0),w=R.value,k=R.styleWithDropdown,S=null;if(!l)if(Array.isArray(o))l=null,c=null;else{var E=l2(n,r,e,o);E.isFormula&&(l=E.text,c=E.formulaVar)}if(i){var T=y.formatter;S=new dm(e.parent),u?S.fromJSON(u):Array.isArray(o)?o.forEach((function(e){var t;null===(t=S)||void 0===t||t.addByTextNoSplit(e,T)})):S.fromString(o,T),_=this.saveNewState(n,r,w,l,c,k,null,void 0,S)}else _=(0,he.Z)(w)?this.saveNewState(n,r,(0,we.Tcw)(w),l,c,k,null):this.saveNewState(n,r,w,l,c,k,null);if(this.saveExtendFilterRangeChangesets(n,r,C,_),!this.checkRangeValid(e.parent,a,!0))return!1;h=this._applyChangsetWithEvent(a)}catch(n){throw we.Ps3.moirae.ravenCatch(n),this._afterAction(e),n}return this._afterAction(e),h}},{key:"undo",value:function(){return this._applyChangsetWithEvent(this._command._oldChangesets)}}]),t}(h4),r6=function(e){function t(){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).apply(this,arguments))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"execute",value:function(){return!(this._command.isFirstExecution&&!this._saveChangesets())&&!0===this.checkRangeValid(this._sheet.parent,this._command._changesets)&&this._applyChangsetWithEvent(this._command._changesets,!0)}},{key:"_saveChangesets",value:function(){var e=this._command,t=e.sheetId,n=e.value,r=n.originName,a=n.viewId,o=(0,we.US_)(a),i=n.name;return i&&!this._isNameConflict(i)||(i=this._getDefaultName(o)),this._command._oldChangesets=[(0,we.OU8)(t,{type:0,origin_name:i,name:r,view_id:a})],this._command._changesets=[(0,we.OU8)(t,{type:0,origin_name:r,name:i,view_id:a})],!0}},{key:"undo",value:function(){return this._applyChangsetWithEvent(this._command._oldChangesets,!0)}},{key:"_getDefaultName",value:function(e){return this._sheet.viewsModel.assignViewName(e)}},{key:"_isNameConflict",value:function(e){return!!this._sheet.viewsModel&&this._sheet.viewsModel.isNameExit(e)}},{key:"commandName",get:function(){return we.rvF.SET_VIEW}}]),t}(j3);var a6,o6,i6,u6,s6,l6=function(e){function t(e,n){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).call(this,e,n))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"execute",value:function(){return this._command.isFirstExecution?this._doAction():this._redoAction()}},{key:"undo",value:function(){return this._undoAction()}},{key:"_doAction",value:function(){var e=performance.now(),t=this._command,n=this._sheet;this._beforeAction(n);try{var r=t.target,a=t.sortConditions,o=t.sortType,i=this.handleSortRangeByFrozen(n,r);if(!i.continueSort)return!1;r=i.sortRange;var u=performance.now();if(!this._canSortRange(r,a,o))return!1;for(var s=performance.now(),l=[],c=0;c<r.rowCount();c++)for(var h=0;h<r.colCount();h++){var f=n.getFormula(c+r.rowFrom(),h+r.colFrom());f&&l.push({row:c+r.rowFrom(),col:h+r.colFrom(),formula:f})}var d=n._sortRange(r.rowFrom(),r.colFrom(),r.rowCount(),r.colCount(),!0,a),v=r.rowFrom(),g=d.reduce((function(e,t,n){return e[t-v]=n+v,e}),[]);if(this._sortToChangeset(r.rowFrom(),r.colFrom(),r.rowCount(),r.colCount(),g,!0),this._sortToChangeset(r.rowFrom(),r.colFrom(),r.rowCount(),r.colCount(),d,!1),!this.checkRangeValid(n.getParent(),this._command._changesets))return we.Ps3.modalHelper.showError(17),!1;var m=performance.now(),p=this._applyChangsetWithEvent(this._command._changesets,!1);return this.checkCanSortTime=s-u,this.createCsTime=m-e,this.applyCsTime=performance.now()-m,p||we.Ps3.modalHelper.showError(17),p}catch(e){return we.Ps3.moirae.ravenCatch(e),we.Ps3.modalHelper.showError(17),!1}finally{this._afterAction(n)}}},{key:"_redoAction",value:function(){var e=this._command,t=this._sheet,n=e._changesets;return!0===this.checkRangeValid(t.parent,n)&&this._applyChangsetWithEvent(n,!1)}},{key:"_undoAction",value:function(){if(!0!==this.checkRangeValid(this._sheet.parent,this._command._oldChangesets))return!1;var e=this._command._oldChangesets;return this._applyChangsetWithEvent(e,!1)}},{key:"_canSortRange",value:function(e,t,n){var r=this._sheet;if(!function(e,t){if(t.length<=0)return!1;var n,r=e.colFrom(),a=e.colTo(),o=_n(t);try{for(o.s();!(n=o.n()).done;){var i=n.value.index;if(i>a||i<r)return we.Ps3.modalHelper.showError(22),!1}}catch(e){o.e(e)}finally{o.f()}return!0}(e,t))return!1;if(1===e.rowCount())return!1;if(!0!==this.checkRangeValid(r.parent,[{action:"sort",sheet_id:r.id(),target:{row:e.rowFrom(),col:e.colFrom(),row_count:e.rowCount(),col_count:e.colCount()}}]))return we.Ps3.modalHelper.showError(22),!1;var a=r.getSpans(e);return a&&a.length>0?(we.Ps3.modalHelper.showSpansPromptModalWhileSort(a,n),!1):!Mh(r,e)||(we.Ps3.modalHelper.showError(21),!1)}},{key:"getPerformanceInfo",value:function(){if(void 0!==this.checkCanSortTime&&void 0!==this.createCsTime&&void 0!==this.applyCsTime)return{checkCanSortTime:this.checkCanSortTime,createCsTime:this.createCsTime,applyCsTime:this.applyCsTime,sortConditionsNum:this.command.sortConditions.length}}},{key:"handleSortRangeByFrozen",value:function(e,t){var n=e.frozenRowCount(),r=t.rowFrom(),a=t.rowCount()-1+r;return a<=n?{continueSort:!1}:(r<=n-1&&((t=Oi.toNormalRange(t)).setRowFrom(n),t.setRowCount(a-n+1)),{continueSort:!0,sortRange:t})}},{key:"commandName",get:function(){return we.rvF.SORT_RANGE}}]),t}(j3),c6=function(e){function t(e,n){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).call(this,e,n))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"execute",value:function(){return this._command.isFirstExecution?this.doAction():this.redoAction()}},{key:"redoAction",value:function(){return this._applyChangsetWithEvent(this._command._changesets,!0)}},{key:"undo",value:function(){return this._applyChangsetWithEvent(this._command._oldChangesets,!0)}},{key:"doAction",value:function(){return!!this.generateAction()&&this._applyChangsetWithEvent(this._command._changesets,!0)}},{key:"generateAction",value:function(){var e=this._command,t=e._changesets,n=e._oldChangesets,r=e.permId,a=this._sheet.protectionModel.getProtectionById(r);if(!a)return!1;var o=UI(a),i=o[we.xj7.NORMAL],u=o[we.xj7.ROW],s=o[we.xj7.COL];if(u.length>0||i.length>0||1!==s.length)return!1;var l=s[0];return n.push(this.lockColChangeset(this._sheetId,l.col,l.colCount,a.description||"",r,a.creatorId)),t.push(this.unLockColChangeset(this._sheetId,l.col,l.colCount,r)),!0}},{key:"lockColChangeset",value:function(e,t,n,r,a,o){return{action:"lockCol",sheet_id:e,target:{col:t,col_count:n},value:{lock_info:r,perm_id:a,creator_id:o||""}}}},{key:"unLockColChangeset",value:function(e,t,n,r){return{action:"unlockCol",sheet_id:e,value:{perm_id:r},target:{col:t,col_count:n}}}},{key:"commandName",get:function(){return we.rvF.UNLOCK_COL}}]),t}(j3),h6=function(e){function t(e,n){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).call(this,e,n))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"execute",value:function(){return this._command.isFirstExecution?this.doAction():this.redoAction()}},{key:"redoAction",value:function(){return this._applyChangsetWithEvent(this._command._changesets,!0)}},{key:"undo",value:function(){return this._applyChangsetWithEvent(this._command._oldChangesets,!0)}},{key:"doAction",value:function(){return!!this.generateAction()&&this._applyChangsetWithEvent(this._command._changesets,!0)}},{key:"generateAction",value:function(){var e=this._command,t=e._changesets,n=e._oldChangesets,r=e.permId,a=this._sheet.protectionModel.getProtectionById(r);if(!a)return!1;var o=UI(a),i=o[we.xj7.NORMAL],u=o[we.xj7.ROW];if(o[we.xj7.COL].length>0||i.length>0||1!==u.length)return!1;var s=u[0];return n.push(this.lockRowChangeset(this._sheetId,s.row,s.rowCount,a.description||"",r,a.creatorId)),t.push(this.unLockRowChangeset(this._sheetId,s.row,s.rowCount,r)),!0}},{key:"lockRowChangeset",value:function(e,t,n,r,a,o){return{action:"lockRow",sheet_id:e,target:{row:t,row_count:n},value:{lock_info:r,perm_id:a,creator_id:o||""}}}},{key:"unLockRowChangeset",value:function(e,t,n,r){return{action:"unlockRow",sheet_id:e,value:{perm_id:r},target:{row:t,row_count:n}}}},{key:"commandName",get:function(){return we.rvF.UNLOCK_ROW}}]),t}(j3),f6=function(e){function t(e,n){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).call(this,e,n))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"execute",value:function(e){return this._command.isFirstExecution?this.doAction(e):this.redoAction()}},{key:"redoAction",value:function(){return this._applyChangsetWithEvent(this._command._changesets,!0)}},{key:"undo",value:function(){return this._applyChangsetWithEvent(this._command._oldChangesets,!0)}},{key:"doAction",value:function(e){return!!this.generateAction(e)&&this._applyChangsetWithEvent(this._command._changesets,!0)}},{key:"generateAction",value:function(e){var t=this._command,n=t._changesets,r=t._oldChangesets,a=t.permId,o=e.permissionManager.findPermById(a);return!!o&&(n.push(this.unUnlockSheetChangeset(this._sheetId,a,this._sheet.name())),r.push(this.lockSheetChangeset(o.sheetId,o.lockInfo,a,o.sheetName,o.creatorId)),!0)}},{key:"lockSheetChangeset",value:function(e,t,n,r,a){return{action:"lockSheet",sheet_id:e,value:{lock_info:t,perm_id:n,sheet_name:r,creator_id:a||""}}}},{key:"unUnlockSheetChangeset",value:function(e,t,n){return{action:"unlockSheet",sheet_id:e,value:{perm_id:t,sheet_name:n}}}},{key:"commandName",get:function(){return we.rvF.UNLOCK_SHEET}}]),t}(j3),d6=function(e){function t(e,n){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).call(this,e,n))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"execute",value:function(){return this._command.isFirstExecution?this.doAction():this.redoAction()}},{key:"undo",value:function(){return this._applyChangsetWithEvent(this._command._oldChangesets)}},{key:"redoAction",value:function(){return!0===this.checkRangeValid(this._sheet.parent,this._command._changesets)&&this._applyChangsetWithEvent(this._command._changesets)}},{key:"doAction",value:function(){return this._saveChangeSets(),this._applyChangsetWithEvent(this._command._changesets,!0)}},{key:"_saveChangeSets",value:function(){var e=this.command,t=e.target,n=e.state,r=n===we.w2y.Fold?we.w2y.Expand:we.w2y.Fold,a=this.createUpdateOutlineActions(t,n),o=this.createUpdateOutlineActions(t,r);this._command._changesets.push(a),this._command._oldChangesets.push(o)}},{key:"createUpdateOutlineActions",value:function(e,t){return{action:"updateOutline",sheet_id:this._sheet.id(),value:{state:t},target:t4(e)}}},{key:"commandName",get:function(){return we.rvF.UPDATE_OUTLINE}}]),t}(j3),v6=function(e){function t(e,n){var r;return(0,y.Z)(this,t),(r=(0,d.Z)(this,(0,v.Z)(t).call(this,e,n)))._command.autoFillType=0,r._command.fillDirection=3,r}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"execute",value:function(){return this._command.isFirstExecution?this.doAction():this.redoAction()}},{key:"canExecute",value:function(){var e=this._sheet,t=this._command,n=t.startRange,r=t.fillRange,a=t.autoFillType;return!(0===r.rowCount()||!e._canChange(r.rowFrom(),r.colFrom(),r.rowCount(),r.colCount())||4!==a&&r.isIntersect(n))}},{key:"redoAction",value:function(){return!0===this.checkRangeValid(this._sheet.parent,this._command._changesets)&&this._applyChangsetWithEvent(this._command._changesets)}},{key:"undo",value:function(){return this._applyChangsetWithEvent(this._command._oldChangesets)}},{key:"doAction",value:function(){if(!this.canExecute())return!1;var e=this._sheet,t=this._command.fillRange,n=this._collRangeInfo(e,t);return this.saveChangesets(n,!0),this._beforeAction(e,!0),this._executeFill(),this._afterAction(this._sheet,!0),this.extendFilterRange([t]),!!this.checkRangeValid(e.parent,this.command._changesets,!0)&&(this._applyChangsetWithEvent(this.command._changesets),!0)}},{key:"commandName",get:function(){return"verticalFill"}}]),t}(K4),g6=function(e){function t(e,n,r){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).call(this,e,n))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"execute",value:function(){return this._command.isFirstExecution?this._doAction():this._redoAction()}},{key:"_clearRangeNotes",value:function(){var e=this,t=this._sheet,n=this._command.ranges,r={ignoreValue:!0,ignoreStyle:!0,ignoreDataValidation:!0,ignoreFormulaData:!0,ignoreMultipleValues:!0,ignoreReminder:!0,ignorePivotTable:!0,needNote:!0};this.filterDuplicateRange(n,!0).forEach((function(n){e._setRangeToChangeset(n,{note:null}),e._setRangeValuesActionToChangeset(jQ(t,n.toJSON(),r),!0)}))}},{key:"_doAction",value:function(){return!!this.generateActions()&&this._applyChangsetWithEvent(this._command._changesets,!0)}},{key:"generateActions",value:function(){var e=this._sheet.getParent();return this._clearRangeNotes(),!0===this.checkRangeValid(e,this._command._changesets)}},{key:"_redoAction",value:function(){return!0===this.checkRangeValid(this._sheet.parent,this._command._changesets)&&this._applyChangsetWithEvent(this._command._changesets,!0,"redo")}},{key:"undo",value:function(){return this._applyChangsetWithEvent(this._command._oldChangesets,!0,"undo")}},{key:"commandName",get:function(){return we.rvF.CLEAR_NOTES}}]),t}(h4),m6=function(e){function t(e,n){return(0,y.Z)(this,t),(0,d.Z)(this,(0,v.Z)(t).call(this,e,n))}return(0,g.Z)(t,e),(0,C.Z)(t,[{key:"execute",value:function(){return!(this._command.isFirstExecution&&!this._saveChangesets())&&this._applyChangsetWithEvent(this._command._changesets,!0)}},{key:"undo",value:function(){return this._applyChangsetWithEvent(this._command._oldChangesets,!0)}},{key:"_saveChangesets",value:function(){var e=this._command,t=e.row,n=e.col,r=e.note,a=void 0===r?null:r,o=this._sheet.id(),i=this._sheet.getCellNoteJSON(t,n);if((0,pe.default)(a,i))return!1;var u={action:"setCell",sheet_id:o,target:{row:t,col:n},value:{note:a},type:8},s={action:"setCell",sheet_id:o,target:{row:t,col:n},value:{note:i},type:8};return this._command._changesets.push(u),this._command._oldChangesets.push(s),!0}},{key:"commandName",get:function(){return we.rvF.SET_CELL_NOTE}}]),t}(j3),p6=(at={},(0,l.Z)(at,we.rvF.FILL_RANGE,{canUndo:!0,execute:function(e,t,n,r){return T4(e,X4,t,n,r)}}),(0,l.Z)(at,we.rvF.SET_RANGE_STYLE,{canUndo:!0,execute:function(e,t,n,r){return T4(e,$5,t,n,r)}}),(0,l.Z)(at,we.rvF.SET_STYLE_FONT,{canUndo:!0,execute:function(e,t,n,r){return T4(e,Q5,t,n,r)}}),(0,l.Z)(at,we.rvF.SET_FORMATTER,{canUndo:!0,execute:function(e,t,n,r){return T4(e,H5,t,n,r)}}),(0,l.Z)(at,we.rvF.SET_TEXT_DECORATION,{canUndo:!0,execute:function(e,t,n,r){return T4(e,e6,t,n,r)}}),(0,l.Z)(at,we.rvF.MERGE_CELLS,{canUndo:!0,execute:function(e,t,n,r){return T4(e,i5,t,n,r)}}),(0,l.Z)(at,we.rvF.SET_ROW_COL_CHANGE,{canUndo:!0,execute:function(e,t,n,r){return T4(e,K5,t,n,r)}}),(0,l.Z)(at,we.rvF.SET_ROW_COL_VISIBLE,{canUndo:!0,execute:function(e,t,n,r){return T4(e,X5,t,n,r)}}),(0,l.Z)(at,we.rvF.DO_CLEAR,{canUndo:!0,execute:function(e,t,n,r){return T4(e,z4,t,n,r)}}),(0,l.Z)(at,we.rvF.CLEAR_VALUES_STYLE,{canUndo:!0,execute:function(e,t,n,r){return T4(e,w4,t,n,r)}}),(0,l.Z)(at,we.rvF.FORMAT_PIVOT_TABLE_RANGE,{canUndo:!0,execute:function(e,t,n,r){return T4(e,e5,t,n,r)}}),(0,l.Z)(at,we.rvF.SORT_RANGE,{canUndo:!0,execute:function(e,t,n,r){return T4(e,l6,t,n,r)}}),(0,l.Z)(at,we.rvF.AUTO_FIT_ROW,{canUndo:!0,execute:function(e,t,n,r){return T4(e,_4,t,n,r)}}),(0,l.Z)(at,we.rvF.AUTO_FIT_COLUMN,{canUndo:!0,execute:function(e,t,n,r){return T4(e,C4,t,n,r)}}),(0,l.Z)(at,we.rvF.ADD_SHEET,{canUndo:!0,execute:function(e,t,n,r){return A4(e,m4,t,n,r)}}),(0,l.Z)(at,we.rvF.MOVE_SHEET,{canUndo:!0,execute:function(e,t,n,r){return A4(e,E5,t,n,r)}}),(0,l.Z)(at,we.rvF.DELETE_SHEET,{canUndo:!0,execute:function(e,t,n,r){return A4(e,H4,t,n,r)}}),(0,l.Z)(at,we.rvF.SET_SHEET_PROPERTY,{canUndo:!0,execute:function(e,t,n,r){return T4(e,T5,t,n,r)}}),(0,l.Z)(at,we.rvF.COPY_SHEET,{canUndo:!0,execute:function(e,t,n,r){return A4(e,N4,t,n,r)}}),(0,l.Z)(at,we.rvF.RESIZE_ROW,{canUndo:!0,execute:function(e,t,n,r){return T4(e,b5,t,n,r)}}),(0,l.Z)(at,we.rvF.RESIZE_COLUMN,{canUndo:!0,execute:function(e,t,n,r){return T4(e,I5,t,n,r)}}),(0,l.Z)(at,we.rvF.EDIT_CELL,{canUndo:!0,execute:function(e,t,n,r){return T4(e,q4,t,n,r)}}),(0,l.Z)(at,we.rvF.SET_CELL_NOTE,{canUndo:!0,execute:function(e,t,n,r){return T4(e,m6,t,n,r)}}),(0,l.Z)(at,we.rvF.CLEAR_NOTES,{canUndo:!0,execute:function(e,t,n,r){return T4(e,g6,t,n,r)}}),(0,l.Z)(at,we.rvF.MOVE_RANGE,{canUndo:!0,execute:function(e,t,n,r){return T4(e,v5,t,n,r)}}),(0,l.Z)(at,we.rvF.FILL,{canUndo:!0,execute:function(e,t,n,r){return T4(e,K4,t,n,r)}}),(0,l.Z)(at,we.rvF.HORIZONTAL_FILL,{canUndo:!0,execute:function(e,t,n,r){return T4(e,n5,t,n,r)}}),(0,l.Z)(at,we.rvF.VERTICAL_FILL,{canUndo:!0,execute:function(e,t,n,r){return T4(e,v6,t,n,r)}}),(0,l.Z)(at,we.rvF.CLEAR_VALUES,{canUndo:!0,execute:function(e,t,n,r){return we.Ps3.collectSuiteEvent("edit_cell_content",{action:"delete"}),T4(e,R4,t,n,r)}}),(0,l.Z)(at,we.rvF.SET_FILTER,{canUndo:!0,execute:function(e,t,n,r){return T4(e,D5,t,n,r)}}),(0,l.Z)(at,we.rvF.FREEZE_SHEET,{canUndo:!0,execute:function(e,t,n,r){return T4(e,t5,t,n,r)}}),(0,l.Z)(at,we.rvF.FORMAT_PAINTER,{canUndo:!0,execute:function(e,t,n,r){return T4(e,Q4,t,n,r)}}),(0,l.Z)(at,we.rvF.REPLACE,{canUndo:!0,execute:function(e,t,n,r){return T4(e,A5,t,n,r)}}),(0,l.Z)(at,we.rvF.SET_DROPDOWN_VALID,{canUndo:!0,execute:function(e,t,n,r){return T4(e,x5,t,n,r)}}),(0,l.Z)(at,we.rvF.CONVERT_LINK,{canUndo:!0,execute:function(e,t,n,r){return T4(e,M4,t,n,r)}}),(0,l.Z)(at,we.rvF.SET_CHART,{canUndo:!0,execute:function(e,t,n,r){return T4(e,F5,t,n,r)}}),(0,l.Z)(at,we.rvF.SET_FLOAT_BLOCK,{canUndo:!0,execute:function(e,t,n,r){return T4(e,B5,t,n,r)}}),(0,l.Z)(at,we.rvF.SET_EMBEDDED_BLOCK,{canUndo:!0,execute:function(e,t,n,r){return T4(e,Z5,t,n,r)}}),(0,l.Z)(at,we.rvF.SET_FLOAT_IMAGE,{canUndo:!0,execute:function(e,t,n,r){return T4(e,U5,t,n,r)}}),(0,l.Z)(at,we.rvF.CONVERT_IMAGE,{canUndo:!0,execute:function(e,t,n,r){return T4(e,F4,t,n,r)}}),(0,l.Z)(at,we.rvF.MODIFY_VALUES,{canUndo:!0,execute:function(e,t,n,r){return T4(e,u5,t,n,r)}}),(0,l.Z)(at,we.rvF.SET_CONDITIONAL_FORMAT,{canUndo:!0,execute:function(e,t,n,r){return T4(e,V5,t,n,r)}}),(0,l.Z)(at,we.rvF.ADD_BLOCK,{canUndo:!0,execute:function(e,t,n,r){return A4(e,Y3,t,n,r)}}),(0,l.Z)(at,we.rvF.DEL_BLOCK,{canUndo:!0,execute:function(e,t,n,r){return A4(e,U4,t,n,r)}}),(0,l.Z)(at,we.rvF.COPY_BLOCK,{canUndo:!0,execute:function(e,t,n,r){return A4(e,V4,t,n,r)}}),(0,l.Z)(at,we.rvF.ADD_VIEW,{canUndo:!0,execute:function(e,t,n,r){return T4(e,p4,t,n,r)}}),(0,l.Z)(at,we.rvF.ENTER_VIEW,{canUndo:!0,execute:function(e,t,n,r){return T4(e,$4,t,n,r)}}),(0,l.Z)(at,we.rvF.EXIT_VIEW,{canUndo:!0,execute:function(e,t,n,r){return T4(e,Y4,t,n,r)}}),(0,l.Z)(at,we.rvF.DEL_VIEW,{canUndo:!0,execute:function(e,t,n,r){return T4(e,j4,t,n,r)}}),(0,l.Z)(at,we.rvF.SET_VIEW,{canUndo:!0,execute:function(e,t,n,r){return T4(e,r6,t,n,r)}}),(0,l.Z)(at,we.rvF.SET_FILTER_VIEW,{canUndo:!0,execute:function(e,t,n,r){return T4(e,L5,t,n,r)}}),(0,l.Z)(at,we.rvF.ADD_REMINDER,{canUndo:!0,execute:function(e,t,n,r){return A4(e,d4,t,n,r)}}),(0,l.Z)(at,we.rvF.SET_REMINDER,{canUndo:!0,execute:function(e,t,n,r){return A4(e,Y5,t,n,r)}}),(0,l.Z)(at,we.rvF.SET_DATA_VALIDATION,{canUndo:!0,execute:function(e,t,n,r){return T4(e,Z4,t,n,r)}}),(0,l.Z)(at,we.rvF.SET_LIST_DATA_VALIDATION,{canUndo:!0,execute:function(e,t,n,r){return T4(e,B4,t,n,r)}}),(0,l.Z)(at,we.rvF.SET_CHECKBOX_VALIDATION,{canUndo:!0,execute:function(e,t,n,r){return T4(e,P4,t,n,r)}}),(0,l.Z)(at,we.rvF.SET_DATE_TIME_VALIDATION,{canUndo:!0,execute:function(e,t,n,r){return T4(e,D4,t,n,r)}}),(0,l.Z)(at,we.rvF.SET_VALUE_BY_DATA_VALIDATION,{canUndo:!0,execute:function(e,t,n,r){return A4(e,n6,t,n,r)}}),(0,l.Z)(at,we.rvF.SET_MULTIPLE_VALUES_BY_RANGE,{canUndo:!0,execute:function(e,t,n,r){return A4(e,W5,t,n,r)}}),(0,l.Z)(at,we.rvF.ADD_ROW_AND_COL,{canUndo:!0,execute:function(e,t,n,r){return T4(e,g4,t,n,r)}}),(0,l.Z)(at,we.rvF.DATA_SPLIT,{canUndo:!0,execute:function(e,t,n,r){return T4(e,y4,t,n,r)}}),(0,l.Z)(at,we.rvF.SET_DATA_RANGE,{canUndo:!0,execute:function(e,t,n,r){return T4(e,N5,t,n,r)}}),(0,l.Z)(at,we.rvF.ADD_OUTLINE,{canUndo:!0,execute:function(e,t,n,r){return T4(e,c4,t,n,r)}}),(0,l.Z)(at,we.rvF.DEL_OUTLINE,{canUndo:!0,execute:function(e,t,n,r){return T4(e,W4,t,n,r)}}),(0,l.Z)(at,we.rvF.UPDATE_OUTLINE,{canUndo:!0,execute:function(e,t,n,r){return T4(e,d6,t,n,r)}}),at);p6[we.rvF.DEL_VIEW_NOT_UNDO]={canUndo:!1,execute:function(e,t,n,r){return T4(e,j4,t,n,r)}},p6[we.rvF.ADD_VIEW_NOT_UNDO]={canUndo:!1,execute:function(e,t,n,r){return T4(e,p4,t,n,r)}},p6[we.rvF.SET_COMMENTS]={canUndo:!1,execute:function(e,t,n,r){return T4(e,M5,t,n,r)}},p6[we.rvF.LOCK_ROW]={canUndo:!1,execute:function(e,t,n,r){return T4(e,a5,t,n,r)}},p6[we.rvF.UNLOCK_ROW]={canUndo:!1,execute:function(e,t,n,r){return T4(e,h6,t,n,r)}},p6[we.rvF.LOCK_COL]={canUndo:!1,execute:function(e,t,n,r){return T4(e,r5,t,n,r)}},p6[we.rvF.UNLOCK_COL]={canUndo:!1,execute:function(e,t,n,r){return T4(e,c6,t,n,r)}},p6[we.rvF.LOCK_SHEET]={canUndo:!1,execute:function(e,t,n,r){return A4(e,o5,t,n,r)}},p6[we.rvF.UNLOCK_SHEET]={canUndo:!1,execute:function(e,t,n,r){return A4(e,f6,t,n,r)}},p6[we.rvF.MOVE_ROW_COL]={canUndo:!0,execute:function(e,t,n,r){return T4(e,S5,t,n,r)}},function(e){e.BackColor="backColor",e.FontSize="fontSize",e.ForeColor="foreColor",e.Frame="frame",e.HAlign="hAlign",e.HideLink="hideLink",e.VAlign="vAlign",e.WordWrap="wordWrap"}(a6||(a6={})),function(e){e.ToolbarDropdown="toolbar_dropdown",e.ToolbarValidation="toolbar_validation",e.AiCreateSheet="AiCreateSheet"}(o6||(o6={})),function(e){e.ADD="add",e.SET="set",e.DEL="del",e.MOVE="move",e.CLEAR_RANGE="clearRange"}(i6||(i6={})),function(e){e[e.Add=0]="Add",e[e.Set=1]="Set",e[e.Del=2]="Del"}(u6||(u6={})),function(e){e[e.Add=0]="Add",e[e.Set=1]="Set",e[e.Del=2]="Del"}(s6||(s6={}));var y6=function(e){var t=e.commandManager();(0,H.Z)(p6,(function(e,n){t.register(n,e)}))},C6=function(){function e(){(0,y.Z)(this,e),this.range$=new vt.X(null),this.visibleRanges$=new vt.X([]),this.invisibleRanges$=new vt.X([]),this.primaryRanges$=new vt.X([]),this.highlightedRows=null,this.highlightFirstDuplicationItem=!1}return(0,C.Z)(e,[{key:"setIsFirstDuplicationItem",value:function(e){this.highlightFirstDuplicationItem=e}},{key:"getIsFirstDuplicationItem",value:function(){return this.highlightFirstDuplicationItem}},{key:"hasHighlightedRange",value:function(){return!!this.highlightedRows}},{key:"cellInHighlightedRange",value:function(e,t){var n=this.range$.getValue()||this.visibleRanges$.getValue()[0]||this.primaryRanges$.getValue()[0];return!(!n||!this.highlightedRows)&&(oo(n.colFrom(),n.colTo(),t,t)&&this.highlightedRows.has(e))}},{key:"cellInHighlightedRows",value:function(e){this.highlightedRows=e}},{key:"updateSearchingRange",value:function(e){this.range$.next(e)}},{key:"updateDuplicationRanges",value:function(e,t,n){this.visibleRanges$.next(e),this.invisibleRanges$.next(t),this.primaryRanges$.next(n)}},{key:"clear",value:function(){this.range$.next(null),this.visibleRanges$.next([]),this.invisibleRanges$.next([]),this.primaryRanges$.next([])}},{key:"clearHighlight",value:function(){this.visibleRanges$.next([]),this.invisibleRanges$.next([]),this.primaryRanges$.next([])}},{key:"dispose",value:function(){this.range$.complete(),this.visibleRanges$.complete(),this.invisibleRanges$.complete(),this.primaryRanges$.complete()}}]),e}();Gi([(0,lt.P)()],C6.prototype,"dispose",null),C6=Gi([(0,ct.b)()],C6)}}]);