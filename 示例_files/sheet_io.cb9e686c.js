(self.webpackChunkbear_fe=self.webpackChunkbear_fe||[]).push([["vsh_6553"],{vsh_35911:function(e,t,r){"use strict";r.d(t,{Aw:function(){return U},IE:function(){return n},l$:function(){return ae},M_:function(){return i},ke:function(){return g},qq:function(){return k},wt:function(){return oe},sG:function(){return u},vP:function(){return l},YT:function(){return d}});var n="DataLoaderPlugin",i=600,o=r("vsh_69691"),s=r("vsh_24627");r("vsh_60505");function a(e,t){var r="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!r){if(Array.isArray(e)||(r=function(e,t){if(!e)return;if("string"==typeof e)return c(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);"Object"===r&&e.constructor&&(r=e.constructor.name);if("Map"===r||"Set"===r)return Array.from(e);if("Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r))return c(e,t)}(e))||t&&e&&"number"==typeof e.length){r&&(e=r);var n=0,i=function(){};return{s:i,n:function(){return n>=e.length?{done:!0}:{done:!1,value:e[n++]}},e:function(e){throw e},f:i}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,s=!0,a=!1;return{s:function(){r=r.call(e)},n:function(){var e=r.next();return s=e.done,e},e:function(e){a=!0,o=e},f:function(){try{s||null==r.return||r.return()}finally{if(a)throw o}}}}function c(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,n=new Array(t);r<t;r++)n[r]=e[r];return n}function u(e,t){var r,n,i="";return e.extra_data&&(i=e.extra_data.sheet_id,r=e.extra_data.row_count,n=e.extra_data.sub_type),{isCustomDataForShortcut:e.isCustomDataForShortcut,link_ISV_sheets:e.link_ISV_sheets,snapshot:e.snapshot,rowCount:r,sheetId:i,changesets:e.changeset_list,changeset_list:e.changeset_list,fromCache:t,version:e.version,is_snapshot_copying:e.is_snapshot_copying,show_template:e.show_template,subType:n,authorized:e.authorized}}function l(e){return Object.assign({},e,{sheetId:e.sheetId,changeset_list:e.changesets,rowCount:0,version:e.schemaVersion||e.version})}var h="Sheet1";function d(e){var t=e.snapshot;if(!t)return e;var r=[],n=[];for(var i in t.sheets)r.push(i),n.push(t.sheets[i]);var o=!t.sheets.Sheet1&&n.every((function(e){return Boolean(e.delTime)})),s=-1,c=[];if(o)c=[].concat(r);else{var u,l=a(r);try{for(l.s();!(u=l.n()).done;){var d=u.value,f=t.sheets[d];Boolean(f.delTime)?delete t.sheets[d]:(c.push(d),d===h&&(s=c.length-1))}}catch(e){l.e(e)}finally{l.f()}}return s>=0&&c.length>1&&(delete t.sheets.Sheet1,c.splice(s,1)),c.sort((function(e,r){return Number(t.sheets[e].index<t.sheets[r].index)})).forEach((function(e,r){t.sheets[e].index=r+1})),t.sheetCount=c.length,e}var f=new Set([o.STATUS_CODE.INVALID_PARAMETERS,o.STATUS_CODE.NOT_FOUND,o.STATUS_CODE.NOTE_DELETED,o.STATUS_CODE.FORBIDDEN,o.STATUS_CODE.LOGIN_REQUIRED,o.STATUS_CODE.KEY_INVALID,Number(s.D1r.ERR_NEED_UPDATE_CLIENT)]);function p(e){return void 0!==e&&f.has(Number(e))}function v(e){var t,r;null===(t=e.cache)||void 0===t||null===(r=t.clear)||void 0===r||r.call(t)}var g,y=r("vsh_47246");!function(e){e.Start="Start",e.RevInit="RevInit",e.ReloadStart="ReloadStart",e.ClientVarsMessageInvalid="ClientVarsMessageInvalid",e.ClientVarsMessageValid="ClientVarsMessageValid",e.ClientVarsFetchFailed="ClientVarsFetchFailed",e.ClientVarsLoaded="ClientVarsLoaded",e.BeforeApplySnapshot="BeforeApplySnapshot",e.AfterApplySnapshot="AfterApplySnapshot",e.BeforeApplyMutation="BeforeApplyMutation",e.AfterApplyMutation="AfterApplyMutation",e.ContentMetaApply="ContentMetaApply",e.SplitDataFetchStart="SplitDataFetchStart",e.ClientVarsSubBlockLoading="ClientVarsSubBlockLoading",e.SplitDataFetchEnd="SplitDataFetchEnd",e.WorksheetLoading="WorksheetLoading",e.DataTableLoaded="DataTableLoaded",e.DataTableApplied="DataTableApplied",e.FormulaCacheEmpty="FormulaCacheEmpty",e.FormulaCacheBlockFetchStart="FormulaCacheBlockFetchStart",e.FormulaCacheMetaLoaded="FormulaCacheMetaLoaded",e.FormulaCacheBlockLoaded="FormulaCacheBlockLoaded",e.WorksheetLoaded="WorksheetLoaded",e.FirstActiveSheetLoaded="FirstActiveSheetLoaded",e.SpreadLoaded="SpreadLoaded",e.AfterSpreadLoaded="AfterSpreadLoaded",e.SheetToUsage="SheetToUsage",e.RecoverRefetching="RecoverRefetching",e.HybridResourceDataInit="HybridResourceDataInit",e.AsyncCopySheet="AsyncCopySheet",e.SnapshotHasExtraData="SnapshotHasExtraData"}(g||(g={}));var _={sheets:{},contentMetaDataApplied:!1,firstActiveSheetLoaded:!1,spreadLoaded:!1,sheetToUsage:!1},k="LoadStatusStore";var E=r("vsh_67017"),m=r.n(E),S=r("vsh_35067"),b=r("vsh_19264"),C=r("vsh_4175"),R=r("vsh_4561"),A=r("vsh_29033"),T=r("vsh_72834"),w=r("vsh_74340"),O=r("vsh_82905"),I=r("vsh_21469"),D=r("vsh_8073"),L=function(){function e(t,r){var n=this;(0,b.Z)(this,e),this.onSheetLoaded=t,this.useTTUOptimizationQ2=r,this.sheetBlockCounter=new Map,this.getAllDepSheetIds=(0,I.Z)((function(e){return Array.from((0,w.WDp)(n.backRefSheetIdDeps,n.forwardRefSheetIdDeps,e))})),this.getAllForwardRefDepSheetIds=(0,I.Z)((function(e){return(0,w.KjG)([e],n.forwardRefSheetIdDeps)})),this.getAllBackRefDepSheetIds=(0,I.Z)((function(e){return(0,w.KjG)([e],n.backRefSheetIdDeps)}))}return(0,C.Z)(e,[{key:"triggerSheetLoaded",value:function(e){this.onSheetLoaded(e),this.sheetBlockCounter.delete(e)}},{key:"setDependency",value:function(e,t){var r=t.dependencies,n=t.refDependencies,i=t.sheetBlock,o=t.forwardRefDependencies;for(var s in this.sheetDepBlockTokens=r,this.backRefSheetIdDeps=n,this.forwardRefSheetIdDeps=o,this.sheetBlockInfo=i,r)e.getSheetFromId(s)&&(r[s].size?this.sheetBlockCounter.set(s,this.useTTUOptimizationQ2?new Set(Object.keys(i[s]||{})):r[s]):this.triggerSheetLoaded(s));this.sheetBlock=i}},{key:"updateDependency",value:function(e){var t=e.dependencies,r=e.refDependencies,n=e.sheetBlock,i=e.forwardRefDependencies;Object.assign(this.sheetDepBlockTokens,t),Object.assign(this.backRefSheetIdDeps,r),Object.assign(this.forwardRefSheetIdDeps,i),Object.assign(this.sheetBlockInfo,n)}},{key:"triggerLoadedIfNoDepBlock",value:function(e){var t=this.sheetBlockCounter.get(e);t&&0!==t.size||this.triggerSheetLoaded(e)}},{key:"reduceBySheetBlock",value:function(e,t){var r=this;this.getAllDepSheetIds(e).forEach((function(e){var n=r.sheetBlockCounter.get(e);n&&(n.delete(t),0===n.size&&r.triggerSheetLoaded(e))}))}},{key:"applyMutationData",value:function(e,t,r){var n=this,i=t.sheetId,o=t.blockToken,s=t.blockData,a=t.range,c=e.getSheetFromId(i);if(s&&c&&"string"==typeof s){var u=e.fiberTaskScheduler;u.add(i,D.ArrayIter.fromArray([s]).do((function(s){var c=a?{row:a.rowStart,col:a.colStart}:void 0;e.applyCommands(e.decodeCommands(s),{isApplySnapshot:!0,offsetRange:c}),n.reduceBySheetBlock(i,o),null==r||r(t)}))),u.run()}}},{key:"applyBlockData",value:function(e,t,r){var n=this,i=t.sheetId,o=t.blockToken,s=t.blockData,a=t.startRowIndex,c=e.getSheetFromId(i);if(s&&c&&"string"!=typeof s){var u=e.fiberTaskScheduler;u.add(i,D.ArrayIter.fromArray([s]).do((function(s){(0,T.fBW)(c._getModel(),e,s,a),n.reduceBySheetBlock(i,o),null==r||r(t)}))),u.run()}}},{key:"applyTableData",value:function(e,t,r){var n=this,i=t.sheetId,o=t.rowData,s=t.blockToken;if(o){var a=e.fiberTaskScheduler;a.add(i,D.ArrayIter.fromArray([o]).do((function(o){(0,T.$2A)(e,i,o,{split:!1,token:s}),null==r||r(t),n.reduceBySheetBlock(i,s)}))),a.run()}}},{key:"getAllDepRelationsBySheetId",value:function(e){return{forwardRef:Array.from(this.forwardRefSheetIdDeps[e]||[]),backRef:Array.from(this.backRefSheetIdDeps[e]||[])}}},{key:"getBlocksBySheetId",value:function(e){var t;return null!==(t=this.sheetBlock[e])&&void 0!==t?t:{}}},{key:"reset",value:function(){this.sheetBlock={},this.sheetBlockCounter.clear(),this.forwardRefSheetIdDeps={},this.backRefSheetIdDeps={},this.sheetBlockInfo={},v(this.getAllDepSheetIds),v(this.getAllForwardRefDepSheetIds),v(this.getAllBackRefDepSheetIds)}},{key:"destroy",value:function(){this.reset(),this.onSheetLoaded=R.default}}]),e}(),M=r("vsh_12064"),N=r("vsh_93035"),B=r("vsh_56589"),x=r("vsh_22462"),F=r("vsh_73455"),P=function(e){function t(e){var r;return(0,b.Z)(this,t),(r=(0,M.Z)(this,(0,x.Z)(t).call(this))).stateCenter=e,r.subscriptions=[r.stateCenter.subscribeSheetStatusChanged(r.onSheetStatusChanged.bind((0,N.Z)(r))),r.stateCenter.subscribeSpreadStatusChanged(r.onSpreadStatusChanged.bind((0,N.Z)(r)))],r}return(0,F.Z)(t,e),(0,C.Z)(t,[{key:"onSheetStatusChanged",value:function(e){this.endTrack(e,!0)}},{key:"onSpreadStatusChanged",value:function(e){this.endTrack(e,!0)}},{key:"startTrackSheet",value:function(e){return this.stateCenter.getSheetStatus(e)?Promise.resolve(!0):(0,B.Z)((0,x.Z)(t.prototype),"startTrack",this).call(this,e)}},{key:"startTrackSpread",value:function(e){return this.stateCenter.getSpreadStatus()?Promise.resolve(!0):(0,B.Z)((0,x.Z)(t.prototype),"startTrack",this).call(this,e)}},{key:"resetStatus",value:function(){this.reset()}},{key:"destroy",value:function(){this.stateCenter={},this.subscriptions.forEach((function(e){e.unsubscribe()})),this.subscriptions.length=0,(0,B.Z)((0,x.Z)(t.prototype),"destroy",this).call(this)}}]),t}(s.Cl4),U=function(){function e(t){var r=this;(0,b.Z)(this,e),this.suite="SPREADSHEET",this.moduleName="dataloader-plugin",this.pendingLoadSheetTasks=[],this.pendingLoadSheetRecords=new Set,this.isSubBlockFetchPrepared=!1,this.priorityRecords=new Set,this.appliedContentMeta=null,this.isLoadProcessing=!1,this.name=n,this.triggerDataTableApplied=function(e){r.store.dispatchEvent("LoadStatusStore/DataTableApplied",e)},this.requestProvider=t.requestProvider,this.retryProvider=t.retryProvider,this.getActiveSheetId=t.getActiveSheetId,this.taskMode=t.taskMode||this.taskMode,this.sheetIdsToFetch=t.sheetIdsToFetch||[]}var t,r;return(0,C.Z)(e,[{key:"init",value:function(e){this.sdk=e,this.store=e.pluginStore,this.store.registerModule({namespace:k,state:(0,y.default)(_),commit:{setSheetContentMetaDataApplied:function(e,t){e.contentMetaDataApplied=t},setSheetLoadStatus:function(e,t){e.sheets[t.sheetId]=t.loadStatus},setFirstActiveSheetLoaded:function(e,t){e.firstActiveSheetLoaded=t},setSpreadLoaded:function(e,t){e.spreadLoaded=t},setSheetToUsage:function(e,t){e.sheetToUsage=t},resetLoadStatus:function(e){Object.assign(e,(0,y.default)(_))},resetSheetLoadedStatus:function(e,t){e.sheets=t}}}),this.reporterService=this.sdk.getService(O.zv),this.loggerService=this.sdk.getService(O.QX),this.configService=this.sdk.getService(O.tb),this.storeState=this.getPluginStoreState(),this.initStatusPromiseTracker(),this.initDataApply()}},{key:"destroy",value:function(){var e,t;this.reset(),null===(e=this.splitDataFetcher)||void 0===e||e.destroy(),null===(t=this.dataApplyCounter)||void 0===t||t.destroy(),this.sheetStatusPromiseTracker.destroy(),this.getActiveSheetId=R.default,this.sheetIdsToFetch.length=0,this.storeState={}}},{key:"isContentMetaDataApplied",value:function(){return this.storeState.contentMetaDataApplied}},{key:"isSheetLoaded",value:function(e){return this.storeState.sheets[e]===s.Px.LOADED}},{key:"isSheetLoading",value:function(e){return this.storeState.sheets[e]===s.Px.LOADING}},{key:"isSheetUnLoaded",value:function(e){return this.storeState.sheets[e]===s.Px.UNLOADED}},{key:"isSpreadLoaded",value:function(){return this.storeState.spreadLoaded}},{key:"isSheetToUsage",value:function(){return this.storeState.sheetToUsage}},{key:"isActiveSheetLoaded",value:function(){return this.storeState.firstActiveSheetLoaded}},{key:"resetLoadStatus",value:function(){this.logMessage("resetLoadStatus"),this.store.commit("LoadStatusStore/resetLoadStatus")}},{key:"hasSpecifySubBlocks",value:function(e){var t;return Boolean(e?null===(t=this.subBlocksToFetch)||void 0===t?void 0:t[e]:this.subBlocksToFetch)}},{key:"getSpecifySubBlocks",value:function(e){var t;return null===(t=this.subBlocksToFetch)||void 0===t?void 0:t[e]}},{key:"loadSheetsDirectly",value:function(e){var t=this;return Promise.all(e.map((function(e){return t.promoteSheetPriority(e),t.sheetStatusPromiseTracker.startTrackSheet(e)}))).then((function(e){}))}},{key:"loadSheets",value:function(e){var t=this;if(!this.isSubBlockFetchPrepared){var r=Math.random(),n=e.join();return this.logMessage("loadSheets but subBlockFetcData is not prepared: ".concat(n," requestCallId: ").concat(r)),new Promise((function(i,o){t.pendingLoadSheetTasks.push((function(){return t.logMessage("subBlockFetcData is prepared and start load sheets: ".concat(n," requestCallId: ").concat(r)),t.loadSheetsDirectly(e).then((function(){t.logMessage("loadSheets finish: ".concat(n," requestCallId: ").concat(r)),i()}))}))}))}return this.loadSheetsDirectly(e)}},{key:"triggerLoadSheet",value:function(e){var t=this;this.isSubBlockFetchPrepared?this.promoteSheetPriority(e):this.pendingLoadSheetRecords.has(e)||(this.pendingLoadSheetTasks.push((function(){t.promoteSheetPriority(e)})),this.pendingLoadSheetRecords.add(e))}},{key:"getSheetDepsRelation",value:function(e){return this.dataApplyCounter.getAllDepRelationsBySheetId(e)}},{key:"getPerformanceData",value:function(){var e=this,t=this.sdk.spread,r=this.sdk.spread.getSheetCount(),n=0,i=0,o=0;t.sheets.forEach((function(t){var r=t.getRowCount()*t.getColumnCount();n+=r,i+=e.sdk.spread.calcEngine.getSheetFormulaCount(t.id()),e.isSheetLoaded(t.id())&&o++}));var a=(0,s.xK_)();return{sheetCount:r,loadedSheetCount:o,loadedRate:o/r,cell_count:n,formula_count:i,totalJSHeapSize:(0,s.SSR)(a.totalJSHeapSize),usedJSHeapSize:(0,s.SSR)(a.usedJSHeapSize),jsHeapSizeLimit:(0,s.SSR)(a.jsHeapSizeLimit)}}},{key:"waitForSheetLoaded",value:function(e,t){return t?this.loadSheets([e]).then((function(){return!0})):this.sheetStatusPromiseTracker.startTrackSheet(e)}},{key:"waitForSpreadLoaded",value:function(){var e=this.sdk.getService(O.UU).token;return this.sheetStatusPromiseTracker.startTrackSpread(e)}},{key:"updateSheetStatus",value:function(e,t){var r=this.sdk.spread.getCalcEngine();this.isSheetLoaded(e)&&t!==s.Px.LOADED?this.logMessage("updateSheetStatus error, set ".concat(e," loadStatus ").concat(t," but current status is loaded")):(this.isSheetUnLoaded(e)&&t===s.Px.LOADING&&r.formulaService.suspend(),this.isSheetLoading(e)&&t===s.Px.LOADED&&(r.formulaService.resume(),r.statistics.reportCacheHitRate(e)),this.store.commit("LoadStatusStore/setSheetLoadStatus",{sheetId:e,loadStatus:t}))}},{key:"infoMessage",value:function(e,t,r){this.loggerService.info(this.moduleName,e,t,r)}},{key:"reset",value:function(){this.dataApplyCounter.reset(),this.sheetStatusPromiseTracker.resetStatus(),this.resetLoadStatus(),this.pendingLoadSheetTasks.length=0,this.pendingLoadSheetRecords.clear(),this.isSubBlockFetchPrepared=!1,this.appliedContentMeta=null,this.priorityRecords.clear()}},{key:"createSplitDataFetcher",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return new w.xej(Object.assign({requestProvider:this.requestProvider,retryProvider:this.retryProvider,taskMode:this.taskMode,parallelNum:this.configService.resolve("dataLoaderParallelNum",10),limit:this.configService.resolve("dataLoaderLimitPerSecond",80),canSetCache:!1,useTTUOptimizationQ2:this.configService.resolve("useTTUOptimizationQ2",!1),convertTableBlockEnable:this.configService.resolve("convertTableBlockEnable",!0)},e,{subBlocksToFetch:this.subBlocksToFetch}))}},{key:"initSplitDataFetcher",value:function(e){var t=this;this.splitDataFetcher||(this.splitDataFetcher=this.createSplitDataFetcher(e),this.splitDataFetcher.getData().subscribe((function(e){switch(e.type){case w.NsU.start:t.onFetchSplitDataStart(e.payload);break;case w.NsU.relationAnalyzed:t.onRelationAnalyzed(e.payload.from,e.payload.to);break;case w.NsU.subBlockFetchPrepared:t.onSubBlockFetchPrepared();break;case w.NsU.sheetStartLoad:t.store.dispatchEvent("LoadStatusStore/WorksheetLoading",e.payload),t.updateSheetStatus(e.payload,s.Px.LOADING);break;case w.NsU.cancel:t.onFetchSplitDataCancel();break;case w.NsU.subBlockLoaded:t.onSubBlockLoaded(e.payload);break;case w.NsU.formulaMetaLoaded:t.onFormulaMetaLoaded(e.payload);break;case w.NsU.formulaMetaEmpty:t.onFormulaMetaEmpty();break;case w.NsU.formulaBlockLoaded:t.onFormulaBlockLoaded(e.payload);break;case w.NsU.error:t.onSplitDataError(e);break;case w.NsU.success:t.onFetchSplitDataEnd();break;case w.LYB.start:t.onSubBlockFetchStart(e.payload);break;case w.LYB.end:t.onSubBlockFetchEnd(e);break;case w.LYB.error:t.onSubBlockError(e);break;case w.LYB.processDataStart:t.onSubBlockProcessDataStart(e)}})))}},{key:"initStatusPromiseTracker",value:function(){var e=this;this.sheetStatusPromiseTracker=new P({getSheetStatus:function(t){return e.isSheetLoaded(t)},getSpreadStatus:function(){return e.isSpreadLoaded()},subscribeSheetStatusChanged:function(t){return e.store.subscribeEvent("LoadStatusStore/WorksheetLoaded",t)},subscribeSpreadStatusChanged:function(t){var r=e.sdk.getService(O.UU).token;return e.store.subscribeEvent("LoadStatusStore/SpreadLoaded",(function(){return t(r)}))}})}},{key:"promoteSheetPriority",value:function(e){this.promoteSheetPriorityWithDep(e)}},{key:"promoteSheetPriorityWithDep",value:function(e){var t=this;this.dataApplyCounter.getAllForwardRefDepSheetIds(e).forEach((function(e){t.promoteSheetSubBlockPriority(e)}))}},{key:"promoteSheetSubBlockPriority",value:(r=(0,S.Z)(m().mark((function e(t){return m().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.isSheetLoaded(t)||this.priorityRecords.has(t)){e.next=9;break}return e.next=3,this.isSubBlockExpire();case 3:if(!e.sent){e.next=7;break}return this.onSubBlockExpire(t,this.splitDataFetcher.getSubBlockTokenTimeStamp()),e.abrupt("return");case 7:this.splitDataFetcher.setPriority((function(e){e.forEach((function(e){var r=e.extensions,n=r.sheetId,i=r.type;t===n&&(e.priority=i!==w.SV8.subBlock?w.T8N.Highest:w.T8N.High)}))})),this.priorityRecords.add(t);case 9:case"end":return e.stop()}}),e,this)}))),function(e){return r.apply(this,arguments)})},{key:"isSubBlockExpire",value:(t=(0,S.Z)(m().mark((function e(){return m().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",!1);case 1:case"end":return e.stop()}}),e)}))),function(){return t.apply(this,arguments)})},{key:"getPluginStoreState",value:function(){var e=this.store.getState("LoadStatusStore");if(!e)throw new Error("dataloader plugin store no state found");return e}},{key:"initDataApply",value:function(){this.dataApplyCounter||(this.dataApplyCounter=new L(this.onWorkSheetLoaded.bind(this),this.configService.resolve("useTTUOptimizationQ2",!1)))}},{key:"onRelationAnalyzed",value:function(e,t){var r=e.snapshot;(0,w.VVp)(e.schema_version)||(0,w.VVp)(r.schemaVersion)?this.onRelationAnalyzedV3(e,t):this.onRelationAnalyzedV2(r,t)}},{key:"onRelationAnalyzedV3",value:function(e,t){var r=e.snapshot;this.logMessage("onRelationAnalyzed",r,t),this.dataApplyCounter.setDependency(this.sdk.spread,t);var n=this.appliedContentMeta.sheetId;if(this.sdk.spread.getSheetFromId(n)){var i=Object.keys(r.blocks||{})[0];i&&(this.logMessage("onRelationAnalyzed delete firstBlockToken ".concat(i," for ").concat(n)),this.dataApplyCounter.reduceBySheetBlock(n,i))}t.sheetFormulaBlockParams&&0!==t.sheetFormulaBlockParams.length||this.store.dispatchEvent("LoadStatusStore/FormulaCacheEmpty")}},{key:"onRelationAnalyzedV2",value:function(e,t){var r=this;this.logMessage("onRelationAnalyzed",e,t),this.dataApplyCounter.setDependency(this.sdk.spread,t),Object.keys(e.sheets).forEach((function(t){var n=e.sheets[t].id;if(r.sdk.spread.getSheetFromId(n)){var i=function(e){var t,r;if(!e.blocks||!e.blocks.length)return"";var n=e.blocks[0],i=n.rowsCount,o=n.token,s=n.startRowIndex,a=null===(t=e.data)||void 0===t?void 0:t.dataTable;if(a)return a[s]&&a[s+i-1]?o:"";var c=null===(r=e.data)||void 0===r?void 0:r.dataTableBlockInfos;return c&&c.length&&c[0].startRowIndex===s&&c[0].table.rows.length===i?o:""}(e.sheets[t]);i&&(r.logMessage("onRelationAnalyzed delete firstBlockToken ".concat(i," for ").concat(n)),r.dataApplyCounter.reduceBySheetBlock(n,i))}})),0===Object.keys(t.sheetFormulaCache).length&&this.store.dispatchEvent("LoadStatusStore/FormulaCacheEmpty")}},{key:"onSubBlockFetchPrepared",value:function(){this.isSubBlockFetchPrepared=!0,this.pendingLoadSheetTasks.forEach((function(e){return e()})),this.pendingLoadSheetRecords.clear(),this.pendingLoadSheetTasks.length=0}},{key:"updateContentMetaStatus",value:function(e){var t;this.appliedContentMeta=e,this.store.commit("LoadStatusStore/setSheetContentMetaDataApplied",!0),this.logMessage("onContentMetaLoaded sheetId:".concat(null==e?void 0:e.sheetId," snapshotRev: ").concat(null==e||null===(t=e.snapshot)||void 0===t?void 0:t.rev),e),this.store.dispatchEvent("LoadStatusStore/ContentMetaApply",e)}},{key:"onSubBlockLoaded",value:function(e){var t,r;if(this.logMessage("subBlockData for sheetId: ".concat(e.sheetId," token: ").concat(null!==(t=null===(r=e.data)||void 0===r?void 0:r.block_token)&&void 0!==t?t:null)),e.data){var n=e.data,i=n.block_token,o=n.rowData,s=n.blockData,a=n.startRowIndex,c=n.range,u=n.blockVersion,l={sheetId:e.sheetId,startRowIndex:a,rowData:o,blockToken:i,blockData:s,range:c,blockVersion:u};try{if((0,w.VVp)(u))this.dataApplyCounter.applyMutationData(this.sdk.spread,l,this.triggerDataTableApplied);else!this.configService.resolve("convertTableBlockEnable",!0)&&s?this.dataApplyCounter.applyBlockData(this.sdk.spread,l,this.triggerDataTableApplied):this.dataApplyCounter.applyTableData(this.sdk.spread,l,this.triggerDataTableApplied);this.store.dispatchEvent("LoadStatusStore/DataTableLoaded",l)}catch(e){this.reporterService.captureException(e,{key:"SHEET_SPLIT_HANDLER_ROW_DATA_ERROR"})}}else this.dataApplyCounter.triggerLoadedIfNoDepBlock(e.sheetId)}},{key:"onFormulaMetaEmpty",value:function(){this.infoMessage("onFormulaMetaEmpty"),this.store.dispatchEvent("LoadStatusStore/FormulaCacheEmpty")}},{key:"onFormulaMetaLoaded",value:function(e){this.infoMessage("onFormulaMetaLoaded ".concat(e.sheetId),e.data),this.appliedContentMeta&&this.appliedContentMeta.changeset_list.length>0||(this.store.dispatchEvent("LoadStatusStore/FormulaCacheMetaLoaded",e.sheetId,e.data),(0,T.mdl)(this.sdk.spread,e.sheetId,e.data))}},{key:"onFormulaBlockLoaded",value:function(e){if(this.infoMessage("onFormulaBlockLoaded ".concat(e.sheetId," isLastBlock: ").concat(e.isLastBlock)),!(this.appliedContentMeta&&this.appliedContentMeta.changeset_list.length>0)){var t=e.sheetId,r=e.data,n=e.isLastBlock;this.store.dispatchEvent("LoadStatusStore/FormulaCacheBlockLoaded",t,r,n),(0,T.Glb)(this.sdk.spread,t,r.map((function(e){return e.formulaBlock})).filter((function(e){return null!==e})),n)}}},{key:"markSheetDirty",value:function(e){var t=this.sdk.spread.getSheetFromId(e);t&&t.markSheetDirty()}},{key:"onSplitDataError",value:function(e){var t=e.payload,r=e.errorType,n=e.identity,i=e.originTask,s=n.blockToken,a="onSplitDataFetchError errorType: ".concat(r," blockToken: ").concat(s);switch(e.errorType){case w.aG9.processDataCrash:this.onSplitDataProcessDataCrash(e,s,a);break;case w.aG9.fetchError:this.onSplitDataFetchError(e,s,a);break;case w.aG9.validateError:this.onSplitDataValidateError(e,s,a)}var c="-1",u="";if(t instanceof Error&&(0,A.default)(t.code))c=o.STATUS_CODE.JS_INTERNAL_ERROR,u=t.message;else if("string"==typeof t)c=o.STATUS_CODE.JS_INTERNAL_ERROR,u=t;else if(t.payload&&t.code===O.jK.ERROR_RETRY_EXCEED){var l,h=t.payload;c=String(h.code)||O.jK.ERROR_RETRY_EXCEED,null!=i&&null!==(l=i.retryConfig)&&void 0!==l&&l.exceedSilent&&(c=O.jK.SILENT_ERROR),u=h instanceof Error?h.message:h.msg||""}else c=t.code,u=t.msg;this.onSplitDataHandlerError(c,u,s,e.errorType),this.onLoadProcessAborted("onSplitDataError")}},{key:"onFetchSplitDataSuccess",value:function(){this.logMessage("onSplitDataFetchSuccess")}},{key:"onWorkSheetLoaded",value:function(e){if(!this.isSheetLoaded(e))try{var t=e===this.getActiveSheetId();this.isSheetUnLoaded(e)&&(this.updateSheetStatus(e,s.Px.LOADING),this.store.dispatchEvent("LoadStatusStore/WorksheetLoading",e)),this.logMessage("onWorkSheetLoaded sheetId: ".concat(e)),this.updateSheetStatus(e,s.Px.LOADED),this.store.dispatchEvent("LoadStatusStore/WorksheetLoaded",e,t),this.priorityRecords.add(e),this.onSplitDataHandlerSheetComplete({sheetId:e,isActiveSheet:t}),e!==this.getActiveSheetId()||this.isActiveSheetLoaded()||(this.updateActiveSheetLoadStatus(e),this.isOnDemandMode()&&this.onSheetToUsage()),this.markSheetDirty(e),this.checkSpreadLoaded()}catch(e){this.onHandleBlockDataError(e,s.vgr.HANDLE_SHEET_COMPLETE,"error on sheet loaded")}}},{key:"updateActiveSheetLoadStatus",value:function(e){this.logMessage("onWorkSheetLoaded active sheet loaded ".concat(e)),this.store.dispatchEvent("LoadStatusStore/FirstActiveSheetLoaded",e,this.taskMode),this.store.commit("LoadStatusStore/setFirstActiveSheetLoaded",!0)}},{key:"checkSpreadLoaded",value:function(){var e=this.storeState.sheets;Object.keys(e).every((function(t){return e[t]===s.Px.LOADED}))&&(this.onSplitDataHandlerComplete(),this.onSpreadLoaded())}},{key:"onSheetToUsage",value:function(){this.logMessage("onSheetToUsage isSpreadLoaded:".concat(this.isSpreadLoaded())),this.onLoadProcessStopped(),this.appliedContentMeta&&this.appliedContentMeta.changeset_list.length>0&&this.applyChangesets(this.appliedContentMeta.changeset_list),this.sdk.spread.getCalcEngine().formulaService.resume(),this.updateSheetToUsageState()}},{key:"applyChangesets",value:function(e){var t=this;this.logMessage("apply changesetList in content meta. length is ".concat(e.length));var r=!1;e.forEach((function(e){var n=e.content||[];r=n.some((function(e){return e.action===s.aOo.RECOVER})),t.sdk.spread.applyActions(n,!1,!0)})),r&&this.reporterService.eventReport({key:"client_sheet_content_meta_changeset_list_has_recover"})}},{key:"updateSheetToUsageState",value:function(){this.store.commit("LoadStatusStore/setSheetToUsage",!0),this.store.dispatchEvent("LoadStatusStore/SheetToUsage",this.appliedContentMeta,this.isSpreadLoaded())}},{key:"onSpreadLoaded",value:function(){try{this.updateSpreadLoadedStatus(),this.taskMode===s.AXv.runInBackground&&this.onSheetToUsage(),this.appliedContentMeta=null,this.afterSpreadLoaded()}catch(e){this.onHandleBlockDataError(e,s.vgr.HANDLE_SPREAD_COMPLETE,"error on active spread loaded")}}},{key:"onLoadProcessStarted",value:function(){this.logMessage("onLoadProcessStarted and set isLoadProcessing true")}},{key:"onLoadProcessStopped",value:function(){this.logMessage("onLoadProcessStopped and set isLoadProcessing false")}},{key:"onLoadProcessAborted",value:function(e){this.logMessage("onLoadProcessAborted and set isLoadProcessing false. pointMessage:".concat(e))}},{key:"updateSpreadLoadedStatus",value:function(){this.logMessage("onSpreadLoaded"),this.store.commit("LoadStatusStore/setSpreadLoaded",!0),this.store.dispatchEvent("LoadStatusStore/SpreadLoaded",this.appliedContentMeta)}},{key:"afterSpreadLoaded",value:function(){this.store.dispatchEvent("LoadStatusStore/AfterSpreadLoaded")}},{key:"applySnapshot",value:function(e){this.onBeforeApplySnapshot(e);try{this.sdk.spread.fromJSON(e)}catch(e){return this.reporterService.captureException(e,{key:"APPLY_SNAPSHOT_ERROR"}),this.onApplySnapshotError(e),!1}return this.onAfterApplySnapshot(),!0}},{key:"applyMutation",value:function(e){this.onBeforeApplySnapshot(e.snapshot);try{this.sdk.spread._clearSheetsImpl(),this.sdk.spread.applyMutationSnapshot(e.snapshot)}catch(e){return this.reporterService.captureException(e,{key:"APPLY_MUTATION_ERROR"}),this.onApplySnapshotError(e),!1}return this.onAfterApplySnapshot(),!0}},{key:"isOnDemandMode",value:function(){return this.taskMode===s.AXv.onDemand}},{key:"logMessage",value:function(e,t,r){this.loggerService.log(this.moduleName,e,t,r)}},{key:"onSplitDataHandlerMeta",value:function(e){this.reporterService.eventReport({key:"client_sheet_split_data_load_meta",sheet_id:e.sheetId,row_count:e.rowCount})}},{key:"onSplitDataHandlerSheetComplete",value:function(e){}},{key:"onFetchSheetSplitData",value:function(){}},{key:"onSplitDataHandlerComplete",value:function(){this.reporterService.eventReport({key:"client_sheet_split_data_load_complete"})}},{key:"onSplitDataProcessDataCrash",value:function(e,t,r){}},{key:"onSplitDataFetchError",value:function(e,t,r){var n=e.payload.code,i=e.payload.payload instanceof Error?e.payload.payload.message:e.payload.payload.msg,o=e.requestContext;this.logMessage("".concat(r," code: ").concat(n," message: ").concat(i," block_token: ").concat(null==o?void 0:o.blockToken," schema_version: ").concat(null==o?void 0:o.schemaVersion," innerPayload: ").concat(null==o?void 0:o.code," request_id: ").concat(null==o?void 0:o.requestId))}},{key:"onSplitDataValidateError",value:function(e,t,r){var n=e.payload,i=e.validateResult,o=e.fromCache;this.logMessage("".concat(r," code: ").concat(n.code," message: ").concat(n.msg," validateResult:").concat(i," fromCache:").concat(o)),i!==w.Jdn.NoBlocksCollection?i!==w.Jdn.NoTargetBlockDataInCollection||this.reporterService.eventReport({key:"client_sheet_block_handle_info_dev",block_type:s.vgr.INVALID_BLOCK_TOKEN,stage:"onTaskDone",subblockToken:t,res:i}):this.reporterService.eventReport({key:"client_sheet_block_handle_info_dev",block_type:s.vgr.INVALID_BLOCK_DATA,stage:"onTaskDone",subblockToken:t,res:i})}},{key:"onSubBlockExpire",value:function(e,t){this.infoMessage("onSubBlockExpire sheetId: ".concat(e," baseTime: ").concat(t))}},{key:"onSubBlockFetchStart",value:function(e){this.infoMessage("onSubBlockFetchStart blockToken: ".concat(e.blockToken," sheetId: ").concat(e.sheetId))}},{key:"onSubBlockFetchEnd",value:function(e){var t=e.payload;this.infoMessage("onSubBlockFetchEnd blockToken: ".concat(t.blockToken," sheetId: ").concat(t.sheetId))}},{key:"onSplitDataHandlerError",value:function(e,t,r,n){this.reporterService.eventReport({key:"client_sheet_split_data_load_fail",error_code:e,type:n})}},{key:"onSubBlockError",value:function(e){var t=e.errorType,r=e.identity;this.logMessage("onSubBlockError errorType: ".concat(t," blockToken: ").concat(r.blockToken))}},{key:"onSubBlockProcessDataStart",value:function(e){}},{key:"onFetchSplitDataStart",value:function(e){this.logMessage("onFetchSplitDataStart, schemaVersion:".concat(e.schema_version))}},{key:"onFetchSplitDataEnd",value:function(){this.logMessage("onFetchSplitDataEnd, isSpreadLoaded: ".concat(this.isSpreadLoaded()))}},{key:"initSheetLoadStatus",value:function(e){var t=this;Object.values(e.sheets||{}).forEach((function(e){var r=e.id;t.updateSheetStatus(r,s.Px.UNLOADED)}))}},{key:"onHandleBlockDataError",value:function(e,t,r){this.logMessage("onHandleBlockDataError ex.message: ".concat(e.message," ex.type: ").concat(t," biz message: ").concat(r)),this.reporterService.eventReport({key:"client_sheet_sync_handle_block_error",msg:r}),this.reporterService.captureException(e,{key:"ERROR_HANDLE_BLOCK"})}},{key:"onBeforeApplySnapshot",value:function(e){var t=this.sdk.spread.getCalcEngine();t.formulaService.suspend(),t.formulaSpace.reactivitySpace.ignoreDirty(!0);var r=e.extra&&e.extra.reference;this.sdk.spread.updateBlockReference(r),this.store.dispatchEvent("LoadStatusStore/BeforeApplySnapshot",e)}},{key:"onAfterApplySnapshot",value:function(){this.sdk.spread.getCalcEngine().formulaSpace.reactivitySpace.ignoreDirty(!1),this.store.dispatchEvent("LoadStatusStore/AfterApplySnapshot")}},{key:"onApplySnapshotError",value:function(e){}},{key:"onFetchSplitDataCancel",value:function(){}}]),e}(),H=r("vsh_74561"),V=r("vsh_65498"),Z=r("vsh_93301"),j=r("vsh_59980"),G=r("vsh_65726"),q=r("vsh_54997"),z=r.n(q),W=r("vsh_21955"),$=r("vsh_86217"),K=r("vsh_36290"),Y=r("vsh_30856");function X(e,t){var r="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!r){if(Array.isArray(e)||(r=function(e,t){if(!e)return;if("string"==typeof e)return J(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);"Object"===r&&e.constructor&&(r=e.constructor.name);if("Map"===r||"Set"===r)return Array.from(e);if("Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r))return J(e,t)}(e))||t&&e&&"number"==typeof e.length){r&&(e=r);var n=0,i=function(){};return{s:i,n:function(){return n>=e.length?{done:!0}:{done:!1,value:e[n++]}},e:function(e){throw e},f:i}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,s=!0,a=!1;return{s:function(){r=r.call(e)},n:function(){var e=r.next();return s=e.done,e},e:function(e){a=!0,o=e},f:function(){try{s||null==r.return||r.return()}finally{if(a)throw o}}}}function J(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,n=new Array(t);r<t;r++)n[r]=e[r];return n}var Q,ee=function(e){var t=new Map;if(e.group){var r,n=X(e.group);try{for(n.s();!(r=n.n()).done;){var i=r.value;i.state===T.w2y.Fold&&i.target.type===s.xj7.ROW&&t.set(i.target.row,i.target.rowCount)}}catch(e){n.e(e)}finally{n.f()}}return t},te=function(e){var t,r,n=null===(t=e.data)||void 0===t?void 0:t.dataTableBlockInfos,i=null==n?void 0:n[n.length-1],o=i?i.startRowIndex+i.table.rows.length:function(e){var t,r=null===(t=e.data)||void 0===t?void 0:t.dataTable;if(!r)return-1;var n=Object.keys(r),i=parseInt(n[n.length-1],10);return i>=0?i+1:-1}(e),s=e.blocks,a=null==s?void 0:s[s.length-1];return a&&a.startRowIndex+a.rowsCount===o&&null!==(r=e.rowCount)&&void 0!==r?r:o},re=function(e,t){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:window.innerHeight;try{var n,i,o,s,a=e.blocks;if(!a)return;for(var c=[],u=new Set((null===(n=e.rowFilter)||void 0===n?void 0:n.filteredOutRows)||[]),l=ee(e),h=e.rowCount||(null===(i=e.rows)||void 0===i?void 0:i.length)||T.mkl._defaultRowCount,d=null!==(o=null==t||null===(s=t.defaults)||void 0===s?void 0:s.rowHeight)&&void 0!==o?o:T.mkl._defaultRowHeight,f=0,p=0,v=0,g=function(){for(;v<a.length&&p>=a[v].startRowIndex+a[v].rowsCount;)v++;a[v]&&c[c.length-1]!==a[v]&&c.push(a[v])},y=function(){var t,r;return l.has(p)?l.get(p):u.has(p)||!1===(null===(t=e.rows)||void 0===t||null===(r=t[p])||void 0===r?void 0:r.visible)?1:0},_=function(){f<r&&p<h&&(f+=(h-p-1)*d);var t=te(e);return t>=p?{height:f}:(c.length>0&&t>=c[0].startRowIndex+c[0].rowsCount&&c.splice(0,1),{height:f,blocks:0===c.length?void 0:c})};f<r&&p<h&&v<a.length;){var k,E,m,S=y();S?p+=S:(g(),f+=null!==(k=null===(E=e.rows)||void 0===E||null===(m=E[p])||void 0===m?void 0:m.size)&&void 0!==k?k:d,p++)}return _()}catch(e){return}},ne=function(e,t,r){var n,i={},o=function(e,t,r){for(var n=e.sheets||{},i=Object.keys(n),o=new Map,s=0,a=i;s<a.length;s++){var c=a[s];o.set(n[c].id,n[c])}return r.length>0?r.map((function(e){return o.get(e)})):[o.get(t)]}(e,t,r),s=window.innerHeight,a=X(o);try{for(a.s();!(n=a.n()).done;){var c=n.value;if(c){var u=re(c,e,s);if(u){var l=u.blocks,h=u.height;l&&(i[c.id]=l),h&&(s-=h)}}}}catch(e){a.e(e)}finally{a.f()}if(0!==Object.keys(i).length)return i},ie=function(e,t,r,n){var i,o=arguments.length,s=o<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,r):n;if("object"===("undefined"==typeof Reflect?"undefined":(0,V.Z)(Reflect))&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,t,r,n);else for(var a=e.length-1;a>=0;a--)(i=e[a])&&(s=(o<3?i(s):o>3?i(t,r,s):i(t,r))||s);return o>3&&s&&Object.defineProperty(t,r,s),s},oe="SHEET_CLIENT_VARS",se="ccm_sheet_clientvars_error",ae=Q=function(e){function t(e){var r;return(0,b.Z)(this,t),(r=(0,M.Z)(this,(0,x.Z)(t).call(this,e))).spreadEventSubscription=null,r.spreadLoadStartTime=0,r.logStageMap={},r.isAsyncCopyingSheet=!1,r.recoverRefreshTimes=0,r.recoverRefreshTimer=0,r._clientVarsDataVersion=s.n0b.REF,r.reloadForDowngrade=!1,r.downgradeForSubBlock=!1,r.snippetSplitDataFetchers=new Map,r.pendingPromotePrioritySheets=new Set,r.dataAdapter=e.dataAdapter,r.preloadHttp=e.preloadHttp,r.preloadData=e.preloadData,r}var r,n,a,c;return(0,F.Z)(t,e),(0,C.Z)(t,[{key:"init",value:function(e){(0,B.Z)((0,x.Z)(t.prototype),"init",this).call(this,e),this.trackerService=this.sdk.getService(O.kM),this.clientMetaService=this.sdk.getService(O.UU),this.engineService=this.sdk.getService(w.AHm),this.initSpreadEvents()}},{key:"destroy",value:function(){var e,r;(0,B.Z)((0,x.Z)(t.prototype),"destroy",this).call(this),window.clearTimeout(this.recoverRefreshTimer),this.spreadEventSubscription&&this.spreadEventSubscription.unsubscribe(),this.spreadEventSubscription=null,null===(e=this.clientVarsFetcher)||void 0===e||e.destroy(),null===(r=this.historyFetcher)||void 0===r||r.destroy(),this.preloadHttp={},this.dataAdapter={},this.clientVarsFetchOptions={},this.snippetSplitDataFetchers.forEach((function(e,t){e.destroy()})),this.snippetSplitDataFetchers.clear(),this.pendingPromotePrioritySheets.clear()}},{key:"reset",value:function(){(0,B.Z)((0,x.Z)(t.prototype),"reset",this).call(this),this.logStageMap={},this.clientVarsDataVersion=s.n0b.REF}},{key:"onLoadProcessStarted",value:function(){(0,B.Z)((0,x.Z)(t.prototype),"onLoadProcessStarted",this).call(this),this.isLoadProcessing=!0}},{key:"onLoadProcessStopped",value:function(){(0,B.Z)((0,x.Z)(t.prototype),"onLoadProcessStopped",this).call(this),this.isLoadProcessing=!1}},{key:"onLoadProcessAborted",value:function(e){(0,B.Z)((0,x.Z)(t.prototype),"onLoadProcessAborted",this).call(this,e),this.isLoadProcessing=!1,this.reloadForDowngrade&&this.reporterService.eventReport({key:"ccm_sheet_down_grade_dev",result:"fail",message:e})}},{key:"afterSpreadLoaded",value:function(){(0,B.Z)((0,x.Z)(t.prototype),"afterSpreadLoaded",this).call(this);var e=this.sdk.spread.getCalcEngine().formulaSpace;this.trackerService.collect(s.FHD.APPLY_DATA,{status:s.G2P.END,formula_count:e.formulas.size});var r=Date.now()-this.spreadLoadStartTime;this.reporterService.eventReport({key:"client_sheet_spread_load_time",cost_time:Math.min(r,6e4)}),this.splitDataFetcher.clearSubBlockCache()}},{key:"onSplitDataHandlerComplete",value:function(){this.reporterService.eventReport({key:"client_sheet_split_data_load_complete"})}},{key:"onSplitDataProcessDataCrash",value:function(e,r,n){(0,B.Z)((0,x.Z)(t.prototype),"onSplitDataProcessDataCrash",this).call(this,e,r,n),e.payload instanceof Error&&this.logMessage("onSplitDataProcessDataCrash ex.message: ".concat(e.payload.message)),this.loggerService.error("dataloader-plugin","onSplitDataProcessDataCrash",e.payload)}},{key:"onSplitDataError",value:function(e){this.checkHandleSubBlockDowngrade(e)?(this.onLoadProcessAborted("SUBBLOCK_DOWN_GRADE"),this.reloadForDowngrade=!0,this.reload(s.Hg0.genSpecTid(s.$UQ.SUBBLOCK_DOWN_GRADE),{},{code:"SUB_BLOCK_DOWN_GRADE"})):(0,B.Z)((0,x.Z)(t.prototype),"onSplitDataError",this).call(this,e)}},{key:"isSubBlockExpire",value:(c=(0,S.Z)(m().mark((function e(){var t,r;return m().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!this.splitDataFetcher.isSubBlockFetchExpire()){e.next=13;break}return e.prev=1,e.next=4,this.fetchRemoteClientVarsVersion();case 4:return t=e.sent,r=this.engineService.getBaseRev(),e.abrupt("return",r<t);case 9:return e.prev=9,e.t0=e.catch(1),console.log("checkSubBlockExpire fetchRemoteClientVarsVersion error",e.t0),e.abrupt("return",!1);case 13:return e.abrupt("return",!1);case 14:case"end":return e.stop()}}),e,this,[[1,9]])}))),function(){return c.apply(this,arguments)})},{key:"fetchRemoteClientVarsVersion",value:(a=(0,S.Z)(m().mark((function e(){var t,r,n,i,o,s,a;return m().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=this.sdk.getService(O.UU),r=t.token,n=t.memberId,i="".concat(this.requestProvider.apiUrls.POST_GET_FILE_VERSION,"?member_id=").concat(n),o={obj_list:[{type:"SPREADSHEET",token:r}]},s={"Content-Type":"application/json"},e.next=6,this.requestProvider.postRequest(i,o,{headers:s}).promise;case 6:return a=e.sent,e.abrupt("return",a.data.obj_version[0].version);case 8:case"end":return e.stop()}}),e,this)}))),function(){return a.apply(this,arguments)})},{key:"checkHandleSubBlockDowngrade",value:function(e){var t,r;return null!==this.appliedContentMeta&&(e.errorType===w.aG9.fetchError&&(null===(t=e.payload)||void 0===t||null===(r=t.payload)||void 0===r?void 0:r.code)===w.IKc.DOWN_GRADE)}},{key:"onSplitDataHandlerError",value:function(e,r,n,i){if(this.logStageMap[s.FHD.FETCH_SUB_BLOCK]||this.trackerService.collect(s.FHD.FETCH_SUB_BLOCK,{status:s.G2P.ERROR}),(0,B.Z)((0,x.Z)(t.prototype),"onSplitDataHandlerError",this).call(this,e,r,n,i),e!==O.jK.SILENT_ERROR){var o=i===w.aG9.fetchError?O.jK.ERR_BUNDLE_FETCH_BLOCKS:O.jK.ERR_HANDLE_BLOCK_DATA,a=i===w.aG9.fetchError?O.NI.NetworkError:O.NI.ClientError;this.sdk.getService(O.Tl).record(O.FP.Plugin,a,o,{raw:{code:e},message:r,blockToken:n})}}},{key:"onFetchSplitDataStart",value:function(e){this.logStageMap[s.FHD.FETCH_SUB_BLOCK]||(this.trackerService.collect(s.FHD.STAGE_PENDING,{status:s.G2P.END,start_stage:s.FHD.FASTER_FIRST_TICK,next_stage:s.FHD.FETCH_SUB_BLOCK}),this.trackerService.collect(s.FHD.FETCH_SUB_BLOCK,{status:s.G2P.START})),this.trackerService.collect(Y.j5.FETCH_SUB_BLOCK_START),this.trackerService.collect(Y.A6.FETCH_SHEET_SUB_BLOCK_START),(0,B.Z)((0,x.Z)(t.prototype),"onFetchSplitDataStart",this).call(this,e),this.initSheetLoadStatus(e.snapshot)}},{key:"onFetchSplitDataEnd",value:function(){this.trackerService.collect(s.FHD.FETCH_SUB_BLOCK,{status:s.G2P.END}),this.logStageMap[s.FHD.FETCH_SUB_BLOCK]=!0,this.trackerService.collect(s.FHD.STAGE_PENDING,{status:s.G2P.START,start_stage:s.FHD.FETCH_SUB_BLOCK,next_stage:s.FHD.TIME_TO_USAGE}),(0,B.Z)((0,x.Z)(t.prototype),"onFetchSplitDataEnd",this).call(this),this.trackerService.collect(Y.j5.FETCH_SUB_BLOCK_SUCCESS),this.trackerService.collect(Y.A6.FETCH_SHEET_SUB_BLOCK_COMPLETE)}},{key:"onHandleBlockDataError",value:function(e,r,n){(0,B.Z)((0,x.Z)(t.prototype),"onHandleBlockDataError",this).call(this,e,r,n),this.sdk.getService(O.Tl).record(O.FP.Plugin,O.NI.ClientError,O.jK.ERR_HANDLE_BLOCK_DATA,null)}},{key:"onApplySnapshotError",value:function(e){this.sdk.getService(O.Tl).record(O.FP.Plugin,O.NI.ClientError,O.jK.ERR_CLIENTVARS_INVALID,e)}},{key:"initClientVarsFetcher",value:function(){this.clientVarsFetcher||(this.clientVarsFetcher=new w.hl7({requestProvider:this.requestProvider,retryProvider:this.retryProvider,dataAdapterContext:this.getAdaptorContext(),convertTableBlockEnable:this.configService.resolve("convertTableBlockEnable",!0)}),this.startGetClientVars())}},{key:"startGetClientVars",value:function(){var e=this;this.clientVarsFetcher.getData().subscribe((function(t){var r,n,i;switch(t.type){case w.fW1.start:e.onClientVarsFetchStart(t.fromCache);break;case w.fW1.processDataStart:e.onHandleClientVarsStart(t.payload,t.fromCache);break;case w.fW1.processDataError:e.onHandleClientVarsFail(t.errors,t.payload),e.onProcessClientVarsMessageError(t.payload,t.fromCache,t.errors);break;case w.fW1.end:e.onClientVarsFetchEnd(t.payload,t.fromCache);break;case w.fW1.success:e.onHandleClientVarsEnd(t.payload,t.fromCache),e.onClientVarsLoaded(t.payload,t.fromCache),window.clientVarsInfo={clientVarsVersion:null===(r=t.payload)||void 0===r?void 0:r.version,fromCache:t.fromCache,changesetLength:null===(n=t.payload)||void 0===n||null===(i=n.changeset_list)||void 0===i?void 0:i.length};break;case w.fW1.error:e.onClientVarsError(t)}}))}},{key:"initHistoryFetcher",value:function(){var e=this;this.historyFetcher||(this.historyFetcher=new w.b6k({requestProvider:this.requestProvider,retryProvider:this.retryProvider}),this.historyFetcher.getData().subscribe((function(t){switch(t.type){case w.vp3.success:e.logMessage("fetchHistory success: ".concat(t.payload.metaData.version)),e.onContentMetaLoaded(l(t.payload.metaData),w.YwH.HISTORY);break;case w.vp3.error:e.onFetchHistoryError(t.payload);break;case w.vp3.cancel:e.logMessage("fetchHistory canceled");break;case w.vp3.retry:e.logMessage("fetchHistory retry, retryCount: ".concat(t.payload.retryCount))}})))}},{key:"initSpreadEvents",value:function(){this.spreadEventSubscription=this.sdk.spread.subscribe(this.getDepends())}},{key:"onFetchHistoryError",value:function(e){this.logMessage("fetchHistory error")}},{key:"fetchHistory",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[],r=arguments.length>2?arguments[2]:void 0,n=this.sdk.getService(O.UU),i=n.token;this.initHistoryFetcher(),this.logMessage("fetchHistory rev: ".concat(e," dataVersion: ").concat(r));var o={rev:e,token:i,changesets:t,type:0};this.historyFetcher.fetch(o).toPromise()}},{key:"fetchClientVars",value:function(e){this.logMessage("fetchClientVars token:".concat((0,o.encryptTea)(e.token))),this.onLoadProcessStarted(),this.clientVarsFetcher.fetch(e,{retryConfig:{shouldRetry:this.shouldClientVarsRetry.bind(this),onRetry:this.onClientVarsFetchRetry.bind(this)},requestConfig:this.getClientVarsFetcherRequestConfig()})}},{key:"getClientVarsFetcherRequestConfig",value:function(){return{timeout:this.configService.resolve("dataLoaderFetchClientVarsTimeout",2e4)}}},{key:"shouldClientVarsRetry",value:function(e,t,r,n){return this.fetchClientVarsShouldRetryChecker(e,r||[],n||[])}},{key:"onClientVarsFetchStart",value:function(e){this.logMessage("onClientVarsFetchStart fromCache:".concat(e)),this.spreadLoadStartTime=Date.now(),this.logStageMap[s.FHD.FETCH_CLIENT_VARS]||(this.trackerService.collect(s.FHD.STAGE_PENDING,{status:s.G2P.END,start_stage:s.FHD.DOWNLOAD_RESOURCE,next_stage:s.FHD.FETCH_CLIENT_VARS}),this.trackerService.collect(s.FHD.FETCH_CLIENT_VARS,{status:s.G2P.START})),this.trackerService.collect(Y.j5.FETCH_FILE_CLIENTVARS_START),this.trackerService.collect(Y.A6.FETCH_SHEET_CLIENTVARS_START)}},{key:"onClientVarsLoaded",value:(n=(0,S.Z)(m().mark((function e(t){var r,n,i,o,a,c,l,h,d,f,p,v,g,y,_,k,E,S,b,C,R=arguments;return m().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(i=R.length>1&&void 0!==R[1]&&R[1],this.store.dispatchEvent("LoadStatusStore/ClientVarsLoaded",t,i),!this.processRecoverActionInChangesetList(t.changeset_list)){e.next=4;break}return e.abrupt("return");case 4:if(o=t.revision||0,a=-1,c=this.sdk.getService(O.UU),l=c.token,h=null===(r=this.preloadData)||void 0===r?void 0:r.getBackupPreload(l),null===(n=this.preloadData)||void 0===n||n.clearBackupPreload(),!(d=this.hasEditablePermission(t.permissions))||!this.isNeedCheckBackup()){e.next=41;break}return f=Date.now(),this.trackerService.collect(s.FHD.INDEXDB_LOCAL_CHECK,{status:s.G2P.START}),v=this.sdk.getService(w.AKO),g=this.configService,y=g.resolve("indexDBOverTimeLimit",0),_=[v.needHandleBackup(h)],y>0&&_.push(new Promise((function(e){return setTimeout(e,y)}))),e.next=20,Promise.race(_);case 20:if(k=e.sent,this.trackerService.collect(s.FHD.INDEXDB_LOCAL_CHECK,{status:s.G2P.END}),E=Date.now()-f,!k){e.next=40;break}if(this.trackerService.collect(s.FHD.INDEXDB_LOCAL_REV_CHECK,{status:s.G2P.START}),S=Date.now(),e.t0=g.resolve("needSetBackupFlagWithLock",!1),e.t0){e.next=31;break}return e.next=30,v.trySetBackupFlagWithLock();case 30:e.t0=e.sent;case 31:if(!e.t0){e.next=38;break}return e.next=35,v.prepareHandlingBackup(h);case 35:return e.next=37,v.checkBackupRev(h);case 37:a=e.sent;case 38:this.trackerService.collect(s.FHD.INDEXDB_LOCAL_REV_CHECK,{status:s.G2P.END}),p=Date.now()-S;case 40:this.trackerService.collect(Y.j5.INDEX_DB_CHECK,{hasLocalCs:k,localCheckCost:E,localRevCheckCost:p});case 41:this.clientVarsDataVersion=t.version,this.logMessage("clientVarsRev: ".concat(o," localBaseRev: ").concat(a," editable:").concat(d)),(b=a>=0&&a<o)&&(o=a),this.store.dispatchEvent("LoadStatusStore/RevInit",{rev:o}),this.reloadForDowngrade?(this.fetchHistory(o,t.changeset_list,t.version),this.reporterService.eventReport({key:"ccm_sheet_down_grade_dev",result:"start"})):b?(this.fetchHistory(o,t.changeset_list,t.version),this.onBackupBaseRevDiff(t.revision,a,i)):(C=u(t),this.onContentMetaLoaded(C,w.YwH.NEW),this.checkSheetInClientVars(C,this.sheetIdsToFetch));case 47:case"end":return e.stop()}}),e,this)}))),function(e){return n.apply(this,arguments)})},{key:"isNeedCheckBackup",value:function(){return!(0,s.pPK)()}},{key:"onClientVarsProcessDataCrash",value:function(e){var t=e.payload,r=e.errorType,n=e.fromCache,i=t.originalData,o=t.ex,s=t.message;this.logMessage("onClientVarsProcessDataCrash fromCache: ".concat(n)),!(n&&!this.configService.resolve("fromCacheClientVarsErrorThrowable",!0))&&this.sdk.getService(O.Tl).record(O.FP.Plugin,O.NI.ClientError,O.jK.ERR_CLIENTVARS_INVALID,{clientVarsMessage:i,fromCache:n}),this.reporterService.eventReport({key:se,errorType:r,error:o,message:s}),this.onLoadProcessAborted("onClientVarsProcessDataCrash")}},{key:"onClientVarsFetchError",value:function(e,t){var r=e.payload,n=e.customErrorInfo,i=n.requestIds,o=n.logIds,s=n.retryTime,a=this.sdk.getService(O.UU).token;if(!z().isCancel(r)&&a){var c,u=this.clientVarsFetcher.getAdaptedErrorResponse(e,t);this.logMessage("onClientVarsFetchError isErrorThrown: ".concat(r instanceof Error," adaptedResponse: ").concat(JSON.stringify({code:u.code,message:u.msg})," retryTimes: ").concat(s," fromCache: ").concat(t)),p(u.data.code)||(c=u.msg)&&"login required!"===c?this.reporterService.eventReport({key:"client_sheet_fetch_client_vars_tracker",stage:"catch",dataCode:u.data.code,dataMsg:u.msg||""}):(this.sdk.getService(O.Tl).record(O.FP.Plugin,O.NI.ServerError,O.jK.ERR_FETCH_CLIENTVARS,{reason:u,raw:{code:String(u.data.code)}}),this.onFetchClientVarsFailed(u,String(u.data.code),{requestIds:i,logIds:o,retryTime:s})),this.onLoadProcessAborted("onClientVarsFetchError"),this.store.dispatchEvent("LoadStatusStore/ClientVarsMessageInvalid",u,t)}else this.reporterService.eventReport({key:"client_sheet_render",stage:"get_clientvars_cancel",res:Number(!a)})}},{key:"tryUseClientVarsFromCache",value:function(e){var t=this,r=this.configService.resolve("dataLoaderUseClientVarsInTemplate",!0);if(this.configService.resolve("dataLoaderUsePreloadHttp",!1)){var n=e.token,o="".concat(n,"_").concat(oe),a=this.preloadHttp.getData(o,!r);if(a){var c,u=a.data,l=a.promise;return u?((0,w.SYU)(u,n)?c=u:this.reporterService.eventReport({key:"client_sheet_fetch_client_vars_should_retry",msg:"preload_http_data_invalid",errCode:u.code}),this.preloadHttp.delData(o)):l&&(c=l.then((function(e){return(0,w.SYU)(e,n)?e:(t.reporterService.eventReport({key:"client_sheet_fetch_client_vars_should_retry",msg:"preload_http_data_invalid_promise",errCode:e.code}),null)})).catch((function(){return null})).finally((function(){t.preloadHttp.delData(o)}))),c?(this.clientVarsFetcher.setPreloadDataFeature(n,c),this.infoMessage("tryUseClientVarsFromCache remove preloadHttp cache"),!0):!1}}if(!r)return!1;var h=(0,j.default)(window,"DATA.clientVars");delete window.DATA;var d=this.sdk.getService(O.UU).token,f=(0,w.ARw)(h,this.suite,d);return this.reporterService.eventReportWithTemplate($.n.SheetPathTracker,{trace_code:f?s.Y6H.isTemplateClientVarsValid:s.Y6H.isTemplateClientVarsInvalid}),(0,w.Xtw)(h)===i?(this.store.dispatchEvent("LoadStatusStore/HybridResourceDataInit"),!1):!!f&&(!!this.validateClientVarsInTemplate(h)&&(this.clientVarsFetcher.setPreloadDataFeature(e.token,h),this.onUseClientVarsInTemplate(h),!0))}},{key:"fetchSplitData",value:function(e,t){var r=this;if(!this.configService.resolve("dataLoaderPreventFetchSplitData",!1)||this.subBlocksToFetch){var n=this.sdk.getService(O.UU).token,i=this.sdk.getService(O.tb);this.initSplitDataFetcher(),this.setSubBlockPreloadData();var o=this.getSchemaVersionParams();this.splitDataFetcher.fetch(Object.assign({snapshot:e.snapshot,sheetId:e.sheetId,token:n,sheetIdsToFetch:this.sheetIdsToFetch,getActiveSheetId:function(){return r.getActiveSheetId()||e.sheetId}},o&&{schema_version:o},{isFetchFormulaMeta:e.changeset_list.length<=0}),{requestConfig:this.splitDataRequestConfig(),isHistory:this.downgradeForSubBlock||t===w.YwH.HISTORY,retryConfig:{max:i.resolve("dataLoaderSubBlocksMaxRetry",w.QRz),interval:i.resolve("dataLoaderSubBlocksInterval",w.x3F),factor:i.resolve("dataLoaderSubBlocksFactor",w.Il5),shouldRetry:function(e){return!e||((0,Z.default)(e.code)?e.code!==w.IKc.SUCCESS&&e.code!==w.IKc.INVALID_SCHEMA_VERSION&&e.code!==w.IKc.DOWN_GRADE:e instanceof Error)},onRetry:function(e,t){r.logMessage("fetchSplitData onRetry, count: ".concat(e,", res code: ").concat(t.code," message: ").concat(t.message)),e>3&&r.store.dispatchEvent("LoadStatusStore/ClientVarsSubBlockLoading",e)}}}),this.store.dispatchEvent("LoadStatusStore/SplitDataFetchStart"),this.reporterService.eventReport({key:"client_sheet_split_data_load_meta",sheet_id:e.sheetId,row_count:e.rowCount})}}},{key:"splitDataRequestConfig",value:function(){return{timeout:this.sdk.getService(O.tb).resolve("dataLoaderSubBlocksTimeout",1/0)}}},{key:"handleSheetAdded",value:function(e){var t=e.sheet;this.updateSheetStatus(t.id(),s.Px.LOADED),this.store.dispatchEvent("LoadStatusStore/WorksheetLoaded",t.id(),!1)}},{key:"handleLoadSheet",value:function(e){var t=null==e?void 0:e.id();if(t){var r=this.configService.resolve("useTTUOptimizationQ2",!1);if(this.isSubBlockFetchPrepared||(r?this.pendingPromotePrioritySheets.add(t):this.triggerLoadSheet(t)),this.isSheetUnLoaded(t)){if(!r)return void this.triggerLoadSheet(t);this.isActiveSheetLoaded()?this.triggerLoadSheet(t):this.pendingPromotePrioritySheets.add(t)}}}},{key:"promtePendingPrioritySheets",value:function(){var e=this;this.pendingPromotePrioritySheets.forEach((function(t){e.isSheetUnLoaded(t)&&e.triggerLoadSheet(t)})),this.pendingPromotePrioritySheets.clear()}},{key:"handleCoverSnapshot",value:function(e){var t=e.contentMeta,r={};t&&t.sheets&&(0,G.Z)(t.sheets,(function(e){r[e.id]=s.Px.LOADED})),this.store.commit("LoadStatusStore/resetSheetLoadedStatus",r)}},{key:"handleActiveSheetChanged",value:function(e){var t=this,r=e.newSheet.id();this.isOnDemandMode()&&!this.isSheetLoaded(r)&&this.splitDataFetcher&&this.isContentMetaDataApplied()&&this.dataApplyCounter.getAllDepSheetIds(r).forEach((function(e){t.triggerLoadSheet(e)}))}},{key:"fetchClientVarsShouldRetryChecker",value:function(e,t,r){var n=0,o={},s=!1,a=this.sdk.getService(O.UU).token;if(a?!e||e instanceof Error&&(0,A.default)(e.code)?n=2:e instanceof Error&&!(0,A.default)(e.code)&&e.code===i?(n=7,o={err_code:e.code}):p(e.code)?(n=3,o={err_code:e.code},s=!0):e.data?e.data.token!==a?(n=5,o={err_code:e.code}):(0,w.Xtw)(e)===w.jq8.Success||p((0,w.Xtw)(e))?(0,w.Xtw)(e)===i&&(n=7,o={err_code:(0,w.Xtw)(e)}):(n=6,o={err_code:e.data.code}):(n=4,o={err_code:e.code,msg:"type:".concat(e.type)}):(n=1,s=!0),n){var c=Object.assign({retry_code:n,request_id:t[t.length-1],request_id_list:t.join("|"),log_id:r[r.length-1],log_id_list:r.join("|")},o);return this.onFetchClientVarsShouldRetry(c),!s}return!1}},{key:"getClientVarsParams",value:function(e){var t=this.sdk.getService(O.UU),r=t.token,n=t.memberId,i=this.sheetIdsToFetch.join(",")||this.getActiveSheetId();return Object.assign({token:r,memberId:n,sheetId:i,defaultRows:e.defaultRows||0,defaultCols:e.defaultCols||0},e)}},{key:"startLoad",value:function(e,t){this.store.dispatchEvent("LoadStatusStore/Start");var r=this.sdk.getService(O.tb),n=this.sdk.getService(O.UU).token,i=r.resolve("clientVarsDefaultRows",e.defaultRows||0),o=r.resolve("clientVarsDefaultCols",e.defaultCols||0);this.clientVarsFetchOptions=Object.assign({},e,{defaultRows:i,defaultCols:o});var s=this.getClientVarsParams(e);this.logMessage("startLoad with memberId:".concat(s.memberId," sheetId:").concat(s.token)),this.initClientVarsFetcher(),this.initDataApply(),t&&this.clientVarsFetcher.setPreloadDataFeature(n,t);try{this.tryUseClientVarsFromCache(s)}catch(e){var a="tryUseClientVarsFromCache fail";this.logMessage("".concat(a," ").concat(e)),this.reporterService.eventReport({key:se,errorType:w.aG9.getCacheError,error:e,message:a})}this.fetchClientVars(s)}},{key:"reload",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{code:"NORMAL_RELOAD"};if(this.store.dispatchEvent("LoadStatusStore/ReloadStart",e,r),this.logMessage("reload transId:".concat(e," isLoadProcessing: ").concat(this.isLoadProcessing)),!this.isLoadProcessing){this.reset();var n=this.getClientVarsParams(Object.assign(this.clientVarsFetchOptions,t));this.fetchClientVars(n)}}},{key:"createSplitDataFetcher",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return(0,B.Z)((0,x.Z)(t.prototype),"createSplitDataFetcher",this).call(this,Object.assign(e,{dataAdapterContext:this.getAdaptorContext()}))}},{key:"loadSnippetSheets",value:function(e,t){var r=this,n=this.createSplitDataFetcher(),i=e?Object.values(e.sheets).map((function(e){return e.id})):t?Object.keys(t):[];if(i.length){var o=e,s=this.sdk.getService(O.UU).token,a=this.sdk.getService(O.tb),c=i.join("_");if(this.snippetSplitDataFetchers.has(c))this.logMessage("loadSnippetSheets fetchTransitionId: ".concat(c," has already been fetched"));else{this.snippetSplitDataFetchers.set(c,n),n.getData().subscribe((function(e){switch(e.type){case w.NsU.relationAnalyzed:r.logMessage("loadSnippetSheets ".concat(c," relationAnalyzed"),e.payload.from,e.payload.to),r.dataApplyCounter.updateDependency(e.payload.to);break;case w.NsU.subBlockLoaded:r.logMessage("loadSnippetSheets ".concat(c," subBlockLoaded")),r.onSubBlockLoaded(e.payload);break;case w.NsU.formulaMetaLoaded:r.onFormulaMetaLoaded(e.payload);break;case w.NsU.formulaBlockLoaded:r.onFormulaBlockLoaded(e.payload);break;case w.NsU.error:r.logMessage("loadSnippetSheets ".concat(c," error")),r.onSplitDataError(e);break;case w.NsU.success:r.logMessage("loadSnippetSheets ".concat(c," success"))}}));var u=this.getSchemaVersionParams();n.fetch(Object.assign({snapshot:o,token:s,sheetIdsToFetch:i,getActiveSheetId:function(){return i[0]}},u&&{schema_version:u}),{timeout:a.resolve("dataLoaderSubBlocksTimeout",1/0),requestConfig:this.splitDataRequestConfig(),isHistory:this.downgradeForSubBlock,retryConfig:{max:a.resolve("dataLoaderSubBlocksMaxRetry",w.QRz),interval:a.resolve("dataLoaderSubBlocksInterval",w.x3F),factor:a.resolve("dataLoaderSubBlocksFactor",w.Il5),shouldRetry:function(e){return!e||((0,Z.default)(e.code)?e.code!==w.IKc.SUCCESS&&e.code!==w.IKc.INVALID_SCHEMA_VERSION:e instanceof Error)},onRetry:function(e,t){r.logMessage("loadSnippetSheets ".concat(c," onRetry, count: ").concat(e,", res code: ").concat(t.code," message: ").concat(t.message))}}})}}}},{key:"getSchemaVersionParams",value:function(){return(0,w.VVp)(this.clientVarsDataVersion)?s.n0b.MUTATION:this.clientVarsDataVersion>=s.n0b.REF?s.jVu:void 0}},{key:"getDepends",value:function(){var e;return e={},(0,H.Z)(e,s.HaZ.SheetAdded,this.handleSheetAdded.bind(this)),(0,H.Z)(e,s.HaZ.ActiveSheetChanged,this.handleActiveSheetChanged.bind(this)),(0,H.Z)(e,s.HaZ.LoadSheet,this.handleLoadSheet.bind(this)),(0,H.Z)(e,s.HaZ.CoverSnapshot,this.handleCoverSnapshot.bind(this)),e}},{key:"onUseClientVarsInTemplate",value:function(e){}},{key:"onContentMetaLoaded",value:function(e,t){if(!e||!e.snapshot)throw new Error("ClientVars Cannot Be NULL");this.dataAdapter&&(e=this.dataAdapter.onContentMeta(e)),(0,w.VVp)(e.version)?this.applyMutation(e):this.applySnapshot(e.snapshot),e.is_snapshot_copying||(this.configService.resolve("dataLoaderPreventFetchSplitData",!1)&&(this.subBlocksToFetch=ne(e.snapshot,this.getActiveSheetId(),this.sheetIdsToFetch)),this.onAfterLoadContentMeta(e),this.fetchSplitData(e,t))}},{key:"onBeforeApplySnapshot",value:function(e){(0,B.Z)((0,x.Z)(t.prototype),"onBeforeApplySnapshot",this).call(this,e),this.trackerService.collect(Y.j5.APPLY_FILE_CLIENTVARS_START),this.trackerService.collect(s.FHD.STAGE_PENDING,{status:s.G2P.END,start_stage:s.FHD.UNGZIP_CLIENT_VARS,next_stage:s.FHD.APPLY_SNAPSHOT}),this.trackerService.collect(s.FHD.APPLY_DATA,{status:s.G2P.START}),this.trackerService.collect(s.FHD.APPLY_SNAPSHOT,{status:s.G2P.START})}},{key:"onBeforeApplyMutation",value:function(e){this.trackerService.collect(Y.j5.APPLY_FILE_CLIENTVARS_START),this.trackerService.collect(s.FHD.STAGE_PENDING,{status:s.G2P.END,start_stage:s.FHD.UNGZIP_CLIENT_VARS,next_stage:s.FHD.APPLY_SNAPSHOT}),this.trackerService.collect(s.FHD.APPLY_DATA,{status:s.G2P.START}),this.trackerService.collect(s.FHD.APPLY_SNAPSHOT,{status:s.G2P.START})}},{key:"onAfterApplySnapshot",value:function(){this.trackerService.collect(Y.j5.APPLY_FILE_CLIENTVARS_SUCCESS),this.trackerService.collect(Y.A6.SHEET_APPLY_SNAPSHOT_SUCCESS),(0,B.Z)((0,x.Z)(t.prototype),"onAfterApplySnapshot",this).call(this),this.trackerService.collect(s.FHD.APPLY_SNAPSHOT,{status:s.G2P.END,validation_ref_count:(0,s.Pho)(this.sdk.spread)}),this.trackerService.collect(s.FHD.STAGE_PENDING,{status:s.G2P.START,start_stage:s.FHD.APPLY_SNAPSHOT,next_stage:s.FHD.FASTER_FIRST_TICK})}},{key:"onAfterApplyMutation",value:function(){this.trackerService.collect(Y.j5.APPLY_FILE_CLIENTVARS_SUCCESS),this.trackerService.collect(Y.A6.SHEET_APPLY_SNAPSHOT_SUCCESS),this.trackerService.collect(s.FHD.APPLY_SNAPSHOT,{status:s.G2P.END,validation_ref_count:(0,s.Pho)(this.sdk.spread)}),this.trackerService.collect(s.FHD.STAGE_PENDING,{status:s.G2P.START,start_stage:s.FHD.APPLY_SNAPSHOT,next_stage:s.FHD.FASTER_FIRST_TICK})}},{key:"onClientVarsFetchRetry",value:function(e,t){var r=w.jq8.ServerError;t instanceof Error?(r=t.code,this.logMessage("onClientVarsFetchRetry GetClientVars Error (code:".concat(r," message:").concat(t.message,"), Retrying... ").concat(e))):(r=t.code||t.data.code,this.logMessage("onClientVarsFetchRetry Error code(".concat(r,"), Retrying... ").concat(e))),r===i&&this.store.dispatchEvent("LoadStatusStore/HybridResourceDataInit"),this.reporterService.eventReport({key:"client_sheet_fetch_retry",retry_source:"client_vars",retry_count:e})}},{key:"getAdaptorContext",value:function(){}},{key:"setSubBlockPreloadData",value:function(){var e=this;this.splitDataFetcher&&this.preloadHttp.getKeys().forEach((function(t){var r=e.preloadHttp.getData(t,!1),n=r.data?{code:r.data.code,data:r.data.data,msg:r.data.msg}:r.promise;t.split(",").forEach((function(t){e.splitDataFetcher.setSubBlockTokenCache(t,n)}))}))}},{key:"onAfterLoadContentMeta",value:function(e){var t=this.sdk.spread.getSheetFromId(e.sheetId);t&&!t.getHiddenStatus()&&this.sdk.spread.setActiveSheetById(e.sheetId),this.updateContentMetaStatus(e),this.onSplitDataHandlerMeta(e);var r=this.sdk.getService(O.UU).token;this.clientVarsFetcher.remotePreloadDataFeature(r)}},{key:"onSheetToUsage",value:function(){var e=this;if(this.trackerService.collect(Y.A6.FIRST_SHEET_LOADED),(0,B.Z)((0,x.Z)(t.prototype),"onSheetToUsage",this).call(this),this.reloadForDowngrade){var r;if(this.configService.resolve("dataloaderShouldFixActiveSheedId",!1))(null===(r=this.sdk.spread.getActiveSheet())||void 0===r?void 0:r.id())!==this.getActiveSheetId()&&this.sdk.spread.setActiveSheetById(this.getActiveSheetId());this.reporterService.eventReport({key:"ccm_sheet_down_grade_dev",result:"success"}),this.reloadForDowngrade=!1}this.configService.resolve("useTTUOptimizationQ2",!1)&&Promise.resolve().then((function(){e.promtePendingPrioritySheets()}))}},{key:"checkSheetInClientVars",value:function(e,t){if(t&&t.length&&e.snapshot.sheets){var r=new Set(t),n=[];for(var i in e.snapshot.sheets)r.has(e.snapshot.sheets[i].id)||n.push(i);n.length&&(1===n.length&&n[0]===h||this.onSheetNotInClientVars(n))}}},{key:"onSheetNotInClientVars",value:function(e){this.logMessage("onSheetNotInClientVars sheet is not in clientVars: ".concat(e.join("_"))),this.reporterService.eventReport({key:"client_sheet_assets_fail",assets_value:"EMBEDSHEET_NOT_IN_CLIENTVARS"})}},{key:"onClientVarsFetchEnd",value:function(e,t){this.logMessage("onClientVarsFetchEnd fromCache: ".concat(t));var r=this.sdk.getService(O.UU).token;if((0,w.czU)(e)&&(0,w.SYU)(e,r)){var n=(0,w.hcA)(e);return n&&(this.checkAsyncCopySheetStatus(n,t),this.onFetchClientVarsSuccess(n),this.downgradeForSubBlock=!!n.isHistorySnapshot),void this.store.dispatchEvent("LoadStatusStore/ClientVarsMessageValid",e,t)}this.reporterService.eventReport({key:"client_sheet_fetch_client_vars_tracker",stage:"then",code:o.STATUS_CODE.SUCCESS,msgCode:e.code,dataCode:(0,j.default)(e,"data.code",-1),dataMsg:(0,j.default)(e,"data.msg","")||(0,j.default)(e,"msg","")}),this.store.dispatchEvent("LoadStatusStore/ClientVarsMessageInvalid",Object.assign({},e,{fromCache:t}),t)}},{key:"onHandleClientVarsStart",value:function(e,t){this.logMessage("onHandleClientVarsStart clientVars revision:".concat(e.data.revision," fromCache: ").concat(t)),this.logStageMap[s.FHD.UNGZIP_CLIENT_VARS]||(this.trackerService.collect(s.FHD.STAGE_PENDING,{status:s.G2P.END,start_stage:s.FHD.FETCH_CLIENT_VARS,next_stage:s.FHD.UNGZIP_CLIENT_VARS}),this.trackerService.collect(s.FHD.UNGZIP_CLIENT_VARS,{status:s.G2P.START})),this.trackerService.collect(Y.j5.UNZIP_FILE_CLIENTVARS_START)}},{key:"onHandleClientVarsFail",value:function(e,t){this.logStageMap[s.FHD.UNGZIP_CLIENT_VARS]||this.trackerService.collect(s.FHD.UNGZIP_CLIENT_VARS,{status:s.G2P.ERROR}),this.logStageMap[s.FHD.UNGZIP_CLIENT_VARS]=!0}},{key:"onHandleClientVarsEnd",value:function(e,t){this.logMessage("onHandleClientVarsEnd, fromCache:".concat(t)),this.logStageMap[s.FHD.UNGZIP_CLIENT_VARS]||(this.trackerService.collect(s.FHD.UNGZIP_CLIENT_VARS,{status:s.G2P.END,clientvar_from:t?"local":"remote",schema_version:e.snapshot.schemaVersion}),this.trackerService.collect(s.FHD.STAGE_PENDING,{status:s.G2P.START,start_stage:s.FHD.UNGZIP_CLIENT_VARS,next_stage:s.FHD.APPLY_SNAPSHOT}),this.trackerService.collect(Y.j5.UNZIP_FILE_CLIENTVARS_SUCCESS)),this.logStageMap[s.FHD.UNGZIP_CLIENT_VARS]=!0}},{key:"onFetchClientVarsSuccess",value:function(e){this.logStageMap[s.FHD.FETCH_CLIENT_VARS]||(this.trackerService.collect(s.FHD.FETCH_CLIENT_VARS,{status:s.G2P.END}),this.trackerService.collect(s.FHD.STAGE_PENDING,{status:s.G2P.START,start_stage:s.FHD.FETCH_CLIENT_VARS,next_stage:s.FHD.UNGZIP_CLIENT_VARS})),this.logStageMap[s.FHD.FETCH_CLIENT_VARS]=!0,this.logMessage("fetch clientVars success, version: ".concat(e.revision)),this.trackerService.collect(Y.j5.FETCH_FILE_CLIENTVARS_SUCCESS),this.trackerService.collect(Y.A6.FETCH_SHEET_CLIENTVARS_SUCCESS)}},{key:"onFetchClientVarsFailed",value:function(e,t,r){this.logStageMap[s.FHD.FETCH_CLIENT_VARS]||this.trackerService.collect(s.FHD.FETCH_CLIENT_VARS,{status:s.G2P.ERROR}),this.logStageMap[s.FHD.FETCH_CLIENT_VARS]=!0;var n=r.requestIds,i=r.logIds,o=n.join(),a=i.join();this.reporterService.eventReport({key:"client_sheet_fetch_client_vars_failed",error_code:t,error_msg:e.msg,request_id:o,log_id:a}),this.store.dispatchEvent("LoadStatusStore/ClientVarsFetchFailed",e,t,o,a),this.reporterService.captureException(e,{key:"FETCH_CLIENT_VARS_ERROR"})}},{key:"onBackupBaseRevDiff",value:function(e,t,r){this.logMessage("onBackupBaseRevDiff rev:".concat(e," localBaseRev: ").concat(t," fromCache: ").concat(r)),this.reporterService.eventReportWithTemplate($.n.SheetPathTracker,{trace_code:s.Y6H.fetchClientVarsByRev})}},{key:"onProcessClientVarsMessageError",value:function(e,t,r){this.logMessage("onProcessClientVarsMessageError fromCache:".concat(t," errors len:").concat(r.length),e,r),this.store.dispatchEvent("LoadStatusStore/ClientVarsMessageInvalid",Object.assign({},e,{fromCache:t}),t),this.sdk.getService(O.Tl).record(O.FP.Plugin,O.NI.ClientError,O.jK.ERR_CLIENTVARS_INVALID,{clientVars:e.data,code:e.code})}},{key:"onClientVarsError",value:function(e){var t=e.payload,r=e.errorType,n=e.fromCache;this.loggerService.error("dataloader-plugin","onClientVarsError",t),r!==w.aG9.processDataCrash?r!==w.aG9.fetchError?r===w.aG9.validateError&&this.onClientVarsValidateError(e):this.onClientVarsFetchError(t,n):this.onClientVarsProcessDataCrash(e)}},{key:"onClientVarsValidateError",value:function(e){var t=e.payload,r=e.errorType,n=e.fromCache,i=e.validateResult;if((0,w.czU)(t)){var o=(0,w.hcA)(t);this.logMessage("onClientVarsValidateError is_snapshot_copying: ".concat(o.is_snapshot_copying," validateResult:").concat(i," fromCache: ").concat(n)),o.is_snapshot_copying&&this.getAsyncCopySheetInfo(this.sdk.getService(O.UU).token)}var s={fromCache:n,code:t.code,msg:(0,j.default)(t,"data.msg","")||(0,j.default)(t,"msg",""),data:t.data};this.onLoadProcessAborted("onClientVarsValidateError adaptedResponse: ".concat(JSON.stringify({code:s.code,message:s.msg})," fromCache: ").concat(n)),this.store.dispatchEvent("LoadStatusStore/ClientVarsMessageInvalid",s,n),this.reporterService.eventReport({key:se,errorType:r,validateResult:i})}},{key:"onSubBlockFetchStart",value:function(e){(0,B.Z)((0,x.Z)(t.prototype),"onSubBlockFetchStart",this).call(this,e),e.blockType===w.SV8.formulaBlock&&this.store.dispatchEvent("LoadStatusStore/FormulaCacheBlockFetchStart",e)}},{key:"onRelationAnalyzed",value:function(e,r){this.trackerService.collect(Y.j5.APPLY_SUB_BLOCK_START),(0,B.Z)((0,x.Z)(t.prototype),"onRelationAnalyzed",this).call(this,e,r)}},{key:"updateActiveSheetLoadStatus",value:function(e){this.trackerService.collect(Y.j5.APPLY_SUB_BLOCK_SUCCESS),(0,B.Z)((0,x.Z)(t.prototype),"updateActiveSheetLoadStatus",this).call(this,e)}},{key:"getAsyncCopySheetInfo",value:(r=(0,S.Z)(m().mark((function e(t){var r,n,i,a,c,u,l,h,d,f;return m().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:this.isAsyncCopyingSheet=!0,this.logMessage("getAsyncCopySheetInfo start"),r=200,n=!1,this.store.dispatchEvent("LoadStatusStore/AsyncCopySheet",{status:s.brm.wait}),i="".concat(this.requestProvider.apiUrls.ASYNC_COPY_SHEET,"/").concat(t);case 6:if(n){e.next=48;break}return a=this.requestProvider.getRequest(i,{headers:{"Content-Type":"application/json"},key:i}),c={},e.prev=9,e.next=12,a.promise;case 12:c=e.sent,e.next=18;break;case 15:e.prev=15,e.t0=e.catch(9),c.code=e.t0.code;case 18:if(c&&c.code===o.STATUS_CODE.SUCCESS){e.next=24;break}return u=c?c.code:o.STATUS_CODE.FAILED,this.logMessage("getAsyncCopySheetInfo request failed response code: ".concat(u)),this.sdk.getService(O.Tl).record(O.FP.Plugin,O.NI.ServerError,O.jK.ERROR_ASYNC_COPY_SHEET,{code:u}),this.onLoadProcessAborted("getAsyncCopySheetInfo response invalid"),e.abrupt("return");case 24:if(l=c.data,h=l.copy_status,d=l.failed_status_code,h!==s.brm.success){e.next=36;break}return f=s.Hg0.genSpecTid(s.$UQ.ASYNC_COPY_SHEET),this.logMessage("getAsyncCopySheetInfo request successfully and async copy sheet completed, start reload transId: ".concat(f)),this.store.dispatchEvent("LoadStatusStore/AsyncCopySheet",{status:s.brm.success}),this.onLoadProcessStopped(),this.clientVarsFetcher.clearCache(),this.reload(f,{openType:s.oTS.DEFAULT}),n=!0,e.abrupt("break",48);case 36:if(h!==s.brm.fail){e.next=41;break}return this.logMessage("getAsyncCopySheetInfo request successfully but async copy sheet failed, errorCode:".concat(d)),this.store.dispatchEvent("LoadStatusStore/AsyncCopySheet",{status:s.brm.fail,errorCode:d}),this.onLoadProcessAborted("getAsyncCopySheetInfo copy failed"),e.abrupt("break",48);case 41:return r=r<2e3?r+300:r,e.next=46,(0,w._vH)(r);case 46:e.next=6;break;case 48:case"end":return e.stop()}}),e,this,[[9,15]])}))),function(e){return r.apply(this,arguments)})},{key:"checkAsyncCopySheetStatus",value:function(e,t){!e.is_snapshot_copying&&this.isAsyncCopyingSheet&&(this.store.dispatchEvent("LoadStatusStore/AsyncCopySheet",{status:s.brm.success}),this.isAsyncCopyingSheet=!1)}},{key:"onFetchClientVarsShouldRetry",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};this.reporterService.eventReport(Object.assign({key:"client_sheet_fetch_client_vars_should_retry"},e))}},{key:"validateClientVarsInTemplate",value:function(e){return-1===location.href.indexOf("noTemplate")}},{key:"hasEditablePermission",value:function(e){return!1}},{key:"applyChangesets",value:function(e){var t=this;this.processRecoverActionInChangesetList(e)||e.forEach((function(e){var r=e.content||[];t.sdk.spread.applyActions(r,!1,!0)}))}},{key:"processRecoverActionInChangesetList",value:function(e){var t=this;if(!e||!e.length)return!1;var r=!!(0,w.Z0n)(e);return this.configService.resolve("dataLoaderRefetchIfRecoverActionFound",!0)&&r&&this.recoverRefreshTimes<Q.RECOVER_RELOAD_TIMES?(this.logMessage("changesetList has recover actions, refresh times: ".concat(this.recoverRefreshTimes)),this.recoverRefreshTimes++,this.store.dispatchEvent("LoadStatusStore/RecoverRefetching"),this.onLoadProcessAborted("changesetList has recover actions. refresh times: ".concat(this.recoverRefreshTimes)),this.recoverRefreshTimer=window.setTimeout((function(){var e;null===(e=t.clientVarsFetcher)||void 0===e||e.clearCache(),t.reload(s.Hg0.genSpecTid(s.$UQ.APPLY_RECOVER_ACTION_AND_REFETCH))}),Q.RECOVER_RELOAD_PENDING_TIMEOUT)):this.recoverRefreshTimes>=Q.RECOVER_RELOAD_TIMES&&(this.logMessage("changesetList has recover actions, recover fail exceeds refresh times"),this.reporterService.eventReport({key:"client_sheet_fetch_recover_history_fail"}),this.sdk.getService(O.Tl).record(O.FP.Plugin,O.NI.ServerError,O.jK.ERR_CLIENTVARS_INVALID_HAS_RECOVER,"")),this.logMessage("changesetListHasRecover:",r),r}},{key:"clientVarsDataVersion",get:function(){return this._clientVarsDataVersion},set:function(e){this._clientVarsDataVersion=e}}]),t}(U);ae.RECOVER_RELOAD_PENDING_TIMEOUT=500,ae.RECOVER_RELOAD_TIMES=10,ae=Q=ie([(0,W.Mn)({required:[w.AKO,O.tb,O.UU,O.Tl,O.zv,O.QX,O.kM,K.OG,w.AHm],optional:[O.B2]})],ae)},vsh_74340:function(e,t,r){"use strict";var n;r.d(t,{GH1:function(){return H},LJT:function(){return G},GbX:function(){return Ut},xV3:function(){return Ht},AKO:function(){return sr},v7i:function(){return ar},ysr:function(){return o},ZL1:function(){return Vt},co3:function(){return Be},MZ:function(){return xe},YwH:function(){return On},hl7:function(){return _i},fW1:function(){return pi},DW6:function(){return E},YVA:function(){return n},NLr:function(){return Hr},AHm:function(){return En},Smh:function(){return mn},P_V:function(){return vn},Nn_:function(){return gn},aG9:function(){return Rn},J5N:function(){return Tn},NMJ:function(){return Ci},T0l:function(){return bo},Eyy:function(){return Ei},RHq:function(){return Oe},s7O:function(){return Ie},cFp:function(){return Fe},b6k:function(){return ko},i$W:function(){return So},in1:function(){return yo},vp3:function(){return po},cAU:function(){return pr},uaV:function(){return I},Giu:function(){return ot.NetworkState},jq8:function(){return Er},VeS:function(){return N},e2Q:function(){return Mn},NYU:function(){return Nn},Il5:function(){return oo},x3F:function(){return io},QRz:function(){return no},xej:function(){return ho},NsU:function(){return ro},IKc:function(){return An},LYB:function(){return Ri},SV8:function(){return Ai},Jdn:function(){return Ti},vbU:function(){return br},ClJ:function(){return Zr},_Ui:function(){return jr},T8N:function(){return wn},M9m:function(){return B},pb3:function(){return dr},qif:function(){return _r},_Gk:function(){return kr},FIP:function(){return fr},OrD:function(){return U},SYU:function(){return se},Z0n:function(){return Ce},WDp:function(){return Un},hcA:function(){return ae},Xtw:function(){return ge},KjG:function(){return Fn},xEU:function(){return X},fq_:function(){return cr},qo4:function(){return ce},VVp:function(){return fe},EQE:function(){return de},M0m:function(){return he},ARw:function(){return we},yyw:function(){return ue},czU:function(){return oe},_vH:function(){return re},Q50:function(){return Pe.Q}}),function(e){e.CACHE_DATA_VERSION_BEHIND="CACHE_DATA_VERSION_BEHIND",e.REV_INIT="REV_INIT",e.CLIENT_VARS="CLIENT_VARS",e.AFTER_APPLY_SNAPSHOT="AFTER_APPLY_SNAPSHOT",e.DATA_TABLE="DATA_TABLE",e.SPREAD_LOADED="SPREAD_LOADED",e.AFTER_SPREAD_LOADED="AFTER_SPREAD_LOADED",e.SPREAD_LOADING="SPREAD_LOADING",e.PRODUCE_CHANGESET="PRODUCE_CHANGESET",e.CLIENTVARS_SUBBLOCK_LOADING="CLIENTVARS_SUBBLOCK_LOADING",e.WORKSHEET_LOADED="WORKSHEET_LOADED",e.FORMULA_CACHE_META="FORMULA_CACHE_META",e.FORMULA_CACHE_BLOCK="FORMULA_CACHE_BLOCK",e.BEFORE_FETCH_FORMULA_BLOCK="BEFORE_FETCH_FORMULA_BLOCK",e.HANDLE_NO_FORMULA_CACHE="HANDLE_NO_FORMULA_CACHE",e.TRIGGER_USER_CHANGES="TRIGGER_USER_CHANGES",e.NEW_CHANGES="NEW_CHANGES",e.APPLY_ACTIONS="APPLY_ACTIONS",e.FETCH_MISS_VERSIONS="FETCH_MISS_VERSIONS",e.SYNC_BASE_REV="SYNC_BASE_REV",e.ACCEPT_COMMIT="ACCEPT_COMMIT",e.REJECT_COMMIT="REJECT_COMMIT",e.LOCAL_CONFLICT="LOCAL_CONFLICT",e.REFETCH_CLIENT_VARS="REFETCH_CLIENT_VARS",e.CONFLICT_HANDLE="CONFLICT_HANDLE",e.SUSPEND_ACTION="SUSPEND_ACTION",e.RESUME_ACTION="RESUME_ACTION",e.PRODUCE_ACTIONS="PRODUCE_ACTIONS",e.ACTIVE_SHEET_CHANGE="ACTIVE_SHEET_CHANGE",e.PRODUCE_RECOVER_ACTION="PRODUCE_RECOVER_ACTION",e.SEND_RECOVER="SEND_RECOVER",e.RECOVER_SUCCESS="RECOVER_SUCCESS",e.RECOVER_ERROR="RECOVER_ERROR",e.ACCEPT_RECOVER="ACCEPT_RECOVER",e.RECEIVE_RECOVER="RECEIVE_RECOVER",e.RECEIVE_RECOVER_PREPREOCCESS="RECEIVE_RECOVER_PREPREOCCESS",e.RECEIVE_BLOCK_RECOVER="RECEIVE_BLOCK_RECOVER",e.CONFIRM_RECOVER="CONFIRM_RECOVER",e.RECOVER_SPREAD="RECOVER_SPREAD",e.ERROR="ERROR",e.REQUIRE_RE_SYNC="REQUIRE_RE_SYNC",e.OFFLINE_SAVE_LOCAL_ERROR="OFFLINE_SAVE_LOCAL_ERROR",e.ONLINE_SAVE_LOCAL_ERROR="ONLINE_SAVE_LOCAL_ERROR",e.ONLINE_SAVE_LOCAL_ERROR_RESUME="ONLINE_SAVE_LOCAL_ERROR_RESUME",e.DELETE_CELL="DELETE_CELL",e.DELETE_ROW="DELETE_ROW",e.DELETE_COL="DELETE_COL",e.DELETE_SHEET="DELETE_SHEET",e.SUSPEND_CHANGESET="SUSPEND_CHANGESET",e.RESUME_CHANGESET="RESUME_CHANGESET",e.TIME_TO_USAGE="TIME_TO_USAGE",e.SYNC_STATUS="SYNC_STATUS",e.CHANNEL_STATE_CHANGE="CHANNEL_STATE_CHANGE",e.SEND_MESSAGE_RETRY_EXCEEDED="SEND_MESSAGE_RETRY_EXCEEDED",e.FREEZE_SPREAD="FREEZE_SPREAD",e.EDIT_STATE_CHANGE="EDIT_STATE_CHANGE",e.SEND_CURSOR="SEND_CURSOR",e.SEND_COMMENT_CHANGE="SEND_COMMENT_CHANGE",e.ACCEPT_COMMENT_CHANGE="ACCEPT_COMMENT_CHANGE",e.HEART_BEAT="HEART_BEAT",e.MAX_WIDTH_CHANGE="MAX_WIDTH_CHANGE",e.SIZE_CHANGE="SIZE_CHANGE",e.ZOOM_CHANGE="ZOOM_CHANGE",e.EMBED_SHEET_LOADED="EMBED_SHEET_LOADED",e.EXIT_FULL_SCREEN_MODE="EXIT_FULL_SCREEN_MODE",e.ENTER_FULL_SCREEN_MODE="ENTER_FULL_SCREEN_MODE",e.RESTORE_SHEET="RESTORE_SHEET",e.SOFT_DEL_SHEET="SOFT_DEL_SHEET",e.WAKEUP="WAKEUP",e.SUSPEND="SUSPEND",e.ENTER_BUFFER="ENTER_BUFFER",e.LEAVE_BUFFER="LEAVE_BUFFER",e.SYNC_VIRTUAL_SCROLL="SYNC_VIRTUAL_SCROLL",e.SET_USERS="SET_USERS",e.USER_NEWINFO="USER_NEWINFO",e.USER_LEAVE="USER_LEAVE",e.MEMBERS_UPDATE="MEMBERS_UPDATE",e.ENGAGEMENT_CURSOR="ENGAGEMENT_CURSOR",e.CELL_COORD_CHANGE="CELL_COORD_CHANGE",e.SPANS_CHANGE="SPANS_CHANGE",e.MEMBER_CURSOR_CHANGED="MEMBER_CURSOR_CHANGED",e.FETCH_HISTORY_META="FETCH_HISTORY",e.ZONE_PERMISSION_CHANGE="ZONE_PERMISSION_CHANGE",e.FULLSCREEN_ADD_COMMENT="FULLSCREEN_ADD_COMMENT",e.FULLSCREEN_DELETE_REPLY="FULLSCREEN_DELETE_REPLY",e.FULLSCREEN_REPLY_COMMENT="FULLSCREEN_REPLY_COMMENT",e.FULLSCREEN_RESOLVE_COMMENT="FULLSCREEN_RESOLVE_COMMENT",e.FULLSCREEN_UPDATE_REPLY="FULLSCREEN_UPDATE_REPLY",e.FULLSCREEN_CAN_EXIT="FULLSCREEN_CAN_EXIT",e.ADD_COMMENT="ADD_COMMENT",e.REPLY_DID_ADD_COMMENT="REPLY_DID_ADD_COMMENT",e.FULLSCREEN_ADD_COMMENT_DOCX="FULLSCREEN_ADD_COMMENT_DOCX",e.FULLSCREEN_ADD_COMMENT_NEW="FULLSCREEN_ADD_COMMENT_NEW",e.FULLSCREEN_SORT="FULLSCREEN_SORT",e.CONNECT="CONNECT",e.IS_WAITING_BACKUP="IS_WAITING_BACKUP",e.COMPLETE_BACKUP="COMPLETE_BACKUP",e.INCONSISTENCY="INCONSISTENCY",e.BLOCK_DATA_CHANGED="BLOCK_DATA_CHANGED",e.SHEET_REVISION_CHANGE="SHEET_REVISION_CHANGE",e.ConditionalFormatUpdate="ConditionalFormatUpdate",e.ISV_RELATIONSHIP="ISV_RELATIONSHIP",e.FIRST_ACTIVE_SHEET_LOADED="FIRST_ACTIVE_SHEET_LOADED",e.MISS_HEARTBEAT_REV="MISS_HEARTBEAT_REV",e.RESET_FIBERTASK="RESET_FIBERTASK",e.TRIGGER_SPREAD_LOADED="TRIGGER_SPREAD_LOADED",e.IMPORT_RANGE_CHANGE="IMPORT_RANGE_CHANGE",e.IMPORT_FORMULA="IMPORTFORMULA",e.AUTHORIZATION="AUTHORIZATION",e.REGET_CLIENT_VARS="REGET_CLIENT_VARS",e.ASYNC_COPY_SHEET="ASYNC_COPY_SHEET",e.VIEW_CHANGE="VIEW_CHANGE",e.FIELD_LOCAL_VALUE_CHANGE="FIELD_LOCAL_VALUE_CHANGE",e.DATA_MIGRATE="DATA_MIGRATE"}(n||(n={}));var i,o,s,a=r("vsh_19264"),c=r("vsh_4175"),u=r("vsh_74561"),l=r("vsh_46775"),h=r("vsh_73565"),d=r.n(h),f=r("vsh_24627"),p=r("vsh_98652"),v=r("vsh_65726"),g=r("vsh_72429"),y=r("vsh_59980"),_=function(){function e(t){var r=this;(0,a.Z)(this,e),this.context=t,this.users=new Map,this.onSetUsers=function(e){return r.resetMembers(e.users)},this.onUserNewInfo=function(e){var t=e.user;r.users.has(t.member_id)||(r.users.set(t.member_id,t),r.context.trigger(n.MEMBER_CURSOR_CHANGED))},this.resetMembers=function(e){(0,g.default)(e)||(r.users=new Map(e.map((function(e){return[e.member_id,r.updateCursorField(e)]}))),r.context.trigger(n.MEMBER_CURSOR_CHANGED))},this.onMemberUpdate=function(e){var t=e.members;return r.resetMembers(t)},this.onUserLeave=function(e){var t=(0,y.default)(e,"user.member_id",[]);0===r.users.size||(0,g.default)(t)||((0,v.Z)(t,(function(e){r.users.delete(e)})),r.context.trigger(n.MEMBER_CURSOR_CHANGED))},this.onEngagementCursor=function(e){var t=String(e.member_id),i=e.cursor_info,o=r.users.get(t);o&&(r.users.set(t,Object.assign({},o,{cursor_info:i})),r.context.trigger(n.MEMBER_CURSOR_CHANGED))}}return(0,c.Z)(e,[{key:"updateCursorField",value:function(e){var t=String(e.member_id)!==String(this.context.getMemberId());if((0,g.default)(e.cursor_info)&&e.cursor_info_str&&t)try{var r=JSON.parse(e.cursor_info_str);if(r)return Object.assign({},e,{cursor_info:r})}catch(e){}return e}},{key:"getAllMembers",value:function(){return(0,p.Z)(this.users.values())}}]),e}(),k=(i={},(0,u.Z)(i,n.REV_INIT,"onRevInit"),(0,u.Z)(i,n.CLIENT_VARS,"onClientVars"),(0,u.Z)(i,n.DATA_TABLE,"onDataTable"),(0,u.Z)(i,n.SPREAD_LOADED,"onSpreadLoaded"),(0,u.Z)(i,n.FORMULA_CACHE_META,"onFormulaCacheMetaLoaded"),(0,u.Z)(i,n.FORMULA_CACHE_BLOCK,"onFormulaCacheBlockLoaded"),(0,u.Z)(i,n.WORKSHEET_LOADED,"onWorksheetLoaded"),(0,u.Z)(i,n.FIRST_ACTIVE_SHEET_LOADED,"onFirstActiveSheetLoaded"),(0,u.Z)(i,n.SPREAD_LOADING,"onSpreadLoading"),(0,u.Z)(i,n.NEW_CHANGES,"onNewChanges"),(0,u.Z)(i,n.APPLY_ACTIONS,"onApplyActions"),(0,u.Z)(i,n.PRODUCE_ACTIONS,"onProduceActions"),(0,u.Z)(i,n.PRODUCE_CHANGESET,"onProduceChangeset"),(0,u.Z)(i,n.ACCEPT_COMMIT,"onAcceptCommit"),(0,u.Z)(i,n.REJECT_COMMIT,"onRejectCommit"),(0,u.Z)(i,n.LOCAL_CONFLICT,"onLocalConflict"),(0,u.Z)(i,n.REFETCH_CLIENT_VARS,"onRefetchClientVars"),(0,u.Z)(i,n.ERROR,"onError"),(0,u.Z)(i,n.WAKEUP,"onWakeup"),(0,u.Z)(i,n.SUSPEND,"onSuspend"),(0,u.Z)(i,n.ENTER_BUFFER,"onEnterBuffer"),(0,u.Z)(i,n.LEAVE_BUFFER,"onLeaveBuffer"),(0,u.Z)(i,n.SYNC_VIRTUAL_SCROLL,"onSyncVirtualScroll"),(0,u.Z)(i,n.SET_USERS,"onSetUsers"),(0,u.Z)(i,n.USER_NEWINFO,"onUserNewInfo"),(0,u.Z)(i,n.ENGAGEMENT_CURSOR,"onEngagementCursor"),(0,u.Z)(i,n.USER_LEAVE,"onUserLeave"),(0,u.Z)(i,n.SEND_CURSOR,"onSendCursor"),(0,u.Z)(i,n.FETCH_HISTORY_META,"onFetchHistoryMeta"),(0,u.Z)(i,n.MEMBERS_UPDATE,"onMemberUpdate"),(0,u.Z)(i,n.ISV_RELATIONSHIP,"onISVRelationship"),i),E=function(){function e(t,r){(0,a.Z)(this,e),this.token="",this.event=new(d()),this.embed=!1,this.fullScreenMode=!1,this.memberId=0,this.eventHandlers=[],this.memberInfoHelper=null,this.historyType=null,this.token=t,this.scene=r,f.Ps3.opendoc.showCollaborators()&&(this.memberInfoHelper=new _(this),this.addEventHandler(this.memberInfoHelper))}return(0,c.Z)(e,[{key:"getScene",value:function(){return this.scene}},{key:"trigger",value:function(e){for(var t,r=arguments.length,n=new Array(r>1?r-1:0),i=1;i<r;i++)n[i-1]=arguments[i];(t=this.event).emit.apply(t,[e].concat(n));var o=k[e];o&&this.eventHandlers.forEach((function(e){var t;(0,l.default)(e[o])&&(t=e[o]).call.apply(t,[e].concat(n))}))}},{key:"bind",value:function(e,t){this.event.addListener(e,t)}},{key:"unbind",value:function(e,t){this.event.removeListener(e,t)}},{key:"once",value:function(e,t){this.event.once(e,t)}},{key:"addListeners",value:function(e){this.event.addListeners(e)}},{key:"removeListeners",value:function(e){this.event.removeListeners(e)}},{key:"addEventHandler",value:function(e){this.eventHandlers.push(e)}},{key:"removeEventHandler",value:function(e){var t=this.eventHandlers,r=t.indexOf(e);-1!==r&&t.splice(r,1)}},{key:"removeAllEventHandlers",value:function(){this.event.removeAllListeners(),this.eventHandlers.length=0}},{key:"setHistoryType",value:function(e){this.historyType=e}},{key:"getHistoryType",value:function(){return this.historyType}},{key:"setEmbed",value:function(e){this.embed=e}},{key:"isEmbed",value:function(){return this.embed}},{key:"isFullScreenMode",value:function(){return this.fullScreenMode}},{key:"setFullScreenMode",value:function(e){this.fullScreenMode=e}},{key:"setToken",value:function(e){this.token=e}},{key:"getToken",value:function(){return this.token}},{key:"setMemberId",value:function(e){this.memberId=e;var t=window;t.teaMap=t.teaMap||{},t.teaMap.memberId=e}},{key:"getMemberId",value:function(){return this.memberId}},{key:"getAllMembers",value:function(){return this.memberInfoHelper&&this.memberInfoHelper.getAllMembers()}},{key:"userId",get:function(){var e;return null===(e=window.User)||void 0===e?void 0:e.id}}]),e}();!function(e){e.Actions="sheet.bu.actions",e.Submit="sheet.bu.submit",e.Follow="sheet.bu.follow",e.Conflict="sheet.bu.records",e.Rev="sheet.bu.rev",e.Backuping="sheet.bu.backuping",e.LocalActionMemberId="sheet.bu.localActionMemId",e.SubmittingMemberId="sheet.bu.submittingId"}(o||(o={})),function(e){e.Set="Set",e.Get="Get",e.Remove="Remove"}(s||(s={}));var m={CREATE:0,SETVALUE:1,SETSTYLE:2,SETFORMULA:3,SETCELL:4,ADDROW:5,DELROW:6,ADDCOL:7,DELCOL:8,SETSPANS:9,SETCELLS:10,SETROWHEIGHT:17,SETCOLUMNWIDTH:18,ADDSHEET:19,DELSHEET:20,SETSHEET:21,COPYSHEET:22,SORT:23,SETFILTER:24,DELFILTER:25,MOVESHEET:26,FREEZESHEET:27,RECOVER:28,ADDCOMMENTS:29,HIDEROW:30,UNHIDEROW:31,HIDECOL:32,UNHIDECOL:33,SOFTDELSHEET:34,RESTORESHEET:35,LOCKROW:36,UNLOCKROW:37,LOCKCOL:38,UNLOCKCOL:39,LOCKSHEET:40,UNLOCKSHEET:41,SETCHART:42,DELCHART:43,UPGRADESNAPSHOT:44,ADDCONDITIONALFORMAT:45,SETCONDITIONALFORMAT:46,DELCONDITIONALFORMAT:47,MOVECONDITIONALFORMAT:48,COVERSNAPSHOT:49,MOVERANGE:50,ADDBLOCK:51,DELBLOCK:52,RESTOREBLOCK:53,COVERSHEET:54,SETROWPROPERTY:55,SETCOLPROPERTY:56,SETFORMDATA:57,SETRANGE:58,UPDATERANGE:61,SETFLOATIMAGE:59,DELFLOATIMAGE:60,ADDVIEW:62,SETVIEW:63,DELVIEW:64,SETFILTERVIEW:65,UPDATEREFERENCE:66,MIXRELOAD:67,SETFLOATBLOCK:69,DELFLOATBLOCK:70,SETDATARANGE:68,DELDATARANGE:71,SETEMBEDDEDBLOCK:72,DELEMBEDDEDBLOCK:73,SETRANGEVALUES:74,ADDOUTLINE:75,UPDATEOUTLINE:76,DELOUTLINE:77,ADDSPARKLINEGROUP:78,UPDATESPARKLINEGROUP:79,DELSPARKLINEGROUP:80,SETRANGEPROTECTION:81,DELRANGEPROTECTION:82},S=(f.aOo.SET_VALUE,f.aOo.SET_STYLE,f.aOo.SET_FORMULA,f.aOo.SET_CELL,f.aOo.ADD_ROW,f.aOo.DEL_ROW,f.aOo.ADD_COL,f.aOo.DEL_COL,f.aOo.SET_SPANS,f.aOo.SET_ROW_HEIGHT,f.aOo.SET_COLUMN_WIDTH,f.aOo.ADD_SHEET,f.aOo.DEL_SHEET,f.aOo.SET_SHEET,f.aOo.COPY_SHEET,f.aOo.SORT,f.aOo.SET_FILTER,f.aOo.DEL_FILTER,f.aOo.MOVE_SHEET,f.aOo.FREEZE_SHEET,f.aOo.RECOVER,f.aOo.ADD_COMMENTS,f.aOo.HIDE_ROW,f.aOo.UNHIDE_ROW,f.aOo.HIDE_COL,f.aOo.UNHIDE_COL,f.aOo.SOFT_DEL_SHEET,f.aOo.RESTORE_SHEET,f.aOo.LOCK_ROW,f.aOo.UNLOCK_ROW,f.aOo.LOCK_COL,f.aOo.UNLOCK_COL,f.aOo.LOCK_SHEET,f.aOo.UNLOCK_SHEET,f.aOo.SET_CHART,f.aOo.DEL_CHART,f.aOo.ADD_CONDITIONAL_FORMAT,f.aOo.SET_CONDITIONAL_FORMAT,f.aOo.DEL_CONDITIONAL_FORMAT,f.aOo.MOVE_CONDITIONAL_FORMAT,f.aOo.COVER_SNAPSHOT,f.aOo.MOVE_RANGE,f.aOo.ADD_BLOCK,f.aOo.DEL_BLOCK,f.aOo.RESTORE_BLOCK,f.aOo.COVER_SHEET,f.aOo.SET_ROW_PROPERTY,f.aOo.SET_COL_PROPERTY,f.aOo.SET_FORM_DATA,f.aOo.SET_RANGE,f.aOo.UPDATE_RANGE,f.aOo.SET_FLOAT_IMAGE,f.aOo.DEL_FLOAT_IMAGE,f.aOo.ADD_VIEW,f.aOo.SET_VIEW,f.aOo.DEL_VIEW,f.aOo.SET_FILTER_VIEW,f.aOo.UPDATE_REFERENCE,f.aOo.SET_DATA_RANGE,f.aOo.SET_FLOAT_BLOCK,f.aOo.DEL_FLOAT_BLOCK,f.aOo.DEL_DATA_RANGE,f.aOo.SET_EMBEDDED_BLOCK,f.aOo.DEL_EMBEDDED_BLOCK,f.aOo.SET_RANGE_VALUES,f.aOo.ADD_OUTLINE,f.aOo.UPDATE_OUTLINE,f.aOo.DEL_OUTLINE,f.aOo.ADD_SPARKLINE_GROUP,f.aOo.UPDATE_SPARKLINE_GROUP,f.aOo.DELETE_SPARKLINE_GROUP,f.aOo.SET_RANGE_PROTECTION,f.aOo.DEL_RANGE_PROTECTION,r("vsh_67017")),b=r.n(S),C=r("vsh_35067"),R=r("vsh_93301"),A="STORE_EMPTY_DATA",T=function(){function e(t,r){(0,a.Z)(this,e),this.type=t,this.host=r,this.candidate=A,this.current=A}var t;return(0,c.Z)(e,[{key:"isEmpty",value:function(e){return e===A}},{key:"submit",value:(t=(0,C.Z)(b().mark((function e(t,r){var n,i,s,a;return b().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n=this.host.backup,i=this.type===o.Rev,s=this.type===o.Backuping,a=r.data,this.host.reporter.eventReport({key:"client_sheet_eng_store_submit_start",transId:t,type:this.type,data:!!a}),i||s||!a){e.next=12;break}return e.next=8,n.checkConsistency();case 8:if(e.sent){e.next=12;break}return this.host.reporter.eventReport({key:"client_sheet_eng_store_consistency",transId:t,type:this.type}),e.abrupt("return");case 12:if(i||null!==a){e.next=24;break}return e.next=15,n.removeBackupItem(this.type,void 0,t);case 15:if(this.type!==o.Actions){e.next=20;break}return e.next=18,n.removeBackupItem(o.LocalActionMemberId,void 0,t);case 18:e.next=23;break;case 20:if(this.type!==o.Submit){e.next=23;break}return e.next=23,n.removeBackupItem(o.SubmittingMemberId,void 0,t);case 23:return e.abrupt("return");case 24:return e.next=26,n.setBackupItem(this.type,i?a:r,t);case 26:if(this.type!==o.Actions){e.next=31;break}return e.next=29,n.setBackupItem(o.LocalActionMemberId,r.memberId,t);case 29:e.next=34;break;case 31:if(this.type!==o.Submit){e.next=34;break}return e.next=34,n.setBackupItem(o.SubmittingMemberId,r.memberId,t);case 34:this.host.reporter.eventReport({key:"client_sheet_eng_store_submit_fin",transId:t,type:this.type});case 35:case"end":return e.stop()}}),e,this)}))),function(e,r){return t.apply(this,arguments)})},{key:"trySubmit",value:function(e){var t=this;!this.isSubmitting&&this.hasCandidate&&(this.current=this.candidate,this.candidate=A,this.submit(e,this.current).then((function(){t.current=A,t.trySubmit(e)})))}},{key:"push",value:function(e,t){this.host.reporter.eventReport({key:"client_sheet_eng_store_submit_push",transId:e,type:this.type}),this.candidate=t,this.trySubmit(e)}},{key:"isSubmitting",get:function(){return!this.isEmpty(this.current)}},{key:"hasCandidate",get:function(){return!this.isEmpty(this.candidate)}},{key:"isStoring",get:function(){return this.isSubmitting||this.hasCandidate}}]),e}(),w=function(){function e(t){(0,a.Z)(this,e),this.host=t,this.channels={}}return(0,c.Z)(e,[{key:"register",value:function(e){this.host.reporter.eventReport({key:"client_sheet_eng_store_register",type:e}),this.channels[e]=new T(e,this.host)}},{key:"channel",value:function(e){if(!this.channels[e])throw this.host.reporter.eventReport({key:"client_sheet_eng_store_channel_invalid",type:e}),new Error("not supported store type: ".concat(e));return this.channels[e]}},{key:"isStoring",get:function(){return Object.values(this.channels).some((function(e){return e.isStoring}))}}]),e}(),O=function(){function e(t){var r=this;(0,a.Z)(this,e),this.host=t,this.queue=new w(this.host),e.backupTypes.forEach((function(e){return r.queue.register(e)}))}return(0,c.Z)(e,[{key:"clone",value:function(e){var t=e.memberId,r=e.baseRev,n=e.data;return null===n||(0,R.default)(n)?e:{memberId:t,baseRev:r,data:JSON.stringify(n)}}},{key:"push",value:function(e,t,r){this.queue.channel(t).push(e,this.clone(r))}},{key:"isStoring",get:function(){return this.queue.isStoring}}]),e}();O.backupTypes=[o.Actions,o.Follow,o.Submit,o.Rev,o.LocalActionMemberId,o.SubmittingMemberId];var I,D,L,M,N,B=function(){function e(){(0,a.Z)(this,e)}var t;return(0,c.Z)(e,[{key:"register",value:function(){}},{key:"unRegister",value:function(){return new Promise((function(){}))}},{key:"request",value:function(){var e=new Promise((function(){}));return e.reqId=-1,e}},{key:"requestApi",value:function(){var e=new Promise((function(){}));return e.reqId=-1,e}},{key:"watch",value:(t=(0,C.Z)(b().mark((function e(){return b().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return");case 1:case"end":return e.stop()}}),e)}))),function(){return t.apply(this,arguments)})},{key:"getTicket",value:function(){return"AnonymousAccessTicket"}},{key:"getMemberId",value:function(){return-1}},{key:"setHeartbeatVersion",value:function(){}},{key:"unregisterChannelState",value:function(){}},{key:"registerChannelState",value:function(){}},{key:"getHeartbeatInfo",value:function(e,t){return null}},{key:"addHeartbeat",value:function(){}},{key:"removeHeartbeat",value:function(){}},{key:"sendHeartbeats",value:function(){}}]),e}();!function(e){e.USER_NEWINFO="USER_NEWINFO",e.USER_LEAVE="USER_LEAVE",e.CLIENT_VARS="CLIENT_VARS",e.ENGAGEMENT_CURSOR="ENGAGEMENT_CURSOR",e.ACCEPT_ENGAGEMENT_CURSOR="ACCEPT_ENGAGEMENT_CURSOR",e.RESPONSE="RESPONSE",e.ACCEPT_WATCH="ACCEPT_WATCH",e.ACCEPT_COMMIT="ACCEPT_COMMIT",e.REJECT_COMMIT="REJECT_COMMIT",e.NEW_CHANGES="NEW_CHANGES",e.USER_CHANGES="USER_CHANGES",e.CHECK_READY="CHECK_READY",e.SERVER_READY="SERVER_READY",e.USER_COMMENT="USER_COMMENT",e.NEW_COMMENT="NEW_COMMENT",e.MESSAGE_CHANNEL="MESSAGE_CHANNEL",e.ROOM_MEMBERS="ROOM_MEMBERS",e.GET_EDITMODE_QUANTITY="GET_EDITMODE_QUANTITY",e.REQUEST_EDIT="REQUEST_EDIT",e.QUIT_EDIT="QUIT_EDIT",e.ZONE_PERMISSION_CHANGE="ZONE_PERMISSION_CHANGE",e.ERROR="ERROR",e.ISV_RELATIONSHIP="ISV_RELATIONSHIP",e.IMPORT_RANGE="IMPORT_RANGE",e.DATA_MIGRATE="DATA_MIGRATE",e.OBJ_TITLE_CHANGE="OBJ_TITLE_CHANGE",e.IMPORT_FORMULA="IMPORTFORMULA",e.AUTHORIZATION="AUTHORIZATION",e.AI_FORMULA="AI_FORMULA",e.AI_REFER_DATA_CHANGE="AI_REFER_DATA_CHANGE"}(I||(I={})),function(e){e.META="META",e.ROW_DATA="ROW_DATA",e.FORMULA_CACHE_META="FORMULA_CACHE_META",e.FORMULA_CACHE_BLOCK="FORMULA_CACHE_BLOCK",e.SHEET_COMPLETE="SHEET_COMPLETE",e.COMPLETE="COMPLETE",e.ERROR="ERROR",e.ABORT="ABORT",e.SHEET_LOADING="SHEET_LOADING"}(D||(D={})),function(e){e[e.NEW=0]="NEW",e[e.OLD=1]="OLD"}(L||(L={})),function(e){e[e.GZIP=1]="GZIP"}(M||(M={})),function(e){e[e.None=0]="None",e[e.Exception=1]="Exception",e[e.Code1015=2]="Code1015",e[e.Code1016=3]="Code1016",e[e.STOP_WRITE_FOR_MIGRATE=4]="STOP_WRITE_FOR_MIGRATE",e[e.HYBRID_RESOURCE=600]="HYBRID_RESOURCE"}(N||(N={}));var x,F,P,U="x-command",H=("".concat("api.doc.token",".create_sheet"),"api.sheet.create"),V="api.sheet.cs_range.token",Z="api.v2.sheet.sub_block",j="api.v2.sheet.historys.token",G="api.v2.sheet.gencs",q="api.v2.sheet.first_block";!function(e){e[e.OK=0]="OK",e[e.EMPTY=1]="EMPTY",e[e.REV=2]="REV",e[e.VERSION_ERROR=3]="VERSION_ERROR",e[e.NO_SNAPSHOT=4]="NO_SNAPSHOT",e[e.EXPIRED=5]="EXPIRED",e[e.SCHEMA_VERSION_NOT_MATCH=6]="SCHEMA_VERSION_NOT_MATCH"}(x||(x={})),function(e){e[e.RUNNING=0]="RUNNING",e[e.Success=1]="Success",e[e.Faild=2]="Faild"}(F||(F={})),function(e){e[e.FAIL_TYPE_NORMAL=1]="FAIL_TYPE_NORMAL",e[e.FAIL_TYPE_ZONE_PERM=2]="FAIL_TYPE_ZONE_PERM"}(P||(P={}));var z,W,$=r("vsh_94760"),K=r("vsh_29033"),Y=r("vsh_4561");(0,K.default)(window)?Y.default:window.requestIdleCallback,"undefined"!=typeof window?window.cancelIdleCallback:Y.default;window.gzip=f.ivc,window.ungzip=f.ecX,function(e){e.Snapshot="Snapshot",e.ChangeSet="ChangeSet",e.DataTable="DataTable"}(z||(z={})),function(e){e.Gzip="Gzip",e.UnGzip="UnGzip"}(W||(W={}));new(function(){function e(){(0,a.Z)(this,e),this.recordStartTime=0,this.reset()}return(0,c.Z)(e,[{key:"reset",value:function(){this.collections={},this.recordStartTime=0}},{key:"getTimestamp",value:function(){return"undefined"!=typeof window&&void 0!==window.performance?window.performance.now():Date.now()}},{key:"recordStart",value:function(){this.recordStartTime&&console.warn("SHEET LOG gzipPerfTracker: you maybe forget call recordEnd."),this.recordStartTime=this.getTimestamp()}},{key:"recordEnd",value:function(e,t,r){if(this.collections[e]||(this.collections[e]={}),this.collections[e][t]||(this.collections[e][t]=[]),this.recordStartTime){var n=this.getTimestamp()-this.recordStartTime;this.collections[e][t].push({length:r,duration:n,timeRatio:r/n}),this.recordStartTime=0}else console.warn("SHEET LOG gzipPerfTracker: please call recordStart first")}},{key:"collect",value:function(){var e=this,t=[];return Object.keys(this.collections).forEach((function(r){var n=e.collections[r],i=Object.keys(n);i.length&&i.forEach((function(e){var i=n[e];if(i.length){var o=i.reduce((function(e,t){return{length:e.length+t.length,duration:e.duration+t.duration,timeRatio:e.timeRatio+t.timeRatio}}),{duration:0,length:0,timeRatio:0});t.push({workType:r,bizDataType:e,length:o.length/i.length,duration:o.duration/i.length,timeRatio:o.timeRatio/i.length})}}))})),this.reset(),t}}]),e}());function X(e){var t,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"utf8",n=0,i=0,o=0;if("utf-16"===(r=r?r.toLowerCase():"")||"utf16"===r)for(i=0,o=e.length;i<o;i++)n+=(t=e.charCodeAt(i))<=65535?2:4;else for(i=0,o=e.length;i<o;i++)n+=(t=e.charCodeAt(i))<=127?1:t<=2047?2:t<=65535?3:4;return n}var J=function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:f.ecX;return e.map((function(e){var r=e.content;return e.gzip_content&&(r=t(e.gzip_content)||[]),Object.assign({},e,{content:r})}))},Q=r("vsh_26278"),ee=["get","set","writable","value"];function te(e){return e&&"function"==typeof e.then}function re(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1e3;return new Promise((function(t){return window.setTimeout(t,e)}))}var ne=r("vsh_69691"),ie=function(e,t){return!!e&&e.type===t&&!!e.data};function oe(e){return function(e){return e.code===ne.STATUS_CODE.SUCCESS&&!!e.data&&e.data.code===ne.STATUS_CODE.SUCCESS}(e)||function(e){var t;return e.code===ne.STATUS_CODE.SUCCESS&&!(null===(t=e.data)||void 0===t||!t.clientvars)}(e)||function(e){var t,r;return e.code===ne.STATUS_CODE.SUCCESS&&((null===(t=e.data)||void 0===t?void 0:t.schemaVersion)===f.n0b.MUTATION&&!!e.data.snapshot||(null===(r=e.data)||void 0===r?void 0:r.schemaVersion)===f.n0b.BACKWARD&&!!e.data.formerlySchema)}(e)}function se(e,t){if(!e.data)return!1;var r=ge(e);return e&&e.code===ne.STATUS_CODE.SUCCESS&&e.data&&r===ne.STATUS_CODE.SUCCESS&&e.data.token===t}function ae(e){var t=e.data;if(de(t)){var r=e.data;return r.is_snapshot_copying=t.status===f.is3.Copying,r.revision=t.revision,r.isHistorySnapshot=!!t.isHistorySnapshot,r}return he(t)&&(t=t.formerlySchema),ue(t)?t.clientvars:t}function ce(e){return e&&e.data&&ue(e.data)}function ue(e){return!(0,K.default)(e.clientvars)}function le(e){return!(0,K.default)(e.schemaVersion)}function he(e){return le(e)&&e.schemaVersion===f.n0b.BACKWARD&&e.formerlySchema}function de(e){return le(e)&&fe(e.schemaVersion)}function fe(e){return!!(e&&e>=f.n0b.MUTATION)}function pe(e){return e.map((function(e){return{revision:e.revision,gzip_content:e.gzipContent,content:e.content,user_id:e.userId,member_id:String(e.memberId)}}))}function ve(e){return e.map((function(e){return{sheetId:e.sheetId,status:e.status,version:e.version}}))}function ge(e){if(e&&e.data)return ue(e.data)||le(e.data)?e.code:e.data.code}function ye(){return!(-1!==location.href.indexOf("clientvarsV3=false"))}function _e(e,t,r,n){if(e.gzipBlockMeta){var i=function(e){var t={},r={},n=0,i=0,o=0;for(var s in e)if(Object.prototype.hasOwnProperty.call(e,s)){var a=e[s],c=a.cellBlockMetas,u=void 0===c?[]:c,l=a.formulaBlockMeta,h=u.map((function(e){return{blockId:e.blockId,revision:e.revision,rowsCount:e.range.rowEnd-e.range.rowStart,startRowIndex:e.range.rowStart,range:e.range,token:e.blockId,size:e.size}}));u.forEach((function(e){i=Math.max(i,e.range.rowEnd),o=Math.max(o,e.range.colEnd),r[e.blockId]=e})),t[s]=Object.assign({id:s,name:s,index:n++,blocks:h,rowCount:i,columnCount:o},l&&{formulaBlockMeta:l})}return{sheets:t,cellBlockMetaMap:r}}(e.blockMeta||(0,ne.ungzip)(e.gzipBlockMeta));e.sheets=i.sheets,e.cellBlockMetaMap=i.cellBlockMetaMap}else e.sheets=(0,u.Z)({},t,{id:t,name:t,index:0});e.gzipDependency&&(e.extra={reference:(0,ne.ungzip)(e.gzipDependency)}),e.schemaVersion=r,e.rev=n}var ke,Ee,me,Se="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz",be=function(){for(var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:20,t="",r=0;r<e;r++)t+=Se[Math.floor(Math.random()*Se.length)];return t};function Ce(e){if(!e||0===e.length)return null;for(var t=e.length-1;t>=0;t--){var r=e[t],n=r.content[0];if(n&&n.action===f.aOo.RECOVER)return{changeset:r,index:t}}return null}function Re(e,t){var r=(0,$.Z)(t.sheets,{id:e});if(!r)throw new Error("sheetId: ".concat(e," "));return r}var Ae=function(){var e;return be(12)+"-"+(null===(e=window.User)||void 0===e?void 0:e.id)};function Te(e,t,r){if(function(e){return e&&e.data&&le(e.data)}(e))return function(e,t){return e.data.token!==t?f.Y6H.templateClientVarsTokenError:!f.Ps3.browser.isFeed&&Date.now()-e.data.serverTimestamp>3e4?f.Y6H.templateClientVarsExpired:e.data.status===f.is3.Copying?f.Y6H.templateClientVarsIsCopying:null}(e,r);if(ce(e))return function(e,t,r){return e.data.token!==r?f.Y6H.templateClientVarsTokenError:!f.Ps3.browser.isFeed&&Date.now()-e.data.clientvars.server_timestamp>3e4?f.Y6H.templateClientVarsExpired:e.data.clientvars.is_snapshot_copying?f.Y6H.templateClientVarsIsCopying:null}(e,0,r);var n=null;if(ie(e,t)){var i=e.data;i.type!==I.CLIENT_VARS?n=f.Y6H.templateClientVarsTypeError:i.token!==r?n=f.Y6H.templateClientVarsTokenError:!f.Ps3.browser.isFeed&&Date.now()-i.server_timestamp>3e4?n=f.Y6H.templateClientVarsExpired:i.is_snapshot_copying&&(n=f.Y6H.templateClientVarsIsCopying)}else n=f.Y6H.hasNoTemplateClientVars;return n}var we=function(e,t,r){var n=Te(e,t,r);return!n||(f.Ps3.moirae.teaLog({key:"client_sheet_path_tracker_dev",trace_code:n}),!1)};var Oe,Ie,De,Le={count:5,whiteList:(ke={},(0,u.Z)(ke,I.USER_CHANGES,!0),(0,u.Z)(ke,I.NEW_CHANGES,!0),ke),countMap:(Ee={},(0,u.Z)(Ee,N.Exception,Number.MAX_VALUE),(0,u.Z)(Ee,N.Code1015,10),Ee),intervalCalculator:(me={},(0,u.Z)(me,N.Exception,(function(e){return Math.min((e+1)*(e<5?1e3:3e3),3e4)})),(0,u.Z)(me,N.Code1015,(function(e){return 1e3*Math.pow(e,2)})),me),getYieldInterval:function(e,t){return Le.intervalCalculator[t]?Le.intervalCalculator[t](e):1e3*Math.pow(e,2)}},Me=r("vsh_45617");!function(e){e[e.EMBED_SHEET=0]="EMBED_SHEET",e[e.MIXED_BITABLE=1]="MIXED_BITABLE"}(Oe||(Oe={})),function(e){e[e.DOC=1]="DOC",e[e.SHEET=2]="SHEET",e[e.SLIDE=3]="SLIDE",e[e.BITABLE_TABLE=4]="BITABLE_TABLE",e[e.BITABLE_BASE=5]="BITABLE_BASE",e[e.SHEET_BLOCKS_CHART=110]="SHEET_BLOCKS_CHART",e[e.SHEET_BLOCKS_PIVOT=37]="SHEET_BLOCKS_PIVOT"}(Ie||(Ie={})),function(e){e[e.DOC=0]="DOC",e[e.SHEET=1]="SHEET",e[e.SLIDE=2]="SLIDE",e[e.BITABLE_TABLE=3]="BITABLE_TABLE",e[e.BITABLE_BASE=4]="BITABLE_BASE"}(De||(De={}));var Ne,Be=800014002,xe=f.ZB9.ERROR_PASSPORT_DELETED,Fe=function(){function e(t,r,i){var o=this;(0,a.Z)(this,e),this.clientMetaInfo=t,this.context=r,this.requestProvider=i,this.tokenRevEnd=0,this.snapshotList=new Map,this.changesetList=new Map,this.requestSource=null,this.fetchHistoryList=function(e,t){var r="".concat(o.requestProvider.apiUrls.GET_SHEET_HISTORY_LIST,"/").concat(o.clientMetaInfo.token),n=o.requestProvider.getRequest(r,{baseURL:o.requestProvider.prependAPI("/"),params:{start:e,page_size:t},headers:(0,u.Z)({},U,"api.sheet.histories.token")});return o.requestSource=n.source,n.promise},this.fetchEmbedHistoryList=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,t=arguments.length>1?arguments[1]:void 0,r="".concat(o.requestProvider.apiUrls.GET_EMBED_SHEET_HISTORY_LIST,"/").concat(o.clientMetaInfo.token),n=o.requestProvider.getRequest(r,{baseURL:o.requestProvider.prependAPI("/"),params:{begin:e,duration:t},headers:(0,u.Z)({},U,V)});return o.requestSource=n.source,n.promise},this.fetchMixedHistoryList=function(){var e=(0,C.Z)(b().mark((function e(t,r){var n,i,s,a,c,l;return b().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n="".concat(o.requestProvider.apiUrls.GET_SHEET_MIXED_HISTORY_LIST,"/").concat(o.clientMetaInfo.token,"/"),i=o.requestProvider.getRequest(n,{baseURL:o.requestProvider.prependAPI("/"),params:{max_version:t,page_size:r},headers:(0,u.Z)({},U,j)}),o.requestSource=i.source,s=(0,f.RdR)((function(){return i.promise}),{max:3,interval:1e3}),e.next=6,s();case 6:if(a=e.sent,c=a.code,l=a.payload,0!==c){e.next=13;break}return e.abrupt("return",l);case 13:throw l;case 14:case"end":return e.stop()}}),e)})));return function(t,r){return e.apply(this,arguments)}}(),this.fetchMixedSubscriptionHistoryList=function(){var e=(0,C.Z)(b().mark((function e(t,r){var n,i,s,a,c,u;return b().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n="".concat(o.requestProvider.apiUrls.GET_SHEET_MIXED_HISTORY_LIST_FOR_SUBSCRIPTION,"/"),i=o.requestProvider.getRequest(n,{baseURL:o.requestProvider.prependAPI("/"),params:{token:o.clientMetaInfo.token,obj_type:3,max_reversion:t,page_size:r}}),o.requestSource=i.source,s=(0,f.RdR)((function(){return i.promise}),{max:3,interval:1e3}),e.next=6,s();case 6:if(a=e.sent,c=a.code,u=a.payload,0!==c){e.next=13;break}return e.abrupt("return",u);case 13:throw u;case 14:case"end":return e.stop()}}),e)})));return function(t,r){return e.apply(this,arguments)}}(),this.recoverMixedHistoryCore=function(){var e=(0,C.Z)(b().mark((function e(t,r){var n,i,s;return b().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n="".concat(o.requestProvider.apiUrls.RECOVER_SHEET_MIXED_HISTORY,"?random=").concat(r),i=o.requestProvider.putRequest(n,JSON.stringify({token:o.clientMetaInfo.token,id:t,member_id:Number(o.clientMetaInfo.memberId),msg_id:(0,Me.v4)()}),{baseURL:o.requestProvider.prependAPI("/"),headers:(0,u.Z)({},U,"api.v2.sheet.recover")}),o.requestSource=i.source,e.next=5,i.promise;case 5:if((s=e.sent)&&(!s.code||0===s.code)){e.next=8;break}throw new Error(s);case 8:return e.next=10,o.pollRecoverResult(s.data.transaction_id);case 10:case"end":return e.stop()}}),e)})));return function(t,r){return e.apply(this,arguments)}}(),this.pollRecoverResult=function(){var e=(0,C.Z)(b().mark((function e(t){var r,i,s,a,c,u,l;return b().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:r={transaction_id:t,token:o.clientMetaInfo.token},i=0;case 2:if(!(i<30)){e.next=18;break}return s=o.requestProvider.getRequest(o.requestProvider.apiUrls.RECOVER_SHEET_POLL_STATUS,{params:r}),e.next=6,s.promise;case 6:if((a=e.sent)&&(!a.code||0===a.code)&&a.data){e.next=9;break}throw new Error(a);case 9:if(c=a.data,u=c.status,l=c.fail_type,!o.processPollRecoverResult(u,l)){e.next=13;break}return e.abrupt("return");case 13:return e.next=15,re(2e3);case 15:i++,e.next=2;break;case 18:o.context&&o.context.trigger(n.RECOVER_ERROR);case 19:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),this.processPollRecoverResult=function(e,t){if(F.Success===e)return o.context&&o.context.trigger(n.RECOVER_SUCCESS),!0;if(F.Faild===e){var r=P.FAIL_TYPE_ZONE_PERM===t;return o.context&&o.context.trigger(n.RECOVER_ERROR,{isZonePermError:r}),!0}return!1}}var t,r,i;return(0,c.Z)(e,[{key:"getSubscriptionHistoryList",value:(i=(0,C.Z)(b().mark((function e(t,r){var n,i,o,s,a,c,u;return b().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=null,e.next=3,this.fetchMixedSubscriptionHistoryList(t,r);case 3:if((n=e.sent)&&(!n.code||0===n.code)){e.next=6;break}return e.abrupt("return",null);case 6:for(i=0,o=n.data.MinorHistories,s=0;s<o.length;s++)for(c in(a=o[s]).all_block_revision)(u=a.all_block_revision[c]).obj_type===Ie.SHEET&&(i=Math.max(i,u.last_revision));return this.tokenRevEnd=Math.max(i,this.tokenRevEnd),e.abrupt("return",n);case 11:case"end":return e.stop()}}),e,this)}))),function(e,t){return i.apply(this,arguments)})},{key:"updateSnapshot",value:function(e,t){this.snapshotList.set(e,t)}},{key:"getHistoryList",value:(r=(0,C.Z)(b().mark((function e(t,r,n){var i,o,s,a,c,u,l;return b().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(i=null,e.prev=1,n!==Oe.MIXED_BITABLE){e.next=8;break}return e.next=5,this.fetchMixedHistoryList(t,r);case 5:i=e.sent,e.next=17;break;case 8:if(!this.context||!this.context.isEmbed()){e.next=14;break}return e.next=11,this.fetchEmbedHistoryList(t,r);case 11:i=e.sent,e.next=17;break;case 14:return e.next=16,this.fetchHistoryList(t,r);case 16:i=e.sent;case 17:e.next=23;break;case 19:if(e.prev=19,e.t0=e.catch(1),e.t0.payload.code!==xe){e.next=23;break}return e.abrupt("return",e.t0.payload);case 23:if(i&&(!i.code||0===i.code)){e.next=25;break}return e.abrupt("return",null);case 25:if(o=0,n===Oe.MIXED_BITABLE)for(s=i.data.minor_histories,a=0;a<s.length;a++)for(u in(c=s[a]).all_block_revision)(l=c.all_block_revision[u]).obj_type===Ie.SHEET&&(o=Math.max(o,l.last_revision));else o=this.context&&this.context.isEmbed()?i.data.end:i.data.histories[0].last_revision;return this.tokenRevEnd=Math.max(o,this.tokenRevEnd),e.abrupt("return",i);case 29:case"end":return e.stop()}}),e,this,[[1,19]])}))),function(e,t,n){return r.apply(this,arguments)})},{key:"destroy",value:function(){this.changesetList.clear(),this.snapshotList.clear(),this.tokenRevEnd=0,this.requestSource&&this.requestSource.cancel(),delete this.sync,delete this.context}},{key:"recoverMixedHistory",value:(t=(0,C.Z)(b().mark((function e(t){var r;return b().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r="".concat(Date.now()).concat(Math.floor(1e3*Math.random())),e.next=3,this.recoverMixedHistoryCore(t,r);case 3:return e.abrupt("return",e.sent);case 4:case"end":return e.stop()}}),e,this)}))),function(e){return t.apply(this,arguments)})}]),e}(),Pe=r("vsh_36189"),Ue=r("vsh_12064"),He=r("vsh_22462"),Ve=r("vsh_93035"),Ze=r("vsh_73455");!function(e){e.WorkerAvailabilityTest="WorkerAvailabilityTest"}(Ne||(Ne={}));var je=r("vsh_5430"),Ge=r.n(je),qe=r("vsh_89722"),ze=r("vsh_65780"),We=r("vsh_38165"),$e=(r("vsh_40338"),r("vsh_56228")),Ke={nested:{sheet:{nested:{Action:{fields:{action:{rule:"required",type:"ActionCode",id:1},sheet_id:{rule:"required",type:"string",id:2},sheet_name:{type:"string",id:3},target:{type:"TARGET",id:4},value:{type:"string",id:5},type:{type:"int32",id:6},extra:{type:"string",id:7}},nested:{ActionCode:{values:m},TARGET:{fields:{row:{type:"int32",id:1},row_count:{type:"int32",id:2},col:{type:"int32",id:3},col_count:{type:"int32",id:4},type:{type:"Type",id:5}},nested:{Type:{values:{Normal:0,Row:1,Col:2,All:3}}}}}},SheetChangeset:{fields:{ops:{rule:"repeated",type:"Action",id:1}}}}}}},Ye=$e.Root.fromJSON(Ke).root.lookupType("sheet.SheetChangeset");function Xe(){for(var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[],t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:qe.n.NEW_SPLIT_CODE,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:ze.ec,n={},i=0;i<e.length;i++){var o=e[i].dataTable;o||(o=r(e[i].gzip_datatable)),t===qe.n.OLD?Object.assign(n,o):Object.assign(n,(0,We.B)(o,e[i].row))}return n}var Je=(0,u.Z)({ungzip:ze.ec,gzip:ze.iv,ungzipBlocks:Xe,"changeset.protobuf":function(e){var t=Date.now(),r={ops:function(e){return JSON.parse(JSON.stringify(e,(function(e,t){return"style"===e&&void 0===t?null:t})))}(e.content).map((function(e){return e.action=m[e.action.toUpperCase()],void 0!==e.value&&(e.value=JSON.stringify(e.value)),void 0!==e.extra&&(e.extra=JSON.stringify(e.extra)),e}))},n=Ye.verify(r);if(n)throw new Error(n);var i=Ye.encode(Ye.create(r)).finish(),o=(0,ze.iv)(i);return Object.assign({},e,{content:o,gzip:!0,timeCost:Date.now()-t})},checkCpuPerformance:function(){for(var e=new Date,t=15e7,r=t;r>0;r--);var n=new Date,i=n.getSeconds()+n.getMilliseconds()/1e3-(e.getSeconds()+e.getMilliseconds()/1e3);e.getMinutes()!==n.getMinutes()&&(i=60*(n.getMinutes()-e.getMinutes())+i);var o=1.349955/i;return{timeCost:Math.round(100*i)/100,estimatedSpeed:Math.round(100*o)/100}}},Ne.WorkerAvailabilityTest,(function(){return{message:Ne.WorkerAvailabilityTest}})),Qe=r("vsh_65498"),et=function(){function e(t){var r=this;(0,a.Z)(this,e),this.proxyWorker=t,this.workerAvailabilityTestTimer=null,this.onAfterCreateWorker=function(){e.hasTestWorkerAvailability||(e.workerAvailabilityData.timeAfterNewWorker=performance.now(),e.workerAvailabilityData.canCreateWorker=!0,r.workerAvailabilityTest())},this.onCreateWorkerFail=function(){e.hasTestWorkerAvailability||(e.workerAvailabilityData.canCreateWorker=!1)},this.report=function(t){if(e.workerAvailabilityData.timeReceivedMessage=performance.now(),e.workerAvailabilityData.reportType=t||null,null!=r.workerAvailabilityTestTimer&&clearTimeout(r.workerAvailabilityTestTimer),!e.hasReportWorkerAvailability){e.hasReportWorkerAvailability=!0;var n=e.workerAvailabilityData,i=n.timeBeforeNewWorker,o=n.timeAfterNewWorker,s=n.timeBeforePostMessage,a=n.timeAfterPostMessage,c=n.timeReceivedMessage,u={hasWorkerClass:"function"==typeof window.Worker?1:0,canCreateWorker:e.workerAvailabilityData.canCreateWorker?1:0,canCommunicate:null!=s&&null!=a?1:0,createWorkerDuration:null!=o&&null!=i?o-i:-1,communicationDuration:null!=c&&null!=s?c-s:-1,workerReadyDuration:null!=c&&null!=i?c-i:-1,hardwareConcurrency:"object"===(0,Qe.Z)(window.navigator)?window.navigator.hardwareConcurrency:0};f.Ps3.collectSuiteEvent("sheet_worker_status_dev",u),r.dispose()}},this.bindEvents(),e.workerAvailabilityData.timeBeforeNewWorker=performance.now()}return(0,c.Z)(e,[{key:"bindEvents",value:function(){this.proxyWorker.addListener(tt.onAfterCreateWorker,this.onAfterCreateWorker),this.proxyWorker.addListener(tt.onCreateWorkerFail,this.onCreateWorkerFail)}},{key:"unbindEvents",value:function(){this.proxyWorker.removeListener(tt.onAfterCreateWorker,this.onAfterCreateWorker),this.proxyWorker.removeListener(tt.onCreateWorkerFail,this.onCreateWorkerFail)}},{key:"workerAvailabilityTest",value:function(){var t=this;e.hasTestWorkerAvailability||(e.hasTestWorkerAvailability=!0,this.workerAvailabilityTestTimer=window.setTimeout((function(){return t.report("timeout")}),3e4),e.workerAvailabilityData.timeBeforePostMessage=performance.now(),this.proxyWorker.exec(Ne.WorkerAvailabilityTest).then((function(){return t.report("success")})).catch((function(){return t.report("fail")})),e.workerAvailabilityData.timeAfterPostMessage=performance.now())}},{key:"dispose",value:function(){null!=this.workerAvailabilityTestTimer&&clearTimeout(this.workerAvailabilityTestTimer),this.unbindEvents(),this.proxyWorker.workerAvailability=null}}]),e}();et.hasTestWorkerAvailability=!1,et.hasReportWorkerAvailability=!1,et.workerAvailabilityData={canCreateWorker:!1,timeBeforeNewWorker:null,timeAfterNewWorker:null,timeBeforePostMessage:null,timeAfterPostMessage:null,timeReceivedMessage:null,reportType:null};var tt,rt=function(){var e=(0,C.Z)(b().mark((function e(t,r,n){var i,o;return b().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return o=new Promise((function(e){i=setTimeout((function(){e(n())}),r)})),e.prev=1,e.next=4,Promise.race([o,t]);case 4:return e.abrupt("return",e.sent);case 5:return e.prev=5,void 0!==i&&clearTimeout(i),e.finish(5);case 8:case"end":return e.stop()}}),e,null,[[1,,5,8]])})));return function(t,r,n){return e.apply(this,arguments)}}(),nt=0;!function(e){e.onBeforeCreateWorker="onBeforeCreateWorker",e.onAfterCreateWorker="onAfterCreateWorker",e.onCreateWorkerFail="onCreateWorkerFail"}(tt||(tt={}));var it=function(e){function t(){var e;return(0,a.Z)(this,t),(e=(0,Ue.Z)(this,(0,He.Z)(t).call(this))).worker=null,e.isWorkerValid=!0,e.timeoutOptions={},e.workerAvailability=null,e.onBeforeCreateWorker=function(){et.hasTestWorkerAvailability||(e.workerAvailability=new et((0,Ve.Z)(e)))},e.callbacks={},e.reset=function(){e.log("reset"),e.callbacks={}},e.destroy=function(){e.log("destroy_start"),e.unBindEvents(),e.reporterService=null,null!==e.worker&&("function"==typeof e.worker.removeEventListener&&(e.worker.removeEventListener("error",e.onError),e.worker.removeEventListener("message",e.onMessage)),e.worker.terminate(),e.log("destroy_fin"))},e.fallback=function(e,t){return function(e){var t=Je[e.method];if(t)return t.apply(void 0,(0,p.Z)(e.args))}({method:e,args:t})},e.onMessage=function(t){var r=t.data,n=r.execId,i=e.callbacks[n];i?(r.error?(e.log("reject"),i.reject(new Error(r.msg))):(e.log("resolve"),i.resolve(r.data)),delete e.callbacks[n]):e.log("no_callback")},e.onError=function(t){var r;e.isWorkerValid=!1,console.error(t);var n="";try{n=JSON.stringify(t.message)}catch(e){console.error(e)}e.log("error",{data:n}),null===(r=e.logger)||void 0===r||r.ravenCatch(t.message,{tags:{scm:JSON.stringify(window.scm),key:"SHEET_IO_WORKER_ERROR"}})},e.bindEvents(),e}return(0,Ze.Z)(t,e),(0,c.Z)(t,[{key:"bindEvents",value:function(){this.addListener(tt.onBeforeCreateWorker,this.onBeforeCreateWorker)}},{key:"unBindEvents",value:function(){this.removeListener(tt.onBeforeCreateWorker,this.onBeforeCreateWorker)}},{key:"createWorker",value:function(){this.log("create");var e=null;this.emit(tt.onBeforeCreateWorker);try{e=new(Ge())}catch(t){return this.emit(tt.onCreateWorkerFail),e}return this.emit(tt.onAfterCreateWorker),null==e?(this.log("create_fail"),e):("function"==typeof e.addEventListener?(e.addEventListener("error",this.onError),e.addEventListener("message",this.onMessage)):this.log("bind_fail"),e)}},{key:"setLogger",value:function(e){this.logger=e}},{key:"setReporterService",value:function(e){this.reporterService=e}},{key:"setTimeoutOptions",value:function(e){this.timeoutOptions=e}},{key:"exec",value:function(e){for(var t=this,r=arguments.length,n=new Array(r>1?r-1:0),i=1;i<r;i++)n[i-1]=arguments[i];if(!this.isWorkerValid)return Promise.resolve(this.fallback(e,n));var o=new Promise((function(r,i){if(null===t.worker&&(t.worker=t.createWorker()),null!=t.worker){var o;if(f.Ps3.browser.isMobile&&e!==Ne.WorkerAvailabilityTest)if(!et.hasReportWorkerAvailability||"success"!==(null===(o=et.workerAvailabilityData)||void 0===o?void 0:o.reportType))return void r(t.fallback(e,n));t.log("run");var s={execId:nt,method:e,args:n};try{t.worker.postMessage(s)}catch(e){t.log("post_fail",{msg:e.message});try{console.error("message"),t.worker.postMessage(JSON.parse(JSON.stringify(s)))}catch(e){t.log("post_fail",{msg:e.message})}}t.callbacks[nt++]={resolve:r,reject:i}}else r(t.fallback(e,n))})),s=this.timeoutOptions[e];return"number"==typeof s?rt(o,s,(function(){return t.reporterService&&t.reporterService.eventReport({key:"ccm_sheet_protobuf_timeout_dev"}),t.fallback(e,n)})):o}},{key:"getWorker",value:function(){return this.worker}},{key:"log",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};this.logger&&this.logger.teaLog(Object.assign({key:"client_sheet_sync_worker_".concat(e),execId:nt},t))}}]),t}(f.vpe),ot=r("vsh_31630"),st=r("vsh_26171"),at=r("vsh_47246"),ct=r("vsh_1139"),ut=r("vsh_16698"),lt=r("vsh_54997"),ht=r.n(lt),dt=r("vsh_92292"),ft=function(){function e(){(0,a.Z)(this,e)}return(0,c.Z)(e,[{key:"aggregate",value:function(){for(var e=this,t=[],r=arguments.length,n=new Array(r),i=0;i<r;i++)n[i]=arguments[i];return n.forEach((function(r,n){if(0===n)t.push(r);else for(var i=t.length-1;i>=0;){var o=t[i],s=e.tryAggregate(o,r),a=(0,ct.Z)(s,2),c=a[0],u=a[1];if(c&&u){t[i]=u;break}--i<0&&t.push(r)}})),t}}]),e}(),pt=function(e){function t(e,r){var n;return(0,a.Z)(this,t),(n=(0,Ue.Z)(this,(0,He.Z)(t).call(this))).aggregateRestrict=e,n.runMultiple=r,n}return(0,Ze.Z)(t,e),(0,c.Z)(t,[{key:"tryAggregate",value:function(e,t){var r=this,n=Array.isArray(e.key)?(0,p.Z)(e.key):[e.key];return Array.isArray(t.key)?n.push.apply(n,(0,p.Z)(t.key)):n.push(t.key),this.canAggregate(n)?[!0,{key:n,run:function(){return r.runMultiple(n).then((function(e){return e}))},beforeRun:function(){var r,n;null===(r=e.beforeRun)||void 0===r||r.call(e),null===(n=t.beforeRun)||void 0===n||n.call(t)},done:function(r){e.done(r),t.done(r)}}]:[!1,null]}},{key:"canAggregate",value:function(e){var t=this;return 0!==e.length&&(e.every((function(e){return!t.aggregateRestrict.some((function(t){return t.has(e)}))}))||this.aggregateRestrict.some((function(t){return e.every((function(e){return t.has(e)}))})))}}]),t}(ft),vt=r("vsh_47253"),gt=function(){function e(t,r,n){(0,a.Z)(this,e),this.total=t,this.duration=r,this.run=n,this.picked=0,this.isDestroy=!1,this.tick()}return(0,c.Z)(e,[{key:"tick",value:function(){var e=this;this.timer=setInterval((function(){e.picked=0,e.run()}),this.duration)}},{key:"in",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1;return!(this.isDestroy||this.rest<e)&&(this.picked+=e,!0)}},{key:"out",value:function(){this.picked>0&&(this.picked-=1)}},{key:"destroy",value:function(){this.isDestroy=!0,clearInterval(this.timer)}},{key:"rest",get:function(){return this.total-this.picked}}]),e}(),yt=function(){function e(){var t=this,r=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:f.AXv.runInBackground,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:10,o=arguments.length>3&&void 0!==arguments[3]?arguments[3]:80;(0,a.Z)(this,e),this.aggregator=r,this.taskMode=n,this.parallelNum=i,this.taskEntityMap={},this.isDestroy=!1,this.isStoped=!1,this.aggregationIdleTime=50,this.isAllTasksDone=function(){return t.getTaskCount(f.hYU.Done)===Object.keys(t.taskEntityMap).length},this.throttleRun=(0,vt.default)((function(){return t.run()}),this.aggregationIdleTime),this.getPendingTaskCount=function(){return t.getTaskCount(f.hYU.Pending)},this.getIdleTaskCount=function(){return t.getTaskCount(f.hYU.Idle)},this.getTaskCount=function(e){return Object.values(t.taskEntityMap).reduce((function(t,r){return r.status===e?t+1:t}),0)},this.handleRes=function(e){e.forEach((function(e){t.taskEntityMap[e].status=f.hYU.Done})),t.throttleRun()},this.limiter=new gt(o,1e3,(function(){return t.run()}))}return(0,c.Z)(e,[{key:"start",value:function(){this.run()}},{key:"stop",value:function(){this.isStoped=!0}},{key:"isTasksDone",value:function(e){var t=this;return e.every((function(e){return t.taskEntityMap[e].status===f.hYU.Done}))}},{key:"run",value:function(){var e,t=this;if(f.NVo.instance.onRun(),this.isDestroy||this.isStoped||this.isAllTasksDone())f.NVo.instance.onTasksEnd(this.isDestroy,this.isStoped,this.isAllTasksDone());else{var r=this.getPendingTaskCount();if(f.NVo.instance.onPendingTaskCount(r),r>=this.parallelNum)return f.NVo.instance.onNoIdleTask(),void(r>this.parallelNum&&console.error("parallel task count error"));var n=Math.min(this.parallelNum-r,this.limiter.rest);f.NVo.instance.onCandidateTasksNum(n);var i=this.getCandidateTasks(n).map((function(e){return t.taskEntityMap[e]}));f.NVo.instance.onRunCandidateTask(n,i);var o=this.aggregator?(e=this.aggregator).aggregate.apply(e,(0,p.Z)(i)):i;f.NVo.instance.onAggregateTask(o),o.forEach((function(e){var r,n=Array.isArray(e.key)?e.key:[e.key];n.forEach((function(e){t.taskEntityMap[e].status=f.hYU.Pending,t.limiter.in(1)})),null===(r=e.beforeRun)||void 0===r||r.call(e),e.run().then((function(r){e.done(r),f.NVo.instance.onTaskDone(n,"idle num: ".concat(t.getIdleTaskCount()),"pending num: ".concat(t.getPendingTaskCount())),t.handleRes(n)}))}))}}},{key:"getCandidateTasks",value:function(e){var t=this;return 0===e?[]:this.taskMode===f.AXv.onDemand?Object.keys(this.taskEntityMap).filter((function(e){return t.taskEntityMap[e].status===f.hYU.Idle&&t.taskEntityMap[e].priority===f.ULn.High})).slice(0,e):Object.keys(this.taskEntityMap).filter((function(e){return t.taskEntityMap[e].status===f.hYU.Idle})).sort((function(e,r){return t.taskEntityMap[r].priority-t.taskEntityMap[e].priority})).slice(0,e)}},{key:"add",value:function(e,t,r,n,i){this.taskEntityMap[e]?console.info("task ".concat(e," already done")):(f.NVo.instance.onAddTask(e,n),this.taskEntityMap[e]={key:e,run:t,priority:null==n?f.ULn.Normal:n,status:f.hYU.Idle,done:r,beforeRun:i})}},{key:"resetPriority",value:function(){var e=this,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:f.ULn.Normal;Object.keys(this.taskEntityMap).forEach((function(r){return e.taskEntityMap[r].priority=t}))}},{key:"setPriority",value:function(e,t){var r=this;e.forEach((function(e){r.taskEntityMap[e]?r.taskEntityMap[e].priority=t:console.warn("cannot find target to set priority")})),this.run()}},{key:"destroy",value:function(){this.stop(),this.isDestroy=!0,this.limiter.destroy()}},{key:"getTaskMode",value:function(){return this.taskMode}}]),e}(),_t=function(e){function t(e){var r,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:f.AXv.runInBackground,o=arguments.length>3&&void 0!==arguments[3]?arguments[3]:10,s=arguments.length>4&&void 0!==arguments[4]?arguments[4]:80;return(0,a.Z)(this,t),(r=(0,Ue.Z)(this,(0,He.Z)(t).call(this,n,i,o,s))).blockRelationMap=e,r.sheetTaskStatus=new Set,r}return(0,Ze.Z)(t,e),(0,c.Z)(t,[{key:"getCandidateTasks",value:function(e){var t=this;if(0===e)return[];var r=function(e,r){return t.blockRelationMap[e]?t.blockRelationMap[r]?t.blockRelationMap[e].localeCompare(t.blockRelationMap[r]):1:-1};return this.taskMode===f.AXv.onDemand?Object.keys(this.taskEntityMap).filter((function(e){return t.taskEntityMap[e].status===f.hYU.Idle&&t.taskEntityMap[e].priority===f.ULn.High})).slice(0,e).sort(r):Object.keys(this.taskEntityMap).filter((function(e){return t.taskEntityMap[e].status===f.hYU.Idle})).sort((function(e,r){return t.taskEntityMap[r].priority-t.taskEntityMap[e].priority})).slice(0,e).sort(r)}},{key:"onTaskStart",value:function(e){var t=this.blockRelationMap[e];t&&!this.sheetTaskStatus.has(t)&&(this.sheetTaskStatus.add(t),f.NVo.instance.onSheetStartLoad(t))}},{key:"onTaskEnd",value:function(e){}},{key:"onAllTasksDone",value:function(){f.NVo.instance.onBlockDataReady()}}]),t}(yt);function kt(e,t){var r="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!r){if(Array.isArray(e)||(r=function(e,t){if(!e)return;if("string"==typeof e)return Et(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);"Object"===r&&e.constructor&&(r=e.constructor.name);if("Map"===r||"Set"===r)return Array.from(e);if("Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r))return Et(e,t)}(e))||t&&e&&"number"==typeof e.length){r&&(e=r);var n=0,i=function(){};return{s:i,n:function(){return n>=e.length?{done:!0}:{done:!1,value:e[n++]}},e:function(e){throw e},f:i}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,s=!0,a=!1;return{s:function(){r=r.call(e)},n:function(){var e=r.next();return s=e.done,e},e:function(e){a=!0,o=e},f:function(){try{s||null==r.return||r.return()}finally{if(a)throw o}}}}function Et(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,n=new Array(t);r<t;r++)n[r]=e[r];return n}var mt=function(){function e(t,r,n,i,o){(0,a.Z)(this,e),this.sheetDp=t,this.runner=r,this.getBackRefBlockTokens=n,this.sheetLoadedFn=i,this.spreadLoadedFn=o,this.requestTasks=[],this.appliedRowCountStatus={},this.sheetLoadedStatus={},this.isSpreadLoaded=!1}return(0,c.Z)(e,[{key:"getTaskMode",value:function(){return this.runner.getTaskMode()}},{key:"getSheetAllDp",value:function(e){var t=[];return t.push.apply(t,(0,p.Z)(this.getBackRefBlockTokens(e))),t.push.apply(t,(0,p.Z)(Array.from(this.sheetDp[e]||[]))),Array.from(new Set(t))}},{key:"requestSheets",value:function(e,t){f.NVo.instance.onRequestSheets(e);var r={type:Ct.Sheet,tokens:e,callback:t};f.NVo.instance.onUpdateQueue("requestTask",this.requestTasks.length);var n,i=[],o=kt(e);try{for(o.s();!(n=o.n()).done;){var s=n.value;i.push.apply(i,(0,p.Z)(this.getSheetAllDp(s)))}}catch(e){o.e(e)}finally{o.f()}var a=Array.from(new Set(i));return 0===a.length?r.callback&&r.callback():(this.requestTasks.push(r),this.runner.setPriority(a,f.ULn.High)),function(){return r.callback=null}}},{key:"requestBlocks",value:function(e,t){f.NVo.instance.onRequestBlocks(e);var r={type:Ct.Block,tokens:e,callback:t};return this.requestTasks.push(r),f.NVo.instance.onUpdateQueue("requestTask",this.requestTasks.length),this.runner.setPriority(e,f.ULn.High),function(){return r.callback=null}}},{key:"setBlockRowCount",value:function(e,t){if(f.NVo.instance.onSetBlockRowCount(e,t),this.appliedRowCountStatus[e])return f.NVo.instance.onSetBlockRowCountFail(),void console.error("repeat block token for channel");this.appliedRowCountStatus[e]=t,0===this.appliedRowCountStatus[e]&&this.onDataApplied(e)}},{key:"onRowDataApplied",value:function(e,t){if(f.NVo.instance.onRowDataApplied(e,t),null==this.appliedRowCountStatus[e])return f.NVo.instance.onRowDataAppliedFail(),void console.error("should init row count before applied");this.appliedRowCountStatus[e]-=1,0===this.appliedRowCountStatus[e]&&this.onDataApplied(e)}},{key:"isSheetApplied",value:function(e){return!this.sheetDp[e]||this.isBlocksApplied(this.getSheetAllDp(e))}},{key:"isBlocksApplied",value:function(e){var t=this;return e.every((function(e){return 0===t.appliedRowCountStatus[e]}))}},{key:"forceSheetLoaded",value:function(e){this.sheetDp[e]&&(this.sheetLoadedStatus[e]=!0,this.onSpreadLoaded())}},{key:"onDataApplied",value:function(e){f.NVo.instance.onDataApplied(e),this.onTaskCallback(e),this.onSheetsLoaded(),this.onSpreadLoaded()}},{key:"onTaskCallback",value:function(e){for(var t=this;this.requestTasks.length;){var r=this.requestTasks[0];if(!(r.type===Ct.Sheet?r.tokens.every((function(e){return t.isSheetApplied(e)})):this.isBlocksApplied(r.tokens)))break;this.requestTasks.shift(),f.NVo.instance.onUpdateQueue("requestTask",this.requestTasks.length),r.callback&&r.callback(),f.NVo.instance.onTaskCallback(r.tokens.join(","))}}},{key:"onSheetsLoaded",value:function(){var e=this;Object.keys(this.sheetDp).forEach((function(t){e.isSheetApplied(t)&&!e.sheetLoadedStatus[t]&&(f.NVo.instance.onSheetLoaded(t),e.sheetLoadedStatus[t]=!0,e.sheetLoadedFn(t))}))}},{key:"onSpreadLoaded",value:function(){var e=this;this.isSpreadLoaded||(this.isSpreadLoaded=Object.keys(this.sheetDp).every((function(t){return e.sheetLoadedStatus[t]})),this.isSpreadLoaded&&(this.spreadLoadedFn(),f.NVo.instance.onSpreadLoaded()))}}]),e}();function St(e,t){var r="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!r){if(Array.isArray(e)||(r=function(e,t){if(!e)return;if("string"==typeof e)return bt(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);"Object"===r&&e.constructor&&(r=e.constructor.name);if("Map"===r||"Set"===r)return Array.from(e);if("Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r))return bt(e,t)}(e))||t&&e&&"number"==typeof e.length){r&&(e=r);var n=0,i=function(){};return{s:i,n:function(){return n>=e.length?{done:!0}:{done:!1,value:e[n++]}},e:function(e){throw e},f:i}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,s=!0,a=!1;return{s:function(){r=r.call(e)},n:function(){var e=r.next();return s=e.done,e},e:function(e){a=!0,o=e},f:function(){try{s||null==r.return||r.return()}finally{if(a)throw o}}}}function bt(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,n=new Array(t);r<t;r++)n[r]=e[r];return n}var Ct,Rt=function(e,t,r,n){var i,o=arguments.length,s=o<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,r):n;if("object"===("undefined"==typeof Reflect?"undefined":(0,Qe.Z)(Reflect))&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,t,r,n);else for(var a=e.length-1;a>=0;a--)(i=e[a])&&(s=(o<3?i(s):o>3?i(t,r,s):i(t,r))||s);return o>3&&s&&Object.defineProperty(t,r,s),s};!function(e){e.Sheet="Sheet",e.Block="Block"}(Ct||(Ct={}));var At=function(){function e(t){var r=this;(0,a.Z)(this,e),this.sheetBlocks={},this.sheetFormulaCache={},this.blockRelationMap={},this.sheetDependences={},this.sheetRefDependencies={},this.noBlockSheets=new Set,this.isDisposed=!1,this.fetchStartTime=0,this.fetchAllFormulaCacheTime=0,this.formulaCacheBlocks={},this.hasCollectedPreloadSuccessEvent=!1,this.getBackRefBySheetId=function(e){return Array.from(r.sheetRefDependencies[e]||[])},this.getBackRefBlockTokens=function(e){for(var t=r.getBackRefBySheetId(e),n=[],i=0;i<t.length;i++)n.push.apply(n,(0,p.Z)(Array.from(r.sheetDependences[t[i]]||[])));return Array.from(new Set(n))},this.onFirstFormulaCacheTaskDone=function(e,t,n){if(n){var i=0,o=(Array.isArray(n.data.blocks)?n.data.blocks:Object.entries(n.data.blocks).map((function(e){var t=(0,ct.Z)(e,2);return{block_token:t[0],gzip_datatable:t[1]}}))).filter((function(e){return e.block_token===t})).reduce((function(t,n){var o,s=n.block_token,a=n.gzip_datatable;i+=a.length;var c=(0,f.ecX)(a);return r.sheetFormulaCache[e].delete(s),null===(o=r.params)||void 0===o||o.callback.onFormulaMetaLoaded(e,c),[].concat((0,p.Z)(t),(0,p.Z)(c.blocks.map((function(t){return r.sheetFormulaCache[e].add(t.token),t.token}))))}),[]);i&&f.Ps3.collectSuiteEvent("client_sheet_path_tracker_dev",{trace_code:f.Y6H.ungzipFormulaCache,length:i}),o.length&&o.forEach((function(t){var n;null===(n=r.runner)||void 0===n||n.add(t,(function(){return r.fetchSubBlocks([t])}),(function(n){return r.onSecondFormulaCacheTaskDone(e,t,n)}),f.ULn.High)}))}},this.onSecondFormulaCacheTaskDone=function(e,t,n){if(r.sheetFormulaCache[e]){var i=r.formulaCacheBlocks[e]=r.formulaCacheBlocks[e]||[],o=0,s=Array.isArray(n.data.blocks)?n.data.blocks.filter((function(e){return e.block_token===t})):[n.data.blocks[t]];s.forEach((function(t){o+=t.gzip_datatable.length,r.sheetFormulaCache[e].delete(t.block_token),i.push((0,f.ecX)(t.gzip_datatable))})),o&&f.Ps3.collectSuiteEvent("client_sheet_path_tracker_dev",{trace_code:f.Y6H.ungzipFormulaCache,length:o});var a=!1;0===r.sheetFormulaCache[e].size&&(delete r.sheetFormulaCache[e],a=!0);var c,u=0===Object.keys(r.sheetFormulaCache).length;if(a)null===(c=r.params)||void 0===c||c.callback.onFormulaBlockLoaded(e,i,u),delete r.formulaCacheBlocks[e];u&&(r.fetchAllFormulaCacheTime=Date.now(),f.Ps3.moirae.teaLog({key:"sheet_formula_cache_request_duration_dev",duration:r.fetchAllFormulaCacheTime-r.fetchStartTime,is_shortcut:(0,f.pPK)().toString()}))}},this.fetchSubBlocks=function(e){if(r.params){var t;f.NVo.instance.onFetchSubBlocks(e);var n=Ae(),i=r.params,o=i.fetchSubBlocks,s=i.callback,a=i.requestor,c=i.schema_version,u=i.requestSubBlocksTimeout,l=r.getPreloadKeys(),h=e.length&&Object.keys(l).find((function(t){return e.every((function(e){return l[t].has(e)}))}));if(h){var d=r.getPreloadData(h);return r.hasCollectedPreloadSuccessEvent||(f.Ps3.moirae.teaLog({key:"client_sheet_path_tracker_dev",trace_code:f.Y6H.preloadSubBlockSuccessed}),r.hasCollectedPreloadSuccessEvent=!0),d.promise.catch((function(){return f.Ps3.preloadHttp.delData(h),r.fetchSubBlocks(e)}))}return a.retryable(o,{max:3,interval:1e3,factor:2,shouldRetry:function(e){return t=wt(e,n),r.shouldRetry(e)},onRetry:function(e,t){s.onRetry(e)}})(r.params.token,e,{requestId:n,schema_version:c,requestSubBlocksTimeout:u}).then((function(e){e.code;return e.payload})).catch((function(e){var n,i=e.code,o=e.payload;ht().isCancel(o)||r.isDisposed||(f.NVo.instance.onFetchSubBlocksError(e),null===(n=r.runner)||void 0===n||n.stop(),s.onRowDataError({code:i,payload:o,customErrorInfo:t}))}))}},this.shouldRetry=function(e){var t,n;return!(null===(t=r.params)||void 0===t||!t.shouldRetry)&&(!r.isDisposed&&(e instanceof Error&&!ht().isCancel(e)?n=e.message:(!e||e.code&&0!==e.code)&&(n=e||""),void 0!==n))},this.onTaskDone=function(e,t){if(console.info("[SHEET LOG] === onTaskDone start block token: ".concat(e)),f.Ps3.moirae.teaLog({key:"client_sheet_block_handle_info_dev",block_type:f.vgr.HANDLE_BLOCK_DATA,stage:"onTaskDone",subblockToken:e}),!r.isDisposed&&r.params){var n=r.params.callback.errorHandler;try{if(t&&t.data&&t.data.blocks){var i=Array.isArray(t.data.blocks)?t.data.blocks.find((function(t){return t.block_token===e})):{block_token:e,gzip_datatable:t.data.blocks[e]};i?r.handleBlockData(i):(console.info("[SHEET LOG] === onTaskDone none block token: ".concat(e)),f.Ps3.moirae.teaLog({key:"client_sheet_block_handle_info_dev",block_type:f.vgr.INVALID_BLOCK_TOKEN,stage:"onTaskDone",subblockToken:e}))}else f.Ps3.moirae.teaLog({key:"client_sheet_block_handle_info_dev",block_type:f.vgr.INVALID_BLOCK_DATA,stage:"onTaskDone"}),console.info("[SHEET LOG] handle sub_block: no block data; BlockDataErrorType.INVALID_BLOCK_DATA; block token: ".concat(e))}catch(t){return f.NVo.instance.onTaskDoneError(t),n(t,"handle block data error",f.vgr.HANDLE_BLOCK_DATA,e)}}},this.getRowDataFromBlock=function(e,t){var r={},n=e.gzip_datatable.length;n&&f.Ps3.collectSuiteEvent("client_sheet_path_tracker_dev",{trace_code:f.Y6H.ungzipBlock,length:n}),console.info("[SHEET LOG] === getRowDataFromBlock blockDataLength: ".concat(n)),f.Ps3.moirae.teaLog({key:"client_sheet_block_handle_info_dev",block_type:f.vgr.HANDLE_BLOCK_DATA,stage:"getRowDataFromBlock"});var i=(0,f.Bep)((0,f.ecX)(e.gzip_datatable),t);return e.dataTable=i,Object.assign(r,i),r},this.onActiveSheetChanged=function(e){r.activeSheetId=e},this.params=t,this.activeSheetId=this.params.activeSheetId||"";try{this.init()}catch(e){console.error("BlockDataManager init error",e),f.NVo.instance.onInitError(e)}}var t;return(0,c.Z)(e,[{key:"init",value:function(){var e=this;this.initBlockRelations(),this.initActiveSheetId(),this.countBlocksNeededForLoaded(),this.initParallelTaskRunner(),this.initDataChannel(),this.waitForNoBlockSheetsReady=Promise.resolve().then((function(){e.triggerNoBlockSheetsReady()}))}},{key:"triggerNoBlockSheetsReady",value:function(){var e=this;this.noBlockSheets.forEach((function(t){var r;null===(r=e.params)||void 0===r||r.callback.onSheetLoaded(t,t===e.activeSheetId,0),e.channel.forceSheetLoaded(t)})),this.noBlockSheets.clear()}},{key:"getChannel",value:function(){return this.channel}},{key:"fetch",value:(t=(0,C.Z)(b().mark((function e(){var t,r,n;return b().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(null===(t=this.runner)||void 0===t||!t.isAllTasksDone()){e.next=7;break}if(!this.waitForNoBlockSheetsReady){e.next=5;break}return e.next=4,this.waitForNoBlockSheetsReady;case 4:this.waitForNoBlockSheetsReady=void 0;case 5:return!this.channel.isSpreadLoaded&&(null===(n=this.params)||void 0===n||n.callback.onSpreadLoaded()),e.abrupt("return");case 7:null===(r=this.runner)||void 0===r||r.start();case 8:case"end":return e.stop()}}),e,this)}))),function(){return t.apply(this,arguments)})},{key:"setSnapshot",value:function(e){this.params&&(this.params.snapshot=e)}},{key:"initActiveSheetId",value:function(){var e=this.activeSheetId||(0,f.eYO)("sheet");e===this.activeSheetId||(0,g.default)(this.sheetBlocks[e])||(this.activeSheetId=e)}},{key:"initDataChannel",value:function(){var e=this;this.runner&&(this.channel=new mt(this.sheetDependences,this.runner,this.getBackRefBlockTokens,(function(t){var r;return null===(r=e.params)||void 0===r?void 0:r.callback.onSheetLoaded(t,t===e.activeSheetId,Object.keys(e.sheetBlocks[t]||{}).length)}),(function(){var t;return null===(t=e.params)||void 0===t?void 0:t.callback.onSpreadLoaded()})))}},{key:"initBlockRelations",value:function(){if(this.params){var e=this.params.snapshot,t=e.sheets,r=e.extra;this.initSheetBlock(t),this.initDependency(Object.values(t),r&&r.reference),f.NVo.instance.onInitBlock(this.sheetBlocks,this.blockRelationMap,this.sheetDependences)}}},{key:"initParallelTaskRunner",value:function(){if(this.params){var e,t,r,n=new pt(Object.values(this.getPreloadKeys()),this.fetchSubBlocks);if(this.runner=new _t(this.blockRelationMap,n,this.params.taskMode,this.params.parallelNum,this.params.limitPerSecond),window.taskRunner=this.runner,0===Object.keys(this.sheetFormulaCache).length)null===(e=this.params)||void 0===e||null===(t=(r=e.callback).handleNoFormulaCache)||void 0===t||t.call(r);for(var i in this.sheetFormulaCache)this.setFormulaCacheTaskForSheet(i);for(var o in this.sheetBlocks)this.setSubBlockTaskForSheet(o);f.NVo.instance.onBlockRequesterStart(),this.fetchStartTime=Date.now(),this.runner.start()}}},{key:"initSheetBlock",value:function(e){var t=this;if(this.params){var r=this.params.sheetIdsToFetch;f.NVo.instance.onInitSheetBlock(r);var n=0,i=[],o=[];Object.values(e).forEach((function(e){var t=e.id,r=e.name;i.push(r),o.push(t)}));var s=[];(r||[]).forEach((function(e){var t=o.indexOf(e);-1!==t&&s.push(i[t])})),i.forEach((function(e){s.includes(e)||s.push(e)}));for(var a=function(i){var o=s[i],a=e[o],c=a.id;if(r&&!r.includes(c))return"continue";t.setFormulaCache(a),a.blocks&&a.blocks.length?(n+=a.blocks.length,a.blocks.forEach((function(e){var r=e.token;t.blockRelationMap[r]||(t.blockRelationMap[r]=c),e.realRowCount=e.rowsCount})),t.sheetBlocks[c]=(0,ut.Z)(a.blocks||[],"token"),t.sheetDependences[c]=new Set((a.blocks||[]).map((function(e){return e.token})))):(t.sheetBlocks[c]={},t.sheetDependences[c]=new Set,t.noBlockSheets.add(c))},c=0;c<s.length;c++)a(c);f.Ps3.moirae.teaLog({key:"client_sheet_block_count",block_count:n})}}},{key:"initDependency",value:function(e,t){var r=this,n=t&&t.dependency||{},i=function(e,t){var r={};return e.forEach((function(e){var n=e.blocks||[],i=[];n.forEach((function(e){for(var r=Math.floor(e.startRowIndex/t),n=Math.floor((e.startRowIndex+e.rowsCount-1)/t),o=r;o<=n;o++)i[o]=i[o]||[],i[o].push(e.token)})),r[e.id]=i})),r}(e,t&&t.size||f.B$J),o={},s=function(e){var t=Tt(i,e);if(null===t)return"continue";var s=(0,ct.Z)(t,2),a=s[0],c=s[1];if(r.sheetRefDependencies[a]=r.sheetRefDependencies[a]||new Set,0===c.length)return"continue";var u,l=St(n[e]);try{for(l.s();!(u=l.n()).done;){var h=u.value,d=Tt(i,h);if(null!==d){var f=(0,ct.Z)(d,2),p=f[0],v=f[1];r.sheetRefDependencies[a].add(p),0!==v.length&&v.forEach((function(e){o[e]=o[e]||new Set,c.forEach((function(t){o[e].add(t)}))}))}}}catch(e){l.e(e)}finally{l.f()}};for(var a in n)s(a);var c,u=(0,ut.Z)(e,"id"),l=St(e);try{var h=function(){var e=c.value,t=e.blocks,r=new Set;if(!t)return"continue";var n=e.dataValidations;n&&Object.values(n).forEach((function(e){var n=e.dependentSheets;if(n){var i,s=St(n);try{for(s.s();!(i=s.n()).done;){var a=i.value;if(!r.has(a)){r.add(a);var c=u[a];if(c){var l=c.blocks;if(l){var h,d=St(t);try{for(d.s();!(h=d.n()).done;){var f,p=h.value.token,v=St(l);try{for(v.s();!(f=v.n()).done;){var g=f.value;o[p]=o[p]||new Set,o[p].add(g.token)}}catch(e){v.e(e)}finally{v.f()}}}catch(e){d.e(e)}finally{d.f()}}}}}}catch(e){s.e(e)}finally{s.f()}}}))};for(l.s();!(c=l.n()).done;)h()}catch(e){l.e(e)}finally{l.f()}var d=function(e){for(var t in r.sheetBlocks[e]){r.getBlockRecursiveRefs(o,t,null).forEach((function(t){return r.sheetDependences[e].add(t)}))}};for(var p in this.sheetBlocks)d(p)}},{key:"setFormulaCache",value:function(e){var t=""!==(0,f.eYO)("no_ssc"),r=Number((0,f.eYO)("formula_cache_version"));isNaN(r)&&(r=null),!t&&e.formulaCache&&e.formulaCache.token!==f.Nfu&&e.formulaCache.version===(r||f.u9N)&&(this.sheetFormulaCache[e.id]=new Set,this.sheetFormulaCache[e.id].add(e.formulaCache.token),this.blockRelationMap[e.formulaCache.token]||(this.blockRelationMap[e.formulaCache.token]=e.id))}},{key:"getBlockRecursiveRefs",value:function(e,t,r){var n=this,i=new Set;return r=r||new Set,!e[t]||r.has(t)||(r.add(t),Array.from(e[t]).filter((function(e){return e!==t})).forEach((function(t){i.add(t),n.getBlockRecursiveRefs(e,t,r).forEach((function(e){return i.add(e)}))}))),i}},{key:"setSubBlockTaskForSheet",value:function(e){var t=this,r=this.sheetBlocks[e];r&&this.runner&&Object.keys(r).forEach((function(r){var n;null===(n=t.runner)||void 0===n||n.add(r,(function(){var n;return null===(n=t.params)||void 0===n||n.callback.onSheetLoading(e),t.fetchSubBlocks([r])}),(function(e){return t.onTaskDone(r,e)}),t.isHighPriorityTask(r)?f.ULn.High:f.ULn.Normal)}))}},{key:"setFormulaCacheTaskForSheet",value:function(e){var t=this,r=this.sheetFormulaCache[e];null!=r&&r.forEach((function(r){var n;null===(n=t.runner)||void 0===n||n.add(r,(function(){return t.fetchSubBlocks([r])}),(function(n){return t.onFirstFormulaCacheTaskDone(e,r,n)}),f.ULn.High,(function(){var n,i,o;null===(n=t.params)||void 0===n||null===(i=(o=n.callback).beforeFetchFormulaBlock)||void 0===i||i.call(o,e,r)}))}))}},{key:"isHighPriorityTask",value:function(e){var t=this,r=!1;return this.sheetRefDependencies[this.activeSheetId]&&(r=Array.from(this.sheetRefDependencies[this.activeSheetId]).some((function(r){return t.sheetDependences[r]&&t.sheetDependences[r].has(e)}))),r||!this.activeSheetId||!this.sheetDependences[this.activeSheetId]||this.sheetDependences[this.activeSheetId].has(e)}},{key:"getPreloadData",value:function(e){return f.Ps3.preloadHttp.getData(e,!1)}},{key:"getPreloadKeys",value:function(){return f.Ps3.preloadHttp.getKeys().reduce((function(e,t){return e[t]=new Set(t.split(",")),e}),{})}},{key:"handleBlockData",value:function(e){var t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],r=e.block_token,n=this.blockRelationMap[r],i=this.sheetBlocks[n];if(console.info("[SHEET LOG] === handleBlockData start sheetId: ".concat(n)),f.Ps3.moirae.teaLog({key:"client_sheet_block_handle_info_dev",block_type:f.vgr.HANDLE_BLOCK_DATA,stage:"handleBlockData",sheetId:n}),i){var o=i[r];if(o){var s,a=o.startRowIndex,c=o.rowsCount,u=this.getRowDataFromBlock(e,a),l=Object.keys(u).length;s=0,Object.keys(i).forEach((function(e){var t=i[e];r===e&&(t.realRowCount=l),s+=t.realRowCount}));var h=a+c;this.handleRowData(n,h,u,r,s,t)}}}},{key:"handleRowData",value:function(e,t,r,n,i){var o,s=this,a=!(arguments.length>5&&void 0!==arguments[5])||arguments[5];console.info("[SHEET LOG] === handleRowData : ".concat(e,"-").concat(n,"-").concat(t,"-").concat(Object.keys(r).length,"-").concat(i)),f.Ps3.moirae.teaLog({key:"client_sheet_block_handle_info_dev",block_type:f.vgr.HANDLE_BLOCK_DATA,stage:"handleRowData",sheetId:e,subblockToken:n}),this.channel.setBlockRowCount(n,Object.keys(r).length),null===(o=this.params)||void 0===o||o.callback.onRowDataLoaded(e,t,r,{token:n,split:a,totalRowCount:i,onRowDataApplied:function(e){return s.channel.onRowDataApplied(n,e)},forceSheetLoaded:function(){return s.channel.forceSheetLoaded(e)}})}},{key:"forceSheetLoaded",value:function(e){this.channel.forceSheetLoaded(e)}},{key:"countBlocksNeededForLoaded",value:function(){if(this.activeSheetId){var e,t,r,n,i,o,s=null!==(e=null===(t=this.sheetDependences[this.activeSheetId])||void 0===t?void 0:t.size)&&void 0!==e?e:0,a=null!==(r=null===(n=this.sheetRefDependencies[this.activeSheetId])||void 0===n?void 0:n.size)&&void 0!==r?r:0,c=null!==(i=null===(o=this.sheetFormulaCache[this.activeSheetId])||void 0===o?void 0:o.size)&&void 0!==i?i:0;f.PxA.collectSpreadEvent("client_sheet_path_tracker_dev",{trace_code:f.Y6H.subBlockCountNeededForUse,length:s+a+c})}}},{key:"reset",value:function(){this.sheetBlocks={},this.blockRelationMap={},this.sheetDependences={}}},{key:"destroy",value:function(){var e;this.isDisposed||(f.NVo.instance.onDestroy(),this.isDisposed=!0,this.noBlockSheets.clear(),delete this.params,null===(e=this.runner)||void 0===e||e.destroy(),delete this.runner)}}]),e}();function Tt(e,t){var r=t.split("_"),n=(0,ct.Z)(r,3),i=n[0],o=n[2],s=-1;try{s=parseInt(o,10)}catch(e){return f.NVo.instance.onParseBlockOffsetError(o),null}var a=e[i];return a?[i,a[s]||[]]:null}Rt([(0,dt.Memoize)()],At.prototype,"getPreloadData",null);var wt=function(e,t){var r;if(e instanceof Error&&!ht().isCancel(e)?r=e.message:(!e||e.code&&0!==e.code)&&(r=e||""),void 0!==r){var n={};return n.requestId=t,n.codeServer=(e||{}).code,n.msgServer=(e||{}).msg,n}},Ot=["config"],It=function(){function e(t,r,n,i){(0,a.Z)(this,e),this.token=t,this.requestor=r,this.fetchSubBlocks=n,this.errorHandler=i,this.blockDataManager=null}return(0,c.Z)(e,[{key:"loadSheetData",value:function(e,t){this.setConfig(t),this.blockDataManager||(this.blockDataManager=this.createBlockDataManager(e,t)),this.blockDataManager.fetch()}},{key:"createBlockDataManager",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},r=(0,at.default)(this.config||{});Object.assign(r,t);var n=e.clientVarsData,i=e.sheetIdsToFetch,o=n.snapshot,s=n.extra_data?n.extra_data.sheet_id:void 0,a=new At(this.createBlockDataParam({snapshot:o,activeSheetId:s,sheetIdsToFetch:i,config:r}));return a}},{key:"createBlockDataParam",value:function(e){var t=e.config,r=(0,Q.Z)(e,Ot);return Object.assign({token:this.token},t,{},r,{fetchSubBlocks:this.fetchSubBlocks,requestor:this.requestor,errorHandler:this.errorHandler})}},{key:"reset",value:function(){this.blockDataManager&&this.blockDataManager.reset()}},{key:"destroy",value:function(){this.blockDataManager&&this.blockDataManager.destroy(),this.callbacks=null,this.requestor=null,this.blockDataManager=null}},{key:"setConfig",value:function(e){this.config?Object.assign(this.config,e):this.config=(0,at.default)(e)}}]),e}(),Dt=function(e,t,r,n){var i,o=arguments.length,s=o<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,r):n;if("object"===("undefined"==typeof Reflect?"undefined":(0,Qe.Z)(Reflect))&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,t,r,n);else for(var a=e.length-1;a>=0;a--)(i=e[a])&&(s=(o<3?i(s):o>3?i(t,r,s):i(t,r))||s);return o>3&&s&&Object.defineProperty(t,r,s),s},Lt=function(){function e(t,r,n){(0,a.Z)(this,e),this._token=t,this.spread=r,this.requestProvider=n,this.splitDataModule=null,this.event=new(d()),this.errorHandler=Y.default,this.requestor={get:this.getRequest,post:this.postRequest,retryable:this.retryable}}var t;return(0,c.Z)(e,[{key:"setSpread",value:function(e){this.spread=e}},{key:"fetchClientVars",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},r=t.requestId,n=t.activeSheetId,i=t.openType,o=f.Ps3.preloadData.getFetchClientVarsReq(e,r,n,i);return o.promise}},{key:"ungzipClientVars",value:function(e,t){var r,n=e.data,i=n.snapshot;if(n.gzip_snapshot||i||t.onError("error","ClientVars Invalid, No GZipSnapshot"),n.gzip_snapshot&&!i&&(i=(0,f.ecX)(n.gzip_snapshot)),n.extra_data&&(n.extra_data.blocks=n.extra_data.blocks||[],r=Xe(n.extra_data.blocks,n.version)),delete n.gzip_snapshot,i&&(n.snapshot=i),r&&n.extra_data){delete n.extra_data.gzip_datatable;try{var o=n.extra_data.sheet_id;if(n.extra_data.row_count=(0,st.Z)(n.extra_data.blocks,(function(e,t){return e+t.row_count}),0),i)Re(o,i).data={dataTable:r}}catch(e){n.extra_data=null,t.onError("clientVarsFail","handle client vars fail")}}return n.version>=f.n0b.CS_GZIP&&(n.changeset_list=J(n.changeset_list)),n}},{key:"loadData",value:function(e,t){var r=t.callback.errorHandler;this.errorHandler=r,this.splitDataModule||(this.splitDataModule=new It(this._token,this.requestor,this.fetchSubBlocks,r)),this.splitDataModule.loadSheetData(e,t)}},{key:"loadSingleSheetData",value:(t=(0,C.Z)(b().mark((function e(t){var r,n,i,o,s=arguments;return b().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=s.length>1&&void 0!==s[1]?s[1]:{},n=t.snapshot){e.next=5;break}throw console.error("sheet snapshot not exist",t),new Error("sheet snapshot not exist");case 5:if(n.id){e.next=8;break}throw console.error("sheet snapshot invalid",t),new Error("sheet snapshot invalid");case 8:return i={snapshot:{sheets:(0,u.Z)({},n.id,n)}},o=new It(this._token,this.requestor,this.fetchSubBlocks,this.errorHandler),console.info("[SHEET LOG] === loadSingleSheetData:",n.id),f.NVo.instance.onLoadSingleSheetData(n.id),e.next=14,o.createBlockDataManager({clientVarsData:i,sheetIdsToFetch:[n.id]},r);case 14:e.sent.fetch();case 16:case"end":return e.stop()}}),e,this)}))),function(e){return t.apply(this,arguments)})},{key:"allowRequestDependSheets",value:function(){return!!this.blockDataChannel}},{key:"loadSheets",value:function(e,t){return this.blockDataChannel?this.blockDataChannel.requestSheets(e,t):Y.default}},{key:"fetchFirstBlock",value:function(e){if(!this.requestor)throw new Error("AXIOS NULL");var t=this.requestProvider.apiUrls.GET_SHEET_HISTORY_FIRST_V2,r=this.requestor.get(t,{baseURL:this.requestProvider.prependAPI("/"),params:e,headers:(0,u.Z)({},U,q)});return{source:r.source,promise:r.promise}}},{key:"fetchSubBlocks",value:function(e,t,r){if(!this.requestor)throw new Error("AXIOS NULL");var n=r.requestId,i=void 0===n?r.requestId||Ae():n,o=r.requestSubBlocksTimeout,s=void 0===o?r.requestSubBlocksTimeout:o,a=r.schema_version,c=Array.isArray(t)?t:[t],l=c.join(","),h={token:e,block_token:l};void 0!==a&&(h.schema_version=a),this.validateBlockRequest(h,c),f.Ps3.performanceStageCollector.updateStage(f.Ps3.sheetRenderStage.FETCH_SHEET_SUB_BLOCK_START,f.Ck$);var d=s,p=this.requestProvider.apiUrls.getSheetSubblocksUrl();return this.requestor.get(p,Object.assign({baseURL:this.requestProvider.prependAPI("/")},d?{timeout:d}:{},{params:h,key:l,once:!f.Ps3.browser.isMobile,headers:(0,u.Z)({"Request-Id":i,"x-request-id":i,"x-tt-trace-id":i},U,Z),readStore:f.Ps3.browser.isMobile})).promise}},{key:"isSheetLoaded",value:function(e){var t=this;return"string"==typeof e?this.checkSheetLoaded(e):e.every((function(e){return t.checkSheetLoaded(e)}))}},{key:"isSheetUnLoaded",value:function(e){var t=this.spread.getSheetFromId(e);return t&&t.loadStatus!==f.Px.LOADED&&!this.isChannelLoadSheet(e)}},{key:"getBackRefBySheetId",value:function(e){return this.splitDataModule&&this.splitDataModule.blockDataManager?this.splitDataModule.blockDataManager.getBackRefBySheetId(e):(f.NVo.instance.onGetBackRefBySheetId(e),[])}},{key:"isDemand",value:function(){return Boolean(this.blockDataChannel&&this.blockDataChannel.getTaskMode()!==f.AXv.runInBackground)}},{key:"onActiveSheetChanged",value:function(e,t){if(this.splitDataModule&&this.splitDataModule.blockDataManager){if(t)if(this.spread.getSheetFromId(e).loadStatus===f.Px.UNLOADED){var r=[e];this.updateSheetsLoadStatus(r),this.loadSheets(r)}this.splitDataModule.blockDataManager.onActiveSheetChanged(e)}}},{key:"reset",value:function(){this.splitDataModule&&this.splitDataModule.reset()}},{key:"destroy",value:function(){this.splitDataModule&&this.splitDataModule.destroy(),this.spread=null,this.requestor=null,this.splitDataModule=null,this.errorHandler=null}},{key:"updateSheetsLoadStatus",value:function(e){for(var t=0;t<e.length;t++){var r=this.spread.getSheetFromId(e[t]);null!==r&&r.loadStatus===f.Px.UNLOADED&&r.markLoading()}}},{key:"on",value:function(e,t){this.event.on(e,t)}},{key:"off",value:function(e,t){this.event.off(e,t)}},{key:"isChannelLoadSheet",value:function(e){return!!this.blockDataChannel&&this.blockDataChannel.isSheetApplied(e)}},{key:"checkSheetLoaded",value:function(e){var t=this.spread.getSheetFromId(e);return t&&t.loadStatus===f.Px.LOADED||this.isChannelLoadSheet(e)}},{key:"retryable",value:function(e,t){return(0,f.RdR)(e,t)}},{key:"getRequest",value:function(e,t){return this.requestProvider.getRequest(e,t)}},{key:"postRequest",value:function(e,t,r){return this.requestProvider.postRequest(e,t,r)}},{key:"validateBlockRequest",value:function(e,t){e.schema_version?t.some((function(e){return/[A..Z]$/.test(e)}))&&f.Ps3.moirae.teaLog({key:"client_sheet_sub_block_token_invalid",schema_version:e.schema_version||0}):t.some((function(e){return/[a..z]$/.test(e)}))&&f.Ps3.moirae.teaLog({key:"client_sheet_sub_block_token_invalid",schema_version:e.schema_version||0})}},{key:"blockDataChannel",get:function(){return this.splitDataModule&&this.splitDataModule.blockDataManager?this.splitDataModule.blockDataManager.getChannel():null}},{key:"token",get:function(){return this._token}}]),e}();Dt([(0,dt.Bind)()],Lt.prototype,"fetchClientVars",null),Dt([(0,dt.Bind)()],Lt.prototype,"fetchFirstBlock",null),Dt([(0,dt.Bind)()],Lt.prototype,"fetchSubBlocks",null),Dt([(0,dt.Bind)()],Lt.prototype,"onActiveSheetChanged",null),Dt([(0,dt.Bind)()],Lt.prototype,"getRequest",null),Dt([(0,dt.Bind)()],Lt.prototype,"postRequest",null),Dt([(0,dt.Bind)()],Lt.prototype,"validateBlockRequest",null);r("vsh_1278");var Mt=r("vsh_22392"),Nt=r("vsh_99520"),Bt=r("vsh_47531"),xt=r("vsh_82905"),Ft=function(e,t,r,n){var i,o=arguments.length,s=o<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,r):n;if("object"===("undefined"==typeof Reflect?"undefined":(0,Qe.Z)(Reflect))&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,t,r,n);else for(var a=e.length-1;a>=0;a--)(i=e[a])&&(s=(o<3?i(s):o>3?i(t,r,s):i(t,r))||s);return o>3&&s&&Object.defineProperty(t,r,s),s},Pt=function(e,t){return function(r,n){t(r,n,e)}},Ut="async-calc",Ht=function(){function e(t,r){(0,a.Z)(this,e),this.reporterService=t,this.configService=r,this.worker=new it,this.worker.setTimeoutOptions({"changeset.protobuf":this.configService.resolve("syncProtobufTimeout",6e4)}),this.worker.setReporterService(this.reporterService)}return(0,c.Z)(e,[{key:"gzip",value:function(e){return this.worker.exec("gzip",e)}},{key:"unGzip",value:function(e){return this.worker.exec("ungzip",e)}},{key:"changesetToProtobuf",value:function(e){return this.worker.exec("changeset.protobuf",e)}},{key:"calcCpuPerformance",value:function(){return this.worker.exec("checkCpuPerformance")}},{key:"destroy",value:function(){this.worker.destroy()}}]),e}();Ft([(0,Mt.P)()],Ht.prototype,"destroy",null),Ht=Ft([(0,Nt.b)(),Pt(0,(0,Bt.f)(xt.zv)),Pt(1,(0,Bt.f)(xt.tb))],Ht);var Vt,Zt=r("vsh_13867"),jt=r("vsh_59800"),Gt="broadcast-channel";!function(e){e.OfflineSync="OfflineSync",e.CompletingBackup="CompletingBackup"}(Vt||(Vt={}));var qt=new jt.BroadcastChannel("sheet.backup.channel"),zt="__MUTEX__",Wt="cross-tab-mutex-storage",$t=function(){function e(){(0,a.Z)(this,e),this.option={retry:!1,duration:50,timeout:5e3},this.lastYKey="",this.loggerService={log:console.log,info:console.info},this.id="".concat(performance.now(),":").concat(1e5*Math.random()|0),this.log("id: ".concat(this.id))}var t,r,n,i,o;return(0,c.Z)(e,[{key:"log",value:function(e){var t;null===(t=this.loggerService)||void 0===t||t.info("CrossTabMutexStorage","mutex_store: ".concat(e," - ").concat(Date.now()))}},{key:"setDeps",value:function(e,t){this.loggerService=e,this.storageService=t}},{key:"lock",value:(o=(0,C.Z)(b().mark((function e(t,r){var n,i,o,s,a,c,u,l=this;return b().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n="".concat(t).concat(zt,"X"),i="".concat(t).concat(zt,"Y"),this.lastYKey=i,o=this.option,s=o.retry,a=o.duration,c=o.timeout,u=function(){var e=(0,C.Z)(b().mark((function e(){return b().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!s){e.next=9;break}return l.log("retry"),e.next=4,(0,ne.sleep)(a);case 4:return e.next=6,l.lock(t,r);case 6:return e.abrupt("return",e.sent);case 9:return e.abrupt("return",null);case 10:case"end":return e.stop()}}),e)})));return function(){return e.apply(this,arguments)}}(),e.prev=5,e.next=8,this.storageService.setItem(n,this.id);case 8:return this.log("set x"),e.next=11,this.getY(i);case 11:if(!e.sent){e.next=16;break}return this.log("has y, return"),e.next=15,u();case 15:return e.abrupt("return",e.sent);case 16:return e.next=18,this.setY(i,c);case 18:return this.log("set y"),e.next=21,this.storageService.getItem(n);case 21:if(e.t0=e.sent,e.t1=this.id,e.t0!==e.t1){e.next=30;break}return this.log("get x correctly, run"),e.next=27,this.criticalSelection(r,i);case 27:return e.abrupt("return",e.sent);case 30:return this.log("get x wrong, wait"),e.next=33,(0,ne.sleep)(a);case 33:return e.next=35,this.getY(i);case 35:if(e.t2=e.sent,e.t3=this.id,e.t2!==e.t3){e.next=44;break}return this.log("get y correctly, run"),e.next=41,this.criticalSelection(r,i);case 41:return e.abrupt("return",e.sent);case 44:if(!s){e.next=48;break}return e.next=47,this.lock(t,r);case 47:return e.abrupt("return",e.sent);case 48:return this.log("return null"),e.next=51,u();case 51:return e.abrupt("return",e.sent);case 54:e.prev=54,e.t4=e.catch(5),console.error(e.t4);case 57:return this.log("return null 2"),e.abrupt("return",null);case 59:case"end":return e.stop()}}),e,this,[[5,54]])}))),function(e,t){return o.apply(this,arguments)})},{key:"criticalSelection",value:(i=(0,C.Z)(b().mark((function e(t,r){var n;return b().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,this.log("criticalSelection"),e.next=4,t();case 4:return n=e.sent,e.abrupt("return",n);case 6:return e.prev=6,this.log("remove y 1"),this.storageService.removeItem(r),e.finish(6);case 10:case"end":return e.stop()}}),e,this,[[0,,6,10]])}))),function(e,t){return i.apply(this,arguments)})},{key:"getY",value:(n=(0,C.Z)(b().mark((function e(t){var r,n,i,o,s;return b().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.storageService.getItem(t);case 2:if(r=e.sent,this.log("get y value"),r){e.next=6;break}return e.abrupt("return",null);case 6:if(this.log("has y value"),n=r.split(/\|/),i=(0,ct.Z)(n,2),o=i[0],s=i[1],!(parseInt(s,10)<Date.now())){e.next=11;break}return this.log("timeout"),e.abrupt("return",null);case 11:return this.log("return id"),e.abrupt("return",o);case 13:case"end":return e.stop()}}),e,this)}))),function(e){return n.apply(this,arguments)})},{key:"setY",value:(r=(0,C.Z)(b().mark((function e(t,r){return b().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.storageService.setItem(t,"".concat(this.id,"|").concat(Date.now()+r));case 2:case"end":return e.stop()}}),e,this)}))),function(e,t){return r.apply(this,arguments)})},{key:"ensureLockYCleared",value:(t=(0,C.Z)(b().mark((function e(){var t,r;return b().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.lastYKey){e.next=2;break}return e.abrupt("return");case 2:t=0;case 3:if(!(t<3)){e.next=19;break}return e.next=6,(0,ne.sleep)(1e3);case 6:return e.next=8,this.storageService.getItem(this.lastYKey);case 8:if(r=e.sent){e.next=13;break}return e.abrupt("return");case 13:if(2!==t||!r){e.next=16;break}return e.next=16,this.storageService.removeItem(this.lastYKey);case 16:t++,e.next=3;break;case 19:case"end":return e.stop()}}),e,this)}))),function(){return t.apply(this,arguments)})},{key:"test",value:function(t){var r=this,n=[];e.instance.option.retry=!0;var i=function(){var i=(0,C.Z)(b().mark((function i(){var o;return b().wrap((function(i){for(;;)switch(i.prev=i.next){case 0:o=0;case 1:if(!(o<t)){i.next=7;break}return i.next=4,e.instance.lock("mutex_test",(0,C.Z)(b().mark((function e(){var t;return b().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,r.storageService.getItem("mutex_index");case 2:if(e.t0=e.sent,e.t0){e.next=5;break}e.t0=0;case 5:return t=e.t0,t+=1,e.next=9,r.storageService.setItem("mutex_index",t);case 9:n.push(t);case 10:case"end":return e.stop()}}),e)}))));case 4:o++,i.next=1;break;case 7:console.log("finish",n);case 8:case"end":return i.stop()}}),i)})));return function(){return i.apply(this,arguments)}}();window.addEventListener("storage",(function(e){"mutex_str"===e.key&&i()})),this.storageService.setItem("mutex_index",0)}}]),e}();$t.instance=new $t;var Kt=r("vsh_75416"),Yt=r.n(Kt),Xt="storage",Jt=function(){function e(){(0,a.Z)(this,e)}return(0,c.Z)(e,null,[{key:"createStorageService",value:function(t){var r=e.instanceMap.get(t);if(r)return r;var n=Yt().createInstance({name:"sheet-forage-v3-".concat(t),driver:[Yt().INDEXEDDB,Yt().LOCALSTORAGE]});return e.instanceMap.set(t,n),n}}]),e}();function Qt(e,t){var r="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!r){if(Array.isArray(e)||(r=function(e,t){if(!e)return;if("string"==typeof e)return er(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);"Object"===r&&e.constructor&&(r=e.constructor.name);if("Map"===r||"Set"===r)return Array.from(e);if("Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r))return er(e,t)}(e))||t&&e&&"number"==typeof e.length){r&&(e=r);var n=0,i=function(){};return{s:i,n:function(){return n>=e.length?{done:!0}:{done:!1,value:e[n++]}},e:function(e){throw e},f:i}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,s=!0,a=!1;return{s:function(){r=r.call(e)},n:function(){var e=r.next();return s=e.done,e},e:function(e){a=!0,o=e},f:function(){try{s||null==r.return||r.return()}finally{if(a)throw o}}}}function er(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,n=new Array(t);r<t;r++)n[r]=e[r];return n}Jt.instanceMap=new Map;var tr,rr,nr,ir=function(e,t,r,n){var i,o=arguments.length,s=o<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,r):n;if("object"===("undefined"==typeof Reflect?"undefined":(0,Qe.Z)(Reflect))&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,t,r,n);else for(var a=e.length-1;a>=0;a--)(i=e[a])&&(s=(o<3?i(s):o>3?i(t,r,s):i(t,r))||s);return o>3&&s&&Object.defineProperty(t,r,s),s},or=function(e,t){return function(r,n){t(r,n,e)}},sr="backup";!function(e){e.Running="running",e.Error="error"}(nr||(nr={}));var ar=function(){function e(t,r,n,i,c,u,l,h,d){var p=this;(0,a.Z)(this,e),this.clientMetaService=t,this.reporterService=r,this.configService=n,this.errorRecorderService=i,this.loggerService=c,this.storageService=u,this.broadcastChannelService=l,this.crossTabMutexStorageService=h,this.storageError={},this.token="",this.userId="",this.isBackingUp$=new f.ps3(!1),this.isConsistency$=new f.ps3(!0),this.saveLocalEnable$=new f.ps3(!0),this.memberId=0,this.init=function(e){var t=p.clientMetaService,r=t.token,n=t.userId,i=t.memberId;p.token!==r&&(p.token=r,p.userId=n,p.memberId=i,p.host=e),p.logDriver()},this.getKey=function(e){return"".concat(e,".").concat(p.token,".").concat(p.userId,".0")},this.validate=function(){var e=p.token,t=p.userId,r=p.memberId;e&&t&&r||(p.reporterService.eventReport({key:"client_sheet_backup_validate_error",user_id:(0,ne.encryptTea)(t),file_id:(0,ne.encryptTea)(p.token)}),p.errorRecorderService.record(xt.FP.Service,xt.NI.ClientError,xt.jK.ERR_BACKUP_INIT_VALIDATE_FAILED,null))},this.broadcastEditableTab=function(e){try{p.validate(),p.broadcastChannelService.postMessage({type:Vt.OfflineSync,data:e})}catch(e){p.onError(e,"offline_edit"),p.onErrorCore(s.Set,e)}},this.setBackupItem=function(){var e=(0,C.Z)(b().mark((function e(t,r,n){var i,o,a,c;return b().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return i="type:".concat(t," transId:").concat(n),e.prev=1,p.loggerService.log("backup","setBackupItem start, ".concat(i)),p.validate(),o=p.getKey(t),e.next=7,p.setItemPretreatment(r);case 7:return a=e.sent,e.next=10,p.storageService.setItem(o,a);case 10:return c=e.sent,p.saveLocalEnable$.value||(p.reporterService.eventReport({key:"client_sheet_save_local_error_resume"}),p.saveLocalEnable$.next(!0)),p.storageError={},p.loggerService.log("backup","setBackupItem end, ".concat(i)),e.abrupt("return",c);case 17:e.prev=17,e.t0=e.catch(1),p.onError(e.t0,"set_item_".concat(p.storageService.driver()),i),p.onErrorCore(s.Set,e.t0);case 21:case"end":return e.stop()}}),e,null,[[1,17]])})));return function(t,r,n){return e.apply(this,arguments)}}(),this.getBackupItem=function(){var e=(0,C.Z)(b().mark((function e(t,r,n){var i,o;return b().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,p.validate(),i=r||p.getKey(t),e.next=5,n||p.storageService.getItem(i);case 5:return o=e.sent,e.next=8,p.getItemPretreatment(o);case 8:return e.abrupt("return",e.sent);case 11:return e.prev=11,e.t0=e.catch(0),p.onError(e.t0,"get_item_".concat(p.storageService.driver())),p.onErrorCore(s.Get,e.t0),e.abrupt("return",null);case 16:case"end":return e.stop()}}),e,null,[[0,11]])})));return function(t,r,n){return e.apply(this,arguments)}}(),this.removeBackupItem=function(){var e=(0,C.Z)(b().mark((function e(t,r,n){var i,o,a;return b().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return i="type:".concat(t," transId:").concat(n),e.prev=1,p.loggerService.log("backup","removeBackupItem start, ".concat(i)),p.validate(),o=r||p.getKey(t),e.next=7,p.storageService.removeItem(o);case 7:return a=e.sent,p.loggerService.log("backup","removeBackupItem end, ".concat(i)),e.abrupt("return",a);case 12:e.prev=12,e.t0=e.catch(1),p.onError(e.t0,"remove_item_".concat(p.storageService.driver()),i),p.onErrorCore(s.Remove,e.t0);case 16:case"end":return e.stop()}}),e,null,[[1,12]])})));return function(t,r,n){return e.apply(this,arguments)}}(),this.getBaseRev=(0,C.Z)(b().mark((function e(){return b().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,p.getBackupItem(o.Rev);case 2:return e.abrupt("return",e.sent);case 3:case"end":return e.stop()}}),e)}))),this.checkBackupRev=function(){var e=(0,C.Z)(b().mark((function e(t){var r,n,i;return b().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,p.getBackupItem(o.Rev);case 2:return r=e.sent,e.next=5,p.getBackupItem(o.Actions,void 0,t?t.actions:void 0);case 5:if(!(n=e.sent)){e.next=11;break}return p.loggerService.log("backup","checkBackupRev LocalBaseRev: ".concat(r," actionRev:").concat(n.baseRev)),e.abrupt("return",n.baseRev||r);case 11:return e.next=13,p.getBackupItem(o.Submit,void 0,t?t.submit:void 0);case 13:if(!(i=e.sent)){e.next=19;break}return p.loggerService.log("backup","checkBackupRev LocalBaseRev: ".concat(r," submittingRev:").concat(i.baseRev)),e.abrupt("return",i.baseRev||r);case 19:return e.abrupt("return",-1);case 20:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),this.checkConsistency=(0,C.Z)(b().mark((function e(){var t,r;return b().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=!0,e.next=3,p.getBackupItem(o.LocalActionMemberId);case 3:if(!(r=e.sent)){e.next=16;break}return e.next=7,p.getBackupItem(o.Actions);case 7:if(!e.sent){e.next=12;break}t=r===p.memberId,e.next=16;break;case 12:return p.reporterService.eventReport({key:"client_sheet_path_tracker_dev",code:f.Y6H.clearMemberId,info:o.Actions}),e.next=15,p.removeMemberId();case 15:t=!0;case 16:return t||(p.loggerService.log("backup","data inconsistency, localActionMemberId:".concat(r," submittingMemberId:").concat(undefined," current memberId:").concat(p.memberId)),p.reporterService.eventReport({key:"client_sheet_eng_inconsistency",type:r?o.LocalActionMemberId:o.SubmittingMemberId}),p.errorRecorderService.record(xt.FP.Service,xt.NI.ClientError,xt.jK.ERR_BACKUP_INCONSISTENT,{isConsistency:t}),p.isConsistency$.next(t)),e.abrupt("return",t);case 18:case"end":return e.stop()}}),e)}))),this.getBackupActions=(0,C.Z)(b().mark((function e(){var t,r,n,i,s;return b().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=[],e.next=3,p.getBackupItem(o.Follow);case 3:return r=e.sent,e.next=6,p.getBackupItem(o.Actions);case 6:return n=e.sent,r&&(i=r.data,t=t.concat(i.content)),n&&(s=n.data,t=t.concat(s)),e.abrupt("return",t);case 10:case"end":return e.stop()}}),e)}))),this.clearBackup=(0,C.Z)(b().mark((function e(){return b().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return p.loggerService.log("backup","clearBackup start"),e.next=3,p.removeBackupItem(o.Submit);case 3:return e.next=5,p.removeBackupItem(o.Follow);case 5:return e.next=7,p.removeBackupItem(o.Actions);case 7:return e.next=9,p.removeBackupItem(o.LocalActionMemberId);case 9:return e.next=11,p.removeBackupItem(o.SubmittingMemberId);case 11:return p.loggerService.log("backup","clearBackup end"),e.abrupt("return",!0);case 13:case"end":return e.stop()}}),e)}))),this.addLocalRecord=function(){var e=(0,C.Z)(b().mark((function e(t){var r;return b().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,p.getLocalRecords();case 2:return(r=e.sent).unshift(t),e.next=6,p.setBackupItem(o.Conflict,r.slice(0,100));case 6:return e.abrupt("return",e.sent);case 7:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),this.getLocalRecords=(0,C.Z)(b().mark((function e(){var t;return b().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,p.getBackupItem(o.Conflict);case 2:return t=e.sent,e.abrupt("return",t||[]);case 4:case"end":return e.stop()}}),e)}))),this.removeLocalRecord=function(){var e=(0,C.Z)(b().mark((function e(t){var r,n;return b().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,p.getLocalRecords();case 2:if(r=e.sent,-1!==(n=r.findIndex((function(e){return e.timestamp===t})))){e.next=6;break}return e.abrupt("return");case 6:return r.splice(n,1),e.next=9,p.setBackupItem(o.Conflict,r);case 9:return e.abrupt("return",e.sent);case 10:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),this.needHandleBackup=function(){var e=(0,C.Z)(b().mark((function e(t){var r,n,i,s,a,c,u;return b().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=(r=t||{}).submit,i=r.actions,e.next=3,Promise.all([p.getBackupItem(o.Submit,void 0,n),p.getBackupItem(o.Actions,void 0,i)]);case 3:return s=e.sent,a=(0,ct.Z)(s,2),c=a[0],u=a[1],p.loggerService.log("backup","check needHandleBackup actions:".concat(lr(u),", submit:").concat(hr(c))),u||p.removeMemberId(),e.abrupt("return",c||u);case 10:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),this.trySetBackupFlagWithLock=function(){var e=(0,C.Z)(b().mark((function e(t){var r;return b().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,p.crossTabMutexStorageService.lock("sheet.mutex",(0,C.Z)(b().mark((function e(){var t;return b().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,p.getBackupItem(o.Backuping);case 2:if(t=e.sent,p.mutexLog("get flag - ".concat(t)),!(t&&Date.now()-parseInt(t.toString(),10)<3e3)){e.next=9;break}return p.mutexLog("get backup lock failed"),e.abrupt("return",!1);case 9:return p.mutexLog("get backup lock success"),e.next=12,p.setBackupItem(o.Backuping,Date.now());case 12:return e.abrupt("return",!0);case 13:case"end":return e.stop()}}),e)}))));case 2:if((r=e.sent)||t){e.next=10;break}return p.mutexLog("double check"),e.next=7,(0,ne.sleep)(3e3);case 7:return e.next=9,p.trySetBackupFlagWithLock(!0);case 9:return e.abrupt("return",e.sent);case 10:return r?p.keepBackingUp():p.crossTabMutexStorageService.ensureLockYCleared(),e.abrupt("return",!!r);case 12:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),this.keepBackingUp=(0,C.Z)(b().mark((function e(){return b().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!p.isBackingUp){e.next=8;break}return p.loggerService.log("backup","keep backing up"),e.next=4,p.setBackupItem(o.Backuping,Date.now());case 4:return e.next=6,(0,ne.sleep)(1e3);case 6:e.next=0;break;case 8:case"end":return e.stop()}}),e)}))),this.completingBackup=(0,C.Z)(b().mark((function e(){var t,r=arguments;return b().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t=!(r.length>0&&void 0!==r[0])||r[0],p.isBackingUp){e.next=3;break}return e.abrupt("return");case 3:return p.isBackingUp$.next(!1),p.loggerService.log("backup","remove backup"),e.next=7,p.removeBackupItem(o.Backuping);case 7:t&&p.broadcastChannelService.postMessage({type:Vt.CompletingBackup});case 8:case"end":return e.stop()}}),e)}))),this.resetMemberId=(0,C.Z)(b().mark((function e(){return b().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,p.setBackupItem(o.LocalActionMemberId,p.memberId);case 2:case"end":return e.stop()}}),e)}))),this.removeMemberId=(0,C.Z)(b().mark((function e(){return b().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",p.removeBackupItem(o.LocalActionMemberId));case 1:case"end":return e.stop()}}),e)}))),this.getStorageService=function(){return{driver:function(){return p.storageService.driver()}}},this.mutexLog=function(e){p.crossTabMutexStorageService.log(e)},this.configService.resolve("backupGzipContentEnable")&&(this.asyncCalcService=d),this.configService.resolve("backupIncognitoSensitive",!0)||(tr=!1)}var t,r,n,i,u,l,h,d,p;return(0,c.Z)(e,[{key:"subscribeBackingUp",value:function(e){return this.isBackingUp$.subscribe(e)}},{key:"subscribeBackupSaveLocalEnable",value:function(e){return this.saveLocalEnable$.subscribe(e)}},{key:"tryCheckIncognito",value:(p=(0,C.Z)(b().mark((function e(){return b().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(void 0===tr){e.next=2;break}return e.abrupt("return",tr);case 2:return e.next=4,new Promise((function(e,t){var r=window.RequestFileSystem||window.webkitRequestFileSystem;if(r)try{r(window.TEMPORARY,100,(function(){return e(!1)}),(function(){return e(!0)}))}catch(t){e(!1)}else t(!1)}));case 4:return tr=e.sent,e.abrupt("return",tr);case 6:case"end":return e.stop()}}),e)}))),function(){return p.apply(this,arguments)})},{key:"setItemPretreatment",value:(d=(0,C.Z)(b().mark((function e(t){var r,n;return b().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=t,!(t&&"object"===(0,Qe.Z)(t)&&(0,Zt.Z)(t.data)&&this.asyncCalcService)){e.next=6;break}return e.next=4,this.asyncCalcService.gzip(t.data);case 4:n=e.sent,r=Object.assign({},t,{data:n});case 6:return e.abrupt("return",r);case 7:case"end":return e.stop()}}),e,this)}))),function(e){return d.apply(this,arguments)})},{key:"getItemPretreatment",value:(h=(0,C.Z)(b().mark((function e(t){var r;return b().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!(t&&"object"===(0,Qe.Z)(t)&&(0,Zt.Z)(t.data)&&this.asyncCalcService)){e.next=5;break}return e.next=3,this.asyncCalcService.unGzip(t.data);case 3:r=e.sent,t.data=r;case 5:return e.abrupt("return",t);case 6:case"end":return e.stop()}}),e,this)}))),function(e){return h.apply(this,arguments)})},{key:"prepareHandlingBackup",value:(l=(0,C.Z)(b().mark((function e(t){var r;return b().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this.isBackingUp$.next(!0),e.next=3,this.getBackupItem(o.Actions,void 0,t?t.actions:void 0);case 3:if(r=e.sent,this.loggerService.log("backup","prepareHandlingBackup reset memberId :".concat(r?this.memberId:null)),!r){e.next=10;break}return e.next=8,this.resetMemberId();case 8:e.next=12;break;case 10:return e.next=12,this.removeMemberId();case 12:case"end":return e.stop()}}),e,this)}))),function(e){return l.apply(this,arguments)})},{key:"onErrorCore",value:(u=(0,C.Z)(b().mark((function e(t,r){var n,i;return b().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n=r.name||"unnamed",!(i="QuotaExceededError"===n)){e.next=5;break}return e.next=5,this.tryClearCacheStorage();case 5:if(!this.host){e.next=11;break}return e.next=8,this.tryCheckIncognito();case 8:tr||(this.storageError[n]=this.storageError[n]?this.storageError[n]+1:1,this.storageError[n]>40&&this.saveLocalEnable$.next(!1),this.handleBackupError(t,r,i)),e.next=12;break;case 11:throw r;case 12:case"end":return e.stop()}}),e,this)}))),function(e,t){return u.apply(this,arguments)})},{key:"handleBackupError",value:function(e,t,r){(this.reportBackupError(e,t),e===s.Set)&&(!this.host||this.host.isOnline()?this.saveLocalEnable$.value&&this.errorRecorderService.record(xt.FP.Service,xt.NI.ClientError,xt.jK.ERR_BACKUP_SAVE_LOCAL_FAILED,{isOnline:!0,isQuotaExceeded:r}):this.errorRecorderService.record(xt.FP.Service,xt.NI.ClientError,xt.jK.ERR_BACKUP_SAVE_LOCAL_FAILED,{isOnline:!1}))}},{key:"reportBackupError",value:function(e,t){this.reporterService.captureException(t,{key:"SHEET_".concat(e,"_BACKUP_EX")})}},{key:"onError",value:(i=(0,C.Z)(b().mark((function e(t,r,n){var i;return b().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return console.error(t,r),this.reporterService.captureException(t,{key:"BACKUP_ON_ERROR"}),this.loggerService.log("backup","onError: ".concat(t.message," from: ").concat(r," ").concat(n||"")),e.next=5,this.tryCheckIncognito();case 5:return e.next=7,this.tryEstimateStorage();case 7:i=e.sent,this.reporterService.eventReport(Object.assign({key:"client_sheet_storage_error",from:r,errorMsg:t.message,errorName:tr?"INCOGNITO":t.name},i));case 9:case"end":return e.stop()}}),e,this)}))),function(e,t,r){return i.apply(this,arguments)})},{key:"tryEstimateStorage",value:(n=(0,C.Z)(b().mark((function e(){var t,r,n,i,o;return b().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t={quota:0,usage:0},!(navigator&&navigator.storage&&navigator.storage.estimate)){e.next=13;break}return e.prev=2,e.next=5,navigator.storage.estimate();case 5:r=e.sent,n=r.quota,i=r.usage,r.usageDetails&&(o=r.usageDetails),t=Object.assign({quota:n,usage:i,caches:r.caches,usageRatio:n?(i||0)/n:0},o),e.next=13;break;case 11:e.prev=11,e.t0=e.catch(2);case 13:return e.abrupt("return",t);case 14:case"end":return e.stop()}}),e,null,[[2,11]])}))),function(){return n.apply(this,arguments)})},{key:"tryClearCacheStorage",value:(r=(0,C.Z)(b().mark((function e(){var t,r,n,i;return b().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(e.prev=0,!rr){e.next=3;break}return e.abrupt("return");case 3:return rr=!0,e.next=6,caches.keys();case 6:t=e.sent,r=Qt(t),e.prev=8,r.s();case 10:if((n=r.n()).done){e.next=16;break}return i=n.value,e.next=14,caches.delete(i);case 14:e.next=10;break;case 16:e.next=21;break;case 18:e.prev=18,e.t0=e.catch(8),r.e(e.t0);case 21:return e.prev=21,r.f(),e.finish(21);case 24:e.next=28;break;case 26:e.prev=26,e.t1=e.catch(0);case 28:case"end":return e.stop()}}),e,null,[[0,26],[8,18,21,24]])}))),function(){return r.apply(this,arguments)})},{key:"logDriver",value:(t=(0,C.Z)(b().mark((function e(){var t;return b().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(e.prev=0,!this.storageService.ready||"function"!=typeof this.storageService.ready){e.next=4;break}return e.next=4,this.storageService.ready();case 4:this.reporterService.eventReport({key:"ccm_sheet_local_driver_dev",driver:(null===(t=this.storageService)||void 0===t?void 0:t.driver())||"unknown"}),e.next=10;break;case 7:e.prev=7,e.t0=e.catch(0),this.reporterService.eventReport({key:"ccm_sheet_local_driver_dev",driver:"error"});case 10:case"end":return e.stop()}}),e,this,[[0,7]])}))),function(){return t.apply(this,arguments)})},{key:"destroy",value:function(){this.loggerService.log("backup","destroy start"),this.isBackingUp$.unsubscribeAll(),this.saveLocalEnable$.unsubscribeAll(),this.isConsistency$.unsubscribeAll(),this.completingBackup(!1),this.loggerService.log("backup","destroy end")}},{key:"getBackupChannelInstance",value:function(){return this.broadcastChannelService}},{key:"isBackingUp",get:function(){return this.isBackingUp$.value}},{key:"isBackupError",get:function(){return!this.saveLocalEnable$.value}},{key:"isConsistency",get:function(){return this.isConsistency$.value}}]),e}();function cr(e){e.bind(Xt).toDynamicValue((function(e){return Jt.createStorageService(e.container.get(xt.UU).userId)})),e.bind(Gt).toConstantValue(qt),e.onActivation(Wt,(function(e,t){var r=e.container.get(xt.QX),n=e.container.get(Xt);return t.setDeps(r,n),t})),e.onDeactivation(Wt,(function(e){e.setDeps({},{})})),e.bind(Wt).toConstantValue($t.instance)}function ur(e,t){return e?"".concat(e.baseRev,"_").concat(e.memberId,"_").concat(t(e.data)):"null"}function lr(e){return ur(e,(function(e){return"".concat(Array.isArray(e)?e.length:null)}))}function hr(e){return ur(e,(function(e){return"".concat(e?Array.isArray(e.content)?e.content.length:0:null)}))}ir([(0,Mt.P)()],ar.prototype,"destroy",null),ar=ir([(0,Nt.b)(),or(0,(0,Bt.f)(xt.UU)),or(1,(0,Bt.f)(xt.zv)),or(2,(0,Bt.f)(xt.tb)),or(3,(0,Bt.f)(xt.Tl)),or(4,(0,Bt.f)(xt.QX)),or(5,(0,Bt.f)(Xt)),or(6,(0,Bt.f)(Gt)),or(7,(0,Bt.f)(Wt)),or(8,(0,Bt.f)(Ut))],ar);var dr,fr="watch-dog",pr="io",vr=r("vsh_93631"),gr=function(e,t,r,n){var i,o=arguments.length,s=o<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,r):n;if("object"===("undefined"==typeof Reflect?"undefined":(0,Qe.Z)(Reflect))&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,t,r,n);else for(var a=e.length-1;a>=0;a--)(i=e[a])&&(s=(o<3?i(s):o>3?i(t,r,s):i(t,r))||s);return o>3&&s&&Object.defineProperty(t,r,s),s};!function(e){e.ACCEPT_COMMIT="ACCEPT_COMMIT",e.LOCAL="local",e.USER_CHANGES="USER_CHANGES",e.NEW_CHANGES="NEW_CHANGES",e.CLEAR="CLEAR"}(dr||(dr={}));var yr,_r="user-changes-state-tracker",kr=function(){function e(){(0,a.Z)(this,e),this.state$=new vr.xQ}return(0,c.Z)(e,[{key:"pushNewState",value:function(e){this.state$.next(e)}},{key:"subscribeStateChange",value:function(e){return this.state$.subscribe(e)}},{key:"destroy",value:function(){this.state$.unsubscribe()}}]),e}();gr([(0,Mt.P)()],kr.prototype,"destroy",null),kr=gr([(0,Nt.b)()],kr);var Er,mr=-1,Sr={count:5,whiteList:new Set([I.USER_CHANGES,I.NEW_CHANGES]),intervalCalculator:(yr={},(0,u.Z)(yr,N.Exception,(function(e,t){return t.resolve("syncRequestErrorRetryTime",Math.min((e+1)*(e<5?1e3:3e3),3e4))})),(0,u.Z)(yr,N.Code1015,(function(e,t){return t.resolve("syncRequestLockFailRetryTime",1e3*Math.pow(e,2))})),(0,u.Z)(yr,N.Code1016,(function(e,t){var r=t.resolve("syncRequestLockFailCacheCalcRetryTime",0);return r?1e3*r:15e3})),yr),getYieldInterval:function(e,t,r){return Sr.intervalCalculator[t]?Sr.intervalCalculator[t](e,r):1e3*Math.pow(e,2)}};!function(e){e[e.Success=0]="Success",e[e.Default=-1]="Default",e[e.TokenChanged=-2]="TokenChanged",e[e.UserStateError=-3]="UserStateError",e[e.UserChangeContentInvalid=-4]="UserChangeContentInvalid",e[e.ServerRetryableError=-5]="ServerRetryableError",e[e.EmptyResponseError=-6]="EmptyResponseError",e[e.ServerRejectError=-7]="ServerRejectError",e[e.ServerError=-8]="ServerError",e[e.ServerErrorAndNoRetry=-9]="ServerErrorAndNoRetry",e[e.ServerErrorAndRetryExceeded=-10]="ServerErrorAndRetryExceeded",e[e.NetworkError=-11]="NetworkError"}(Er||(Er={}));var br,Cr,Rr=new Set([f.D1r.ERR_LOCK_FAILED,f.D1r.ERR_LOCK_FAILED_FOR_CACHE_CALC,f.D1r.STOP_WRITE_FOR_MIGRATE]),Ar=new Set([f.D1r.ERR_FORBIDDEN,f.D1r.ERR_LOGIN_REQUIRE,f.D1r.ERR_NOT_IN_ROOM,f.D1r.ERR_OLD_VERSION,f.D1r.ERROR_PROTECTION_COUNT_LIMIT,f.D1r.ERR_MESSAGE_INVALID,f.D1r.ERR_CHANGESET_EXCEED_LIMIT,f.D1r.ERROR_SHEET_COL_COUNT_OUT,f.D1r.ERR_500,f.D1r.ERROR_PERM_LOCK,f.D1r.ERROR_CELL_STR_LEN_OUT,f.D1r.TENANT_QUOTA_EXCEEDED,f.D1r.FILE_USER_QUOTA_EXCEEDED,f.D1r.FILE_DEPT_QUOTA_EXCEEDED,f.D1r.FILE_SUPER_DOCS_EXCEEDED,f.D1r.ERROR_DOC_SHEET_UPGRADING,f.D1r.ERROR_DOC_SHEET_FORBID_EDITING,f.D1r.STOP_WRITE_FOR_MIGRATE,f.D1r.NO_PERM_BY_LACK_OF_BENEFIT,f.D1r.BLOCK_BY_LACK_OF_BENEFIT]);!function(e){e.IO_WATCH_ACCEPTED="IO_WATCH_ACCEPTED",e.REMOTE_DATA_OVER_SIZE="REMOTE_DATA_OVER_SIZE",e.RESET="RESET",e.RECOVER_PROCESS="RECOVER_PROCESS"}(br||(br={})),function(e){e.FetchMiss="FetchMiss",e.UserChanges="UserChanges",e.Comment="Comment",e.Cursor="Cursor"}(Cr||(Cr={}));var Tr,wr,Or=r("vsh_82898"),Ir=r("vsh_68133"),Dr=r("vsh_60505"),Lr=r.n(Dr),Mr=r("vsh_64299"),Nr=r("vsh_64841"),Br=r("vsh_73043"),xr=function(){function e(t){(0,a.Z)(this,e),this.syncContext=t}return(0,c.Z)(e,[{key:"initSyncBuffer",value:function(){var e=this,t=function(t){t.forEach((function(t){return e.syncContext.processMemberChannelMessage(t)}))},r=function(t){e.syncContext.processNewChanges(t)};this.contentSyncBuffer=(0,Nr.createSyncBuffer)({logger:this.syncContext.logger,checkIfEnable:function(){return e.syncContext.getContentBufferEnable()},onEnterInactive:function(){e.syncContext.io.switchHeartbeatInactive(),e.syncContext.io.setEntityExternalInfo([{entity:{type:e.syncContext.suite,token:e.syncContext.token},inactive:1}])},onEnterActive:function(){e.syncContext.io.switchHeartbeatActive(),e.syncContext.io.setEntityExternalInfo([{entity:{type:e.syncContext.suite,token:e.syncContext.token},inactive:0}]),f.Ps3.Toast.show({key:"reactivate_tab_apply_data",type:"loading",content:Br("common.reactivate_tab_apply_data"),keepAlive:!0})},onSwitchToActiveMode:function(){f.Ps3.Toast.remove("reactivate_tab_apply_data")},handleMessage:r,handleMessageOnActive:r,handleMessageOnReActive:r,getVersionFromMessage:function(e){return{from:e.revision,to:e.revision}},getClientVersion:function(){return e.syncContext.getContentRev()}}),this.membersSyncBuffer=(0,Nr.createSyncBuffer)({logger:this.syncContext.logger,checkIfEnable:function(){return e.syncContext.getMemberBufferEnable()},handleMessage:t,handleMessageOnActive:t,handleMessageOnReActive:t,getVersionFromMessage:function(e){var t=e.version;return{from:t,to:t}},getClientVersion:function(){return e.syncContext.getMemberRev()}},{isFullPipe:!0})}},{key:"pipeContentData",value:function(e){return this.contentSyncBuffer.pipe(e)}},{key:"pipeMemberData",value:function(e){return this.membersSyncBuffer.pipe(e)}},{key:"destroySyncBuffer",value:function(){this.contentSyncBuffer.destroy(),this.membersSyncBuffer.destroy(),f.Ps3.Toast.remove("reactivate_tab_apply_data")}}]),e}(),Fr=function(e,t,r,n){var i,o=arguments.length,s=o<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,r):n;if("object"===("undefined"==typeof Reflect?"undefined":(0,Qe.Z)(Reflect))&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,t,r,n);else for(var a=e.length-1;a>=0;a--)(i=e[a])&&(s=(o<3?i(s):o>3?i(t,r,s):i(t,r))||s);return o>3&&s&&Object.defineProperty(t,r,s),s},Pr=function(e,t){return function(r,n){t(r,n,e)}};!function(e){e.Engine="engine_channel",e.Member="member_channel"}(wr||(wr={}));var Ur,Hr,Vr=function e(t,r,n,i){var o=arguments.length>4&&void 0!==arguments[4]?arguments[4]:{};(0,a.Z)(this,e),this.requestOperation=t,this.transId=r,this.data=n,this.oldData=i,this.options=o,this.sendStartTime=0,this.retryCount=0,this.retryType=N.Exception},Zr="sync",jr=Tr=function(){function e(t,r,n,i,o,s,c,u){var l=this;(0,a.Z)(this,e),this.io=t,this.clientMetaService=r,this.loggerService=n,this.configService=i,this.reporterService=o,this.errorRecorderService=s,this.asyncCalcService=c,this.watchDogService=u,this.changesetsData$=new vr.xQ,this.memberData$=new vr.xQ,this.changedEventData$=new vr.xQ,this.contentDataRev$=new f.ps3(mr),this.memberDataRev$=new f.ps3(mr),this.engineChannelHeartbeatRev$=new f.ps3(mr),this.memberChannelHeartbeatRev$=new f.ps3(mr),this.retryExceededMessage$=new vr.xQ,this.isSuspend=!1,this.suspendNewChangeData=[],this.sendingChangesetId=Tr.DEFAULT_CHANGESET_TRANS_ID,this.changesetSendStateMap=new Map,this.engagementCursorEnable=!0,this.eventTrigger$=new vr.xQ,this.token="",this.syncOption={retryConfig:{interval:15e3,max:Sr.count},channel:ot.ChannelState.socket,apiUrls:{}},this.connectEntity$=new Mr.X(null),this.onChannelStateChange=function(e,t){l.channelState$.value.netState===ot.NetworkState.offline&&e===ot.NetworkState.online&&l.configService.resolve("syncNetworkRecoverSendHBEnable",!0)&&l.forceHeartbeatSync((function(){}),(function(){})),e===ot.NetworkState.online?l.onChannelOnline():l.onChannelOffline(),l.channelState$.next({netState:Gr(e),channel:t})},this.engineChannelHeartBeatsCallback=function(e,t){t!==mr?(e!==l.contentDataRev$.value&&l.logMessage("receive engine channel heartbeat ".concat(e," oldVersion ").concat(t," current version ").concat(l.engineChannelHeartbeatRev$.value," contentVersion ").concat(l.contentDataRev$.value)),l.engineChannelHeartbeatRev$.next(e)):l.logMessage("receive engine channel heartbeat with ".concat(e," but old version is ").concat(t))},this.handleMessageFromServer=function(e){try{if(!ie(e,l.suite))return void l.logMessage("InvalidSheetMsg",e);var t=e.data,r=t.type;switch(l.infoMessage("SheetMsgFromServer ".concat(r),e),t.msg_timestamp&&l.onServerMsgSyncPerf(r,Date.now()-t.msg_timestamp),r){case I.NEW_CHANGES:l.handleNewChanges(t);break;case I.USER_NEWINFO:case I.USER_LEAVE:case I.ROOM_MEMBERS:l.handleMemberChannelMessage(t);break;case I.ENGAGEMENT_CURSOR:l.changedEventData$.next({type:I.ENGAGEMENT_CURSOR,data:t});break;case I.NEW_COMMENT:l.changedEventData$.next({type:I.NEW_COMMENT,data:t});break;case I.ZONE_PERMISSION_CHANGE:l.changedEventData$.next({type:I.ZONE_PERMISSION_CHANGE,data:Object.assign({requestId:e.request_id,logId:e.log_id},t)});break;case I.ISV_RELATIONSHIP:l.changedEventData$.next({type:I.ISV_RELATIONSHIP,data:t});break;case I.IMPORT_RANGE:l.changedEventData$.next({type:I.IMPORT_RANGE,data:t});break;case I.IMPORT_FORMULA:l.changedEventData$.next({type:I.IMPORT_FORMULA,data:t});break;case I.AUTHORIZATION:l.changedEventData$.next({type:I.AUTHORIZATION,data:t});break;case I.ERROR:l.handleError(t,void 0,f.f9g.IO_MESSAGE,e.request_id,e.log_id),l.errorRecorderService.record(xt.FP.Module,xt.NI.ServerError,xt.jK.ERR_SERVER_CONTENT_RESPONSE_ERROR,Object.assign(t,{from:f.f9g.IO_MESSAGE,requestId:e.request_id,logId:e.log_id}));break;case I.OBJ_TITLE_CHANGE:l.handleTitleChange(t);break;case I.AI_FORMULA:l.changedEventData$.next({type:I.AI_FORMULA,data:t});break;case I.AI_REFER_DATA_CHANGE:l.changedEventData$.next({type:I.AI_REFER_DATA_CHANGE,data:t})}}catch(e){l.onHandleMessageFromServerError(e)}},this.sendCursor=(0,vt.default)(this.sendCursorCore,this.configService.resolve("syncSendCursorThrottleTime",1e3)),this.processNewChanges=function(e){l.changesetsData$.next(e),l.onHandleNewChangesEnd(e)},this.processMemberChannelMessage=function(e){l.memberData$.next(e)},this.suite="SPREADSHEET",this.suiteType=ne.NUM_SUITE_TYPE.SHEET,this.initData(),this.initIO(),this.initMessageSyncBuffer()}var t,r,n,i,o,s,l;return(0,c.Z)(e,[{key:"initData",value:function(){this.channelState$=new f.ps3(this.getConnectState())}},{key:"initIO",value:function(){this.io.registerChannelState(this.onChannelStateChange),this.onInitEnd()}},{key:"releaseIO",value:function(){this.connectEntity$.value&&this.io.unRegister(this.connectEntity$.value),this.io.unregisterChannelState(this.onChannelStateChange)}},{key:"initMessageSyncBuffer",value:function(){var e=this;this.messageBuffer=new xr({io:this.io,suite:this.suite,token:this.token,logger:function(t,r){return e.reporterService.eventReport(Object.assign({key:t},r))},getContentRev:function(){return e.contentDataRev$.value},getMemberRev:function(){return e.memberDataRev$.value},getContentBufferEnable:function(){return!!e.configService.resolve("syncContentBufferEnable",!1)},getMemberBufferEnable:function(){return!!e.configService.resolve("syncMemberBufferEnable",!1)},processMemberChannelMessage:function(t){return e.processMemberChannelMessage(t)},processNewChanges:function(t){return e.processNewChanges(t)}}),this.messageBuffer.initSyncBuffer()}},{key:"setHeartbeatRev",value:function(e,t){this.connectEntity$.value&&this.io.setHeartbeatVersion(this.connectEntity$.value,e,t)}},{key:"setMemberChannelRev",value:function(e){var t=this.getChannelVersion(wr.Member);null!==t&&(e===t+1&&this.setHeartbeatRev(wr.Member,e))}},{key:"consumeSuspendContentData",value:function(){var e=this;this.suspendNewChangeData.forEach((function(t){e.handleNewChanges(t)})),this.suspendNewChangeData.length=0}},{key:"handleTitleChange",value:function(e){String(this.getMemberId())!==e.member_id&&this.changedEventData$.next({type:I.OBJ_TITLE_CHANGE,data:e})}},{key:"handleNewChanges",value:function(e){var t=this;if(this.onHandleNewChangesStart(e),e.over_size)return this.logMessage("new change content is over size. rev: ".concat(e.revision)),void this.dispatchEvent(br.REMOTE_DATA_OVER_SIZE,[e.revision]);if(this.isSuspend)this.suspendNewChangeData.push(e);else{var r=e.changeset_list,n=e.edit_time;if(r&&r.length)for(var i=e.version>=M.GZIP,o=function(o,s){var a=r[o];if(i&&a.gzip_content&&(a.content=(0,f.ecX)(a.gzip_content)||[]),Array.isArray(a.content)){if(a.content.length&&a.content[0].action===f.aOo.RECOVER&&String(a.member_id)!==String(t.getMemberId()))return t.dispatchEvent(br.RECOVER_PROCESS,{newRevision:e.revision,recoverRevision:a.content[0].value.revision}),{v:void 0};a.content.forEach((function(e){(0,f.j6Y)(e)&&(e.member_id=a.member_id)}))}a.editTime=n,t.pipeNewChangesToBuffer(a)},s=0,a=r.length;s<a;s++){var c=o(s);if("object"===(0,Qe.Z)(c))return c.v}else this.logMessage("no changesets found. rev: ".concat(e.revision))}}},{key:"pipeNewChangesToBuffer",value:function(e){this.messageBuffer.pipeContentData(e)}},{key:"handleMemberChannelMessage",value:function(e){this.memberDataRev$.next(e.version),this.setMemberChannelRev(e.version),this.messageBuffer.pipeMemberData(e)}},{key:"sendMessageCore",value:(l=(0,C.Z)(b().mark((function e(t){var r,n,i,o,s,a,c,u,l;return b().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=t.data,n=t.retryCount,i=t.transId,o=t.options,s=r.type,r.retryCount=n,a=this.sendRequest(t),c=String(a.reqId),this.onSendMessageStart(t,n,c),e.prev=6,e.next=9,a;case 9:u=e.sent,e.next=29;break;case 12:if(e.prev=12,e.t0=e.catch(6),e.t0 instanceof Error&&(null==o||!o.ignoreSocketError)&&this.onSendMessageCatchError(e.t0),e.t0.code=(e.t0.code||"").toString()||Er.Default,this.onSendMessageFail(i,r,n,e.t0.code),!Ar.has(e.t0.code)){e.next=20;break}return this.onSendMsgSuccServerError(i),e.abrupt("return",Promise.reject({type:this.suite,token:this.token,retryCount:t.retryCount,code:e.t0.code,subCode:Er.UserStateError,transId:i,data:{type:I.ERROR,code:e.t0.code,token:this.token,transId:i,message:e.t0.message||"user state error"}}));case 20:if(Sr.whiteList.has(s)){e.next=23;break}return this.onSendMsgFailNoRetry(i),e.abrupt("return",Promise.reject({type:this.suite,code:e.t0.code,token:this.token,subCode:Er.ServerErrorAndNoRetry,retryCount:t.retryCount,transId:i,data:{type:I.ERROR,code:e.t0.code,token:this.token,transId:i,message:e.t0.message||"request throw error"}}));case 23:if(!this.checkIfRetryExceeded(t,N.Exception,e.t0)){e.next=26;break}return t.retryType=N.Exception,e.abrupt("return",Promise.reject({type:this.suite,code:e.t0.code,token:this.token,subCode:Er.ServerErrorAndRetryExceeded,retryCount:t.retryCount,transId:i,data:{type:I.ERROR,code:e.t0.code,token:this.token,transId:i,message:e.t0.message||"request throw error and retry exceeded"}}));case 26:return this.onSendMsgFailAndRetry(i),t.retryType=N.Exception,e.abrupt("return",this.retrySendMessage(t));case 29:if(null==(l=u.data)&&this.onResponseDataNull(i,s,c),u.retryCount=u.retryCount||n,u.transId=i,Sr.whiteList.has(s)){e.next=36;break}return this.onSendMsgSuccNoRetry(i,c),e.abrupt("return",u);case 36:if(!l||l.type!==I.ERROR||!Rr.has(String(l.code))){e.next=38;break}return e.abrupt("return",this.handleServerRetryableError(t,u,c));case 38:return this.onSendMessageSuccess(i),n>0&&this.retryExceededMessage$.next(N.None),e.abrupt("return",u);case 41:case"end":return e.stop()}}),e,this,[[6,12]])}))),function(e){return l.apply(this,arguments)})},{key:"isRetryFailResponse",value:function(e){var t=e.subCode,r=e.code;return Er.ServerErrorAndRetryExceeded===t||f.D1r.ERROR_HYBRID_RESOURCE===String(r)}},{key:"handleServerRetryableError",value:function(e,t,r){var n=t.data;return this.logMessage("ServerRetryableError code: ".concat(n.code)),String(n.code)===f.D1r.ERR_LOCK_FAILED_FOR_CACHE_CALC?this.checkIfRetryExceeded(e,N.Code1016)?Promise.reject({type:this.suite,code:Er.Success,subCode:Er.ServerErrorAndRetryExceeded,transId:e.transId,data:{subCode:Er.ServerErrorAndRetryExceeded,request_id:r,code:f.D1r.ERR_LOCK_FAILED_FOR_CACHE_CALC,type:I.ERROR}}):(this.onSendMessageLockCacheCalcFailed(e.transId,t.request_id),this.logMessage("sendMessageCoreRsp and retry",t),e.retryType=N.Code1016,this.retrySendMessage(e)):String(n.code)===f.D1r.ERR_LOCK_FAILED?this.checkIfRetryExceeded(e,N.Code1015)?Promise.reject({type:this.suite,code:Er.Success,subCode:Er.ServerErrorAndRetryExceeded,transId:e.transId,data:{subCode:Er.ServerErrorAndRetryExceeded,request_id:r,code:f.D1r.ERR_LOCK_FAILED,type:I.ERROR}}):(this.onSendMessageLockFailed(e.transId,t.request_id),this.logMessage("sendMessageCoreRsp and retry",t),e.retryType=N.Code1015,this.retrySendMessage(e)):String(n.code)===f.D1r.STOP_WRITE_FOR_MIGRATE?this.checkIfRetryExceeded(e,N.STOP_WRITE_FOR_MIGRATE)?Promise.reject({type:this.suite,code:Er.Success,subCode:Er.ServerErrorAndRetryExceeded,transId:e.transId,data:{subCode:Er.ServerErrorAndRetryExceeded,request_id:r,code:f.D1r.STOP_WRITE_FOR_MIGRATE,type:I.ERROR}}):(this.logMessage("sendMessageCoreRsp and retry",t),e.retryType=N.STOP_WRITE_FOR_MIGRATE,this.retrySendMessage(e)):Promise.reject(t)}},{key:"handleAcceptCommit",value:function(e,t){this.onAcceptCommit(e,t),this.logMessage("SheetMsgFromServer ".concat(I.ACCEPT_COMMIT," code:").concat(e.code," newRev: ").concat(e.new_rev," transId: ").concat(e.transId))}},{key:"handleRejectCommit",value:function(e,t){this.onRejectCommit(e,t)}},{key:"getNetworkErrorResponse",value:function(e){var t=e.retryCount,r=e.retryType,n=e.transId;return this.getConnectState().netState===ot.NetworkState.offline?(this.logMessage("retrySendMessage and network is offline. retryCount: ".concat(t,", retryType: ").concat(r," transId: ").concat(n)),{type:this.suite,token:this.token,retryCount:t,code:Er.NetworkError,transId:n,data:{type:I.ERROR,code:Er.NetworkError,token:this.token,transId:n,message:"network offline"}}):null}},{key:"retrySendMessage",value:(s=(0,C.Z)(b().mark((function e(t,r){var n,i,o,s,a,c;return b().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n=t.data,i=t.retryCount,o=t.retryType,s=t.transId,!(a=this.getNetworkErrorResponse(t))){e.next=4;break}return e.abrupt("return",a);case 4:return e.next=6,(0,f.Dc1)(r||Sr.getYieldInterval(i+1,o,this.configService));case 6:if(!(c=this.getNetworkErrorResponse(t))){e.next=9;break}return e.abrupt("return",c);case 9:if(n.token===this.token){e.next=12;break}return this.logMessage("retrySendMessage token changed ".concat(n.token," to ").concat(this.token)),e.abrupt("return",Promise.reject({type:this.suite,data:{code:Er.TokenChanged,type:I.ERROR}}));case 12:return this.logMessage("retrySendMessage retryCount: ".concat(i,", retryType: ").concat(o," transId: ").concat(s)),n.retryType=o,t.retryCount++,e.abrupt("return",this.sendMessageCore(t));case 16:case"end":return e.stop()}}),e,this)}))),function(e,t){return s.apply(this,arguments)})},{key:"checkIfRetryExceeded",value:function(e,t,r){var n,i=e.retryCount,o=e.transId;if(i>=(null===(n=this.syncOption.retryConfig)||void 0===n?void 0:n.max)){this.retryExceededMessage$.next(t);var s=r||{message:"",stack:""},a=s.message,c=s.stack;return this.reporterService.eventReport({key:"client_sheet_sendmessage_retry_exceeded",transId:o,type:t,message:a,stack:c}),!0}return!1}},{key:"sendUserChanges",value:(o=(0,C.Z)(b().mark((function e(t,r){var n,i,o,s,a,c,u,l,h,d,p,v,g=this,y=arguments;return b().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n=y.length>2&&void 0!==y[2]?y[2]:{},i=y.length>3?y[3]:void 0,o=this.token,s=t.base_rev,0===r&&this.reporterService.captureException(new Error("TransId === 0"),{key:"SHEET_TRANS_ID_0",baseRev:s}),t&&t.content&&0!==t.content.length){e.next=8;break}return this.onSendUserChangeInvalid(r,t,s),e.abrupt("return",{code:Er.UserChangeContentInvalid,changeset:t,transId:r});case 8:return this.sendingChangesetId=r,this.onSendUserChangeStart(this.sendingChangesetId,t,s),this.filterInvalidActions(t,r),e.next=13,this.changesetToProtobuf(t,{transId:r,baseRev:s},(function(e){g.onSendUserChangeError(r,e,t),g.errorRecorderService.record(xt.FP.Module,xt.NI.ClientError,f.D1r.ERROR_WORKER_SEND_USER_CHANGE,null)}));case 13:if(a=e.sent){e.next=17;break}return this.errorMessage("changeset to protobuf transform failed"),e.abrupt("return",{code:Er.UserChangeContentInvalid,changeset:t,transId:r});case 17:if(o===this.token){e.next=20;break}return this.onInvalidToken(this.token,o),e.abrupt("return",{code:Er.TokenChanged,changeset:t,transId:r});case 20:return c=Object.assign({},a,{token:o,type:I.USER_CHANGES}),u=new Vr(Cr.UserChanges,r,c,t,n),this.changesetSendStateMap.set(r,u),this.checkHighCSAndSetCallback(u),this.onSendUserChangeProtobuf(r,s,t),e.prev=25,e.next=28,this.sendMessageCore(u);case 28:l=e.sent,e.next=40;break;case 31:if(e.prev=31,e.t0=e.catch(25),this.resetSendingChangesetId(),this.onSendUserChangeFailed(r,t,s),h=e.t0.code,d=e.t0.retryCount,p=e.t0.data,u.onSendError&&u.onSendError({code:h,retryCount:d,message:p.message}),!this.isRetryFailResponse(e.t0)){e.next=39;break}return e.abrupt("return",{code:qr(String(h))?Er.NetworkError:Er.ServerRetryableError,changeset:t,errorResponse:e.t0.data});case 39:return e.abrupt("return",{code:Er.ServerError,changeset:t,errorResponse:e.t0.data});case 40:if(this.resetSendingChangesetId(),l&&l.data){e.next=44;break}return this.logMessage("serverMessage is empty",l),e.abrupt("return",{code:Er.EmptyResponseError,changeset:t,transId:r});case 44:if(u.onSendSuccess&&u.onSendSuccess(l),v=l.data,this.watchDogService.done(r,{hasLocalActions:i,csLength:a.content.length}),v&&v.type===I.ERROR?this.onSendUserChangeLogicFailed(r,s,l.request_id,l.log_id):this.onSendUserChangeSucc(r,t,s),v.transId=r,v.type!==I.ACCEPT_COMMIT){e.next=52;break}return this.handleAcceptCommit(v,t),e.abrupt("return",{code:Er.Success,changeset:t,ackResponse:v});case 52:if(v.type!==I.REJECT_COMMIT){e.next=55;break}return this.handleRejectCommit(v,t),e.abrupt("return",{code:Er.ServerRejectError,changeset:t,rejectResponse:v});case 55:if(v.type!==I.ERROR){e.next=58;break}return this.handleError(v,t,f.f9g.SEND_USER_CS,l.request_id,l.log_id),e.abrupt("return",{code:Er.ServerError,changeset:t,errorResponse:Object.assign(v,{from:f.f9g.SEND_USER_CS})});case 58:return this.onSendUserChangeEnd(r,t,s),e.abrupt("return",{code:Er.Success,changeset:t,ackResponse:v});case 60:case"end":return e.stop()}}),e,this,[[25,31]])}))),function(e,t){return o.apply(this,arguments)})},{key:"dispatchEvent",value:function(e){for(var t=arguments.length,r=new Array(t>1?t-1:0),n=1;n<t;n++)r[n-1]=arguments[n];this.eventTrigger$.next({event:e,data:r})}},{key:"sendRequest",value:function(e){return this.requestWithNewEditApi(e)}},{key:"requestWithNewEditApi",value:function(e){return e.requestOperation===Cr.FetchMiss?this.requestFetchMiss(e):e.requestOperation===Cr.UserChanges?this.requestUserChanges(e):this.request(e)}},{key:"requestFetchMiss",value:function(e){var t=this,r=e.oldData.rev_list,n=Lr().stringify({start_revision:r[0],end_revision:r[r.length-1]+1,token:this.token}),i="".concat(this.syncOption.apiUrls.POST_FETCH_MISS,"?").concat(n),o=Ae(),s=(0,Ir.M)(),a=Tr.generateChangesetSendId(),c=this.syncOption.retryProvider((function(){return t.syncOption.requestProvider.getRequest(i,{headers:{"Content-Type":"application/json","Request-Id":o,"x-request-id":o,"x-tt-trace-id":s}}).promise}),{shouldRetry:function(e,r){return!t.isSuspend&&t.getConnectState().netState===ot.NetworkState.online&&(Rr.has(String(e.code))||String(e.code)===ne.STATUS_CODE.CONNECT_ERROR)},onRetry:function(e,r){t.logMessage("requestFetchMiss onRetry retryCount ".concat(e," retryContext code: ").concat(null==r?void 0:r.code))},max:1})(void 0,void 0,{}).then((function(r){if(r.code!==Er.Success)throw r;var n=r.payload.data.changeset_list;return{code:r.payload.code,type:t.suite,data:{edit_time:r.payload.data.edit_time,changeset_list:n.map((function(e){return{revision:e.revision,gzip_content:e.gzip_action,member_id:String(e.member_id),user_id:e.user_id}})),type:I.NEW_CHANGES,token:e.data.token,member_id:String(t.getMemberId()),code:r.code,msg_timestamp:Date.now(),over_size:0,user_id:Number(t.clientMetaService.userId),version:M.GZIP,revision:n[n.length-1].revision,msg:"success",retry:r.retryTime},transId:e.transId,retryCount:r.retryTime}}));return c.reqId=a,c}},{key:"requestUserChanges",value:function(e){var t=this,r=e.data,n=this.token,i=Lr().stringify({token:n,member_id:this.getMemberId()}),o="".concat(this.syncOption.apiUrls.POST_USER_CHANGES,"?").concat(i),s=Ae(),a=(0,Ir.M)(),c=Tr.generateChangesetSendId(),u={base_rev:r.base_rev,block_infos:r.block_infos,ext_resources:r.ext_resources,command_type:r.command_type,content:r.content,mode:0,msg_timestamp:Date.now(),msg_id:r.msg_id,retryCount:e.retryCount||0};r.property&&(u.property=r.property);var l=this.syncOption.retryProvider((function(){return t.syncOption.requestProvider.postRequest(o,u,{headers:{"Content-Type":"application/json","Request-Id":s,"x-request-id":s,"x-tt-trace-id":a},timeout:zr(r.content.length)}).promise}),{shouldRetry:function(e,t){return e instanceof Error||e.code!==Er.Success},onRetry:function(e,r){t.logMessage("requestUserChanges onRetry retryCount ".concat(e," retryContext code: ").concat(null==r?void 0:r.code))},max:0})(void 0,void 0,{}).then((function(r){if(r.code!==Er.Success)throw r;var i=r.payload.data;if(i.type===I.ACCEPT_COMMIT){var o=i.edit_time;return{code:r.payload.code,type:t.suite,transId:e.transId,token:n,retryCount:r.retryTime,msg:r.payload.msg,data:{editTime:o,code:r.payload.code,type:i.type,new_rev:i.new_rev,block_tokens:i.block_tokens,token:n,transId:e.transId,msg:r.payload.msg}}}return i.type===I.REJECT_COMMIT?{code:r.payload.code,type:t.suite,transId:e.transId,token:n,retryCount:r.retryTime,msg:r.payload.msg,data:{code:r.payload.code,type:i.type,transId:e.transId,token:n,msg:r.payload.msg}}:{code:r.payload.code,type:t.suite,transId:e.transId,token:n,retryCount:r.retryTime,msg:r.payload.msg,data:{type:I.ERROR,code:r.payload.code,message:r.payload.msg,token:n}}})).catch((function(r){var i;if(r instanceof Error)throw r;var o=r.code===xt.jK.ERROR_RETRY_EXCEED?r.payload.code:Number(r.code),s=(r.code===xt.jK.ERROR_RETRY_EXCEED?r.payload instanceof Error?r.payload.message:r.payload.msg:r.msg)||"",a=r instanceof Error?0:r.code===xt.jK.ERROR_RETRY_EXCEED&&(null===(i=r.customErrorInfo)||void 0===i?void 0:i.retryTime)||0;throw{code:o,type:t.suite,transId:e.transId,token:n,retryCount:a,msg:s,data:{type:I.ERROR,code:o,message:s,token:n}}}));return l.reqId=c,l}},{key:"request",value:function(e){var t=e.data,r=e.options;t.msg_timestamp=Date.now();return this.io.request({type:this.suite,data:t},Object.assign({timeout:3e4,timeoutRetry:3,headers:(0,u.Z)({},U,"api.sheet.rce.msg")},r))}},{key:"getRequestOption",value:function(e){var t=this.syncOption.apiUrls.POST_USER_CHANGES,r=Lr().stringify({token:this.clientMetaService.token,member_id:this.clientMetaService.memberId});return Object.assign({url:"".concat(t,"?").concat(r),timeout:3e4,timeoutRetry:3,headers:(0,u.Z)({},U,"api.sheet.user.changes")},e,{channel:ot.ChannelState.http})}},{key:"changesetToProtobuf",value:(i=(0,C.Z)(b().mark((function e(t,r,n){var i,o,s,a;return b().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return i=Date.now(),o=r.transId,s=r.baseRev,e.prev=2,e.next=5,this.asyncCalcService.changesetToProtobuf(t);case 5:return a=e.sent,this.onSendUserChangeProtobufSucc(o,s,{timeCost:Date.now()-i,gzipedTimeCost:a.timeCost,changeset:t}),e.abrupt("return",a);case 10:return e.prev=10,e.t0=e.catch(2),this.onSendUserChangeProtobufFailed(o,s,e.t0),n&&n(e.t0),e.abrupt("return",null);case 15:case"end":return e.stop()}}),e,this,[[2,10]])}))),function(e,t,r){return i.apply(this,arguments)})},{key:"checkHighCSAndSetCallback",value:function(e){var t=this,r=e.oldData,n=e.transId;r.content&&r.content.filter((function(e){return(0,f.A$_)(e.action)})).length>0&&(this.logMessage("SheetHighPriorityAction Found",r),e.onSendSuccess=function(e){e&&e.data&&(e.data.new_rev&&(0,f.ji5)("info","HighPriorityCSSended: newRev=".concat(e.data.new_rev," Retry=").concat(e.retryCount||0)),t.onHighCSSucc(e),t.changesetSendStateMap.delete(n))},e.onSendError=function(r){r&&(t.onHighCSFail(r),e.retryCount=Math.max(e.retryCount,r.retryCount),t.errorMessage("HighPriorityActionFailed: Code=".concat(r.code||""," Message=").concat(r.message," Retry=").concat(r.retryCount)))})}},{key:"filterInvalidActions",value:function(e,t){if(e&&e.content&&e.content.length){var r=e.content.length;e.content=e.content.filter((function(e){return e.action!==f.aOo.TID_SPLIT})),e.content.length!==r&&(this.logMessage("filterInvalidActions ".concat(r," -> ").concat(e.content.length," transId: ").concat(t," ")),this.reporterService.eventReport({key:"client_sheet_filter_invalid_actions",transId:t,actions:f.aOo.TID_SPLIT}))}else this.logMessage("filterInvalidActions cs empty: ".concat(!e||!e.content," empty transId: ").concat(t))}},{key:"sendCursorCore",value:(n=(0,C.Z)(b().mark((function e(t){var r;return b().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.configService.resolve("syncEngagementCursorEnable",!0)){e.next=2;break}return e.abrupt("return");case 2:if(this.getConnectState().netState===ot.NetworkState.online){e.next=4;break}return e.abrupt("return");case 4:if(this.engagementCursorEnable){e.next=6;break}return e.abrupt("return");case 6:return e.prev=6,r={cursor_info:t,type:I.ENGAGEMENT_CURSOR,token:this.token},e.next=10,this.sendMessageCore(new Vr(Cr.Cursor,f.Hg0.genStepTid(),r,t,{ignoreSocketError:!0}));case 10:e.next=15;break;case 12:e.prev=12,e.t0=e.catch(6),this.logMessage("send cursor failed",e.t0);case 15:case"end":return e.stop()}}),e,this,[[6,12]])}))),function(e){return n.apply(this,arguments)})},{key:"handleError",value:function(e,t,r,n,i){this.onErrorCommit(e,t,n,i),String(e.code)===f.D1r.ERROR_PERM_LOCK&&this.resetSendingChangesetId()}},{key:"resetSendingChangesetId",value:function(){this.sendingChangesetId=Tr.DEFAULT_CHANGESET_TRANS_ID}},{key:"getConnectState",value:function(){return{netState:Gr(this.io.netState),channel:this.io.channel}}},{key:"getEngineChannelHeartbeatRev",value:function(){return this.engineChannelHeartbeatRev$.value}},{key:"connectIO",value:function(e){var t=this;this.onConnectIOStart(e);var r=this.registerHeartbeats(e);this.io.watch(r).then((function(){return t.onConnectIOEnd(e)})),this.connectEntity$.next(r)}},{key:"submitChangeset",value:(r=(0,C.Z)(b().mark((function e(t,r,n){var i,o;return b().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return i=t.base_rev,this.onSubmitChangesetStart(r,t,i),e.next=4,this.sendUserChanges(t,r,void 0,n);case 4:return o=e.sent,this.onSubmitChangesetEnd(r,t,i),e.abrupt("return",o);case 7:case"end":return e.stop()}}),e,this)}))),function(e,t,n){return r.apply(this,arguments)})},{key:"getSendingEnable",value:function(){return this.getConnectState().netState===ot.NetworkState.online&&!this.hasChangesetSending()}},{key:"hasChangesetSending",value:function(){return this.sendingChangesetId!==Tr.DEFAULT_CHANGESET_TRANS_ID}},{key:"resendChangeset",value:(t=(0,C.Z)(b().mark((function e(t,r,n){var i;return b().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(i=this.hasChangesetSending(),this.onTriggerChangeset(t,i),i){e.next=4;break}return e.abrupt("return",this.submitChangeset(t,r,n));case 4:return e.abrupt("return",null);case 5:case"end":return e.stop()}}),e,this)}))),function(e,r,n){return t.apply(this,arguments)})},{key:"sendMissRevMessage",value:function(e,t){var r={rev_list:e,version:M.GZIP},n=Object.assign({},r,{type:I.NEW_CHANGES,token:this.token}),i=new Vr(Cr.FetchMiss,t,n,r,{channel:ot.ChannelState.http});return this.sendMessageCore(i)}},{key:"subscribeChangesetsMessage",value:function(e){return this.changesetsData$.subscribe(e)}},{key:"subscribeMemberMessage",value:function(e){return this.memberData$.subscribe(e)}},{key:"subscribeChangedEventDataMessage",value:function(e){return this.changedEventData$.subscribe(e)}},{key:"subscribeExtractChangedEventDataMessage",value:function(e,t){return this.changedEventData$.subscribe((function(r){e===r.type&&t(r.data)}))}},{key:"subscribeChannelState",value:function(e){return this.channelState$.subscribe(e)}},{key:"subscribeRetryExceededMessage",value:function(e){return this.retryExceededMessage$.subscribe(e)}},{key:"subscribeEvent",value:function(e,t){return this.eventTrigger$.subscribe((function(r){e===r.event&&t.call.apply(t,[null].concat((0,p.Z)(r.data)))}))}},{key:"subscribeEngagementCursorData",value:function(e){return this.subscribeExtractChangedEventDataMessage(I.ENGAGEMENT_CURSOR,e)}},{key:"subscribeEngineChannelHeartbeat",value:function(e){return this.engineChannelHeartbeatRev$.subscribe(e)}},{key:"forceHeartbeatSync",value:function(e,t){this.io.counter+=1,this.io.sendHeartbeats(e,t)}},{key:"getStatus",value:function(){if(-1!==this.sendingChangesetId){var e=this.changesetSendStateMap.get(this.sendingChangesetId);if(e)return{csRetryCount:e.retryCount,memberId:this.getMemberId(),sendingChangeset:e.data}}return{sendingChangeset:null,csRetryCount:0,memberId:this.getMemberId()}}},{key:"reset",value:function(e){this.onResetStart(e),this.channelState$.next(this.getConnectState()),this.releaseIO(),this.resetSendingChangesetId(),this.suspend(e),this.suspendNewChangeData.length=0,this.changesetSendStateMap.clear(),this.setEngagementCursorEnable(!1),this.onResetEnd()}},{key:"setContentVersion",value:function(e){this.contentDataRev$.next(e),this.setHeartbeatRev(wr.Engine,e)}},{key:"setSyncOptions",value:function(e){this.syncOption=(0,Or.Z)(this.syncOption,e)}},{key:"setToken",value:function(e){this.token=e,this.logMessage("setToken: ".concat((0,ne.encryptTea)(e)))}},{key:"addHeartbeat",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},r={type:this.suite,token:this.token};this.io.addHeartbeat(r,e,Object.assign({},t))}},{key:"removeHeartbeat",value:function(e){var t={type:this.suite,token:this.token};this.io.removeHeartbeat(t,e)}},{key:"sendCommentChange",value:function(e){return this.sendMessageCore(new Vr(Cr.Comment,f.Hg0.genSpecTid(f.$UQ.SEND_COMMENT_CHANGE),Object.assign({},e,{type:I.USER_COMMENT,token:this.token}),e))}},{key:"suspend",value:function(e){this.isSuspend=!0,this.logMessage("suspend transId: ".concat(e))}},{key:"resume",value:function(e){this.isSuspend&&(this.isSuspend=!1,this.logMessage("resume transId: ".concat(e)),this.consumeSuspendContentData())}},{key:"getEntity",value:function(){return this.connectEntity$.value}},{key:"getEntityObservable",value:function(){return this.connectEntity$.asObservable()}},{key:"getMemberId",value:function(){return this.io.getMemberId()}},{key:"setEngagementCursorEnable",value:function(e){this.engagementCursorEnable=e}},{key:"processRemoteMessage",value:function(e){return this.handleMessageFromServer(e)}},{key:"processRemoteMemberMessage",value:function(e){return this.handleMessageFromServer(e)}},{key:"getChannelVersion",value:function(e){var t=(this.io.getHeartbeatInfo(this.suite,this.token)||{})[e];return t?t.version:null}},{key:"destroy",value:function(){var e,t;this.releaseIO(),this.changesetsData$.unsubscribe(),this.memberData$.unsubscribe(),this.changedEventData$.unsubscribe(),this.channelState$.unsubscribeAll(),this.contentDataRev$.unsubscribeAll(),this.memberDataRev$.unsubscribeAll(),this.engineChannelHeartbeatRev$.unsubscribeAll(),this.memberChannelHeartbeatRev$.unsubscribeAll(),this.retryExceededMessage$.unsubscribe(),this.eventTrigger$.unsubscribe(),this.suspendNewChangeData.length=0,this.changesetSendStateMap.clear(),this.messageBuffer.destroySyncBuffer(),this.connectEntity$.unsubscribe(),this.onConnectRelease(),null===(e=(t=this.sendCursor).cancel)||void 0===e||e.call(t)}},{key:"onChannelOnline",value:function(){}},{key:"getEntityToken",value:function(){return this.token}},{key:"getCollaborativeMessageFilter",value:function(e){return e}},{key:"onChannelOffline",value:function(){}},{key:"onServerMsgSyncPerf",value:function(e,t){t>0&&t<=6e4&&10*Math.random()<=2&&this.reporterService.eventReport({key:"client_sheet_message_sync_cost",message_type:e,cost_time:t})}},{key:"onHandleNewChangesStart",value:function(e){var t,r=(null===(t=e.changeset_list)||void 0===t?void 0:t.length)||0,n=e.revision||0;this.logMessage("handle new changeset start: ".concat(n-r+1," - ").concat(n),e)}},{key:"onHandleNewChangesEnd",value:function(e){this.logMessage("handle new content data end: ".concat(e.length?e[0].revision:"empty"," "),e)}},{key:"onHandleMessageFromServerError",value:function(e){this.reporterService.captureException(e,{key:"HANDLE_SERVER_MESSAGE_EX"}),this.reporterService.eventReport({key:"client_sheet_handle_server_message_error"})}},{key:"onConnectIOStart",value:function(e){this.logMessage("onConnectIOStart")}},{key:"onConnectIOEnd",value:function(e){this.logMessage("onConnectIOEnd"),this.reporterService.eventReport({key:"client_sheet_sync_connect"})}},{key:"onConnectRelease",value:function(){this.logMessage("onConnectRelease"),this.reporterService.eventReport({key:"client_sheet_sync_disconnect"})}},{key:"logMessage",value:function(e,t,r){this.loggerService.log("sync",e,t,r)}},{key:"errorMessage",value:function(e,t,r){this.loggerService.error("sync",e,t,r)}},{key:"infoMessage",value:function(e,t){this.loggerService.info("sync",e,t)}},{key:"getPermissionHBOption",value:function(){return null}},{key:"registerHeartbeats",value:function(e){var t=this,r={type:this.suite,token:this.getEntityToken()},n=Object.assign({},this.getPermissionHBOption());return this.configService.resolve("syncMemberChannelEnable",!1)&&(n.member_channel={interval:1,callback:function(e,r){e<=t.memberChannelHeartbeatRev$.value||!t.configService.resolve("syncShowCollaboratorUserInfo",!0)||t.configService.resolve("syncMemberChannelEnable",!1)&&t.memberChannelHeartbeatRev$.next(e)}}),this.configService.resolve("syncEngineChannelEnable",!0)&&(n.engine_channel={interval:1,version:e,callback:this.engineChannelHeartBeatsCallback}),this.io.register(r,{message:{handler:this.handleMessageFromServer,filter:this.getCollaborativeMessageFilter(r)},heartbeats:n,acceptWatchHandler:function(e){t.configService.resolve("syncMemberChannelEnable",!1)&&t.dispatchEvent(br.IO_WATCH_ACCEPTED)},isNewHeartbeatsProtocol:!0}),r}},{key:"onSendMsgFailAndRetry",value:function(e){e&&this.reporterService.eventReport({key:"client_sheet_sendmessage_fail_and_retry",transId:e})}},{key:"onSendMsgSuccServerError",value:function(e){e&&this.reporterService.eventReport({key:"client_sheet_sendmessage_succ_server_error",transId:e})}},{key:"onSendMsgFailNoRetry",value:function(e){e&&this.reporterService.eventReport({key:"client_sheet_sendmessage_fail_no_retry",transId:e})}},{key:"onSendMsgSuccNoRetry",value:function(e,t){e&&this.reporterService.eventReport({key:"client_sheet_sendmessage_succ_no_retry",transId:e,requestId:t||""})}},{key:"onSendMessageLockFailed",value:function(e,t,r){e&&this.reporterService.eventReport({key:"client_sheet_sendmessage_fail_1015",transId:e,requestId:t||"",logId:r||""})}},{key:"onSendMessageLockCacheCalcFailed",value:function(e,t){e&&this.reporterService.eventReport({key:"client_sheet_sendmessage_fail_1016",transId:e,requestId:t||""})}},{key:"onSubmitChangesetStart",value:function(e,t,r){e&&this.reporterService.eventReport({key:"client_sheet_sync_submit_cs",csLength:t.content.length,baseRev:t.base_rev,msg_id:t.msg_id,cs_time:Date.now(),transId:e,networkState:this.getConnectState().netState})}},{key:"onSubmitChangesetEnd",value:function(e,t,r){e&&this.reporterService.eventReport({key:"client_sheet_sync_submit_cs_fin",transId:e,csLength:t.content.length,baseRev:t.base_rev,msg_id:t.msg_id,cs_time:Date.now(),networkState:this.getConnectState().netState})}},{key:"onSendUserChangeStart",value:function(e,t,r){e&&this.reporterService.eventReport({key:"client_sheet_sends_user_change",transId:e,baseRev:r,msg_id:t.msg_id,networkState:this.getConnectState().netState})}},{key:"onSendUserChangeEnd",value:function(e,t,r){e&&this.reporterService.eventReport({key:"client_sheet_sends_user_change_fin",transId:e,baseRev:r,msg_id:t.msg_id,networkState:this.getConnectState().netState})}},{key:"onSendUserChangeFailed",value:function(e,t,r){this.reporterService.eventReport({key:"client_sheet_send_user_cs_failed",transId:e,baseRev:r,msg_id:t.msg_id})}},{key:"onSendUserChangeSucc",value:function(e,t,r){this.reporterService.eventReport({key:"client_sheet_send_user_cs_succ",transId:e,baseRev:r,msg_id:t.msg_id})}},{key:"onSendUserChangeInvalid",value:function(e,t,r){this.loggerService.error("sheet sync","Error! Changeset Content NULL ".concat(e," ").concat(JSON.stringify(t))),this.reporterService.eventReport({key:"client_sheet_assets_fail",assets_value:"CS_NULL"})}},{key:"onSendUserChangeProtobuf",value:function(e,t,r){e&&this.reporterService.eventReport({key:"client_file_edit",file_type:"sheet",file_id:f.Ps3.encryptTea(this.token),transId:e,baseRev:t,msg_id:r.msg_id})}},{key:"onSendUserChangeError",value:function(e,t,r){e&&this.reporterService.eventReport({key:"client_sheet_send_user_change_error",transId:e,msg:t?t.message:"",stack:t?t.stack:"",msg_id:r.msg_id,baseRev:r.base_rev})}},{key:"onTriggerChangeset",value:function(e,t){this.reporterService.eventReport({key:"client_sheet_trigger_sending_changset",token:(0,ne.encryptTea)(this.token)||"",baseRevision:e.base_rev,hasSendingCS:t})}},{key:"onSendUserChangeProtobufSucc",value:function(e,t,r){this.reporterService.eventReport({key:"client_sheet_worker_succ",transId:e,baseRev:t,time_cost:r.timeCost,gzip_time_cost:r.gzipedTimeCost,submittingChangesetLength:Math.floor(r.changeset.content.length/5e3)})}},{key:"onSendUserChangeProtobufFailed",value:function(e,t,r){this.reporterService.captureException(r,{key:"USER_CHANGE_PROTOCOL_FAILED"}),this.reporterService.eventReport({key:"client_sheet_worker_failed",msg:r.message,transId:e,baseRev:t})}},{key:"onSendMessageStart",value:function(e,t,r){if(e.requestOperation!==Cr.Cursor){var n=e.transId,i=e.data.type;e.sendStartTime=Date.now();var o=e.requestOperation===Cr.FetchMiss?e.oldData.rev_list:e.requestOperation===Cr.UserChanges?e.oldData.base_rev:null;this.logMessage("onSendMessageStart transId:".concat(n," requestOperation=").concat(e.requestOperation," type:").concat(i," messageData:").concat(JSON.stringify(o)," ioRequestId:").concat(r),e),this.reporterService.eventReport({key:"client_sheet_sendmessage_start",network:this.getConnectState().netState,type:i,retryCount:t,transId:n})}}},{key:"onSendMessageFail",value:function(e,t,r,n){e&&this.reporterService.eventReport({key:"client_sheet_sendmessage_fail",network:this.getConnectState().netState,token:(0,ne.encryptTea)(this.token)||"",type:t.type,length:t.content&&t.content.length||0,retryCount:r,transId:e,code:n}),this.logMessage("onSendMessageFail, retryCount: ".concat(r," ex.code: ").concat(n))}},{key:"onSendMessageSuccess",value:function(e){var t=this.changesetSendStateMap.get(e);if(t){var r=t.sendStartTime,n=Date.now()-r;e&&n<1e3&&10*Math.random()<1&&this.reporterService.eventReport({key:"client_sheet_send_message_speed",cost_time:n,transId:e}),e&&this.reporterService.eventReport({key:"client_sheet_sendmessage_succ",transId:e})}}},{key:"onResponseDataNull",value:function(e,t,r){e&&this.reporterService.eventReport({key:"client_sheet_response_data_null",transId:e,type:t,requestId:r||""})}},{key:"onSendMessageCatchError",value:function(e){this.logMessage("SendMessageCatchError: ".concat(e.message)),this.reporterService.captureException(e,{key:"SYNC_SEND_MESSAGE_ERROR"})}},{key:"onSendUserChangeLogicFailed",value:function(e,t,r,n){this.reporterService.eventReport({key:"client_sheet_sendmessage_logic_fail",transId:e,baseRev:t,requestId:r||"",logId:n||""})}},{key:"onInvalidToken",value:function(e,t){this.logMessage("token has been changed",e,t),this.reporterService.eventReport({key:"client_sheet_sync_invalid_token",newToken:e,oldToken:t})}},{key:"onAcceptCommit",value:function(e,t){e.transId&&this.reporterService.eventReport({key:"client_sheet_cs_commit_accept",transId:e.transId,baseRev:t.base_rev})}},{key:"onRejectCommit",value:function(e,t){e.transId&&this.reporterService.eventReport({key:"client_sheet_cs_commit_reject",transId:e.transId,baseRev:t.base_rev})}},{key:"onErrorCommit",value:function(e,t,r,n){e.transId&&this.reporterService.eventReport({key:"client_sheet_cs_commit_error",transId:e.transId,baseRev:t?t.base_rev:-1,requestId:r||"",logId:n||""}),String(e.code)===f.D1r.ERR_500&&t&&t.content&&t.content[0].action===f.aOo.ADD_BLOCK&&(this.reporterService.captureException(new Error(e.message),{key:"ERROR_ADD_BLOCK_1006"}),this.reporterService.eventReport({key:"client_sheet_cs_add_block_1006_error",transId:e.transId,baseRev:t?t.base_rev:-1}))}},{key:"onHighCSSucc",value:function(e){e.retryCount&&this.reporterService.eventReport({key:"client_sheet_high_priority_retry_succ",retryCount:e.retryCount})}},{key:"onHighCSFail",value:function(e){this.reporterService.eventReport({key:"client_sheet_high_priority_failed",retryCount:e.retryTimes||0,code:e.code||"",message:e.message||""})}},{key:"onInitEnd",value:function(){this.infoMessage("onInitEnd")}},{key:"onResetStart",value:function(e){this.logMessage("onResetStart transId:".concat(e)),this.dispatchEvent(br.RESET,e)}},{key:"onResetEnd",value:function(){this.reporterService.eventReport({key:"client_sheet_sync_reset_end"})}}],[{key:"generateChangesetSendId",value:function(){return Tr.changesetSendId++}}]),e}();function Gr(e){return e===ot.NetworkState.online?ot.NetworkState.online:ot.NetworkState.offline}function qr(e){return e===ne.STATUS_CODE.CONNECT_ERROR||e===ne.STATUS_CODE.TIMEOUT}function zr(e){return e<=4e5?1e4:6e4}jr.changesetSendId=0,jr.DEFAULT_CHANGESET_TRANS_ID=-1,Fr([(0,Mt.P)()],jr.prototype,"destroy",null),jr=Tr=Fr([(0,Nt.b)(),Pr(0,(0,Bt.f)(pr)),Pr(1,(0,Bt.f)(xt.UU)),Pr(2,(0,Bt.f)(xt.QX)),Pr(3,(0,Bt.f)(xt.tb)),Pr(4,(0,Bt.f)(xt.zv)),Pr(5,(0,Bt.f)(xt.Tl)),Pr(6,(0,Bt.f)(Ut)),Pr(7,(0,Bt.f)(fr))],jr),function(e){e.Start="start",e.Success="success",e.Failed="failed"}(Ur||(Ur={})),function(e){e.COLLECT_USER_CHANGES="COLLECT_USER_CHANGES",e.PRODUCE_CHANGESET="PRODUCE_CHANGESET",e.ACCEPT_COMMIT="ACCEPT_COMMIT",e.REJECT_COMMIT="REJECT_COMMIT",e.NEW_CHANGES="NEW_CHANGES",e.REV_CHANGE="REV_CHANGE",e.HEARTBEAT_REV_CHANGE="HEARTBEAT_REV_CHANGE"}(Hr||(Hr={}));var Wr=r("vsh_89646"),$r=r("vsh_96636"),Kr=r("vsh_99343"),Yr=r("vsh_63818");function Xr(e){return e&&"cell"!==e.type?(e=(0,at.default)(e),(0,K.default)(e.rowCount)||(e.row_count=e.rowCount),(0,K.default)(e.colCount)||(e.col_count=e.colCount),delete e.rowCount,delete e.colCount,e):e}function Jr(e){return!(0,R.default)(e)||(0,Yr.Z)(e)}function Qr(e){return Jr(e)||e<0}function en(e,t){var r=e<0||t<0;return Jr(e)||Jr(t)||r||e*t<=1}function tn(e){if(!e.action)return!0;if("target"in e&&e.action!==f.aOo.FREEZE_SHEET){var t=e.target;if("row"in t&&Qr(t.row))return!0;if("row_count"in t&&Qr(t.row_count))return!0;if("col"in t&&Qr(t.col))return!0;if("col_count"in t&&Qr(t.col_count))return!0}if(e.action===f.aOo.MOVE_SHEET){var r=e.value;if(!("target"in r)||Qr(r.target))return!0;if(!("source"in r)||Qr(r.source))return!0}if(e.action===f.aOo.SORT){var n=e.value,i=e.target.row,o=e.target.row_count;if(function(e){return Jr(e)||e<1}(o))return!0;if(Array.isArray(n)){if(n.length!==o)return!0;for(var s={},a=0;a<n.length;a++){var c=n[a];if(c>=i+o||c<i)return!0;if(s[c])return!0;s[c]=!0}return!1}return!0}if(e.action===f.aOo.SET_COLUMN_WIDTH&&!(0,R.default)(e.value))return!0;if(e.action===f.aOo.ADD_COMMENTS&&0===e.value.comments.length)return!0;if(e.action===f.aOo.SET_SPANS){var u=e.target,l=e.value;if(en(u.row_count,u.col_count))return!0;if(Array.isArray(l)&&l.length>0)for(var h=0;h<l.length;h++){var d=l[h];if(en(d.target.row_count,d.target.col_count))return!0}}return!!(e.action===f.aOo.SET_CELL&&e.value&&e.value.value&&e.value.value instanceof Array&&e.value.value.filter((function(e){return void 0===e.text||null===e.text})).length>0)}function rn(e){return!!e.is_local}var nn=r("vsh_56589");function on(e,t){var r="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!r){if(Array.isArray(e)||(r=function(e,t){if(!e)return;if("string"==typeof e)return sn(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);"Object"===r&&e.constructor&&(r=e.constructor.name);if("Map"===r||"Set"===r)return Array.from(e);if("Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r))return sn(e,t)}(e))||t&&e&&"number"==typeof e.length){r&&(e=r);var n=0,i=function(){};return{s:i,n:function(){return n>=e.length?{done:!0}:{done:!1,value:e[n++]}},e:function(e){throw e},f:i}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,s=!0,a=!1;return{s:function(){r=r.call(e)},n:function(){var e=r.next();return s=e.done,e},e:function(e){a=!0,o=e},f:function(){try{s||null==r.return||r.return()}finally{if(a)throw o}}}}function sn(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,n=new Array(t);r<t;r++)n[r]=e[r];return n}var an=function(e){function t(){return(0,a.Z)(this,t),(0,Ue.Z)(this,(0,He.Z)(t).apply(this,arguments))}return(0,Ze.Z)(t,e),t}(f.Cl4),cn=function(e){function t(){var e;return(0,a.Z)(this,t),(e=(0,Ue.Z)(this,(0,He.Z)(t).apply(this,arguments))).maxResolvedRev=-1,e}return(0,Ze.Z)(t,e),(0,c.Z)(t,[{key:"setMaxResolvedRev",value:function(e){this.maxResolvedRev=e}},{key:"startTrack",value:function(e){return e<=this.maxResolvedRev?Promise.resolve(e):(0,nn.Z)((0,He.Z)(t.prototype),"startTrack",this).call(this,e)}},{key:"endTrack",value:function(e){var r,n=on(this.promiseMap.keys());try{for(n.s();!(r=n.n()).done;){var i=r.value;i<=e&&(0,nn.Z)((0,He.Z)(t.prototype),"endTrack",this).call(this,i,i)}}catch(e){n.e(e)}finally{n.f()}this.maxResolvedRev=Math.max(this.maxResolvedRev,e)}}]),t}(f.Cl4),un=r("vsh_11967");function ln(e){return e.action===f.aOo.SET_CELL?!!e.no_history:e.action===f.aOo.SET_SHEET&&void 0!==e.value.tab_type}function hn(e){for(var t=0;t<e.length&&ln(e[t]);)t++;return e.slice(0,t)}var dn,fn=function(e,t,r,n){var i,o=arguments.length,s=o<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,r):n;if("object"===("undefined"==typeof Reflect?"undefined":(0,Qe.Z)(Reflect))&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,t,r,n);else for(var a=e.length-1;a>=0;a--)(i=e[a])&&(s=(o<3?i(s):o>3?i(t,r,s):i(t,r))||s);return o>3&&s&&Object.defineProperty(t,r,s),s},pn=function(e,t){return function(r,n){t(r,n,e)}},vn="fetch-miss-manager",gn=dn=function(){function e(t,r,n,i){var o=this;(0,a.Z)(this,e),this.fetchProvider=t,this.reporterService=r,this.loggerService=n,this.configService=i,this._versionFetching=new Set,this._versionToFetch=new Set,this._destroyed=!1,this.fetchingVersionRetryCountMap=new Map,this.retryConfig={max:5},this.requireFetchMissVersion=function(e,t){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;!o._destroyed&&Array.isArray(e)&&e.length&&(e.forEach((function(e){o._versionToFetch.add(e)})),o.onRequireFetchMissVersion(e,t,r),o.fetchMissVersionCore())},this.markAsResolved=function(e){o._versionFetching.delete(e),o._versionToFetch.delete(e),o.fetchingVersionRetryCountMap.delete(e)},this.triggerFetchMiss=function(){0===o._versionFetching.size&&o.fetchMissVersionCore()},this.fetchMissVersionCore=(0,vt.default)((function(){if(!(o._destroyed||o._versionFetching.size>0||0===o._versionToFetch.size)){var e=function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:200;if(!e.length||t<=0)return[];var r=0;for(;r<e.length-1&&e[r]===e[r+1]-1&&r<t-1;)r++;return e.slice(0,r+1)}((0,p.Z)(o._versionToFetch).sort((function(e,t){return e-t})),o.configService.resolve("fetchMissMaxRevCount",200));if(e.length){e.forEach((function(e){o._versionFetching.add(e)})),o.onFetchMissVersion(e);var t=e[0];o.fetchingVersionRetryCountMap.has(t)||o.fetchingVersionRetryCountMap.set(t,0),o.fetchProvider.sendMissRevMessage(e,f.Hg0.genSpecTid(f.$UQ.FETCH_MISS_VERSION_CORE)).then((function(r){var n;if(r.code!==Er.Success)throw{code:r.code,subCode:null===(n=r.data)||void 0===n?void 0:n.code,message:"".concat(r.code,"_").concat(r.data.code,"_").concat(r.request_id)};if(e.forEach((function(e){o._versionFetching.delete(e)})),o.onFetchMissVersionSucc(e),o.fetchProvider.processRemoteMessage(r),o._versionToFetch.has(t)){o.onFetchMissNoResolve(t);var i=o.fetchingVersionRetryCountMap.get(t);void 0!==i&&i<o.retryConfig.max&&(o.fetchingVersionRetryCountMap.set(t,i+1),o.fetchMissVersionCore())}})).catch((function(t){o.onFetchMissVersionFail(e,t),e.forEach((function(e){o._versionFetching.delete(e)}))}))}}}),dn.THRESHOLD_TIME),this.destroy=function(){var e,t;o._destroyed=!0,o._versionFetching.clear(),o._versionToFetch.clear(),o.fetchingVersionRetryCountMap.clear(),o.subscription.unsubscribe(),null===(e=(t=o.fetchMissVersionCore).cancel)||void 0===e||e.call(t)},this.subscription=this.fetchProvider.subscribeEvent(br.REMOTE_DATA_OVER_SIZE,this.handleRemoteDataOverSize)}return(0,c.Z)(e,[{key:"handleRemoteDataOverSize",value:function(e){return this.requireFetchMissVersion(e,!0,f.Hg0.genSpecTid(f.$UQ.REMOTE_DATA_OVER_SIZE))}},{key:"setRetryConfig",value:function(e){this.retryConfig=(0,Or.Z)(this.retryConfig,e)}},{key:"getFetchMissMaxCount",value:function(){return this.configService.resolve("fetchMissMaxRevCount",200)}},{key:"onRequireFetchMissVersion",value:function(e,t){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,n=e.join("_"),i=t?"client_sheet_fetch_miss_version_require_overSize":"client_sheet_fetch_miss_version_require";this.reporterService.eventReport({key:i,versionTobeFetch:n,transId:r}),this.logMessage("".concat(i,": ").concat(n," transId: ").concat(r))}},{key:"onFetchMissVersion",value:function(e){var t=e.join("_");this.reporterService.eventReport({key:"client_sheet_fetch_miss_version",versionTobeFetch:t}),this.logMessage("client_sheet_fetch_miss_version: ".concat(t))}},{key:"onFetchMissNoResolve",value:function(e){this.reporterService.eventReport({key:"client_sheet_fetch_miss_no_resolve",version:e,retryCount:this.fetchingVersionRetryCountMap.get(e)})}},{key:"onFetchMissVersionFail",value:function(e,t){var r=e.join("_");this.reporterService.eventReport({key:"client_sheet_fetch_miss_version_fail",versionTobeFetch:r,retryCount:this.fetchingVersionRetryCountMap.get(e[0]),code:t.code,subCode:t.subCode,msg:t.msg}),this.logMessage("client_sheet_fetch_miss_version_fail: ".concat(r))}},{key:"onFetchMissVersionSucc",value:function(e){var t=e.join("_");this.reporterService.eventReport({key:"client_sheet_fetch_miss_version_succ",versionTobeFetch:t,retryCount:this.fetchingVersionRetryCountMap.get(e[0])}),this.logMessage("client_sheet_fetch_miss_version_succ: ".concat(t))}},{key:"logMessage",value:function(e){this.loggerService.log("fetch-miss",e)}}]),e}();gn.THRESHOLD_TIME=3e3,fn([(0,dt.Bind)()],gn.prototype,"handleRemoteDataOverSize",null),gn=dn=fn([(0,Nt.b)(),pn(0,(0,Bt.f)(Zr)),pn(1,(0,Bt.f)(xt.zv)),pn(2,(0,Bt.f)(xt.QX)),pn(3,(0,Bt.f)(xt.tb))],gn);var yn,_n=function(e,t,r,n){var i,o=arguments.length,s=o<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,r):n;if("object"===("undefined"==typeof Reflect?"undefined":(0,Qe.Z)(Reflect))&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,t,r,n);else for(var a=e.length-1;a>=0;a--)(i=e[a])&&(s=(o<3?i(s):o>3?i(t,r,s):i(t,r))||s);return o>3&&s&&Object.defineProperty(t,r,s),s},kn=function(e,t){return function(r,n){t(r,n,e)}},En="engine";!function(e){e.LOCAL="local",e.REMOTE="remote"}(yn||(yn={}));var mn=function(){function e(t,r,n,i,o,s,c,u,l,h){var d=this;(0,a.Z)(this,e),this.sync=t,this.fetchMissService=r,this.userChangesStateTracker=n,this.watchDog=i,this.loggerService=o,this.configService=s,this.reporterService=c,this.errorRecorderService=u,this.backupService=l,this.clientMetaService=h,this.actionSuspend=!1,this.suspendActions=[],this.receiveChangesetsMap=new Map,this.baseRev$=new f.ps3(0),this.maxRev$=new f.ps3(0),this.revPromiseTracker=new cn,this.localActions=[],this.submittingChangeset=null,this.followChangeset=null,this.enable=!1,this.changesetPromiseTracker=new an,this.applyActions$=new vr.xQ,this.lastFetchMissRev=mr,this.pendingSheetActionsRefs=[],this.eventTrigger$=new vr.xQ,this.sendingChangesetEditors=[],this.localActionConsumer=new O({backup:this.backupService,logger:this.loggerService,reporter:this.reporterService}),this.backupService.init({isOnline:function(){return d.network===ot.NetworkState.online}}),this.sendUserChanges=(0,$r.default)(this.sendUserChangesCore,this.configService.resolve("engineSendUserChangeDebounceTime",500)),this.subscribeMessage()}var t,r,n,i;return(0,c.Z)(e,[{key:"subscribeMessage",value:function(){this.sync.subscribeChangesetsMessage(this.onNewChanges.bind(this)),this.sync.subscribeEngineChannelHeartbeat(this.onEngineChannelHeartbeat.bind(this)),this.sync.subscribeChannelState(this.onChannelStateChange.bind(this))}},{key:"sendUserChangesCore",value:function(e){try{if(!this.getSendable())return void(this.watchDogEnable()||this.watchDog.resetAll());if(this.getUserChangesSending()||!this.getUserChangesPrepared())return;this.onSendUserChangeStart(e);var t=function(e,t,r){for(var n,i=0,o=0,s=e.length;o<s;o++){if(o+1>t)return e.slice(0,o);var a=e[o],c=a.sheet_id;if(n=a,(0,f.CHx)(n.action))return 0===o?[a]:e.slice(0,o);if(ln(a))return 0===o?hn(e):e.slice(0,o);if((0,f.i55)(a)&&++i>=r)return e.slice(0,o+1);var u=e[o+1];if(u&&c!==u.sheet_id)return e.slice(0,o+1)}return e}(this.localActions,this.configService.resolve("engineMaxChangesetActionCount",5e3),this.configService.resolve("engineMaxRangeActionCount",5)),r=t.length;this.logMessage("log","generateChangeset, total localActions: ".concat(this.localActions.length,", sliceIndex: ").concat(r," transId: ").concat(e));var n=f.Hg0.genMergedTid(this.localActions,r,e),i=function(e,t){for(var r,n={base_rev:t,content:[],msg_id:(0,Me.v4)()},i=[],o=0;o<e.length;o++){var s,a=e[o];if(a.action!==f.aOo.TID_SPLIT){var c=null===(s=a.extra)||void 0===s?void 0:s.commandType;if(c&&(r=c),(0,f.Lod)(a)&&a.value.block_id){var u={block_id:(a=(0,at.default)(a)).value.block_id,block_type:a.value.block_type,block_token:a.value.block_token};a.action===f.aOo.COPY_SHEET&&(delete a.value.block_id,delete a.value.block_type,delete a.value.block_token),a.action!==f.aOo.ADD_BLOCK&&a.action!==f.aOo.COPY_SHEET||(u.data=a.value.block_data,delete a.value.block_data,a.value.transaction_id&&(n.msg_id=a.value.transaction_id,delete a.value.transaction_id)),(0,un.Z)(n,["block_infos",a.action,a.value.block_id],u)}if((0,f._DH)(a)&&a.value)switch(a.action){case f.aOo.ADD_BLOCK:case f.aOo.RESTORE_BLOCK:i.push({resource_id:a.value.block_token,resource_type:a.value.block_type});break;case f.aOo.SET_EMBEDDED_BLOCK:case f.aOo.DEL_EMBEDDED_BLOCK:i.push({resource_id:a.value.blockToken,resource_type:a.value.blockType})}n.content.push(a)}}return 1===e.length&&e[0].no_history&&(n.property=f.I1b.NOT_GENERATE_HISTORY|f.I1b.NOT_UPDATE_EDIT_TIME),i.length&&(n.ext_resources=i),r&&(n.command_type=r),n}(t,this.baseRev);if(!i.content.length)return void this.logMessage("log","generateChangeset filtered content is empty");this.watchDog.mergeWatch(n);var o=this.localActions[0].sheet_id;i=this.editSendingChangeset(i),this.onBeforeSendUserChange(n,i,o),this.setSubmittingChangeset(i,n),this.setFollowChangeset(i,n);var s=this.localActions.slice(r);return this.setLocalActions(s,n),0===s.length&&this.completeBackup(),this.submittingChangeset&&0!==this.submittingChangeset.content.length?(this.userChangesStateTracker.pushNewState({type:dr.USER_CHANGES}),this.changesetPromiseTracker.startTrack(this.submittingChangeset.msg_id),this.sendChangesetByMessenger(this.submittingChangeset,n),this.onSendUserChangeEnd(e,i),this.submittingChangeset.msg_id):(this.onSendUserChangeError(n,r,this.localActions.length,0),this.setSubmittingChangeset(null,n),void this.setFollowChangeset(null,n))}catch(e){this.logMessage("log","sendUserChangesCore catch error: ".concat(e.message)),this.reporterService.captureException(e,{key:"ENGINE_ERR_RCE_LIVE_SYNC"}),this.errorRecorderService.record(xt.FP.Module,xt.NI.ClientError,xt.jK.ERR_RCE_LIVE_SYNC,null),this.reporterService.eventReport({key:"ccm_sheet_engine_error_dev",from:"sendUserChangesCore",message:e&&e.stack?String(e.stack):String(e)})}}},{key:"sendChangesetByMessenger",value:(i=(0,C.Z)(b().mark((function e(t,r){var n;return b().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.getSendable()){e.next=3;break}return this.logMessage("log","sendChangesetByMessenger engine is not sendable"),e.abrupt("return");case 3:return this.dispatchEvent(Hr.PRODUCE_CHANGESET,t),e.prev=4,e.next=7,this.sync.submitChangeset(t,r,this.localActions.length>0);case 7:n=e.sent,e.next=14;break;case 10:return e.prev=10,e.t0=e.catch(4),this.logMessage("error","sendChangesetByMessenger error",e.t0),e.abrupt("return");case 14:this.processChangesetResponse(n,r);case 15:case"end":return e.stop()}}),e,this,[[4,10]])}))),function(e,t){return i.apply(this,arguments)})},{key:"processChangesetResponse",value:function(e,t){var r=e.changeset;e.code===Er.Success?this.onAcceptCommit(e.code,e.ackResponse,r,t):!function(e){return e.code===Er.ServerRejectError}(e)?!function(e){return e.code===Er.ServerRetryableError||e.code===Er.ServerError||e.code===Er.NetworkError}(e)?function(e){return Sn.has(e.code)}(e)&&this.onEmptyResponse(r,t):this.onAcceptError(e.code,e.errorResponse,r,t):this.onAcceptReject(e.code,e.rejectResponse,r,t)}},{key:"editSendingChangeset",value:function(e){return this.sendingChangesetEditors.length?this.sendingChangesetEditors.reduce((function(e,t){return t(e)}),e):e}},{key:"onNewChanges",value:function(e){var t=this;if(e&&0!==e.length){var r=f.Hg0.genSpecTid(f.$UQ.FORWARD_CHANGESET_CORE);this.onNewChangesStart(e.length,e.map((function(e){return e.revision}))),e.forEach((function(e){t.fetchMissService.markAsResolved(e.revision),e.revision<=t.baseRev||(String(e.member_id)!==String(t.sync.getMemberId())||(0,f.mzR)(e)?t.receiveChangesetsMap.set(e.revision,{source:yn.REMOTE,changeset:e}):t.receiveChangesetsMap.set(e.revision,{source:yn.LOCAL}),t.maxRev=Math.max(t.maxRev,e.revision))})),this.consumeNewChanges(r);var n=e[0].editTime;this.userChangesStateTracker.pushNewState({type:dr.NEW_CHANGES,editTime:n}),this.dispatchEvent(Hr.NEW_CHANGES,e),this.onNewChangesEnd()}}},{key:"consumeNewChanges",value:function(e){this.getApplyEnable()&&(this.forwardChangesets(e),this.checkAndFetchMiss(e))}},{key:"forwardChangesets",value:function(e){var t=[],r=this.baseRev+1;try{for(;this.receiveChangesetsMap.has(r);r++){var n=this.receiveChangesetsMap.get(r);if(this.receiveChangesetsMap.delete(r),n.source===yn.LOCAL){this.applyActions((0,Wr.Z)(t),e),t.length=0;var i=f.Hg0.genSpecTid(f.$UQ.FORWARD_CHANGESET_CORE);this.setFollowChangeset(null,i),this.setSubmittingChangeset(null,i),this.logMessage("log","forwardLocalClientChange ".concat(e," end and send next changeset: ").concat(i)),this.sendNextChangeset(i)}else n.source===yn.REMOTE&&t.push(n.changeset.content||[])}}catch(t){return this.onForwardChangesetsError(t,e),void this.errorRecorderService.record(xt.FP.Module,xt.NI.ClientError,xt.jK.ERROR_APPLY_ACTION_EX,{transId:e,ex:t})}var o=(0,Wr.Z)(t);if(o.length&&!this.applyActions(o,e))return void this.logMessage("log","forwardChangesets applyActions return false",o);this.baseRev<r-1&&this.setBaseRev(r-1,e)}},{key:"applyActions",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;try{if(!Array.isArray(e)||0===e.length)return!1;this.onApplyActionsStart(e,t);var r=this.followActions(e,t);return null!==r&&(this.applyActionsCore(r,t),this.onApplyActionsEnd(e,t),!0)}catch(r){return this.errorRecorderService.record(xt.FP.Module,xt.NI.ClientError,xt.jK.ERROR_APPLY_ACTION_EX,{transId:t,error:r}),this.logMessage("error","applyAction throw error: ".concat(r.message),r,JSON.stringify(e)),this.onApplyActionsError(r,t),!1}}},{key:"followActions",value:function(e,t){try{if(this.followChangeset){var r=this.followChangeset.content;this.setFollowChangeset(Object.assign({},this.followChangeset,{content:this.followFunc(e,r,!1)}),t||f.Hg0.genSpecTid(f.$UQ.FOLLOW_ACTIONS)),e=this.followFunc(r,e,!0)}var n=this.localActions;return n.length>0&&this.setLocalActions(this.followFunc(e,n,!1),t||f.Hg0.genSpecTid(f.$UQ.FOLLOW_ACTIONS_2)),e=this.followFunc(n,e,!0)}catch(e){return this.onFollowActionsError(e,t),this.errorRecorderService.record(xt.FP.Module,xt.NI.ClientError,xt.jK.ERR_CLIENT_FOLLOW_REJECT,{transId:t,rejectType:f.KNj.FOLLOW_REJECT,error:e}),null}}},{key:"applyActionsCore",value:function(e,t){if(this.actionSuspend)(0,f.hTd)(this.suspendActions,e);else try{this.applyActions$.next(e)}catch(r){this.onApplyActionsCoreError(r),this.errorRecorderService.record(xt.FP.Module,xt.NI.ClientError,xt.jK.ERROR_APPLY_ACTION_EX,{transId:t,actions:e,error:r})}}},{key:"onAcceptCommit",value:function(e,t,r,n){var i=t.new_rev;if(this.logMessage("log","onAcceptCommit newRev ".concat(i," baseRev:").concat(this.baseRev,", code: ").concat(e,", transId: ").concat(n)),i<=this.baseRev)this.submittingChangeset&&this.submittingChangeset.base_rev<this.baseRev&&this.handleAckInvalid(i);else{this.receiveChangesetsMap.set(i,{source:yn.LOCAL}),this.maxRev=Math.max(this.maxRev,i),this.consumeNewChanges(t.transId);var o=r.msg_id;this.changesetPromiseTracker.endTrack(o,!0),this.userChangesStateTracker.pushNewState({type:dr.ACCEPT_COMMIT,editTime:t.editTime}),this.dispatchEvent(Hr.ACCEPT_COMMIT,e,t,r)}}},{key:"handleAckInvalid",value:function(e){var t;this.logMessage("log","ack invalid:baseRev(".concat(this.baseRev,") newRev(").concat(e,")\n    submitting: ").concat(null===(t=this.submittingChangeset)||void 0===t?void 0:t.msg_id)),this.submittingChangeset&&this.onAckInvalid(this.baseRev,e,this.submittingChangeset.base_rev,f.$UQ.ACK),this.setSubmittingChangeset(null,f.$UQ.ACK),this.setFollowChangeset(null,f.$UQ.ACK)}},{key:"onAcceptReject",value:function(e,t,r,n){this.logMessage("log","onAcceptReject code: ".concat(e," transId:").concat(n),t),this.errorRecorderService.record(xt.FP.Module,xt.NI.ServerError,xt.jK.ERR_SERVER_REJECT_COMMIT,{rejectType:f.KNj.SEND_USER_CS,rspData:t,changeset:r}),this.dispatchEvent(Hr.REJECT_COMMIT),this.changesetPromiseTracker.endTrack(r.msg_id,!1)}},{key:"onAcceptError",value:function(e,t,r,n){this.logMessage("error","onAcceptError send user change error ".concat(t.transId," code: ").concat(e," transId:").concat(n),t,r);var i=function(e,t){return e===Er.NetworkError||t.code===Er.NetworkError}(e,t);if(!i){if(function(e,t){return e===Er.ServerRetryableError&&String(t.code)===xt.jK.ERR_LOCK_FAILED}(e,t));else{var o=e===Er.ServerRetryableError?xt.jK.ERR_SERVER_RETRY_FAILED:xt.jK.ERR_SERVER_CONTENT_RESPONSE_ERROR;this.errorRecorderService.record(xt.FP.Module,xt.NI.ServerError,o,t)}this.changesetPromiseTracker.endTrack(r.msg_id,!1)}}},{key:"onEngineChannelHeartbeat",value:function(e){var t=this.sync.getEngineChannelHeartbeatRev();if(t!==mr){if(!this.getEngineEnable())return this.logMessage("log","revision from heartbeat but engine is not enable.  remoteRev ".concat(e,"  oldVersion: ").concat(t," maxRev: ").concat(this.maxRev," baseRev: ").concat(this.baseRev)),void(this.maxRev=Math.max(this.maxRev,e,t));var r=this.baseRev;if(!(e<=r)){this.logMessage("log","RevisionFromHB: local: ".concat(r,", remote: ").concat(e," maxRev: ").concat(this.maxRev," baseRev: ").concat(this.baseRev)),this.maxRev=Math.max(this.maxRev,e);var n=f.Hg0.genSpecTid(f.$UQ.HB);this.dispatchEvent(Hr.HEARTBEAT_REV_CHANGE,e),this.onHeartBeats(e,r),this.checkAndFetchMiss(n)}}}},{key:"fetchMissByMaxRevMaxRevChanged",value:function(e){for(var t=[],r=this.fetchMissService.getFetchMissMaxCount(),n=Math.min(this.maxRev-this.baseRev,r),i=this.baseRev+n,o=this.baseRev+1;o<=i;o++)this.receiveChangesetsMap.has(o)||t.push(o);if(t.length&&!(this.lastFetchMissRev>=t[0])){var s=t[t.length-1];this.logMessage("log","start fetch miss from ".concat(t[0]," to ").concat(s)),this.fetchMissService.requireFetchMissVersion(t,!1,e),this.lastFetchMissRev=s}}},{key:"onChannelStateChange",value:function(e){var t=e.netState;if(this.onNetworkChanged(t),t===ot.NetworkState.online)this.sendUserChanges(f.Hg0.genSpecTid(f.$UQ.ONLINE_STATE_CHANGE))}},{key:"setBaseRev",value:function(e,t){this.onSetBaseRevStart(e,t),this.baseRev=e,this.sync.setContentVersion(e),this.setBackup(o.Rev,e,t),this.onSetBaseRevEnd(this.baseRev,t),this.dispatchEvent(Hr.REV_CHANGE,e),this.revPromiseTracker.endTrack(e)}},{key:"setLocalActions",value:function(e,t){for(var r=!(arguments.length>2&&void 0!==arguments[2])||arguments[2];e.length&&e[0].action===f.aOo.TID_SPLIT;)e.shift();if(this.localActions=e,r){var n=!e||e&&!e.length;this.setBackup(o.Actions,n?null:e,t),this.onSetLocalActionEnd(t,e.length)}}},{key:"setSubmittingChangeset",value:function(e,t){var r=arguments.length>2&&void 0!==arguments[2]&&arguments[2];this.submittingChangeset=e,!1===r&&this.setBackup(o.Submit,e,t),this.onSetSubmittingChangesetEnd(t,e?e.content.length:0)}},{key:"setFollowChangeset",value:function(e,t){this.followChangeset=e,this.setBackup(o.Follow,e,t),this.onSetFollowChangesetEnd(t,e?e.content.length:0)}},{key:"setBackup",value:function(e,t,r){var n=this.clientMetaService,i=n.token,s=n.userId,a=n.memberId;this.logMessage("log","setBackup currentRev: ".concat(this.getBaseRev()," type: ").concat(e," transId: ").concat(r)),this.beforeSaveStore(e,t,r),this.localActionConsumer.push(r,e,{data:t,baseRev:this.getBaseRev(),memberId:a}),this.network===ot.NetworkState.offline&&e===o.Actions&&(this.backup.broadcastEditableTab({token:i,userId:s,memberId:a,date:Date.now()}),this.userChangesStateTracker.pushNewState({type:dr.LOCAL,status:"success"}))}},{key:"beforeSaveStore",value:function(e,t,r){}},{key:"checkAndFetchMiss",value:function(e){if(this.getEngineEnable()){if(this.baseRev!==this.maxRev){this.logMessage("log","checkAndFetchMiss baseRev: ".concat(this.baseRev," maxRev: ").concat(this.maxRev," transId:").concat(e));var t=this.configService.resolve("engineMissVersionThreshold",200);if(this.maxRev-this.baseRev>t)return this.reporterService.eventReport({key:"client_sheet_old_version_detail",msg:"".concat(this.maxRev,"-").concat(this.baseRev),is_base_rev_zero:0===this.baseRev?1:0}),this.errorRecorderService.record(xt.FP.Module,xt.NI.ServerError,xt.jK.ERR_OLD_VERSION,{rejectType:f.KNj.TOO_OLD_REV,transId:e}),void this.onVersionTooOld(e);this.fetchMissByMaxRevMaxRevChanged(e)}}else this.logMessage("log","checkAndFetchMiss but engine is not enable transId: ".concat(e))}},{key:"handleBackup",value:(n=(0,C.Z)(b().mark((function e(t){var r,n,i,s,a,c,u,l,h,d,p,v;return b().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=this.backup.isBackingUp,this.logMessage("log","handleBackup start, isBackingUp: ".concat(r," enable: ").concat(this.getEngineEnable()," sendable: ").concat(this.getSendable()," transId: ").concat(t)),r){e.next=4;break}return e.abrupt("return");case 4:return e.next=6,Promise.all([this.backup.getBackupItem(o.Submit),this.backup.getBackupItem(o.Follow),this.backup.getBackupItem(o.Actions)]);case 6:n=e.sent,i=(0,ct.Z)(n,3),s=i[0],a=i[1],c=i[2],this.logMessage("log","handleBackup getDataFinish, actions:".concat(lr(c),", submit:").concat(hr(s),", isBackingUp: ").concat(r," enable: ").concat(this.getEngineEnable()," sendable: ").concat(this.getSendable()," transId: ").concat(t)),s&&a?(u=f.Hg0.genSpecTid(f.$UQ.HANDLE_BACKUP_SUBMITTING_FOLLOW),l=a.data,(h=s.data).member_id=s.memberId,this.logMessage("log","handleBackup submittingChangeset & followChangeset exist. transId: ".concat(u," memberId: ").concat(s.memberId," localRev:").concat(h.base_rev," followRev:").concat(l.base_rev," current rev:").concat(this.baseRev)),this.baseRev===h.base_rev?(this.applyActionsCore(h.content,u),this.setFollowChangeset(h,u)):this.applyActionsCore(l.content,u),this.setSubmittingChangeset(h,u,!0),this.logMessage("log","handleBackup submit ".concat(u," ").concat(h.member_id)),h.content.length&&(h.content=h.content.filter((function(e){return e.action!==f.aOo.TID_SPLIT}))),this.sendChangesetByMessenger(h,u),this.onHandleBackup_SubmittingChangeset()):(s||a)&&(d=f.Hg0.genSpecTid(f.$UQ.HANDLE_BACKUP_SUBMITTING_FOLLOW),this.setFollowChangeset(null,d),this.setSubmittingChangeset(null,d),this.onSubmitAndFollowCSInconsistency(!!a)),c&&(p=f.Hg0.genSpecTid(f.$UQ.HANDLE_BACKUP_LOCAL_ACTION),v=c.data.filter((function(e){return e.action!==f.aOo.TID_SPLIT})),this.logMessage("log","handleBackup onLocalActions len: ".concat(v.length," transId: ").concat(p)),this.applyActionsCore(v,p),this.setLocalActions(v,p,!1),this.sendUserChanges(p),this.onHandleBackup_LocalAction(v)),this.localActions&&0!==this.localActions.length||this.completeBackup(),this.onHandleBackupEnd();case 16:case"end":return e.stop()}}),e,this)}))),function(e){return n.apply(this,arguments)})},{key:"hasPendingSheetActionsRefs",value:function(){return this.pendingSheetActionsRefs.length>0}},{key:"forwardPendingSheetActionsRefs",value:function(e){for(var t=0;t<this.pendingSheetActionsRefs.length;t++){var r=this.pendingSheetActionsRefs[t],n=this.followFunc(r,e,!1),i=this.followFunc(e,r,!0);e=n,r.length=0,(0,f.hTd)(r,i)}return e}},{key:"dispatchEvent",value:function(e){for(var t=arguments.length,r=new Array(t>1?t-1:0),n=1;n<t;n++)r[n-1]=arguments[n];this.eventTrigger$.next({event:e,data:r})}},{key:"addPendingSheetActionsRefs",value:function(e){this.pendingSheetActionsRefs.push(e)}},{key:"removePendingSheetActionsRefs",value:function(e){for(var t=0;t<this.pendingSheetActionsRefs.length;t++)if(this.pendingSheetActionsRefs[t]===e)return void this.pendingSheetActionsRefs.splice(t,1)}},{key:"addSendingChangesetEditor",value:function(e){var t=this;this.sendingChangesetEditors.push(e);var r={closed:!1,unsubscribe:function(){for(var n=0;n<t.sendingChangesetEditors.length;n++)if(t.sendingChangesetEditors[n]===e){t.sendingChangesetEditors.splice(n,1);break}r.closed=!0}};return r}},{key:"collectUserChange",value:function(e,t){this.dispatchEvent(Hr.COLLECT_USER_CHANGES,e);try{if(!e)return 0;this.logMessage("log","CollectUserChange actionLen: ".concat(e.length,", memory actionLen: ").concat(this.localActions.length," transId: ").concat(t)),this.onCollectUserChangeStart(t,e);for(var r=[],n=Array.isArray(e)?e:[(l=e,(l=(0,at.default)(l)).target&&(l.target=Xr(l.target)),(0,g.default)(l.value)||l.action===f.aOo.SET_SPANS&&(l.value=l.value.map((function(e){return e.target=Xr(e.target),e}))),l)],i=[],o=0;o<n.length;o++){var s=n[o];s&&!rn(s)&&(tn(s)?i.push(s):r.push(s))}if(i.length)return this.onIllegalOpsFound(t,i),this.logMessage("error","illegal changeset",i),this.errorRecorderService.record(xt.FP.Module,xt.NI.ClientError,xt.jK.ERROR_ILLEGAL_OP,null),0;this.hasPendingSheetActionsRefs()&&(r=this.forwardPendingSheetActionsRefs(r));var a=(0,f.rx6)(this.localActions,r);if(r.length){var c=r[r.length-1].sheet_id,u=f.Hg0.genTidSplitAction(t,c);a.push(u),this.onCollectUserChangeBeforeSetLocalActions(t,a),this.setLocalActions(a,t),this.onCollectUserChangeAfterSetLocalActions(t),this.sendUserChanges(t),this.onCollectUserChangeEnd(t)}else this.watchDog.done(t,{hasLocalActions:this.localActions.length>0,csLength:0});return r.length}catch(e){return this.logMessage("log","sendUserChangesCore catch error: ".concat(e.message)),this.reporterService.captureException(e,{key:"ENGINE_ERR_RCE_LIVE_SYNC"}),this.errorRecorderService.record(xt.FP.Module,xt.NI.ClientError,xt.jK.ERR_RCE_LIVE_SYNC,null),this.reporterService.eventReport({key:"ccm_sheet_engine_error_dev",from:"collectUserChange",message:e&&e.stack?String(e.stack):String(e)}),0}var l}},{key:"setFollowImplementation",value:function(e){this.followFunc=e}},{key:"getBaseRev",value:function(){return this.baseRev}},{key:"getStatus",value:function(){return{ready:this.enable,network:this.network,baseRev:this.baseRev,localActions:this.localActions,followChangeset:this.followChangeset,submittingChangeset:this.submittingChangeset,actionSuspend:this.actionSuspend,suspendActions:this.suspendActions}}},{key:"suspendApplyAction",value:function(){this.actionSuspend=!0,this.onSuspendAction()}},{key:"resumeApplyAction",value:function(){if(this.actionSuspend){this.actionSuspend=!1;var e=this.suspendActions,t=f.Hg0.genSpecTid(f.$UQ.RESUME_ACTION);this.suspendActions=[],this.applyActionsCore(e,t),this.onResumeAction()}}},{key:"resetLocalChangeAndStop",value:function(){var e=f.Hg0.genSpecTid(f.$UQ.RESET_AND_STOP);this.setLocalActions([],e),this.setEngineEnable(!1,e),this.onSuspendReady()}},{key:"recoverRemoteRevAndStart",value:function(e){var t=f.Hg0.genSpecTid(f.$UQ.RECOVER_AND_START);this.setEngineEnable(!0,t),(0,K.default)(e)||(this.maxRev=e,this.setBaseRev(e,t)),this.consumeNewChanges(t),this.onResumeReady()}},{key:"completeBackup",value:function(){this.backup.isBackingUp&&(this.logMessage("log","mutex_store: completing backup - ".concat(Date.now())),this.backup.completingBackup())}},{key:"getSendable",value:function(){return this.getEngineEnable()&&this.network!==ot.NetworkState.offline}},{key:"getApplyEnable",value:function(){return this.getEngineEnable()}},{key:"getUserChangesSending",value:function(){return!!this.submittingChangeset}},{key:"getUserChangesPrepared",value:function(){return this.localActions.length>0}},{key:"getUserChangesExisted",value:function(){return!!this.submittingChangeset||!!this.localActions.length}},{key:"getLocalActionSheetIds",value:function(){var e=new Set;return this.submittingChangeset&&this.submittingChangeset.content.forEach((function(t){e.add(t.sheet_id)})),this.localActions.forEach((function(t){e.add(t.sheet_id)})),(0,p.Z)(e)}},{key:"getUserChangeSendingOrSaving",value:function(){var e=this.network===ot.NetworkState.online&&this.getUserChangesExisted(),t=this.network===ot.NetworkState.offline&&this.localActionConsumer.isStoring;return e||t}},{key:"subscribeApplyAction",value:function(e){return this.applyActions$.subscribe(e)}},{key:"subscribeEvent",value:function(e,t){return this.eventTrigger$.subscribe((function(r){e===r.event&&t.call.apply(t,[null].concat((0,p.Z)(r.data)))}))}},{key:"subscribeClientRev",value:function(e){return this.baseRev$.subscribe(e)}},{key:"getEngineEnable",value:function(){return this.enable}},{key:"setEngineEnable",value:function(e,t){e!==this.enable&&(this.enable=e,this.logMessage("log","setEngineEnable ".concat(e," transId: ").concat(t)))}},{key:"startTrackChangesetAccept",value:function(e){return this.changesetPromiseTracker.startTrack(e)}},{key:"clearBackup",value:function(){var e=f.Hg0.genSpecTid(f.$UQ.CLEAR_BACKUP);this.onClearBackup(this.baseRev,e),this.setLocalActions([],e),this.setSubmittingChangeset(null,e),this.setFollowChangeset(null,e)}},{key:"submitLocalChanges",value:(r=(0,C.Z)(b().mark((function e(t){return b().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this.setEngineEnable(!0,t),e.next=3,this.handleBackup(t);case 3:this.consumeNewChanges(t),this.sendUserChanges(t);case 5:case"end":return e.stop()}}),e,this)}))),function(e){return r.apply(this,arguments)})},{key:"resendUserChanges",value:(t=(0,C.Z)(b().mark((function e(){var t,r;return b().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.sync.getSendingEnable()){e.next=3;break}return this.logMessage("log","resend UserChanges but sync service can not send. network: ".concat(this.sync.getConnectState().netState,". hasChangesetSending:").concat(this.sync.hasChangesetSending())),e.abrupt("return");case 3:if(!this.submittingChangeset||this.sync.hasChangesetSending()){e.next=10;break}return t=f.Hg0.genSpecTid(f.$UQ.TRIGGER_CHANGESET),this.logMessage("log","resend UserChanges transId: ".concat(t," sendingChangesetRev: ").concat(this.submittingChangeset.base_rev)),e.next=8,this.sync.resendChangeset(this.submittingChangeset,t,this.localActions.length>0);case 8:(r=e.sent)&&this.processChangesetResponse(r,t);case 10:case"end":return e.stop()}}),e,this)}))),function(){return t.apply(this,arguments)})},{key:"sendNextChangeset",value:function(e){return!this.getUserChangesSending()&&(this.sendUserChanges(e),!0)}},{key:"initRev",value:function(e,t){this.maxRev=e,this.setBaseRev(e,t),this.revPromiseTracker.setMaxResolvedRev(e)}},{key:"waitForMaxRev",value:function(e){return e>this.baseRev&&(this.maxRev=e,this.checkAndFetchMiss(f.Hg0.genSpecTid(f.$UQ.SYNC_MAX_REV))),this.revPromiseTracker.startTrack(e)}},{key:"destroy",value:function(){this.enable=!1,this.applyActions$.unsubscribe(),this.baseRev$.unsubscribeAll(),this.maxRev$.unsubscribeAll(),this.revPromiseTracker.destroy(),this.eventTrigger$.unsubscribe(),this.followChangeset=null,this.submittingChangeset=null,this.localActions=[],this.receiveChangesetsMap.clear(),this.suspendActions.length=0,this.pendingSheetActionsRefs.length=0,this.sendingChangesetEditors.length=0}},{key:"logMessage",value:function(e,t){for(var r,n=arguments.length,i=new Array(n>2?n-2:0),o=2;o<n;o++)i[o-2]=arguments[o];(r=this.loggerService)[e].apply(r,["engine",t].concat(i))}},{key:"watchDogEnable",value:function(){return this.network!==ot.NetworkState.offline}},{key:"onAckInvalid",value:function(e,t,r,n){this.reporterService.eventReport({key:"client_sheet_eng_on_ack_invalid",baseRev:e,newRev:t,submittingRev:r,transId:n})}},{key:"onHeartBeats",value:function(e,t){this.reporterService.eventReport({key:"client_sheet_sync_heart_beats",updated_revision:e,base_revision:t})}},{key:"onCollectUserChangeError",value:function(e,t){}},{key:"onBeforeSendUserChange",value:function(e,t,r){this.reporterService.eventReport({key:"client_sheet_eng_before_send_user_change",transId:e,sheetId:r,msg_id:t.msg_id,opLength:t.content.length})}},{key:"onHandleBackup_SubmittingChangeset",value:function(){}},{key:"onHandleBackupEnd",value:function(){}},{key:"onInconsistency",value:function(){}},{key:"onCollectUserChangeStart",value:function(e,t){this.reporterService.eventReport({key:"client_sheet_eng_collect_user_change",opLength:t.length,transId:e})}},{key:"onCollectUserChangeBeforeSetLocalActions",value:function(e,t){this.logMessage("log","onCollectUserChangeBeforeSetLocalActions: localActionsLength: ".concat(t.length,", transId: ").concat(e))}},{key:"onCollectUserChangeAfterSetLocalActions",value:function(e){this.logMessage("log","onCollectUserChangeAfterSetLocalActions: transId: ".concat(e))}},{key:"onCollectUserChangeEnd",value:function(e){this.logMessage("log","onCollectUserChangeEnd: transId: ".concat(e))}},{key:"onIllegalOpsFound",value:function(e,t){this.reporterService.eventReport({key:"client_sheet_eng_collect_user_change_illegal",illegalOps:t.length,transId:e})}},{key:"onSendUserChangeStart",value:function(e){this.reporterService.eventReport({key:"client_sheet_eng_send_user_change",ready:this.getSendable(),network:this.network,submittingChangeset:!!this.submittingChangeset,localActionsLength:this.localActions.length,transId:e})}},{key:"onSendUserChangeEnd",value:function(e,t){e&&this.reporterService.eventReport({key:"client_sheet_eng_send_user_change_fin",transId:e,msg_id:t.msg_id,opLength:t.content.length})}},{key:"onSendUserChangeError",value:function(e,t,r,n){e&&this.reporterService.eventReport({key:"client_sheet_eng_send_user_change_error",transId:e,sliceIndex:t,localActionsLength:r,submittingChangesetLength:n})}},{key:"onSetLocalActionEnd",value:function(e,t){e&&this.reporterService.eventReport({key:"client_sheet_eng_set_localaction_fin",transId:e,localActionsLength:t})}},{key:"onSetSubmittingChangesetEnd",value:function(e,t){e&&this.reporterService.eventReport({key:"client_sheet_eng_set_submitting_fin",transId:e,submittingChangesetLength:t})}},{key:"onSetFollowChangesetEnd",value:function(e,t){e&&this.reporterService.eventReport({key:"client_sheet_eng_set_follow_fin",transId:e,followChangesetLength:t})}},{key:"onHandleBackup_LocalAction",value:function(e){this.reporterService.eventReport({key:"file_edit_merge_offline",actions_size:e.length})}},{key:"onApplyActionsStart",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;this.logMessage("log","onApplyActionsStart: opLength: ".concat(e.length,", transId: ").concat(t))}},{key:"onApplyActionsEnd",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;this.logMessage("log","onApplyActionsEnd: opLength: ".concat(e.length,", transId: ").concat(t))}},{key:"onApplyActionsError",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;this.reporterService.eventReport({key:"client_sheet_eng_apply_action_error",transId:t}),this.reporterService.captureException(e,{key:"SHEET_APPLY_ACTION_EX"})}},{key:"onApplyActionsCoreError",value:function(e){this.reporterService.captureException(e,{key:"SHEET__APPLY_ACTION_EX"})}},{key:"onForwardChangesetsError",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;this.reporterService.captureException(e,{key:"FORWARD_CHANGESETS_ERROR"}),t&&this.reporterService.eventReport({key:"client_sheet_forward_cs_error",transId:t})}},{key:"onFollowActionsError",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;e instanceof Kr.FollowException?this.reporterService.captureException((0,f.chq)(e),{key:"SHEET_FOLLOW_CONFLICT"}):this.reporterService.captureException(e,{key:"SHEET_FOLLOW_ACTION_EX"}),this.reporterService.eventReport({key:"client_sheet_follow_action_error",transId:t})}},{key:"onBeforePageUnload",value:function(){this.reporterService.eventReport({key:"client_sheet_eng_before_unload",network:this.network,localAction:this.localActions.length,submittingCS:!!this.submittingChangeset})}},{key:"onSubmitAndFollowCSInconsistency",value:function(e){this.reporterService.eventReport({key:"client_sheet_eng_submit_follow_inconsistency",isFollowCS:e})}},{key:"onSuspendReady",value:function(){this.reporterService.eventReport({key:"client_sheet_eng_ready_suspend"})}},{key:"onResumeReady",value:function(){this.reporterService.eventReport({key:"client_sheet_eng_ready_resume"})}},{key:"onSuspendAction",value:function(){this.reporterService.eventReport({key:"client_sheet_eng_action_suspend"})}},{key:"onResumeAction",value:function(){this.reporterService.eventReport({key:"client_sheet_eng_action_resume"})}},{key:"onDestroyStart",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;this.reporterService.eventReport({key:"client_sheet_eng_reset_start",transId:e})}},{key:"onDestroyEnd",value:function(){this.reporterService.eventReport({key:"client_sheet_eng_reset_end"})}},{key:"onSpreadLoaded",value:function(e){this.reporterService.eventReport({key:"client_sheet_eng_spread_loaded",base_revision:e})}},{key:"onNewChangesStart",value:function(e,t){this.logMessage("log","onNewChangesStart: size ".concat(e,", revision_id: ").concat(JSON.stringify(t)))}},{key:"onNewChangesEnd",value:function(){this.logMessage("log","onNewChangesEnd")}},{key:"onNetworkChanged",value:function(e){this.reporterService.eventReport({key:"client_sheet_eng_network_changed",state:e})}},{key:"onClearBackup",value:function(e,t){this.reporterService.eventReport({key:"client_sheet_eng_clear_backup",baseRev:e,transId:t})}},{key:"onSetBaseRevStart",value:function(e,t){this.logMessage("log","onSetBaseRevStart: baseRev: ".concat(this.baseRev," -> ").concat(e," transId: ").concat(t))}},{key:"onSetBaseRevEnd",value:function(e,t){this.logMessage("log","onSetBaseRevEnd: ".concat(e," transId: ").concat(t))}},{key:"onEmptyResponse",value:function(e,t){this.logMessage("log","send user changeset receive empty response ".concat(t),e),t&&this.reporterService.eventReport({key:"client_sheet_eng_send_cs_empty_response",transId:t}),this.changesetPromiseTracker.endTrack(e.msg_id,!1)}},{key:"onBackupError",value:function(e,t){this.reporterService.captureException(t,{key:"SHEET_".concat(e,"_BACKUP_EX")})}},{key:"onVersionTooOld",value:function(e){this.reporterService.eventReport({key:"client_sheet_refetch_client_vars",transId:e})}},{key:"network",get:function(){return this.sync.getConnectState().netState}},{key:"backup",get:function(){return this.backupService}},{key:"baseRev",get:function(){return this.baseRev$.value},set:function(e){this.baseRev$.next(e)}},{key:"maxRev",get:function(){return this.maxRev$.value},set:function(e){this.maxRev$.next(e)}}]),e}();_n([(0,Mt.P)()],mn.prototype,"destroy",null),mn=_n([(0,Nt.b)(),kn(0,(0,Bt.f)(Zr)),kn(1,(0,Bt.f)(vn)),kn(2,(0,Bt.f)(_r)),kn(3,(0,Bt.f)(fr)),kn(4,(0,Bt.f)(xt.QX)),kn(5,(0,Bt.f)(xt.tb)),kn(6,(0,Bt.f)(xt.zv)),kn(7,(0,Bt.f)(xt.Tl)),kn(8,(0,Bt.f)(sr)),kn(9,(0,Bt.f)(xt.UU))],mn);var Sn=new Set([Er.UserChangeContentInvalid,Er.TokenChanged,Er.EmptyResponseError]);var bn,Cn,Rn,An,Tn,wn,On,In=["entities"],Dn=function(e,t,r,n){var i,o=arguments.length,s=o<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,r):n;if("object"===("undefined"==typeof Reflect?"undefined":(0,Qe.Z)(Reflect))&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,t,r,n);else for(var a=e.length-1;a>=0;a--)(i=e[a])&&(s=(o<3?i(s):o>3?i(t,r,s):i(t,r))||s);return o>3&&s&&Object.defineProperty(t,r,s),s},Ln=function(e,t){return function(r,n){t(r,n,e)}},Mn="room-member",Nn=function(){function e(t,r,n){var i=this;(0,a.Z)(this,e),this.memberDataProvider=t,this.reporterService=r,this.loggerService=n,this.users=new Map,this.userList$=new vr.xQ,this.subscription=null,this.connectedEntity=null,this.onEntityChanged=function(e){e&&(i.connectedEntity=Object.assign({},e),i.memberDataProvider&&i.memberHelper.eventOnRefetchRoomMembers(i.reFetchRoomMembersBound,i.connectedEntity.token))},this.handleEngagementCursor=function(e){var t=e.member_id,r=e.cursor_info,n=String(t),o=i.users.get(n);o&&(i.connectedEntity?(i.memberHelper.handleUserUpdate("sheet",Object.assign({token:i.connectedEntity.token},o,{member_id:n})),o&&(o.cursor_info=r,i.dispatchUserListChange())):i.logMessage("log","reFetchRoomMembers no entity"))},this.handleMemberData=function(e){e.type===I.USER_NEWINFO?(i.handleNewUser(e),i.checkMemberRevAndReFetch(e)):e.type===I.USER_LEAVE?(i.handleUserLeave(e),i.checkMemberRevAndReFetch(e)):i.handleRoomMember(e)},this.checkMemberRevAndReFetch=function(e){var t=e.version;if(i.connectedEntity){var r=i.connectedEntity,n=r.type,o=r.token,s=i.memberDataProvider.getChannelVersion(wr.Member);if(null!==s){var a=s+1,c=i.memberHelper.getSuiteMembers(n,o);t>a&&c.length<150&&(i.reFetchRoomMembers(),i.reporterService.eventReport({key:"client_sheet_path_tracker_dev",trace_code:f.Y6H.memberRefetch}))}}else i.logMessage("log","checkMemberRevAndReFetch no entity")},this.handleNewUser=function(e){var t=e.entities,r=(0,Q.Z)(e,In),n=(0,y.default)(t,"users",{}),o=Object.assign(r,n[r.user_id],{count:t.users_count});i.memberHelper.handleUserNewInfo("sheet",Object.assign({},o));var s=String(i.memberDataProvider.getMemberId());i.users.has(o.member_id)||o.member_id===s||(i.users.set(o.member_id,o),i.dispatchUserListChange())},this.handleUserLeave=function(e){i.memberHelper.handleUserLeave("sheet",e);var t=e.member_id;0===i.users.size||(0,g.default)(t)||((0,v.Z)(t,(function(e){i.users.delete(e)})),i.dispatchUserListChange())},this.handleRoomMember=function(e){var t=e.count,r=e.members,n=void 0===r?[]:r;i.connectedEntity?(i.memberHelper.handleMembersMessage("sheet",Object.assign(e,{token:i.connectedEntity.token,members:i.assignMemberInfo(e),count:t})),i.resetMembers(n)):i.logMessage("log","handleRoomMember no entity")},this.assignMemberInfo=function(e){var t=e.members||[],r=(0,y.default)(e,"entities.users",{});return t.forEach((function(e){Object.assign(e,r[e.user_id])})),t},this.resetMembers=function(e){if(!(0,g.default)(e)){var t=String(i.memberDataProvider.getMemberId());i.users=new Map(e.filter((function(e){return e.member_id!==t})).map((function(e){return[e.member_id,i.updateCursorField(e)]}))),i.dispatchUserListChange()}},[this.memberDataProvider.subscribeEngagementCursorData(this.handleEngagementCursor),this.memberDataProvider.subscribeMemberMessage(this.handleMemberData),this.memberDataProvider.getEntityObservable().subscribe(this.onEntityChanged)].forEach((function(e){i.subscription?i.subscription.add(e):i.subscription=e})),this.reFetchRoomMembersBound=this.reFetchRoomMembers.bind(this)}return(0,c.Z)(e,[{key:"logMessage",value:function(e,t){for(var r,n=arguments.length,i=new Array(n>2?n-2:0),o=2;o<n;o++)i[o-2]=arguments[o];(r=this.loggerService)[e].apply(r,["roomMember",t].concat(i))}},{key:"hasOtherUsers",value:function(){return this.users.size>0}},{key:"reFetchRoomMembers",value:function(){var e=this;this.onReFetchRoomMembers();var t=this.memberDataProvider.getMemberId();if(this.connectedEntity){var r=this.connectedEntity,n=r.token,i=r.type,o=f.Hg0.genSpecTid(f.$UQ.REFETCH_ROOM_MEMBER),s=this.memberDataProvider.getChannelVersion(wr.Member)||0;return this.memberHelper.fetchMemberInfos(String(t),n,ne.NUM_SUITE_TYPE.SHEET).then((function(t){t&&t.data&&!(0,K.default)(t.code)&&t.code===ne.STATUS_CODE.SUCCESS&&(t.data.version>s&&e.memberDataProvider.setHeartbeatRev(wr.Member,t.data.version),e.memberDataProvider.processRemoteMemberMessage({type:i,transId:o,retryCount:0,code:t.code,data:Object.assign(t.data,{type:I.ROOM_MEMBERS})}))})).catch((function(t){e.onReFetchRoomMembersFailed()}))}this.logMessage("log","reFetchRoomMembers no entity")}},{key:"onReFetchRoomMembers",value:function(){this.logMessage("log","onReFetchRoomMembers")}},{key:"onReFetchRoomMembersFailed",value:function(){this.reporterService.eventReport({key:"client_sheet_refetch_room_member_error"})}},{key:"updateCursorField",value:function(e){var t=String(e.member_id)!==String(this.memberDataProvider.getMemberId());if((0,g.default)(e.cursor_info)&&e.cursor_info_str&&t)try{var r=JSON.parse(e.cursor_info_str);r&&Object.assign(e,{cursor_info:r})}catch(e){}return e}},{key:"getAllMembers",value:function(){return(0,p.Z)(this.users.values())}},{key:"setMemberHelper",value:function(e){this.memberHelper=e}},{key:"dispatchUserListChange",value:function(){this.userList$.next(this.getAllMembers())}},{key:"subscribeUserListChange",value:function(e){return this.userList$.subscribe(e)}},{key:"destroy",value:function(){var e;this.connectedEntity&&this.memberHelper.eventOffRefetchRoomMembers(this.reFetchRoomMembersBound,this.connectedEntity.token),this.reFetchRoomMembersBound=Y.default,null===(e=this.subscription)||void 0===e||e.unsubscribe(),this.subscription=null,this.userList$.unsubscribe(),this.users.clear(),this.memberHelper={}}}]),e}();Dn([(bn="reFetchRoomMembers",function(e,t,r){r.get,r.set,r.writable;var n=r.value,i=(0,Q.Z)(r,ee);if(!(0,l.default)(n))return r;var o=new Map;return Object.assign({},i,{value:function(){for(var e=arguments.length,t=new Array(e),r=0;r<e;r++)t[r]=arguments[r];var i=t[0]||bn,s=o.get(i);if(!s){var a=n.call.apply(n,[this].concat(t));return te(a)?(o.set(i,!0),a.then((function(e){return o.delete(i),e})).catch((function(e){return o.delete(i),Promise.reject(e)}))):console.error("should return an Promise")}}})})],Nn.prototype,"reFetchRoomMembers",null),Dn([(0,Mt.P)()],Nn.prototype,"destroy",null),Nn=Dn([(0,Nt.b)(),Ln(0,(0,Bt.f)(Zr)),Ln(1,(0,Bt.f)(xt.zv)),Ln(2,(0,Bt.f)(xt.QX))],Nn),function(e){e.start="start",e.retry="retry",e.end="end",e.success="success",e.error="error",e.cancel="cancel",e.processDataStart="processDataStart",e.processDataError="processDataError",e.processDataEnd="processDataEnd"}(Cn||(Cn={})),function(e){e[e.processDataCrash=0]="processDataCrash",e[e.setCacheError=1]="setCacheError",e[e.getCacheError=2]="getCacheError",e[e.fetchError=3]="fetchError",e[e.validateError=4]="validateError"}(Rn||(Rn={})),function(e){e[e.SUCCESS=0]="SUCCESS",e[e.INVALID_SCHEMA_VERSION=2]="INVALID_SCHEMA_VERSION",e[e.DOWN_GRADE=1018]="DOWN_GRADE"}(An||(An={})),function(e){e[e.switch=0]="switch",e[e.merge=1]="merge"}(Tn||(Tn={})),function(e){e[e.Low=0]="Low",e[e.High=1]="High",e[e.Highest=2]="Highest"}(wn||(wn={})),function(e){e.NEW="NEW",e.HISTORY="HISTORY"}(On||(On={}));function Bn(e,t){var r="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!r){if(Array.isArray(e)||(r=function(e,t){if(!e)return;if("string"==typeof e)return xn(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);"Object"===r&&e.constructor&&(r=e.constructor.name);if("Map"===r||"Set"===r)return Array.from(e);if("Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r))return xn(e,t)}(e))||t&&e&&"number"==typeof e.length){r&&(e=r);var n=0,i=function(){};return{s:i,n:function(){return n>=e.length?{done:!0}:{done:!1,value:e[n++]}},e:function(e){throw e},f:i}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,s=!0,a=!1;return{s:function(){r=r.call(e)},n:function(){var e=r.next();return s=e.done,e},e:function(e){a=!0,o=e},f:function(){try{s||null==r.return||r.return()}finally{if(a)throw o}}}}function xn(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,n=new Array(t);r<t;r++)n[r]=e[r];return n}function Fn(e,t){var r,n=new Set,i=new Set,o=[],s="",a=function e(r){t[r].forEach((function(r){var n;if(r!==s&&(!i.has(r)&&(i.add(r),o.unshift(r),(null===(n=t[r])||void 0===n?void 0:n.size)>0)))return e(r)}))},c=Bn(e);try{for(c.s();!(r=c.n()).done;){var u,l=r.value;t[l]||i.has(l)?i.has(l)||(s=l,(null===(u=t[l])||void 0===u?void 0:u.size)>0&&(a(l),o.forEach((function(e){return n.add(e)}))),i.add(l),n.add(l),o.length=0):n.add(l)}}catch(e){c.e(e)}finally{c.f()}return Array.from(n)}function Pn(e,t,r){var n=!(arguments.length>3&&void 0!==arguments[3])||arguments[3];e[t]||(e[t]=new Set),n&&t===r||e[t].add(r)}function Un(e,t,r){if(!r)return new Set;var n=Fn([r],t),i=Fn([r],e);return new Set([].concat((0,p.Z)(n),(0,p.Z)(i)))}var Hn=r("vsh_67295"),Vn=r("vsh_22052"),Zn=r("vsh_19108"),jn=r("vsh_56489"),Gn=r("vsh_17494"),qn=r("vsh_80361"),zn=r("vsh_42958"),Wn=r("vsh_98085"),$n=r("vsh_69009"),Kn=r("vsh_95692"),Yn=r("vsh_99448"),Xn=r("vsh_75071"),Jn=r("vsh_54016"),Qn=r("vsh_4285"),ei=new Set([Cn.error,Cn.end,Cn.cancel]);function ti(e){return new Qn.y((function(t){var r,n=!1,i=e.retryConfig||{max:1},o=e.retryProvider,s=e.requestProvider,a=[],c=[];return t.next({type:Cn.start}),o((function(){var t,n=be(12)+"-"+(null===(t=window.User)||void 0===t?void 0:t.id),i=(0,Ir.M)(),o=(0,Or.Z)(e.requestConfig,{headers:{"Request-Id":n,"x-request-id":n,"x-tt-trace-id":i}});return a.push(n),c.push(i),(r="GET"===e.method?s.getRequest(e.url,o):("POST"===e.method?s.postRequest:s.putRequest)(e.url,e.params,o)).promise}),Object.assign({},i,{onRetry:function(e,r){var n;null===(n=i.onRetry)||void 0===n||n.call(i,e,r),t.next({type:Cn.retry,payload:{retryTime:e,error:r,requestIds:a,logIds:c}})}}))(void 0,void 0,{requestIds:a,logIds:c}).then((function(e){n=!0,t.next({type:Cn.end,payload:e.payload}),t.complete()})).catch((function(e){n=!0,t.next({type:Cn.error,payload:e}),t.complete()})),function(){n||r.source.cancel()}}))}var ri=function(){function e(){(0,a.Z)(this,e),this.signal=++e.signal}return(0,c.Z)(e,[{key:"cancel",value:function(){e.getCancelSource().next(this.signal)}}],[{key:"getCancelSource",value:function(){return e.cancel$}}]),e}();function ni(e,t){var r="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!r){if(Array.isArray(e)||(r=function(e,t){if(!e)return;if("string"==typeof e)return ii(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);"Object"===r&&e.constructor&&(r=e.constructor.name);if("Map"===r||"Set"===r)return Array.from(e);if("Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r))return ii(e,t)}(e))||t&&e&&"number"==typeof e.length){r&&(e=r);var n=0,i=function(){};return{s:i,n:function(){return n>=e.length?{done:!0}:{done:!1,value:e[n++]}},e:function(e){throw e},f:i}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,s=!0,a=!1;return{s:function(){r=r.call(e)},n:function(){var e=r.next();return s=e.done,e},e:function(e){a=!0,o=e},f:function(){try{s||null==r.return||r.return()}finally{if(a)throw o}}}}function ii(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,n=new Array(t);r<t;r++)n[r]=e[r];return n}ri.cancel$=new vr.xQ,ri.signal=1;var oi=new Set([Cn.error,Cn.success,Cn.cancel]),si=function(){function e(t){var r=this;(0,a.Z)(this,e),this.taskMode=f.AXv.runInBackground,this.task$=new vr.xQ,this.result$=new vr.xQ,this.cancel$=new vr.xQ,this.queue=[],this.pendingQueue=[],this.taskMap=new Map,this.mergedTaskMap=new Map,this.restRequestCount=t.parallelNum||10,this.limit=this.restTaskCount=t.limit||80,this.duration=t.duration||1e3,this.aggregate=t.aggregate,this.taskMode=t.taskMode||f.AXv.runInBackground,this.task$.pipe((0,jn.map)((function(){return r.getTask()})),(0,Gn.h)((function(e){return e.length>0})),(0,qn.zg)((function(e){return Hn.T.apply(void 0,(0,p.Z)(e.map((function(e){var n=r.mergedTaskMap.has(e);return ti(Object.assign({},e,{requestProvider:t.requestProvider,retryProvider:t.retryProvider})).pipe((0,jn.map)((function(t){return[e,t]})),(0,zn.R)(r.cancel$.pipe((0,Gn.h)((function(t){return!t||t===e.signal||!r.mergedTaskMap.has(e)&&n})))),(0,Wn.b)({complete:function(){r.pendingQueue=r.pendingQueue.filter((function(t){return t!==e})),r.restRequestCount++,r.task$.next()}}),(0,$n.K)((function(e){return(0,Vn.of)({type:Cn.error,payload:e})})))}))))}))).subscribe(this.result$),this.cancelSubscription=ri.getCancelSource().pipe((0,Kn.g)(1)).subscribe(this.cancel$),this.cancel$.pipe((0,Yn.b)((function(e){var t,n=[],i=ni(r.pendingQueue);try{for(i.s();!(t=i.n()).done;){var o=t.value;r.mergedTaskMap.has(o)?r.mergedTaskMap.get(o).forEach((function(t){t.signal!==e&&e||n.push([t,{type:Cn.cancel,originTask:t}])})):o.signal!==e&&e||n.push([o,{type:Cn.cancel,originTask:o}])}}catch(e){i.e(e)}finally{i.f()}return Vn.of.apply(void 0,n)}))).subscribe(this.result$),(0,Hn.T)(this.task$.pipe((0,qn.zg)((function(){return(0,Zn.H)(r.duration).pipe((0,Wn.b)((function(){r.restTaskCount=r.limit-r.latestTaskCount})))}))),this.task$.pipe((0,Xn.w)((function(){return(0,Zn.H)(r.duration+1).pipe((0,Wn.b)((function(){r.restTaskCount=r.limit})))})))).subscribe((function(){r.needContinue()&&r.task$.next()}))}return(0,c.Z)(e,[{key:"sort",value:function(){this.queue.sort((function(e,t){return Number(t.priority>e.priority)}))}},{key:"getTask",value:function(){var e=this;if(!this.needContinue())return[];for(var t=0,r=[],n=0;n<this.queue.length&&!(r.length>this.restTaskCount);n++){var i=this.queue[n];i.priority!==wn.Low&&(r.push(i),this.queue.splice(n,1),n--)}var o=new Set(r),s=[];try{if(this.aggregate){var a=this.aggregate(Array.from(o),this.restRequestCount);this.restRequestCount<a.size&&console.warn("mergedTaskMap.size must be less or equal to this.restRequestCount");var c,u=ni(a);try{var l=function(){var r=(0,ct.Z)(c.value,2),n=r[0],i=r[1];"signal"in n&&(delete n.signal,console.warn("It is illegal to set a signal to a merge task. The signal should remain on the original task.")),s.push(n),t+=i.size,e.restRequestCount--,e.mergedTaskMap.set(n,i),e.pendingQueue.push(n),i.forEach((function(t){e.taskMap.set(t,n),o.delete(t)}))};for(u.s();!(c=u.n()).done;)l()}catch(e){u.e(e)}finally{u.f()}}}catch(e){console.error(e)}return o.forEach((function(r){0!==e.restRequestCount&&(s.push(r),o.delete(r),e.pendingQueue.push(r),t++,e.restRequestCount--)})),o.size>0&&((0,f.hTd)(this.queue,o),this.sort()),this.latestTaskCount=t,this.restTaskCount=this.limit-this.latestTaskCount,s}},{key:"removeDependency",value:function(e){var t,r,n=this.taskMap.get(e);n&&(this.taskMap.delete(e),null===(t=this.mergedTaskMap.get(n))||void 0===t||t.delete(e),0===(null===(r=this.mergedTaskMap.get(n))||void 0===r?void 0:r.size)&&this.mergedTaskMap.delete(n))}},{key:"isTaskInProgress",value:function(e){var t=this;return this.pendingQueue.some((function(r){return r===e||r===t.taskMap.get(e)}))}},{key:"needContinue",value:function(){return 0!==this.restRequestCount&&0!==this.queue.length&&0!==this.restTaskCount&&(this.taskMode!==f.AXv.onDemand||this.queue.some((function(e){return e.priority!==wn.Low})))}},{key:"addTask",value:function(e){var t=this;return this.queue.push(e),clearTimeout(this.timerId),this.timerId=setTimeout((function(){t.sort(),t.task$.next()}),1),this.result$.pipe((0,Gn.h)((function(r){var n=(0,ct.Z)(r,1)[0];return n===e||n===t.taskMap.get(e)})),(0,Yn.b)((function(t){var r=(0,ct.Z)(t,2),n=(r[0],r[1]);return n.originTask=e,ei.has(n.type)?(0,Vn.of)(n,null):(0,Vn.of)(n)})),(0,Jn.o)((function(e){return null!==e})),(0,zn.R)(this.cancel$.pipe((0,Gn.h)((function(r){return!t.isTaskInProgress(e)&&(r===e.signal||void 0===r)})),(0,Wn.b)((function(){t.queue=t.queue.filter((function(t){return t!==e}))})))),(0,Wn.b)({complete:function(){t.removeDependency(e)}}))}},{key:"getTaskMode",value:function(){return this.taskMode}},{key:"cancel",value:function(){this.cancel$.next()}},{key:"getCancelSource$",value:function(){return this.cancel$}},{key:"destroy",value:function(){this.cancel(),this.cancelSubscription.unsubscribe(),this.cancel$.complete(),this.task$.complete(),this.taskMap.clear(),this.mergedTaskMap.clear(),this.aggregate=Y.default,this.result$.complete(),this.queue.length=this.pendingQueue.length=0,clearTimeout(this.timerId)}}]),e}(),ai=r("vsh_79828"),ci=r("vsh_50177"),ui=r("vsh_66624"),li=r("vsh_72764"),hi=r("vsh_62536"),di=function(){function e(t){var r=this;(0,a.Z)(this,e),this.curTask=new Set,this.task$=new vr.xQ,this.result$=new ai.t(1),this.queue=[],this.canSetCache=!1,this.mode=Tn.switch,this.taskQueue=new si(t),this.mode=t.mode||this.mode,this.canSetCache=!!t.canSetCache,this.task$.pipe((0,jn.map)((function(){return r.queue.filter((function(e){return e.priority!==wn.Low}))})),(0,Gn.h)((function(e){return!!e.length})),(0,Wn.b)((function(){r.queue=r.queue.filter((function(e){return e.priority===wn.Low}))})),(0,qn.zg)((function(e){return Hn.T.apply(void 0,(0,p.Z)(e.map((function(e){var t=r.getCache(e);return t?(t instanceof Qn.y||t instanceof Promise?(0,ci.D)(t):(0,Vn.of)(t)).pipe((0,Kn.g)(0,ui.e),(0,$n.K)((function(e){return r.checkCacheUsage(e)?(0,Vn.of)(e):(0,Vn.of)(null)})),(0,qn.zg)((function(t){return t?r.fromCache$(t,e):(r.logMessage("has no cache, will fromFetcher$ ",e.extensions),r.fromFetcher$(e))})),(0,jn.map)((function(t){return[e,t]}))):r.fromFetcher$(e).pipe((0,jn.map)((function(t){return[e,t]})))}))))}))).subscribe(this.result$),this.dataAdapterContext=t.dataAdapterContext}return(0,c.Z)(e,[{key:"createDeferProcessCacheSource",value:function(e,t){var r=this;return(0,li.P)((function(){try{var n=[],i=[],o=r.dataAdapter(e,t,!0,(function(e){i.push(e)}));return i.length>0&&n.push({type:Cn.processDataError,payload:t,errors:i,fromCache:!0,originTask:e}),n.push({type:Cn.success,fromCache:!0,payload:o,originalPayload:t,originTask:e}),Vn.of.apply(void 0,n)}catch(e){throw{type:Cn.error,payload:e,errorType:Rn.processDataCrash,fromCache:!0}}})).pipe((0,hi.O)({type:Cn.processDataStart,payload:t,fromCache:!0}))}},{key:"fromCache$",value:function(e,t){var r=this,n={type:Cn.start,fromCache:!0},i={type:Cn.end,fromCache:!0,payload:e};try{if(this.shouldValidateCache(t,e)){var o=this.validateResponse(t,e,!0);if(0!==o)return(0,Vn.of)(n,i,{type:Cn.error,payload:e,fromCache:!0,errorType:Rn.validateError,validateResult:o})}return this.shouldAdaptCache(e)?(0,li.P)((function(){return r.createDeferProcessCacheSource(t,e)})).pipe((0,hi.O)(n,i)):(0,Vn.of)(n,i,{type:Cn.success,fromCache:!0,payload:e,adaptedPayload:e,originTask:t})}catch(e){return this.logMessage("fromCache$ catch ".concat(e.message),e),(0,Vn.of)({type:Cn.error,payload:e,errorType:Rn.getCacheError,fromCache:!0,originTask:t})}}},{key:"fromFetcher$",value:function(e){var t=this;return this.taskQueue.addTask(e).pipe((0,qn.zg)((function(r){return r.type===Cn.end?(r.fromCache=!1,(0,li.P)((function(){var n=t.validateResponse(e,r.payload,!1);return 0!==n?(0,Vn.of)({type:Cn.error,payload:r.payload,fromCache:!1,errorType:Rn.validateError,validateResult:n}):(0,li.P)((function(){try{var n=[],i=t.dataAdapter(e,r.payload,!1,(function(e){n.push(e)})),o={type:Cn.success,payload:i,originalPayload:r.payload,fromCache:!1,originTask:e};return n.length?(0,Vn.of)({type:Cn.processDataError,payload:r.payload,errors:n,fromCache:!1,originTask:e},o):(0,Vn.of)(o)}catch(e){throw{type:Cn.error,payload:e,errorType:Rn.processDataCrash,fromCache:!1}}})).pipe((0,Wn.b)((function(r){if(r.type===Cn.success&&t.canSetCache)try{t.setCache(e,r.originalPayload,r.payload)}catch(e){throw{type:Cn.error,payload:e,errorType:Rn.setCacheError,fromCache:!1}}})),(0,hi.O)({payload:r.payload,type:Cn.processDataStart,fromCache:!1}))})).pipe((0,hi.O)(r))):(r.type===Cn.error&&(r.errorType=Rn.fetchError),r.type!==Cn.cancel&&(r.fromCache=!1),(0,Vn.of)(r))})),(0,$n.K)((function(e){return(0,Vn.of)(e)})),(0,Wn.b)({complete:function(){t.curTask.delete(e)}}))}},{key:"getData",value:function(){return this.getEvent$(this.result$).pipe((0,jn.map)((function(e){return(0,ct.Z)(e,2)[1]})))}},{key:"getTaskMode",value:function(){return this.taskQueue.getTaskMode()}},{key:"setPriority",value:function(e){e(this.queue),this.task$.next()}},{key:"cancel",value:function(){this.taskQueue.cancel(),this.queue.length=0}},{key:"getCancelSource$",value:function(){return this.taskQueue.getCancelSource$()}},{key:"destroy",value:function(){this.cancel(),this.clearCache(),this.curTask.clear(),this.task$.complete(),this.result$.complete(),this.result$=null,this.queue.length=0,this.taskQueue.destroy()}},{key:"checkCacheUsage",value:function(e){return!1}},{key:"loadData",value:function(e){return this.mode===Tn.switch&&this.cancel(),this.queue.push(e),this.task$.next(),this.curTask.add(e),this.getEvent$(this.result$.pipe((0,Gn.h)((function(t){return t[0]===e})),(0,Yn.b)((function(e){return oi.has(e[1].type)?(0,Vn.of)(e,null):(0,Vn.of)(e)})),(0,Jn.o)((function(e){return null!==e})))).pipe((0,jn.map)((function(e){return(0,ct.Z)(e,2)[1]})))}},{key:"logMessage",value:function(t){for(var r=arguments.length,n=new Array(r>1?r-1:0),i=1;i<r;i++)n[i-1]=arguments[i];e.LogFn.apply(e,[t].concat(n))}}]),e}();di.LogFn=function(e){for(var t,r=arguments.length,n=new Array(r>1?r-1:0),i=1;i<r;i++)n[i-1]=arguments[i];(t=console).log.apply(t,["[sheet][fetcher]",e].concat(n))};var fi,pi,vi=r("vsh_70098");!function(e){e.start="clientVarsStart",e.end="ClientVarsEnd",e.success="clientVarsSuccess",e.error="clientVarsError",e.retry="clientVarsRetry",e.cancel="clientVarsCancel",e.processDataStart="clientVarsProcessDataStart",e.processDataError="clientVarsProcessDataError"}(pi||(pi={}));var gi,yi=(fi={},(0,u.Z)(fi,Cn.start,pi.start),(0,u.Z)(fi,Cn.end,pi.end),(0,u.Z)(fi,Cn.success,pi.success),(0,u.Z)(fi,Cn.error,pi.error),(0,u.Z)(fi,Cn.retry,pi.retry),(0,u.Z)(fi,Cn.cancel,pi.cancel),(0,u.Z)(fi,Cn.processDataStart,pi.processDataStart),(0,u.Z)(fi,Cn.processDataError,pi.processDataError),fi),_i=function(e){function t(e){var r;return(0,a.Z)(this,t),(r=(0,Ue.Z)(this,(0,He.Z)(t).call(this,e))).cache=new Map,r.useV3Api=ye(),r.convertTableBlockEnable=!0,r.requestProvider=e.requestProvider,r.convertTableBlockEnable=e.convertTableBlockEnable,r}return(0,Ze.Z)(t,e),(0,c.Z)(t,[{key:"fetchV2",value:function(e,r){var n=Lr().stringify(Object.assign({sheet_id:e.sheetId||"",version:f.n0b.REF,open_type:e.openType,token:e.token,member_id:e.memberId,client_version:f.BxA},(0,l.default)(e.getClientVarsRequestExtraParams)?e.getClientVarsRequestExtraParams():{}));return this.loadData({url:"".concat(this.requestProvider.apiUrls.GET_CLIENT_VARS_V2,"?").concat(n),method:"GET",priority:wn.Highest,requestConfig:(0,Or.Z)({headers:{"Content-Type":"application/json","x-command":"api.sheet.rce.msg"},timeout:2e4},null==r?void 0:r.requestConfig),retryConfig:(0,Or.Z)({factor:t.retryFactor,interval:t.retryInterval,max:t.retryLimit},null==r?void 0:r.retryConfig),extensions:{token:e.token,memberId:e.memberId,openType:e.openType}})}},{key:"fetchV3",value:function(e,r){var n=(Array.isArray(e.sheetId)?e.sheetId[0]:e.sheetId)||"",i=Object.assign({memberId:e.memberId,schemaVersion:f.n0b.MUTATION,openType:e.openType,token:e.token,sheetRange:{sheetId:n},clientVersion:f.BxA},(0,l.default)(e.getClientVarsRequestExtraParams)?e.getClientVarsRequestExtraParams():{});return this.loadData({url:this.requestProvider.apiUrls.GET_SHEET_CLIENT_VARS_V3,method:"POST",priority:wn.Highest,params:i,requestConfig:(0,Or.Z)({headers:{"Content-Type":"application/json","x-command":"api.sheet.rce.msg"},timeout:2e4},null==r?void 0:r.requestConfig),retryConfig:(0,Or.Z)({factor:t.retryFactor,interval:t.retryInterval,max:t.retryLimit},null==r?void 0:r.retryConfig),extensions:{token:e.token,memberId:e.memberId,openType:e.openType}})}},{key:"fetch",value:function(e,t){return this.useV3Api&&!(0,f.pPK)()?this.fetchV3(e,t):this.fetchV2(e,t)}},{key:"checkCacheUsage",value:function(e){return!(e instanceof Error&&e.code===Number(f.D1r.ERROR_HYBRID_RESOURCE))}},{key:"getEvent$",value:function(e){var t=this;return e.pipe((0,Gn.h)((function(e){return e[1].type in yi})),(0,jn.map)((function(e){var r=(0,ct.Z)(e,2),n=r[0],i=r[1];return i.type===Cn.end&&i.payload&&i.payload.data&&(i.payload.data=t.transformClientVarsContent(i.payload,n)),[n,Object.assign({},i,{type:yi[i.type]})]})))}},{key:"dataAdapter",value:function(e,t,r,n){var i=t.data;if(i.code||i.token!==e.extensions.token)throw{ex:new Error("ClientVars code or token is invalid"),originalData:t};var o,s,a,c,u=i,l=this.getSnapshotFromClientVarsMessage(u);if(!l)throw{ex:new Error("ClientVars No Snapshot"),originalData:t};if(u.snapshot=l,u.extra_data){var h,d;if(u.extra_data.blocks=u.extra_data.blocks||[],this.convertTableBlockEnable||!this.convertTableBlockEnable&&u.version===f.n0b.OLD)o=Xe(u.extra_data.blocks,u.version,null===(h=this.dataAdapterContext)||void 0===h?void 0:h.dataAdaptMethod[f.Y6H.ungzipBlock].inflationMethod);else s=u.extra_data.blocks.map((function(e){return{startRowIndex:e.row,table:e.dataTable||(0,f.ecX)(e.gzip_datatable)}}));if(!(0,vi.Z)(u.extra_data.formula_blocks))a=Xe(u.extra_data.formula_blocks,3,null===(d=this.dataAdapterContext)||void 0===d?void 0:d.dataAdaptMethod[f.Y6H.ungzipFormulaCache].inflationMethod)}if((o||s)&&u.extra_data){delete u.extra_data.gzip_datatable;try{var p=u.extra_data.sheet_id;if(u.extra_data.row_count=(0,st.Z)(u.extra_data.blocks,(function(e,t){return e+t.row_count}),0),l)Re(p,l).data={dataTable:o,dataTableBlockInfos:s,formulaCacheTable:a}}catch(e){u.extra_data=null,n({ex:e,originData:t})}}u.version>=f.n0b.CS_GZIP&&(u.changeset_list=J(u.changeset_list,null===(c=this.dataAdapterContext)||void 0===c?void 0:c.dataAdaptMethod[f.Y6H.ungzipSnapshot].inflationMethod));if(!this.isChangeListValid(u))throw{ex:new Error("ClientVars Changeset List Revision Invalid"),originData:t};return i}},{key:"convertV3MutationToV2",value:function(e,t){var r=this.getClientVarsBizExtras(e,t),n=this.convertV3ClientVarsCore(e);return Object.assign({clientvars:n},r)}},{key:"getClientVarsBizExtras",value:function(e,t){var r=e.permissions,n=e.permStatusCode,i=e.token,o=e.authorized;return{title:"",token:i,permissions:r,permission_status_code:n,open_type:t.openType,member_id:t.memberId,readonly:!this.getIsEditable(r),authorized:o}}},{key:"getIsEditable",value:function(e){return!(!e||0===e.length)&&e.indexOf(ne.PERMISSION.EDITABLE)>-1}},{key:"convertV3ClientVarsCore",value:function(e){var t=e.snapshot,r=e.changesets,n=e.revision,i=e.serverTimestamp,o=e.showTemplate,s=e.schemaVersion,a=e.linkISV,c=e.status,u=e.sheetId;try{_e(t,u,s,n)}catch(t){throw{ex:t,message:"convertV3SnapshotToV2 fail",originalData:e}}var l={sheet_id:e.sheetId,blocks:null};return{snapshot:t,changeset_list:pe(r),extra_data:l,revision:this.convertToLatestVersion(n,r),server_timestamp:i,show_template:o,version:s,is_snapshot_copying:c===f.is3.Copying,link_ISV_sheets:a?ve(a):void 0}}},{key:"convertToLatestVersion",value:function(e,t){return t&&0!==t.length?t[t.length-1].revision:e}},{key:"isChangeListValid",value:function(e){var t=e.snapshot.rev||0;return e.changeset_list.every((function(e){return e.revision===++t}))&&t===e.revision}},{key:"getCache",value:function(e){return this.cache.get(e.extensions.token)||null}},{key:"setCache",value:function(e,t){this.mode===Tn.merge&&e.extensions.token&&this.cache.set(e.extensions.token,t)}},{key:"clearCache",value:function(){this.cache.clear()}},{key:"shouldValidateCache",value:function(e){return!0}},{key:"shouldAdaptCache",value:function(e){return!0}},{key:"validateResponse",value:function(e,t,r){return function(e,t){if(!se(t,e))return gi.DataCodeInvalid;if(ae(t).is_snapshot_copying)return gi.SnapshotCopying;return gi.OK}(e.extensions.token,t)}},{key:"setPreloadDataFeature",value:function(e,t){this.cache.set(e,t)}},{key:"remotePreloadDataFeature",value:function(e){this.cache.delete(e)}},{key:"getAdaptedErrorResponse",value:function(e,t){var r=e.payload,n=e.code,i={};if(r instanceof Error)i.code=(0,K.default)(r.code)?Number(ne.STATUS_CODE.JS_INTERNAL_ERROR):r.code,i.msg=r.message,i.data=r.data||{code:i.code};else{var o=parseInt(n,10);i.code=r.code||o,i.data=r.data||{code:r.code||o},i.msg=""}return"object"===(0,Qe.Z)(i.data)&&(0,K.default)(i.data.code)&&(i.data.code=i.code),i.data.code===ne.STATUS_CODE.INVALID_PARAMETERS&&(i.data.code=ne.STATUS_CODE.NOT_FOUND),i.fromCache=t,i}},{key:"gzipDataKeepEnable",value:function(e){return!1}},{key:"getSnapshotFromClientVarsMessage",value:function(e){var t;if(e.snapshot)return e.snapshot;var r=e.gzip_snapshot;return r?(t=(0,f.ecX)(r),this.gzipDataKeepEnable(e)||delete e.gzip_snapshot):(0,f.ji5)("error","ClientVars Invalid, No GZipSnapshot"),t}},{key:"transformClientVarsContent",value:function(e,t){var r,n=e.data,i=e.code;if(de(n)){if((0,f.pPK)()){var o=n.snapshot,s=n.revision,a=n.schemaVersion,c=n.sheetId;try{_e(o,c,a,s)}catch(e){throw{ex:e,message:"convertV3SnapshotToV2 fail",originalData:n}}return Object.assign({},n,{isCustomDataForShortcut:!0,extra_data:{sheet_id:c,blocks:null},version:f.n0b.MUTATION})}r=this.convertV3MutationToV2(n,t.extensions)}else if(he(n))r=n.formerlySchema;else{if(!ue(n))return n;r=n}return r.clientvars?{changeset_list:r.clientvars.changeset_list,snapshot:r.clientvars.snapshot,extra_data:r.clientvars.extra_data,revision:r.clientvars.revision,server_timestamp:r.clientvars.server_timestamp,show_template:r.clientvars.show_template,version:r.clientvars.version,gzip_snapshot:r.clientvars.gzip_snapshot,link_ISV_sheets:r.clientvars.link_ISV_sheets,is_snapshot_copying:r.clientvars.is_snapshot_copying,title:r.title,user_info:r.user_info,permission_status_code:r.permission_status_code,permissions:r.permissions,token:r.token,open_type:r.open_type,member_id:r.member_id,readonly:r.readonly,code:i,editable:!r.readonly,type:I.CLIENT_VARS,authorized:r.authorized}:n}}]),t}(di);_i.retryLimit=5,_i.retryInterval=1e3,_i.retryFactor=2,function(e){e[e.OK=0]="OK",e[e.DataCodeInvalid=1]="DataCodeInvalid",e[e.SnapshotCopying=2]="SnapshotCopying"}(gi||(gi={}));var ki,Ei,mi=["changesets"];!function(e){e.start="firstBlockStart",e.success="firstBlockSuccess",e.error="firstBlockError",e.retry="firstBlockRetry",e.cancel="firstBlockCancel",e.processDataStart="firstBlockProcessDataStart"}(Ei||(Ei={}));var Si,bi=(ki={},(0,u.Z)(ki,Cn.start,Ei.start),(0,u.Z)(ki,Cn.success,Ei.success),(0,u.Z)(ki,Cn.error,Ei.error),(0,u.Z)(ki,Cn.retry,Ei.retry),(0,u.Z)(ki,Cn.cancel,Ei.cancel),(0,u.Z)(ki,Cn.processDataStart,Ei.processDataStart),ki),Ci=function(e){function t(e){var r;return(0,a.Z)(this,t),(r=(0,Ue.Z)(this,(0,He.Z)(t).call(this,e))).cache=new Map,r.changesetsCache=new Map,r.useV3Api=ye(),r.requestProvider=e.requestProvider,r}return(0,Ze.Z)(t,e),(0,c.Z)(t,[{key:"fetchV2",value:function(e,t){return this.loadData({url:this.requestProvider.apiUrls.GET_SHEET_HISTORY_FIRST_V2,method:"GET",requestConfig:(0,Or.Z)({baseURL:this.requestProvider.prependAPI("/"),headers:(0,u.Z)({},U,q),params:Object.assign({type:0,token:e.token,rev:e.rev,last_rev:e.lastRev||e.rev,schema_version:f.jVu},e.sheet_id&&{sheet_id:e.sheet_id})},null==t?void 0:t.requestConfig),retryConfig:null==t?void 0:t.retryConfig})}},{key:"fetchV3",value:function(e,t){return this.loadData({url:this.requestProvider.apiUrls.GET_SHEET_HISTORY_FIRST_V3,method:"POST",params:e,requestConfig:(0,Or.Z)({headers:{"Content-Type":"application/json"},baseURL:this.requestProvider.prependAPI("/"),schemaVersion:f.n0b.MUTATION},null==t?void 0:t.requestConfig),retryConfig:null==t?void 0:t.retryConfig})}},{key:"fetch",value:function(e,t){return this.useV3Api?this.fetchV3(this.convertV3Params(e),t):this.fetchV2(e,t)}},{key:"convertV3Params",value:function(e){return Object.assign({revision:e.rev,schemaVersion:f.n0b.MUTATION,token:e.token},e.sheet_id&&{sheetRange:{sheetId:e.sheet_id}})}},{key:"getEvent$",value:function(e){return e.pipe((0,Gn.h)((function(e){return e[1].type in bi})),(0,jn.map)((function(e){var t=(0,ct.Z)(e,2),r=t[0],n=t[1];return[r,Object.assign({},n,{type:bi[n.type]})]})))}},{key:"dataAdapter",value:function(e,t){var r=t.data;if(de(r))return this.convertV3MutationToV2(r);he(r)&&(r=r.formerlySchema),r=r;var n=(0,f.ecX)(r.content_meta);delete r.content_meta;var i=r.changesets.map((function(e){return Object.assign({},e,{content:(0,f.ecX)(e.content)})}));r.blocks.length&&(Re(r.sheet_id,n).data={dataTable:Xe(r.blocks,r.data_version)});return Object.assign({},r,{changesets:i,snapshot:n})}},{key:"convertV3MutationToV2",value:function(e){var t=e.snapshot,r=e.schemaVersion,n=e.revision,i=e.sheetId,o=e.historyChangesets;try{_e(t,i,r,n)}catch(t){throw{ex:t,message:"convertV3SnapshotToV2 fail",originalData:e}}var s=[];if(o)try{s=e.historyChangesets.map((function(e){return{content:(0,f.ecX)(e.changeset.gzipContent),create_at:String(e.changeset.createTimestamp),revision:e.changeset.revision,user_id:String(e.changeset.userId)}}))}catch(t){throw{ex:t,message:"ungzip historyChangesets fail",originalData:e}}return{changesets:s,data_version:r,version:n,snapshot:t,sheet_id:i}}},{key:"getCache",value:function(e){for(var t,r=fe(e.requestConfig.schemaVersion)?e.params:null===(t=e.requestConfig)||void 0===t?void 0:t.params,n=r.rev,i=r.lastRev||n,o=100*Math.floor(n/100),s=[],a=i;a>=o;a--){if(this.cache.has(a))return Object.assign({},this.cache.get(a),{changesets:s});if(!this.changesetsCache.has(a))return null;s.unshift(this.changesetsCache.get(a))}return null}},{key:"setCache",value:function(e,t,r){var n,i=this,o=fe(e.requestConfig.schemaVersion)?e.params:null===(n=e.requestConfig)||void 0===n?void 0:n.params;if(this.mode===Tn.merge){var s,a=r.changesets,c=(0,Q.Z)(r,mi);this.cache.set(null!==(s=c.snapshot.rev)&&void 0!==s?s:o.rev,c),a.forEach((function(e){i.changesetsCache.set(e.revision,e)}))}}},{key:"clearCache",value:function(){this.cache.clear(),this.changesetsCache.clear()}},{key:"shouldValidateCache",value:function(e){return!1}},{key:"shouldAdaptCache",value:function(e){return!!e.data&&this.canSetCache}},{key:"validateResponse",value:function(e,t,r){return t.code}}]),t}(di);!function(e){e[e.OK=0]="OK",e[e.FAILED=1]="FAILED"}(Si||(Si={}));var Ri,Ai,Ti,wi,Oi=r("vsh_86982"),Ii=r("vsh_43369"),Di=r("vsh_96121");!function(e){e.start="subBlockStart",e.end="subBlockEnd",e.success="subBlockSuccess",e.error="subBlockError",e.cancel="subBlockCancel",e.retry="subBlockRetry",e.processDataStart="subBlockProcessDataStart"}(Ri||(Ri={})),function(e){e.subBlock="subBlock",e.formulaMeta="formulaMeta",e.formulaBlock="formulaBlock"}(Ai||(Ai={})),function(e){e[e.OK=0]="OK",e[e.NoBlocksCollection=1]="NoBlocksCollection",e[e.NoTargetBlockDataInCollection=2]="NoTargetBlockDataInCollection",e[e.NoBlockTokenFound=3]="NoBlockTokenFound"}(Ti||(Ti={}));var Li=(wi={},(0,u.Z)(wi,Cn.start,Ri.start),(0,u.Z)(wi,Cn.success,Ri.success),(0,u.Z)(wi,Cn.error,Ri.error),(0,u.Z)(wi,Cn.retry,Ri.retry),(0,u.Z)(wi,Cn.end,Ri.end),(0,u.Z)(wi,Cn.cancel,Ri.cancel),(0,u.Z)(wi,Cn.processDataStart,Ri.processDataStart),wi),Mi=new Set([Ri.error,Ri.success,Ri.cancel]),Ni=function(e){function t(e){var r;return(0,a.Z)(this,t),(r=(0,Ue.Z)(this,(0,He.Z)(t).call(this,e))).cache=new Map,r.convertTableBlockEnable=!0,r.requestProvider=e.requestProvider,r.convertTableBlockEnable=e.convertTableBlockEnable,r}return(0,Ze.Z)(t,e),(0,c.Z)(t,[{key:"fetch",value:function(e,t){return fe(e.schema_version)?this.fetchV3(e,t):this.fetchV2(e,t)}},{key:"fetchV3",value:function(e,r){var n=null!=r&&r.isHistory?this.requestProvider.apiUrls.GET_SHEET_HISTORY_BLOCK_V3:this.requestProvider.apiUrls.GET_SHEET_BLOCK_V3,i=(0,Ii.default)(e,["token"]);return this.loadData({url:n,method:"GET",retryConfig:null==r?void 0:r.retryConfig,requestConfig:(0,Or.Z)({baseURL:this.requestProvider.prependAPI("/"),params:(0,Oi.Z)(e,["token","block_token","schema_version"])},null==r?void 0:r.requestConfig),signal:null==r?void 0:r.signal,extensions:i,priority:null==r?void 0:r.priority}).pipe((0,Yn.b)((function(r){return Mi.has(r.type)?(r.type===Ri.error&&r.errorType===Rn.fetchError&&(r.requestContext=t.getRequestContext(e,r)),(0,Vn.of)(r,null)):(0,Vn.of)(r)})),(0,Jn.o)((function(e){return null!==e})))}},{key:"fetchV2",value:function(e,r){return this.loadData({url:this.requestProvider.apiUrls.getSheetSubblocksUrl(),method:"GET",retryConfig:e.type===Ai.formulaMeta||e.type===Ai.formulaBlock?(0,Or.Z)({exceedSilent:!0},null==r?void 0:r.retryConfig):null==r?void 0:r.retryConfig,requestConfig:(0,Or.Z)({baseURL:this.requestProvider.prependAPI("/"),params:(0,Oi.Z)(e,["token","block_token","schema_version"]),headers:(0,u.Z)({},U,Z)},null==r?void 0:r.requestConfig),signal:null==r?void 0:r.signal,extensions:(0,Ii.default)(e,["token"]),priority:null==r?void 0:r.priority}).pipe((0,Yn.b)((function(r){return Mi.has(r.type)?(r.type===Ri.error&&r.errorType===Rn.fetchError&&(r.requestContext=t.getRequestContext(e,r)),(0,Vn.of)(r,null)):(0,Vn.of)(r)})),(0,Jn.o)((function(e){return null!==e})))}},{key:"getEvent$",value:function(e){return e.pipe((0,Gn.h)((function(e){return e[1].type in Li})),(0,jn.map)((function(e){var t=(0,ct.Z)(e,2),r=t[0],n=t[1],i={sheetId:r.extensions.sheetId,blockToken:r.extensions.block_token,blockType:r.extensions.type,priority:r.priority};return n.type===Cn.start||n.type===Cn.end?[r,Object.assign({},n,{type:Li[n.type],payload:i})]:[r,Object.assign({},n,{type:Li[n.type],identity:i})]})),(0,Di.B)())}},{key:"dataAdapter",value:function(e,t,r){return fe(e.extensions.schema_version)?this.dataAdapterV3(e,t,r):this.dataAdapterV2(e,t,r)}},{key:"dataAdapterV3",value:function(e,t,r){var n=e.extensions,i={sheetId:n.sheetId,data:{block_token:n.block_token,startRowIndex:n.info.startRowIndex,range:n.info.range,blockVersion:n.schema_version}},o=t.data.blocks[n.block_token];return i.data.blockData=o,i}},{key:"dataAdapterV2",value:function(e,t,r){var n,i=e.extensions;if(i.type===Ai.subBlock){var o,s=t.data.blocks.find((function(e){return e.block_token===i.block_token})),a={sheetId:i.sheetId,data:{block_token:i.block_token,startRowIndex:i.info.startRowIndex}};if(s.dataTable||s.blockData||!s.gzip_datatable)a.data.rowData=s.dataTable,a.data.blockData=s.blockData;else{var c,l=((null===(c=this.dataAdapterContext)||void 0===c?void 0:c.dataAdaptMethod[f.Y6H.ungzipBlock].bufferInflationMethod)||f.yGW)(s.gzip_datatable);o=l.buffer,a.data.blockDataBuffer=o;var h=l.result;this.convertTableBlockEnable?(a.data.rowData=(0,f.Bep)(h,i.info.startRowIndex),a.data.blockData=void 0):(a.data.rowData=void 0,a.data.blockData=h,s.startRowIndex=i.info.startRowIndex),s.dataTable=a.data.rowData,s.blockData=a.data.blockData,this.gzipDataKeepEnable(s)||delete s.gzip_datatable}return a}var d=(null===(n=this.dataAdapterContext)||void 0===n?void 0:n.dataAdaptMethod[f.Y6H.ungzipBlock].inflationMethod)||f.ecX,p=t.data.blocks.filter((function(e){return e.block_token===i.block_token})).map((function(e){return d(e.gzip_datatable)}));return{sheetId:i.sheetId,data:(0,u.Z)({block_token:i.block_token},i.type===Ai.formulaMeta?"formulaMetas":"formulaBlocks",p)}}},{key:"getCache",value:function(e){return this.cache.get(e.extensions.block_token)||null}},{key:"setCache",value:function(e,t,r){this.mode===Tn.merge&&this.cache.set(e.extensions.block_token,t)}},{key:"clearCache",value:function(){this.cache.clear()}},{key:"shouldValidateCache",value:function(e,t){return Bi(t)}},{key:"shouldAdaptCache",value:function(e){return Bi(e)}},{key:"validateResponse",value:function(e,t,r){if(!e.extensions)return Ti.NoBlockTokenFound;if(e.extensions.type!==Ai.subBlock&&!t)return Ti.NoBlocksCollection;if(!Bi(t))return Ti.OK;if(!(t&&t.data&&t.data.blocks))return Ti.NoBlocksCollection;var n=e.extensions.block_token;return(Array.isArray(t.data.blocks)?t.data.blocks.some((function(e){return e.block_token===n})):!!t.data.blocks[n])?Ti.OK:Ti.NoTargetBlockDataInCollection}},{key:"setPreloadDataFeature",value:function(e,t){this.cache.set(e,t)}},{key:"gzipDataKeepEnable",value:function(e){return!1}}],[{key:"getRequestContext",value:function(e,t){var r,n,i,o=t.payload,s=t.identity,a=e.schema_version;return(i=o)&&i.code===f.D1r.ERROR_RETRY_EXCEED&&function(e){return e instanceof Error&&!(0,K.default)(e.code)}(o.payload)?{requestId:(0,y.default)(o,"payload.config.requestId"),schemaVersion:a,blockToken:(0,y.default)(o,"payload.config.params.block_token"),code:o.code}:{requestId:(null===(r=o.customErrorInfo)||void 0===r||null===(n=r.requestIds)||void 0===n?void 0:n.join(""))||"",code:o.payload.code,schemaVersion:a,blockToken:s.blockToken}}}]),t}(di);function Bi(e){return!!e&&!(0,K.default)(e.code)&&e.data&&e.data.blocks}var xi,Fi,Pi,Ui=r("vsh_90786");!function(e){e[e.OK=0]="OK",e[e.NoBlocksCollection=1]="NoBlocksCollection",e[e.NoTargetBlockDataInCollection=2]="NoTargetBlockDataInCollection",e[e.NoTokenFound=3]="NoTokenFound"}(Fi||(Fi={})),function(e){e.start="formulaMetaStart",e.retry="formulaMetaRetry",e.cancel="formulaMetaCancel",e.success="formulaMetaSuccess",e.error="formulaMetaError",e.processDataStart="formulaMetaProcessDataStart"}(Pi||(Pi={}));var Hi,Vi,Zi=(xi={},(0,u.Z)(xi,Cn.start,Pi.start),(0,u.Z)(xi,Cn.success,Pi.success),(0,u.Z)(xi,Cn.error,Pi.error),(0,u.Z)(xi,Cn.retry,Pi.retry),(0,u.Z)(xi,Cn.cancel,Pi.cancel),(0,u.Z)(xi,Cn.processDataStart,Pi.processDataStart),xi),ji=function(e){function t(e){var r;return(0,a.Z)(this,t),(r=(0,Ue.Z)(this,(0,He.Z)(t).call(this,e))).cache=new Map,r.requestProvider=e.requestProvider,r}return(0,Ze.Z)(t,e),(0,c.Z)(t,[{key:"extractPreloadedFormulaBlocks",value:function(e){var t,r=[];e.forEach((function(e){var t=e.formula_cache_meta.blocks.map((function(e){return e.token})),n=e.formula_cache_datas.map((function(e){return e.block_token})),i=(0,Ui.Z)(t,n);r=[].concat((0,p.Z)(r),(0,p.Z)(i))}));var n=(null===(t=this.dataAdapterContext)||void 0===t?void 0:t.dataAdaptMethod[f.Y6H.ungzipFormulaCache].bufferInflationMethod)||f.yGW;return{formulaBlockTokensToFetch:r,formulaBlocks:e.map((function(e){return e.formula_cache_datas})).flat().map((function(e){var t=n(e.gzip_datatable);return{block_token:e.block_token,data:t.result,blockDataBuffer:t.buffer}}))}}},{key:"fetch",value:function(e,t){return this.loadData({url:"".concat(this.requestProvider.apiUrls.FORMULA_CACHE),method:"GET",requestConfig:(0,Or.Z)({baseURL:this.requestProvider.prependAPI("/"),params:(0,Oi.Z)(e,["token","block_token","schema_version"]),headers:(0,u.Z)({},U,"api.v2.sheet.formula_cache")},null==t?void 0:t.requestConfig),extensions:(0,Oi.Z)(e,["block_token","sheetId"]),retryConfig:(0,Or.Z)({exceedSilent:!0},null==t?void 0:t.retryConfig)})}},{key:"getEvent$",value:function(e){return e.pipe((0,Gn.h)((function(e){return e[1].type in Zi})),(0,jn.map)((function(e){var t=(0,ct.Z)(e,2),r=t[0],n=t[1],i={sheetId:r.extensions.sheetId||"",blockToken:r.extensions.block_token||"",priority:r.priority};return[r,Object.assign({},n,{type:Zi[n.type],identity:i})]})))}},{key:"dataAdapter",value:function(e,t,r,n){var i,o,s=(null===(i=e.extensions)||void 0===i?void 0:i.sheetId)||"",a=(null===(o=e.extensions)||void 0===o?void 0:o.block_token)||"",c=(t.data.formula_cache_infos||[]).filter((function(e){return e.block_token===a})),u=this.extractPreloadedFormulaBlocks(c),l=u.formulaBlockTokensToFetch,h=u.formulaBlocks;return{sheetId:s,data:{block_token:a,formulaMetas:c.map((function(e){return e.formula_cache_meta}))},extra:{formulaBlocksToFetch:l,formulaBlocksInfo:h.map((function(e){return Object.assign({},e,{formulaBlock:e.data})}))}}}},{key:"getCache",value:function(e){return this.cache.get(e.extensions.block_token)||null}},{key:"setCache",value:function(e,t){this.mode===Tn.merge&&this.cache.set(null==e?void 0:e.extensions.block_token,t)}},{key:"clearCache",value:function(){this.cache.clear()}},{key:"shouldValidateCache",value:function(e,t){return!1}},{key:"shouldAdaptCache",value:function(e){return!!e.data.formula_cache_infos&&this.canSetCache}},{key:"validateResponse",value:function(e,t,r){return t?Fi.OK:Fi.NoBlocksCollection}}]),t}(di);!function(e){e.start="formulaBlockStart",e.retry="formulaBlockRetry",e.cancel="formulaBlockCancel",e.success="formulaBlockSuccess",e.error="formulaBlockError",e.processDataStart="formulaBlockProcessDataStart"}(Vi||(Vi={}));var Gi,qi=(Hi={},(0,u.Z)(Hi,Cn.start,Vi.start),(0,u.Z)(Hi,Cn.success,Vi.success),(0,u.Z)(Hi,Cn.error,Vi.error),(0,u.Z)(Hi,Cn.retry,Vi.retry),(0,u.Z)(Hi,Cn.cancel,Vi.cancel),(0,u.Z)(Hi,Cn.processDataStart,Vi.processDataStart),Hi);!function(e){e[e.OK=0]="OK",e[e.NoBlocksCollection=1]="NoBlocksCollection",e[e.NoTargetBlockDataInCollection=2]="NoTargetBlockDataInCollection",e[e.NoTokenFound=3]="NoTokenFound"}(Gi||(Gi={}));var zi=function(e){function t(e){var r;return(0,a.Z)(this,t),(r=(0,Ue.Z)(this,(0,He.Z)(t).call(this,e))).cache=new Map,r.requestProvider=e.requestProvider,r}return(0,Ze.Z)(t,e),(0,c.Z)(t,[{key:"fetchV2",value:function(e,t){return this.loadData({url:"".concat(this.requestProvider.apiUrls.FORMULA_CACHE_DATA),method:"GET",requestConfig:(0,Or.Z)({baseURL:this.requestProvider.prependAPI("/"),params:(0,Oi.Z)(e,["token","block_token","schema_version"]),headers:(0,u.Z)({},U,"api.v2.sheet.formula_cache_data")},null==t?void 0:t.requestConfig),extensions:(0,Oi.Z)(e,["block_token","sheetId"]),retryConfig:(0,Or.Z)({exceedSilent:!0},null==t?void 0:t.retryConfig)})}},{key:"fetchV3",value:function(e,t){return this.loadData({url:this.requestProvider.apiUrls.GET_SHEET_FORMULA_BLOCK_V3,method:"GET",requestConfig:(0,Or.Z)({baseURL:this.requestProvider.prependAPI("/"),params:(0,Oi.Z)(e,["token","block_token"])},null==t?void 0:t.requestConfig),extensions:(0,Oi.Z)(e,["block_token","sheetId"]),retryConfig:(0,Or.Z)({exceedSilent:!0},null==t?void 0:t.retryConfig)})}},{key:"fetch",value:function(e,t){return fe(e.schema_version)?this.fetchV3(e,t):this.fetchV2(e,t)}},{key:"getEvent$",value:function(e){return e.pipe((0,Gn.h)((function(e){return e[1].type in qi})),(0,jn.map)((function(e){var t=(0,ct.Z)(e,2),r=t[0],n=t[1];return[r,Object.assign({},n,{type:qi[n.type]})]})))}},{key:"dataAdapter",value:function(e,t,r,n){var i,o,s,a=(null===(i=e.extensions)||void 0===i?void 0:i.sheetId)||"",c=(null===(o=e.extensions)||void 0===o?void 0:o.block_token)||"",u=[],l=(null===(s=this.dataAdapterContext)||void 0===s?void 0:s.dataAdaptMethod[f.Y6H.ungzipFormulaCache].bufferInflationMethod)||f.yGW;if(t.data.formula_cache_datas){var h=t.data.formula_cache_datas.filter((function(e){return e.block_token===c})).map((function(e){var t=l(e.gzip_datatable);return{formulaBlock:t.result,blockDataBuffer:t.buffer}}));u.push({block_token:c,formulaBlock:h.length>0?h[0].formulaBlock:null,blockDataBuffer:h.length>0?h[0].blockDataBuffer:void 0})}else if(t.data.blocks){var d=t.data.blocks[c],p=l(d);u.push({block_token:c,formulaBlock:p.result,blockDataBuffer:p.buffer})}return{sheetId:a,data:u}}},{key:"getCache",value:function(e){return this.cache.get(null==e?void 0:e.extensions.block_token)||null}},{key:"setCache",value:function(e,t,r){this.mode===Tn.merge&&this.cache.set(null==e?void 0:e.extensions.block_token,r)}},{key:"clearCache",value:function(){this.cache.clear()}},{key:"shouldValidateCache",value:function(e,t){return!1}},{key:"shouldAdaptCache",value:function(e){return!!e.data.formula_cache_datas&&this.canSetCache}},{key:"validateResponse",value:function(e,t,r){return t?Gi.OK:Gi.NoBlocksCollection}}]),t}(di),Wi=r("vsh_64026"),$i=r("vsh_22362"),Ki=r("vsh_49457"),Yi=r("vsh_91903"),Xi=r("vsh_21183");function Ji(e,t){var r=t.split("_"),n=r[0],i=r[r.length-1],o=parseInt(i,10);if(isNaN(o))return null;var s=e[n];return s?[n,s[o]||[]]:null}var Qi=function(e){return null!==e};function eo(e,t){var r="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!r){if(Array.isArray(e)||(r=function(e,t){if(!e)return;if("string"==typeof e)return to(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);"Object"===r&&e.constructor&&(r=e.constructor.name);if("Map"===r||"Set"===r)return Array.from(e);if("Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r))return to(e,t)}(e))||t&&e&&"number"==typeof e.length){r&&(e=r);var n=0,i=function(){};return{s:i,n:function(){return n>=e.length?{done:!0}:{done:!1,value:e[n++]}},e:function(e){throw e},f:i}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,s=!0,a=!1;return{s:function(){r=r.call(e)},n:function(){var e=r.next();return s=e.done,e},e:function(e){a=!0,o=e},f:function(){try{s||null==r.return||r.return()}finally{if(a)throw o}}}}function to(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,n=new Array(t);r<t;r++)n[r]=e[r];return n}var ro,no=3,io=1e3,oo=2;!function(e){e.start="splitDataStart",e.relationAnalyzed="splitDataRelationAnalyzed",e.subBlockFetchPrepared="splitDataSubBlockFetchPrepared",e.sheetStartLoad="splitDataSheetStartLoad",e.subBlockLoaded="splitDataSubBlockLoaded",e.formulaMetaLoaded="splitDataFormulaMetaLoaded",e.formulaMetaEmpty="splitDataFormulaMetaEmpty",e.formulaBlockLoaded="splitDataFormulaBlockLoaded",e.success="splitDataSuccess",e.error="splitDataError",e.cancel="splitDataCancel"}(ro||(ro={}));var so=new Set([Ri.error,Ri.success,Ri.cancel]),ao=new Set([ro.error,ro.success,ro.cancel]),co=new Set([Vi.error,Vi.success,Vi.cancel]),uo=new Set([Pi.error,Pi.success,Pi.cancel]);function lo(e){if(!e)return!1;for(var t in e)return!1;return!0}var ho=function(){function e(t){var r=this;if((0,a.Z)(this,e),this.mode=Tn.switch,this.useTTUOptimizationQ2=!1,this.params$=new vr.xQ,this.result$=new ai.t(2),this.cancelControllerMap=new Map,"subBlockFetcher"in t){if(t.subBlockFetcher.mode!==Tn.merge)throw new Error("subBlockFetcher must be merge mode!");if(this.subBlockFetcher=t.subBlockFetcher,t.formulaMetaFetcher.mode!==Tn.merge)throw new Error("formulaMetaFetcher must be merge mode!");if(t.formulaBlockFetcher.mode!==Tn.merge)throw new Error("formulaBlockFetcher must be merge mode!");this.formulaMetaFetcher=t.formulaMetaFetcher,this.formulaBlockFetcher=t.formulaBlockFetcher}else{var n={mode:Tn.merge,requestProvider:t.requestProvider,retryProvider:t.retryProvider,parallelNum:t.parallelNum,limit:t.limit,taskMode:t.taskMode,canSetCache:t.canSetCache,convertTableBlockEnable:!!t.convertTableBlockEnable,aggregate:function(e,t){for(var r=[],n=0;n<e.length;n++){if(0===r.length||r[r.length-1].length>=20){if(r.length>=t)break;r.push([])}r[r.length-1].push(e[n])}return r.reduce((function(e,t){var r=t.map((function(e){return e.requestConfig.params.block_token})),n=r.join(","),i=t[0];return i.requestConfig.params.blockIds=r,i.requestConfig.params.block_token=n,delete i.signal,e.set(i,new Set(t)),e}),new Map)},dataAdapterContext:t.dataAdapterContext};this.subBlockFetcher=new Ni(n),this.formulaMetaFetcher=new ji(n),this.formulaBlockFetcher=new zi(n)}this.subBlocksToFetch=t.subBlocksToFetch,this.mode=t.mode||this.mode,this.useTTUOptimizationQ2=t.useTTUOptimizationQ2||this.useTTUOptimizationQ2,this.params$.pipe((0,Ki.g)("noBlockSheets"),(0,Kn.g)(0,ui.e),(0,Gn.h)((function(e){return e.noBlockSheets.size>0})),(0,Yn.b)((function(e){var t=e.originParams,r=e.noBlockSheets,n=e.subBlockParams,i=e.formulaMetaParams,o=Array.from(r).map((function(e){return{type:ro.subBlockLoaded,payload:{sheetId:e,data:null}}}));return 0===n.length&&0===i.length&&o.push({type:ro.success}),Vn.of.apply(void 0,(0,p.Z)(o)).pipe((0,jn.map)((function(e){return{event:e,originParams:t}})))}))).subscribe(this.result$),this.params$.pipe((0,Ki.g)("subBlockParams"),(0,qn.zg)((function(e){var t=e.originParams,n=e.subBlockParams,i=e.formulaMetaParams,o={type:ro.subBlockFetchPrepared};r.setSubBlockTokenTimeStamp(Date.now());var s=n.map((function(e){var n;return(n=r.subBlockFetcher).fetch.apply(n,(0,p.Z)(e)).pipe((0,Wn.b)((function(n){so.has(n.type)&&r.removeCancelController(t,e[1].signal)})),(0,Yn.b)((function(e){return e.type===Ri.success?(0,Vn.of)(e,{type:ro.subBlockLoaded,payload:e.payload}):(0,Vn.of)(e)})))}));return 0===i.length&&s.push((0,$i.D)((0,p.Z)(s)).pipe((0,Gn.h)((function(e){return e.every((function(e){return e.type===ro.subBlockLoaded}))})),(0,Yi.h)({type:ro.success}))),Hn.T.apply(void 0,[(0,Vn.of)(o)].concat((0,p.Z)(s))).pipe((0,jn.map)((function(e){return{event:e,originParams:t}})))}))).subscribe(this.result$),this.params$.pipe((0,Ki.g)("formulaBlockV3Params"),(0,qn.zg)((function(e){var t=e.originParams,n=e.formulaBlockV3Params,i=(e.extraConfig,Date.now()),o=n.reduce((function(e,t){var r=t[0],n=r.sheetId,i=r.block_token;return e[n]||(e[n]={tokens:new Set,data:[]}),e[n].tokens.add(i),e}),{});return Hn.T.apply(void 0,(0,p.Z)(n.map((function(e){var n;return(n=r.formulaBlockFetcher).fetch.apply(n,(0,p.Z)(e)).pipe((0,Wn.b)((function(n){co.has(n.type)&&r.removeCancelController(t,e[1].signal)})))})))).pipe((0,qn.zg)((function(e){var t=[];if(e.type===Vi.success){var r=e.payload,n=r.sheetId,s=r.data;if((0,f.hTd)(o[n].data,s),s.forEach((function(e){o[n].tokens.delete(e.block_token)})),0===o[n].tokens.size){var a=Object.values(o).every((function(e){return!e.tokens.size}));t.push({type:ro.formulaBlockLoaded,payload:{sheetId:n,data:o[n].data,isLastBlock:a,formulaTimeCost:Date.now()-i}}),a&&t.push({type:ro.success})}}return Vn.of.apply(void 0,t)})),(0,Gn.h)(Qi),(0,jn.map)((function(e){return{originParams:t,event:e}})))}))).subscribe(this.result$),this.params$.pipe((0,Ki.g)("formulaMetaParams"),(0,qn.zg)((function(e){var t=e.originParams,n=e.formulaMetaParams,i=e.extraConfig,o=Date.now(),s=n.reduce((function(e,t){var r=(0,ct.Z)(t,1)[0];return e[r.sheetId]=e[r.sheetId]||{tokens:new Set,data:[]},e[r.sheetId].tokens.add(r.block_token),e}),{}),a=function(e){return Object.values(e).every((function(e){return 0===e.tokens.size}))};return Hn.T.apply(void 0,(0,p.Z)(n.map((function(e){var n;return(n=r.formulaMetaFetcher).fetch.apply(n,(0,p.Z)(e)).pipe((0,Wn.b)((function(n){uo.has(n.type)&&r.removeCancelController(t,e[1].signal)})))})))).pipe((0,Yn.b)((function(e){if(e.type===Pi.success&&(console.info("[SHEET LOG] splitDataFetcher: FormulaMetaStatus.success palyload data",e.payload.data),e.payload.data.formulaMetas.some((function(e){return 0===e.blocks.length}))))return(0,Vn.of)({type:ro.formulaMetaEmpty},{type:ro.success});return(0,Vn.of)(e)}))).pipe((0,qn.zg)((function(e){var n=[];if(e.type===Pi.success){var c=e.payload,u=c.sheetId,l=c.data,h=c.extra,d=l.block_token,v=l.formulaMetas,g=h.formulaBlocksToFetch,y=h.formulaBlocksInfo,_=s[u];return _?(g.forEach((function(e){return _.tokens.add(e)})),y.forEach((function(e){var t=e.formulaBlock,r=e.block_token,n=e.blockDataBuffer;return _.data.push({formulaBlock:t,block_token:r,blockDataBuffer:n})})),_.tokens.delete(d),(0,f.hTd)(n,[e],v.map((function(e){return{type:ro.formulaMetaLoaded,payload:{sheetId:u,data:e}}}))),0===g.length&&_.data.length>0&&n.push({type:ro.formulaBlockLoaded,payload:{sheetId:u,data:_.data,isLastBlock:a(s),formulaTimeCost:Date.now()-o}}),a(s)&&n.push({type:ro.success}),Hn.T.apply(void 0,[Vn.of.apply(void 0,n)].concat((0,p.Z)(g.map((function(n){var c=new ri;return r.addCancelController(t,c),r.formulaBlockFetcher.fetch({block_token:n,sheetId:u,token:t.token,schema_version:t.schema_version},Object.assign({},i,{priority:e.identity.priority,signal:c.signal})).pipe((0,Wn.b)((function(e){co.has(e.type)&&r.removeCancelController(t,c.signal)})),(0,Yn.b)((function(e){e.type===Vi.success&&(s[u].tokens.delete(n),(0,f.hTd)(s[u].data,e.payload.data));var t=[];if(t.push(e),0===s[u].tokens.size){var r=a(s);t.push({type:ro.formulaBlockLoaded,payload:{sheetId:u,data:s[u].data,isLastBlock:r,formulaTimeCost:Date.now()-o}}),r&&t.push({type:ro.success})}return Vn.of.apply(void 0,t)})))})))))):(0,Vn.of)(null)}return(0,Vn.of)(e)})),(0,Gn.h)(Qi),(0,jn.map)((function(e){return{originParams:t,event:e}})))}))).subscribe(this.result$),this.result$.pipe((0,Gn.h)((function(e){var t=e.event;return[Ri.error,Ri.cancel,Pi.error,Pi.cancel,Vi.error,Vi.cancel].includes(t.type)})),(0,Ki.g)("originParams"),(0,Kn.g)(0,ui.e),(0,Wn.b)((function(e){var t,n=e.originParams;null===(t=r.cancelControllerMap.get(n))||void 0===t||t.forEach((function(e){return e.cancel()}))})),(0,jn.map)((function(e){var t=e.originParams,r=e.event;return[Ri.cancel,Pi.cancel,Vi.cancel].includes(r.type)?{originParams:t,event:{type:ro.cancel}}:{originParams:t,event:Object.assign({},r,{type:ro.error})}}))).subscribe(this.result$),this.result$.pipe((0,Gn.h)((function(e){var t=e.event;return t.type===Ri.start&&t.payload&&t.payload.blockType===Ai.subBlock})),(0,Xi.E)((function(e){return e.event.payload.sheetId}),this.subBlockFetcher.getCancelSource$()),(0,jn.map)((function(e){var t=e.originParams,r=e.event;return{originParams:t,event:{type:ro.sheetStartLoad,payload:r.payload.sheetId}}}))).subscribe(this.result$)}return(0,c.Z)(e,[{key:"addCancelController",value:function(e,t){this.cancelControllerMap.has(e)||this.cancelControllerMap.set(e,new Set),this.cancelControllerMap.get(e).add(t)}},{key:"removeCancelController",value:function(e,t){if(this.cancelControllerMap.has(e)){var r,n=this.cancelControllerMap.get(e),i=eo(n);try{for(i.s();!(r=i.n()).done;){var o=r.value;o.signal===t&&n.delete(o)}}catch(e){i.e(e)}finally{i.f()}0===n.size&&this.cancelControllerMap.delete(e)}}},{key:"setSubBlockTokenTimeStamp",value:function(e){this.subBlockTokenTimeStamp=e}},{key:"getSubBlockTokenTimeStamp",value:function(){return this.subBlockTokenTimeStamp}},{key:"defaultShouldRetry",value:function(e){return!e||e instanceof Error||e.code!==An.SUCCESS}},{key:"getSheetBlock",value:function(e){var t=e.snapshot.sheets,r=Object.keys(t||{}),n=new Set,i={},o={},s=""!==(0,f.eYO)("no_ssc")||!1===e.isFetchFormulaMeta,a=Number((0,f.eYO)("formula_cache_version"));(isNaN(a)||0===a)&&(a=f.u9N);for(var c=0,u=r;c<u.length;c++){var l=t[u[c]],h=l.id,d=this.subBlocksToFetch?this.subBlocksToFetch[h]:l.blocks;!s&&l.formulaCache&&l.formulaCache.token!==f.Nfu&&l.formulaCache.version===a&&(i[h]=l.formulaCache.token),null!=d&&d.length?o[h]=(0,ut.Z)(d,"token"):n.add(h)}return{noBlockSheets:n,sheetBlocks:o,sheetFormulaCache:i}}},{key:"getDependency",value:function(e,t){var r,n=this,i=Object.values(e.snapshot.sheets||{}),o=null===(r=e.snapshot.extra)||void 0===r?void 0:r.reference,s=(null==o?void 0:o.dependency)||{},a=function(e,t){var r={},n={};return e.forEach((function(e){var i=e.blocks||[],o=[];i.forEach((function(r){if(r.token){for(var i=r,s=Math.floor(i.startRowIndex/t),a=Math.floor((i.startRowIndex+i.rowsCount-1)/t),c=s;c<=a;c++)o[c]=o[c]||[],o[c].push(i.token);n[i.token]=e.id}else{for(var u=r,l=Math.floor(u.range.rowStart/t),h=Math.floor((u.range.rowEnd-1)/t),d=l;d<=h;d++)o[d]=o[d]||[],o[d].push(u.blockId);n[u.blockId]=e.id}})),r[e.id]=o})),{pBlockMap:r,pBlockToSheetIdMap:n}}(i,(null==o?void 0:o.size)||f.B$J),c=a.pBlockMap,u=a.pBlockToSheetIdMap,l={},h={},d={},p=(0,Wi.Z)(t,(function(e){return new Set(Object.keys(e))})),v=function(e){var t=Ji(c,e);if(null===t)return"continue";var r=(0,ct.Z)(t,2),n=r[0],i=r[1];if(d[n]=d[n]||new Set,0===i.length)return"continue";var o,a=eo(s[e]);try{for(a.s();!(o=a.n()).done;){var u=o.value,f=Ji(c,u);if(null!==f){var p=(0,ct.Z)(f,2),v=p[0],g=p[1];n!==v&&(Pn(d,n,v),Pn(h,v,n)),0!==g.length&&g.forEach((function(e){l[e]=l[e]||new Set,i.forEach((function(t){l[e].add(t)}))}))}}}catch(e){a.e(e)}finally{a.f()}};for(var g in s)v(g);for(var y=(0,ut.Z)(i,"id"),_=function(){var e=E[k],t=e.blocks,r=new Set;if(!t)return"continue";var n=e.dataValidations,i=e.id;n&&Object.values(n).forEach((function(e){var n=e.dependentSheets;if(n){var o,s=eo(n);try{for(s.s();!(o=s.n()).done;){var a=o.value;if(!r.has(a)){r.add(a);var c=y[a];if(c){var u=c.blocks;if(u){var f,p=eo(t);try{for(p.s();!(f=p.n()).done;){var v,g=f.value.token,_=eo(u);try{for(_.s();!(v=_.n()).done;){var k=v.value;l[g]=l[g]||new Set,l[g].add(k.token)}}catch(e){_.e(e)}finally{_.f()}}}catch(e){p.e(e)}finally{p.f()}Pn(h,i,a),Pn(d,a,i)}}}}}catch(e){s.e(e)}finally{s.f()}}}))},k=0,E=i;k<E.length;k++)_();var m=new Set,S=function(e){m.add(e),n.getBlockRecursiveRefs(l,Object.keys(t[e])).forEach((function(t){p[e].add(t);var r=u[t];Pn(h,e,r),Pn(d,r,e)}))};for(var b in t)S(b);var C,R=e.sheetIdsToFetch||[];if(R.length){var A=[];R.forEach((function(e){m.has(e)&&(A.push(e),m.delete(e))})),m.forEach((function(e){A.push(e)})),C=Fn(Array.from(A),h)}else C=Array.from(m);return{sheetDependencies:p,sheetForwardRefDependencies:h,sheetRefDependencies:d,sheetIdLoadOrders:C,sheetIdsToFetchSet:new Set(R),blockTokenToSheetId:u}}},{key:"getBlockRecursiveRefs",value:function(e,t){for(var r=[],n=new Set,i=0;i<t.length;i++){var o;null===(o=e[t[i]])||void 0===o||o.forEach((function(e){n.has(e)||(r.push(e),n.add(e))}))}for(var s=0;s<r.length;s++){var a;null===(a=e[r[s]])||void 0===a||a.forEach((function(e){n.has(e)||(r.push(e),n.add(e))}))}return r}},{key:"getSubBlockParams",value:function(e,t,r,n){for(var i=this,o=[],s=[],a=[],c=function(c){var u=n[c];if(u in t){var l;try{l=Re(u,e.snapshot).data}catch(e){console.error(e)}Object.keys(t[u]).forEach((function(r,n,s){var c=t[u][r];fe(e.schema_version)&&i.checkMatchNoBlockSheetV3(c,e)||function(e,t,r){if(!r)return!1;var n=r.dataTable;if(n&&n[t.startRowIndex]&&n[t.startRowIndex+t.rowsCount-1])return!0;var i=r.dataTableBlockInfos;if(i&&i.length>0){var o=i[0],s=o.startRowIndex,a=o.table;if(s===t.startRowIndex&&t.rowsCount===a.rows.length)return!0}return!1}(0,c,l)?1===s.length&&a.push(u):o.push({token:e.token,block_token:r,schema_version:e.schema_version,sheetId:u,type:Ai.subBlock,info:c})}))}u in r&&s.push({token:e.token,block_token:r[u],schema_version:e.schema_version,sheetId:u,type:Ai.formulaMeta})},u=0;u<n.length;u++)c(u);return{sheetSubBlockParams:o,sheetFormulaMetaParams:s,newNoBlockSheets:a}}},{key:"dispatchFormulaMetaEvent",value:function(e){var t=this,r=!1;Object.values(e.snapshot.sheets).forEach((function(n){var i;null!==(i=n.formulaBlockMeta)&&void 0!==i&&i.hasFormula&&(r=!0,t.result$.next({originParams:e,event:{type:ro.formulaMetaLoaded,payload:{sheetId:n.id,data:n.formulaBlockMeta}}}))})),r||this.result$.next({originParams:e,event:{type:ro.formulaMetaEmpty}})}},{key:"checkMatchNoBlockSheetV3",value:function(e,t){var r=e.blockId,n=t.snapshot.blocks;return!(!n||!n[r])}},{key:"fetch",value:function(e,t){var r=this;this.mode===Tn.switch&&this.cancel(),this.result$.next({originParams:e,event:{type:ro.start,payload:e}});var n=[];fe(e.schema_version)&&(n=this.getSheetFormulaBlockParams(e));var i=this.getSheetBlock(e),o=i.noBlockSheets,s=i.sheetBlocks,a=i.sheetFormulaCache,c=this.getDependency(e,s),u=c.sheetDependencies,l=c.sheetRefDependencies,h=c.sheetForwardRefDependencies,d=c.sheetIdLoadOrders,p=c.sheetIdsToFetchSet,v=c.blockTokenToSheetId,g=this.getSubBlockParams(e,s,a,d),y=g.sheetSubBlockParams,_=g.sheetFormulaMetaParams;g.newNoBlockSheets.forEach((function(e){o.add(e)})),this.result$.next({originParams:e,event:{type:ro.relationAnalyzed,payload:{from:e,to:{dependencies:u,refDependencies:l,sheetBlock:s,forwardRefDependencies:h,blockTokenToSheetId:v,sheetFormulaCache:a,sheetFormulaBlockParams:n}}}}),fe(e.schema_version)&&this.dispatchFormulaMetaEvent(e);var k=this.subBlockFetcher.getTaskMode()===f.AXv.runInBackground;t=this.handleExtraConfig(k,t);var E=e.getActiveSheetId(),m=new Set(E?Fn([E],h):[]),S=Object.values(e.snapshot.sheets||{}).find((function(e){return e.id===E})),b=this.collectTableDependencies(m,null==S?void 0:S.importRangeIDs,l);return this.params$.next({noBlockSheets:o,subBlockParams:y.map((function(n){var i,o=new ri;(r.addCancelController(e,o),k)?i=p.has(n.sheetId)?wn.Highest:wn.High:i=(r.useTTUOptimizationQ2?E===v[n.block_token]:E&&m.has(v[n.block_token]))?wn.High:wn.Low;return[n,Object.assign({},t,{signal:o.signal,priority:i})]})),formulaBlockV3Params:n.map((function(n){var i,o=new ri;return r.addCancelController(e,o),i=k?p.has(n.sheetId)?wn.Highest:wn.High:e.getActiveSheetId()===n.sheetId?wn.Highest:wn.High,[n,Object.assign({},t,{signal:o.signal,priority:i})]})),formulaMetaParams:!1===e.isFetchFormulaMeta?[]:_.filter((function(e){return!!m.has(e.sheetId)||!b.has(e.sheetId)})).map((function(n){var i,o=new ri;return r.addCancelController(e,o),i=k?p.has(n.sheetId)?wn.Highest:wn.High:e.getActiveSheetId()===n.sheetId?wn.Highest:wn.High,[n,Object.assign({},t,{signal:o.signal,priority:i})]})),originParams:e,extraConfig:t}),this.result$.pipe((0,Gn.h)((function(t){return t.originParams===e})),(0,jn.map)((function(e){return e.event})),(0,Yn.b)((function(e){return ao.has(e.type)?(0,Vn.of)(e,null):(0,Vn.of)(e)})),(0,Jn.o)((function(e){return null!==e})))}},{key:"getSheetFormulaBlockParams",value:function(e){var t=[],r=e.snapshot.sheets,n=""!==(0,f.eYO)("no_ssc")||!1===e.isFetchFormulaMeta;if(!r||n)return t;for(var i=e.token,o=Object.keys(r),s=function(){var n=c[a],o=r[n].formulaBlockMeta;o&&o.blockMetas.map((function(e){return e.blockId})).forEach((function(r){t.push({token:i,block_token:r,sheetId:n,schema_version:e.schema_version})}))},a=0,c=o;a<c.length;a++)s();return t}},{key:"handleExtraConfig",value:function(e,t){var r,n;(null!==(r=t)&&void 0!==r&&r.signal&&console.warn("signal will be overridden, use cancel() instead of CancelController"),t)&&(t=Object.assign({},t,{retryConfig:Object.assign({max:no,interval:io,factor:oo,shouldRetry:this.defaultShouldRetry},null===(n=t)||void 0===n?void 0:n.retryConfig),priority:e?wn.High:wn.Low}));return t}},{key:"collectTableDependencies",value:function(e,t,r){var n,i=new Set,o=eo(e);try{for(o.s();!(n=o.n()).done;){var s=n.value;if(t&&!lo(t))Fn([s],r).forEach((function(e){i.add(e)}))}}catch(e){o.e(e)}finally{o.f()}return i}},{key:"isSubBlockFetchExpire",value:function(){return!!(this.subBlockTokenTimeStamp&&Date.now()-this.subBlockTokenTimeStamp>6048e5)}},{key:"setPriority",value:function(e){this.subBlockFetcher.setPriority(e)}},{key:"getData",value:function(){return this.result$.pipe((0,jn.map)((function(e){return e.event})))}},{key:"setSubBlockTokenCache",value:function(e,t){return this.subBlockFetcher.setPreloadDataFeature(e,t)}},{key:"clearSubBlockCache",value:function(){this.subBlockFetcher.clearCache(),this.formulaMetaFetcher.clearCache(),this.formulaBlockFetcher.clearCache()}},{key:"cancel",value:function(){this.subBlockFetcher.cancel(),this.formulaMetaFetcher.cancel(),this.formulaBlockFetcher.cancel()}},{key:"destroy",value:function(){this.cancel(),this.params$.complete(),this.result$.complete(),this.result$=null,this.cancelControllerMap.clear(),this.subBlockFetcher.destroy(),this.formulaBlockFetcher.destroy(),this.formulaMetaFetcher.destroy()}}]),e}();var fo,po,vo=r("vsh_38383");!function(e){e.start="historyStart",e.retry="historyRetry",e.cancel="historyCancel",e.success="historySuccess",e.error="historyError"}(po||(po={}));var go,yo,_o=(fo={},(0,u.Z)(fo,Ei.cancel,po.cancel),(0,u.Z)(fo,Ei.error,po.error),(0,u.Z)(fo,Ei.retry,po.retry),fo),ko=function(){function e(t){(0,a.Z)(this,e),this.result$=new ai.t(1),this.mode=Tn.switch,"firstBlockFetcher"in t?(this.firstBlockFetcher=t.firstBlockFetcher,this.mode=this.firstBlockFetcher.mode||this.mode):(this.mode=t.mode||this.mode,this.firstBlockFetcher=new Ci(t))}return(0,c.Z)(e,[{key:"getRecover",value:function(e,t){var r=Ce(e);if(r){var n=r.changeset,i=r.index;return(0,f.VB2)(t,e.slice(i+1)),n.content[0].value.revision}return null}},{key:"fetch",value:function(e,t){var r=this;this.mode===Tn.switch&&this.cancel();var n=[];return function i(o){return r.firstBlockFetcher.fetch(Object.assign({},e,{rev:o}),t).pipe((0,Xn.w)((function(e){if(e.type===Ei.success){var t=r.getRecover(e.payload.changesets,n);if(t)return i(t).pipe((0,vo.T)(1));try{var o=e.payload.changesets.concat(n),s=e.payload.snapshot,a=String(e.payload.sheet_id);if(fe(e.payload.data_version))return(0,Vn.of)({type:po.success,payload:{metaData:{snapshot:s,changesets:o,changeset_list:o,sheetId:a,schemaVersion:f.n0b.MUTATION}}});var c=Re(a,s),u={snapshot:s,sheetId:a,changesets:o,changeset_list:o,rowCount:null==c.rowCount?200:c.rowCount};return(0,Vn.of)({type:po.success,payload:{metaData:u}})}catch(e){return(0,Vn.of)({type:po.error,payload:e})}}if(e.type in _o){var l=Object.assign({},e,{type:_o[e.type]});return(0,Vn.of)(l)}return(0,Vn.of)(null)})),(0,Gn.h)((function(e){return null!==e})),(0,hi.O)({type:po.start}),(0,Wn.b)((function(e){r.result$.next(e)})))}(this.getRecover(e.changesets||[],n)||e.rev)}},{key:"getData",value:function(){return this.result$}},{key:"cancel",value:function(){this.firstBlockFetcher.cancel()}},{key:"destroy",value:function(){this.result$.complete(),this.result$=null,this.firstBlockFetcher.destroy()}}]),e}();!function(e){e.start="historyListStart",e.success="historyListSuccess",e.error="historyListError",e.retry="historyListRetry",e.cancel="historyListCancel",e.processDataStart="historyListProcessDataStart"}(yo||(yo={}));var Eo,mo=(go={},(0,u.Z)(go,Cn.start,yo.start),(0,u.Z)(go,Cn.success,yo.success),(0,u.Z)(go,Cn.error,yo.error),(0,u.Z)(go,Cn.retry,yo.retry),(0,u.Z)(go,Cn.cancel,yo.cancel),(0,u.Z)(go,Cn.processDataStart,yo.processDataStart),go),So=function(e){function t(e){var r;return(0,a.Z)(this,t),(r=(0,Ue.Z)(this,(0,He.Z)(t).call(this,e))).requestProvider=e.requestProvider,r}return(0,Ze.Z)(t,e),(0,c.Z)(t,[{key:"fetch",value:function(e,t){return e.type===Oe.MIXED_BITABLE?this.loadData({url:"".concat(this.requestProvider.apiUrls.GET_SHEET_MIXED_HISTORY_LIST,"/").concat(e.token,"/"),method:"GET",requestConfig:(0,Or.Z)({baseURL:this.requestProvider.prependAPI("/"),params:{max_version:e.start,page_size:e.range},headers:(0,u.Z)({},U,j)},null==t?void 0:t.requestConfig),retryConfig:(0,Or.Z)({max:3,interval:1e3},null==t?void 0:t.retryConfig),extensions:{type:e.type}}):this.loadData({url:"".concat(this.requestProvider.apiUrls.GET_EMBED_SHEET_HISTORY_LIST,"/").concat(e.token),method:"GET",requestConfig:(0,Or.Z)({baseURL:this.requestProvider.prependAPI("/"),params:{begin:e.start,duration:e.range},headers:(0,u.Z)({},U,V)},null==t?void 0:t.requestConfig),retryConfig:null==t?void 0:t.retryConfig,extensions:{type:e.type}})}},{key:"getEvent$",value:function(e){return e.pipe((0,Gn.h)((function(e){return e[1].type in mo})),(0,jn.map)((function(e){var t=(0,ct.Z)(e,2),r=t[0],n=t[1];return[r,Object.assign({},n,{type:mo[n.type]})]})))}},{key:"dataAdapter",value:function(e,t){var r=0;if(e.extensions.type===Oe.EMBED_SHEET)r=t.data.end;else for(var n=t.data.minor_histories,i=0;i<n.length;i++){var o=n[i];for(var s in o.all_block_revision){var a=o.all_block_revision[s];a.obj_type===Ie.SHEET&&(r=Math.max(r,a.last_revision))}}return{tokenEnd:r,historyList:t}}},{key:"getCache",value:function(e){return null}},{key:"setCache",value:function(e,t){}},{key:"clearCache",value:function(){}},{key:"shouldValidateCache",value:function(e){return!1}},{key:"shouldAdaptCache",value:function(e){return!!e.data&&this.canSetCache}},{key:"validateResponse",value:function(e,t,r){return t.code}}]),t}(di);!function(e){e[e.OK=0]="OK",e[e.Failed=1]="Failed"}(Eo||(Eo={}));var bo=function(e){function t(){return(0,a.Z)(this,t),(0,Ue.Z)(this,(0,He.Z)(t).apply(this,arguments))}return(0,Ze.Z)(t,e),(0,c.Z)(t,[{key:"fetch",value:function(e,t){return this.loadData({url:this.requestProvider.apiUrls.GET_SHEET_FIRST_BLOCK_FOR_SUBSCRIPTION,method:"GET",requestConfig:(0,Or.Z)({baseURL:this.requestProvider.prependAPI("/"),params:{token:e.token,revision:e.rev||e.revision,schema_version:f.jVu}},null==t?void 0:t.requestConfig),retryConfig:null==t?void 0:t.retryConfig})}},{key:"dataAdapter",value:function(e,r){var n=r.data;return(0,nn.Z)((0,He.Z)(t.prototype),"dataAdapter",this).call(this,e,n)}},{key:"getCache",value:function(e){return e.requestConfig.params.rev=e.requestConfig.params.revision,(0,nn.Z)((0,He.Z)(t.prototype),"getCache",this).call(this,e)}},{key:"setCache",value:function(e,r,n){e.requestConfig.params.rev=e.requestConfig.params.revision,(0,nn.Z)((0,He.Z)(t.prototype),"setCache",this).call(this,e,r,n)}}]),t}(Ci)},vsh_36189:function(e,t,r){"use strict";r.d(t,{Q:function(){return d}});var n=r("vsh_1139"),i=r("vsh_19264"),o=r("vsh_4175"),s=r("vsh_94760"),a=r("vsh_42326"),c=r("vsh_46016"),u=r("vsh_24627"),l=r("vsh_93631");e=r.hmd(e);var h=function(){function t(){var e=this;(0,i.Z)(this,t),this.watchList=[],this.commandTraceList=[],this.interval=0,this.isInit=!1,this.isCheckFinished=!1,this.events$=new l.xQ,this.warningThreshold=1,this.alarmThreshold=5,this.WATCH_TIMEOUT=6e4,this.WATCH_CHECK_PERIOD=6e4,this.logFn=u.ji5,this.init=function(){e.isInit||(e.interval=window.setInterval(e.checkWatch,e.WATCH_CHECK_PERIOD),e.isInit=!0,e.resetEventsIfNeed())},this.destroy=function(){window.clearInterval(e.interval),e.resetAll(),e.unsubscribeAll(),e.logFn=u.ji5,e.isInit=!1},this.watch=function(t,r){if(e.isInit)if(r){var n=Date.now();e.log("watch ".concat(n," ").concat(t," transId: ").concat(r)),e.watchList.push({commandName:t,timestamp:n,alarmCount:0,transId:r}),e.commandTraceList.push({transId:r,commandName:t,startTime:n,csLength:0})}else e.onWatchDogWatchError(t)},this.checkWatch=function(){if(0===e.watchList.length)return!e.isCheckFinished&&e.log("SheetWatchDogCheckFIN"),void(e.isCheckFinished=!0);e.isCheckFinished=!1;var t=e.watchList[0];e.isWatchStale(t)&&(t.alarmCount++,e.log("alarm ".concat(t.commandName," tid: ").concat(t.transId," count: ").concat(t.alarmCount)),e.warningThreshold===t.alarmCount&&e.onWatchdogWarning(t.transId,t.commandName,e.watchList.length),e.alarmThreshold===t.alarmCount&&e.onWatchdogAlert(t.transId,t.commandName,e.watchList.length))},this.done=function(t,r){e.log("before done ".concat(t," watchList: ").concat(e.watchList.length)),t&&(e.removeWatchByTid(t),e.removeAlertWatch(),e.log("after done ".concat(t," watchList: ").concat(e.watchList.length)),e.nextEvent({type:"done"}),e.commandTraceDone(t,r))},this.resetAll=function(){e.watchList=[],e.commandTraceList=[],e.nextEvent({type:"done"})},this.mergeWatch=function(t){try{if(e.log("before mergedWatch ".concat(t," watchList: ").concat(e.watchList.length)),!t||"string"!=typeof t)return;var r=e.calcMergedTid(t),n=r.start,i=r.end;if(![n,i].every(e.isValidTid))return;if(n===i)return void e.setWatchTid(i,t);var o=(0,c.Z)(n,i);e.watchList=(0,a.Z)(e.watchList,(function(e){return!o.includes(e.transId)})),e.setWatchTid(i,t),e.log("after mergedWatch ".concat(t," watchList: ").concat(e.watchList.length))}catch(r){e.onWatchDogMergedTidFail(),e.log("mergedWatch error ".concat(t," err: ").concat(r.message))}},this.removeWatchByTid=function(t){e.watchList=e.watchList.filter((function(e){return e.transId!==t}))},this.removeAlertWatch=function(){e.watchList=e.watchList.filter((function(e){return e.alarmCount<5}))},this.isWatchStale=function(t){return Date.now()-t.timestamp>=e.WATCH_TIMEOUT},this.setWatchTid=function(t,r){var n=(0,s.Z)(e.watchList,{transId:t});n&&(n.transId=r)}}return(0,o.Z)(t,[{key:"setLogger",value:function(e){this.logFn=e}},{key:"setThreshold",value:function(e){e&&(this.warningThreshold=e.warning,this.alarmThreshold=e.alarm)}},{key:"log",value:function(e){return this.logFn(t.LOG_MODULE_NAME,e)}},{key:"nextEvent",value:function(e){try{this.events$.next(e)}catch(e){}}},{key:"commandTraceDone",value:function(e,t){if(t)try{for(var r=Date.now(),n=(e=String(e)).split("-"),i=Number(n[n.length-1]),o=0===t.csLength,s=0;s<this.commandTraceList.length;s++){var a=this.commandTraceList[s];if(a.transId<i&&!o||a.transId===i&&(o||!t.hasLocalActions)){if(""!==n[0]||e.startsWith(u.$UQ.FORWARD_CHANGESET_CORE.toString())){var c=a.csLength+t.csLength;if(0!==c){var l=r-a.startTime;this.log("command trace done ".concat(e," ").concat(l)),u.Ps3.moirae.teaLog({key:"sheet_changeset_info_dev",cost_time:l,cs_length:c,command_name:a.commandName})}}this.commandTraceList.splice(s,1),s--}else a.csLength+=t.csLength}this.log("command trace done commandTraceList: ".concat(this.commandTraceList.length))}catch(e){this.commandTraceList=[],console.error(e)}}},{key:"calcMergedTid",value:function(e){var t=(e=e.startsWith("-")?e.slice(1):e).split("-"),r=(0,n.Z)(t,3),i=r[1],o=r[2];return{start:i=parseInt(i,10),end:o=parseInt(o,10)}}},{key:"isValidTid",value:function(e){return e>0&&Number.isInteger(e)}},{key:"onWatchdogWarning",value:function(t,r,n){this.nextEvent({type:"warning"}),u.Ps3.moirae.teaLog({key:"show_server_error_modal",error_code:u.D1r.ERROR_WATCH_DOG_WARNING,module:e,transId:t,commandName:r,watchLen:n})}},{key:"onWatchdogAlert",value:function(t,r,n){this.nextEvent({type:"alarm"}),u.Ps3.moirae.teaLog({key:"show_server_error_modal",error_code:u.D1r.ERROR_WATCH_DOG_ALERT,module:e,transId:t,commandName:r,watchLen:n})}},{key:"onWatchDogMergedTidFail",value:function(){u.Ps3.moirae.teaLog({key:"client_sheet_watchdog_mergetid_fail"})}},{key:"onWatchDogWatchError",value:function(e){u.Ps3.moirae.teaLog({key:"client_sheet_watchdog_watch_err",commandName:e})}},{key:"subscribeEvent",value:function(e){return this.resetEventsIfNeed(),this.events$.subscribe(e)}},{key:"resetEventsIfNeed",value:function(){this.events$.closed&&(this.events$=new l.xQ)}},{key:"unsubscribeAll",value:function(){this.events$.unsubscribe()}}]),t}();h.LOG_MODULE_NAME="watchDog";var d=new h},vsh_5430:function(e,t,r){var n=r("vsh_66588");e.exports=function(){return n('(function(){var __webpack_modules__={vsh_415:function(t,e){"use strict";e.byteLength=function(t){var e=h(t),r=e[0],n=e[1];return 3*(r+n)/4-n},e.toByteArray=function(t){var e,r,o=h(t),s=o[0],a=o[1],u=new i(function(t,e,r){return 3*(e+r)/4-r}(0,s,a)),l=0,f=a>0?s-4:s;for(r=0;r<f;r+=4)e=n[t.charCodeAt(r)]<<18|n[t.charCodeAt(r+1)]<<12|n[t.charCodeAt(r+2)]<<6|n[t.charCodeAt(r+3)],u[l++]=e>>16&255,u[l++]=e>>8&255,u[l++]=255&e;2===a&&(e=n[t.charCodeAt(r)]<<2|n[t.charCodeAt(r+1)]>>4,u[l++]=255&e);1===a&&(e=n[t.charCodeAt(r)]<<10|n[t.charCodeAt(r+1)]<<4|n[t.charCodeAt(r+2)]>>2,u[l++]=e>>8&255,u[l++]=255&e);return u},e.fromByteArray=function(t){for(var e,n=t.length,i=n%3,o=[],s=16383,a=0,h=n-i;a<h;a+=s)o.push(u(t,a,a+s>h?h:a+s));1===i?(e=t[n-1],o.push(r[e>>2]+r[e<<4&63]+"==")):2===i&&(e=(t[n-2]<<8)+t[n-1],o.push(r[e>>10]+r[e>>4&63]+r[e<<2&63]+"="));return o.join("")};for(var r=[],n=[],i="undefined"!=typeof Uint8Array?Uint8Array:Array,o="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",s=0,a=o.length;s<a;++s)r[s]=o[s],n[o.charCodeAt(s)]=s;function h(t){var e=t.length;if(e%4>0)throw new Error("Invalid string. Length must be a multiple of 4");var r=t.indexOf("=");return-1===r&&(r=e),[r,r===e?0:4-r%4]}function u(t,e,n){for(var i,o,s=[],a=e;a<n;a+=3)i=(t[a]<<16&16711680)+(t[a+1]<<8&65280)+(255&t[a+2]),s.push(r[(o=i)>>18&63]+r[o>>12&63]+r[o>>6&63]+r[63&o]);return s.join("")}n["-".charCodeAt(0)]=62,n["_".charCodeAt(0)]=63},vsh_872:function(t,e,r){"use strict";\n/*!\n * The buffer module from node.js, for the browser.\n *\n * @author   Feross Aboukhadijeh <https://feross.org>\n * @license  MIT\n */\nconst n=r("vsh_415"),i=r("vsh_551"),o="function"==typeof Symbol&&"function"==typeof Symbol.for?Symbol.for("nodejs.util.inspect.custom"):null;e.lW=h,e.h2=50;const s=2147483647;function a(t){if(t>s)throw new RangeError(\'The value "\'+t+\'" is invalid for option "size"\');const e=new Uint8Array(t);return Object.setPrototypeOf(e,h.prototype),e}function h(t,e,r){if("number"==typeof t){if("string"==typeof e)throw new TypeError(\'The "string" argument must be of type string. Received type number\');return f(t)}return u(t,e,r)}function u(t,e,r){if("string"==typeof t)return function(t,e){"string"==typeof e&&""!==e||(e="utf8");if(!h.isEncoding(e))throw new TypeError("Unknown encoding: "+e);const r=0|g(t,e);let n=a(r);const i=n.write(t,e);i!==r&&(n=n.slice(0,i));return n}(t,e);if(ArrayBuffer.isView(t))return function(t){if(V(t,Uint8Array)){const e=new Uint8Array(t);return p(e.buffer,e.byteOffset,e.byteLength)}return c(t)}(t);if(null==t)throw new TypeError("The first argument must be one of type string, Buffer, ArrayBuffer, Array, or Array-like Object. Received type "+typeof t);if(V(t,ArrayBuffer)||t&&V(t.buffer,ArrayBuffer))return p(t,e,r);if("undefined"!=typeof SharedArrayBuffer&&(V(t,SharedArrayBuffer)||t&&V(t.buffer,SharedArrayBuffer)))return p(t,e,r);if("number"==typeof t)throw new TypeError(\'The "value" argument must not be of type number. Received type number\');const n=t.valueOf&&t.valueOf();if(null!=n&&n!==t)return h.from(n,e,r);const i=function(t){if(h.isBuffer(t)){const e=0|d(t.length),r=a(e);return 0===r.length||t.copy(r,0,0,e),r}if(void 0!==t.length)return"number"!=typeof t.length||J(t.length)?a(0):c(t);if("Buffer"===t.type&&Array.isArray(t.data))return c(t.data)}(t);if(i)return i;if("undefined"!=typeof Symbol&&null!=Symbol.toPrimitive&&"function"==typeof t[Symbol.toPrimitive])return h.from(t[Symbol.toPrimitive]("string"),e,r);throw new TypeError("The first argument must be one of type string, Buffer, ArrayBuffer, Array, or Array-like Object. Received type "+typeof t)}function l(t){if("number"!=typeof t)throw new TypeError(\'"size" argument must be of type number\');if(t<0)throw new RangeError(\'The value "\'+t+\'" is invalid for option "size"\')}function f(t){return l(t),a(t<0?0:0|d(t))}function c(t){const e=t.length<0?0:0|d(t.length),r=a(e);for(let n=0;n<e;n+=1)r[n]=255&t[n];return r}function p(t,e,r){if(e<0||t.byteLength<e)throw new RangeError(\'"offset" is outside of buffer bounds\');if(t.byteLength<e+(r||0))throw new RangeError(\'"length" is outside of buffer bounds\');let n;return n=void 0===e&&void 0===r?new Uint8Array(t):void 0===r?new Uint8Array(t,e):new Uint8Array(t,e,r),Object.setPrototypeOf(n,h.prototype),n}function d(t){if(t>=s)throw new RangeError("Attempt to allocate Buffer larger than maximum size: 0x"+s.toString(16)+" bytes");return 0|t}function g(t,e){if(h.isBuffer(t))return t.length;if(ArrayBuffer.isView(t)||V(t,ArrayBuffer))return t.byteLength;if("string"!=typeof t)throw new TypeError(\'The "string" argument must be one of type string, Buffer, or ArrayBuffer. Received type \'+typeof t);const r=t.length,n=arguments.length>2&&!0===arguments[2];if(!n&&0===r)return 0;let i=!1;for(;;)switch(e){case"ascii":case"latin1":case"binary":return r;case"utf8":case"utf-8":return W(t).length;case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return 2*r;case"hex":return r>>>1;case"base64":return K(t).length;default:if(i)return n?-1:W(t).length;e=(""+e).toLowerCase(),i=!0}}function y(t,e,r){let n=!1;if((void 0===e||e<0)&&(e=0),e>this.length)return"";if((void 0===r||r>this.length)&&(r=this.length),r<=0)return"";if((r>>>=0)<=(e>>>=0))return"";for(t||(t="utf8");;)switch(t){case"hex":return L(this,e,r);case"utf8":case"utf-8":return T(this,e,r);case"ascii":return R(this,e,r);case"latin1":case"binary":return x(this,e,r);case"base64":return A(this,e,r);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return N(this,e,r);default:if(n)throw new TypeError("Unknown encoding: "+t);t=(t+"").toLowerCase(),n=!0}}function m(t,e,r){const n=t[e];t[e]=t[r],t[r]=n}function _(t,e,r,n,i){if(0===t.length)return-1;if("string"==typeof r?(n=r,r=0):r>2147483647?r=2147483647:r<-2147483648&&(r=-2147483648),J(r=+r)&&(r=i?0:t.length-1),r<0&&(r=t.length+r),r>=t.length){if(i)return-1;r=t.length-1}else if(r<0){if(!i)return-1;r=0}if("string"==typeof e&&(e=h.from(e,n)),h.isBuffer(e))return 0===e.length?-1:b(t,e,r,n,i);if("number"==typeof e)return e&=255,"function"==typeof Uint8Array.prototype.indexOf?i?Uint8Array.prototype.indexOf.call(t,e,r):Uint8Array.prototype.lastIndexOf.call(t,e,r):b(t,[e],r,n,i);throw new TypeError("val must be string, number or Buffer")}function b(t,e,r,n,i){let o,s=1,a=t.length,h=e.length;if(void 0!==n&&("ucs2"===(n=String(n).toLowerCase())||"ucs-2"===n||"utf16le"===n||"utf-16le"===n)){if(t.length<2||e.length<2)return-1;s=2,a/=2,h/=2,r/=2}function u(t,e){return 1===s?t[e]:t.readUInt16BE(e*s)}if(i){let n=-1;for(o=r;o<a;o++)if(u(t,o)===u(e,-1===n?0:o-n)){if(-1===n&&(n=o),o-n+1===h)return n*s}else-1!==n&&(o-=o-n),n=-1}else for(r+h>a&&(r=a-h),o=r;o>=0;o--){let r=!0;for(let n=0;n<h;n++)if(u(t,o+n)!==u(e,n)){r=!1;break}if(r)return o}return-1}function w(t,e,r,n){r=Number(r)||0;const i=t.length-r;n?(n=Number(n))>i&&(n=i):n=i;const o=e.length;let s;for(n>o/2&&(n=o/2),s=0;s<n;++s){const n=parseInt(e.substr(2*s,2),16);if(J(n))return s;t[r+s]=n}return s}function v(t,e,r,n){return G(W(e,t.length-r),t,r,n)}function E(t,e,r,n){return G(function(t){const e=[];for(let r=0;r<t.length;++r)e.push(255&t.charCodeAt(r));return e}(e),t,r,n)}function O(t,e,r,n){return G(K(e),t,r,n)}function k(t,e,r,n){return G(function(t,e){let r,n,i;const o=[];for(let s=0;s<t.length&&!((e-=2)<0);++s)r=t.charCodeAt(s),n=r>>8,i=r%256,o.push(i),o.push(n);return o}(e,t.length-r),t,r,n)}function A(t,e,r){return 0===e&&r===t.length?n.fromByteArray(t):n.fromByteArray(t.slice(e,r))}function T(t,e,r){r=Math.min(t.length,r);const n=[];let i=e;for(;i<r;){const e=t[i];let o=null,s=e>239?4:e>223?3:e>191?2:1;if(i+s<=r){let r,n,a,h;switch(s){case 1:e<128&&(o=e);break;case 2:r=t[i+1],128==(192&r)&&(h=(31&e)<<6|63&r,h>127&&(o=h));break;case 3:r=t[i+1],n=t[i+2],128==(192&r)&&128==(192&n)&&(h=(15&e)<<12|(63&r)<<6|63&n,h>2047&&(h<55296||h>57343)&&(o=h));break;case 4:r=t[i+1],n=t[i+2],a=t[i+3],128==(192&r)&&128==(192&n)&&128==(192&a)&&(h=(15&e)<<18|(63&r)<<12|(63&n)<<6|63&a,h>65535&&h<1114112&&(o=h))}}null===o?(o=65533,s=1):o>65535&&(o-=65536,n.push(o>>>10&1023|55296),o=56320|1023&o),n.push(o),i+=s}return function(t){const e=t.length;if(e<=S)return String.fromCharCode.apply(String,t);let r="",n=0;for(;n<e;)r+=String.fromCharCode.apply(String,t.slice(n,n+=S));return r}(n)}h.TYPED_ARRAY_SUPPORT=function(){try{const t=new Uint8Array(1),e={foo:function(){return 42}};return Object.setPrototypeOf(e,Uint8Array.prototype),Object.setPrototypeOf(t,e),42===t.foo()}catch(t){return!1}}(),h.TYPED_ARRAY_SUPPORT||"undefined"==typeof console||"function"!=typeof console.error||console.error("This browser lacks typed array (Uint8Array) support which is required by `buffer` v5.x. Use `buffer` v4.x if you require old browser support."),Object.defineProperty(h.prototype,"parent",{enumerable:!0,get:function(){if(h.isBuffer(this))return this.buffer}}),Object.defineProperty(h.prototype,"offset",{enumerable:!0,get:function(){if(h.isBuffer(this))return this.byteOffset}}),h.poolSize=8192,h.from=function(t,e,r){return u(t,e,r)},Object.setPrototypeOf(h.prototype,Uint8Array.prototype),Object.setPrototypeOf(h,Uint8Array),h.alloc=function(t,e,r){return function(t,e,r){return l(t),t<=0?a(t):void 0!==e?"string"==typeof r?a(t).fill(e,r):a(t).fill(e):a(t)}(t,e,r)},h.allocUnsafe=function(t){return f(t)},h.allocUnsafeSlow=function(t){return f(t)},h.isBuffer=function(t){return null!=t&&!0===t._isBuffer&&t!==h.prototype},h.compare=function(t,e){if(V(t,Uint8Array)&&(t=h.from(t,t.offset,t.byteLength)),V(e,Uint8Array)&&(e=h.from(e,e.offset,e.byteLength)),!h.isBuffer(t)||!h.isBuffer(e))throw new TypeError(\'The "buf1", "buf2" arguments must be one of type Buffer or Uint8Array\');if(t===e)return 0;let r=t.length,n=e.length;for(let i=0,o=Math.min(r,n);i<o;++i)if(t[i]!==e[i]){r=t[i],n=e[i];break}return r<n?-1:n<r?1:0},h.isEncoding=function(t){switch(String(t).toLowerCase()){case"hex":case"utf8":case"utf-8":case"ascii":case"latin1":case"binary":case"base64":case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return!0;default:return!1}},h.concat=function(t,e){if(!Array.isArray(t))throw new TypeError(\'"list" argument must be an Array of Buffers\');if(0===t.length)return h.alloc(0);let r;if(void 0===e)for(e=0,r=0;r<t.length;++r)e+=t[r].length;const n=h.allocUnsafe(e);let i=0;for(r=0;r<t.length;++r){let e=t[r];if(V(e,Uint8Array))i+e.length>n.length?(h.isBuffer(e)||(e=h.from(e)),e.copy(n,i)):Uint8Array.prototype.set.call(n,e,i);else{if(!h.isBuffer(e))throw new TypeError(\'"list" argument must be an Array of Buffers\');e.copy(n,i)}i+=e.length}return n},h.byteLength=g,h.prototype._isBuffer=!0,h.prototype.swap16=function(){const t=this.length;if(t%2!=0)throw new RangeError("Buffer size must be a multiple of 16-bits");for(let e=0;e<t;e+=2)m(this,e,e+1);return this},h.prototype.swap32=function(){const t=this.length;if(t%4!=0)throw new RangeError("Buffer size must be a multiple of 32-bits");for(let e=0;e<t;e+=4)m(this,e,e+3),m(this,e+1,e+2);return this},h.prototype.swap64=function(){const t=this.length;if(t%8!=0)throw new RangeError("Buffer size must be a multiple of 64-bits");for(let e=0;e<t;e+=8)m(this,e,e+7),m(this,e+1,e+6),m(this,e+2,e+5),m(this,e+3,e+4);return this},h.prototype.toString=function(){const t=this.length;return 0===t?"":0===arguments.length?T(this,0,t):y.apply(this,arguments)},h.prototype.toLocaleString=h.prototype.toString,h.prototype.equals=function(t){if(!h.isBuffer(t))throw new TypeError("Argument must be a Buffer");return this===t||0===h.compare(this,t)},h.prototype.inspect=function(){let t="";const r=e.h2;return t=this.toString("hex",0,r).replace(/(.{2})/g,"$1 ").trim(),this.length>r&&(t+=" ... "),"<Buffer "+t+">"},o&&(h.prototype[o]=h.prototype.inspect),h.prototype.compare=function(t,e,r,n,i){if(V(t,Uint8Array)&&(t=h.from(t,t.offset,t.byteLength)),!h.isBuffer(t))throw new TypeError(\'The "target" argument must be one of type Buffer or Uint8Array. Received type \'+typeof t);if(void 0===e&&(e=0),void 0===r&&(r=t?t.length:0),void 0===n&&(n=0),void 0===i&&(i=this.length),e<0||r>t.length||n<0||i>this.length)throw new RangeError("out of range index");if(n>=i&&e>=r)return 0;if(n>=i)return-1;if(e>=r)return 1;if(this===t)return 0;let o=(i>>>=0)-(n>>>=0),s=(r>>>=0)-(e>>>=0);const a=Math.min(o,s),u=this.slice(n,i),l=t.slice(e,r);for(let t=0;t<a;++t)if(u[t]!==l[t]){o=u[t],s=l[t];break}return o<s?-1:s<o?1:0},h.prototype.includes=function(t,e,r){return-1!==this.indexOf(t,e,r)},h.prototype.indexOf=function(t,e,r){return _(this,t,e,r,!0)},h.prototype.lastIndexOf=function(t,e,r){return _(this,t,e,r,!1)},h.prototype.write=function(t,e,r,n){if(void 0===e)n="utf8",r=this.length,e=0;else if(void 0===r&&"string"==typeof e)n=e,r=this.length,e=0;else{if(!isFinite(e))throw new Error("Buffer.write(string, encoding, offset[, length]) is no longer supported");e>>>=0,isFinite(r)?(r>>>=0,void 0===n&&(n="utf8")):(n=r,r=void 0)}const i=this.length-e;if((void 0===r||r>i)&&(r=i),t.length>0&&(r<0||e<0)||e>this.length)throw new RangeError("Attempt to write outside buffer bounds");n||(n="utf8");let o=!1;for(;;)switch(n){case"hex":return w(this,t,e,r);case"utf8":case"utf-8":return v(this,t,e,r);case"ascii":case"latin1":case"binary":return E(this,t,e,r);case"base64":return O(this,t,e,r);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return k(this,t,e,r);default:if(o)throw new TypeError("Unknown encoding: "+n);n=(""+n).toLowerCase(),o=!0}},h.prototype.toJSON=function(){return{type:"Buffer",data:Array.prototype.slice.call(this._arr||this,0)}};const S=4096;function R(t,e,r){let n="";r=Math.min(t.length,r);for(let i=e;i<r;++i)n+=String.fromCharCode(127&t[i]);return n}function x(t,e,r){let n="";r=Math.min(t.length,r);for(let i=e;i<r;++i)n+=String.fromCharCode(t[i]);return n}function L(t,e,r){const n=t.length;(!e||e<0)&&(e=0),(!r||r<0||r>n)&&(r=n);let i="";for(let n=e;n<r;++n)i+=Y[t[n]];return i}function N(t,e,r){const n=t.slice(e,r);let i="";for(let t=0;t<n.length-1;t+=2)i+=String.fromCharCode(n[t]+256*n[t+1]);return i}function I(t,e,r){if(t%1!=0||t<0)throw new RangeError("offset is not uint");if(t+e>r)throw new RangeError("Trying to access beyond buffer length")}function B(t,e,r,n,i,o){if(!h.isBuffer(t))throw new TypeError(\'"buffer" argument must be a Buffer instance\');if(e>i||e<o)throw new RangeError(\'"value" argument is out of bounds\');if(r+n>t.length)throw new RangeError("Index out of range")}function D(t,e,r,n,i){Z(e,n,i,t,r,7);let o=Number(e&BigInt(4294967295));t[r++]=o,o>>=8,t[r++]=o,o>>=8,t[r++]=o,o>>=8,t[r++]=o;let s=Number(e>>BigInt(32)&BigInt(4294967295));return t[r++]=s,s>>=8,t[r++]=s,s>>=8,t[r++]=s,s>>=8,t[r++]=s,r}function j(t,e,r,n,i){Z(e,n,i,t,r,7);let o=Number(e&BigInt(4294967295));t[r+7]=o,o>>=8,t[r+6]=o,o>>=8,t[r+5]=o,o>>=8,t[r+4]=o;let s=Number(e>>BigInt(32)&BigInt(4294967295));return t[r+3]=s,s>>=8,t[r+2]=s,s>>=8,t[r+1]=s,s>>=8,t[r]=s,r+8}function C(t,e,r,n,i,o){if(r+n>t.length)throw new RangeError("Index out of range");if(r<0)throw new RangeError("Index out of range")}function U(t,e,r,n,o){return e=+e,r>>>=0,o||C(t,0,r,4),i.write(t,e,r,n,23,4),r+4}function z(t,e,r,n,o){return e=+e,r>>>=0,o||C(t,0,r,8),i.write(t,e,r,n,52,8),r+8}h.prototype.slice=function(t,e){const r=this.length;(t=~~t)<0?(t+=r)<0&&(t=0):t>r&&(t=r),(e=void 0===e?r:~~e)<0?(e+=r)<0&&(e=0):e>r&&(e=r),e<t&&(e=t);const n=this.subarray(t,e);return Object.setPrototypeOf(n,h.prototype),n},h.prototype.readUintLE=h.prototype.readUIntLE=function(t,e,r){t>>>=0,e>>>=0,r||I(t,e,this.length);let n=this[t],i=1,o=0;for(;++o<e&&(i*=256);)n+=this[t+o]*i;return n},h.prototype.readUintBE=h.prototype.readUIntBE=function(t,e,r){t>>>=0,e>>>=0,r||I(t,e,this.length);let n=this[t+--e],i=1;for(;e>0&&(i*=256);)n+=this[t+--e]*i;return n},h.prototype.readUint8=h.prototype.readUInt8=function(t,e){return t>>>=0,e||I(t,1,this.length),this[t]},h.prototype.readUint16LE=h.prototype.readUInt16LE=function(t,e){return t>>>=0,e||I(t,2,this.length),this[t]|this[t+1]<<8},h.prototype.readUint16BE=h.prototype.readUInt16BE=function(t,e){return t>>>=0,e||I(t,2,this.length),this[t]<<8|this[t+1]},h.prototype.readUint32LE=h.prototype.readUInt32LE=function(t,e){return t>>>=0,e||I(t,4,this.length),(this[t]|this[t+1]<<8|this[t+2]<<16)+16777216*this[t+3]},h.prototype.readUint32BE=h.prototype.readUInt32BE=function(t,e){return t>>>=0,e||I(t,4,this.length),16777216*this[t]+(this[t+1]<<16|this[t+2]<<8|this[t+3])},h.prototype.readBigUInt64LE=X((function(t){H(t>>>=0,"offset");const e=this[t],r=this[t+7];void 0!==e&&void 0!==r||q(t,this.length-8);const n=e+256*this[++t]+65536*this[++t]+this[++t]*2**24,i=this[++t]+256*this[++t]+65536*this[++t]+r*2**24;return BigInt(n)+(BigInt(i)<<BigInt(32))})),h.prototype.readBigUInt64BE=X((function(t){H(t>>>=0,"offset");const e=this[t],r=this[t+7];void 0!==e&&void 0!==r||q(t,this.length-8);const n=e*2**24+65536*this[++t]+256*this[++t]+this[++t],i=this[++t]*2**24+65536*this[++t]+256*this[++t]+r;return(BigInt(n)<<BigInt(32))+BigInt(i)})),h.prototype.readIntLE=function(t,e,r){t>>>=0,e>>>=0,r||I(t,e,this.length);let n=this[t],i=1,o=0;for(;++o<e&&(i*=256);)n+=this[t+o]*i;return i*=128,n>=i&&(n-=Math.pow(2,8*e)),n},h.prototype.readIntBE=function(t,e,r){t>>>=0,e>>>=0,r||I(t,e,this.length);let n=e,i=1,o=this[t+--n];for(;n>0&&(i*=256);)o+=this[t+--n]*i;return i*=128,o>=i&&(o-=Math.pow(2,8*e)),o},h.prototype.readInt8=function(t,e){return t>>>=0,e||I(t,1,this.length),128&this[t]?-1*(255-this[t]+1):this[t]},h.prototype.readInt16LE=function(t,e){t>>>=0,e||I(t,2,this.length);const r=this[t]|this[t+1]<<8;return 32768&r?4294901760|r:r},h.prototype.readInt16BE=function(t,e){t>>>=0,e||I(t,2,this.length);const r=this[t+1]|this[t]<<8;return 32768&r?4294901760|r:r},h.prototype.readInt32LE=function(t,e){return t>>>=0,e||I(t,4,this.length),this[t]|this[t+1]<<8|this[t+2]<<16|this[t+3]<<24},h.prototype.readInt32BE=function(t,e){return t>>>=0,e||I(t,4,this.length),this[t]<<24|this[t+1]<<16|this[t+2]<<8|this[t+3]},h.prototype.readBigInt64LE=X((function(t){H(t>>>=0,"offset");const e=this[t],r=this[t+7];void 0!==e&&void 0!==r||q(t,this.length-8);const n=this[t+4]+256*this[t+5]+65536*this[t+6]+(r<<24);return(BigInt(n)<<BigInt(32))+BigInt(e+256*this[++t]+65536*this[++t]+this[++t]*2**24)})),h.prototype.readBigInt64BE=X((function(t){H(t>>>=0,"offset");const e=this[t],r=this[t+7];void 0!==e&&void 0!==r||q(t,this.length-8);const n=(e<<24)+65536*this[++t]+256*this[++t]+this[++t];return(BigInt(n)<<BigInt(32))+BigInt(this[++t]*2**24+65536*this[++t]+256*this[++t]+r)})),h.prototype.readFloatLE=function(t,e){return t>>>=0,e||I(t,4,this.length),i.read(this,t,!0,23,4)},h.prototype.readFloatBE=function(t,e){return t>>>=0,e||I(t,4,this.length),i.read(this,t,!1,23,4)},h.prototype.readDoubleLE=function(t,e){return t>>>=0,e||I(t,8,this.length),i.read(this,t,!0,52,8)},h.prototype.readDoubleBE=function(t,e){return t>>>=0,e||I(t,8,this.length),i.read(this,t,!1,52,8)},h.prototype.writeUintLE=h.prototype.writeUIntLE=function(t,e,r,n){if(t=+t,e>>>=0,r>>>=0,!n){B(this,t,e,r,Math.pow(2,8*r)-1,0)}let i=1,o=0;for(this[e]=255&t;++o<r&&(i*=256);)this[e+o]=t/i&255;return e+r},h.prototype.writeUintBE=h.prototype.writeUIntBE=function(t,e,r,n){if(t=+t,e>>>=0,r>>>=0,!n){B(this,t,e,r,Math.pow(2,8*r)-1,0)}let i=r-1,o=1;for(this[e+i]=255&t;--i>=0&&(o*=256);)this[e+i]=t/o&255;return e+r},h.prototype.writeUint8=h.prototype.writeUInt8=function(t,e,r){return t=+t,e>>>=0,r||B(this,t,e,1,255,0),this[e]=255&t,e+1},h.prototype.writeUint16LE=h.prototype.writeUInt16LE=function(t,e,r){return t=+t,e>>>=0,r||B(this,t,e,2,65535,0),this[e]=255&t,this[e+1]=t>>>8,e+2},h.prototype.writeUint16BE=h.prototype.writeUInt16BE=function(t,e,r){return t=+t,e>>>=0,r||B(this,t,e,2,65535,0),this[e]=t>>>8,this[e+1]=255&t,e+2},h.prototype.writeUint32LE=h.prototype.writeUInt32LE=function(t,e,r){return t=+t,e>>>=0,r||B(this,t,e,4,4294967295,0),this[e+3]=t>>>24,this[e+2]=t>>>16,this[e+1]=t>>>8,this[e]=255&t,e+4},h.prototype.writeUint32BE=h.prototype.writeUInt32BE=function(t,e,r){return t=+t,e>>>=0,r||B(this,t,e,4,4294967295,0),this[e]=t>>>24,this[e+1]=t>>>16,this[e+2]=t>>>8,this[e+3]=255&t,e+4},h.prototype.writeBigUInt64LE=X((function(t,e=0){return D(this,t,e,BigInt(0),BigInt("0xffffffffffffffff"))})),h.prototype.writeBigUInt64BE=X((function(t,e=0){return j(this,t,e,BigInt(0),BigInt("0xffffffffffffffff"))})),h.prototype.writeIntLE=function(t,e,r,n){if(t=+t,e>>>=0,!n){const n=Math.pow(2,8*r-1);B(this,t,e,r,n-1,-n)}let i=0,o=1,s=0;for(this[e]=255&t;++i<r&&(o*=256);)t<0&&0===s&&0!==this[e+i-1]&&(s=1),this[e+i]=(t/o>>0)-s&255;return e+r},h.prototype.writeIntBE=function(t,e,r,n){if(t=+t,e>>>=0,!n){const n=Math.pow(2,8*r-1);B(this,t,e,r,n-1,-n)}let i=r-1,o=1,s=0;for(this[e+i]=255&t;--i>=0&&(o*=256);)t<0&&0===s&&0!==this[e+i+1]&&(s=1),this[e+i]=(t/o>>0)-s&255;return e+r},h.prototype.writeInt8=function(t,e,r){return t=+t,e>>>=0,r||B(this,t,e,1,127,-128),t<0&&(t=255+t+1),this[e]=255&t,e+1},h.prototype.writeInt16LE=function(t,e,r){return t=+t,e>>>=0,r||B(this,t,e,2,32767,-32768),this[e]=255&t,this[e+1]=t>>>8,e+2},h.prototype.writeInt16BE=function(t,e,r){return t=+t,e>>>=0,r||B(this,t,e,2,32767,-32768),this[e]=t>>>8,this[e+1]=255&t,e+2},h.prototype.writeInt32LE=function(t,e,r){return t=+t,e>>>=0,r||B(this,t,e,4,2147483647,-2147483648),this[e]=255&t,this[e+1]=t>>>8,this[e+2]=t>>>16,this[e+3]=t>>>24,e+4},h.prototype.writeInt32BE=function(t,e,r){return t=+t,e>>>=0,r||B(this,t,e,4,2147483647,-2147483648),t<0&&(t=4294967295+t+1),this[e]=t>>>24,this[e+1]=t>>>16,this[e+2]=t>>>8,this[e+3]=255&t,e+4},h.prototype.writeBigInt64LE=X((function(t,e=0){return D(this,t,e,-BigInt("0x8000000000000000"),BigInt("0x7fffffffffffffff"))})),h.prototype.writeBigInt64BE=X((function(t,e=0){return j(this,t,e,-BigInt("0x8000000000000000"),BigInt("0x7fffffffffffffff"))})),h.prototype.writeFloatLE=function(t,e,r){return U(this,t,e,!0,r)},h.prototype.writeFloatBE=function(t,e,r){return U(this,t,e,!1,r)},h.prototype.writeDoubleLE=function(t,e,r){return z(this,t,e,!0,r)},h.prototype.writeDoubleBE=function(t,e,r){return z(this,t,e,!1,r)},h.prototype.copy=function(t,e,r,n){if(!h.isBuffer(t))throw new TypeError("argument should be a Buffer");if(r||(r=0),n||0===n||(n=this.length),e>=t.length&&(e=t.length),e||(e=0),n>0&&n<r&&(n=r),n===r)return 0;if(0===t.length||0===this.length)return 0;if(e<0)throw new RangeError("targetStart out of bounds");if(r<0||r>=this.length)throw new RangeError("Index out of range");if(n<0)throw new RangeError("sourceEnd out of bounds");n>this.length&&(n=this.length),t.length-e<n-r&&(n=t.length-e+r);const i=n-r;return this===t&&"function"==typeof Uint8Array.prototype.copyWithin?this.copyWithin(e,r,n):Uint8Array.prototype.set.call(t,this.subarray(r,n),e),i},h.prototype.fill=function(t,e,r,n){if("string"==typeof t){if("string"==typeof e?(n=e,e=0,r=this.length):"string"==typeof r&&(n=r,r=this.length),void 0!==n&&"string"!=typeof n)throw new TypeError("encoding must be a string");if("string"==typeof n&&!h.isEncoding(n))throw new TypeError("Unknown encoding: "+n);if(1===t.length){const e=t.charCodeAt(0);("utf8"===n&&e<128||"latin1"===n)&&(t=e)}}else"number"==typeof t?t&=255:"boolean"==typeof t&&(t=Number(t));if(e<0||this.length<e||this.length<r)throw new RangeError("Out of range index");if(r<=e)return this;let i;if(e>>>=0,r=void 0===r?this.length:r>>>0,t||(t=0),"number"==typeof t)for(i=e;i<r;++i)this[i]=t;else{const o=h.isBuffer(t)?t:h.from(t,n),s=o.length;if(0===s)throw new TypeError(\'The value "\'+t+\'" is invalid for argument "value"\');for(i=0;i<r-e;++i)this[i+e]=o[i%s]}return this};const F={};function M(t,e,r){F[t]=class extends r{constructor(){super(),Object.defineProperty(this,"message",{value:e.apply(this,arguments),writable:!0,configurable:!0}),this.name=`${this.name} [${t}]`,this.stack,delete this.name}get code(){return t}set code(t){Object.defineProperty(this,"code",{configurable:!0,enumerable:!0,value:t,writable:!0})}toString(){return`${this.name} [${t}]: ${this.message}`}}}function P(t){let e="",r=t.length;const n="-"===t[0]?1:0;for(;r>=n+4;r-=3)e=`_${t.slice(r-3,r)}${e}`;return`${t.slice(0,r)}${e}`}function Z(t,e,r,n,i,o){if(t>r||t<e){const n="bigint"==typeof e?"n":"";let i;throw i=o>3?0===e||e===BigInt(0)?`>= 0${n} and < 2${n} ** ${8*(o+1)}${n}`:`>= -(2${n} ** ${8*(o+1)-1}${n}) and < 2 ** ${8*(o+1)-1}${n}`:`>= ${e}${n} and <= ${r}${n}`,new F.ERR_OUT_OF_RANGE("value",i,t)}!function(t,e,r){H(e,"offset"),void 0!==t[e]&&void 0!==t[e+r]||q(e,t.length-(r+1))}(n,i,o)}function H(t,e){if("number"!=typeof t)throw new F.ERR_INVALID_ARG_TYPE(e,"number",t)}function q(t,e,r){if(Math.floor(t)!==t)throw H(t,r),new F.ERR_OUT_OF_RANGE(r||"offset","an integer",t);if(e<0)throw new F.ERR_BUFFER_OUT_OF_BOUNDS;throw new F.ERR_OUT_OF_RANGE(r||"offset",`>= ${r?1:0} and <= ${e}`,t)}M("ERR_BUFFER_OUT_OF_BOUNDS",(function(t){return t?`${t} is outside of buffer bounds`:"Attempt to access memory outside buffer bounds"}),RangeError),M("ERR_INVALID_ARG_TYPE",(function(t,e){return`The "${t}" argument must be of type number. Received type ${typeof e}`}),TypeError),M("ERR_OUT_OF_RANGE",(function(t,e,r){let n=`The value of "${t}" is out of range.`,i=r;return Number.isInteger(r)&&Math.abs(r)>2**32?i=P(String(r)):"bigint"==typeof r&&(i=String(r),(r>BigInt(2)**BigInt(32)||r<-(BigInt(2)**BigInt(32)))&&(i=P(i)),i+="n"),n+=` It must be ${e}. Received ${i}`,n}),RangeError);const $=/[^+/0-9A-Za-z-_]/g;function W(t,e){let r;e=e||1/0;const n=t.length;let i=null;const o=[];for(let s=0;s<n;++s){if(r=t.charCodeAt(s),r>55295&&r<57344){if(!i){if(r>56319){(e-=3)>-1&&o.push(239,191,189);continue}if(s+1===n){(e-=3)>-1&&o.push(239,191,189);continue}i=r;continue}if(r<56320){(e-=3)>-1&&o.push(239,191,189),i=r;continue}r=65536+(i-55296<<10|r-56320)}else i&&(e-=3)>-1&&o.push(239,191,189);if(i=null,r<128){if((e-=1)<0)break;o.push(r)}else if(r<2048){if((e-=2)<0)break;o.push(r>>6|192,63&r|128)}else if(r<65536){if((e-=3)<0)break;o.push(r>>12|224,r>>6&63|128,63&r|128)}else{if(!(r<1114112))throw new Error("Invalid code point");if((e-=4)<0)break;o.push(r>>18|240,r>>12&63|128,r>>6&63|128,63&r|128)}}return o}function K(t){return n.toByteArray(function(t){if((t=(t=t.split("=")[0]).trim().replace($,"")).length<2)return"";for(;t.length%4!=0;)t+="=";return t}(t))}function G(t,e,r,n){let i;for(i=0;i<n&&!(i+r>=e.length||i>=t.length);++i)e[i+r]=t[i];return i}function V(t,e){return t instanceof e||null!=t&&null!=t.constructor&&null!=t.constructor.name&&t.constructor.name===e.name}function J(t){return t!=t}const Y=function(){const t="0123456789abcdef",e=new Array(256);for(let r=0;r<16;++r){const n=16*r;for(let i=0;i<16;++i)e[n+i]=t[r]+t[i]}return e}();function X(t){return"undefined"==typeof BigInt?Q:t}function Q(){throw new Error("BigInt not supported")}},vsh_551:function(t,e){\n/*! ieee754. BSD-3-Clause License. Feross Aboukhadijeh <https://feross.org/opensource> */\ne.read=function(t,e,r,n,i){var o,s,a=8*i-n-1,h=(1<<a)-1,u=h>>1,l=-7,f=r?i-1:0,c=r?-1:1,p=t[e+f];for(f+=c,o=p&(1<<-l)-1,p>>=-l,l+=a;l>0;o=256*o+t[e+f],f+=c,l-=8);for(s=o&(1<<-l)-1,o>>=-l,l+=n;l>0;s=256*s+t[e+f],f+=c,l-=8);if(0===o)o=1-u;else{if(o===h)return s?NaN:1/0*(p?-1:1);s+=Math.pow(2,n),o-=u}return(p?-1:1)*s*Math.pow(2,o-n)},e.write=function(t,e,r,n,i,o){var s,a,h,u=8*o-i-1,l=(1<<u)-1,f=l>>1,c=23===i?Math.pow(2,-24)-Math.pow(2,-77):0,p=n?0:o-1,d=n?1:-1,g=e<0||0===e&&1/e<0?1:0;for(e=Math.abs(e),isNaN(e)||e===1/0?(a=isNaN(e)?1:0,s=l):(s=Math.floor(Math.log(e)/Math.LN2),e*(h=Math.pow(2,-s))<1&&(s--,h*=2),(e+=s+f>=1?c/h:c*Math.pow(2,1-f))*h>=2&&(s++,h/=2),s+f>=l?(a=0,s=l):s+f>=1?(a=(e*h-1)*Math.pow(2,i),s+=f):(a=e*Math.pow(2,f-1)*Math.pow(2,i),s=0));i>=8;t[r+p]=255&a,p+=d,a/=256,i-=8);for(s=s<<i|a,u+=i;u>0;t[r+p]=255&s,p+=d,s/=256,u-=8);t[r+p-d]|=128*g}},vsh_776:function(module,exports,__webpack_require__){var __WEBPACK_AMD_DEFINE_ARRAY__,__WEBPACK_AMD_DEFINE_RESULT__;\n/*!\n * protobuf.js v7.2.6 (c) 2016, daniel wirtz\n * compiled tue, 16 jan 2024 22:54:38 utc\n * licensed under the bsd-3-clause license\n * see: https://github.com/dcodeio/protobuf.js for details\n */module=__webpack_require__.nmd(module),function(g){"use strict";var r,e,i;r={1:[function(t,e,r){e.exports=function(t,e){for(var r=Array(arguments.length-1),n=0,i=2,o=!0;i<arguments.length;)r[n++]=arguments[i++];return new Promise((function(i,s){r[n]=function(t){if(o)if(o=!1,t)s(t);else{for(var e=Array(arguments.length-1),r=0;r<e.length;)e[r++]=arguments[r];i.apply(null,e)}};try{t.apply(e||null,r)}catch(t){o&&(o=!1,s(t))}}))}},{}],2:[function(t,e,r){r.length=function(t){var e=t.length;if(!e)return 0;for(var r=0;1<--e%4&&"="==(t[0|e]||"");)++r;return Math.ceil(3*t.length)/4-r};for(var n=Array(64),i=Array(123),o=0;o<64;)i[n[o]=o<26?o+65:o<52?o+71:o<62?o-4:o-59|43]=o++;r.encode=function(t,e,r){for(var i,o=null,s=[],a=0,h=0;e<r;){var u=t[e++];switch(h){case 0:s[a++]=n[u>>2],i=(3&u)<<4,h=1;break;case 1:s[a++]=n[i|u>>4],i=(15&u)<<2,h=2;break;case 2:s[a++]=n[i|u>>6],s[a++]=n[63&u],h=0}8191<a&&((o=o||[]).push(String.fromCharCode.apply(String,s)),a=0)}return h&&(s[a++]=n[i],s[a++]=61,1===h&&(s[a++]=61)),o?(a&&o.push(String.fromCharCode.apply(String,s.slice(0,a))),o.join("")):String.fromCharCode.apply(String,s.slice(0,a))};var s="invalid encoding";r.decode=function(t,e,r){for(var n,o=r,a=0,h=0;h<t.length;){var u=t.charCodeAt(h++);if(61==u&&1<a)break;if((u=i[u])===g)throw Error(s);switch(a){case 0:n=u,a=1;break;case 1:e[r++]=n<<2|(48&u)>>4,n=u,a=2;break;case 2:e[r++]=(15&n)<<4|(60&u)>>2,n=u,a=3;break;case 3:e[r++]=(3&n)<<6|u,a=0}}if(1===a)throw Error(s);return r-o},r.test=function(t){return/^(?:[A-Za-z0-9+/]{4})*(?:[A-Za-z0-9+/]{2}==|[A-Za-z0-9+/]{3}=)?$/.test(t)}},{}],3:[function(t,e,r){(e.exports=function t(e,r){"string"==typeof e&&(r=e,e=g);var n=[];function i(e){if("string"!=typeof e){var r=o();if(t.verbose&&console.log("codegen: "+r),r="return "+r,e){for(var s=Object.keys(e),a=Array(s.length+1),h=Array(s.length),u=0;u<s.length;)a[u]=s[u],h[u]=e[s[u++]];return a[u]=r,Function.apply(null,a).apply(null,h)}return Function(r)()}for(var l=Array(arguments.length-1),f=0;f<l.length;)l[f]=arguments[++f];if(f=0,e=e.replace(/%([%dfijs])/g,(function(t,e){var r=l[f++];switch(e){case"d":case"f":return""+ +(""+r);case"i":return""+Math.floor(r);case"j":return JSON.stringify(r);case"s":return""+r}return"%"})),f!==l.length)throw Error("parameter count mismatch");return n.push(e),i}function o(t){return"function "+(t||r||"")+"("+(e&&e.join(",")||"")+"){\\n  "+n.join("\\n  ")+"\\n}"}return i.toString=o,i}).verbose=!1},{}],4:[function(t,e,r){function n(){this.t={}}(e.exports=n).prototype.on=function(t,e,r){return(this.t[t]||(this.t[t]=[])).push({fn:e,ctx:r||this}),this},n.prototype.off=function(t,e){if(t===g)this.t={};else if(e===g)this.t[t]=[];else for(var r=this.t[t],n=0;n<r.length;)r[n].fn===e?r.splice(n,1):++n;return this},n.prototype.emit=function(t){var e=this.t[t];if(e){for(var r=[],n=1;n<arguments.length;)r.push(arguments[n++]);for(n=0;n<e.length;)e[n].fn.apply(e[n++].ctx,r)}return this}},{}],5:[function(t,e,r){e.exports=o;var n=t(1),i=t(7)("fs");function o(t,e,r){return e="function"==typeof e?(r=e,{}):e||{},r?!e.xhr&&i&&i.readFile?i.readFile(t,(function(n,i){return n&&"undefined"!=typeof XMLHttpRequest?o.xhr(t,e,r):n?r(n):r(null,e.binary?i:i.toString("utf8"))})):o.xhr(t,e,r):n(o,this,t,e)}o.xhr=function(t,e,r){var n=new XMLHttpRequest;n.onreadystatechange=function(){if(4!==n.readyState)return g;if(0!==n.status&&200!==n.status)return r(Error("status "+n.status));if(e.binary){if(!(t=n.response))for(var t=[],i=0;i<n.responseText.length;++i)t.push(255&n.responseText.charCodeAt(i));return r(null,"undefined"!=typeof Uint8Array?new Uint8Array(t):t)}return r(null,n.responseText)},e.binary&&("overrideMimeType"in n&&n.overrideMimeType("text/plain; charset=x-user-defined"),n.responseType="arraybuffer"),n.open("GET",t),n.send()}},{1:1,7:7}],6:[function(t,e,r){function n(t){function e(t,e,r,n){var i=e<0?1:0;t(0===(e=i?-e:e)?0<1/e?0:2147483648:isNaN(e)?2143289344:34028234663852886e22<e?(i<<31|2139095040)>>>0:e<11754943508222875e-54?(i<<31|Math.round(e/1401298464324817e-60))>>>0:(i<<31|127+(t=Math.floor(Math.log(e)/Math.LN2))<<23|8388607&Math.round(e*Math.pow(2,-t)*8388608))>>>0,r,n)}function r(t,e,r){return e=2*((t=t(e,r))>>31)+1,r=t>>>23&255,t&=8388607,255==r?t?NaN:1/0*e:0==r?1401298464324817e-60*e*t:e*Math.pow(2,r-150)*(8388608+t)}function n(t,e,r){f[0]=t,e[r]=c[0],e[r+1]=c[1],e[r+2]=c[2],e[r+3]=c[3]}function h(t,e,r){f[0]=t,e[r]=c[3],e[r+1]=c[2],e[r+2]=c[1],e[r+3]=c[0]}function u(t,e){return c[0]=t[e],c[1]=t[e+1],c[2]=t[e+2],c[3]=t[e+3],f[0]}function l(t,e){return c[3]=t[e],c[2]=t[e+1],c[1]=t[e+2],c[0]=t[e+3],f[0]}var f,c,p,d,g;function y(t,e,r,n,i,o){var s,a=n<0?1:0;0===(n=a?-n:n)?(t(0,i,o+e),t(0<1/n?0:2147483648,i,o+r)):isNaN(n)?(t(0,i,o+e),t(2146959360,i,o+r)):17976931348623157e292<n?(t(0,i,o+e),t((a<<31|2146435072)>>>0,i,o+r)):n<22250738585072014e-324?(t((s=n/5e-324)>>>0,i,o+e),t((a<<31|s/4294967296)>>>0,i,o+r)):(t(4503599627370496*(s=n*Math.pow(2,-(n=1024===(n=Math.floor(Math.log(n)/Math.LN2))?1023:n)))>>>0,i,o+e),t((a<<31|n+1023<<20|1048576*s&1048575)>>>0,i,o+r))}function m(t,e,r,n,i){return e=t(n,i+e),n=2*((t=t(n,i+r))>>31)+1,r=4294967296*(1048575&t)+e,2047==(i=t>>>20&2047)?r?NaN:1/0*n:0==i?5e-324*n*r:n*Math.pow(2,i-1075)*(r+4503599627370496)}function _(t,e,r){p[0]=t,e[r]=d[0],e[r+1]=d[1],e[r+2]=d[2],e[r+3]=d[3],e[r+4]=d[4],e[r+5]=d[5],e[r+6]=d[6],e[r+7]=d[7]}function b(t,e,r){p[0]=t,e[r]=d[7],e[r+1]=d[6],e[r+2]=d[5],e[r+3]=d[4],e[r+4]=d[3],e[r+5]=d[2],e[r+6]=d[1],e[r+7]=d[0]}function w(t,e){return d[0]=t[e],d[1]=t[e+1],d[2]=t[e+2],d[3]=t[e+3],d[4]=t[e+4],d[5]=t[e+5],d[6]=t[e+6],d[7]=t[e+7],p[0]}function v(t,e){return d[7]=t[e],d[6]=t[e+1],d[5]=t[e+2],d[4]=t[e+3],d[3]=t[e+4],d[2]=t[e+5],d[1]=t[e+6],d[0]=t[e+7],p[0]}return"undefined"!=typeof Float32Array?(f=new Float32Array([-0]),g=128===(c=new Uint8Array(f.buffer))[3],t.writeFloatLE=g?n:h,t.writeFloatBE=g?h:n,t.readFloatLE=g?u:l,t.readFloatBE=g?l:u):(t.writeFloatLE=e.bind(null,i),t.writeFloatBE=e.bind(null,o),t.readFloatLE=r.bind(null,s),t.readFloatBE=r.bind(null,a)),"undefined"!=typeof Float64Array?(p=new Float64Array([-0]),g=128===(d=new Uint8Array(p.buffer))[7],t.writeDoubleLE=g?_:b,t.writeDoubleBE=g?b:_,t.readDoubleLE=g?w:v,t.readDoubleBE=g?v:w):(t.writeDoubleLE=y.bind(null,i,0,4),t.writeDoubleBE=y.bind(null,o,4,0),t.readDoubleLE=m.bind(null,s,0,4),t.readDoubleBE=m.bind(null,a,4,0)),t}function i(t,e,r){e[r]=255&t,e[r+1]=t>>>8&255,e[r+2]=t>>>16&255,e[r+3]=t>>>24}function o(t,e,r){e[r]=t>>>24,e[r+1]=t>>>16&255,e[r+2]=t>>>8&255,e[r+3]=255&t}function s(t,e){return(t[e]|t[e+1]<<8|t[e+2]<<16|t[e+3]<<24)>>>0}function a(t,e){return(t[e]<<24|t[e+1]<<16|t[e+2]<<8|t[e+3])>>>0}e.exports=n(n)},{}],7:[function(t,i,n){function r(t){try{var i=eval("require")(t);if(i&&(i.length||Object.keys(i).length))return i}catch(t){}return null}i.exports=r},{}],8:[function(t,e,r){var n=r.isAbsolute=function(t){return/^(?:\\/|\\w+:)/.test(t)},i=r.normalize=function(t){var e=(t=t.replace(/\\\\/g,"/").replace(/\\/{2,}/g,"/")).split("/"),r=n(t);t="",r&&(t=e.shift()+"/");for(var i=0;i<e.length;)".."===e[i]?0<i&&".."!==e[i-1]?e.splice(--i,2):r?e.splice(i,1):++i:"."===e[i]?e.splice(i,1):++i;return t+e.join("/")};r.resolve=function(t,e,r){return r||(e=i(e)),!n(e)&&(t=(t=r?t:i(t)).replace(/(?:\\/|^)[^/]+$/,"")).length?i(t+"/"+e):e}},{}],9:[function(t,e,r){e.exports=function(t,e,r){var n=r||8192,i=n>>>1,o=null,s=n;return function(r){return r<1||i<r?t(r):(n<s+r&&(o=t(n),s=0),r=e.call(o,s,s+=r),7&s&&(s=1+(7|s)),r)}}},{}],10:[function(t,e,r){r.length=function(t){for(var e,r=0,n=0;n<t.length;++n)(e=t.charCodeAt(n))<128?r+=1:e<2048?r+=2:55296==(64512&e)&&56320==(64512&t.charCodeAt(n+1))?(++n,r+=4):r+=3;return r},r.read=function(t,e,r){if(r-e<1)return"";for(var n,i=null,o=[],s=0;e<r;)(n=t[e++])<128?o[s++]=n:191<n&&n<224?o[s++]=(31&n)<<6|63&t[e++]:239<n&&n<365?(n=((7&n)<<18|(63&t[e++])<<12|(63&t[e++])<<6|63&t[e++])-65536,o[s++]=55296+(n>>10),o[s++]=56320+(1023&n)):o[s++]=(15&n)<<12|(63&t[e++])<<6|63&t[e++],8191<s&&((i=i||[]).push(String.fromCharCode.apply(String,o)),s=0);return i?(s&&i.push(String.fromCharCode.apply(String,o.slice(0,s))),i.join("")):String.fromCharCode.apply(String,o.slice(0,s))},r.write=function(t,e,r){for(var n,i,o=r,s=0;s<t.length;++s)(n=t.charCodeAt(s))<128?e[r++]=n:(n<2048?e[r++]=n>>6|192:(55296==(64512&n)&&56320==(64512&(i=t.charCodeAt(s+1)))?(++s,e[r++]=(n=65536+((1023&n)<<10)+(1023&i))>>18|240,e[r++]=n>>12&63|128):e[r++]=n>>12|224,e[r++]=n>>6&63|128),e[r++]=63&n|128);return r-o}},{}],11:[function(t,e,r){var n=t(14),i=t(33);function o(t,e,r,i){var o=!1;if(e.resolvedType)if(e.resolvedType instanceof n){t("switch(d%s){",i);for(var s=e.resolvedType.values,a=Object.keys(s),h=0;h<a.length;++h)s[a[h]]!==e.typeDefault||o||(t("default:")(\'if(typeof(d%s)==="number"){m%s=d%s;break}\',i,i,i),e.repeated||t("break"),o=!0),t("case%j:",a[h])("case %i:",s[a[h]])("m%s=%j",i,s[a[h]])("break");t("}")}else t(\'if(typeof d%s!=="object")\',i)("throw TypeError(%j)",e.fullName+": object expected")("m%s=types[%i].fromObject(d%s)",i,r,i);else{var u=!1;switch(e.type){case"double":case"float":t("m%s=Number(d%s)",i,i);break;case"uint32":case"fixed32":t("m%s=d%s>>>0",i,i);break;case"int32":case"sint32":case"sfixed32":t("m%s=d%s|0",i,i);break;case"uint64":u=!0;case"int64":case"sint64":case"fixed64":case"sfixed64":t("if(util.Long)")("(m%s=util.Long.fromValue(d%s)).unsigned=%j",i,i,u)(\'else if(typeof d%s==="string")\',i)("m%s=parseInt(d%s,10)",i,i)(\'else if(typeof d%s==="number")\',i)("m%s=d%s",i,i)(\'else if(typeof d%s==="object")\',i)("m%s=new util.LongBits(d%s.low>>>0,d%s.high>>>0).toNumber(%s)",i,i,i,u?"true":"");break;case"bytes":t(\'if(typeof d%s==="string")\',i)("util.base64.decode(d%s,m%s=util.newBuffer(util.base64.length(d%s)),0)",i,i,i)("else if(d%s.length >= 0)",i)("m%s=d%s",i,i);break;case"string":t("m%s=String(d%s)",i,i);break;case"bool":t("m%s=Boolean(d%s)",i,i)}}return t}function s(t,e,r,i){if(e.resolvedType)e.resolvedType instanceof n?t("d%s=o.enums===String?(types[%i].values[m%s]===undefined?m%s:types[%i].values[m%s]):m%s",i,r,i,i,r,i,i):t("d%s=types[%i].toObject(m%s,o)",i,r,i);else{var o=!1;switch(e.type){case"double":case"float":t("d%s=o.json&&!isFinite(m%s)?String(m%s):m%s",i,i,i,i);break;case"uint64":o=!0;case"int64":case"sint64":case"fixed64":case"sfixed64":t(\'if(typeof m%s==="number")\',i)("d%s=o.longs===String?String(m%s):m%s",i,i,i)("else")("d%s=o.longs===String?util.Long.prototype.toString.call(m%s):o.longs===Number?new util.LongBits(m%s.low>>>0,m%s.high>>>0).toNumber(%s):m%s",i,i,i,i,o?"true":"",i);break;case"bytes":t("d%s=o.bytes===String?util.base64.encode(m%s,0,m%s.length):o.bytes===Array?Array.prototype.slice.call(m%s):m%s",i,i,i,i,i);break;default:t("d%s=m%s",i,i)}}return t}r.fromObject=function(t){var e=t.fieldsArray,r=i.codegen(["d"],t.name+"$fromObject")("if(d instanceof this.ctor)")("return d");if(!e.length)return r("return new this.ctor");r("var m=new this.ctor");for(var s=0;s<e.length;++s){var a=e[s].resolve(),h=i.safeProp(a.name);a.map?(r("if(d%s){",h)(\'if(typeof d%s!=="object")\',h)("throw TypeError(%j)",a.fullName+": object expected")("m%s={}",h)("for(var ks=Object.keys(d%s),i=0;i<ks.length;++i){",h),o(r,a,s,h+"[ks[i]]")("}")("}")):a.repeated?(r("if(d%s){",h)("if(!Array.isArray(d%s))",h)("throw TypeError(%j)",a.fullName+": array expected")("m%s=[]",h)("for(var i=0;i<d%s.length;++i){",h),o(r,a,s,h+"[i]")("}")("}")):(a.resolvedType instanceof n||r("if(d%s!=null){",h),o(r,a,s,h),a.resolvedType instanceof n||r("}"))}return r("return m")},r.toObject=function(t){var e=t.fieldsArray.slice().sort(i.compareFieldsById);if(!e.length)return i.codegen()("return {}");for(var r=i.codegen(["m","o"],t.name+"$toObject")("if(!o)")("o={}")("var d={}"),o=[],a=[],h=[],u=0;u<e.length;++u)e[u].partOf||(e[u].resolve().repeated?o:e[u].map?a:h).push(e[u]);if(o.length){for(r("if(o.arrays||o.defaults){"),u=0;u<o.length;++u)r("d%s=[]",i.safeProp(o[u].name));r("}")}if(a.length){for(r("if(o.objects||o.defaults){"),u=0;u<a.length;++u)r("d%s={}",i.safeProp(a[u].name));r("}")}if(h.length){for(r("if(o.defaults){"),u=0;u<h.length;++u){var l,f=h[u],c=i.safeProp(f.name);f.resolvedType instanceof n?r("d%s=o.enums===String?%j:%j",c,f.resolvedType.valuesById[f.typeDefault],f.typeDefault):f.long?r("if(util.Long){")("var n=new util.Long(%i,%i,%j)",f.typeDefault.low,f.typeDefault.high,f.typeDefault.unsigned)("d%s=o.longs===String?n.toString():o.longs===Number?n.toNumber():n",c)("}else")("d%s=o.longs===String?%j:%i",c,f.typeDefault.toString(),f.typeDefault.toNumber()):f.bytes?(l="["+Array.prototype.slice.call(f.typeDefault).join(",")+"]",r("if(o.bytes===String)d%s=%j",c,String.fromCharCode.apply(String,f.typeDefault))("else{")("d%s=%s",c,l)("if(o.bytes!==Array)d%s=util.newBuffer(d%s)",c,c)("}")):r("d%s=%j",c,f.typeDefault)}r("}")}var p=!1;for(u=0;u<e.length;++u){f=e[u];var d=t.i.indexOf(f);c=i.safeProp(f.name),f.map?(p||(p=!0,r("var ks2")),r("if(m%s&&(ks2=Object.keys(m%s)).length){",c,c)("d%s={}",c)("for(var j=0;j<ks2.length;++j){"),s(r,f,d,c+"[ks2[j]]")("}")):f.repeated?(r("if(m%s&&m%s.length){",c,c)("d%s=[]",c)("for(var j=0;j<m%s.length;++j){",c),s(r,f,d,c+"[j]")("}")):(r("if(m%s!=null&&m.hasOwnProperty(%j)){",c,f.name),s(r,f,d,c),f.partOf&&r("if(o.oneofs)")("d%s=%j",i.safeProp(f.partOf.name),f.name)),r("}")}return r("return d")}},{14:14,33:33}],12:[function(t,e,r){e.exports=function(t){var e=o.codegen(["r","l"],t.name+"$decode")("if(!(r instanceof Reader))")("r=Reader.create(r)")("var c=l===undefined?r.len:r.pos+l,m=new this.ctor"+(t.fieldsArray.filter((function(t){return t.map})).length?",k,value":""))("while(r.pos<c){")("var t=r.uint32()");t.group&&e("if((t&7)===4)")("break"),e("switch(t>>>3){");for(var r=0;r<t.fieldsArray.length;++r){var s=t.i[r].resolve(),a=s.resolvedType instanceof n?"int32":s.type,h="m"+o.safeProp(s.name);e("case %i: {",s.id),s.map?(e("if(%s===util.emptyObject)",h)("%s={}",h)("var c2 = r.uint32()+r.pos"),i.defaults[s.keyType]!==g?e("k=%j",i.defaults[s.keyType]):e("k=null"),i.defaults[a]!==g?e("value=%j",i.defaults[a]):e("value=null"),e("while(r.pos<c2){")("var tag2=r.uint32()")("switch(tag2>>>3){")("case 1: k=r.%s(); break",s.keyType)("case 2:"),i.basic[a]===g?e("value=types[%i].decode(r,r.uint32())",r):e("value=r.%s()",a),e("break")("default:")("r.skipType(tag2&7)")("break")("}")("}"),i.long[s.keyType]!==g?e(\'%s[typeof k==="object"?util.longToHash(k):k]=value\',h):e("%s[k]=value",h)):s.repeated?(e("if(!(%s&&%s.length))",h,h)("%s=[]",h),i.packed[a]!==g&&e("if((t&7)===2){")("var c2=r.uint32()+r.pos")("while(r.pos<c2)")("%s.push(r.%s())",h,a)("}else"),i.basic[a]===g?e(s.resolvedType.group?"%s.push(types[%i].decode(r))":"%s.push(types[%i].decode(r,r.uint32()))",h,r):e("%s.push(r.%s())",h,a)):i.basic[a]===g?e(s.resolvedType.group?"%s=types[%i].decode(r)":"%s=types[%i].decode(r,r.uint32())",h,r):e("%s=r.%s()",h,a),e("break")("}")}for(e("default:")("r.skipType(t&7)")("break")("}")("}"),r=0;r<t.i.length;++r){var u=t.i[r];u.required&&e("if(!m.hasOwnProperty(%j))",u.name)("throw util.ProtocolError(%j,{instance:m})","missing required \'"+u.name+"\'")}return e("return m")};var n=t(14),i=t(32),o=t(33)},{14:14,32:32,33:33}],13:[function(t,e,r){e.exports=function(t){for(var e,r=o.codegen(["m","w"],t.name+"$encode")("if(!w)")("w=Writer.create()"),a=t.fieldsArray.slice().sort(o.compareFieldsById),h=0;h<a.length;++h){var u=a[h].resolve(),l=t.i.indexOf(u),f=u.resolvedType instanceof n?"int32":u.type,c=i.basic[f];e="m"+o.safeProp(u.name),u.map?(r("if(%s!=null&&Object.hasOwnProperty.call(m,%j)){",e,u.name)("for(var ks=Object.keys(%s),i=0;i<ks.length;++i){",e)("w.uint32(%i).fork().uint32(%i).%s(ks[i])",(u.id<<3|2)>>>0,8|i.mapKey[u.keyType],u.keyType),c===g?r("types[%i].encode(%s[ks[i]],w.uint32(18).fork()).ldelim().ldelim()",l,e):r(".uint32(%i).%s(%s[ks[i]]).ldelim()",16|c,f,e),r("}")("}")):u.repeated?(r("if(%s!=null&&%s.length){",e,e),u.packed&&i.packed[f]!==g?r("w.uint32(%i).fork()",(u.id<<3|2)>>>0)("for(var i=0;i<%s.length;++i)",e)("w.%s(%s[i])",f,e)("w.ldelim()"):(r("for(var i=0;i<%s.length;++i)",e),c===g?s(r,u,l,e+"[i]"):r("w.uint32(%i).%s(%s[i])",(u.id<<3|c)>>>0,f,e)),r("}")):(u.optional&&r("if(%s!=null&&Object.hasOwnProperty.call(m,%j))",e,u.name),c===g?s(r,u,l,e):r("w.uint32(%i).%s(%s)",(u.id<<3|c)>>>0,f,e))}return r("return w")};var n=t(14),i=t(32),o=t(33);function s(t,e,r,n){e.resolvedType.group?t("types[%i].encode(%s,w.uint32(%i)).uint32(%i)",r,n,(e.id<<3|3)>>>0,(e.id<<3|4)>>>0):t("types[%i].encode(%s,w.uint32(%i).fork()).ldelim()",r,n,(e.id<<3|2)>>>0)}},{14:14,32:32,33:33}],14:[function(t,e,r){e.exports=s;var n=t(22),i=(((s.prototype=Object.create(n.prototype)).constructor=s).className="Enum",t(21)),o=t(33);function s(t,e,r,i,o,s){if(n.call(this,t,r),e&&"object"!=typeof e)throw TypeError("values must be an object");if(this.valuesById={},this.values=Object.create(this.valuesById),this.comment=i,this.comments=o||{},this.valuesOptions=s,this.reserved=g,e)for(var a=Object.keys(e),h=0;h<a.length;++h)"number"==typeof e[a[h]]&&(this.valuesById[this.values[a[h]]=e[a[h]]]=a[h])}s.fromJSON=function(t,e){return(t=new s(t,e.values,e.options,e.comment,e.comments)).reserved=e.reserved,t},s.prototype.toJSON=function(t){return t=!!t&&!!t.keepComments,o.toObject(["options",this.options,"valuesOptions",this.valuesOptions,"values",this.values,"reserved",this.reserved&&this.reserved.length?this.reserved:g,"comment",t?this.comment:g,"comments",t?this.comments:g])},s.prototype.add=function(t,e,r,n){if(!o.isString(t))throw TypeError("name must be a string");if(!o.isInteger(e))throw TypeError("id must be an integer");if(this.values[t]!==g)throw Error("duplicate name \'"+t+"\' in "+this);if(this.isReservedId(e))throw Error("id "+e+" is reserved in "+this);if(this.isReservedName(t))throw Error("name \'"+t+"\' is reserved in "+this);if(this.valuesById[e]!==g){if(!this.options||!this.options.allow_alias)throw Error("duplicate id "+e+" in "+this);this.values[t]=e}else this.valuesById[this.values[t]=e]=t;return n&&(this.valuesOptions===g&&(this.valuesOptions={}),this.valuesOptions[t]=n||null),this.comments[t]=r||null,this},s.prototype.remove=function(t){if(!o.isString(t))throw TypeError("name must be a string");var e=this.values[t];if(null==e)throw Error("name \'"+t+"\' does not exist in "+this);return delete this.valuesById[e],delete this.values[t],delete this.comments[t],this.valuesOptions&&delete this.valuesOptions[t],this},s.prototype.isReservedId=function(t){return i.isReservedId(this.reserved,t)},s.prototype.isReservedName=function(t){return i.isReservedName(this.reserved,t)}},{21:21,22:22,33:33}],15:[function(t,e,r){e.exports=u;var n,i=t(22),o=(((u.prototype=Object.create(i.prototype)).constructor=u).className="Field",t(14)),s=t(32),a=t(33),h=/^required|optional|repeated$/;function u(t,e,r,n,o,u,l){if(a.isObject(n)?(l=o,u=n,n=o=g):a.isObject(o)&&(l=u,u=o,o=g),i.call(this,t,u),!a.isInteger(e)||e<0)throw TypeError("id must be a non-negative integer");if(!a.isString(r))throw TypeError("type must be a string");if(n!==g&&!h.test(n=n.toString().toLowerCase()))throw TypeError("rule must be a string rule");if(o!==g&&!a.isString(o))throw TypeError("extend must be a string");this.rule=(n="proto3_optional"===n?"optional":n)&&"optional"!==n?n:g,this.type=r,this.id=e,this.extend=o||g,this.required="required"===n,this.optional=!this.required,this.repeated="repeated"===n,this.map=!1,this.message=null,this.partOf=null,this.typeDefault=null,this.defaultValue=null,this.long=!!a.Long&&s.long[r]!==g,this.bytes="bytes"===r,this.resolvedType=null,this.extensionField=null,this.declaringField=null,this.n=null,this.comment=l}u.fromJSON=function(t,e){return new u(t,e.id,e.type,e.rule,e.extend,e.options,e.comment)},Object.defineProperty(u.prototype,"packed",{get:function(){return null===this.n&&(this.n=!1!==this.getOption("packed")),this.n}}),u.prototype.setOption=function(t,e,r){return"packed"===t&&(this.n=null),i.prototype.setOption.call(this,t,e,r)},u.prototype.toJSON=function(t){return t=!!t&&!!t.keepComments,a.toObject(["rule","optional"!==this.rule&&this.rule||g,"type",this.type,"id",this.id,"extend",this.extend,"options",this.options,"comment",t?this.comment:g])},u.prototype.resolve=function(){var t;return this.resolved?this:((this.typeDefault=s.defaults[this.type])===g?(this.resolvedType=(this.declaringField||this).parent.lookupTypeOrEnum(this.type),this.resolvedType instanceof n?this.typeDefault=null:this.typeDefault=this.resolvedType.values[Object.keys(this.resolvedType.values)[0]]):this.options&&this.options.proto3_optional&&(this.typeDefault=null),this.options&&null!=this.options.default&&(this.typeDefault=this.options.default,this.resolvedType instanceof o&&"string"==typeof this.typeDefault&&(this.typeDefault=this.resolvedType.values[this.typeDefault])),this.options&&(!0!==this.options.packed&&(this.options.packed===g||!this.resolvedType||this.resolvedType instanceof o)||delete this.options.packed,Object.keys(this.options).length||(this.options=g)),this.long?(this.typeDefault=a.Long.fromNumber(this.typeDefault,"u"==(this.type[0]||"")),Object.freeze&&Object.freeze(this.typeDefault)):this.bytes&&"string"==typeof this.typeDefault&&(a.base64.test(this.typeDefault)?a.base64.decode(this.typeDefault,t=a.newBuffer(a.base64.length(this.typeDefault)),0):a.utf8.write(this.typeDefault,t=a.newBuffer(a.utf8.length(this.typeDefault)),0),this.typeDefault=t),this.map?this.defaultValue=a.emptyObject:this.repeated?this.defaultValue=a.emptyArray:this.defaultValue=this.typeDefault,this.parent instanceof n&&(this.parent.ctor.prototype[this.name]=this.defaultValue),i.prototype.resolve.call(this))},u.d=function(t,e,r,n){return"function"==typeof e?e=a.decorateType(e).name:e&&"object"==typeof e&&(e=a.decorateEnum(e).name),function(i,o){a.decorateType(i.constructor).add(new u(o,t,e,r,{default:n}))}},u.r=function(t){n=t}},{14:14,22:22,32:32,33:33}],16:[function(t,e,r){var n=e.exports=t(17);n.build="light",n.load=function(t,e,r){return(e="function"==typeof e?(r=e,new n.Root):e||new n.Root).load(t,r)},n.loadSync=function(t,e){return(e=e||new n.Root).loadSync(t)},n.encoder=t(13),n.decoder=t(12),n.verifier=t(36),n.converter=t(11),n.ReflectionObject=t(22),n.Namespace=t(21),n.Root=t(26),n.Enum=t(14),n.Type=t(31),n.Field=t(15),n.OneOf=t(23),n.MapField=t(18),n.Service=t(30),n.Method=t(20),n.Message=t(19),n.wrappers=t(37),n.types=t(32),n.util=t(33),n.ReflectionObject.r(n.Root),n.Namespace.r(n.Type,n.Service,n.Enum),n.Root.r(n.Type),n.Field.r(n.Type)},{11:11,12:12,13:13,14:14,15:15,17:17,18:18,19:19,20:20,21:21,22:22,23:23,26:26,30:30,31:31,32:32,33:33,36:36,37:37}],17:[function(t,e,r){var n=r;function i(){n.util.r(),n.Writer.r(n.BufferWriter),n.Reader.r(n.BufferReader)}n.build="minimal",n.Writer=t(38),n.BufferWriter=t(39),n.Reader=t(24),n.BufferReader=t(25),n.util=t(35),n.rpc=t(28),n.roots=t(27),n.configure=i,i()},{24:24,25:25,27:27,28:28,35:35,38:38,39:39}],18:[function(t,e,r){e.exports=s;var n=t(15),i=(((s.prototype=Object.create(n.prototype)).constructor=s).className="MapField",t(32)),o=t(33);function s(t,e,r,i,s,a){if(n.call(this,t,e,i,g,g,s,a),!o.isString(r))throw TypeError("keyType must be a string");this.keyType=r,this.resolvedKeyType=null,this.map=!0}s.fromJSON=function(t,e){return new s(t,e.id,e.keyType,e.type,e.options,e.comment)},s.prototype.toJSON=function(t){return t=!!t&&!!t.keepComments,o.toObject(["keyType",this.keyType,"type",this.type,"id",this.id,"extend",this.extend,"options",this.options,"comment",t?this.comment:g])},s.prototype.resolve=function(){if(this.resolved)return this;if(i.mapKey[this.keyType]===g)throw Error("invalid key type: "+this.keyType);return n.prototype.resolve.call(this)},s.d=function(t,e,r){return"function"==typeof r?r=o.decorateType(r).name:r&&"object"==typeof r&&(r=o.decorateEnum(r).name),function(n,i){o.decorateType(n.constructor).add(new s(i,t,e,r))}}},{15:15,32:32,33:33}],19:[function(t,e,r){e.exports=i;var n=t(35);function i(t){if(t)for(var e=Object.keys(t),r=0;r<e.length;++r)this[e[r]]=t[e[r]]}i.create=function(t){return this.$type.create(t)},i.encode=function(t,e){return this.$type.encode(t,e)},i.encodeDelimited=function(t,e){return this.$type.encodeDelimited(t,e)},i.decode=function(t){return this.$type.decode(t)},i.decodeDelimited=function(t){return this.$type.decodeDelimited(t)},i.verify=function(t){return this.$type.verify(t)},i.fromObject=function(t){return this.$type.fromObject(t)},i.toObject=function(t,e){return this.$type.toObject(t,e)},i.prototype.toJSON=function(){return this.$type.toObject(this,n.toJSONOptions)}},{35:35}],20:[function(t,e,r){e.exports=o;var n=t(22),i=(((o.prototype=Object.create(n.prototype)).constructor=o).className="Method",t(33));function o(t,e,r,o,s,a,h,u,l){if(i.isObject(s)?(h=s,s=a=g):i.isObject(a)&&(h=a,a=g),e!==g&&!i.isString(e))throw TypeError("type must be a string");if(!i.isString(r))throw TypeError("requestType must be a string");if(!i.isString(o))throw TypeError("responseType must be a string");n.call(this,t,h),this.type=e||"rpc",this.requestType=r,this.requestStream=!!s||g,this.responseType=o,this.responseStream=!!a||g,this.resolvedRequestType=null,this.resolvedResponseType=null,this.comment=u,this.parsedOptions=l}o.fromJSON=function(t,e){return new o(t,e.type,e.requestType,e.responseType,e.requestStream,e.responseStream,e.options,e.comment,e.parsedOptions)},o.prototype.toJSON=function(t){return t=!!t&&!!t.keepComments,i.toObject(["type","rpc"!==this.type&&this.type||g,"requestType",this.requestType,"requestStream",this.requestStream,"responseType",this.responseType,"responseStream",this.responseStream,"options",this.options,"comment",t?this.comment:g,"parsedOptions",this.parsedOptions])},o.prototype.resolve=function(){return this.resolved?this:(this.resolvedRequestType=this.parent.lookupType(this.requestType),this.resolvedResponseType=this.parent.lookupType(this.responseType),n.prototype.resolve.call(this))}},{22:22,33:33}],21:[function(t,e,r){e.exports=f;var n,i,o,s=t(22),a=(((f.prototype=Object.create(s.prototype)).constructor=f).className="Namespace",t(15)),h=t(33),u=t(23);function l(t,e){if(!t||!t.length)return g;for(var r={},n=0;n<t.length;++n)r[t[n].name]=t[n].toJSON(e);return r}function f(t,e){s.call(this,t,e),this.nested=g,this.e=null}function c(t){return t.e=null,t}f.fromJSON=function(t,e){return new f(t,e.options).addJSON(e.nested)},f.arrayToJSON=l,f.isReservedId=function(t,e){if(t)for(var r=0;r<t.length;++r)if("string"!=typeof t[r]&&t[r][0]<=e&&t[r][1]>e)return!0;return!1},f.isReservedName=function(t,e){if(t)for(var r=0;r<t.length;++r)if(t[r]===e)return!0;return!1},Object.defineProperty(f.prototype,"nestedArray",{get:function(){return this.e||(this.e=h.toArray(this.nested))}}),f.prototype.toJSON=function(t){return h.toObject(["options",this.options,"nested",l(this.nestedArray,t)])},f.prototype.addJSON=function(t){if(t)for(var e,r=Object.keys(t),s=0;s<r.length;++s)e=t[r[s]],this.add((e.fields!==g?n:e.values!==g?o:e.methods!==g?i:e.id!==g?a:f).fromJSON(r[s],e));return this},f.prototype.get=function(t){return this.nested&&this.nested[t]||null},f.prototype.getEnum=function(t){if(this.nested&&this.nested[t]instanceof o)return this.nested[t].values;throw Error("no such enum: "+t)},f.prototype.add=function(t){if(!(t instanceof a&&t.extend!==g||t instanceof n||t instanceof u||t instanceof o||t instanceof i||t instanceof f))throw TypeError("object must be a valid nested object");if(this.nested){var e=this.get(t.name);if(e){if(!(e instanceof f&&t instanceof f)||e instanceof n||e instanceof i)throw Error("duplicate name \'"+t.name+"\' in "+this);for(var r=e.nestedArray,s=0;s<r.length;++s)t.add(r[s]);this.remove(e),this.nested||(this.nested={}),t.setOptions(e.options,!0)}}else this.nested={};return(this.nested[t.name]=t).onAdd(this),c(this)},f.prototype.remove=function(t){if(!(t instanceof s))throw TypeError("object must be a ReflectionObject");if(t.parent!==this)throw Error(t+" is not a member of "+this);return delete this.nested[t.name],Object.keys(this.nested).length||(this.nested=g),t.onRemove(this),c(this)},f.prototype.define=function(t,e){if(h.isString(t))t=t.split(".");else if(!Array.isArray(t))throw TypeError("illegal path");if(t&&t.length&&""===t[0])throw Error("path must be relative");for(var r=this;0<t.length;){var n=t.shift();if(r.nested&&r.nested[n]){if(!((r=r.nested[n])instanceof f))throw Error("path conflicts with non-namespace objects")}else r.add(r=new f(n))}return e&&r.addJSON(e),r},f.prototype.resolveAll=function(){for(var t=this.nestedArray,e=0;e<t.length;)t[e]instanceof f?t[e++].resolveAll():t[e++].resolve();return this.resolve()},f.prototype.lookup=function(t,e,r){if("boolean"==typeof e?(r=e,e=g):e&&!Array.isArray(e)&&(e=[e]),h.isString(t)&&t.length){if("."===t)return this.root;t=t.split(".")}else if(!t.length)return this;if(""===t[0])return this.root.lookup(t.slice(1),e);var n=this.get(t[0]);if(n){if(1===t.length){if(!e||~e.indexOf(n.constructor))return n}else if(n instanceof f&&(n=n.lookup(t.slice(1),e,!0)))return n}else for(var i=0;i<this.nestedArray.length;++i)if(this.e[i]instanceof f&&(n=this.e[i].lookup(t,e,!0)))return n;return null===this.parent||r?null:this.parent.lookup(t,e)},f.prototype.lookupType=function(t){var e=this.lookup(t,[n]);if(e)return e;throw Error("no such type: "+t)},f.prototype.lookupEnum=function(t){var e=this.lookup(t,[o]);if(e)return e;throw Error("no such Enum \'"+t+"\' in "+this)},f.prototype.lookupTypeOrEnum=function(t){var e=this.lookup(t,[n,o]);if(e)return e;throw Error("no such Type or Enum \'"+t+"\' in "+this)},f.prototype.lookupService=function(t){var e=this.lookup(t,[i]);if(e)return e;throw Error("no such Service \'"+t+"\' in "+this)},f.r=function(t,e,r){n=t,i=e,o=r}},{15:15,22:22,23:23,33:33}],22:[function(t,e,r){(e.exports=o).className="ReflectionObject";var n,i=t(33);function o(t,e){if(!i.isString(t))throw TypeError("name must be a string");if(e&&!i.isObject(e))throw TypeError("options must be an object");this.options=e,this.parsedOptions=null,this.name=t,this.parent=null,this.resolved=!1,this.comment=null,this.filename=null}Object.defineProperties(o.prototype,{root:{get:function(){for(var t=this;null!==t.parent;)t=t.parent;return t}},fullName:{get:function(){for(var t=[this.name],e=this.parent;e;)t.unshift(e.name),e=e.parent;return t.join(".")}}}),o.prototype.toJSON=function(){throw Error()},o.prototype.onAdd=function(t){this.parent&&this.parent!==t&&this.parent.remove(this),this.parent=t,this.resolved=!1,(t=t.root)instanceof n&&t.u(this)},o.prototype.onRemove=function(t){(t=t.root)instanceof n&&t.o(this),this.parent=null,this.resolved=!1},o.prototype.resolve=function(){return this.resolved||this.root instanceof n&&(this.resolved=!0),this},o.prototype.getOption=function(t){return this.options?this.options[t]:g},o.prototype.setOption=function(t,e,r){return r&&this.options&&this.options[t]!==g||((this.options||(this.options={}))[t]=e),this},o.prototype.setParsedOption=function(t,e,r){this.parsedOptions||(this.parsedOptions=[]);var n,o,s=this.parsedOptions;return r?(n=s.find((function(e){return Object.prototype.hasOwnProperty.call(e,t)})))?(o=n[t],i.setProperty(o,r,e)):((n={})[t]=i.setProperty({},r,e),s.push(n)):((o={})[t]=e,s.push(o)),this},o.prototype.setOptions=function(t,e){if(t)for(var r=Object.keys(t),n=0;n<r.length;++n)this.setOption(r[n],t[r[n]],e);return this},o.prototype.toString=function(){var t=this.constructor.className,e=this.fullName;return e.length?t+" "+e:t},o.r=function(t){n=t}},{33:33}],23:[function(t,e,r){e.exports=s;var n=t(22),i=(((s.prototype=Object.create(n.prototype)).constructor=s).className="OneOf",t(15)),o=t(33);function s(t,e,r,i){if(Array.isArray(e)||(r=e,e=g),n.call(this,t,r),e!==g&&!Array.isArray(e))throw TypeError("fieldNames must be an Array");this.oneof=e||[],this.fieldsArray=[],this.comment=i}function a(t){if(t.parent)for(var e=0;e<t.fieldsArray.length;++e)t.fieldsArray[e].parent||t.parent.add(t.fieldsArray[e])}s.fromJSON=function(t,e){return new s(t,e.oneof,e.options,e.comment)},s.prototype.toJSON=function(t){return t=!!t&&!!t.keepComments,o.toObject(["options",this.options,"oneof",this.oneof,"comment",t?this.comment:g])},s.prototype.add=function(t){if(t instanceof i)return t.parent&&t.parent!==this.parent&&t.parent.remove(t),this.oneof.push(t.name),this.fieldsArray.push(t),a(t.partOf=this),this;throw TypeError("field must be a Field")},s.prototype.remove=function(t){if(!(t instanceof i))throw TypeError("field must be a Field");var e=this.fieldsArray.indexOf(t);if(e<0)throw Error(t+" is not a member of "+this);return this.fieldsArray.splice(e,1),-1<(e=this.oneof.indexOf(t.name))&&this.oneof.splice(e,1),t.partOf=null,this},s.prototype.onAdd=function(t){n.prototype.onAdd.call(this,t);for(var e=0;e<this.oneof.length;++e){var r=t.get(this.oneof[e]);r&&!r.partOf&&(r.partOf=this).fieldsArray.push(r)}a(this)},s.prototype.onRemove=function(t){for(var e,r=0;r<this.fieldsArray.length;++r)(e=this.fieldsArray[r]).parent&&e.parent.remove(e);n.prototype.onRemove.call(this,t)},s.d=function(){for(var t=Array(arguments.length),e=0;e<arguments.length;)t[e]=arguments[e++];return function(e,r){o.decorateType(e.constructor).add(new s(r,t)),Object.defineProperty(e,r,{get:o.oneOfGetter(t),set:o.oneOfSetter(t)})}}},{15:15,22:22,33:33}],24:[function(t,e,r){e.exports=h;var n,i=t(35),o=i.LongBits,s=i.utf8;function a(t,e){return RangeError("index out of range: "+t.pos+" + "+(e||1)+" > "+t.len)}function h(t){this.buf=t,this.pos=0,this.len=t.length}function u(){return i.Buffer?function(t){return(h.create=function(t){return i.Buffer.isBuffer(t)?new n(t):f(t)})(t)}:f}var l,f="undefined"!=typeof Uint8Array?function(t){if(t instanceof Uint8Array||Array.isArray(t))return new h(t);throw Error("illegal buffer")}:function(t){if(Array.isArray(t))return new h(t);throw Error("illegal buffer")};function c(){var t=new o(0,0),e=0;if(!(4<this.len-this.pos)){for(;e<3;++e){if(this.pos>=this.len)throw a(this);if(t.lo=(t.lo|(127&this.buf[this.pos])<<7*e)>>>0,this.buf[this.pos++]<128)return t}return t.lo=(t.lo|(127&this.buf[this.pos++])<<7*e)>>>0,t}for(;e<4;++e)if(t.lo=(t.lo|(127&this.buf[this.pos])<<7*e)>>>0,this.buf[this.pos++]<128)return t;if(t.lo=(t.lo|(127&this.buf[this.pos])<<28)>>>0,t.hi=(t.hi|(127&this.buf[this.pos])>>4)>>>0,this.buf[this.pos++]<128)return t;if(e=0,4<this.len-this.pos){for(;e<5;++e)if(t.hi=(t.hi|(127&this.buf[this.pos])<<7*e+3)>>>0,this.buf[this.pos++]<128)return t}else for(;e<5;++e){if(this.pos>=this.len)throw a(this);if(t.hi=(t.hi|(127&this.buf[this.pos])<<7*e+3)>>>0,this.buf[this.pos++]<128)return t}throw Error("invalid varint encoding")}function p(t,e){return(t[e-4]|t[e-3]<<8|t[e-2]<<16|t[e-1]<<24)>>>0}function d(){if(this.pos+8>this.len)throw a(this,8);return new o(p(this.buf,this.pos+=4),p(this.buf,this.pos+=4))}h.create=u(),h.prototype.h=i.Array.prototype.subarray||i.Array.prototype.slice,h.prototype.uint32=(l=4294967295,function(){if(l=(127&this.buf[this.pos])>>>0,this.buf[this.pos++]<128||(l=(l|(127&this.buf[this.pos])<<7)>>>0,this.buf[this.pos++]<128||(l=(l|(127&this.buf[this.pos])<<14)>>>0,this.buf[this.pos++]<128||(l=(l|(127&this.buf[this.pos])<<21)>>>0,this.buf[this.pos++]<128||(l=(l|(15&this.buf[this.pos])<<28)>>>0,this.buf[this.pos++]<128||!((this.pos+=5)>this.len))))))return l;throw this.pos=this.len,a(this,10)}),h.prototype.int32=function(){return 0|this.uint32()},h.prototype.sint32=function(){var t=this.uint32();return t>>>1^-(1&t)|0},h.prototype.bool=function(){return 0!==this.uint32()},h.prototype.fixed32=function(){if(this.pos+4>this.len)throw a(this,4);return p(this.buf,this.pos+=4)},h.prototype.sfixed32=function(){if(this.pos+4>this.len)throw a(this,4);return 0|p(this.buf,this.pos+=4)},h.prototype.float=function(){if(this.pos+4>this.len)throw a(this,4);var t=i.float.readFloatLE(this.buf,this.pos);return this.pos+=4,t},h.prototype.double=function(){if(this.pos+8>this.len)throw a(this,4);var t=i.float.readDoubleLE(this.buf,this.pos);return this.pos+=8,t},h.prototype.bytes=function(){var t=this.uint32(),e=this.pos,r=this.pos+t;if(r>this.len)throw a(this,t);return this.pos+=t,Array.isArray(this.buf)?this.buf.slice(e,r):e===r?(t=i.Buffer)?t.alloc(0):new this.buf.constructor(0):this.h.call(this.buf,e,r)},h.prototype.string=function(){var t=this.bytes();return s.read(t,0,t.length)},h.prototype.skip=function(t){if("number"==typeof t){if(this.pos+t>this.len)throw a(this,t);this.pos+=t}else do{if(this.pos>=this.len)throw a(this)}while(128&this.buf[this.pos++]);return this},h.prototype.skipType=function(t){switch(t){case 0:this.skip();break;case 1:this.skip(8);break;case 2:this.skip(this.uint32());break;case 3:for(;4!=(t=7&this.uint32());)this.skipType(t);break;case 5:this.skip(4);break;default:throw Error("invalid wire type "+t+" at offset "+this.pos)}return this},h.r=function(t){n=t,h.create=u(),n.r();var e=i.Long?"toLong":"toNumber";i.merge(h.prototype,{int64:function(){return c.call(this)[e](!1)},uint64:function(){return c.call(this)[e](!0)},sint64:function(){return c.call(this).zzDecode()[e](!1)},fixed64:function(){return d.call(this)[e](!0)},sfixed64:function(){return d.call(this)[e](!1)}})}},{35:35}],25:[function(t,e,r){e.exports=o;var n=t(24),i=((o.prototype=Object.create(n.prototype)).constructor=o,t(35));function o(t){n.call(this,t)}o.r=function(){i.Buffer&&(o.prototype.h=i.Buffer.prototype.slice)},o.prototype.string=function(){var t=this.uint32();return this.buf.utf8Slice?this.buf.utf8Slice(this.pos,this.pos=Math.min(this.pos+t,this.len)):this.buf.toString("utf-8",this.pos,this.pos=Math.min(this.pos+t,this.len))},o.r()},{24:24,35:35}],26:[function(t,e,r){e.exports=f;var n,i,o,s=t(21),a=(((f.prototype=Object.create(s.prototype)).constructor=f).className="Root",t(15)),h=t(14),u=t(23),l=t(33);function f(t){s.call(this,"",t),this.deferred=[],this.files=[]}function c(){}f.fromJSON=function(t,e){return e=e||new f,t.options&&e.setOptions(t.options),e.addJSON(t.nested)},f.prototype.resolvePath=l.path.resolve,f.prototype.fetch=l.fetch,f.prototype.load=function t(e,r,n){"function"==typeof r&&(n=r,r=g);var s=this;if(!n)return l.asPromise(t,s,e,r);var a=n===c;function h(t,e){if(n){if(a)throw t;var r=n;n=null,r(t,e)}}function u(t){var e=t.lastIndexOf("google/protobuf/");return-1<e&&(t=t.substring(e))in o?t:null}function f(t,e){try{if(l.isString(e)&&"{"==(e[0]||"")&&(e=JSON.parse(e)),l.isString(e)){i.filename=t;var n,o=i(e,s,r),f=0;if(o.imports)for(;f<o.imports.length;++f)(n=u(o.imports[f])||s.resolvePath(t,o.imports[f]))&&p(n);if(o.weakImports)for(f=0;f<o.weakImports.length;++f)(n=u(o.weakImports[f])||s.resolvePath(t,o.weakImports[f]))&&p(n,!0)}else s.setOptions(e.options).addJSON(e.nested)}catch(t){h(t)}a||d||h(null,s)}function p(t,e){if(t=u(t)||t,!~s.files.indexOf(t))if(s.files.push(t),t in o)a?f(t,o[t]):(++d,setTimeout((function(){--d,f(t,o[t])})));else if(a){var r;try{r=l.fs.readFileSync(t).toString("utf8")}catch(r){return void(e||h(r))}f(t,r)}else++d,s.fetch(t,(function(r,i){--d,n&&(r?e?d||h(null,s):h(r):f(t,i))}))}var d=0;l.isString(e)&&(e=[e]);for(var y,m=0;m<e.length;++m)(y=s.resolvePath("",e[m]))&&p(y);return a?s:(d||h(null,s),g)},f.prototype.loadSync=function(t,e){if(l.isNode)return this.load(t,e,c);throw Error("not supported")},f.prototype.resolveAll=function(){if(this.deferred.length)throw Error("unresolvable extensions: "+this.deferred.map((function(t){return"\'extend "+t.extend+"\' in "+t.parent.fullName})).join(", "));return s.prototype.resolveAll.call(this)};var p=/^[A-Z]/;function d(t,e){var r,n=e.parent.lookup(e.extend);if(n)return r=new a(e.fullName,e.id,e.type,e.rule,g,e.options),n.get(r.name)||((r.declaringField=e).extensionField=r,n.add(r)),1}f.prototype.u=function(t){if(t instanceof a)t.extend===g||t.extensionField||d(0,t)||this.deferred.push(t);else if(t instanceof h)p.test(t.name)&&(t.parent[t.name]=t.values);else if(!(t instanceof u)){if(t instanceof n)for(var e=0;e<this.deferred.length;)d(0,this.deferred[e])?this.deferred.splice(e,1):++e;for(var r=0;r<t.nestedArray.length;++r)this.u(t.e[r]);p.test(t.name)&&(t.parent[t.name]=t)}},f.prototype.o=function(t){var e;if(t instanceof a)t.extend!==g&&(t.extensionField?(t.extensionField.parent.remove(t.extensionField),t.extensionField=null):-1<(e=this.deferred.indexOf(t))&&this.deferred.splice(e,1));else if(t instanceof h)p.test(t.name)&&delete t.parent[t.name];else if(t instanceof s){for(var r=0;r<t.nestedArray.length;++r)this.o(t.e[r]);p.test(t.name)&&delete t.parent[t.name]}},f.r=function(t,e,r){n=t,i=e,o=r}},{14:14,15:15,21:21,23:23,33:33}],27:[function(t,e,r){e.exports={}},{}],28:[function(t,e,r){r.Service=t(29)},{29:29}],29:[function(t,e,r){e.exports=i;var n=t(35);function i(t,e,r){if("function"!=typeof t)throw TypeError("rpcImpl must be a function");n.EventEmitter.call(this),this.rpcImpl=t,this.requestDelimited=!!e,this.responseDelimited=!!r}((i.prototype=Object.create(n.EventEmitter.prototype)).constructor=i).prototype.rpcCall=function t(e,r,i,o,s){if(!o)throw TypeError("request must be specified");var a=this;if(!s)return n.asPromise(t,a,e,r,i,o);if(!a.rpcImpl)return setTimeout((function(){s(Error("already ended"))}),0),g;try{return a.rpcImpl(e,r[a.requestDelimited?"encodeDelimited":"encode"](o).finish(),(function(t,r){if(t)return a.emit("error",t,e),s(t);if(null===r)return a.end(!0),g;if(!(r instanceof i))try{r=i[a.responseDelimited?"decodeDelimited":"decode"](r)}catch(t){return a.emit("error",t,e),s(t)}return a.emit("data",r,e),s(null,r)}))}catch(t){return a.emit("error",t,e),setTimeout((function(){s(t)}),0),g}},i.prototype.end=function(t){return this.rpcImpl&&(t||this.rpcImpl(null,null,null),this.rpcImpl=null,this.emit("end").off()),this}},{35:35}],30:[function(t,e,r){e.exports=a;var n=t(21),i=(((a.prototype=Object.create(n.prototype)).constructor=a).className="Service",t(20)),o=t(33),s=t(28);function a(t,e){n.call(this,t,e),this.methods={},this.f=null}function h(t){return t.f=null,t}a.fromJSON=function(t,e){var r=new a(t,e.options);if(e.methods)for(var n=Object.keys(e.methods),o=0;o<n.length;++o)r.add(i.fromJSON(n[o],e.methods[n[o]]));return e.nested&&r.addJSON(e.nested),r.comment=e.comment,r},a.prototype.toJSON=function(t){var e=n.prototype.toJSON.call(this,t),r=!!t&&!!t.keepComments;return o.toObject(["options",e&&e.options||g,"methods",n.arrayToJSON(this.methodsArray,t)||{},"nested",e&&e.nested||g,"comment",r?this.comment:g])},Object.defineProperty(a.prototype,"methodsArray",{get:function(){return this.f||(this.f=o.toArray(this.methods))}}),a.prototype.get=function(t){return this.methods[t]||n.prototype.get.call(this,t)},a.prototype.resolveAll=function(){for(var t=this.methodsArray,e=0;e<t.length;++e)t[e].resolve();return n.prototype.resolve.call(this)},a.prototype.add=function(t){if(this.get(t.name))throw Error("duplicate name \'"+t.name+"\' in "+this);return t instanceof i?h((this.methods[t.name]=t).parent=this):n.prototype.add.call(this,t)},a.prototype.remove=function(t){if(t instanceof i){if(this.methods[t.name]!==t)throw Error(t+" is not a member of "+this);return delete this.methods[t.name],t.parent=null,h(this)}return n.prototype.remove.call(this,t)},a.prototype.create=function(t,e,r){for(var n,i=new s.Service(t,e,r),a=0;a<this.methodsArray.length;++a){var h=o.lcFirst((n=this.f[a]).resolve().name).replace(/[^$\\w_]/g,"");i[h]=o.codegen(["r","c"],o.isReserved(h)?h+"_":h)("return this.rpcCall(m,q,s,r,c)")({m:n,q:n.resolvedRequestType.ctor,s:n.resolvedResponseType.ctor})}return i}},{20:20,21:21,28:28,33:33}],31:[function(t,e,r){e.exports=b;var n=t(21),i=(((b.prototype=Object.create(n.prototype)).constructor=b).className="Type",t(14)),o=t(23),s=t(15),a=t(18),h=t(30),u=t(19),l=t(24),f=t(38),c=t(33),p=t(13),d=t(12),y=t(36),m=t(11),_=t(37);function b(t,e){n.call(this,t,e),this.fields={},this.oneofs=g,this.extensions=g,this.reserved=g,this.group=g,this.c=null,this.i=null,this.a=null,this.l=null}function w(t){return t.c=t.i=t.a=null,delete t.encode,delete t.decode,delete t.verify,t}Object.defineProperties(b.prototype,{fieldsById:{get:function(){if(!this.c){this.c={};for(var t=Object.keys(this.fields),e=0;e<t.length;++e){var r=this.fields[t[e]],n=r.id;if(this.c[n])throw Error("duplicate id "+n+" in "+this);this.c[n]=r}}return this.c}},fieldsArray:{get:function(){return this.i||(this.i=c.toArray(this.fields))}},oneofsArray:{get:function(){return this.a||(this.a=c.toArray(this.oneofs))}},ctor:{get:function(){return this.l||(this.ctor=b.generateConstructor(this)())},set:function(t){for(var e=t.prototype,r=(e instanceof u||((t.prototype=new u).constructor=t,c.merge(t.prototype,e)),t.$type=t.prototype.$type=this,c.merge(t,u,!0),this.l=t,0);r<this.fieldsArray.length;++r)this.i[r].resolve();var n={};for(r=0;r<this.oneofsArray.length;++r)n[this.a[r].resolve().name]={get:c.oneOfGetter(this.a[r].oneof),set:c.oneOfSetter(this.a[r].oneof)};r&&Object.defineProperties(t.prototype,n)}}}),b.generateConstructor=function(t){for(var e,r=c.codegen(["p"],t.name),n=0;n<t.fieldsArray.length;++n)(e=t.i[n]).map?r("this%s={}",c.safeProp(e.name)):e.repeated&&r("this%s=[]",c.safeProp(e.name));return r("if(p)for(var ks=Object.keys(p),i=0;i<ks.length;++i)if(p[ks[i]]!=null)")("this[ks[i]]=p[ks[i]]")},b.fromJSON=function(t,e){for(var r=new b(t,e.options),u=(r.extensions=e.extensions,r.reserved=e.reserved,Object.keys(e.fields)),l=0;l<u.length;++l)r.add((void 0!==e.fields[u[l]].keyType?a:s).fromJSON(u[l],e.fields[u[l]]));if(e.oneofs)for(u=Object.keys(e.oneofs),l=0;l<u.length;++l)r.add(o.fromJSON(u[l],e.oneofs[u[l]]));if(e.nested)for(u=Object.keys(e.nested),l=0;l<u.length;++l){var f=e.nested[u[l]];r.add((f.id!==g?s:f.fields!==g?b:f.values!==g?i:f.methods!==g?h:n).fromJSON(u[l],f))}return e.extensions&&e.extensions.length&&(r.extensions=e.extensions),e.reserved&&e.reserved.length&&(r.reserved=e.reserved),e.group&&(r.group=!0),e.comment&&(r.comment=e.comment),r},b.prototype.toJSON=function(t){var e=n.prototype.toJSON.call(this,t),r=!!t&&!!t.keepComments;return c.toObject(["options",e&&e.options||g,"oneofs",n.arrayToJSON(this.oneofsArray,t),"fields",n.arrayToJSON(this.fieldsArray.filter((function(t){return!t.declaringField})),t)||{},"extensions",this.extensions&&this.extensions.length?this.extensions:g,"reserved",this.reserved&&this.reserved.length?this.reserved:g,"group",this.group||g,"nested",e&&e.nested||g,"comment",r?this.comment:g])},b.prototype.resolveAll=function(){for(var t=this.fieldsArray,e=0;e<t.length;)t[e++].resolve();var r=this.oneofsArray;for(e=0;e<r.length;)r[e++].resolve();return n.prototype.resolveAll.call(this)},b.prototype.get=function(t){return this.fields[t]||this.oneofs&&this.oneofs[t]||this.nested&&this.nested[t]||null},b.prototype.add=function(t){if(this.get(t.name))throw Error("duplicate name \'"+t.name+"\' in "+this);if(t instanceof s&&t.extend===g){if((this.c||this.fieldsById)[t.id])throw Error("duplicate id "+t.id+" in "+this);if(this.isReservedId(t.id))throw Error("id "+t.id+" is reserved in "+this);if(this.isReservedName(t.name))throw Error("name \'"+t.name+"\' is reserved in "+this);return t.parent&&t.parent.remove(t),(this.fields[t.name]=t).message=this,t.onAdd(this),w(this)}return t instanceof o?(this.oneofs||(this.oneofs={}),(this.oneofs[t.name]=t).onAdd(this),w(this)):n.prototype.add.call(this,t)},b.prototype.remove=function(t){if(t instanceof s&&t.extend===g){if(this.fields&&this.fields[t.name]===t)return delete this.fields[t.name],t.parent=null,t.onRemove(this),w(this);throw Error(t+" is not a member of "+this)}if(t instanceof o){if(this.oneofs&&this.oneofs[t.name]===t)return delete this.oneofs[t.name],t.parent=null,t.onRemove(this),w(this);throw Error(t+" is not a member of "+this)}return n.prototype.remove.call(this,t)},b.prototype.isReservedId=function(t){return n.isReservedId(this.reserved,t)},b.prototype.isReservedName=function(t){return n.isReservedName(this.reserved,t)},b.prototype.create=function(t){return new this.ctor(t)},b.prototype.setup=function(){for(var t=this.fullName,e=[],r=0;r<this.fieldsArray.length;++r)e.push(this.i[r].resolve().resolvedType);var n;return this.encode=p(this)({Writer:f,types:e,util:c}),this.decode=d(this)({Reader:l,types:e,util:c}),this.verify=y(this)({types:e,util:c}),this.fromObject=m.fromObject(this)({types:e,util:c}),this.toObject=m.toObject(this)({types:e,util:c}),(t=_[t])&&((n=Object.create(this)).fromObject=this.fromObject,this.fromObject=t.fromObject.bind(n),n.toObject=this.toObject,this.toObject=t.toObject.bind(n)),this},b.prototype.encode=function(t,e){return this.setup().encode(t,e)},b.prototype.encodeDelimited=function(t,e){return this.encode(t,e&&e.len?e.fork():e).ldelim()},b.prototype.decode=function(t,e){return this.setup().decode(t,e)},b.prototype.decodeDelimited=function(t){return t instanceof l||(t=l.create(t)),this.decode(t,t.uint32())},b.prototype.verify=function(t){return this.setup().verify(t)},b.prototype.fromObject=function(t){return this.setup().fromObject(t)},b.prototype.toObject=function(t,e){return this.setup().toObject(t,e)},b.d=function(t){return function(e){c.decorateType(e,t)}}},{11:11,12:12,13:13,14:14,15:15,18:18,19:19,21:21,23:23,24:24,30:30,33:33,36:36,37:37,38:38}],32:[function(t,e,r){t=t(33);var n=["double","float","int32","uint32","sint32","fixed32","sfixed32","int64","uint64","sint64","fixed64","sfixed64","bool","string","bytes"];function i(t,e){var r=0,i={};for(e|=0;r<t.length;)i[n[r+e]]=t[r++];return i}r.basic=i([1,5,0,0,0,5,5,0,0,0,1,1,0,2,2]),r.defaults=i([0,0,0,0,0,0,0,0,0,0,0,0,!1,"",t.emptyArray,null]),r.long=i([0,0,0,1,1],7),r.mapKey=i([0,0,0,5,5,0,0,0,1,1,0,2],2),r.packed=i([1,5,0,0,0,5,5,0,0,0,1,1,0])},{33:33}],33:[function(t,e,r){var n,i,o=e.exports=t(35),s=t(27),a=(o.codegen=t(3),o.fetch=t(5),o.path=t(8),o.fs=o.inquire("fs"),o.toArray=function(t){if(t){for(var e=Object.keys(t),r=Array(e.length),n=0;n<e.length;)r[n]=t[e[n++]];return r}return[]},o.toObject=function(t){for(var e={},r=0;r<t.length;){var n=t[r++],i=t[r++];i!==g&&(e[n]=i)}return e},/\\\\/g),h=/"/g,u=(o.isReserved=function(t){return/^(?:do|if|in|for|let|new|try|var|case|else|enum|eval|false|null|this|true|void|with|break|catch|class|const|super|throw|while|yield|delete|export|import|public|return|static|switch|typeof|default|extends|finally|package|private|continue|debugger|function|arguments|interface|protected|implements|instanceof)$/.test(t)},o.safeProp=function(t){return!/^[$\\w_]+$/.test(t)||o.isReserved(t)?\'["\'+t.replace(a,"\\\\\\\\").replace(h,\'\\\\"\')+\'"]\':"."+t},o.ucFirst=function(t){return(t[0]||"").toUpperCase()+t.substring(1)},/_([a-z])/g),l=(o.camelCase=function(t){return t.substring(0,1)+t.substring(1).replace(u,(function(t,e){return e.toUpperCase()}))},o.compareFieldsById=function(t,e){return t.id-e.id},o.decorateType=function(e,r){return e.$type?(r&&e.$type.name!==r&&(o.decorateRoot.remove(e.$type),e.$type.name=r,o.decorateRoot.add(e.$type)),e.$type):(r=new(n=n||t(31))(r||e.name),o.decorateRoot.add(r),r.ctor=e,Object.defineProperty(e,"$type",{value:r,enumerable:!1}),Object.defineProperty(e.prototype,"$type",{value:r,enumerable:!1}),r)},0);o.decorateEnum=function(e){var r;return e.$type||(r=new(i=i||t(14))("Enum"+l++,e),o.decorateRoot.add(r),Object.defineProperty(e,"$type",{value:r,enumerable:!1}),r)},o.setProperty=function(t,e,r){if("object"!=typeof t)throw TypeError("dst must be an object");if(e)return function t(e,r,n){var i=r.shift();return"__proto__"!==i&&"prototype"!==i&&(0<r.length?e[i]=t(e[i]||{},r,n):((r=e[i])&&(n=[].concat(r).concat(n)),e[i]=n)),e}(t,e=e.split("."),r);throw TypeError("path must be specified")},Object.defineProperty(o,"decorateRoot",{get:function(){return s.decorated||(s.decorated=new(t(26)))}})},{14:14,26:26,27:27,3:3,31:31,35:35,5:5,8:8}],34:[function(t,e,r){e.exports=i;var n=t(35);function i(t,e){this.lo=t>>>0,this.hi=e>>>0}var o=i.zero=new i(0,0),s=(o.toNumber=function(){return 0},o.zzEncode=o.zzDecode=function(){return this},o.length=function(){return 1},i.zeroHash="\\0\\0\\0\\0\\0\\0\\0\\0",i.fromNumber=function(t){var e,r;return 0===t?o:(r=(t=(e=t<0)?-t:t)>>>0,t=(t-r)/4294967296>>>0,e&&(t=~t>>>0,r=~r>>>0,4294967295<++r&&(r=0,4294967295<++t&&(t=0))),new i(r,t))},i.from=function(t){if("number"==typeof t)return i.fromNumber(t);if(n.isString(t)){if(!n.Long)return i.fromNumber(parseInt(t,10));t=n.Long.fromString(t)}return t.low||t.high?new i(t.low>>>0,t.high>>>0):o},i.prototype.toNumber=function(t){var e;return!t&&this.hi>>>31?(t=1+~this.lo>>>0,e=~this.hi>>>0,-(t+4294967296*(e=t?e:e+1>>>0))):this.lo+4294967296*this.hi},i.prototype.toLong=function(t){return n.Long?new n.Long(0|this.lo,0|this.hi,!!t):{low:0|this.lo,high:0|this.hi,unsigned:!!t}},String.prototype.charCodeAt);i.fromHash=function(t){return"\\0\\0\\0\\0\\0\\0\\0\\0"===t?o:new i((s.call(t,0)|s.call(t,1)<<8|s.call(t,2)<<16|s.call(t,3)<<24)>>>0,(s.call(t,4)|s.call(t,5)<<8|s.call(t,6)<<16|s.call(t,7)<<24)>>>0)},i.prototype.toHash=function(){return String.fromCharCode(255&this.lo,this.lo>>>8&255,this.lo>>>16&255,this.lo>>>24,255&this.hi,this.hi>>>8&255,this.hi>>>16&255,this.hi>>>24)},i.prototype.zzEncode=function(){var t=this.hi>>31;return this.hi=((this.hi<<1|this.lo>>>31)^t)>>>0,this.lo=(this.lo<<1^t)>>>0,this},i.prototype.zzDecode=function(){var t=-(1&this.lo);return this.lo=((this.lo>>>1|this.hi<<31)^t)>>>0,this.hi=(this.hi>>>1^t)>>>0,this},i.prototype.length=function(){var t=this.lo,e=(this.lo>>>28|this.hi<<4)>>>0,r=this.hi>>>24;return 0==r?0==e?t<16384?t<128?1:2:t<2097152?3:4:e<16384?e<128?5:6:e<2097152?7:8:r<128?9:10}},{35:35}],35:[function(t,e,r){var n=r;function i(t,e,r){for(var n=Object.keys(e),i=0;i<n.length;++i)t[n[i]]!==g&&r||(t[n[i]]=e[n[i]]);return t}function o(t){function e(t,r){if(!(this instanceof e))return new e(t,r);Object.defineProperty(this,"message",{get:function(){return t}}),Error.captureStackTrace?Error.captureStackTrace(this,e):Object.defineProperty(this,"stack",{value:Error().stack||""}),r&&i(this,r)}return e.prototype=Object.create(Error.prototype,{constructor:{value:e,writable:!0,enumerable:!1,configurable:!0},name:{get:function(){return t},set:g,enumerable:!1,configurable:!0},toString:{value:function(){return this.name+": "+this.message},writable:!0,enumerable:!1,configurable:!0}}),e}n.asPromise=t(1),n.base64=t(2),n.EventEmitter=t(4),n.float=t(6),n.inquire=t(7),n.utf8=t(10),n.pool=t(9),n.LongBits=t(34),n.isNode=!!(void 0!==__webpack_require__.g&&__webpack_require__.g&&__webpack_require__.g.process&&__webpack_require__.g.process.versions&&__webpack_require__.g.process.versions.node),n.global=n.isNode&&__webpack_require__.g||"undefined"!=typeof window&&window||"undefined"!=typeof self&&self||this,n.emptyArray=Object.freeze?Object.freeze([]):[],n.emptyObject=Object.freeze?Object.freeze({}):{},n.isInteger=Number.isInteger||function(t){return"number"==typeof t&&isFinite(t)&&Math.floor(t)===t},n.isString=function(t){return"string"==typeof t||t instanceof String},n.isObject=function(t){return t&&"object"==typeof t},n.isset=n.isSet=function(t,e){var r=t[e];return null!=r&&t.hasOwnProperty(e)&&("object"!=typeof r||0<(Array.isArray(r)?r:Object.keys(r)).length)},n.Buffer=function(){try{var t=n.inquire("buffer").Buffer;return t.prototype.utf8Write?t:null}catch(t){return null}}(),n.v=null,n.b=null,n.newBuffer=function(t){return"number"==typeof t?n.Buffer?n.b(t):new n.Array(t):n.Buffer?n.v(t):"undefined"==typeof Uint8Array?t:new Uint8Array(t)},n.Array="undefined"!=typeof Uint8Array?Uint8Array:Array,n.Long=n.global.dcodeIO&&n.global.dcodeIO.Long||n.global.Long||n.inquire("long"),n.key2Re=/^true|false|0|1$/,n.key32Re=/^-?(?:0|[1-9][0-9]*)$/,n.key64Re=/^(?:[\\\\x00-\\\\xff]{8}|-?(?:0|[1-9][0-9]*))$/,n.longToHash=function(t){return t?n.LongBits.from(t).toHash():n.LongBits.zeroHash},n.longFromHash=function(t,e){return t=n.LongBits.fromHash(t),n.Long?n.Long.fromBits(t.lo,t.hi,e):t.toNumber(!!e)},n.merge=i,n.lcFirst=function(t){return(t[0]||"").toLowerCase()+t.substring(1)},n.newError=o,n.ProtocolError=o("ProtocolError"),n.oneOfGetter=function(t){for(var e={},r=0;r<t.length;++r)e[t[r]]=1;return function(){for(var t=Object.keys(this),r=t.length-1;-1<r;--r)if(1===e[t[r]]&&this[t[r]]!==g&&null!==this[t[r]])return t[r]}},n.oneOfSetter=function(t){return function(e){for(var r=0;r<t.length;++r)t[r]!==e&&delete this[t[r]]}},n.toJSONOptions={longs:String,enums:String,bytes:String,json:!0},n.r=function(){var t=n.Buffer;t?(n.v=t.from!==Uint8Array.from&&t.from||function(e,r){return new t(e,r)},n.b=t.allocUnsafe||function(e){return new t(e)}):n.v=n.b=null}},{1:1,10:10,2:2,34:34,4:4,6:6,7:7,9:9}],36:[function(t,e,r){e.exports=function(t){var e=i.codegen(["m"],t.name+"$verify")(\'if(typeof m!=="object"||m===null)\')("return%j","object expected"),r={};t.oneofsArray.length&&e("var p={}");for(var n=0;n<t.fieldsArray.length;++n){var a,h=t.i[n].resolve(),u="m"+i.safeProp(h.name);h.optional&&e("if(%s!=null&&m.hasOwnProperty(%j)){",u,h.name),h.map?(e("if(!util.isObject(%s))",u)("return%j",o(h,"object"))("var k=Object.keys(%s)",u)("for(var i=0;i<k.length;++i){"),function(t,e,r){switch(e.keyType){case"int32":case"uint32":case"sint32":case"fixed32":case"sfixed32":t("if(!util.key32Re.test(%s))",r)("return%j",o(e,"integer key"));break;case"int64":case"uint64":case"sint64":case"fixed64":case"sfixed64":t("if(!util.key64Re.test(%s))",r)("return%j",o(e,"integer|Long key"));break;case"bool":t("if(!util.key2Re.test(%s))",r)("return%j",o(e,"boolean key"))}}(e,h,"k[i]"),s(e,h,n,u+"[k[i]]")("}")):h.repeated?(e("if(!Array.isArray(%s))",u)("return%j",o(h,"array"))("for(var i=0;i<%s.length;++i){",u),s(e,h,n,u+"[i]")("}")):(h.partOf&&(a=i.safeProp(h.partOf.name),1===r[h.partOf.name]&&e("if(p%s===1)",a)("return%j",h.partOf.name+": multiple values"),r[h.partOf.name]=1,e("p%s=1",a)),s(e,h,n,u)),h.optional&&e("}")}return e("return null")};var n=t(14),i=t(33);function o(t,e){return t.name+": "+e+(t.repeated&&"array"!==e?"[]":t.map&&"object"!==e?"{k:"+t.keyType+"}":"")+" expected"}function s(t,e,r,i){if(e.resolvedType)if(e.resolvedType instanceof n){t("switch(%s){",i)("default:")("return%j",o(e,"enum value"));for(var s=Object.keys(e.resolvedType.values),a=0;a<s.length;++a)t("case %i:",e.resolvedType.values[s[a]]);t("break")("}")}else t("{")("var e=types[%i].verify(%s);",r,i)("if(e)")("return%j+e",e.name+".")("}");else switch(e.type){case"int32":case"uint32":case"sint32":case"fixed32":case"sfixed32":t("if(!util.isInteger(%s))",i)("return%j",o(e,"integer"));break;case"int64":case"uint64":case"sint64":case"fixed64":case"sfixed64":t("if(!util.isInteger(%s)&&!(%s&&util.isInteger(%s.low)&&util.isInteger(%s.high)))",i,i,i,i)("return%j",o(e,"integer|Long"));break;case"float":case"double":t(\'if(typeof %s!=="number")\',i)("return%j",o(e,"number"));break;case"bool":t(\'if(typeof %s!=="boolean")\',i)("return%j",o(e,"boolean"));break;case"string":t("if(!util.isString(%s))",i)("return%j",o(e,"string"));break;case"bytes":t(\'if(!(%s&&typeof %s.length==="number"||util.isString(%s)))\',i,i,i)("return%j",o(e,"buffer"))}return t}},{14:14,33:33}],37:[function(t,e,r){var n=t(19);r[".google.protobuf.Any"]={fromObject:function(t){if(t&&t["@type"]){var e,r=t["@type"].substring(1+t["@type"].lastIndexOf("/"));if(r=this.lookup(r))return~(e="."==(t["@type"][0]||"")?t["@type"].slice(1):t["@type"]).indexOf("/")||(e="/"+e),this.create({type_url:e,value:r.encode(r.fromObject(t)).finish()})}return this.fromObject(t)},toObject:function(t,e){var r,i,o="",s="";return e&&e.json&&t.type_url&&t.value&&(s=t.type_url.substring(1+t.type_url.lastIndexOf("/")),o=t.type_url.substring(0,1+t.type_url.lastIndexOf("/")),(r=this.lookup(s))&&(t=r.decode(t.value))),!(t instanceof this.ctor)&&t instanceof n?(r=t.$type.toObject(t,e),i="."===t.$type.fullName[0]?t.$type.fullName.slice(1):t.$type.fullName,r["@type"]=s=(o=""===o?"type.googleapis.com/":o)+i,r):this.toObject(t,e)}}},{19:19}],38:[function(t,e,r){e.exports=f;var n,i=t(35),o=i.LongBits,s=i.base64,a=i.utf8;function h(t,e,r){this.fn=t,this.len=e,this.next=g,this.val=r}function u(){}function l(t){this.head=t.head,this.tail=t.tail,this.len=t.len,this.next=t.states}function f(){this.len=0,this.head=new h(u,0,0),this.tail=this.head,this.states=null}function c(){return i.Buffer?function(){return(f.create=function(){return new n})()}:function(){return new f}}function p(t,e,r){e[r]=255&t}function d(t,e){this.len=t,this.next=g,this.val=e}function y(t,e,r){for(;t.hi;)e[r++]=127&t.lo|128,t.lo=(t.lo>>>7|t.hi<<25)>>>0,t.hi>>>=7;for(;127<t.lo;)e[r++]=127&t.lo|128,t.lo=t.lo>>>7;e[r++]=t.lo}function m(t,e,r){e[r]=255&t,e[r+1]=t>>>8&255,e[r+2]=t>>>16&255,e[r+3]=t>>>24}f.create=c(),f.alloc=function(t){return new i.Array(t)},i.Array!==Array&&(f.alloc=i.pool(f.alloc,i.Array.prototype.subarray)),f.prototype.p=function(t,e,r){return this.tail=this.tail.next=new h(t,e,r),this.len+=e,this},(d.prototype=Object.create(h.prototype)).fn=function(t,e,r){for(;127<t;)e[r++]=127&t|128,t>>>=7;e[r]=t},f.prototype.uint32=function(t){return this.len+=(this.tail=this.tail.next=new d((t>>>=0)<128?1:t<16384?2:t<2097152?3:t<268435456?4:5,t)).len,this},f.prototype.int32=function(t){return t<0?this.p(y,10,o.fromNumber(t)):this.uint32(t)},f.prototype.sint32=function(t){return this.uint32((t<<1^t>>31)>>>0)},f.prototype.int64=f.prototype.uint64=function(t){return t=o.from(t),this.p(y,t.length(),t)},f.prototype.sint64=function(t){return t=o.from(t).zzEncode(),this.p(y,t.length(),t)},f.prototype.bool=function(t){return this.p(p,1,t?1:0)},f.prototype.sfixed32=f.prototype.fixed32=function(t){return this.p(m,4,t>>>0)},f.prototype.sfixed64=f.prototype.fixed64=function(t){return t=o.from(t),this.p(m,4,t.lo).p(m,4,t.hi)},f.prototype.float=function(t){return this.p(i.float.writeFloatLE,4,t)},f.prototype.double=function(t){return this.p(i.float.writeDoubleLE,8,t)};var _=i.Array.prototype.set?function(t,e,r){e.set(t,r)}:function(t,e,r){for(var n=0;n<t.length;++n)e[r+n]=t[n]};f.prototype.bytes=function(t){var e,r=t.length>>>0;return r?(i.isString(t)&&(e=f.alloc(r=s.length(t)),s.decode(t,e,0),t=e),this.uint32(r).p(_,r,t)):this.p(p,1,0)},f.prototype.string=function(t){var e=a.length(t);return e?this.uint32(e).p(a.write,e,t):this.p(p,1,0)},f.prototype.fork=function(){return this.states=new l(this),this.head=this.tail=new h(u,0,0),this.len=0,this},f.prototype.reset=function(){return this.states?(this.head=this.states.head,this.tail=this.states.tail,this.len=this.states.len,this.states=this.states.next):(this.head=this.tail=new h(u,0,0),this.len=0),this},f.prototype.ldelim=function(){var t=this.head,e=this.tail,r=this.len;return this.reset().uint32(r),r&&(this.tail.next=t.next,this.tail=e,this.len+=r),this},f.prototype.finish=function(){for(var t=this.head.next,e=this.constructor.alloc(this.len),r=0;t;)t.fn(t.val,e,r),r+=t.len,t=t.next;return e},f.r=function(t){n=t,f.create=c(),n.r()}},{35:35}],39:[function(t,e,r){e.exports=o;var n=t(38),i=((o.prototype=Object.create(n.prototype)).constructor=o,t(35));function o(){n.call(this)}function s(t,e,r){t.length<40?i.utf8.write(t,e,r):e.utf8Write?e.utf8Write(t,r):e.write(t,r)}o.r=function(){o.alloc=i.b,o.writeBytesBuffer=i.Buffer&&i.Buffer.prototype instanceof Uint8Array&&"set"===i.Buffer.prototype.set.name?function(t,e,r){e.set(t,r)}:function(t,e,r){if(t.copy)t.copy(e,r,0,t.length);else for(var n=0;n<t.length;)e[r++]=t[n++]}},o.prototype.bytes=function(t){var e=(t=i.isString(t)?i.v(t,"base64"):t).length>>>0;return this.uint32(e),e&&this.p(o.writeBytesBuffer,e,t),this},o.prototype.string=function(t){var e=i.Buffer.byteLength(t);return this.uint32(e),e&&this.p(s,e,t),this},o.r()},{35:35,38:38}]},e={},i=function t(n){var i=e[n];return i||r[n][0].call(i=e[n]={exports:{}},t,i,i.exports),i.exports}(16),i.util.global.protobuf=i,__WEBPACK_AMD_DEFINE_ARRAY__=[__webpack_require__("vsh_171")],__WEBPACK_AMD_DEFINE_RESULT__=function(t){return t&&t.isLong&&(i.util.Long=t,i.configure()),i}.apply(exports,__WEBPACK_AMD_DEFINE_ARRAY__),void 0!==__WEBPACK_AMD_DEFINE_RESULT__&&(module.exports=__WEBPACK_AMD_DEFINE_RESULT__),module&&module.exports&&(module.exports=i)}()},vsh_171:function(t,e){var r,n=function(t){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;\n/**\n   * @license\n   * Copyright 2009 The Closure Library Authors\n   * Copyright 2020 Daniel Wirtz / The long.js Authors.\n   *\n   * Licensed under the Apache License, Version 2.0 (the "License");\n   * you may not use this file except in compliance with the License.\n   * You may obtain a copy of the License at\n   *\n   *     http://www.apache.org/licenses/LICENSE-2.0\n   *\n   * Unless required by applicable law or agreed to in writing, software\n   * distributed under the License is distributed on an "AS IS" BASIS,\n   * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n   * See the License for the specific language governing permissions and\n   * limitations under the License.\n   *\n   * SPDX-License-Identifier: Apache-2.0\n   */\nvar e=null;try{e=new WebAssembly.Instance(new WebAssembly.Module(new Uint8Array([0,97,115,109,1,0,0,0,1,13,2,96,0,1,127,96,4,127,127,127,127,1,127,3,7,6,0,1,1,1,1,1,6,6,1,127,1,65,0,11,7,50,6,3,109,117,108,0,1,5,100,105,118,95,115,0,2,5,100,105,118,95,117,0,3,5,114,101,109,95,115,0,4,5,114,101,109,95,117,0,5,8,103,101,116,95,104,105,103,104,0,0,10,191,1,6,4,0,35,0,11,36,1,1,126,32,0,173,32,1,173,66,32,134,132,32,2,173,32,3,173,66,32,134,132,126,34,4,66,32,135,167,36,0,32,4,167,11,36,1,1,126,32,0,173,32,1,173,66,32,134,132,32,2,173,32,3,173,66,32,134,132,127,34,4,66,32,135,167,36,0,32,4,167,11,36,1,1,126,32,0,173,32,1,173,66,32,134,132,32,2,173,32,3,173,66,32,134,132,128,34,4,66,32,135,167,36,0,32,4,167,11,36,1,1,126,32,0,173,32,1,173,66,32,134,132,32,2,173,32,3,173,66,32,134,132,129,34,4,66,32,135,167,36,0,32,4,167,11,36,1,1,126,32,0,173,32,1,173,66,32,134,132,32,2,173,32,3,173,66,32,134,132,130,34,4,66,32,135,167,36,0,32,4,167,11])),{}).exports}catch(t){}function r(t,e,r){this.low=0|t,this.high=0|e,this.unsigned=!!r}function n(t){return!0===(t&&t.__isLong__)}function i(t){var e=Math.clz32(t&-t);return t?31-e:e}r.prototype.__isLong__,Object.defineProperty(r.prototype,"__isLong__",{value:!0}),r.isLong=n;var o={},s={};function a(t,e){var r,n,i;return e?(i=0<=(t>>>=0)&&t<256)&&(n=s[t])?n:(r=u(t,0,!0),i&&(s[t]=r),r):(i=-128<=(t|=0)&&t<128)&&(n=o[t])?n:(r=u(t,t<0?-1:0,!1),i&&(o[t]=r),r)}function h(t,e){if(isNaN(t))return e?_:m;if(e){if(t<0)return _;if(t>=d)return O}else{if(t<=-g)return k;if(t+1>=g)return E}return t<0?h(-t,e).neg():u(t%p|0,t/p|0,e)}function u(t,e,n){return new r(t,e,n)}r.fromInt=a,r.fromNumber=h,r.fromBits=u;var l=Math.pow;function f(t,e,r){if(0===t.length)throw Error("empty string");if("number"==typeof e?(r=e,e=!1):e=!!e,"NaN"===t||"Infinity"===t||"+Infinity"===t||"-Infinity"===t)return e?_:m;if((r=r||10)<2||36<r)throw RangeError("radix");var n;if((n=t.indexOf("-"))>0)throw Error("interior hyphen");if(0===n)return f(t.substring(1),e,r).neg();for(var i=h(l(r,8)),o=m,s=0;s<t.length;s+=8){var a=Math.min(8,t.length-s),u=parseInt(t.substring(s,s+a),r);if(a<8){var c=h(l(r,a));o=o.mul(c).add(h(u))}else o=(o=o.mul(i)).add(h(u))}return o.unsigned=e,o}function c(t,e){return"number"==typeof t?h(t,e):"string"==typeof t?f(t,e):u(t.low,t.high,"boolean"==typeof e?e:t.unsigned)}r.fromString=f,r.fromValue=c;var p=4294967296,d=p*p,g=d/2,y=a(1<<24),m=a(0);r.ZERO=m;var _=a(0,!0);r.UZERO=_;var b=a(1);r.ONE=b;var w=a(1,!0);r.UONE=w;var v=a(-1);r.NEG_ONE=v;var E=u(-1,2147483647,!1);r.MAX_VALUE=E;var O=u(-1,-1,!0);r.MAX_UNSIGNED_VALUE=O;var k=u(0,-2147483648,!1);r.MIN_VALUE=k;var A=r.prototype;A.toInt=function(){return this.unsigned?this.low>>>0:this.low},A.toNumber=function(){return this.unsigned?(this.high>>>0)*p+(this.low>>>0):this.high*p+(this.low>>>0)},A.toString=function(t){if((t=t||10)<2||36<t)throw RangeError("radix");if(this.isZero())return"0";if(this.isNegative()){if(this.eq(k)){var e=h(t),r=this.div(e),n=r.mul(e).sub(this);return r.toString(t)+n.toInt().toString(t)}return"-"+this.neg().toString(t)}for(var i=h(l(t,6),this.unsigned),o=this,s="";;){var a=o.div(i),u=(o.sub(a.mul(i)).toInt()>>>0).toString(t);if((o=a).isZero())return u+s;for(;u.length<6;)u="0"+u;s=""+u+s}},A.getHighBits=function(){return this.high},A.getHighBitsUnsigned=function(){return this.high>>>0},A.getLowBits=function(){return this.low},A.getLowBitsUnsigned=function(){return this.low>>>0},A.getNumBitsAbs=function(){if(this.isNegative())return this.eq(k)?64:this.neg().getNumBitsAbs();for(var t=0!=this.high?this.high:this.low,e=31;e>0&&0==(t&1<<e);e--);return 0!=this.high?e+33:e+1},A.isZero=function(){return 0===this.high&&0===this.low},A.eqz=A.isZero,A.isNegative=function(){return!this.unsigned&&this.high<0},A.isPositive=function(){return this.unsigned||this.high>=0},A.isOdd=function(){return 1==(1&this.low)},A.isEven=function(){return 0==(1&this.low)},A.equals=function(t){return n(t)||(t=c(t)),(this.unsigned===t.unsigned||this.high>>>31!=1||t.high>>>31!=1)&&(this.high===t.high&&this.low===t.low)},A.eq=A.equals,A.notEquals=function(t){return!this.eq(t)},A.neq=A.notEquals,A.ne=A.notEquals,A.lessThan=function(t){return this.comp(t)<0},A.lt=A.lessThan,A.lessThanOrEqual=function(t){return this.comp(t)<=0},A.lte=A.lessThanOrEqual,A.le=A.lessThanOrEqual,A.greaterThan=function(t){return this.comp(t)>0},A.gt=A.greaterThan,A.greaterThanOrEqual=function(t){return this.comp(t)>=0},A.gte=A.greaterThanOrEqual,A.ge=A.greaterThanOrEqual,A.compare=function(t){if(n(t)||(t=c(t)),this.eq(t))return 0;var e=this.isNegative(),r=t.isNegative();return e&&!r?-1:!e&&r?1:this.unsigned?t.high>>>0>this.high>>>0||t.high===this.high&&t.low>>>0>this.low>>>0?-1:1:this.sub(t).isNegative()?-1:1},A.comp=A.compare,A.negate=function(){return!this.unsigned&&this.eq(k)?k:this.not().add(b)},A.neg=A.negate,A.add=function(t){n(t)||(t=c(t));var e=this.high>>>16,r=65535&this.high,i=this.low>>>16,o=65535&this.low,s=t.high>>>16,a=65535&t.high,h=t.low>>>16,l=0,f=0,p=0,d=0;return p+=(d+=o+(65535&t.low))>>>16,f+=(p+=i+h)>>>16,l+=(f+=r+a)>>>16,l+=e+s,u((p&=65535)<<16|(d&=65535),(l&=65535)<<16|(f&=65535),this.unsigned)},A.subtract=function(t){return n(t)||(t=c(t)),this.add(t.neg())},A.sub=A.subtract,A.multiply=function(t){if(this.isZero())return this;if(n(t)||(t=c(t)),e)return u(e.mul(this.low,this.high,t.low,t.high),e.get_high(),this.unsigned);if(t.isZero())return this.unsigned?_:m;if(this.eq(k))return t.isOdd()?k:m;if(t.eq(k))return this.isOdd()?k:m;if(this.isNegative())return t.isNegative()?this.neg().mul(t.neg()):this.neg().mul(t).neg();if(t.isNegative())return this.mul(t.neg()).neg();if(this.lt(y)&&t.lt(y))return h(this.toNumber()*t.toNumber(),this.unsigned);var r=this.high>>>16,i=65535&this.high,o=this.low>>>16,s=65535&this.low,a=t.high>>>16,l=65535&t.high,f=t.low>>>16,p=65535&t.low,d=0,g=0,b=0,w=0;return b+=(w+=s*p)>>>16,g+=(b+=o*p)>>>16,b&=65535,g+=(b+=s*f)>>>16,d+=(g+=i*p)>>>16,g&=65535,d+=(g+=o*f)>>>16,g&=65535,d+=(g+=s*l)>>>16,d+=r*p+i*f+o*l+s*a,u((b&=65535)<<16|(w&=65535),(d&=65535)<<16|(g&=65535),this.unsigned)},A.mul=A.multiply,A.divide=function(t){if(n(t)||(t=c(t)),t.isZero())throw Error("division by zero");var r,i,o;if(e)return this.unsigned||-2147483648!==this.high||-1!==t.low||-1!==t.high?u((this.unsigned?e.div_u:e.div_s)(this.low,this.high,t.low,t.high),e.get_high(),this.unsigned):this;if(this.isZero())return this.unsigned?_:m;if(this.unsigned){if(t.unsigned||(t=t.toUnsigned()),t.gt(this))return _;if(t.gt(this.shru(1)))return w;o=_}else{if(this.eq(k))return t.eq(b)||t.eq(v)?k:t.eq(k)?b:(r=this.shr(1).div(t).shl(1)).eq(m)?t.isNegative()?b:v:(i=this.sub(t.mul(r)),o=r.add(i.div(t)));if(t.eq(k))return this.unsigned?_:m;if(this.isNegative())return t.isNegative()?this.neg().div(t.neg()):this.neg().div(t).neg();if(t.isNegative())return this.div(t.neg()).neg();o=m}for(i=this;i.gte(t);){r=Math.max(1,Math.floor(i.toNumber()/t.toNumber()));for(var s=Math.ceil(Math.log(r)/Math.LN2),a=s<=48?1:l(2,s-48),f=h(r),p=f.mul(t);p.isNegative()||p.gt(i);)p=(f=h(r-=a,this.unsigned)).mul(t);f.isZero()&&(f=b),o=o.add(f),i=i.sub(p)}return o},A.div=A.divide,A.modulo=function(t){return n(t)||(t=c(t)),e?u((this.unsigned?e.rem_u:e.rem_s)(this.low,this.high,t.low,t.high),e.get_high(),this.unsigned):this.sub(this.div(t).mul(t))},A.mod=A.modulo,A.rem=A.modulo,A.not=function(){return u(~this.low,~this.high,this.unsigned)},A.countLeadingZeros=function(){return this.high?Math.clz32(this.high):Math.clz32(this.low)+32},A.clz=A.countLeadingZeros,A.countTrailingZeros=function(){return this.low?i(this.low):i(this.high)+32},A.ctz=A.countTrailingZeros,A.and=function(t){return n(t)||(t=c(t)),u(this.low&t.low,this.high&t.high,this.unsigned)},A.or=function(t){return n(t)||(t=c(t)),u(this.low|t.low,this.high|t.high,this.unsigned)},A.xor=function(t){return n(t)||(t=c(t)),u(this.low^t.low,this.high^t.high,this.unsigned)},A.shiftLeft=function(t){return n(t)&&(t=t.toInt()),0==(t&=63)?this:t<32?u(this.low<<t,this.high<<t|this.low>>>32-t,this.unsigned):u(0,this.low<<t-32,this.unsigned)},A.shl=A.shiftLeft,A.shiftRight=function(t){return n(t)&&(t=t.toInt()),0==(t&=63)?this:t<32?u(this.low>>>t|this.high<<32-t,this.high>>t,this.unsigned):u(this.high>>t-32,this.high>=0?0:-1,this.unsigned)},A.shr=A.shiftRight,A.shiftRightUnsigned=function(t){return n(t)&&(t=t.toInt()),0==(t&=63)?this:t<32?u(this.low>>>t|this.high<<32-t,this.high>>>t,this.unsigned):u(32===t?this.high:this.high>>>t-32,0,this.unsigned)},A.shru=A.shiftRightUnsigned,A.shr_u=A.shiftRightUnsigned,A.rotateLeft=function(t){var e;return n(t)&&(t=t.toInt()),0==(t&=63)?this:32===t?u(this.high,this.low,this.unsigned):t<32?(e=32-t,u(this.low<<t|this.high>>>e,this.high<<t|this.low>>>e,this.unsigned)):(e=32-(t-=32),u(this.high<<t|this.low>>>e,this.low<<t|this.high>>>e,this.unsigned))},A.rotl=A.rotateLeft,A.rotateRight=function(t){var e;return n(t)&&(t=t.toInt()),0==(t&=63)?this:32===t?u(this.high,this.low,this.unsigned):t<32?(e=32-t,u(this.high<<e|this.low>>>t,this.low<<e|this.high>>>t,this.unsigned)):(e=32-(t-=32),u(this.low<<e|this.high>>>t,this.high<<e|this.low>>>t,this.unsigned))},A.rotr=A.rotateRight,A.toSigned=function(){return this.unsigned?u(this.low,this.high,!1):this},A.toUnsigned=function(){return this.unsigned?this:u(this.low,this.high,!0)},A.toBytes=function(t){return t?this.toBytesLE():this.toBytesBE()},A.toBytesLE=function(){var t=this.high,e=this.low;return[255&e,e>>>8&255,e>>>16&255,e>>>24,255&t,t>>>8&255,t>>>16&255,t>>>24]},A.toBytesBE=function(){var t=this.high,e=this.low;return[t>>>24,t>>>16&255,t>>>8&255,255&t,e>>>24,e>>>16&255,e>>>8&255,255&e]},r.fromBytes=function(t,e,n){return n?r.fromBytesLE(t,e):r.fromBytesBE(t,e)},r.fromBytesLE=function(t,e){return new r(t[0]|t[1]<<8|t[2]<<16|t[3]<<24,t[4]|t[5]<<8|t[6]<<16|t[7]<<24,e)},r.fromBytesBE=function(t,e){return new r(t[4]<<24|t[5]<<16|t[6]<<8|t[7],t[0]<<24|t[1]<<16|t[2]<<8|t[3],e)};var T=r;return t.default=T,"default"in t?t.default:t}({});void 0===(r=function(){return n}.apply(e,[]))||(t.exports=r)}},__webpack_module_cache__={};function __webpack_require__(t){var e=__webpack_module_cache__[t];if(void 0!==e)return e.exports;var r=__webpack_module_cache__[t]={id:t,loaded:!1,exports:{}};return __webpack_modules__[t](r,r.exports,__webpack_require__),r.loaded=!0,r.exports}__webpack_require__.g=function(){if("object"==typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(t){if("object"==typeof window)return window}}(),__webpack_require__.nmd=function(t){return t.paths=[],t.children||(t.children=[]),t};var __webpack_exports__={};!function(){"use strict";function t(t,e){(null==e||e>t.length)&&(e=t.length);for(var r=0,n=new Array(e);r<e;r++)n[r]=t[r];return n}function e(e){return function(e){if(Array.isArray(e))return t(e)}(e)||function(t){if("undefined"!=typeof Symbol&&null!=t[Symbol.iterator]||null!=t["@@iterator"])return Array.from(t)}(e)||function(e,r){if(e){if("string"==typeof e)return t(e,r);var n=Object.prototype.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?t(e,r):void 0}}(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}var r;!function(t){t[t.OLD=3]="OLD",t[t.NEW_SPLIT_CODE=4]="NEW_SPLIT_CODE",t[t.CS_GZIP=5]="CS_GZIP",t[t.NODE=6]="NODE",t[t.REF=7]="REF",t[t.BACKWARD=8]="BACKWARD",t[t.MUTATION=9]="MUTATION"}(r||(r={}));function n(t){let e=t.length;for(;--e>=0;)t[e]=0}const i=256,o=286,s=30,a=15,h=new Uint8Array([0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0]),u=new Uint8Array([0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13]),l=new Uint8Array([0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2,3,7]),f=new Uint8Array([16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15]),c=new Array(576);n(c);const p=new Array(60);n(p);const d=new Array(512);n(d);const g=new Array(256);n(g);const y=new Array(29);n(y);const m=new Array(s);function _(t,e,r,n,i){this.static_tree=t,this.extra_bits=e,this.extra_base=r,this.elems=n,this.max_length=i,this.has_stree=t&&t.length}let b,w,v;function E(t,e){this.dyn_tree=t,this.max_code=0,this.stat_desc=e}n(m);const O=t=>t<256?d[t]:d[256+(t>>>7)],k=(t,e)=>{t.pending_buf[t.pending++]=255&e,t.pending_buf[t.pending++]=e>>>8&255},A=(t,e,r)=>{t.bi_valid>16-r?(t.bi_buf|=e<<t.bi_valid&65535,k(t,t.bi_buf),t.bi_buf=e>>16-t.bi_valid,t.bi_valid+=r-16):(t.bi_buf|=e<<t.bi_valid&65535,t.bi_valid+=r)},T=(t,e,r)=>{A(t,r[2*e],r[2*e+1])},S=(t,e)=>{let r=0;do{r|=1&t,t>>>=1,r<<=1}while(--e>0);return r>>>1},R=(t,e,r)=>{const n=new Array(16);let i,o,s=0;for(i=1;i<=a;i++)n[i]=s=s+r[i-1]<<1;for(o=0;o<=e;o++){let e=t[2*o+1];0!==e&&(t[2*o]=S(n[e]++,e))}},x=t=>{let e;for(e=0;e<o;e++)t.dyn_ltree[2*e]=0;for(e=0;e<s;e++)t.dyn_dtree[2*e]=0;for(e=0;e<19;e++)t.bl_tree[2*e]=0;t.dyn_ltree[512]=1,t.opt_len=t.static_len=0,t.last_lit=t.matches=0},L=t=>{t.bi_valid>8?k(t,t.bi_buf):t.bi_valid>0&&(t.pending_buf[t.pending++]=t.bi_buf),t.bi_buf=0,t.bi_valid=0},N=(t,e,r,n)=>{const i=2*e,o=2*r;return t[i]<t[o]||t[i]===t[o]&&n[e]<=n[r]},I=(t,e,r)=>{const n=t.heap[r];let i=r<<1;for(;i<=t.heap_len&&(i<t.heap_len&&N(e,t.heap[i+1],t.heap[i],t.depth)&&i++,!N(e,n,t.heap[i],t.depth));)t.heap[r]=t.heap[i],r=i,i<<=1;t.heap[r]=n},B=(t,e,r)=>{let n,o,s,a,l=0;if(0!==t.last_lit)do{n=t.pending_buf[t.d_buf+2*l]<<8|t.pending_buf[t.d_buf+2*l+1],o=t.pending_buf[t.l_buf+l],l++,0===n?T(t,o,e):(s=g[o],T(t,s+i+1,e),a=h[s],0!==a&&(o-=y[s],A(t,o,a)),n--,s=O(n),T(t,s,r),a=u[s],0!==a&&(n-=m[s],A(t,n,a)))}while(l<t.last_lit);T(t,256,e)},D=(t,e)=>{const r=e.dyn_tree,n=e.stat_desc.static_tree,i=e.stat_desc.has_stree,o=e.stat_desc.elems;let s,h,u,l=-1;for(t.heap_len=0,t.heap_max=573,s=0;s<o;s++)0!==r[2*s]?(t.heap[++t.heap_len]=l=s,t.depth[s]=0):r[2*s+1]=0;for(;t.heap_len<2;)u=t.heap[++t.heap_len]=l<2?++l:0,r[2*u]=1,t.depth[u]=0,t.opt_len--,i&&(t.static_len-=n[2*u+1]);for(e.max_code=l,s=t.heap_len>>1;s>=1;s--)I(t,r,s);u=o;do{s=t.heap[1],t.heap[1]=t.heap[t.heap_len--],I(t,r,1),h=t.heap[1],t.heap[--t.heap_max]=s,t.heap[--t.heap_max]=h,r[2*u]=r[2*s]+r[2*h],t.depth[u]=(t.depth[s]>=t.depth[h]?t.depth[s]:t.depth[h])+1,r[2*s+1]=r[2*h+1]=u,t.heap[1]=u++,I(t,r,1)}while(t.heap_len>=2);t.heap[--t.heap_max]=t.heap[1],((t,e)=>{const r=e.dyn_tree,n=e.max_code,i=e.stat_desc.static_tree,o=e.stat_desc.has_stree,s=e.stat_desc.extra_bits,h=e.stat_desc.extra_base,u=e.stat_desc.max_length;let l,f,c,p,d,g,y=0;for(p=0;p<=a;p++)t.bl_count[p]=0;for(r[2*t.heap[t.heap_max]+1]=0,l=t.heap_max+1;l<573;l++)f=t.heap[l],p=r[2*r[2*f+1]+1]+1,p>u&&(p=u,y++),r[2*f+1]=p,f>n||(t.bl_count[p]++,d=0,f>=h&&(d=s[f-h]),g=r[2*f],t.opt_len+=g*(p+d),o&&(t.static_len+=g*(i[2*f+1]+d)));if(0!==y){do{for(p=u-1;0===t.bl_count[p];)p--;t.bl_count[p]--,t.bl_count[p+1]+=2,t.bl_count[u]--,y-=2}while(y>0);for(p=u;0!==p;p--)for(f=t.bl_count[p];0!==f;)c=t.heap[--l],c>n||(r[2*c+1]!==p&&(t.opt_len+=(p-r[2*c+1])*r[2*c],r[2*c+1]=p),f--)}})(t,e),R(r,l,t.bl_count)},j=(t,e,r)=>{let n,i,o=-1,s=e[1],a=0,h=7,u=4;for(0===s&&(h=138,u=3),e[2*(r+1)+1]=65535,n=0;n<=r;n++)i=s,s=e[2*(n+1)+1],++a<h&&i===s||(a<u?t.bl_tree[2*i]+=a:0!==i?(i!==o&&t.bl_tree[2*i]++,t.bl_tree[32]++):a<=10?t.bl_tree[34]++:t.bl_tree[36]++,a=0,o=i,0===s?(h=138,u=3):i===s?(h=6,u=3):(h=7,u=4))},C=(t,e,r)=>{let n,i,o=-1,s=e[1],a=0,h=7,u=4;for(0===s&&(h=138,u=3),n=0;n<=r;n++)if(i=s,s=e[2*(n+1)+1],!(++a<h&&i===s)){if(a<u)do{T(t,i,t.bl_tree)}while(0!=--a);else 0!==i?(i!==o&&(T(t,i,t.bl_tree),a--),T(t,16,t.bl_tree),A(t,a-3,2)):a<=10?(T(t,17,t.bl_tree),A(t,a-3,3)):(T(t,18,t.bl_tree),A(t,a-11,7));a=0,o=i,0===s?(h=138,u=3):i===s?(h=6,u=3):(h=7,u=4)}};let U=!1;const z=(t,e,r,n)=>{A(t,0+(n?1:0),3),((t,e,r,n)=>{L(t),n&&(k(t,r),k(t,~r)),t.pending_buf.set(t.window.subarray(e,e+r),t.pending),t.pending+=r})(t,e,r,!0)};var F=(t,e,r,n)=>{let o,s,a=0;t.level>0?(2===t.strm.data_type&&(t.strm.data_type=(t=>{let e,r=4093624447;for(e=0;e<=31;e++,r>>>=1)if(1&r&&0!==t.dyn_ltree[2*e])return 0;if(0!==t.dyn_ltree[18]||0!==t.dyn_ltree[20]||0!==t.dyn_ltree[26])return 1;for(e=32;e<i;e++)if(0!==t.dyn_ltree[2*e])return 1;return 0})(t)),D(t,t.l_desc),D(t,t.d_desc),a=(t=>{let e;for(j(t,t.dyn_ltree,t.l_desc.max_code),j(t,t.dyn_dtree,t.d_desc.max_code),D(t,t.bl_desc),e=18;e>=3&&0===t.bl_tree[2*f[e]+1];e--);return t.opt_len+=3*(e+1)+5+5+4,e})(t),o=t.opt_len+3+7>>>3,s=t.static_len+3+7>>>3,s<=o&&(o=s)):o=s=r+5,r+4<=o&&-1!==e?z(t,e,r,n):4===t.strategy||s===o?(A(t,2+(n?1:0),3),B(t,c,p)):(A(t,4+(n?1:0),3),((t,e,r,n)=>{let i;for(A(t,e-257,5),A(t,r-1,5),A(t,n-4,4),i=0;i<n;i++)A(t,t.bl_tree[2*f[i]+1],3);C(t,t.dyn_ltree,e-1),C(t,t.dyn_dtree,r-1)})(t,t.l_desc.max_code+1,t.d_desc.max_code+1,a+1),B(t,t.dyn_ltree,t.dyn_dtree)),x(t),n&&L(t)},M={_tr_init:t=>{U||((()=>{let t,e,r,n,i;const f=new Array(16);for(r=0,n=0;n<28;n++)for(y[n]=r,t=0;t<1<<h[n];t++)g[r++]=n;for(g[r-1]=n,i=0,n=0;n<16;n++)for(m[n]=i,t=0;t<1<<u[n];t++)d[i++]=n;for(i>>=7;n<s;n++)for(m[n]=i<<7,t=0;t<1<<u[n]-7;t++)d[256+i++]=n;for(e=0;e<=a;e++)f[e]=0;for(t=0;t<=143;)c[2*t+1]=8,t++,f[8]++;for(;t<=255;)c[2*t+1]=9,t++,f[9]++;for(;t<=279;)c[2*t+1]=7,t++,f[7]++;for(;t<=287;)c[2*t+1]=8,t++,f[8]++;for(R(c,287,f),t=0;t<s;t++)p[2*t+1]=5,p[2*t]=S(t,5);b=new _(c,h,257,o,a),w=new _(p,u,0,s,a),v=new _(new Array(0),l,0,19,7)})(),U=!0),t.l_desc=new E(t.dyn_ltree,b),t.d_desc=new E(t.dyn_dtree,w),t.bl_desc=new E(t.bl_tree,v),t.bi_buf=0,t.bi_valid=0,x(t)},_tr_stored_block:z,_tr_flush_block:F,_tr_tally:(t,e,r)=>(t.pending_buf[t.d_buf+2*t.last_lit]=e>>>8&255,t.pending_buf[t.d_buf+2*t.last_lit+1]=255&e,t.pending_buf[t.l_buf+t.last_lit]=255&r,t.last_lit++,0===e?t.dyn_ltree[2*r]++:(t.matches++,e--,t.dyn_ltree[2*(g[r]+i+1)]++,t.dyn_dtree[2*O(e)]++),t.last_lit===t.lit_bufsize-1),_tr_align:t=>{A(t,2,3),T(t,256,c),(t=>{16===t.bi_valid?(k(t,t.bi_buf),t.bi_buf=0,t.bi_valid=0):t.bi_valid>=8&&(t.pending_buf[t.pending++]=255&t.bi_buf,t.bi_buf>>=8,t.bi_valid-=8)})(t)}};var P=(t,e,r,n)=>{let i=65535&t|0,o=t>>>16&65535|0,s=0;for(;0!==r;){s=r>2e3?2e3:r,r-=s;do{i=i+e[n++]|0,o=o+i|0}while(--s);i%=65521,o%=65521}return i|o<<16|0};const Z=new Uint32Array((()=>{let t,e=[];for(var r=0;r<256;r++){t=r;for(var n=0;n<8;n++)t=1&t?3988292384^t>>>1:t>>>1;e[r]=t}return e})());var H=(t,e,r,n)=>{const i=Z,o=n+r;t^=-1;for(let r=n;r<o;r++)t=t>>>8^i[255&(t^e[r])];return-1^t},q={2:"need dictionary",1:"stream end",0:"","-1":"file error","-2":"stream error","-3":"data error","-4":"insufficient memory","-5":"buffer error","-6":"incompatible version"},$={Z_NO_FLUSH:0,Z_PARTIAL_FLUSH:1,Z_SYNC_FLUSH:2,Z_FULL_FLUSH:3,Z_FINISH:4,Z_BLOCK:5,Z_TREES:6,Z_OK:0,Z_STREAM_END:1,Z_NEED_DICT:2,Z_ERRNO:-1,Z_STREAM_ERROR:-2,Z_DATA_ERROR:-3,Z_MEM_ERROR:-4,Z_BUF_ERROR:-5,Z_NO_COMPRESSION:0,Z_BEST_SPEED:1,Z_BEST_COMPRESSION:9,Z_DEFAULT_COMPRESSION:-1,Z_FILTERED:1,Z_HUFFMAN_ONLY:2,Z_RLE:3,Z_FIXED:4,Z_DEFAULT_STRATEGY:0,Z_BINARY:0,Z_TEXT:1,Z_UNKNOWN:2,Z_DEFLATED:8};const{_tr_init:W,_tr_stored_block:K,_tr_flush_block:G,_tr_tally:V,_tr_align:J}=M,{Z_NO_FLUSH:Y,Z_PARTIAL_FLUSH:X,Z_FULL_FLUSH:Q,Z_FINISH:tt,Z_BLOCK:et,Z_OK:rt,Z_STREAM_END:nt,Z_STREAM_ERROR:it,Z_DATA_ERROR:ot,Z_BUF_ERROR:st,Z_DEFAULT_COMPRESSION:at,Z_FILTERED:ht,Z_HUFFMAN_ONLY:ut,Z_RLE:lt,Z_FIXED:ft,Z_DEFAULT_STRATEGY:ct,Z_UNKNOWN:pt,Z_DEFLATED:dt}=$,gt=258,yt=262,mt=103,_t=113,bt=666,wt=(t,e)=>(t.msg=q[e],e),vt=t=>(t<<1)-(t>4?9:0),Et=t=>{let e=t.length;for(;--e>=0;)t[e]=0};let Ot=(t,e,r)=>(e<<t.hash_shift^r)&t.hash_mask;const kt=t=>{const e=t.state;let r=e.pending;r>t.avail_out&&(r=t.avail_out),0!==r&&(t.output.set(e.pending_buf.subarray(e.pending_out,e.pending_out+r),t.next_out),t.next_out+=r,e.pending_out+=r,t.total_out+=r,t.avail_out-=r,e.pending-=r,0===e.pending&&(e.pending_out=0))},At=(t,e)=>{G(t,t.block_start>=0?t.block_start:-1,t.strstart-t.block_start,e),t.block_start=t.strstart,kt(t.strm)},Tt=(t,e)=>{t.pending_buf[t.pending++]=e},St=(t,e)=>{t.pending_buf[t.pending++]=e>>>8&255,t.pending_buf[t.pending++]=255&e},Rt=(t,e,r,n)=>{let i=t.avail_in;return i>n&&(i=n),0===i?0:(t.avail_in-=i,e.set(t.input.subarray(t.next_in,t.next_in+i),r),1===t.state.wrap?t.adler=P(t.adler,e,i,r):2===t.state.wrap&&(t.adler=H(t.adler,e,i,r)),t.next_in+=i,t.total_in+=i,i)},xt=(t,e)=>{let r,n,i=t.max_chain_length,o=t.strstart,s=t.prev_length,a=t.nice_match;const h=t.strstart>t.w_size-yt?t.strstart-(t.w_size-yt):0,u=t.window,l=t.w_mask,f=t.prev,c=t.strstart+gt;let p=u[o+s-1],d=u[o+s];t.prev_length>=t.good_match&&(i>>=2),a>t.lookahead&&(a=t.lookahead);do{if(r=e,u[r+s]===d&&u[r+s-1]===p&&u[r]===u[o]&&u[++r]===u[o+1]){o+=2,r++;do{}while(u[++o]===u[++r]&&u[++o]===u[++r]&&u[++o]===u[++r]&&u[++o]===u[++r]&&u[++o]===u[++r]&&u[++o]===u[++r]&&u[++o]===u[++r]&&u[++o]===u[++r]&&o<c);if(n=gt-(c-o),o=c-gt,n>s){if(t.match_start=e,s=n,n>=a)break;p=u[o+s-1],d=u[o+s]}}}while((e=f[e&l])>h&&0!=--i);return s<=t.lookahead?s:t.lookahead},Lt=t=>{const e=t.w_size;let r,n,i,o,s;do{if(o=t.window_size-t.lookahead-t.strstart,t.strstart>=e+(e-yt)){t.window.set(t.window.subarray(e,e+e),0),t.match_start-=e,t.strstart-=e,t.block_start-=e,n=t.hash_size,r=n;do{i=t.head[--r],t.head[r]=i>=e?i-e:0}while(--n);n=e,r=n;do{i=t.prev[--r],t.prev[r]=i>=e?i-e:0}while(--n);o+=e}if(0===t.strm.avail_in)break;if(n=Rt(t.strm,t.window,t.strstart+t.lookahead,o),t.lookahead+=n,t.lookahead+t.insert>=3)for(s=t.strstart-t.insert,t.ins_h=t.window[s],t.ins_h=Ot(t,t.ins_h,t.window[s+1]);t.insert&&(t.ins_h=Ot(t,t.ins_h,t.window[s+3-1]),t.prev[s&t.w_mask]=t.head[t.ins_h],t.head[t.ins_h]=s,s++,t.insert--,!(t.lookahead+t.insert<3)););}while(t.lookahead<yt&&0!==t.strm.avail_in)},Nt=(t,e)=>{let r,n;for(;;){if(t.lookahead<yt){if(Lt(t),t.lookahead<yt&&e===Y)return 1;if(0===t.lookahead)break}if(r=0,t.lookahead>=3&&(t.ins_h=Ot(t,t.ins_h,t.window[t.strstart+3-1]),r=t.prev[t.strstart&t.w_mask]=t.head[t.ins_h],t.head[t.ins_h]=t.strstart),0!==r&&t.strstart-r<=t.w_size-yt&&(t.match_length=xt(t,r)),t.match_length>=3)if(n=V(t,t.strstart-t.match_start,t.match_length-3),t.lookahead-=t.match_length,t.match_length<=t.max_lazy_match&&t.lookahead>=3){t.match_length--;do{t.strstart++,t.ins_h=Ot(t,t.ins_h,t.window[t.strstart+3-1]),r=t.prev[t.strstart&t.w_mask]=t.head[t.ins_h],t.head[t.ins_h]=t.strstart}while(0!=--t.match_length);t.strstart++}else t.strstart+=t.match_length,t.match_length=0,t.ins_h=t.window[t.strstart],t.ins_h=Ot(t,t.ins_h,t.window[t.strstart+1]);else n=V(t,0,t.window[t.strstart]),t.lookahead--,t.strstart++;if(n&&(At(t,!1),0===t.strm.avail_out))return 1}return t.insert=t.strstart<2?t.strstart:2,e===tt?(At(t,!0),0===t.strm.avail_out?3:4):t.last_lit&&(At(t,!1),0===t.strm.avail_out)?1:2},It=(t,e)=>{let r,n,i;for(;;){if(t.lookahead<yt){if(Lt(t),t.lookahead<yt&&e===Y)return 1;if(0===t.lookahead)break}if(r=0,t.lookahead>=3&&(t.ins_h=Ot(t,t.ins_h,t.window[t.strstart+3-1]),r=t.prev[t.strstart&t.w_mask]=t.head[t.ins_h],t.head[t.ins_h]=t.strstart),t.prev_length=t.match_length,t.prev_match=t.match_start,t.match_length=2,0!==r&&t.prev_length<t.max_lazy_match&&t.strstart-r<=t.w_size-yt&&(t.match_length=xt(t,r),t.match_length<=5&&(t.strategy===ht||3===t.match_length&&t.strstart-t.match_start>4096)&&(t.match_length=2)),t.prev_length>=3&&t.match_length<=t.prev_length){i=t.strstart+t.lookahead-3,n=V(t,t.strstart-1-t.prev_match,t.prev_length-3),t.lookahead-=t.prev_length-1,t.prev_length-=2;do{++t.strstart<=i&&(t.ins_h=Ot(t,t.ins_h,t.window[t.strstart+3-1]),r=t.prev[t.strstart&t.w_mask]=t.head[t.ins_h],t.head[t.ins_h]=t.strstart)}while(0!=--t.prev_length);if(t.match_available=0,t.match_length=2,t.strstart++,n&&(At(t,!1),0===t.strm.avail_out))return 1}else if(t.match_available){if(n=V(t,0,t.window[t.strstart-1]),n&&At(t,!1),t.strstart++,t.lookahead--,0===t.strm.avail_out)return 1}else t.match_available=1,t.strstart++,t.lookahead--}return t.match_available&&(n=V(t,0,t.window[t.strstart-1]),t.match_available=0),t.insert=t.strstart<2?t.strstart:2,e===tt?(At(t,!0),0===t.strm.avail_out?3:4):t.last_lit&&(At(t,!1),0===t.strm.avail_out)?1:2};function Bt(t,e,r,n,i){this.good_length=t,this.max_lazy=e,this.nice_length=r,this.max_chain=n,this.func=i}const Dt=[new Bt(0,0,0,0,((t,e)=>{let r=65535;for(r>t.pending_buf_size-5&&(r=t.pending_buf_size-5);;){if(t.lookahead<=1){if(Lt(t),0===t.lookahead&&e===Y)return 1;if(0===t.lookahead)break}t.strstart+=t.lookahead,t.lookahead=0;const n=t.block_start+r;if((0===t.strstart||t.strstart>=n)&&(t.lookahead=t.strstart-n,t.strstart=n,At(t,!1),0===t.strm.avail_out))return 1;if(t.strstart-t.block_start>=t.w_size-yt&&(At(t,!1),0===t.strm.avail_out))return 1}return t.insert=0,e===tt?(At(t,!0),0===t.strm.avail_out?3:4):(t.strstart>t.block_start&&(At(t,!1),t.strm.avail_out),1)})),new Bt(4,4,8,4,Nt),new Bt(4,5,16,8,Nt),new Bt(4,6,32,32,Nt),new Bt(4,4,16,16,It),new Bt(8,16,32,32,It),new Bt(8,16,128,128,It),new Bt(8,32,128,256,It),new Bt(32,128,258,1024,It),new Bt(32,258,258,4096,It)];function jt(){this.strm=null,this.status=0,this.pending_buf=null,this.pending_buf_size=0,this.pending_out=0,this.pending=0,this.wrap=0,this.gzhead=null,this.gzindex=0,this.method=dt,this.last_flush=-1,this.w_size=0,this.w_bits=0,this.w_mask=0,this.window=null,this.window_size=0,this.prev=null,this.head=null,this.ins_h=0,this.hash_size=0,this.hash_bits=0,this.hash_mask=0,this.hash_shift=0,this.block_start=0,this.match_length=0,this.prev_match=0,this.match_available=0,this.strstart=0,this.match_start=0,this.lookahead=0,this.prev_length=0,this.max_chain_length=0,this.max_lazy_match=0,this.level=0,this.strategy=0,this.good_match=0,this.nice_match=0,this.dyn_ltree=new Uint16Array(1146),this.dyn_dtree=new Uint16Array(122),this.bl_tree=new Uint16Array(78),Et(this.dyn_ltree),Et(this.dyn_dtree),Et(this.bl_tree),this.l_desc=null,this.d_desc=null,this.bl_desc=null,this.bl_count=new Uint16Array(16),this.heap=new Uint16Array(573),Et(this.heap),this.heap_len=0,this.heap_max=0,this.depth=new Uint16Array(573),Et(this.depth),this.l_buf=0,this.lit_bufsize=0,this.last_lit=0,this.d_buf=0,this.opt_len=0,this.static_len=0,this.matches=0,this.insert=0,this.bi_buf=0,this.bi_valid=0}const Ct=t=>{if(!t||!t.state)return wt(t,it);t.total_in=t.total_out=0,t.data_type=pt;const e=t.state;return e.pending=0,e.pending_out=0,e.wrap<0&&(e.wrap=-e.wrap),e.status=e.wrap?42:_t,t.adler=2===e.wrap?0:1,e.last_flush=Y,W(e),rt},Ut=t=>{const e=Ct(t);var r;return e===rt&&((r=t.state).window_size=2*r.w_size,Et(r.head),r.max_lazy_match=Dt[r.level].max_lazy,r.good_match=Dt[r.level].good_length,r.nice_match=Dt[r.level].nice_length,r.max_chain_length=Dt[r.level].max_chain,r.strstart=0,r.block_start=0,r.lookahead=0,r.insert=0,r.match_length=r.prev_length=2,r.match_available=0,r.ins_h=0),e},zt=(t,e,r,n,i,o)=>{if(!t)return it;let s=1;if(e===at&&(e=6),n<0?(s=0,n=-n):n>15&&(s=2,n-=16),i<1||i>9||r!==dt||n<8||n>15||e<0||e>9||o<0||o>ft)return wt(t,it);8===n&&(n=9);const a=new jt;return t.state=a,a.strm=t,a.wrap=s,a.gzhead=null,a.w_bits=n,a.w_size=1<<a.w_bits,a.w_mask=a.w_size-1,a.hash_bits=i+7,a.hash_size=1<<a.hash_bits,a.hash_mask=a.hash_size-1,a.hash_shift=~~((a.hash_bits+3-1)/3),a.window=new Uint8Array(2*a.w_size),a.head=new Uint16Array(a.hash_size),a.prev=new Uint16Array(a.w_size),a.lit_bufsize=1<<i+6,a.pending_buf_size=4*a.lit_bufsize,a.pending_buf=new Uint8Array(a.pending_buf_size),a.d_buf=1*a.lit_bufsize,a.l_buf=3*a.lit_bufsize,a.level=e,a.strategy=o,a.method=r,Ut(t)};var Ft={deflateInit:(t,e)=>zt(t,e,dt,15,8,ct),deflateInit2:zt,deflateReset:Ut,deflateResetKeep:Ct,deflateSetHeader:(t,e)=>t&&t.state?2!==t.state.wrap?it:(t.state.gzhead=e,rt):it,deflate:(t,e)=>{let r,n;if(!t||!t.state||e>et||e<0)return t?wt(t,it):it;const i=t.state;if(!t.output||!t.input&&0!==t.avail_in||i.status===bt&&e!==tt)return wt(t,0===t.avail_out?st:it);i.strm=t;const o=i.last_flush;if(i.last_flush=e,42===i.status)if(2===i.wrap)t.adler=0,Tt(i,31),Tt(i,139),Tt(i,8),i.gzhead?(Tt(i,(i.gzhead.text?1:0)+(i.gzhead.hcrc?2:0)+(i.gzhead.extra?4:0)+(i.gzhead.name?8:0)+(i.gzhead.comment?16:0)),Tt(i,255&i.gzhead.time),Tt(i,i.gzhead.time>>8&255),Tt(i,i.gzhead.time>>16&255),Tt(i,i.gzhead.time>>24&255),Tt(i,9===i.level?2:i.strategy>=ut||i.level<2?4:0),Tt(i,255&i.gzhead.os),i.gzhead.extra&&i.gzhead.extra.length&&(Tt(i,255&i.gzhead.extra.length),Tt(i,i.gzhead.extra.length>>8&255)),i.gzhead.hcrc&&(t.adler=H(t.adler,i.pending_buf,i.pending,0)),i.gzindex=0,i.status=69):(Tt(i,0),Tt(i,0),Tt(i,0),Tt(i,0),Tt(i,0),Tt(i,9===i.level?2:i.strategy>=ut||i.level<2?4:0),Tt(i,3),i.status=_t);else{let e=dt+(i.w_bits-8<<4)<<8,r=-1;r=i.strategy>=ut||i.level<2?0:i.level<6?1:6===i.level?2:3,e|=r<<6,0!==i.strstart&&(e|=32),e+=31-e%31,i.status=_t,St(i,e),0!==i.strstart&&(St(i,t.adler>>>16),St(i,65535&t.adler)),t.adler=1}if(69===i.status)if(i.gzhead.extra){for(r=i.pending;i.gzindex<(65535&i.gzhead.extra.length)&&(i.pending!==i.pending_buf_size||(i.gzhead.hcrc&&i.pending>r&&(t.adler=H(t.adler,i.pending_buf,i.pending-r,r)),kt(t),r=i.pending,i.pending!==i.pending_buf_size));)Tt(i,255&i.gzhead.extra[i.gzindex]),i.gzindex++;i.gzhead.hcrc&&i.pending>r&&(t.adler=H(t.adler,i.pending_buf,i.pending-r,r)),i.gzindex===i.gzhead.extra.length&&(i.gzindex=0,i.status=73)}else i.status=73;if(73===i.status)if(i.gzhead.name){r=i.pending;do{if(i.pending===i.pending_buf_size&&(i.gzhead.hcrc&&i.pending>r&&(t.adler=H(t.adler,i.pending_buf,i.pending-r,r)),kt(t),r=i.pending,i.pending===i.pending_buf_size)){n=1;break}n=i.gzindex<i.gzhead.name.length?255&i.gzhead.name.charCodeAt(i.gzindex++):0,Tt(i,n)}while(0!==n);i.gzhead.hcrc&&i.pending>r&&(t.adler=H(t.adler,i.pending_buf,i.pending-r,r)),0===n&&(i.gzindex=0,i.status=91)}else i.status=91;if(91===i.status)if(i.gzhead.comment){r=i.pending;do{if(i.pending===i.pending_buf_size&&(i.gzhead.hcrc&&i.pending>r&&(t.adler=H(t.adler,i.pending_buf,i.pending-r,r)),kt(t),r=i.pending,i.pending===i.pending_buf_size)){n=1;break}n=i.gzindex<i.gzhead.comment.length?255&i.gzhead.comment.charCodeAt(i.gzindex++):0,Tt(i,n)}while(0!==n);i.gzhead.hcrc&&i.pending>r&&(t.adler=H(t.adler,i.pending_buf,i.pending-r,r)),0===n&&(i.status=mt)}else i.status=mt;if(i.status===mt&&(i.gzhead.hcrc?(i.pending+2>i.pending_buf_size&&kt(t),i.pending+2<=i.pending_buf_size&&(Tt(i,255&t.adler),Tt(i,t.adler>>8&255),t.adler=0,i.status=_t)):i.status=_t),0!==i.pending){if(kt(t),0===t.avail_out)return i.last_flush=-1,rt}else if(0===t.avail_in&&vt(e)<=vt(o)&&e!==tt)return wt(t,st);if(i.status===bt&&0!==t.avail_in)return wt(t,st);if(0!==t.avail_in||0!==i.lookahead||e!==Y&&i.status!==bt){let r=i.strategy===ut?((t,e)=>{let r;for(;;){if(0===t.lookahead&&(Lt(t),0===t.lookahead)){if(e===Y)return 1;break}if(t.match_length=0,r=V(t,0,t.window[t.strstart]),t.lookahead--,t.strstart++,r&&(At(t,!1),0===t.strm.avail_out))return 1}return t.insert=0,e===tt?(At(t,!0),0===t.strm.avail_out?3:4):t.last_lit&&(At(t,!1),0===t.strm.avail_out)?1:2})(i,e):i.strategy===lt?((t,e)=>{let r,n,i,o;const s=t.window;for(;;){if(t.lookahead<=gt){if(Lt(t),t.lookahead<=gt&&e===Y)return 1;if(0===t.lookahead)break}if(t.match_length=0,t.lookahead>=3&&t.strstart>0&&(i=t.strstart-1,n=s[i],n===s[++i]&&n===s[++i]&&n===s[++i])){o=t.strstart+gt;do{}while(n===s[++i]&&n===s[++i]&&n===s[++i]&&n===s[++i]&&n===s[++i]&&n===s[++i]&&n===s[++i]&&n===s[++i]&&i<o);t.match_length=gt-(o-i),t.match_length>t.lookahead&&(t.match_length=t.lookahead)}if(t.match_length>=3?(r=V(t,1,t.match_length-3),t.lookahead-=t.match_length,t.strstart+=t.match_length,t.match_length=0):(r=V(t,0,t.window[t.strstart]),t.lookahead--,t.strstart++),r&&(At(t,!1),0===t.strm.avail_out))return 1}return t.insert=0,e===tt?(At(t,!0),0===t.strm.avail_out?3:4):t.last_lit&&(At(t,!1),0===t.strm.avail_out)?1:2})(i,e):Dt[i.level].func(i,e);if(3!==r&&4!==r||(i.status=bt),1===r||3===r)return 0===t.avail_out&&(i.last_flush=-1),rt;if(2===r&&(e===X?J(i):e!==et&&(K(i,0,0,!1),e===Q&&(Et(i.head),0===i.lookahead&&(i.strstart=0,i.block_start=0,i.insert=0))),kt(t),0===t.avail_out))return i.last_flush=-1,rt}return e!==tt?rt:i.wrap<=0?nt:(2===i.wrap?(Tt(i,255&t.adler),Tt(i,t.adler>>8&255),Tt(i,t.adler>>16&255),Tt(i,t.adler>>24&255),Tt(i,255&t.total_in),Tt(i,t.total_in>>8&255),Tt(i,t.total_in>>16&255),Tt(i,t.total_in>>24&255)):(St(i,t.adler>>>16),St(i,65535&t.adler)),kt(t),i.wrap>0&&(i.wrap=-i.wrap),0!==i.pending?rt:nt)},deflateEnd:t=>{if(!t||!t.state)return it;const e=t.state.status;return 42!==e&&69!==e&&73!==e&&91!==e&&e!==mt&&e!==_t&&e!==bt?wt(t,it):(t.state=null,e===_t?wt(t,ot):rt)},deflateSetDictionary:(t,e)=>{let r=e.length;if(!t||!t.state)return it;const n=t.state,i=n.wrap;if(2===i||1===i&&42!==n.status||n.lookahead)return it;if(1===i&&(t.adler=P(t.adler,e,r,0)),n.wrap=0,r>=n.w_size){0===i&&(Et(n.head),n.strstart=0,n.block_start=0,n.insert=0);let t=new Uint8Array(n.w_size);t.set(e.subarray(r-n.w_size,r),0),e=t,r=n.w_size}const o=t.avail_in,s=t.next_in,a=t.input;for(t.avail_in=r,t.next_in=0,t.input=e,Lt(n);n.lookahead>=3;){let t=n.strstart,e=n.lookahead-2;do{n.ins_h=Ot(n,n.ins_h,n.window[t+3-1]),n.prev[t&n.w_mask]=n.head[n.ins_h],n.head[n.ins_h]=t,t++}while(--e);n.strstart=t,n.lookahead=2,Lt(n)}return n.strstart+=n.lookahead,n.block_start=n.strstart,n.insert=n.lookahead,n.lookahead=0,n.match_length=n.prev_length=2,n.match_available=0,t.next_in=s,t.input=a,t.avail_in=o,n.wrap=i,rt},deflateInfo:"pako deflate (from Nodeca project)"};const Mt=(t,e)=>Object.prototype.hasOwnProperty.call(t,e);var Pt=function(t){const e=Array.prototype.slice.call(arguments,1);for(;e.length;){const r=e.shift();if(r){if("object"!=typeof r)throw new TypeError(r+"must be non-object");for(const e in r)Mt(r,e)&&(t[e]=r[e])}}return t},Zt=t=>{let e=0;for(let r=0,n=t.length;r<n;r++)e+=t[r].length;const r=new Uint8Array(e);for(let e=0,n=0,i=t.length;e<i;e++){let i=t[e];r.set(i,n),n+=i.length}return r};let Ht=!0;try{String.fromCharCode.apply(null,new Uint8Array(1))}catch(t){Ht=!1}const qt=new Uint8Array(256);for(let t=0;t<256;t++)qt[t]=t>=252?6:t>=248?5:t>=240?4:t>=224?3:t>=192?2:1;qt[254]=qt[254]=1;var $t=t=>{if("function"==typeof TextEncoder&&TextEncoder.prototype.encode)return(new TextEncoder).encode(t);let e,r,n,i,o,s=t.length,a=0;for(i=0;i<s;i++)r=t.charCodeAt(i),55296==(64512&r)&&i+1<s&&(n=t.charCodeAt(i+1),56320==(64512&n)&&(r=65536+(r-55296<<10)+(n-56320),i++)),a+=r<128?1:r<2048?2:r<65536?3:4;for(e=new Uint8Array(a),o=0,i=0;o<a;i++)r=t.charCodeAt(i),55296==(64512&r)&&i+1<s&&(n=t.charCodeAt(i+1),56320==(64512&n)&&(r=65536+(r-55296<<10)+(n-56320),i++)),r<128?e[o++]=r:r<2048?(e[o++]=192|r>>>6,e[o++]=128|63&r):r<65536?(e[o++]=224|r>>>12,e[o++]=128|r>>>6&63,e[o++]=128|63&r):(e[o++]=240|r>>>18,e[o++]=128|r>>>12&63,e[o++]=128|r>>>6&63,e[o++]=128|63&r);return e},Wt=(t,e)=>{const r=e||t.length;if("function"==typeof TextDecoder&&TextDecoder.prototype.decode)return(new TextDecoder).decode(t.subarray(0,e));let n,i;const o=new Array(2*r);for(i=0,n=0;n<r;){let e=t[n++];if(e<128){o[i++]=e;continue}let s=qt[e];if(s>4)o[i++]=65533,n+=s-1;else{for(e&=2===s?31:3===s?15:7;s>1&&n<r;)e=e<<6|63&t[n++],s--;s>1?o[i++]=65533:e<65536?o[i++]=e:(e-=65536,o[i++]=55296|e>>10&1023,o[i++]=56320|1023&e)}}return((t,e)=>{if(e<65534&&t.subarray&&Ht)return String.fromCharCode.apply(null,t.length===e?t:t.subarray(0,e));let r="";for(let n=0;n<e;n++)r+=String.fromCharCode(t[n]);return r})(o,i)},Kt=(t,e)=>{(e=e||t.length)>t.length&&(e=t.length);let r=e-1;for(;r>=0&&128==(192&t[r]);)r--;return r<0||0===r?e:r+qt[t[r]]>e?r:e};var Gt=function(){this.input=null,this.next_in=0,this.avail_in=0,this.total_in=0,this.output=null,this.next_out=0,this.avail_out=0,this.total_out=0,this.msg="",this.state=null,this.data_type=2,this.adler=0};const Vt=Object.prototype.toString,{Z_NO_FLUSH:Jt,Z_SYNC_FLUSH:Yt,Z_FULL_FLUSH:Xt,Z_FINISH:Qt,Z_OK:te,Z_STREAM_END:ee,Z_DEFAULT_COMPRESSION:re,Z_DEFAULT_STRATEGY:ne,Z_DEFLATED:ie}=$;function oe(t){this.options=Pt({level:re,method:ie,chunkSize:16384,windowBits:15,memLevel:8,strategy:ne},t||{});let e=this.options;e.raw&&e.windowBits>0?e.windowBits=-e.windowBits:e.gzip&&e.windowBits>0&&e.windowBits<16&&(e.windowBits+=16),this.err=0,this.msg="",this.ended=!1,this.chunks=[],this.strm=new Gt,this.strm.avail_out=0;let r=Ft.deflateInit2(this.strm,e.level,e.method,e.windowBits,e.memLevel,e.strategy);if(r!==te)throw new Error(q[r]);if(e.header&&Ft.deflateSetHeader(this.strm,e.header),e.dictionary){let t;if(t="string"==typeof e.dictionary?$t(e.dictionary):"[object ArrayBuffer]"===Vt.call(e.dictionary)?new Uint8Array(e.dictionary):e.dictionary,r=Ft.deflateSetDictionary(this.strm,t),r!==te)throw new Error(q[r]);this._dict_set=!0}}function se(t,e){const r=new oe(e);if(r.push(t,!0),r.err)throw r.msg||q[r.err];return r.result}oe.prototype.push=function(t,e){const r=this.strm,n=this.options.chunkSize;let i,o;if(this.ended)return!1;for(o=e===~~e?e:!0===e?Qt:Jt,"string"==typeof t?r.input=$t(t):"[object ArrayBuffer]"===Vt.call(t)?r.input=new Uint8Array(t):r.input=t,r.next_in=0,r.avail_in=r.input.length;;)if(0===r.avail_out&&(r.output=new Uint8Array(n),r.next_out=0,r.avail_out=n),(o===Yt||o===Xt)&&r.avail_out<=6)this.onData(r.output.subarray(0,r.next_out)),r.avail_out=0;else{if(i=Ft.deflate(r,o),i===ee)return r.next_out>0&&this.onData(r.output.subarray(0,r.next_out)),i=Ft.deflateEnd(this.strm),this.onEnd(i),this.ended=!0,i===te;if(0!==r.avail_out){if(o>0&&r.next_out>0)this.onData(r.output.subarray(0,r.next_out)),r.avail_out=0;else if(0===r.avail_in)break}else this.onData(r.output)}return!0},oe.prototype.onData=function(t){this.chunks.push(t)},oe.prototype.onEnd=function(t){t===te&&(this.result=Zt(this.chunks)),this.chunks=[],this.err=t,this.msg=this.strm.msg};var ae={Deflate:oe,deflate:se,deflateRaw:function(t,e){return(e=e||{}).raw=!0,se(t,e)},gzip:function(t,e){return(e=e||{}).gzip=!0,se(t,e)},constants:$};var he=function(t,e){let r,n,i,o,s,a,h,u,l,f,c,p,d,g,y,m,_,b,w,v,E,O,k,A;const T=t.state;r=t.next_in,k=t.input,n=r+(t.avail_in-5),i=t.next_out,A=t.output,o=i-(e-t.avail_out),s=i+(t.avail_out-257),a=T.dmax,h=T.wsize,u=T.whave,l=T.wnext,f=T.window,c=T.hold,p=T.bits,d=T.lencode,g=T.distcode,y=(1<<T.lenbits)-1,m=(1<<T.distbits)-1;t:do{p<15&&(c+=k[r++]<<p,p+=8,c+=k[r++]<<p,p+=8),_=d[c&y];e:for(;;){if(b=_>>>24,c>>>=b,p-=b,b=_>>>16&255,0===b)A[i++]=65535&_;else{if(!(16&b)){if(0==(64&b)){_=d[(65535&_)+(c&(1<<b)-1)];continue e}if(32&b){T.mode=12;break t}t.msg="invalid literal/length code",T.mode=30;break t}w=65535&_,b&=15,b&&(p<b&&(c+=k[r++]<<p,p+=8),w+=c&(1<<b)-1,c>>>=b,p-=b),p<15&&(c+=k[r++]<<p,p+=8,c+=k[r++]<<p,p+=8),_=g[c&m];r:for(;;){if(b=_>>>24,c>>>=b,p-=b,b=_>>>16&255,!(16&b)){if(0==(64&b)){_=g[(65535&_)+(c&(1<<b)-1)];continue r}t.msg="invalid distance code",T.mode=30;break t}if(v=65535&_,b&=15,p<b&&(c+=k[r++]<<p,p+=8,p<b&&(c+=k[r++]<<p,p+=8)),v+=c&(1<<b)-1,v>a){t.msg="invalid distance too far back",T.mode=30;break t}if(c>>>=b,p-=b,b=i-o,v>b){if(b=v-b,b>u&&T.sane){t.msg="invalid distance too far back",T.mode=30;break t}if(E=0,O=f,0===l){if(E+=h-b,b<w){w-=b;do{A[i++]=f[E++]}while(--b);E=i-v,O=A}}else if(l<b){if(E+=h+l-b,b-=l,b<w){w-=b;do{A[i++]=f[E++]}while(--b);if(E=0,l<w){b=l,w-=b;do{A[i++]=f[E++]}while(--b);E=i-v,O=A}}}else if(E+=l-b,b<w){w-=b;do{A[i++]=f[E++]}while(--b);E=i-v,O=A}for(;w>2;)A[i++]=O[E++],A[i++]=O[E++],A[i++]=O[E++],w-=3;w&&(A[i++]=O[E++],w>1&&(A[i++]=O[E++]))}else{E=i-v;do{A[i++]=A[E++],A[i++]=A[E++],A[i++]=A[E++],w-=3}while(w>2);w&&(A[i++]=A[E++],w>1&&(A[i++]=A[E++]))}break}}break}}while(r<n&&i<s);w=p>>3,r-=w,p-=w<<3,c&=(1<<p)-1,t.next_in=r,t.next_out=i,t.avail_in=r<n?n-r+5:5-(r-n),t.avail_out=i<s?s-i+257:257-(i-s),T.hold=c,T.bits=p};const ue=15,le=new Uint16Array([3,4,5,6,7,8,9,10,11,13,15,17,19,23,27,31,35,43,51,59,67,83,99,115,131,163,195,227,258,0,0]),fe=new Uint8Array([16,16,16,16,16,16,16,16,17,17,17,17,18,18,18,18,19,19,19,19,20,20,20,20,21,21,21,21,16,72,78]),ce=new Uint16Array([1,2,3,4,5,7,9,13,17,25,33,49,65,97,129,193,257,385,513,769,1025,1537,2049,3073,4097,6145,8193,12289,16385,24577,0,0]),pe=new Uint8Array([16,16,16,16,17,17,18,18,19,19,20,20,21,21,22,22,23,23,24,24,25,25,26,26,27,27,28,28,29,29,64,64]);var de=(t,e,r,n,i,o,s,a)=>{const h=a.bits;let u,l,f,c,p,d,g=0,y=0,m=0,_=0,b=0,w=0,v=0,E=0,O=0,k=0,A=null,T=0;const S=new Uint16Array(16),R=new Uint16Array(16);let x,L,N,I=null,B=0;for(g=0;g<=ue;g++)S[g]=0;for(y=0;y<n;y++)S[e[r+y]]++;for(b=h,_=ue;_>=1&&0===S[_];_--);if(b>_&&(b=_),0===_)return i[o++]=20971520,i[o++]=20971520,a.bits=1,0;for(m=1;m<_&&0===S[m];m++);for(b<m&&(b=m),E=1,g=1;g<=ue;g++)if(E<<=1,E-=S[g],E<0)return-1;if(E>0&&(0===t||1!==_))return-1;for(R[1]=0,g=1;g<ue;g++)R[g+1]=R[g]+S[g];for(y=0;y<n;y++)0!==e[r+y]&&(s[R[e[r+y]]++]=y);if(0===t?(A=I=s,d=19):1===t?(A=le,T-=257,I=fe,B-=257,d=256):(A=ce,I=pe,d=-1),k=0,y=0,g=m,p=o,w=b,v=0,f=-1,O=1<<b,c=O-1,1===t&&O>852||2===t&&O>592)return 1;for(;;){x=g-v,s[y]<d?(L=0,N=s[y]):s[y]>d?(L=I[B+s[y]],N=A[T+s[y]]):(L=96,N=0),u=1<<g-v,l=1<<w,m=l;do{l-=u,i[p+(k>>v)+l]=x<<24|L<<16|N|0}while(0!==l);for(u=1<<g-1;k&u;)u>>=1;if(0!==u?(k&=u-1,k+=u):k=0,y++,0==--S[g]){if(g===_)break;g=e[r+s[y]]}if(g>b&&(k&c)!==f){for(0===v&&(v=b),p+=m,w=g-v,E=1<<w;w+v<_&&(E-=S[w+v],!(E<=0));)w++,E<<=1;if(O+=1<<w,1===t&&O>852||2===t&&O>592)return 1;f=k&c,i[f]=b<<24|w<<16|p-o|0}}return 0!==k&&(i[p+k]=g-v<<24|64<<16|0),a.bits=b,0};const{Z_FINISH:ge,Z_BLOCK:ye,Z_TREES:me,Z_OK:_e,Z_STREAM_END:be,Z_NEED_DICT:we,Z_STREAM_ERROR:ve,Z_DATA_ERROR:Ee,Z_MEM_ERROR:Oe,Z_BUF_ERROR:ke,Z_DEFLATED:Ae}=$,Te=12,Se=30,Re=t=>(t>>>24&255)+(t>>>8&65280)+((65280&t)<<8)+((255&t)<<24);function xe(){this.mode=0,this.last=!1,this.wrap=0,this.havedict=!1,this.flags=0,this.dmax=0,this.check=0,this.total=0,this.head=null,this.wbits=0,this.wsize=0,this.whave=0,this.wnext=0,this.window=null,this.hold=0,this.bits=0,this.length=0,this.offset=0,this.extra=0,this.lencode=null,this.distcode=null,this.lenbits=0,this.distbits=0,this.ncode=0,this.nlen=0,this.ndist=0,this.have=0,this.next=null,this.lens=new Uint16Array(320),this.work=new Uint16Array(288),this.lendyn=null,this.distdyn=null,this.sane=0,this.back=0,this.was=0}const Le=t=>{if(!t||!t.state)return ve;const e=t.state;return t.total_in=t.total_out=e.total=0,t.msg="",e.wrap&&(t.adler=1&e.wrap),e.mode=1,e.last=0,e.havedict=0,e.dmax=32768,e.head=null,e.hold=0,e.bits=0,e.lencode=e.lendyn=new Int32Array(852),e.distcode=e.distdyn=new Int32Array(592),e.sane=1,e.back=-1,_e},Ne=t=>{if(!t||!t.state)return ve;const e=t.state;return e.wsize=0,e.whave=0,e.wnext=0,Le(t)},Ie=(t,e)=>{let r;if(!t||!t.state)return ve;const n=t.state;return e<0?(r=0,e=-e):(r=1+(e>>4),e<48&&(e&=15)),e&&(e<8||e>15)?ve:(null!==n.window&&n.wbits!==e&&(n.window=null),n.wrap=r,n.wbits=e,Ne(t))},Be=(t,e)=>{if(!t)return ve;const r=new xe;t.state=r,r.window=null;const n=Ie(t,e);return n!==_e&&(t.state=null),n};let De,je,Ce=!0;const Ue=t=>{if(Ce){De=new Int32Array(512),je=new Int32Array(32);let e=0;for(;e<144;)t.lens[e++]=8;for(;e<256;)t.lens[e++]=9;for(;e<280;)t.lens[e++]=7;for(;e<288;)t.lens[e++]=8;for(de(1,t.lens,0,288,De,0,t.work,{bits:9}),e=0;e<32;)t.lens[e++]=5;de(2,t.lens,0,32,je,0,t.work,{bits:5}),Ce=!1}t.lencode=De,t.lenbits=9,t.distcode=je,t.distbits=5},ze=(t,e,r,n)=>{let i;const o=t.state;return null===o.window&&(o.wsize=1<<o.wbits,o.wnext=0,o.whave=0,o.window=new Uint8Array(o.wsize)),n>=o.wsize?(o.window.set(e.subarray(r-o.wsize,r),0),o.wnext=0,o.whave=o.wsize):(i=o.wsize-o.wnext,i>n&&(i=n),o.window.set(e.subarray(r-n,r-n+i),o.wnext),(n-=i)?(o.window.set(e.subarray(r-n,r),0),o.wnext=n,o.whave=o.wsize):(o.wnext+=i,o.wnext===o.wsize&&(o.wnext=0),o.whave<o.wsize&&(o.whave+=i))),0};var Fe={inflateReset:Ne,inflateReset2:Ie,inflateResetKeep:Le,inflateInit:t=>Be(t,15),inflateInit2:Be,inflate:(t,e)=>{let r,n,i,o,s,a,h,u,l,f,c,p,d,g,y,m,_,b,w,v,E,O,k=0;const A=new Uint8Array(4);let T,S;const R=new Uint8Array([16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15]);if(!t||!t.state||!t.output||!t.input&&0!==t.avail_in)return ve;r=t.state,r.mode===Te&&(r.mode=13),s=t.next_out,i=t.output,h=t.avail_out,o=t.next_in,n=t.input,a=t.avail_in,u=r.hold,l=r.bits,f=a,c=h,O=_e;t:for(;;)switch(r.mode){case 1:if(0===r.wrap){r.mode=13;break}for(;l<16;){if(0===a)break t;a--,u+=n[o++]<<l,l+=8}if(2&r.wrap&&35615===u){r.check=0,A[0]=255&u,A[1]=u>>>8&255,r.check=H(r.check,A,2,0),u=0,l=0,r.mode=2;break}if(r.flags=0,r.head&&(r.head.done=!1),!(1&r.wrap)||(((255&u)<<8)+(u>>8))%31){t.msg="incorrect header check",r.mode=Se;break}if((15&u)!==Ae){t.msg="unknown compression method",r.mode=Se;break}if(u>>>=4,l-=4,E=8+(15&u),0===r.wbits)r.wbits=E;else if(E>r.wbits){t.msg="invalid window size",r.mode=Se;break}r.dmax=1<<r.wbits,t.adler=r.check=1,r.mode=512&u?10:Te,u=0,l=0;break;case 2:for(;l<16;){if(0===a)break t;a--,u+=n[o++]<<l,l+=8}if(r.flags=u,(255&r.flags)!==Ae){t.msg="unknown compression method",r.mode=Se;break}if(57344&r.flags){t.msg="unknown header flags set",r.mode=Se;break}r.head&&(r.head.text=u>>8&1),512&r.flags&&(A[0]=255&u,A[1]=u>>>8&255,r.check=H(r.check,A,2,0)),u=0,l=0,r.mode=3;case 3:for(;l<32;){if(0===a)break t;a--,u+=n[o++]<<l,l+=8}r.head&&(r.head.time=u),512&r.flags&&(A[0]=255&u,A[1]=u>>>8&255,A[2]=u>>>16&255,A[3]=u>>>24&255,r.check=H(r.check,A,4,0)),u=0,l=0,r.mode=4;case 4:for(;l<16;){if(0===a)break t;a--,u+=n[o++]<<l,l+=8}r.head&&(r.head.xflags=255&u,r.head.os=u>>8),512&r.flags&&(A[0]=255&u,A[1]=u>>>8&255,r.check=H(r.check,A,2,0)),u=0,l=0,r.mode=5;case 5:if(1024&r.flags){for(;l<16;){if(0===a)break t;a--,u+=n[o++]<<l,l+=8}r.length=u,r.head&&(r.head.extra_len=u),512&r.flags&&(A[0]=255&u,A[1]=u>>>8&255,r.check=H(r.check,A,2,0)),u=0,l=0}else r.head&&(r.head.extra=null);r.mode=6;case 6:if(1024&r.flags&&(p=r.length,p>a&&(p=a),p&&(r.head&&(E=r.head.extra_len-r.length,r.head.extra||(r.head.extra=new Uint8Array(r.head.extra_len)),r.head.extra.set(n.subarray(o,o+p),E)),512&r.flags&&(r.check=H(r.check,n,p,o)),a-=p,o+=p,r.length-=p),r.length))break t;r.length=0,r.mode=7;case 7:if(2048&r.flags){if(0===a)break t;p=0;do{E=n[o+p++],r.head&&E&&r.length<65536&&(r.head.name+=String.fromCharCode(E))}while(E&&p<a);if(512&r.flags&&(r.check=H(r.check,n,p,o)),a-=p,o+=p,E)break t}else r.head&&(r.head.name=null);r.length=0,r.mode=8;case 8:if(4096&r.flags){if(0===a)break t;p=0;do{E=n[o+p++],r.head&&E&&r.length<65536&&(r.head.comment+=String.fromCharCode(E))}while(E&&p<a);if(512&r.flags&&(r.check=H(r.check,n,p,o)),a-=p,o+=p,E)break t}else r.head&&(r.head.comment=null);r.mode=9;case 9:if(512&r.flags){for(;l<16;){if(0===a)break t;a--,u+=n[o++]<<l,l+=8}if(u!==(65535&r.check)){t.msg="header crc mismatch",r.mode=Se;break}u=0,l=0}r.head&&(r.head.hcrc=r.flags>>9&1,r.head.done=!0),t.adler=r.check=0,r.mode=Te;break;case 10:for(;l<32;){if(0===a)break t;a--,u+=n[o++]<<l,l+=8}t.adler=r.check=Re(u),u=0,l=0,r.mode=11;case 11:if(0===r.havedict)return t.next_out=s,t.avail_out=h,t.next_in=o,t.avail_in=a,r.hold=u,r.bits=l,we;t.adler=r.check=1,r.mode=Te;case Te:if(e===ye||e===me)break t;case 13:if(r.last){u>>>=7&l,l-=7&l,r.mode=27;break}for(;l<3;){if(0===a)break t;a--,u+=n[o++]<<l,l+=8}switch(r.last=1&u,u>>>=1,l-=1,3&u){case 0:r.mode=14;break;case 1:if(Ue(r),r.mode=20,e===me){u>>>=2,l-=2;break t}break;case 2:r.mode=17;break;case 3:t.msg="invalid block type",r.mode=Se}u>>>=2,l-=2;break;case 14:for(u>>>=7&l,l-=7&l;l<32;){if(0===a)break t;a--,u+=n[o++]<<l,l+=8}if((65535&u)!=(u>>>16^65535)){t.msg="invalid stored block lengths",r.mode=Se;break}if(r.length=65535&u,u=0,l=0,r.mode=15,e===me)break t;case 15:r.mode=16;case 16:if(p=r.length,p){if(p>a&&(p=a),p>h&&(p=h),0===p)break t;i.set(n.subarray(o,o+p),s),a-=p,o+=p,h-=p,s+=p,r.length-=p;break}r.mode=Te;break;case 17:for(;l<14;){if(0===a)break t;a--,u+=n[o++]<<l,l+=8}if(r.nlen=257+(31&u),u>>>=5,l-=5,r.ndist=1+(31&u),u>>>=5,l-=5,r.ncode=4+(15&u),u>>>=4,l-=4,r.nlen>286||r.ndist>30){t.msg="too many length or distance symbols",r.mode=Se;break}r.have=0,r.mode=18;case 18:for(;r.have<r.ncode;){for(;l<3;){if(0===a)break t;a--,u+=n[o++]<<l,l+=8}r.lens[R[r.have++]]=7&u,u>>>=3,l-=3}for(;r.have<19;)r.lens[R[r.have++]]=0;if(r.lencode=r.lendyn,r.lenbits=7,T={bits:r.lenbits},O=de(0,r.lens,0,19,r.lencode,0,r.work,T),r.lenbits=T.bits,O){t.msg="invalid code lengths set",r.mode=Se;break}r.have=0,r.mode=19;case 19:for(;r.have<r.nlen+r.ndist;){for(;k=r.lencode[u&(1<<r.lenbits)-1],y=k>>>24,m=k>>>16&255,_=65535&k,!(y<=l);){if(0===a)break t;a--,u+=n[o++]<<l,l+=8}if(_<16)u>>>=y,l-=y,r.lens[r.have++]=_;else{if(16===_){for(S=y+2;l<S;){if(0===a)break t;a--,u+=n[o++]<<l,l+=8}if(u>>>=y,l-=y,0===r.have){t.msg="invalid bit length repeat",r.mode=Se;break}E=r.lens[r.have-1],p=3+(3&u),u>>>=2,l-=2}else if(17===_){for(S=y+3;l<S;){if(0===a)break t;a--,u+=n[o++]<<l,l+=8}u>>>=y,l-=y,E=0,p=3+(7&u),u>>>=3,l-=3}else{for(S=y+7;l<S;){if(0===a)break t;a--,u+=n[o++]<<l,l+=8}u>>>=y,l-=y,E=0,p=11+(127&u),u>>>=7,l-=7}if(r.have+p>r.nlen+r.ndist){t.msg="invalid bit length repeat",r.mode=Se;break}for(;p--;)r.lens[r.have++]=E}}if(r.mode===Se)break;if(0===r.lens[256]){t.msg="invalid code -- missing end-of-block",r.mode=Se;break}if(r.lenbits=9,T={bits:r.lenbits},O=de(1,r.lens,0,r.nlen,r.lencode,0,r.work,T),r.lenbits=T.bits,O){t.msg="invalid literal/lengths set",r.mode=Se;break}if(r.distbits=6,r.distcode=r.distdyn,T={bits:r.distbits},O=de(2,r.lens,r.nlen,r.ndist,r.distcode,0,r.work,T),r.distbits=T.bits,O){t.msg="invalid distances set",r.mode=Se;break}if(r.mode=20,e===me)break t;case 20:r.mode=21;case 21:if(a>=6&&h>=258){t.next_out=s,t.avail_out=h,t.next_in=o,t.avail_in=a,r.hold=u,r.bits=l,he(t,c),s=t.next_out,i=t.output,h=t.avail_out,o=t.next_in,n=t.input,a=t.avail_in,u=r.hold,l=r.bits,r.mode===Te&&(r.back=-1);break}for(r.back=0;k=r.lencode[u&(1<<r.lenbits)-1],y=k>>>24,m=k>>>16&255,_=65535&k,!(y<=l);){if(0===a)break t;a--,u+=n[o++]<<l,l+=8}if(m&&0==(240&m)){for(b=y,w=m,v=_;k=r.lencode[v+((u&(1<<b+w)-1)>>b)],y=k>>>24,m=k>>>16&255,_=65535&k,!(b+y<=l);){if(0===a)break t;a--,u+=n[o++]<<l,l+=8}u>>>=b,l-=b,r.back+=b}if(u>>>=y,l-=y,r.back+=y,r.length=_,0===m){r.mode=26;break}if(32&m){r.back=-1,r.mode=Te;break}if(64&m){t.msg="invalid literal/length code",r.mode=Se;break}r.extra=15&m,r.mode=22;case 22:if(r.extra){for(S=r.extra;l<S;){if(0===a)break t;a--,u+=n[o++]<<l,l+=8}r.length+=u&(1<<r.extra)-1,u>>>=r.extra,l-=r.extra,r.back+=r.extra}r.was=r.length,r.mode=23;case 23:for(;k=r.distcode[u&(1<<r.distbits)-1],y=k>>>24,m=k>>>16&255,_=65535&k,!(y<=l);){if(0===a)break t;a--,u+=n[o++]<<l,l+=8}if(0==(240&m)){for(b=y,w=m,v=_;k=r.distcode[v+((u&(1<<b+w)-1)>>b)],y=k>>>24,m=k>>>16&255,_=65535&k,!(b+y<=l);){if(0===a)break t;a--,u+=n[o++]<<l,l+=8}u>>>=b,l-=b,r.back+=b}if(u>>>=y,l-=y,r.back+=y,64&m){t.msg="invalid distance code",r.mode=Se;break}r.offset=_,r.extra=15&m,r.mode=24;case 24:if(r.extra){for(S=r.extra;l<S;){if(0===a)break t;a--,u+=n[o++]<<l,l+=8}r.offset+=u&(1<<r.extra)-1,u>>>=r.extra,l-=r.extra,r.back+=r.extra}if(r.offset>r.dmax){t.msg="invalid distance too far back",r.mode=Se;break}r.mode=25;case 25:if(0===h)break t;if(p=c-h,r.offset>p){if(p=r.offset-p,p>r.whave&&r.sane){t.msg="invalid distance too far back",r.mode=Se;break}p>r.wnext?(p-=r.wnext,d=r.wsize-p):d=r.wnext-p,p>r.length&&(p=r.length),g=r.window}else g=i,d=s-r.offset,p=r.length;p>h&&(p=h),h-=p,r.length-=p;do{i[s++]=g[d++]}while(--p);0===r.length&&(r.mode=21);break;case 26:if(0===h)break t;i[s++]=r.length,h--,r.mode=21;break;case 27:if(r.wrap){for(;l<32;){if(0===a)break t;a--,u|=n[o++]<<l,l+=8}if(c-=h,t.total_out+=c,r.total+=c,c&&(t.adler=r.check=r.flags?H(r.check,i,c,s-c):P(r.check,i,c,s-c)),c=h,(r.flags?u:Re(u))!==r.check){t.msg="incorrect data check",r.mode=Se;break}u=0,l=0}r.mode=28;case 28:if(r.wrap&&r.flags){for(;l<32;){if(0===a)break t;a--,u+=n[o++]<<l,l+=8}if(u!==(4294967295&r.total)){t.msg="incorrect length check",r.mode=Se;break}u=0,l=0}r.mode=29;case 29:O=be;break t;case Se:O=Ee;break t;case 31:return Oe;default:return ve}return t.next_out=s,t.avail_out=h,t.next_in=o,t.avail_in=a,r.hold=u,r.bits=l,(r.wsize||c!==t.avail_out&&r.mode<Se&&(r.mode<27||e!==ge))&&ze(t,t.output,t.next_out,c-t.avail_out),f-=t.avail_in,c-=t.avail_out,t.total_in+=f,t.total_out+=c,r.total+=c,r.wrap&&c&&(t.adler=r.check=r.flags?H(r.check,i,c,t.next_out-c):P(r.check,i,c,t.next_out-c)),t.data_type=r.bits+(r.last?64:0)+(r.mode===Te?128:0)+(20===r.mode||15===r.mode?256:0),(0===f&&0===c||e===ge)&&O===_e&&(O=ke),O},inflateEnd:t=>{if(!t||!t.state)return ve;let e=t.state;return e.window&&(e.window=null),t.state=null,_e},inflateGetHeader:(t,e)=>{if(!t||!t.state)return ve;const r=t.state;return 0==(2&r.wrap)?ve:(r.head=e,e.done=!1,_e)},inflateSetDictionary:(t,e)=>{const r=e.length;let n,i,o;return t&&t.state?(n=t.state,0!==n.wrap&&11!==n.mode?ve:11===n.mode&&(i=1,i=P(i,e,r,0),i!==n.check)?Ee:(o=ze(t,e,r,r),o?(n.mode=31,Oe):(n.havedict=1,_e))):ve},inflateInfo:"pako inflate (from Nodeca project)"};var Me=function(){this.text=0,this.time=0,this.xflags=0,this.os=0,this.extra=null,this.extra_len=0,this.name="",this.comment="",this.hcrc=0,this.done=!1};const Pe=Object.prototype.toString,{Z_NO_FLUSH:Ze,Z_FINISH:He,Z_OK:qe,Z_STREAM_END:$e,Z_NEED_DICT:We,Z_STREAM_ERROR:Ke,Z_DATA_ERROR:Ge,Z_MEM_ERROR:Ve}=$;function Je(t){this.options=Pt({chunkSize:65536,windowBits:15,to:""},t||{});const e=this.options;e.raw&&e.windowBits>=0&&e.windowBits<16&&(e.windowBits=-e.windowBits,0===e.windowBits&&(e.windowBits=-15)),!(e.windowBits>=0&&e.windowBits<16)||t&&t.windowBits||(e.windowBits+=32),e.windowBits>15&&e.windowBits<48&&0==(15&e.windowBits)&&(e.windowBits|=15),this.err=0,this.msg="",this.ended=!1,this.chunks=[],this.strm=new Gt,this.strm.avail_out=0;let r=Fe.inflateInit2(this.strm,e.windowBits);if(r!==qe)throw new Error(q[r]);if(this.header=new Me,Fe.inflateGetHeader(this.strm,this.header),e.dictionary&&("string"==typeof e.dictionary?e.dictionary=$t(e.dictionary):"[object ArrayBuffer]"===Pe.call(e.dictionary)&&(e.dictionary=new Uint8Array(e.dictionary)),e.raw&&(r=Fe.inflateSetDictionary(this.strm,e.dictionary),r!==qe)))throw new Error(q[r])}function Ye(t,e){const r=new Je(e);if(r.push(t),r.err)throw r.msg||q[r.err];return r.result}Je.prototype.push=function(t,e){const r=this.strm,n=this.options.chunkSize,i=this.options.dictionary;let o,s,a;if(this.ended)return!1;for(s=e===~~e?e:!0===e?He:Ze,"[object ArrayBuffer]"===Pe.call(t)?r.input=new Uint8Array(t):r.input=t,r.next_in=0,r.avail_in=r.input.length;;){for(0===r.avail_out&&(r.output=new Uint8Array(n),r.next_out=0,r.avail_out=n),o=Fe.inflate(r,s),o===We&&i&&(o=Fe.inflateSetDictionary(r,i),o===qe?o=Fe.inflate(r,s):o===Ge&&(o=We));r.avail_in>0&&o===$e&&r.state.wrap>0&&0!==t[r.next_in];)Fe.inflateReset(r),o=Fe.inflate(r,s);switch(o){case Ke:case Ge:case We:case Ve:return this.onEnd(o),this.ended=!0,!1}if(a=r.avail_out,r.next_out&&(0===r.avail_out||o===$e))if("string"===this.options.to){let t=Kt(r.output,r.next_out),e=r.next_out-t,i=Wt(r.output,t);r.next_out=e,r.avail_out=n-e,e&&r.output.set(r.output.subarray(t,t+e),0),this.onData(i)}else this.onData(r.output.length===r.next_out?r.output:r.output.subarray(0,r.next_out));if(o!==qe||0!==a){if(o===$e)return o=Fe.inflateEnd(this.strm),this.onEnd(o),this.ended=!0,!0;if(0===r.avail_in)break}}return!0},Je.prototype.onData=function(t){this.chunks.push(t)},Je.prototype.onEnd=function(t){t===qe&&("string"===this.options.to?this.result=this.chunks.join(""):this.result=Zt(this.chunks)),this.chunks=[],this.err=t,this.msg=this.strm.msg};var Xe={Inflate:Je,inflate:Ye,inflateRaw:function(t,e){return(e=e||{}).raw=!0,Ye(t,e)},ungzip:Ye,constants:$};const{Deflate:Qe,deflate:tr,deflateRaw:er,gzip:rr}=ae,{Inflate:nr,inflate:ir,inflateRaw:or,ungzip:sr}=Xe;var ar,hr={Deflate:Qe,deflate:tr,deflateRaw:er,gzip:rr,Inflate:nr,inflate:ir,inflateRaw:or,ungzip:sr,constants:$},ur=__webpack_require__("vsh_872");function lr(t,e=!1){return function(t,e=!1){return e?hr.ungzip(t):JSON.parse(hr.ungzip(t,{to:"string"}))}((r=t,ur.lW.from(r,"base64")),e);var r}function fr(t){return ur.lW.from(hr.gzip(t,{level:9})).toString("base64")}function cr(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,r={};if(t.rows&&t.rows.length)for(var n=0,i=t.rows.length;n<i;n++){var o=t.rows[n];if(o&&o.columns&&o.columns.length){r[e+n]={};for(var s=0,a=o.columns.length;s<a;s++){var h=o.columns[s];h&&(r[e+n][s]=h)}}}return r}!function(t){t.SET_VALUE="setValue",t.SET_FORMULA="setFormula",t.SET_STYLE="setStyle",t.ADD_SHEET="addSheet",t.CREATE="create",t.SORT="sort",t.SET_CELL="setCell",t.SET_SPANS="setSpans",t.SET_COLUMN_WIDTH="setColumnWidth",t.SET_ROW_HEIGHT="setRowHeight",t.SET_SHEET="setSheet",t.COPY_SHEET="copySheet",t.DEL_SHEET="delSheet",t.SOFT_DEL_SHEET="softDelSheet",t.RESTORE_SHEET="restoreSheet",t.MOVE_SHEET="moveSheet",t.ADD_ROW="addRow",t.ADD_COL="addCol",t.DEL_ROW="delRow",t.DEL_COL="delCol",t.HIDE_ROW="hideRow",t.UNHIDE_ROW="unhideRow",t.HIDE_COL="hideCol",t.UNHIDE_COL="unhideCol",t.DEL_FILTER="delFilter",t.SET_FILTER="setFilter",t.FREEZE_SHEET="freezeSheet",t.ADD_COMMENTS="addComments",t.RECOVER="recover",t.LOCK_ROW="lockRow",t.UNLOCK_ROW="unlockRow",t.LOCK_COL="lockCol",t.UNLOCK_COL="unlockCol",t.LOCK_SHEET="lockSheet",t.UNLOCK_SHEET="unlockSheet",t.SET_CHART="setChart",t.DEL_CHART="delChart",t.SET_FLOAT_IMAGE="setFloatImage",t.DEL_FLOAT_IMAGE="delFloatImage",t.SET_FLOAT_BLOCK="setFloatBlock",t.DEL_FLOAT_BLOCK="delFloatBlock",t.ADD_CONDITIONAL_FORMAT="addConditionalFormat",t.SET_CONDITIONAL_FORMAT="setConditionalFormat",t.DEL_CONDITIONAL_FORMAT="delConditionalFormat",t.MOVE_CONDITIONAL_FORMAT="moveConditionalFormat",t.COVER_SNAPSHOT="coverSnapshot",t.ADD_BLOCK="addBlock",t.DEL_BLOCK="delBlock",t.RESTORE_BLOCK="restoreBlock",t.MOVE_RANGE="moveRange",t.COVER_SHEET="coverSheet",t.TID_SPLIT="tidSplit",t.SET_RANGE="setRange",t.UPDATE_RANGE="updateRange",t.SET_RANGE_VALUES="setRangeValues",t.SET_FORM_DATA="setFormData",t.SET_COL_PROPERTY="setColProperty",t.SET_ROW_PROPERTY="setRowProperty",t.ADD_VIEW="addView",t.SET_VIEW="setView",t.DEL_VIEW="delView",t.SET_FILTER_VIEW="setFilterView",t.LOCAL_ACTIVE_VIEW="localActiveView",t.LOCAL_DEACTIVE_VIEW="localDeactiveView",t.UPDATE_REFERENCE="updateReference",t.MIX_RELOAD="mixReload",t.SET_DATA_RANGE="setDataRange",t.DEL_DATA_RANGE="delDataRange",t.EDIT_CHART="editChart",t.SET_EMBEDDED_BLOCK="setEmbeddedBlock",t.DEL_EMBEDDED_BLOCK="delEmbeddedBlock",t.EDIT_PIVOT_TABLE="editPivotTable",t.ADD_OUTLINE="addOutline",t.UPDATE_OUTLINE="updateOutline",t.DEL_OUTLINE="delOutline",t.ADD_SPARKLINE_GROUP="addSparklineGroup",t.UPDATE_SPARKLINE_GROUP="updateSparklineGroup",t.DELETE_SPARKLINE_GROUP="delSparklineGroup",t.SET_RANGE_PROTECTION="setRangeProtection",t.DEL_RANGE_PROTECTION="delRangeProtection"}(ar||(ar={}));var pr,dr=__webpack_require__("vsh_776"),gr={CREATE:0,SETVALUE:1,SETSTYLE:2,SETFORMULA:3,SETCELL:4,ADDROW:5,DELROW:6,ADDCOL:7,DELCOL:8,SETSPANS:9,SETCELLS:10,SETROWHEIGHT:17,SETCOLUMNWIDTH:18,ADDSHEET:19,DELSHEET:20,SETSHEET:21,COPYSHEET:22,SORT:23,SETFILTER:24,DELFILTER:25,MOVESHEET:26,FREEZESHEET:27,RECOVER:28,ADDCOMMENTS:29,HIDEROW:30,UNHIDEROW:31,HIDECOL:32,UNHIDECOL:33,SOFTDELSHEET:34,RESTORESHEET:35,LOCKROW:36,UNLOCKROW:37,LOCKCOL:38,UNLOCKCOL:39,LOCKSHEET:40,UNLOCKSHEET:41,SETCHART:42,DELCHART:43,UPGRADESNAPSHOT:44,ADDCONDITIONALFORMAT:45,SETCONDITIONALFORMAT:46,DELCONDITIONALFORMAT:47,MOVECONDITIONALFORMAT:48,COVERSNAPSHOT:49,MOVERANGE:50,ADDBLOCK:51,DELBLOCK:52,RESTOREBLOCK:53,COVERSHEET:54,SETROWPROPERTY:55,SETCOLPROPERTY:56,SETFORMDATA:57,SETRANGE:58,UPDATERANGE:61,SETFLOATIMAGE:59,DELFLOATIMAGE:60,ADDVIEW:62,SETVIEW:63,DELVIEW:64,SETFILTERVIEW:65,UPDATEREFERENCE:66,MIXRELOAD:67,SETFLOATBLOCK:69,DELFLOATBLOCK:70,SETDATARANGE:68,DELDATARANGE:71,SETEMBEDDEDBLOCK:72,DELEMBEDDEDBLOCK:73,SETRANGEVALUES:74,ADDOUTLINE:75,UPDATEOUTLINE:76,DELOUTLINE:77,ADDSPARKLINEGROUP:78,UPDATESPARKLINEGROUP:79,DELSPARKLINEGROUP:80,SETRANGEPROTECTION:81,DELRANGEPROTECTION:82},yr={nested:{sheet:{nested:{Action:{fields:{action:{rule:"required",type:"ActionCode",id:1},sheet_id:{rule:"required",type:"string",id:2},sheet_name:{type:"string",id:3},target:{type:"TARGET",id:4},value:{type:"string",id:5},type:{type:"int32",id:6},extra:{type:"string",id:7}},nested:{ActionCode:{values:gr},TARGET:{fields:{row:{type:"int32",id:1},row_count:{type:"int32",id:2},col:{type:"int32",id:3},col_count:{type:"int32",id:4},type:{type:"Type",id:5}},nested:{Type:{values:{Normal:0,Row:1,Col:2,All:3}}}}}},SheetChangeset:{fields:{ops:{rule:"repeated",type:"Action",id:1}}}}}}},mr=dr.Root.fromJSON(yr).root.lookupType("sheet.SheetChangeset");!function(t){t.WorkerAvailabilityTest="WorkerAvailabilityTest"}(pr||(pr={}));var _r,br,wr,vr=(_r={ungzip:lr,gzip:fr,ungzipBlocks:function(){for(var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[],e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:r.NEW_SPLIT_CODE,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:lr,i={},o=0;o<t.length;o++){var s=t[o].dataTable;s||(s=n(t[o].gzip_datatable)),e===r.OLD?Object.assign(i,s):Object.assign(i,cr(s,t[o].row))}return i},"changeset.protobuf":function(t){var e=Date.now(),r={ops:function(t){return JSON.parse(JSON.stringify(t,(function(t,e){return"style"===t&&void 0===e?null:e})))}(t.content).map((function(t){return t.action=gr[t.action.toUpperCase()],void 0!==t.value&&(t.value=JSON.stringify(t.value)),void 0!==t.extra&&(t.extra=JSON.stringify(t.extra)),t}))},n=mr.verify(r);if(n)throw new Error(n);var i=fr(mr.encode(mr.create(r)).finish());return Object.assign({},t,{content:i,gzip:!0,timeCost:Date.now()-e})},checkCpuPerformance:function(){for(var t=new Date,e=15e7,r=e;r>0;r--);var n=new Date,i=n.getSeconds()+n.getMilliseconds()/1e3-(t.getSeconds()+t.getMilliseconds()/1e3);t.getMinutes()!==n.getMinutes()&&(i=60*(n.getMinutes()-t.getMinutes())+i);var o=1.349955/i;return{timeCost:Math.round(100*i)/100,estimatedSpeed:Math.round(100*o)/100}}},br=pr.WorkerAvailabilityTest,wr=function(){return{message:pr.WorkerAvailabilityTest}},br in _r?Object.defineProperty(_r,br,{value:wr,enumerable:!0,configurable:!0,writable:!0}):_r[br]=wr,_r),Er=self;Er.addEventListener("message",(function(t){var r=t.data;try{var n=function(t){var r=vr[t.method];if(r)return r.apply(void 0,e(t.args))}(r);Er.postMessage({execId:r.execId,data:n})}catch(t){Er.postMessage({execId:r.execId,error:!0,msg:t.message}),console.error(t)}}))}()})();',"Worker",void 0,void 0)}}}]);